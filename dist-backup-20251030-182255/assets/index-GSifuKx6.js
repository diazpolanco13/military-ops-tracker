(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const v of document.querySelectorAll('link[rel="modulepreload"]'))m(v);new MutationObserver(v=>{for(const S of v)if(S.type==="childList")for(const C of S.addedNodes)C.tagName==="LINK"&&C.rel==="modulepreload"&&m(C)}).observe(document,{childList:!0,subtree:!0});function c(v){const S={};return v.integrity&&(S.integrity=v.integrity),v.referrerPolicy&&(S.referrerPolicy=v.referrerPolicy),v.crossOrigin==="use-credentials"?S.credentials="include":v.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function m(v){if(v.ep)return;v.ep=!0;const S=c(v);fetch(v.href,S)}})();var Ho=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function U2(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function gD(r){if(r.__esModule)return r;var s=r.default;if(typeof s=="function"){var c=function m(){return this instanceof m?Reflect.construct(s,arguments,this.constructor):s.apply(this,arguments)};c.prototype=s.prototype}else c={};return Object.defineProperty(c,"__esModule",{value:!0}),Object.keys(r).forEach(function(m){var v=Object.getOwnPropertyDescriptor(r,m);Object.defineProperty(c,m,v.get?v:{enumerable:!0,get:function(){return r[m]}})}),c}var ok={exports:{}},cv={},ak={exports:{}},Ni={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var N_=Symbol.for("react.element"),_D=Symbol.for("react.portal"),yD=Symbol.for("react.fragment"),xD=Symbol.for("react.strict_mode"),vD=Symbol.for("react.profiler"),bD=Symbol.for("react.provider"),wD=Symbol.for("react.context"),SD=Symbol.for("react.forward_ref"),TD=Symbol.for("react.suspense"),ED=Symbol.for("react.memo"),ID=Symbol.for("react.lazy"),XC=Symbol.iterator;function CD(r){return r===null||typeof r!="object"?null:(r=XC&&r[XC]||r["@@iterator"],typeof r=="function"?r:null)}var lk={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},ck=Object.assign,uk={};function Lp(r,s,c){this.props=r,this.context=s,this.refs=uk,this.updater=c||lk}Lp.prototype.isReactComponent={};Lp.prototype.setState=function(r,s){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,s,"setState")};Lp.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function dk(){}dk.prototype=Lp.prototype;function V2(r,s,c){this.props=r,this.context=s,this.refs=uk,this.updater=c||lk}var $2=V2.prototype=new dk;$2.constructor=V2;ck($2,Lp.prototype);$2.isPureReactComponent=!0;var YC=Array.isArray,hk=Object.prototype.hasOwnProperty,G2={current:null},fk={key:!0,ref:!0,__self:!0,__source:!0};function pk(r,s,c){var m,v={},S=null,C=null;if(s!=null)for(m in s.ref!==void 0&&(C=s.ref),s.key!==void 0&&(S=""+s.key),s)hk.call(s,m)&&!fk.hasOwnProperty(m)&&(v[m]=s[m]);var o=arguments.length-2;if(o===1)v.children=c;else if(1<o){for(var L=Array(o),F=0;F<o;F++)L[F]=arguments[F+2];v.children=L}if(r&&r.defaultProps)for(m in o=r.defaultProps,o)v[m]===void 0&&(v[m]=o[m]);return{$$typeof:N_,type:r,key:S,ref:C,props:v,_owner:G2.current}}function AD(r,s){return{$$typeof:N_,type:r.type,key:s,ref:r.ref,props:r.props,_owner:r._owner}}function q2(r){return typeof r=="object"&&r!==null&&r.$$typeof===N_}function PD(r){var s={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(c){return s[c]})}var KC=/\/+/g;function Uw(r,s){return typeof r=="object"&&r!==null&&r.key!=null?PD(""+r.key):s.toString(36)}function hx(r,s,c,m,v){var S=typeof r;(S==="undefined"||S==="boolean")&&(r=null);var C=!1;if(r===null)C=!0;else switch(S){case"string":case"number":C=!0;break;case"object":switch(r.$$typeof){case N_:case _D:C=!0}}if(C)return C=r,v=v(C),r=m===""?"."+Uw(C,0):m,YC(v)?(c="",r!=null&&(c=r.replace(KC,"$&/")+"/"),hx(v,s,c,"",function(F){return F})):v!=null&&(q2(v)&&(v=AD(v,c+(!v.key||C&&C.key===v.key?"":(""+v.key).replace(KC,"$&/")+"/")+r)),s.push(v)),1;if(C=0,m=m===""?".":m+":",YC(r))for(var o=0;o<r.length;o++){S=r[o];var L=m+Uw(S,o);C+=hx(S,s,c,L,v)}else if(L=CD(r),typeof L=="function")for(r=L.call(r),o=0;!(S=r.next()).done;)S=S.value,L=m+Uw(S,o++),C+=hx(S,s,c,L,v);else if(S==="object")throw s=String(r),Error("Objects are not valid as a React child (found: "+(s==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":s)+"). If you meant to render a collection of children, use an array instead.");return C}function Uy(r,s,c){if(r==null)return r;var m=[],v=0;return hx(r,m,"","",function(S){return s.call(c,S,v++)}),m}function kD(r){if(r._status===-1){var s=r._result;s=s(),s.then(function(c){(r._status===0||r._status===-1)&&(r._status=1,r._result=c)},function(c){(r._status===0||r._status===-1)&&(r._status=2,r._result=c)}),r._status===-1&&(r._status=0,r._result=s)}if(r._status===1)return r._result.default;throw r._result}var uo={current:null},fx={transition:null},MD={ReactCurrentDispatcher:uo,ReactCurrentBatchConfig:fx,ReactCurrentOwner:G2};function mk(){throw Error("act(...) is not supported in production builds of React.")}Ni.Children={map:Uy,forEach:function(r,s,c){Uy(r,function(){s.apply(this,arguments)},c)},count:function(r){var s=0;return Uy(r,function(){s++}),s},toArray:function(r){return Uy(r,function(s){return s})||[]},only:function(r){if(!q2(r))throw Error("React.Children.only expected to receive a single React element child.");return r}};Ni.Component=Lp;Ni.Fragment=yD;Ni.Profiler=vD;Ni.PureComponent=V2;Ni.StrictMode=xD;Ni.Suspense=TD;Ni.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=MD;Ni.act=mk;Ni.cloneElement=function(r,s,c){if(r==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+r+".");var m=ck({},r.props),v=r.key,S=r.ref,C=r._owner;if(s!=null){if(s.ref!==void 0&&(S=s.ref,C=G2.current),s.key!==void 0&&(v=""+s.key),r.type&&r.type.defaultProps)var o=r.type.defaultProps;for(L in s)hk.call(s,L)&&!fk.hasOwnProperty(L)&&(m[L]=s[L]===void 0&&o!==void 0?o[L]:s[L])}var L=arguments.length-2;if(L===1)m.children=c;else if(1<L){o=Array(L);for(var F=0;F<L;F++)o[F]=arguments[F+2];m.children=o}return{$$typeof:N_,type:r.type,key:v,ref:S,props:m,_owner:C}};Ni.createContext=function(r){return r={$$typeof:wD,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},r.Provider={$$typeof:bD,_context:r},r.Consumer=r};Ni.createElement=pk;Ni.createFactory=function(r){var s=pk.bind(null,r);return s.type=r,s};Ni.createRef=function(){return{current:null}};Ni.forwardRef=function(r){return{$$typeof:SD,render:r}};Ni.isValidElement=q2;Ni.lazy=function(r){return{$$typeof:ID,_payload:{_status:-1,_result:r},_init:kD}};Ni.memo=function(r,s){return{$$typeof:ED,type:r,compare:s===void 0?null:s}};Ni.startTransition=function(r){var s=fx.transition;fx.transition={};try{r()}finally{fx.transition=s}};Ni.unstable_act=mk;Ni.useCallback=function(r,s){return uo.current.useCallback(r,s)};Ni.useContext=function(r){return uo.current.useContext(r)};Ni.useDebugValue=function(){};Ni.useDeferredValue=function(r){return uo.current.useDeferredValue(r)};Ni.useEffect=function(r,s){return uo.current.useEffect(r,s)};Ni.useId=function(){return uo.current.useId()};Ni.useImperativeHandle=function(r,s,c){return uo.current.useImperativeHandle(r,s,c)};Ni.useInsertionEffect=function(r,s){return uo.current.useInsertionEffect(r,s)};Ni.useLayoutEffect=function(r,s){return uo.current.useLayoutEffect(r,s)};Ni.useMemo=function(r,s){return uo.current.useMemo(r,s)};Ni.useReducer=function(r,s,c){return uo.current.useReducer(r,s,c)};Ni.useRef=function(r){return uo.current.useRef(r)};Ni.useState=function(r){return uo.current.useState(r)};Ni.useSyncExternalStore=function(r,s,c){return uo.current.useSyncExternalStore(r,s,c)};Ni.useTransition=function(){return uo.current.useTransition()};Ni.version="18.3.1";ak.exports=Ni;var Ne=ak.exports;/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ND=Ne,RD=Symbol.for("react.element"),LD=Symbol.for("react.fragment"),OD=Object.prototype.hasOwnProperty,DD=ND.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,jD={key:!0,ref:!0,__self:!0,__source:!0};function gk(r,s,c){var m,v={},S=null,C=null;c!==void 0&&(S=""+c),s.key!==void 0&&(S=""+s.key),s.ref!==void 0&&(C=s.ref);for(m in s)OD.call(s,m)&&!jD.hasOwnProperty(m)&&(v[m]=s[m]);if(r&&r.defaultProps)for(m in s=r.defaultProps,s)v[m]===void 0&&(v[m]=s[m]);return{$$typeof:RD,type:r,key:S,ref:C,props:v,_owner:DD.current}}cv.Fragment=LD;cv.jsx=gk;cv.jsxs=gk;ok.exports=cv;var x=ok.exports,_k={exports:{}},Xo={},yk={exports:{}},xk={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(r){function s(Ht,xr){var Rt=Ht.length;Ht.push(xr);e:for(;0<Rt;){var rr=Rt-1>>>1,Nr=Ht[rr];if(0<v(Nr,xr))Ht[rr]=xr,Ht[Rt]=Nr,Rt=rr;else break e}}function c(Ht){return Ht.length===0?null:Ht[0]}function m(Ht){if(Ht.length===0)return null;var xr=Ht[0],Rt=Ht.pop();if(Rt!==xr){Ht[0]=Rt;e:for(var rr=0,Nr=Ht.length,Un=Nr>>>1;rr<Un;){var us=2*(rr+1)-1,rs=Ht[us],Yr=us+1,vi=Ht[Yr];if(0>v(rs,Rt))Yr<Nr&&0>v(vi,rs)?(Ht[rr]=vi,Ht[Yr]=Rt,rr=Yr):(Ht[rr]=rs,Ht[us]=Rt,rr=us);else if(Yr<Nr&&0>v(vi,Rt))Ht[rr]=vi,Ht[Yr]=Rt,rr=Yr;else break e}}return xr}function v(Ht,xr){var Rt=Ht.sortIndex-xr.sortIndex;return Rt!==0?Rt:Ht.id-xr.id}if(typeof performance=="object"&&typeof performance.now=="function"){var S=performance;r.unstable_now=function(){return S.now()}}else{var C=Date,o=C.now();r.unstable_now=function(){return C.now()-o}}var L=[],F=[],Z=1,$=null,W=3,ee=!1,ie=!1,ae=!1,ke=typeof setTimeout=="function"?setTimeout:null,le=typeof clearTimeout=="function"?clearTimeout:null,se=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function J(Ht){for(var xr=c(F);xr!==null;){if(xr.callback===null)m(F);else if(xr.startTime<=Ht)m(F),xr.sortIndex=xr.expirationTime,s(L,xr);else break;xr=c(F)}}function Ee(Ht){if(ae=!1,J(Ht),!ie)if(c(L)!==null)ie=!0,Ut(je);else{var xr=c(F);xr!==null&&jr(Ee,xr.startTime-Ht)}}function je(Ht,xr){ie=!1,ae&&(ae=!1,le(it),it=-1),ee=!0;var Rt=W;try{for(J(xr),$=c(L);$!==null&&(!($.expirationTime>xr)||Ht&&!Nt());){var rr=$.callback;if(typeof rr=="function"){$.callback=null,W=$.priorityLevel;var Nr=rr($.expirationTime<=xr);xr=r.unstable_now(),typeof Nr=="function"?$.callback=Nr:$===c(L)&&m(L),J(xr)}else m(L);$=c(L)}if($!==null)var Un=!0;else{var us=c(F);us!==null&&jr(Ee,us.startTime-xr),Un=!1}return Un}finally{$=null,W=Rt,ee=!1}}var Xe=!1,tt=null,it=-1,We=5,Ct=-1;function Nt(){return!(r.unstable_now()-Ct<We)}function Wt(){if(tt!==null){var Ht=r.unstable_now();Ct=Ht;var xr=!0;try{xr=tt(!0,Ht)}finally{xr?fr():(Xe=!1,tt=null)}}else Xe=!1}var fr;if(typeof se=="function")fr=function(){se(Wt)};else if(typeof MessageChannel<"u"){var dr=new MessageChannel,cr=dr.port2;dr.port1.onmessage=Wt,fr=function(){cr.postMessage(null)}}else fr=function(){ke(Wt,0)};function Ut(Ht){tt=Ht,Xe||(Xe=!0,fr())}function jr(Ht,xr){it=ke(function(){Ht(r.unstable_now())},xr)}r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(Ht){Ht.callback=null},r.unstable_continueExecution=function(){ie||ee||(ie=!0,Ut(je))},r.unstable_forceFrameRate=function(Ht){0>Ht||125<Ht?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):We=0<Ht?Math.floor(1e3/Ht):5},r.unstable_getCurrentPriorityLevel=function(){return W},r.unstable_getFirstCallbackNode=function(){return c(L)},r.unstable_next=function(Ht){switch(W){case 1:case 2:case 3:var xr=3;break;default:xr=W}var Rt=W;W=xr;try{return Ht()}finally{W=Rt}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(Ht,xr){switch(Ht){case 1:case 2:case 3:case 4:case 5:break;default:Ht=3}var Rt=W;W=Ht;try{return xr()}finally{W=Rt}},r.unstable_scheduleCallback=function(Ht,xr,Rt){var rr=r.unstable_now();switch(typeof Rt=="object"&&Rt!==null?(Rt=Rt.delay,Rt=typeof Rt=="number"&&0<Rt?rr+Rt:rr):Rt=rr,Ht){case 1:var Nr=-1;break;case 2:Nr=250;break;case 5:Nr=1073741823;break;case 4:Nr=1e4;break;default:Nr=5e3}return Nr=Rt+Nr,Ht={id:Z++,callback:xr,priorityLevel:Ht,startTime:Rt,expirationTime:Nr,sortIndex:-1},Rt>rr?(Ht.sortIndex=Rt,s(F,Ht),c(L)===null&&Ht===c(F)&&(ae?(le(it),it=-1):ae=!0,jr(Ee,Rt-rr))):(Ht.sortIndex=Nr,s(L,Ht),ie||ee||(ie=!0,Ut(je))),Ht},r.unstable_shouldYield=Nt,r.unstable_wrapCallback=function(Ht){var xr=W;return function(){var Rt=W;W=xr;try{return Ht.apply(this,arguments)}finally{W=Rt}}}})(xk);yk.exports=xk;var zD=yk.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var FD=Ne,Wo=zD;function Zt(r){for(var s="https://reactjs.org/docs/error-decoder.html?invariant="+r,c=1;c<arguments.length;c++)s+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+r+"; visit "+s+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var vk=new Set,a_={};function ch(r,s){bp(r,s),bp(r+"Capture",s)}function bp(r,s){for(a_[r]=s,r=0;r<s.length;r++)vk.add(s[r])}var _c=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),I1=Object.prototype.hasOwnProperty,BD=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,JC={},QC={};function UD(r){return I1.call(QC,r)?!0:I1.call(JC,r)?!1:BD.test(r)?QC[r]=!0:(JC[r]=!0,!1)}function VD(r,s,c,m){if(c!==null&&c.type===0)return!1;switch(typeof s){case"function":case"symbol":return!0;case"boolean":return m?!1:c!==null?!c.acceptsBooleans:(r=r.toLowerCase().slice(0,5),r!=="data-"&&r!=="aria-");default:return!1}}function $D(r,s,c,m){if(s===null||typeof s>"u"||VD(r,s,c,m))return!0;if(m)return!1;if(c!==null)switch(c.type){case 3:return!s;case 4:return s===!1;case 5:return isNaN(s);case 6:return isNaN(s)||1>s}return!1}function ho(r,s,c,m,v,S,C){this.acceptsBooleans=s===2||s===3||s===4,this.attributeName=m,this.attributeNamespace=v,this.mustUseProperty=c,this.propertyName=r,this.type=s,this.sanitizeURL=S,this.removeEmptyString=C}var Ms={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(r){Ms[r]=new ho(r,0,!1,r,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(r){var s=r[0];Ms[s]=new ho(s,1,!1,r[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(r){Ms[r]=new ho(r,2,!1,r.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(r){Ms[r]=new ho(r,2,!1,r,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(r){Ms[r]=new ho(r,3,!1,r.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(r){Ms[r]=new ho(r,3,!0,r,null,!1,!1)});["capture","download"].forEach(function(r){Ms[r]=new ho(r,4,!1,r,null,!1,!1)});["cols","rows","size","span"].forEach(function(r){Ms[r]=new ho(r,6,!1,r,null,!1,!1)});["rowSpan","start"].forEach(function(r){Ms[r]=new ho(r,5,!1,r.toLowerCase(),null,!1,!1)});var H2=/[\-:]([a-z])/g;function W2(r){return r[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(r){var s=r.replace(H2,W2);Ms[s]=new ho(s,1,!1,r,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(r){var s=r.replace(H2,W2);Ms[s]=new ho(s,1,!1,r,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(r){var s=r.replace(H2,W2);Ms[s]=new ho(s,1,!1,r,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(r){Ms[r]=new ho(r,1,!1,r.toLowerCase(),null,!1,!1)});Ms.xlinkHref=new ho("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(r){Ms[r]=new ho(r,1,!1,r.toLowerCase(),null,!0,!0)});function Z2(r,s,c,m){var v=Ms.hasOwnProperty(s)?Ms[s]:null;(v!==null?v.type!==0:m||!(2<s.length)||s[0]!=="o"&&s[0]!=="O"||s[1]!=="n"&&s[1]!=="N")&&($D(s,c,v,m)&&(c=null),m||v===null?UD(s)&&(c===null?r.removeAttribute(s):r.setAttribute(s,""+c)):v.mustUseProperty?r[v.propertyName]=c===null?v.type===3?!1:"":c:(s=v.attributeName,m=v.attributeNamespace,c===null?r.removeAttribute(s):(v=v.type,c=v===3||v===4&&c===!0?"":""+c,m?r.setAttributeNS(m,s,c):r.setAttribute(s,c))))}var wc=FD.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,Vy=Symbol.for("react.element"),ep=Symbol.for("react.portal"),tp=Symbol.for("react.fragment"),X2=Symbol.for("react.strict_mode"),C1=Symbol.for("react.profiler"),bk=Symbol.for("react.provider"),wk=Symbol.for("react.context"),Y2=Symbol.for("react.forward_ref"),A1=Symbol.for("react.suspense"),P1=Symbol.for("react.suspense_list"),K2=Symbol.for("react.memo"),xu=Symbol.for("react.lazy"),Sk=Symbol.for("react.offscreen"),eA=Symbol.iterator;function Lg(r){return r===null||typeof r!="object"?null:(r=eA&&r[eA]||r["@@iterator"],typeof r=="function"?r:null)}var Dn=Object.assign,Vw;function Gg(r){if(Vw===void 0)try{throw Error()}catch(c){var s=c.stack.trim().match(/\n( *(at )?)/);Vw=s&&s[1]||""}return`
`+Vw+r}var $w=!1;function Gw(r,s){if(!r||$w)return"";$w=!0;var c=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(s)if(s=function(){throw Error()},Object.defineProperty(s.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(s,[])}catch(F){var m=F}Reflect.construct(r,[],s)}else{try{s.call()}catch(F){m=F}r.call(s.prototype)}else{try{throw Error()}catch(F){m=F}r()}}catch(F){if(F&&m&&typeof F.stack=="string"){for(var v=F.stack.split(`
`),S=m.stack.split(`
`),C=v.length-1,o=S.length-1;1<=C&&0<=o&&v[C]!==S[o];)o--;for(;1<=C&&0<=o;C--,o--)if(v[C]!==S[o]){if(C!==1||o!==1)do if(C--,o--,0>o||v[C]!==S[o]){var L=`
`+v[C].replace(" at new "," at ");return r.displayName&&L.includes("<anonymous>")&&(L=L.replace("<anonymous>",r.displayName)),L}while(1<=C&&0<=o);break}}}finally{$w=!1,Error.prepareStackTrace=c}return(r=r?r.displayName||r.name:"")?Gg(r):""}function GD(r){switch(r.tag){case 5:return Gg(r.type);case 16:return Gg("Lazy");case 13:return Gg("Suspense");case 19:return Gg("SuspenseList");case 0:case 2:case 15:return r=Gw(r.type,!1),r;case 11:return r=Gw(r.type.render,!1),r;case 1:return r=Gw(r.type,!0),r;default:return""}}function k1(r){if(r==null)return null;if(typeof r=="function")return r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case tp:return"Fragment";case ep:return"Portal";case C1:return"Profiler";case X2:return"StrictMode";case A1:return"Suspense";case P1:return"SuspenseList"}if(typeof r=="object")switch(r.$$typeof){case wk:return(r.displayName||"Context")+".Consumer";case bk:return(r._context.displayName||"Context")+".Provider";case Y2:var s=r.render;return r=r.displayName,r||(r=s.displayName||s.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case K2:return s=r.displayName||null,s!==null?s:k1(r.type)||"Memo";case xu:s=r._payload,r=r._init;try{return k1(r(s))}catch{}}return null}function qD(r){var s=r.type;switch(r.tag){case 24:return"Cache";case 9:return(s.displayName||"Context")+".Consumer";case 10:return(s._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return r=s.render,r=r.displayName||r.name||"",s.displayName||(r!==""?"ForwardRef("+r+")":"ForwardRef");case 7:return"Fragment";case 5:return s;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return k1(s);case 8:return s===X2?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof s=="function")return s.displayName||s.name||null;if(typeof s=="string")return s}return null}function Ou(r){switch(typeof r){case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}function Tk(r){var s=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(s==="checkbox"||s==="radio")}function HD(r){var s=Tk(r)?"checked":"value",c=Object.getOwnPropertyDescriptor(r.constructor.prototype,s),m=""+r[s];if(!r.hasOwnProperty(s)&&typeof c<"u"&&typeof c.get=="function"&&typeof c.set=="function"){var v=c.get,S=c.set;return Object.defineProperty(r,s,{configurable:!0,get:function(){return v.call(this)},set:function(C){m=""+C,S.call(this,C)}}),Object.defineProperty(r,s,{enumerable:c.enumerable}),{getValue:function(){return m},setValue:function(C){m=""+C},stopTracking:function(){r._valueTracker=null,delete r[s]}}}}function $y(r){r._valueTracker||(r._valueTracker=HD(r))}function Ek(r){if(!r)return!1;var s=r._valueTracker;if(!s)return!0;var c=s.getValue(),m="";return r&&(m=Tk(r)?r.checked?"true":"false":r.value),r=m,r!==c?(s.setValue(r),!0):!1}function Cx(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}function M1(r,s){var c=s.checked;return Dn({},s,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:c??r._wrapperState.initialChecked})}function tA(r,s){var c=s.defaultValue==null?"":s.defaultValue,m=s.checked!=null?s.checked:s.defaultChecked;c=Ou(s.value!=null?s.value:c),r._wrapperState={initialChecked:m,initialValue:c,controlled:s.type==="checkbox"||s.type==="radio"?s.checked!=null:s.value!=null}}function Ik(r,s){s=s.checked,s!=null&&Z2(r,"checked",s,!1)}function N1(r,s){Ik(r,s);var c=Ou(s.value),m=s.type;if(c!=null)m==="number"?(c===0&&r.value===""||r.value!=c)&&(r.value=""+c):r.value!==""+c&&(r.value=""+c);else if(m==="submit"||m==="reset"){r.removeAttribute("value");return}s.hasOwnProperty("value")?R1(r,s.type,c):s.hasOwnProperty("defaultValue")&&R1(r,s.type,Ou(s.defaultValue)),s.checked==null&&s.defaultChecked!=null&&(r.defaultChecked=!!s.defaultChecked)}function rA(r,s,c){if(s.hasOwnProperty("value")||s.hasOwnProperty("defaultValue")){var m=s.type;if(!(m!=="submit"&&m!=="reset"||s.value!==void 0&&s.value!==null))return;s=""+r._wrapperState.initialValue,c||s===r.value||(r.value=s),r.defaultValue=s}c=r.name,c!==""&&(r.name=""),r.defaultChecked=!!r._wrapperState.initialChecked,c!==""&&(r.name=c)}function R1(r,s,c){(s!=="number"||Cx(r.ownerDocument)!==r)&&(c==null?r.defaultValue=""+r._wrapperState.initialValue:r.defaultValue!==""+c&&(r.defaultValue=""+c))}var qg=Array.isArray;function hp(r,s,c,m){if(r=r.options,s){s={};for(var v=0;v<c.length;v++)s["$"+c[v]]=!0;for(c=0;c<r.length;c++)v=s.hasOwnProperty("$"+r[c].value),r[c].selected!==v&&(r[c].selected=v),v&&m&&(r[c].defaultSelected=!0)}else{for(c=""+Ou(c),s=null,v=0;v<r.length;v++){if(r[v].value===c){r[v].selected=!0,m&&(r[v].defaultSelected=!0);return}s!==null||r[v].disabled||(s=r[v])}s!==null&&(s.selected=!0)}}function L1(r,s){if(s.dangerouslySetInnerHTML!=null)throw Error(Zt(91));return Dn({},s,{value:void 0,defaultValue:void 0,children:""+r._wrapperState.initialValue})}function iA(r,s){var c=s.value;if(c==null){if(c=s.children,s=s.defaultValue,c!=null){if(s!=null)throw Error(Zt(92));if(qg(c)){if(1<c.length)throw Error(Zt(93));c=c[0]}s=c}s==null&&(s=""),c=s}r._wrapperState={initialValue:Ou(c)}}function Ck(r,s){var c=Ou(s.value),m=Ou(s.defaultValue);c!=null&&(c=""+c,c!==r.value&&(r.value=c),s.defaultValue==null&&r.defaultValue!==c&&(r.defaultValue=c)),m!=null&&(r.defaultValue=""+m)}function nA(r){var s=r.textContent;s===r._wrapperState.initialValue&&s!==""&&s!==null&&(r.value=s)}function Ak(r){switch(r){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function O1(r,s){return r==null||r==="http://www.w3.org/1999/xhtml"?Ak(s):r==="http://www.w3.org/2000/svg"&&s==="foreignObject"?"http://www.w3.org/1999/xhtml":r}var Gy,Pk=function(r){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(s,c,m,v){MSApp.execUnsafeLocalFunction(function(){return r(s,c,m,v)})}:r}(function(r,s){if(r.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in r)r.innerHTML=s;else{for(Gy=Gy||document.createElement("div"),Gy.innerHTML="<svg>"+s.valueOf().toString()+"</svg>",s=Gy.firstChild;r.firstChild;)r.removeChild(r.firstChild);for(;s.firstChild;)r.appendChild(s.firstChild)}});function l_(r,s){if(s){var c=r.firstChild;if(c&&c===r.lastChild&&c.nodeType===3){c.nodeValue=s;return}}r.textContent=s}var Xg={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},WD=["Webkit","ms","Moz","O"];Object.keys(Xg).forEach(function(r){WD.forEach(function(s){s=s+r.charAt(0).toUpperCase()+r.substring(1),Xg[s]=Xg[r]})});function kk(r,s,c){return s==null||typeof s=="boolean"||s===""?"":c||typeof s!="number"||s===0||Xg.hasOwnProperty(r)&&Xg[r]?(""+s).trim():s+"px"}function Mk(r,s){r=r.style;for(var c in s)if(s.hasOwnProperty(c)){var m=c.indexOf("--")===0,v=kk(c,s[c],m);c==="float"&&(c="cssFloat"),m?r.setProperty(c,v):r[c]=v}}var ZD=Dn({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function D1(r,s){if(s){if(ZD[r]&&(s.children!=null||s.dangerouslySetInnerHTML!=null))throw Error(Zt(137,r));if(s.dangerouslySetInnerHTML!=null){if(s.children!=null)throw Error(Zt(60));if(typeof s.dangerouslySetInnerHTML!="object"||!("__html"in s.dangerouslySetInnerHTML))throw Error(Zt(61))}if(s.style!=null&&typeof s.style!="object")throw Error(Zt(62))}}function j1(r,s){if(r.indexOf("-")===-1)return typeof s.is=="string";switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var z1=null;function J2(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}var F1=null,fp=null,pp=null;function sA(r){if(r=O_(r)){if(typeof F1!="function")throw Error(Zt(280));var s=r.stateNode;s&&(s=pv(s),F1(r.stateNode,r.type,s))}}function Nk(r){fp?pp?pp.push(r):pp=[r]:fp=r}function Rk(){if(fp){var r=fp,s=pp;if(pp=fp=null,sA(r),s)for(r=0;r<s.length;r++)sA(s[r])}}function Lk(r,s){return r(s)}function Ok(){}var qw=!1;function Dk(r,s,c){if(qw)return r(s,c);qw=!0;try{return Lk(r,s,c)}finally{qw=!1,(fp!==null||pp!==null)&&(Ok(),Rk())}}function c_(r,s){var c=r.stateNode;if(c===null)return null;var m=pv(c);if(m===null)return null;c=m[s];e:switch(s){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(m=!m.disabled)||(r=r.type,m=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!m;break e;default:r=!1}if(r)return null;if(c&&typeof c!="function")throw Error(Zt(231,s,typeof c));return c}var B1=!1;if(_c)try{var Og={};Object.defineProperty(Og,"passive",{get:function(){B1=!0}}),window.addEventListener("test",Og,Og),window.removeEventListener("test",Og,Og)}catch{B1=!1}function XD(r,s,c,m,v,S,C,o,L){var F=Array.prototype.slice.call(arguments,3);try{s.apply(c,F)}catch(Z){this.onError(Z)}}var Yg=!1,Ax=null,Px=!1,U1=null,YD={onError:function(r){Yg=!0,Ax=r}};function KD(r,s,c,m,v,S,C,o,L){Yg=!1,Ax=null,XD.apply(YD,arguments)}function JD(r,s,c,m,v,S,C,o,L){if(KD.apply(this,arguments),Yg){if(Yg){var F=Ax;Yg=!1,Ax=null}else throw Error(Zt(198));Px||(Px=!0,U1=F)}}function uh(r){var s=r,c=r;if(r.alternate)for(;s.return;)s=s.return;else{r=s;do s=r,s.flags&4098&&(c=s.return),r=s.return;while(r)}return s.tag===3?c:null}function jk(r){if(r.tag===13){var s=r.memoizedState;if(s===null&&(r=r.alternate,r!==null&&(s=r.memoizedState)),s!==null)return s.dehydrated}return null}function oA(r){if(uh(r)!==r)throw Error(Zt(188))}function QD(r){var s=r.alternate;if(!s){if(s=uh(r),s===null)throw Error(Zt(188));return s!==r?null:r}for(var c=r,m=s;;){var v=c.return;if(v===null)break;var S=v.alternate;if(S===null){if(m=v.return,m!==null){c=m;continue}break}if(v.child===S.child){for(S=v.child;S;){if(S===c)return oA(v),r;if(S===m)return oA(v),s;S=S.sibling}throw Error(Zt(188))}if(c.return!==m.return)c=v,m=S;else{for(var C=!1,o=v.child;o;){if(o===c){C=!0,c=v,m=S;break}if(o===m){C=!0,m=v,c=S;break}o=o.sibling}if(!C){for(o=S.child;o;){if(o===c){C=!0,c=S,m=v;break}if(o===m){C=!0,m=S,c=v;break}o=o.sibling}if(!C)throw Error(Zt(189))}}if(c.alternate!==m)throw Error(Zt(190))}if(c.tag!==3)throw Error(Zt(188));return c.stateNode.current===c?r:s}function zk(r){return r=QD(r),r!==null?Fk(r):null}function Fk(r){if(r.tag===5||r.tag===6)return r;for(r=r.child;r!==null;){var s=Fk(r);if(s!==null)return s;r=r.sibling}return null}var Bk=Wo.unstable_scheduleCallback,aA=Wo.unstable_cancelCallback,ej=Wo.unstable_shouldYield,tj=Wo.unstable_requestPaint,Wn=Wo.unstable_now,rj=Wo.unstable_getCurrentPriorityLevel,Q2=Wo.unstable_ImmediatePriority,Uk=Wo.unstable_UserBlockingPriority,kx=Wo.unstable_NormalPriority,ij=Wo.unstable_LowPriority,Vk=Wo.unstable_IdlePriority,uv=null,Al=null;function nj(r){if(Al&&typeof Al.onCommitFiberRoot=="function")try{Al.onCommitFiberRoot(uv,r,void 0,(r.current.flags&128)===128)}catch{}}var Ua=Math.clz32?Math.clz32:aj,sj=Math.log,oj=Math.LN2;function aj(r){return r>>>=0,r===0?32:31-(sj(r)/oj|0)|0}var qy=64,Hy=4194304;function Hg(r){switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return r&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return r}}function Mx(r,s){var c=r.pendingLanes;if(c===0)return 0;var m=0,v=r.suspendedLanes,S=r.pingedLanes,C=c&268435455;if(C!==0){var o=C&~v;o!==0?m=Hg(o):(S&=C,S!==0&&(m=Hg(S)))}else C=c&~v,C!==0?m=Hg(C):S!==0&&(m=Hg(S));if(m===0)return 0;if(s!==0&&s!==m&&!(s&v)&&(v=m&-m,S=s&-s,v>=S||v===16&&(S&4194240)!==0))return s;if(m&4&&(m|=c&16),s=r.entangledLanes,s!==0)for(r=r.entanglements,s&=m;0<s;)c=31-Ua(s),v=1<<c,m|=r[c],s&=~v;return m}function lj(r,s){switch(r){case 1:case 2:case 4:return s+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return s+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function cj(r,s){for(var c=r.suspendedLanes,m=r.pingedLanes,v=r.expirationTimes,S=r.pendingLanes;0<S;){var C=31-Ua(S),o=1<<C,L=v[C];L===-1?(!(o&c)||o&m)&&(v[C]=lj(o,s)):L<=s&&(r.expiredLanes|=o),S&=~o}}function V1(r){return r=r.pendingLanes&-1073741825,r!==0?r:r&1073741824?1073741824:0}function $k(){var r=qy;return qy<<=1,!(qy&4194240)&&(qy=64),r}function Hw(r){for(var s=[],c=0;31>c;c++)s.push(r);return s}function R_(r,s,c){r.pendingLanes|=s,s!==536870912&&(r.suspendedLanes=0,r.pingedLanes=0),r=r.eventTimes,s=31-Ua(s),r[s]=c}function uj(r,s){var c=r.pendingLanes&~s;r.pendingLanes=s,r.suspendedLanes=0,r.pingedLanes=0,r.expiredLanes&=s,r.mutableReadLanes&=s,r.entangledLanes&=s,s=r.entanglements;var m=r.eventTimes;for(r=r.expirationTimes;0<c;){var v=31-Ua(c),S=1<<v;s[v]=0,m[v]=-1,r[v]=-1,c&=~S}}function eS(r,s){var c=r.entangledLanes|=s;for(r=r.entanglements;c;){var m=31-Ua(c),v=1<<m;v&s|r[m]&s&&(r[m]|=s),c&=~v}}var rn=0;function Gk(r){return r&=-r,1<r?4<r?r&268435455?16:536870912:4:1}var qk,tS,Hk,Wk,Zk,$1=!1,Wy=[],Cu=null,Au=null,Pu=null,u_=new Map,d_=new Map,bu=[],dj="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function lA(r,s){switch(r){case"focusin":case"focusout":Cu=null;break;case"dragenter":case"dragleave":Au=null;break;case"mouseover":case"mouseout":Pu=null;break;case"pointerover":case"pointerout":u_.delete(s.pointerId);break;case"gotpointercapture":case"lostpointercapture":d_.delete(s.pointerId)}}function Dg(r,s,c,m,v,S){return r===null||r.nativeEvent!==S?(r={blockedOn:s,domEventName:c,eventSystemFlags:m,nativeEvent:S,targetContainers:[v]},s!==null&&(s=O_(s),s!==null&&tS(s)),r):(r.eventSystemFlags|=m,s=r.targetContainers,v!==null&&s.indexOf(v)===-1&&s.push(v),r)}function hj(r,s,c,m,v){switch(s){case"focusin":return Cu=Dg(Cu,r,s,c,m,v),!0;case"dragenter":return Au=Dg(Au,r,s,c,m,v),!0;case"mouseover":return Pu=Dg(Pu,r,s,c,m,v),!0;case"pointerover":var S=v.pointerId;return u_.set(S,Dg(u_.get(S)||null,r,s,c,m,v)),!0;case"gotpointercapture":return S=v.pointerId,d_.set(S,Dg(d_.get(S)||null,r,s,c,m,v)),!0}return!1}function Xk(r){var s=Yd(r.target);if(s!==null){var c=uh(s);if(c!==null){if(s=c.tag,s===13){if(s=jk(c),s!==null){r.blockedOn=s,Zk(r.priority,function(){Hk(c)});return}}else if(s===3&&c.stateNode.current.memoizedState.isDehydrated){r.blockedOn=c.tag===3?c.stateNode.containerInfo:null;return}}}r.blockedOn=null}function px(r){if(r.blockedOn!==null)return!1;for(var s=r.targetContainers;0<s.length;){var c=G1(r.domEventName,r.eventSystemFlags,s[0],r.nativeEvent);if(c===null){c=r.nativeEvent;var m=new c.constructor(c.type,c);z1=m,c.target.dispatchEvent(m),z1=null}else return s=O_(c),s!==null&&tS(s),r.blockedOn=c,!1;s.shift()}return!0}function cA(r,s,c){px(r)&&c.delete(s)}function fj(){$1=!1,Cu!==null&&px(Cu)&&(Cu=null),Au!==null&&px(Au)&&(Au=null),Pu!==null&&px(Pu)&&(Pu=null),u_.forEach(cA),d_.forEach(cA)}function jg(r,s){r.blockedOn===s&&(r.blockedOn=null,$1||($1=!0,Wo.unstable_scheduleCallback(Wo.unstable_NormalPriority,fj)))}function h_(r){function s(v){return jg(v,r)}if(0<Wy.length){jg(Wy[0],r);for(var c=1;c<Wy.length;c++){var m=Wy[c];m.blockedOn===r&&(m.blockedOn=null)}}for(Cu!==null&&jg(Cu,r),Au!==null&&jg(Au,r),Pu!==null&&jg(Pu,r),u_.forEach(s),d_.forEach(s),c=0;c<bu.length;c++)m=bu[c],m.blockedOn===r&&(m.blockedOn=null);for(;0<bu.length&&(c=bu[0],c.blockedOn===null);)Xk(c),c.blockedOn===null&&bu.shift()}var mp=wc.ReactCurrentBatchConfig,Nx=!0;function pj(r,s,c,m){var v=rn,S=mp.transition;mp.transition=null;try{rn=1,rS(r,s,c,m)}finally{rn=v,mp.transition=S}}function mj(r,s,c,m){var v=rn,S=mp.transition;mp.transition=null;try{rn=4,rS(r,s,c,m)}finally{rn=v,mp.transition=S}}function rS(r,s,c,m){if(Nx){var v=G1(r,s,c,m);if(v===null)r1(r,s,m,Rx,c),lA(r,m);else if(hj(v,r,s,c,m))m.stopPropagation();else if(lA(r,m),s&4&&-1<dj.indexOf(r)){for(;v!==null;){var S=O_(v);if(S!==null&&qk(S),S=G1(r,s,c,m),S===null&&r1(r,s,m,Rx,c),S===v)break;v=S}v!==null&&m.stopPropagation()}else r1(r,s,m,null,c)}}var Rx=null;function G1(r,s,c,m){if(Rx=null,r=J2(m),r=Yd(r),r!==null)if(s=uh(r),s===null)r=null;else if(c=s.tag,c===13){if(r=jk(s),r!==null)return r;r=null}else if(c===3){if(s.stateNode.current.memoizedState.isDehydrated)return s.tag===3?s.stateNode.containerInfo:null;r=null}else s!==r&&(r=null);return Rx=r,null}function Yk(r){switch(r){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(rj()){case Q2:return 1;case Uk:return 4;case kx:case ij:return 16;case Vk:return 536870912;default:return 16}default:return 16}}var Tu=null,iS=null,mx=null;function Kk(){if(mx)return mx;var r,s=iS,c=s.length,m,v="value"in Tu?Tu.value:Tu.textContent,S=v.length;for(r=0;r<c&&s[r]===v[r];r++);var C=c-r;for(m=1;m<=C&&s[c-m]===v[S-m];m++);return mx=v.slice(r,1<m?1-m:void 0)}function gx(r){var s=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&s===13&&(r=13)):r=s,r===10&&(r=13),32<=r||r===13?r:0}function Zy(){return!0}function uA(){return!1}function Yo(r){function s(c,m,v,S,C){this._reactName=c,this._targetInst=v,this.type=m,this.nativeEvent=S,this.target=C,this.currentTarget=null;for(var o in r)r.hasOwnProperty(o)&&(c=r[o],this[o]=c?c(S):S[o]);return this.isDefaultPrevented=(S.defaultPrevented!=null?S.defaultPrevented:S.returnValue===!1)?Zy:uA,this.isPropagationStopped=uA,this}return Dn(s.prototype,{preventDefault:function(){this.defaultPrevented=!0;var c=this.nativeEvent;c&&(c.preventDefault?c.preventDefault():typeof c.returnValue!="unknown"&&(c.returnValue=!1),this.isDefaultPrevented=Zy)},stopPropagation:function(){var c=this.nativeEvent;c&&(c.stopPropagation?c.stopPropagation():typeof c.cancelBubble!="unknown"&&(c.cancelBubble=!0),this.isPropagationStopped=Zy)},persist:function(){},isPersistent:Zy}),s}var Op={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(r){return r.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},nS=Yo(Op),L_=Dn({},Op,{view:0,detail:0}),gj=Yo(L_),Ww,Zw,zg,dv=Dn({},L_,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:sS,button:0,buttons:0,relatedTarget:function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},movementX:function(r){return"movementX"in r?r.movementX:(r!==zg&&(zg&&r.type==="mousemove"?(Ww=r.screenX-zg.screenX,Zw=r.screenY-zg.screenY):Zw=Ww=0,zg=r),Ww)},movementY:function(r){return"movementY"in r?r.movementY:Zw}}),dA=Yo(dv),_j=Dn({},dv,{dataTransfer:0}),yj=Yo(_j),xj=Dn({},L_,{relatedTarget:0}),Xw=Yo(xj),vj=Dn({},Op,{animationName:0,elapsedTime:0,pseudoElement:0}),bj=Yo(vj),wj=Dn({},Op,{clipboardData:function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData}}),Sj=Yo(wj),Tj=Dn({},Op,{data:0}),hA=Yo(Tj),Ej={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Ij={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Cj={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Aj(r){var s=this.nativeEvent;return s.getModifierState?s.getModifierState(r):(r=Cj[r])?!!s[r]:!1}function sS(){return Aj}var Pj=Dn({},L_,{key:function(r){if(r.key){var s=Ej[r.key]||r.key;if(s!=="Unidentified")return s}return r.type==="keypress"?(r=gx(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?Ij[r.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:sS,charCode:function(r){return r.type==="keypress"?gx(r):0},keyCode:function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},which:function(r){return r.type==="keypress"?gx(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0}}),kj=Yo(Pj),Mj=Dn({},dv,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),fA=Yo(Mj),Nj=Dn({},L_,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:sS}),Rj=Yo(Nj),Lj=Dn({},Op,{propertyName:0,elapsedTime:0,pseudoElement:0}),Oj=Yo(Lj),Dj=Dn({},dv,{deltaX:function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},deltaY:function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},deltaZ:0,deltaMode:0}),jj=Yo(Dj),zj=[9,13,27,32],oS=_c&&"CompositionEvent"in window,Kg=null;_c&&"documentMode"in document&&(Kg=document.documentMode);var Fj=_c&&"TextEvent"in window&&!Kg,Jk=_c&&(!oS||Kg&&8<Kg&&11>=Kg),pA=" ",mA=!1;function Qk(r,s){switch(r){case"keyup":return zj.indexOf(s.keyCode)!==-1;case"keydown":return s.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function eM(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}var rp=!1;function Bj(r,s){switch(r){case"compositionend":return eM(s);case"keypress":return s.which!==32?null:(mA=!0,pA);case"textInput":return r=s.data,r===pA&&mA?null:r;default:return null}}function Uj(r,s){if(rp)return r==="compositionend"||!oS&&Qk(r,s)?(r=Kk(),mx=iS=Tu=null,rp=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(s.ctrlKey||s.altKey||s.metaKey)||s.ctrlKey&&s.altKey){if(s.char&&1<s.char.length)return s.char;if(s.which)return String.fromCharCode(s.which)}return null;case"compositionend":return Jk&&s.locale!=="ko"?null:s.data;default:return null}}var Vj={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function gA(r){var s=r&&r.nodeName&&r.nodeName.toLowerCase();return s==="input"?!!Vj[r.type]:s==="textarea"}function tM(r,s,c,m){Nk(m),s=Lx(s,"onChange"),0<s.length&&(c=new nS("onChange","change",null,c,m),r.push({event:c,listeners:s}))}var Jg=null,f_=null;function $j(r){hM(r,0)}function hv(r){var s=sp(r);if(Ek(s))return r}function Gj(r,s){if(r==="change")return s}var rM=!1;if(_c){var Yw;if(_c){var Kw="oninput"in document;if(!Kw){var _A=document.createElement("div");_A.setAttribute("oninput","return;"),Kw=typeof _A.oninput=="function"}Yw=Kw}else Yw=!1;rM=Yw&&(!document.documentMode||9<document.documentMode)}function yA(){Jg&&(Jg.detachEvent("onpropertychange",iM),f_=Jg=null)}function iM(r){if(r.propertyName==="value"&&hv(f_)){var s=[];tM(s,f_,r,J2(r)),Dk($j,s)}}function qj(r,s,c){r==="focusin"?(yA(),Jg=s,f_=c,Jg.attachEvent("onpropertychange",iM)):r==="focusout"&&yA()}function Hj(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return hv(f_)}function Wj(r,s){if(r==="click")return hv(s)}function Zj(r,s){if(r==="input"||r==="change")return hv(s)}function Xj(r,s){return r===s&&(r!==0||1/r===1/s)||r!==r&&s!==s}var $a=typeof Object.is=="function"?Object.is:Xj;function p_(r,s){if($a(r,s))return!0;if(typeof r!="object"||r===null||typeof s!="object"||s===null)return!1;var c=Object.keys(r),m=Object.keys(s);if(c.length!==m.length)return!1;for(m=0;m<c.length;m++){var v=c[m];if(!I1.call(s,v)||!$a(r[v],s[v]))return!1}return!0}function xA(r){for(;r&&r.firstChild;)r=r.firstChild;return r}function vA(r,s){var c=xA(r);r=0;for(var m;c;){if(c.nodeType===3){if(m=r+c.textContent.length,r<=s&&m>=s)return{node:c,offset:s-r};r=m}e:{for(;c;){if(c.nextSibling){c=c.nextSibling;break e}c=c.parentNode}c=void 0}c=xA(c)}}function nM(r,s){return r&&s?r===s?!0:r&&r.nodeType===3?!1:s&&s.nodeType===3?nM(r,s.parentNode):"contains"in r?r.contains(s):r.compareDocumentPosition?!!(r.compareDocumentPosition(s)&16):!1:!1}function sM(){for(var r=window,s=Cx();s instanceof r.HTMLIFrameElement;){try{var c=typeof s.contentWindow.location.href=="string"}catch{c=!1}if(c)r=s.contentWindow;else break;s=Cx(r.document)}return s}function aS(r){var s=r&&r.nodeName&&r.nodeName.toLowerCase();return s&&(s==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||s==="textarea"||r.contentEditable==="true")}function Yj(r){var s=sM(),c=r.focusedElem,m=r.selectionRange;if(s!==c&&c&&c.ownerDocument&&nM(c.ownerDocument.documentElement,c)){if(m!==null&&aS(c)){if(s=m.start,r=m.end,r===void 0&&(r=s),"selectionStart"in c)c.selectionStart=s,c.selectionEnd=Math.min(r,c.value.length);else if(r=(s=c.ownerDocument||document)&&s.defaultView||window,r.getSelection){r=r.getSelection();var v=c.textContent.length,S=Math.min(m.start,v);m=m.end===void 0?S:Math.min(m.end,v),!r.extend&&S>m&&(v=m,m=S,S=v),v=vA(c,S);var C=vA(c,m);v&&C&&(r.rangeCount!==1||r.anchorNode!==v.node||r.anchorOffset!==v.offset||r.focusNode!==C.node||r.focusOffset!==C.offset)&&(s=s.createRange(),s.setStart(v.node,v.offset),r.removeAllRanges(),S>m?(r.addRange(s),r.extend(C.node,C.offset)):(s.setEnd(C.node,C.offset),r.addRange(s)))}}for(s=[],r=c;r=r.parentNode;)r.nodeType===1&&s.push({element:r,left:r.scrollLeft,top:r.scrollTop});for(typeof c.focus=="function"&&c.focus(),c=0;c<s.length;c++)r=s[c],r.element.scrollLeft=r.left,r.element.scrollTop=r.top}}var Kj=_c&&"documentMode"in document&&11>=document.documentMode,ip=null,q1=null,Qg=null,H1=!1;function bA(r,s,c){var m=c.window===c?c.document:c.nodeType===9?c:c.ownerDocument;H1||ip==null||ip!==Cx(m)||(m=ip,"selectionStart"in m&&aS(m)?m={start:m.selectionStart,end:m.selectionEnd}:(m=(m.ownerDocument&&m.ownerDocument.defaultView||window).getSelection(),m={anchorNode:m.anchorNode,anchorOffset:m.anchorOffset,focusNode:m.focusNode,focusOffset:m.focusOffset}),Qg&&p_(Qg,m)||(Qg=m,m=Lx(q1,"onSelect"),0<m.length&&(s=new nS("onSelect","select",null,s,c),r.push({event:s,listeners:m}),s.target=ip)))}function Xy(r,s){var c={};return c[r.toLowerCase()]=s.toLowerCase(),c["Webkit"+r]="webkit"+s,c["Moz"+r]="moz"+s,c}var np={animationend:Xy("Animation","AnimationEnd"),animationiteration:Xy("Animation","AnimationIteration"),animationstart:Xy("Animation","AnimationStart"),transitionend:Xy("Transition","TransitionEnd")},Jw={},oM={};_c&&(oM=document.createElement("div").style,"AnimationEvent"in window||(delete np.animationend.animation,delete np.animationiteration.animation,delete np.animationstart.animation),"TransitionEvent"in window||delete np.transitionend.transition);function fv(r){if(Jw[r])return Jw[r];if(!np[r])return r;var s=np[r],c;for(c in s)if(s.hasOwnProperty(c)&&c in oM)return Jw[r]=s[c];return r}var aM=fv("animationend"),lM=fv("animationiteration"),cM=fv("animationstart"),uM=fv("transitionend"),dM=new Map,wA="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function zu(r,s){dM.set(r,s),ch(s,[r])}for(var Qw=0;Qw<wA.length;Qw++){var e1=wA[Qw],Jj=e1.toLowerCase(),Qj=e1[0].toUpperCase()+e1.slice(1);zu(Jj,"on"+Qj)}zu(aM,"onAnimationEnd");zu(lM,"onAnimationIteration");zu(cM,"onAnimationStart");zu("dblclick","onDoubleClick");zu("focusin","onFocus");zu("focusout","onBlur");zu(uM,"onTransitionEnd");bp("onMouseEnter",["mouseout","mouseover"]);bp("onMouseLeave",["mouseout","mouseover"]);bp("onPointerEnter",["pointerout","pointerover"]);bp("onPointerLeave",["pointerout","pointerover"]);ch("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));ch("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));ch("onBeforeInput",["compositionend","keypress","textInput","paste"]);ch("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));ch("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));ch("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Wg="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),ez=new Set("cancel close invalid load scroll toggle".split(" ").concat(Wg));function SA(r,s,c){var m=r.type||"unknown-event";r.currentTarget=c,JD(m,s,void 0,r),r.currentTarget=null}function hM(r,s){s=(s&4)!==0;for(var c=0;c<r.length;c++){var m=r[c],v=m.event;m=m.listeners;e:{var S=void 0;if(s)for(var C=m.length-1;0<=C;C--){var o=m[C],L=o.instance,F=o.currentTarget;if(o=o.listener,L!==S&&v.isPropagationStopped())break e;SA(v,o,F),S=L}else for(C=0;C<m.length;C++){if(o=m[C],L=o.instance,F=o.currentTarget,o=o.listener,L!==S&&v.isPropagationStopped())break e;SA(v,o,F),S=L}}}if(Px)throw r=U1,Px=!1,U1=null,r}function Sn(r,s){var c=s[K1];c===void 0&&(c=s[K1]=new Set);var m=r+"__bubble";c.has(m)||(fM(s,r,2,!1),c.add(m))}function t1(r,s,c){var m=0;s&&(m|=4),fM(c,r,m,s)}var Yy="_reactListening"+Math.random().toString(36).slice(2);function m_(r){if(!r[Yy]){r[Yy]=!0,vk.forEach(function(c){c!=="selectionchange"&&(ez.has(c)||t1(c,!1,r),t1(c,!0,r))});var s=r.nodeType===9?r:r.ownerDocument;s===null||s[Yy]||(s[Yy]=!0,t1("selectionchange",!1,s))}}function fM(r,s,c,m){switch(Yk(s)){case 1:var v=pj;break;case 4:v=mj;break;default:v=rS}c=v.bind(null,s,c,r),v=void 0,!B1||s!=="touchstart"&&s!=="touchmove"&&s!=="wheel"||(v=!0),m?v!==void 0?r.addEventListener(s,c,{capture:!0,passive:v}):r.addEventListener(s,c,!0):v!==void 0?r.addEventListener(s,c,{passive:v}):r.addEventListener(s,c,!1)}function r1(r,s,c,m,v){var S=m;if(!(s&1)&&!(s&2)&&m!==null)e:for(;;){if(m===null)return;var C=m.tag;if(C===3||C===4){var o=m.stateNode.containerInfo;if(o===v||o.nodeType===8&&o.parentNode===v)break;if(C===4)for(C=m.return;C!==null;){var L=C.tag;if((L===3||L===4)&&(L=C.stateNode.containerInfo,L===v||L.nodeType===8&&L.parentNode===v))return;C=C.return}for(;o!==null;){if(C=Yd(o),C===null)return;if(L=C.tag,L===5||L===6){m=S=C;continue e}o=o.parentNode}}m=m.return}Dk(function(){var F=S,Z=J2(c),$=[];e:{var W=dM.get(r);if(W!==void 0){var ee=nS,ie=r;switch(r){case"keypress":if(gx(c)===0)break e;case"keydown":case"keyup":ee=kj;break;case"focusin":ie="focus",ee=Xw;break;case"focusout":ie="blur",ee=Xw;break;case"beforeblur":case"afterblur":ee=Xw;break;case"click":if(c.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ee=dA;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ee=yj;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ee=Rj;break;case aM:case lM:case cM:ee=bj;break;case uM:ee=Oj;break;case"scroll":ee=gj;break;case"wheel":ee=jj;break;case"copy":case"cut":case"paste":ee=Sj;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ee=fA}var ae=(s&4)!==0,ke=!ae&&r==="scroll",le=ae?W!==null?W+"Capture":null:W;ae=[];for(var se=F,J;se!==null;){J=se;var Ee=J.stateNode;if(J.tag===5&&Ee!==null&&(J=Ee,le!==null&&(Ee=c_(se,le),Ee!=null&&ae.push(g_(se,Ee,J)))),ke)break;se=se.return}0<ae.length&&(W=new ee(W,ie,null,c,Z),$.push({event:W,listeners:ae}))}}if(!(s&7)){e:{if(W=r==="mouseover"||r==="pointerover",ee=r==="mouseout"||r==="pointerout",W&&c!==z1&&(ie=c.relatedTarget||c.fromElement)&&(Yd(ie)||ie[yc]))break e;if((ee||W)&&(W=Z.window===Z?Z:(W=Z.ownerDocument)?W.defaultView||W.parentWindow:window,ee?(ie=c.relatedTarget||c.toElement,ee=F,ie=ie?Yd(ie):null,ie!==null&&(ke=uh(ie),ie!==ke||ie.tag!==5&&ie.tag!==6)&&(ie=null)):(ee=null,ie=F),ee!==ie)){if(ae=dA,Ee="onMouseLeave",le="onMouseEnter",se="mouse",(r==="pointerout"||r==="pointerover")&&(ae=fA,Ee="onPointerLeave",le="onPointerEnter",se="pointer"),ke=ee==null?W:sp(ee),J=ie==null?W:sp(ie),W=new ae(Ee,se+"leave",ee,c,Z),W.target=ke,W.relatedTarget=J,Ee=null,Yd(Z)===F&&(ae=new ae(le,se+"enter",ie,c,Z),ae.target=J,ae.relatedTarget=ke,Ee=ae),ke=Ee,ee&&ie)t:{for(ae=ee,le=ie,se=0,J=ae;J;J=Gf(J))se++;for(J=0,Ee=le;Ee;Ee=Gf(Ee))J++;for(;0<se-J;)ae=Gf(ae),se--;for(;0<J-se;)le=Gf(le),J--;for(;se--;){if(ae===le||le!==null&&ae===le.alternate)break t;ae=Gf(ae),le=Gf(le)}ae=null}else ae=null;ee!==null&&TA($,W,ee,ae,!1),ie!==null&&ke!==null&&TA($,ke,ie,ae,!0)}}e:{if(W=F?sp(F):window,ee=W.nodeName&&W.nodeName.toLowerCase(),ee==="select"||ee==="input"&&W.type==="file")var je=Gj;else if(gA(W))if(rM)je=Zj;else{je=Hj;var Xe=qj}else(ee=W.nodeName)&&ee.toLowerCase()==="input"&&(W.type==="checkbox"||W.type==="radio")&&(je=Wj);if(je&&(je=je(r,F))){tM($,je,c,Z);break e}Xe&&Xe(r,W,F),r==="focusout"&&(Xe=W._wrapperState)&&Xe.controlled&&W.type==="number"&&R1(W,"number",W.value)}switch(Xe=F?sp(F):window,r){case"focusin":(gA(Xe)||Xe.contentEditable==="true")&&(ip=Xe,q1=F,Qg=null);break;case"focusout":Qg=q1=ip=null;break;case"mousedown":H1=!0;break;case"contextmenu":case"mouseup":case"dragend":H1=!1,bA($,c,Z);break;case"selectionchange":if(Kj)break;case"keydown":case"keyup":bA($,c,Z)}var tt;if(oS)e:{switch(r){case"compositionstart":var it="onCompositionStart";break e;case"compositionend":it="onCompositionEnd";break e;case"compositionupdate":it="onCompositionUpdate";break e}it=void 0}else rp?Qk(r,c)&&(it="onCompositionEnd"):r==="keydown"&&c.keyCode===229&&(it="onCompositionStart");it&&(Jk&&c.locale!=="ko"&&(rp||it!=="onCompositionStart"?it==="onCompositionEnd"&&rp&&(tt=Kk()):(Tu=Z,iS="value"in Tu?Tu.value:Tu.textContent,rp=!0)),Xe=Lx(F,it),0<Xe.length&&(it=new hA(it,r,null,c,Z),$.push({event:it,listeners:Xe}),tt?it.data=tt:(tt=eM(c),tt!==null&&(it.data=tt)))),(tt=Fj?Bj(r,c):Uj(r,c))&&(F=Lx(F,"onBeforeInput"),0<F.length&&(Z=new hA("onBeforeInput","beforeinput",null,c,Z),$.push({event:Z,listeners:F}),Z.data=tt))}hM($,s)})}function g_(r,s,c){return{instance:r,listener:s,currentTarget:c}}function Lx(r,s){for(var c=s+"Capture",m=[];r!==null;){var v=r,S=v.stateNode;v.tag===5&&S!==null&&(v=S,S=c_(r,c),S!=null&&m.unshift(g_(r,S,v)),S=c_(r,s),S!=null&&m.push(g_(r,S,v))),r=r.return}return m}function Gf(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5);return r||null}function TA(r,s,c,m,v){for(var S=s._reactName,C=[];c!==null&&c!==m;){var o=c,L=o.alternate,F=o.stateNode;if(L!==null&&L===m)break;o.tag===5&&F!==null&&(o=F,v?(L=c_(c,S),L!=null&&C.unshift(g_(c,L,o))):v||(L=c_(c,S),L!=null&&C.push(g_(c,L,o)))),c=c.return}C.length!==0&&r.push({event:s,listeners:C})}var tz=/\r\n?/g,rz=/\u0000|\uFFFD/g;function EA(r){return(typeof r=="string"?r:""+r).replace(tz,`
`).replace(rz,"")}function Ky(r,s,c){if(s=EA(s),EA(r)!==s&&c)throw Error(Zt(425))}function Ox(){}var W1=null,Z1=null;function X1(r,s){return r==="textarea"||r==="noscript"||typeof s.children=="string"||typeof s.children=="number"||typeof s.dangerouslySetInnerHTML=="object"&&s.dangerouslySetInnerHTML!==null&&s.dangerouslySetInnerHTML.__html!=null}var Y1=typeof setTimeout=="function"?setTimeout:void 0,iz=typeof clearTimeout=="function"?clearTimeout:void 0,IA=typeof Promise=="function"?Promise:void 0,nz=typeof queueMicrotask=="function"?queueMicrotask:typeof IA<"u"?function(r){return IA.resolve(null).then(r).catch(sz)}:Y1;function sz(r){setTimeout(function(){throw r})}function i1(r,s){var c=s,m=0;do{var v=c.nextSibling;if(r.removeChild(c),v&&v.nodeType===8)if(c=v.data,c==="/$"){if(m===0){r.removeChild(v),h_(s);return}m--}else c!=="$"&&c!=="$?"&&c!=="$!"||m++;c=v}while(c);h_(s)}function ku(r){for(;r!=null;r=r.nextSibling){var s=r.nodeType;if(s===1||s===3)break;if(s===8){if(s=r.data,s==="$"||s==="$!"||s==="$?")break;if(s==="/$")return null}}return r}function CA(r){r=r.previousSibling;for(var s=0;r;){if(r.nodeType===8){var c=r.data;if(c==="$"||c==="$!"||c==="$?"){if(s===0)return r;s--}else c==="/$"&&s++}r=r.previousSibling}return null}var Dp=Math.random().toString(36).slice(2),El="__reactFiber$"+Dp,__="__reactProps$"+Dp,yc="__reactContainer$"+Dp,K1="__reactEvents$"+Dp,oz="__reactListeners$"+Dp,az="__reactHandles$"+Dp;function Yd(r){var s=r[El];if(s)return s;for(var c=r.parentNode;c;){if(s=c[yc]||c[El]){if(c=s.alternate,s.child!==null||c!==null&&c.child!==null)for(r=CA(r);r!==null;){if(c=r[El])return c;r=CA(r)}return s}r=c,c=r.parentNode}return null}function O_(r){return r=r[El]||r[yc],!r||r.tag!==5&&r.tag!==6&&r.tag!==13&&r.tag!==3?null:r}function sp(r){if(r.tag===5||r.tag===6)return r.stateNode;throw Error(Zt(33))}function pv(r){return r[__]||null}var J1=[],op=-1;function Fu(r){return{current:r}}function Tn(r){0>op||(r.current=J1[op],J1[op]=null,op--)}function xn(r,s){op++,J1[op]=r.current,r.current=s}var Du={},Vs=Fu(Du),To=Fu(!1),ih=Du;function wp(r,s){var c=r.type.contextTypes;if(!c)return Du;var m=r.stateNode;if(m&&m.__reactInternalMemoizedUnmaskedChildContext===s)return m.__reactInternalMemoizedMaskedChildContext;var v={},S;for(S in c)v[S]=s[S];return m&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=s,r.__reactInternalMemoizedMaskedChildContext=v),v}function Eo(r){return r=r.childContextTypes,r!=null}function Dx(){Tn(To),Tn(Vs)}function AA(r,s,c){if(Vs.current!==Du)throw Error(Zt(168));xn(Vs,s),xn(To,c)}function pM(r,s,c){var m=r.stateNode;if(s=s.childContextTypes,typeof m.getChildContext!="function")return c;m=m.getChildContext();for(var v in m)if(!(v in s))throw Error(Zt(108,qD(r)||"Unknown",v));return Dn({},c,m)}function jx(r){return r=(r=r.stateNode)&&r.__reactInternalMemoizedMergedChildContext||Du,ih=Vs.current,xn(Vs,r),xn(To,To.current),!0}function PA(r,s,c){var m=r.stateNode;if(!m)throw Error(Zt(169));c?(r=pM(r,s,ih),m.__reactInternalMemoizedMergedChildContext=r,Tn(To),Tn(Vs),xn(Vs,r)):Tn(To),xn(To,c)}var fc=null,mv=!1,n1=!1;function mM(r){fc===null?fc=[r]:fc.push(r)}function lz(r){mv=!0,mM(r)}function Bu(){if(!n1&&fc!==null){n1=!0;var r=0,s=rn;try{var c=fc;for(rn=1;r<c.length;r++){var m=c[r];do m=m(!0);while(m!==null)}fc=null,mv=!1}catch(v){throw fc!==null&&(fc=fc.slice(r+1)),Bk(Q2,Bu),v}finally{rn=s,n1=!1}}return null}var ap=[],lp=0,zx=null,Fx=0,ua=[],da=0,nh=null,pc=1,mc="";function $d(r,s){ap[lp++]=Fx,ap[lp++]=zx,zx=r,Fx=s}function gM(r,s,c){ua[da++]=pc,ua[da++]=mc,ua[da++]=nh,nh=r;var m=pc;r=mc;var v=32-Ua(m)-1;m&=~(1<<v),c+=1;var S=32-Ua(s)+v;if(30<S){var C=v-v%5;S=(m&(1<<C)-1).toString(32),m>>=C,v-=C,pc=1<<32-Ua(s)+v|c<<v|m,mc=S+r}else pc=1<<S|c<<v|m,mc=r}function lS(r){r.return!==null&&($d(r,1),gM(r,1,0))}function cS(r){for(;r===zx;)zx=ap[--lp],ap[lp]=null,Fx=ap[--lp],ap[lp]=null;for(;r===nh;)nh=ua[--da],ua[da]=null,mc=ua[--da],ua[da]=null,pc=ua[--da],ua[da]=null}var qo=null,Go=null,Mn=!1,Ba=null;function _M(r,s){var c=fa(5,null,null,0);c.elementType="DELETED",c.stateNode=s,c.return=r,s=r.deletions,s===null?(r.deletions=[c],r.flags|=16):s.push(c)}function kA(r,s){switch(r.tag){case 5:var c=r.type;return s=s.nodeType!==1||c.toLowerCase()!==s.nodeName.toLowerCase()?null:s,s!==null?(r.stateNode=s,qo=r,Go=ku(s.firstChild),!0):!1;case 6:return s=r.pendingProps===""||s.nodeType!==3?null:s,s!==null?(r.stateNode=s,qo=r,Go=null,!0):!1;case 13:return s=s.nodeType!==8?null:s,s!==null?(c=nh!==null?{id:pc,overflow:mc}:null,r.memoizedState={dehydrated:s,treeContext:c,retryLane:1073741824},c=fa(18,null,null,0),c.stateNode=s,c.return=r,r.child=c,qo=r,Go=null,!0):!1;default:return!1}}function Q1(r){return(r.mode&1)!==0&&(r.flags&128)===0}function e2(r){if(Mn){var s=Go;if(s){var c=s;if(!kA(r,s)){if(Q1(r))throw Error(Zt(418));s=ku(c.nextSibling);var m=qo;s&&kA(r,s)?_M(m,c):(r.flags=r.flags&-4097|2,Mn=!1,qo=r)}}else{if(Q1(r))throw Error(Zt(418));r.flags=r.flags&-4097|2,Mn=!1,qo=r}}}function MA(r){for(r=r.return;r!==null&&r.tag!==5&&r.tag!==3&&r.tag!==13;)r=r.return;qo=r}function Jy(r){if(r!==qo)return!1;if(!Mn)return MA(r),Mn=!0,!1;var s;if((s=r.tag!==3)&&!(s=r.tag!==5)&&(s=r.type,s=s!=="head"&&s!=="body"&&!X1(r.type,r.memoizedProps)),s&&(s=Go)){if(Q1(r))throw yM(),Error(Zt(418));for(;s;)_M(r,s),s=ku(s.nextSibling)}if(MA(r),r.tag===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(Zt(317));e:{for(r=r.nextSibling,s=0;r;){if(r.nodeType===8){var c=r.data;if(c==="/$"){if(s===0){Go=ku(r.nextSibling);break e}s--}else c!=="$"&&c!=="$!"&&c!=="$?"||s++}r=r.nextSibling}Go=null}}else Go=qo?ku(r.stateNode.nextSibling):null;return!0}function yM(){for(var r=Go;r;)r=ku(r.nextSibling)}function Sp(){Go=qo=null,Mn=!1}function uS(r){Ba===null?Ba=[r]:Ba.push(r)}var cz=wc.ReactCurrentBatchConfig;function Fg(r,s,c){if(r=c.ref,r!==null&&typeof r!="function"&&typeof r!="object"){if(c._owner){if(c=c._owner,c){if(c.tag!==1)throw Error(Zt(309));var m=c.stateNode}if(!m)throw Error(Zt(147,r));var v=m,S=""+r;return s!==null&&s.ref!==null&&typeof s.ref=="function"&&s.ref._stringRef===S?s.ref:(s=function(C){var o=v.refs;C===null?delete o[S]:o[S]=C},s._stringRef=S,s)}if(typeof r!="string")throw Error(Zt(284));if(!c._owner)throw Error(Zt(290,r))}return r}function Qy(r,s){throw r=Object.prototype.toString.call(s),Error(Zt(31,r==="[object Object]"?"object with keys {"+Object.keys(s).join(", ")+"}":r))}function NA(r){var s=r._init;return s(r._payload)}function xM(r){function s(le,se){if(r){var J=le.deletions;J===null?(le.deletions=[se],le.flags|=16):J.push(se)}}function c(le,se){if(!r)return null;for(;se!==null;)s(le,se),se=se.sibling;return null}function m(le,se){for(le=new Map;se!==null;)se.key!==null?le.set(se.key,se):le.set(se.index,se),se=se.sibling;return le}function v(le,se){return le=Lu(le,se),le.index=0,le.sibling=null,le}function S(le,se,J){return le.index=J,r?(J=le.alternate,J!==null?(J=J.index,J<se?(le.flags|=2,se):J):(le.flags|=2,se)):(le.flags|=1048576,se)}function C(le){return r&&le.alternate===null&&(le.flags|=2),le}function o(le,se,J,Ee){return se===null||se.tag!==6?(se=d1(J,le.mode,Ee),se.return=le,se):(se=v(se,J),se.return=le,se)}function L(le,se,J,Ee){var je=J.type;return je===tp?Z(le,se,J.props.children,Ee,J.key):se!==null&&(se.elementType===je||typeof je=="object"&&je!==null&&je.$$typeof===xu&&NA(je)===se.type)?(Ee=v(se,J.props),Ee.ref=Fg(le,se,J),Ee.return=le,Ee):(Ee=Sx(J.type,J.key,J.props,null,le.mode,Ee),Ee.ref=Fg(le,se,J),Ee.return=le,Ee)}function F(le,se,J,Ee){return se===null||se.tag!==4||se.stateNode.containerInfo!==J.containerInfo||se.stateNode.implementation!==J.implementation?(se=h1(J,le.mode,Ee),se.return=le,se):(se=v(se,J.children||[]),se.return=le,se)}function Z(le,se,J,Ee,je){return se===null||se.tag!==7?(se=rh(J,le.mode,Ee,je),se.return=le,se):(se=v(se,J),se.return=le,se)}function $(le,se,J){if(typeof se=="string"&&se!==""||typeof se=="number")return se=d1(""+se,le.mode,J),se.return=le,se;if(typeof se=="object"&&se!==null){switch(se.$$typeof){case Vy:return J=Sx(se.type,se.key,se.props,null,le.mode,J),J.ref=Fg(le,null,se),J.return=le,J;case ep:return se=h1(se,le.mode,J),se.return=le,se;case xu:var Ee=se._init;return $(le,Ee(se._payload),J)}if(qg(se)||Lg(se))return se=rh(se,le.mode,J,null),se.return=le,se;Qy(le,se)}return null}function W(le,se,J,Ee){var je=se!==null?se.key:null;if(typeof J=="string"&&J!==""||typeof J=="number")return je!==null?null:o(le,se,""+J,Ee);if(typeof J=="object"&&J!==null){switch(J.$$typeof){case Vy:return J.key===je?L(le,se,J,Ee):null;case ep:return J.key===je?F(le,se,J,Ee):null;case xu:return je=J._init,W(le,se,je(J._payload),Ee)}if(qg(J)||Lg(J))return je!==null?null:Z(le,se,J,Ee,null);Qy(le,J)}return null}function ee(le,se,J,Ee,je){if(typeof Ee=="string"&&Ee!==""||typeof Ee=="number")return le=le.get(J)||null,o(se,le,""+Ee,je);if(typeof Ee=="object"&&Ee!==null){switch(Ee.$$typeof){case Vy:return le=le.get(Ee.key===null?J:Ee.key)||null,L(se,le,Ee,je);case ep:return le=le.get(Ee.key===null?J:Ee.key)||null,F(se,le,Ee,je);case xu:var Xe=Ee._init;return ee(le,se,J,Xe(Ee._payload),je)}if(qg(Ee)||Lg(Ee))return le=le.get(J)||null,Z(se,le,Ee,je,null);Qy(se,Ee)}return null}function ie(le,se,J,Ee){for(var je=null,Xe=null,tt=se,it=se=0,We=null;tt!==null&&it<J.length;it++){tt.index>it?(We=tt,tt=null):We=tt.sibling;var Ct=W(le,tt,J[it],Ee);if(Ct===null){tt===null&&(tt=We);break}r&&tt&&Ct.alternate===null&&s(le,tt),se=S(Ct,se,it),Xe===null?je=Ct:Xe.sibling=Ct,Xe=Ct,tt=We}if(it===J.length)return c(le,tt),Mn&&$d(le,it),je;if(tt===null){for(;it<J.length;it++)tt=$(le,J[it],Ee),tt!==null&&(se=S(tt,se,it),Xe===null?je=tt:Xe.sibling=tt,Xe=tt);return Mn&&$d(le,it),je}for(tt=m(le,tt);it<J.length;it++)We=ee(tt,le,it,J[it],Ee),We!==null&&(r&&We.alternate!==null&&tt.delete(We.key===null?it:We.key),se=S(We,se,it),Xe===null?je=We:Xe.sibling=We,Xe=We);return r&&tt.forEach(function(Nt){return s(le,Nt)}),Mn&&$d(le,it),je}function ae(le,se,J,Ee){var je=Lg(J);if(typeof je!="function")throw Error(Zt(150));if(J=je.call(J),J==null)throw Error(Zt(151));for(var Xe=je=null,tt=se,it=se=0,We=null,Ct=J.next();tt!==null&&!Ct.done;it++,Ct=J.next()){tt.index>it?(We=tt,tt=null):We=tt.sibling;var Nt=W(le,tt,Ct.value,Ee);if(Nt===null){tt===null&&(tt=We);break}r&&tt&&Nt.alternate===null&&s(le,tt),se=S(Nt,se,it),Xe===null?je=Nt:Xe.sibling=Nt,Xe=Nt,tt=We}if(Ct.done)return c(le,tt),Mn&&$d(le,it),je;if(tt===null){for(;!Ct.done;it++,Ct=J.next())Ct=$(le,Ct.value,Ee),Ct!==null&&(se=S(Ct,se,it),Xe===null?je=Ct:Xe.sibling=Ct,Xe=Ct);return Mn&&$d(le,it),je}for(tt=m(le,tt);!Ct.done;it++,Ct=J.next())Ct=ee(tt,le,it,Ct.value,Ee),Ct!==null&&(r&&Ct.alternate!==null&&tt.delete(Ct.key===null?it:Ct.key),se=S(Ct,se,it),Xe===null?je=Ct:Xe.sibling=Ct,Xe=Ct);return r&&tt.forEach(function(Wt){return s(le,Wt)}),Mn&&$d(le,it),je}function ke(le,se,J,Ee){if(typeof J=="object"&&J!==null&&J.type===tp&&J.key===null&&(J=J.props.children),typeof J=="object"&&J!==null){switch(J.$$typeof){case Vy:e:{for(var je=J.key,Xe=se;Xe!==null;){if(Xe.key===je){if(je=J.type,je===tp){if(Xe.tag===7){c(le,Xe.sibling),se=v(Xe,J.props.children),se.return=le,le=se;break e}}else if(Xe.elementType===je||typeof je=="object"&&je!==null&&je.$$typeof===xu&&NA(je)===Xe.type){c(le,Xe.sibling),se=v(Xe,J.props),se.ref=Fg(le,Xe,J),se.return=le,le=se;break e}c(le,Xe);break}else s(le,Xe);Xe=Xe.sibling}J.type===tp?(se=rh(J.props.children,le.mode,Ee,J.key),se.return=le,le=se):(Ee=Sx(J.type,J.key,J.props,null,le.mode,Ee),Ee.ref=Fg(le,se,J),Ee.return=le,le=Ee)}return C(le);case ep:e:{for(Xe=J.key;se!==null;){if(se.key===Xe)if(se.tag===4&&se.stateNode.containerInfo===J.containerInfo&&se.stateNode.implementation===J.implementation){c(le,se.sibling),se=v(se,J.children||[]),se.return=le,le=se;break e}else{c(le,se);break}else s(le,se);se=se.sibling}se=h1(J,le.mode,Ee),se.return=le,le=se}return C(le);case xu:return Xe=J._init,ke(le,se,Xe(J._payload),Ee)}if(qg(J))return ie(le,se,J,Ee);if(Lg(J))return ae(le,se,J,Ee);Qy(le,J)}return typeof J=="string"&&J!==""||typeof J=="number"?(J=""+J,se!==null&&se.tag===6?(c(le,se.sibling),se=v(se,J),se.return=le,le=se):(c(le,se),se=d1(J,le.mode,Ee),se.return=le,le=se),C(le)):c(le,se)}return ke}var Tp=xM(!0),vM=xM(!1),Bx=Fu(null),Ux=null,cp=null,dS=null;function hS(){dS=cp=Ux=null}function fS(r){var s=Bx.current;Tn(Bx),r._currentValue=s}function t2(r,s,c){for(;r!==null;){var m=r.alternate;if((r.childLanes&s)!==s?(r.childLanes|=s,m!==null&&(m.childLanes|=s)):m!==null&&(m.childLanes&s)!==s&&(m.childLanes|=s),r===c)break;r=r.return}}function gp(r,s){Ux=r,dS=cp=null,r=r.dependencies,r!==null&&r.firstContext!==null&&(r.lanes&s&&(So=!0),r.firstContext=null)}function ga(r){var s=r._currentValue;if(dS!==r)if(r={context:r,memoizedValue:s,next:null},cp===null){if(Ux===null)throw Error(Zt(308));cp=r,Ux.dependencies={lanes:0,firstContext:r}}else cp=cp.next=r;return s}var Kd=null;function pS(r){Kd===null?Kd=[r]:Kd.push(r)}function bM(r,s,c,m){var v=s.interleaved;return v===null?(c.next=c,pS(s)):(c.next=v.next,v.next=c),s.interleaved=c,xc(r,m)}function xc(r,s){r.lanes|=s;var c=r.alternate;for(c!==null&&(c.lanes|=s),c=r,r=r.return;r!==null;)r.childLanes|=s,c=r.alternate,c!==null&&(c.childLanes|=s),c=r,r=r.return;return c.tag===3?c.stateNode:null}var vu=!1;function mS(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function wM(r,s){r=r.updateQueue,s.updateQueue===r&&(s.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects})}function gc(r,s){return{eventTime:r,lane:s,tag:0,payload:null,callback:null,next:null}}function Mu(r,s,c){var m=r.updateQueue;if(m===null)return null;if(m=m.shared,Hi&2){var v=m.pending;return v===null?s.next=s:(s.next=v.next,v.next=s),m.pending=s,xc(r,c)}return v=m.interleaved,v===null?(s.next=s,pS(m)):(s.next=v.next,v.next=s),m.interleaved=s,xc(r,c)}function _x(r,s,c){if(s=s.updateQueue,s!==null&&(s=s.shared,(c&4194240)!==0)){var m=s.lanes;m&=r.pendingLanes,c|=m,s.lanes=c,eS(r,c)}}function RA(r,s){var c=r.updateQueue,m=r.alternate;if(m!==null&&(m=m.updateQueue,c===m)){var v=null,S=null;if(c=c.firstBaseUpdate,c!==null){do{var C={eventTime:c.eventTime,lane:c.lane,tag:c.tag,payload:c.payload,callback:c.callback,next:null};S===null?v=S=C:S=S.next=C,c=c.next}while(c!==null);S===null?v=S=s:S=S.next=s}else v=S=s;c={baseState:m.baseState,firstBaseUpdate:v,lastBaseUpdate:S,shared:m.shared,effects:m.effects},r.updateQueue=c;return}r=c.lastBaseUpdate,r===null?c.firstBaseUpdate=s:r.next=s,c.lastBaseUpdate=s}function Vx(r,s,c,m){var v=r.updateQueue;vu=!1;var S=v.firstBaseUpdate,C=v.lastBaseUpdate,o=v.shared.pending;if(o!==null){v.shared.pending=null;var L=o,F=L.next;L.next=null,C===null?S=F:C.next=F,C=L;var Z=r.alternate;Z!==null&&(Z=Z.updateQueue,o=Z.lastBaseUpdate,o!==C&&(o===null?Z.firstBaseUpdate=F:o.next=F,Z.lastBaseUpdate=L))}if(S!==null){var $=v.baseState;C=0,Z=F=L=null,o=S;do{var W=o.lane,ee=o.eventTime;if((m&W)===W){Z!==null&&(Z=Z.next={eventTime:ee,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var ie=r,ae=o;switch(W=s,ee=c,ae.tag){case 1:if(ie=ae.payload,typeof ie=="function"){$=ie.call(ee,$,W);break e}$=ie;break e;case 3:ie.flags=ie.flags&-65537|128;case 0:if(ie=ae.payload,W=typeof ie=="function"?ie.call(ee,$,W):ie,W==null)break e;$=Dn({},$,W);break e;case 2:vu=!0}}o.callback!==null&&o.lane!==0&&(r.flags|=64,W=v.effects,W===null?v.effects=[o]:W.push(o))}else ee={eventTime:ee,lane:W,tag:o.tag,payload:o.payload,callback:o.callback,next:null},Z===null?(F=Z=ee,L=$):Z=Z.next=ee,C|=W;if(o=o.next,o===null){if(o=v.shared.pending,o===null)break;W=o,o=W.next,W.next=null,v.lastBaseUpdate=W,v.shared.pending=null}}while(!0);if(Z===null&&(L=$),v.baseState=L,v.firstBaseUpdate=F,v.lastBaseUpdate=Z,s=v.shared.interleaved,s!==null){v=s;do C|=v.lane,v=v.next;while(v!==s)}else S===null&&(v.shared.lanes=0);oh|=C,r.lanes=C,r.memoizedState=$}}function LA(r,s,c){if(r=s.effects,s.effects=null,r!==null)for(s=0;s<r.length;s++){var m=r[s],v=m.callback;if(v!==null){if(m.callback=null,m=c,typeof v!="function")throw Error(Zt(191,v));v.call(m)}}}var D_={},Pl=Fu(D_),y_=Fu(D_),x_=Fu(D_);function Jd(r){if(r===D_)throw Error(Zt(174));return r}function gS(r,s){switch(xn(x_,s),xn(y_,r),xn(Pl,D_),r=s.nodeType,r){case 9:case 11:s=(s=s.documentElement)?s.namespaceURI:O1(null,"");break;default:r=r===8?s.parentNode:s,s=r.namespaceURI||null,r=r.tagName,s=O1(s,r)}Tn(Pl),xn(Pl,s)}function Ep(){Tn(Pl),Tn(y_),Tn(x_)}function SM(r){Jd(x_.current);var s=Jd(Pl.current),c=O1(s,r.type);s!==c&&(xn(y_,r),xn(Pl,c))}function _S(r){y_.current===r&&(Tn(Pl),Tn(y_))}var Ln=Fu(0);function $x(r){for(var s=r;s!==null;){if(s.tag===13){var c=s.memoizedState;if(c!==null&&(c=c.dehydrated,c===null||c.data==="$?"||c.data==="$!"))return s}else if(s.tag===19&&s.memoizedProps.revealOrder!==void 0){if(s.flags&128)return s}else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===r)break;for(;s.sibling===null;){if(s.return===null||s.return===r)return null;s=s.return}s.sibling.return=s.return,s=s.sibling}return null}var s1=[];function yS(){for(var r=0;r<s1.length;r++)s1[r]._workInProgressVersionPrimary=null;s1.length=0}var yx=wc.ReactCurrentDispatcher,o1=wc.ReactCurrentBatchConfig,sh=0,On=null,ls=null,xs=null,Gx=!1,e_=!1,v_=0,uz=0;function zs(){throw Error(Zt(321))}function xS(r,s){if(s===null)return!1;for(var c=0;c<s.length&&c<r.length;c++)if(!$a(r[c],s[c]))return!1;return!0}function vS(r,s,c,m,v,S){if(sh=S,On=s,s.memoizedState=null,s.updateQueue=null,s.lanes=0,yx.current=r===null||r.memoizedState===null?pz:mz,r=c(m,v),e_){S=0;do{if(e_=!1,v_=0,25<=S)throw Error(Zt(301));S+=1,xs=ls=null,s.updateQueue=null,yx.current=gz,r=c(m,v)}while(e_)}if(yx.current=qx,s=ls!==null&&ls.next!==null,sh=0,xs=ls=On=null,Gx=!1,s)throw Error(Zt(300));return r}function bS(){var r=v_!==0;return v_=0,r}function Sl(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return xs===null?On.memoizedState=xs=r:xs=xs.next=r,xs}function _a(){if(ls===null){var r=On.alternate;r=r!==null?r.memoizedState:null}else r=ls.next;var s=xs===null?On.memoizedState:xs.next;if(s!==null)xs=s,ls=r;else{if(r===null)throw Error(Zt(310));ls=r,r={memoizedState:ls.memoizedState,baseState:ls.baseState,baseQueue:ls.baseQueue,queue:ls.queue,next:null},xs===null?On.memoizedState=xs=r:xs=xs.next=r}return xs}function b_(r,s){return typeof s=="function"?s(r):s}function a1(r){var s=_a(),c=s.queue;if(c===null)throw Error(Zt(311));c.lastRenderedReducer=r;var m=ls,v=m.baseQueue,S=c.pending;if(S!==null){if(v!==null){var C=v.next;v.next=S.next,S.next=C}m.baseQueue=v=S,c.pending=null}if(v!==null){S=v.next,m=m.baseState;var o=C=null,L=null,F=S;do{var Z=F.lane;if((sh&Z)===Z)L!==null&&(L=L.next={lane:0,action:F.action,hasEagerState:F.hasEagerState,eagerState:F.eagerState,next:null}),m=F.hasEagerState?F.eagerState:r(m,F.action);else{var $={lane:Z,action:F.action,hasEagerState:F.hasEagerState,eagerState:F.eagerState,next:null};L===null?(o=L=$,C=m):L=L.next=$,On.lanes|=Z,oh|=Z}F=F.next}while(F!==null&&F!==S);L===null?C=m:L.next=o,$a(m,s.memoizedState)||(So=!0),s.memoizedState=m,s.baseState=C,s.baseQueue=L,c.lastRenderedState=m}if(r=c.interleaved,r!==null){v=r;do S=v.lane,On.lanes|=S,oh|=S,v=v.next;while(v!==r)}else v===null&&(c.lanes=0);return[s.memoizedState,c.dispatch]}function l1(r){var s=_a(),c=s.queue;if(c===null)throw Error(Zt(311));c.lastRenderedReducer=r;var m=c.dispatch,v=c.pending,S=s.memoizedState;if(v!==null){c.pending=null;var C=v=v.next;do S=r(S,C.action),C=C.next;while(C!==v);$a(S,s.memoizedState)||(So=!0),s.memoizedState=S,s.baseQueue===null&&(s.baseState=S),c.lastRenderedState=S}return[S,m]}function TM(){}function EM(r,s){var c=On,m=_a(),v=s(),S=!$a(m.memoizedState,v);if(S&&(m.memoizedState=v,So=!0),m=m.queue,wS(AM.bind(null,c,m,r),[r]),m.getSnapshot!==s||S||xs!==null&&xs.memoizedState.tag&1){if(c.flags|=2048,w_(9,CM.bind(null,c,m,v,s),void 0,null),bs===null)throw Error(Zt(349));sh&30||IM(c,s,v)}return v}function IM(r,s,c){r.flags|=16384,r={getSnapshot:s,value:c},s=On.updateQueue,s===null?(s={lastEffect:null,stores:null},On.updateQueue=s,s.stores=[r]):(c=s.stores,c===null?s.stores=[r]:c.push(r))}function CM(r,s,c,m){s.value=c,s.getSnapshot=m,PM(s)&&kM(r)}function AM(r,s,c){return c(function(){PM(s)&&kM(r)})}function PM(r){var s=r.getSnapshot;r=r.value;try{var c=s();return!$a(r,c)}catch{return!0}}function kM(r){var s=xc(r,1);s!==null&&Va(s,r,1,-1)}function OA(r){var s=Sl();return typeof r=="function"&&(r=r()),s.memoizedState=s.baseState=r,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:b_,lastRenderedState:r},s.queue=r,r=r.dispatch=fz.bind(null,On,r),[s.memoizedState,r]}function w_(r,s,c,m){return r={tag:r,create:s,destroy:c,deps:m,next:null},s=On.updateQueue,s===null?(s={lastEffect:null,stores:null},On.updateQueue=s,s.lastEffect=r.next=r):(c=s.lastEffect,c===null?s.lastEffect=r.next=r:(m=c.next,c.next=r,r.next=m,s.lastEffect=r)),r}function MM(){return _a().memoizedState}function xx(r,s,c,m){var v=Sl();On.flags|=r,v.memoizedState=w_(1|s,c,void 0,m===void 0?null:m)}function gv(r,s,c,m){var v=_a();m=m===void 0?null:m;var S=void 0;if(ls!==null){var C=ls.memoizedState;if(S=C.destroy,m!==null&&xS(m,C.deps)){v.memoizedState=w_(s,c,S,m);return}}On.flags|=r,v.memoizedState=w_(1|s,c,S,m)}function DA(r,s){return xx(8390656,8,r,s)}function wS(r,s){return gv(2048,8,r,s)}function NM(r,s){return gv(4,2,r,s)}function RM(r,s){return gv(4,4,r,s)}function LM(r,s){if(typeof s=="function")return r=r(),s(r),function(){s(null)};if(s!=null)return r=r(),s.current=r,function(){s.current=null}}function OM(r,s,c){return c=c!=null?c.concat([r]):null,gv(4,4,LM.bind(null,s,r),c)}function SS(){}function DM(r,s){var c=_a();s=s===void 0?null:s;var m=c.memoizedState;return m!==null&&s!==null&&xS(s,m[1])?m[0]:(c.memoizedState=[r,s],r)}function jM(r,s){var c=_a();s=s===void 0?null:s;var m=c.memoizedState;return m!==null&&s!==null&&xS(s,m[1])?m[0]:(r=r(),c.memoizedState=[r,s],r)}function zM(r,s,c){return sh&21?($a(c,s)||(c=$k(),On.lanes|=c,oh|=c,r.baseState=!0),s):(r.baseState&&(r.baseState=!1,So=!0),r.memoizedState=c)}function dz(r,s){var c=rn;rn=c!==0&&4>c?c:4,r(!0);var m=o1.transition;o1.transition={};try{r(!1),s()}finally{rn=c,o1.transition=m}}function FM(){return _a().memoizedState}function hz(r,s,c){var m=Ru(r);if(c={lane:m,action:c,hasEagerState:!1,eagerState:null,next:null},BM(r))UM(s,c);else if(c=bM(r,s,c,m),c!==null){var v=ao();Va(c,r,m,v),VM(c,s,m)}}function fz(r,s,c){var m=Ru(r),v={lane:m,action:c,hasEagerState:!1,eagerState:null,next:null};if(BM(r))UM(s,v);else{var S=r.alternate;if(r.lanes===0&&(S===null||S.lanes===0)&&(S=s.lastRenderedReducer,S!==null))try{var C=s.lastRenderedState,o=S(C,c);if(v.hasEagerState=!0,v.eagerState=o,$a(o,C)){var L=s.interleaved;L===null?(v.next=v,pS(s)):(v.next=L.next,L.next=v),s.interleaved=v;return}}catch{}finally{}c=bM(r,s,v,m),c!==null&&(v=ao(),Va(c,r,m,v),VM(c,s,m))}}function BM(r){var s=r.alternate;return r===On||s!==null&&s===On}function UM(r,s){e_=Gx=!0;var c=r.pending;c===null?s.next=s:(s.next=c.next,c.next=s),r.pending=s}function VM(r,s,c){if(c&4194240){var m=s.lanes;m&=r.pendingLanes,c|=m,s.lanes=c,eS(r,c)}}var qx={readContext:ga,useCallback:zs,useContext:zs,useEffect:zs,useImperativeHandle:zs,useInsertionEffect:zs,useLayoutEffect:zs,useMemo:zs,useReducer:zs,useRef:zs,useState:zs,useDebugValue:zs,useDeferredValue:zs,useTransition:zs,useMutableSource:zs,useSyncExternalStore:zs,useId:zs,unstable_isNewReconciler:!1},pz={readContext:ga,useCallback:function(r,s){return Sl().memoizedState=[r,s===void 0?null:s],r},useContext:ga,useEffect:DA,useImperativeHandle:function(r,s,c){return c=c!=null?c.concat([r]):null,xx(4194308,4,LM.bind(null,s,r),c)},useLayoutEffect:function(r,s){return xx(4194308,4,r,s)},useInsertionEffect:function(r,s){return xx(4,2,r,s)},useMemo:function(r,s){var c=Sl();return s=s===void 0?null:s,r=r(),c.memoizedState=[r,s],r},useReducer:function(r,s,c){var m=Sl();return s=c!==void 0?c(s):s,m.memoizedState=m.baseState=s,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:s},m.queue=r,r=r.dispatch=hz.bind(null,On,r),[m.memoizedState,r]},useRef:function(r){var s=Sl();return r={current:r},s.memoizedState=r},useState:OA,useDebugValue:SS,useDeferredValue:function(r){return Sl().memoizedState=r},useTransition:function(){var r=OA(!1),s=r[0];return r=dz.bind(null,r[1]),Sl().memoizedState=r,[s,r]},useMutableSource:function(){},useSyncExternalStore:function(r,s,c){var m=On,v=Sl();if(Mn){if(c===void 0)throw Error(Zt(407));c=c()}else{if(c=s(),bs===null)throw Error(Zt(349));sh&30||IM(m,s,c)}v.memoizedState=c;var S={value:c,getSnapshot:s};return v.queue=S,DA(AM.bind(null,m,S,r),[r]),m.flags|=2048,w_(9,CM.bind(null,m,S,c,s),void 0,null),c},useId:function(){var r=Sl(),s=bs.identifierPrefix;if(Mn){var c=mc,m=pc;c=(m&~(1<<32-Ua(m)-1)).toString(32)+c,s=":"+s+"R"+c,c=v_++,0<c&&(s+="H"+c.toString(32)),s+=":"}else c=uz++,s=":"+s+"r"+c.toString(32)+":";return r.memoizedState=s},unstable_isNewReconciler:!1},mz={readContext:ga,useCallback:DM,useContext:ga,useEffect:wS,useImperativeHandle:OM,useInsertionEffect:NM,useLayoutEffect:RM,useMemo:jM,useReducer:a1,useRef:MM,useState:function(){return a1(b_)},useDebugValue:SS,useDeferredValue:function(r){var s=_a();return zM(s,ls.memoizedState,r)},useTransition:function(){var r=a1(b_)[0],s=_a().memoizedState;return[r,s]},useMutableSource:TM,useSyncExternalStore:EM,useId:FM,unstable_isNewReconciler:!1},gz={readContext:ga,useCallback:DM,useContext:ga,useEffect:wS,useImperativeHandle:OM,useInsertionEffect:NM,useLayoutEffect:RM,useMemo:jM,useReducer:l1,useRef:MM,useState:function(){return l1(b_)},useDebugValue:SS,useDeferredValue:function(r){var s=_a();return ls===null?s.memoizedState=r:zM(s,ls.memoizedState,r)},useTransition:function(){var r=l1(b_)[0],s=_a().memoizedState;return[r,s]},useMutableSource:TM,useSyncExternalStore:EM,useId:FM,unstable_isNewReconciler:!1};function ja(r,s){if(r&&r.defaultProps){s=Dn({},s),r=r.defaultProps;for(var c in r)s[c]===void 0&&(s[c]=r[c]);return s}return s}function r2(r,s,c,m){s=r.memoizedState,c=c(m,s),c=c==null?s:Dn({},s,c),r.memoizedState=c,r.lanes===0&&(r.updateQueue.baseState=c)}var _v={isMounted:function(r){return(r=r._reactInternals)?uh(r)===r:!1},enqueueSetState:function(r,s,c){r=r._reactInternals;var m=ao(),v=Ru(r),S=gc(m,v);S.payload=s,c!=null&&(S.callback=c),s=Mu(r,S,v),s!==null&&(Va(s,r,v,m),_x(s,r,v))},enqueueReplaceState:function(r,s,c){r=r._reactInternals;var m=ao(),v=Ru(r),S=gc(m,v);S.tag=1,S.payload=s,c!=null&&(S.callback=c),s=Mu(r,S,v),s!==null&&(Va(s,r,v,m),_x(s,r,v))},enqueueForceUpdate:function(r,s){r=r._reactInternals;var c=ao(),m=Ru(r),v=gc(c,m);v.tag=2,s!=null&&(v.callback=s),s=Mu(r,v,m),s!==null&&(Va(s,r,m,c),_x(s,r,m))}};function jA(r,s,c,m,v,S,C){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(m,S,C):s.prototype&&s.prototype.isPureReactComponent?!p_(c,m)||!p_(v,S):!0}function $M(r,s,c){var m=!1,v=Du,S=s.contextType;return typeof S=="object"&&S!==null?S=ga(S):(v=Eo(s)?ih:Vs.current,m=s.contextTypes,S=(m=m!=null)?wp(r,v):Du),s=new s(c,S),r.memoizedState=s.state!==null&&s.state!==void 0?s.state:null,s.updater=_v,r.stateNode=s,s._reactInternals=r,m&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=v,r.__reactInternalMemoizedMaskedChildContext=S),s}function zA(r,s,c,m){r=s.state,typeof s.componentWillReceiveProps=="function"&&s.componentWillReceiveProps(c,m),typeof s.UNSAFE_componentWillReceiveProps=="function"&&s.UNSAFE_componentWillReceiveProps(c,m),s.state!==r&&_v.enqueueReplaceState(s,s.state,null)}function i2(r,s,c,m){var v=r.stateNode;v.props=c,v.state=r.memoizedState,v.refs={},mS(r);var S=s.contextType;typeof S=="object"&&S!==null?v.context=ga(S):(S=Eo(s)?ih:Vs.current,v.context=wp(r,S)),v.state=r.memoizedState,S=s.getDerivedStateFromProps,typeof S=="function"&&(r2(r,s,S,c),v.state=r.memoizedState),typeof s.getDerivedStateFromProps=="function"||typeof v.getSnapshotBeforeUpdate=="function"||typeof v.UNSAFE_componentWillMount!="function"&&typeof v.componentWillMount!="function"||(s=v.state,typeof v.componentWillMount=="function"&&v.componentWillMount(),typeof v.UNSAFE_componentWillMount=="function"&&v.UNSAFE_componentWillMount(),s!==v.state&&_v.enqueueReplaceState(v,v.state,null),Vx(r,c,v,m),v.state=r.memoizedState),typeof v.componentDidMount=="function"&&(r.flags|=4194308)}function Ip(r,s){try{var c="",m=s;do c+=GD(m),m=m.return;while(m);var v=c}catch(S){v=`
Error generating stack: `+S.message+`
`+S.stack}return{value:r,source:s,stack:v,digest:null}}function c1(r,s,c){return{value:r,source:null,stack:c??null,digest:s??null}}function n2(r,s){try{console.error(s.value)}catch(c){setTimeout(function(){throw c})}}var _z=typeof WeakMap=="function"?WeakMap:Map;function GM(r,s,c){c=gc(-1,c),c.tag=3,c.payload={element:null};var m=s.value;return c.callback=function(){Wx||(Wx=!0,p2=m),n2(r,s)},c}function qM(r,s,c){c=gc(-1,c),c.tag=3;var m=r.type.getDerivedStateFromError;if(typeof m=="function"){var v=s.value;c.payload=function(){return m(v)},c.callback=function(){n2(r,s)}}var S=r.stateNode;return S!==null&&typeof S.componentDidCatch=="function"&&(c.callback=function(){n2(r,s),typeof m!="function"&&(Nu===null?Nu=new Set([this]):Nu.add(this));var C=s.stack;this.componentDidCatch(s.value,{componentStack:C!==null?C:""})}),c}function FA(r,s,c){var m=r.pingCache;if(m===null){m=r.pingCache=new _z;var v=new Set;m.set(s,v)}else v=m.get(s),v===void 0&&(v=new Set,m.set(s,v));v.has(c)||(v.add(c),r=Mz.bind(null,r,s,c),s.then(r,r))}function BA(r){do{var s;if((s=r.tag===13)&&(s=r.memoizedState,s=s!==null?s.dehydrated!==null:!0),s)return r;r=r.return}while(r!==null);return null}function UA(r,s,c,m,v){return r.mode&1?(r.flags|=65536,r.lanes=v,r):(r===s?r.flags|=65536:(r.flags|=128,c.flags|=131072,c.flags&=-52805,c.tag===1&&(c.alternate===null?c.tag=17:(s=gc(-1,1),s.tag=2,Mu(c,s,1))),c.lanes|=1),r)}var yz=wc.ReactCurrentOwner,So=!1;function so(r,s,c,m){s.child=r===null?vM(s,null,c,m):Tp(s,r.child,c,m)}function VA(r,s,c,m,v){c=c.render;var S=s.ref;return gp(s,v),m=vS(r,s,c,m,S,v),c=bS(),r!==null&&!So?(s.updateQueue=r.updateQueue,s.flags&=-2053,r.lanes&=~v,vc(r,s,v)):(Mn&&c&&lS(s),s.flags|=1,so(r,s,m,v),s.child)}function $A(r,s,c,m,v){if(r===null){var S=c.type;return typeof S=="function"&&!MS(S)&&S.defaultProps===void 0&&c.compare===null&&c.defaultProps===void 0?(s.tag=15,s.type=S,HM(r,s,S,m,v)):(r=Sx(c.type,null,m,s,s.mode,v),r.ref=s.ref,r.return=s,s.child=r)}if(S=r.child,!(r.lanes&v)){var C=S.memoizedProps;if(c=c.compare,c=c!==null?c:p_,c(C,m)&&r.ref===s.ref)return vc(r,s,v)}return s.flags|=1,r=Lu(S,m),r.ref=s.ref,r.return=s,s.child=r}function HM(r,s,c,m,v){if(r!==null){var S=r.memoizedProps;if(p_(S,m)&&r.ref===s.ref)if(So=!1,s.pendingProps=m=S,(r.lanes&v)!==0)r.flags&131072&&(So=!0);else return s.lanes=r.lanes,vc(r,s,v)}return s2(r,s,c,m,v)}function WM(r,s,c){var m=s.pendingProps,v=m.children,S=r!==null?r.memoizedState:null;if(m.mode==="hidden")if(!(s.mode&1))s.memoizedState={baseLanes:0,cachePool:null,transitions:null},xn(dp,$o),$o|=c;else{if(!(c&1073741824))return r=S!==null?S.baseLanes|c:c,s.lanes=s.childLanes=1073741824,s.memoizedState={baseLanes:r,cachePool:null,transitions:null},s.updateQueue=null,xn(dp,$o),$o|=r,null;s.memoizedState={baseLanes:0,cachePool:null,transitions:null},m=S!==null?S.baseLanes:c,xn(dp,$o),$o|=m}else S!==null?(m=S.baseLanes|c,s.memoizedState=null):m=c,xn(dp,$o),$o|=m;return so(r,s,v,c),s.child}function ZM(r,s){var c=s.ref;(r===null&&c!==null||r!==null&&r.ref!==c)&&(s.flags|=512,s.flags|=2097152)}function s2(r,s,c,m,v){var S=Eo(c)?ih:Vs.current;return S=wp(s,S),gp(s,v),c=vS(r,s,c,m,S,v),m=bS(),r!==null&&!So?(s.updateQueue=r.updateQueue,s.flags&=-2053,r.lanes&=~v,vc(r,s,v)):(Mn&&m&&lS(s),s.flags|=1,so(r,s,c,v),s.child)}function GA(r,s,c,m,v){if(Eo(c)){var S=!0;jx(s)}else S=!1;if(gp(s,v),s.stateNode===null)vx(r,s),$M(s,c,m),i2(s,c,m,v),m=!0;else if(r===null){var C=s.stateNode,o=s.memoizedProps;C.props=o;var L=C.context,F=c.contextType;typeof F=="object"&&F!==null?F=ga(F):(F=Eo(c)?ih:Vs.current,F=wp(s,F));var Z=c.getDerivedStateFromProps,$=typeof Z=="function"||typeof C.getSnapshotBeforeUpdate=="function";$||typeof C.UNSAFE_componentWillReceiveProps!="function"&&typeof C.componentWillReceiveProps!="function"||(o!==m||L!==F)&&zA(s,C,m,F),vu=!1;var W=s.memoizedState;C.state=W,Vx(s,m,C,v),L=s.memoizedState,o!==m||W!==L||To.current||vu?(typeof Z=="function"&&(r2(s,c,Z,m),L=s.memoizedState),(o=vu||jA(s,c,o,m,W,L,F))?($||typeof C.UNSAFE_componentWillMount!="function"&&typeof C.componentWillMount!="function"||(typeof C.componentWillMount=="function"&&C.componentWillMount(),typeof C.UNSAFE_componentWillMount=="function"&&C.UNSAFE_componentWillMount()),typeof C.componentDidMount=="function"&&(s.flags|=4194308)):(typeof C.componentDidMount=="function"&&(s.flags|=4194308),s.memoizedProps=m,s.memoizedState=L),C.props=m,C.state=L,C.context=F,m=o):(typeof C.componentDidMount=="function"&&(s.flags|=4194308),m=!1)}else{C=s.stateNode,wM(r,s),o=s.memoizedProps,F=s.type===s.elementType?o:ja(s.type,o),C.props=F,$=s.pendingProps,W=C.context,L=c.contextType,typeof L=="object"&&L!==null?L=ga(L):(L=Eo(c)?ih:Vs.current,L=wp(s,L));var ee=c.getDerivedStateFromProps;(Z=typeof ee=="function"||typeof C.getSnapshotBeforeUpdate=="function")||typeof C.UNSAFE_componentWillReceiveProps!="function"&&typeof C.componentWillReceiveProps!="function"||(o!==$||W!==L)&&zA(s,C,m,L),vu=!1,W=s.memoizedState,C.state=W,Vx(s,m,C,v);var ie=s.memoizedState;o!==$||W!==ie||To.current||vu?(typeof ee=="function"&&(r2(s,c,ee,m),ie=s.memoizedState),(F=vu||jA(s,c,F,m,W,ie,L)||!1)?(Z||typeof C.UNSAFE_componentWillUpdate!="function"&&typeof C.componentWillUpdate!="function"||(typeof C.componentWillUpdate=="function"&&C.componentWillUpdate(m,ie,L),typeof C.UNSAFE_componentWillUpdate=="function"&&C.UNSAFE_componentWillUpdate(m,ie,L)),typeof C.componentDidUpdate=="function"&&(s.flags|=4),typeof C.getSnapshotBeforeUpdate=="function"&&(s.flags|=1024)):(typeof C.componentDidUpdate!="function"||o===r.memoizedProps&&W===r.memoizedState||(s.flags|=4),typeof C.getSnapshotBeforeUpdate!="function"||o===r.memoizedProps&&W===r.memoizedState||(s.flags|=1024),s.memoizedProps=m,s.memoizedState=ie),C.props=m,C.state=ie,C.context=L,m=F):(typeof C.componentDidUpdate!="function"||o===r.memoizedProps&&W===r.memoizedState||(s.flags|=4),typeof C.getSnapshotBeforeUpdate!="function"||o===r.memoizedProps&&W===r.memoizedState||(s.flags|=1024),m=!1)}return o2(r,s,c,m,S,v)}function o2(r,s,c,m,v,S){ZM(r,s);var C=(s.flags&128)!==0;if(!m&&!C)return v&&PA(s,c,!1),vc(r,s,S);m=s.stateNode,yz.current=s;var o=C&&typeof c.getDerivedStateFromError!="function"?null:m.render();return s.flags|=1,r!==null&&C?(s.child=Tp(s,r.child,null,S),s.child=Tp(s,null,o,S)):so(r,s,o,S),s.memoizedState=m.state,v&&PA(s,c,!0),s.child}function XM(r){var s=r.stateNode;s.pendingContext?AA(r,s.pendingContext,s.pendingContext!==s.context):s.context&&AA(r,s.context,!1),gS(r,s.containerInfo)}function qA(r,s,c,m,v){return Sp(),uS(v),s.flags|=256,so(r,s,c,m),s.child}var a2={dehydrated:null,treeContext:null,retryLane:0};function l2(r){return{baseLanes:r,cachePool:null,transitions:null}}function YM(r,s,c){var m=s.pendingProps,v=Ln.current,S=!1,C=(s.flags&128)!==0,o;if((o=C)||(o=r!==null&&r.memoizedState===null?!1:(v&2)!==0),o?(S=!0,s.flags&=-129):(r===null||r.memoizedState!==null)&&(v|=1),xn(Ln,v&1),r===null)return e2(s),r=s.memoizedState,r!==null&&(r=r.dehydrated,r!==null)?(s.mode&1?r.data==="$!"?s.lanes=8:s.lanes=1073741824:s.lanes=1,null):(C=m.children,r=m.fallback,S?(m=s.mode,S=s.child,C={mode:"hidden",children:C},!(m&1)&&S!==null?(S.childLanes=0,S.pendingProps=C):S=vv(C,m,0,null),r=rh(r,m,c,null),S.return=s,r.return=s,S.sibling=r,s.child=S,s.child.memoizedState=l2(c),s.memoizedState=a2,r):TS(s,C));if(v=r.memoizedState,v!==null&&(o=v.dehydrated,o!==null))return xz(r,s,C,m,o,v,c);if(S){S=m.fallback,C=s.mode,v=r.child,o=v.sibling;var L={mode:"hidden",children:m.children};return!(C&1)&&s.child!==v?(m=s.child,m.childLanes=0,m.pendingProps=L,s.deletions=null):(m=Lu(v,L),m.subtreeFlags=v.subtreeFlags&14680064),o!==null?S=Lu(o,S):(S=rh(S,C,c,null),S.flags|=2),S.return=s,m.return=s,m.sibling=S,s.child=m,m=S,S=s.child,C=r.child.memoizedState,C=C===null?l2(c):{baseLanes:C.baseLanes|c,cachePool:null,transitions:C.transitions},S.memoizedState=C,S.childLanes=r.childLanes&~c,s.memoizedState=a2,m}return S=r.child,r=S.sibling,m=Lu(S,{mode:"visible",children:m.children}),!(s.mode&1)&&(m.lanes=c),m.return=s,m.sibling=null,r!==null&&(c=s.deletions,c===null?(s.deletions=[r],s.flags|=16):c.push(r)),s.child=m,s.memoizedState=null,m}function TS(r,s){return s=vv({mode:"visible",children:s},r.mode,0,null),s.return=r,r.child=s}function ex(r,s,c,m){return m!==null&&uS(m),Tp(s,r.child,null,c),r=TS(s,s.pendingProps.children),r.flags|=2,s.memoizedState=null,r}function xz(r,s,c,m,v,S,C){if(c)return s.flags&256?(s.flags&=-257,m=c1(Error(Zt(422))),ex(r,s,C,m)):s.memoizedState!==null?(s.child=r.child,s.flags|=128,null):(S=m.fallback,v=s.mode,m=vv({mode:"visible",children:m.children},v,0,null),S=rh(S,v,C,null),S.flags|=2,m.return=s,S.return=s,m.sibling=S,s.child=m,s.mode&1&&Tp(s,r.child,null,C),s.child.memoizedState=l2(C),s.memoizedState=a2,S);if(!(s.mode&1))return ex(r,s,C,null);if(v.data==="$!"){if(m=v.nextSibling&&v.nextSibling.dataset,m)var o=m.dgst;return m=o,S=Error(Zt(419)),m=c1(S,m,void 0),ex(r,s,C,m)}if(o=(C&r.childLanes)!==0,So||o){if(m=bs,m!==null){switch(C&-C){case 4:v=2;break;case 16:v=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:v=32;break;case 536870912:v=268435456;break;default:v=0}v=v&(m.suspendedLanes|C)?0:v,v!==0&&v!==S.retryLane&&(S.retryLane=v,xc(r,v),Va(m,r,v,-1))}return kS(),m=c1(Error(Zt(421))),ex(r,s,C,m)}return v.data==="$?"?(s.flags|=128,s.child=r.child,s=Nz.bind(null,r),v._reactRetry=s,null):(r=S.treeContext,Go=ku(v.nextSibling),qo=s,Mn=!0,Ba=null,r!==null&&(ua[da++]=pc,ua[da++]=mc,ua[da++]=nh,pc=r.id,mc=r.overflow,nh=s),s=TS(s,m.children),s.flags|=4096,s)}function HA(r,s,c){r.lanes|=s;var m=r.alternate;m!==null&&(m.lanes|=s),t2(r.return,s,c)}function u1(r,s,c,m,v){var S=r.memoizedState;S===null?r.memoizedState={isBackwards:s,rendering:null,renderingStartTime:0,last:m,tail:c,tailMode:v}:(S.isBackwards=s,S.rendering=null,S.renderingStartTime=0,S.last=m,S.tail=c,S.tailMode=v)}function KM(r,s,c){var m=s.pendingProps,v=m.revealOrder,S=m.tail;if(so(r,s,m.children,c),m=Ln.current,m&2)m=m&1|2,s.flags|=128;else{if(r!==null&&r.flags&128)e:for(r=s.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&HA(r,c,s);else if(r.tag===19)HA(r,c,s);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===s)break e;for(;r.sibling===null;){if(r.return===null||r.return===s)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}m&=1}if(xn(Ln,m),!(s.mode&1))s.memoizedState=null;else switch(v){case"forwards":for(c=s.child,v=null;c!==null;)r=c.alternate,r!==null&&$x(r)===null&&(v=c),c=c.sibling;c=v,c===null?(v=s.child,s.child=null):(v=c.sibling,c.sibling=null),u1(s,!1,v,c,S);break;case"backwards":for(c=null,v=s.child,s.child=null;v!==null;){if(r=v.alternate,r!==null&&$x(r)===null){s.child=v;break}r=v.sibling,v.sibling=c,c=v,v=r}u1(s,!0,c,null,S);break;case"together":u1(s,!1,null,null,void 0);break;default:s.memoizedState=null}return s.child}function vx(r,s){!(s.mode&1)&&r!==null&&(r.alternate=null,s.alternate=null,s.flags|=2)}function vc(r,s,c){if(r!==null&&(s.dependencies=r.dependencies),oh|=s.lanes,!(c&s.childLanes))return null;if(r!==null&&s.child!==r.child)throw Error(Zt(153));if(s.child!==null){for(r=s.child,c=Lu(r,r.pendingProps),s.child=c,c.return=s;r.sibling!==null;)r=r.sibling,c=c.sibling=Lu(r,r.pendingProps),c.return=s;c.sibling=null}return s.child}function vz(r,s,c){switch(s.tag){case 3:XM(s),Sp();break;case 5:SM(s);break;case 1:Eo(s.type)&&jx(s);break;case 4:gS(s,s.stateNode.containerInfo);break;case 10:var m=s.type._context,v=s.memoizedProps.value;xn(Bx,m._currentValue),m._currentValue=v;break;case 13:if(m=s.memoizedState,m!==null)return m.dehydrated!==null?(xn(Ln,Ln.current&1),s.flags|=128,null):c&s.child.childLanes?YM(r,s,c):(xn(Ln,Ln.current&1),r=vc(r,s,c),r!==null?r.sibling:null);xn(Ln,Ln.current&1);break;case 19:if(m=(c&s.childLanes)!==0,r.flags&128){if(m)return KM(r,s,c);s.flags|=128}if(v=s.memoizedState,v!==null&&(v.rendering=null,v.tail=null,v.lastEffect=null),xn(Ln,Ln.current),m)break;return null;case 22:case 23:return s.lanes=0,WM(r,s,c)}return vc(r,s,c)}var JM,c2,QM,eN;JM=function(r,s){for(var c=s.child;c!==null;){if(c.tag===5||c.tag===6)r.appendChild(c.stateNode);else if(c.tag!==4&&c.child!==null){c.child.return=c,c=c.child;continue}if(c===s)break;for(;c.sibling===null;){if(c.return===null||c.return===s)return;c=c.return}c.sibling.return=c.return,c=c.sibling}};c2=function(){};QM=function(r,s,c,m){var v=r.memoizedProps;if(v!==m){r=s.stateNode,Jd(Pl.current);var S=null;switch(c){case"input":v=M1(r,v),m=M1(r,m),S=[];break;case"select":v=Dn({},v,{value:void 0}),m=Dn({},m,{value:void 0}),S=[];break;case"textarea":v=L1(r,v),m=L1(r,m),S=[];break;default:typeof v.onClick!="function"&&typeof m.onClick=="function"&&(r.onclick=Ox)}D1(c,m);var C;c=null;for(F in v)if(!m.hasOwnProperty(F)&&v.hasOwnProperty(F)&&v[F]!=null)if(F==="style"){var o=v[F];for(C in o)o.hasOwnProperty(C)&&(c||(c={}),c[C]="")}else F!=="dangerouslySetInnerHTML"&&F!=="children"&&F!=="suppressContentEditableWarning"&&F!=="suppressHydrationWarning"&&F!=="autoFocus"&&(a_.hasOwnProperty(F)?S||(S=[]):(S=S||[]).push(F,null));for(F in m){var L=m[F];if(o=v!=null?v[F]:void 0,m.hasOwnProperty(F)&&L!==o&&(L!=null||o!=null))if(F==="style")if(o){for(C in o)!o.hasOwnProperty(C)||L&&L.hasOwnProperty(C)||(c||(c={}),c[C]="");for(C in L)L.hasOwnProperty(C)&&o[C]!==L[C]&&(c||(c={}),c[C]=L[C])}else c||(S||(S=[]),S.push(F,c)),c=L;else F==="dangerouslySetInnerHTML"?(L=L?L.__html:void 0,o=o?o.__html:void 0,L!=null&&o!==L&&(S=S||[]).push(F,L)):F==="children"?typeof L!="string"&&typeof L!="number"||(S=S||[]).push(F,""+L):F!=="suppressContentEditableWarning"&&F!=="suppressHydrationWarning"&&(a_.hasOwnProperty(F)?(L!=null&&F==="onScroll"&&Sn("scroll",r),S||o===L||(S=[])):(S=S||[]).push(F,L))}c&&(S=S||[]).push("style",c);var F=S;(s.updateQueue=F)&&(s.flags|=4)}};eN=function(r,s,c,m){c!==m&&(s.flags|=4)};function Bg(r,s){if(!Mn)switch(r.tailMode){case"hidden":s=r.tail;for(var c=null;s!==null;)s.alternate!==null&&(c=s),s=s.sibling;c===null?r.tail=null:c.sibling=null;break;case"collapsed":c=r.tail;for(var m=null;c!==null;)c.alternate!==null&&(m=c),c=c.sibling;m===null?s||r.tail===null?r.tail=null:r.tail.sibling=null:m.sibling=null}}function Fs(r){var s=r.alternate!==null&&r.alternate.child===r.child,c=0,m=0;if(s)for(var v=r.child;v!==null;)c|=v.lanes|v.childLanes,m|=v.subtreeFlags&14680064,m|=v.flags&14680064,v.return=r,v=v.sibling;else for(v=r.child;v!==null;)c|=v.lanes|v.childLanes,m|=v.subtreeFlags,m|=v.flags,v.return=r,v=v.sibling;return r.subtreeFlags|=m,r.childLanes=c,s}function bz(r,s,c){var m=s.pendingProps;switch(cS(s),s.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Fs(s),null;case 1:return Eo(s.type)&&Dx(),Fs(s),null;case 3:return m=s.stateNode,Ep(),Tn(To),Tn(Vs),yS(),m.pendingContext&&(m.context=m.pendingContext,m.pendingContext=null),(r===null||r.child===null)&&(Jy(s)?s.flags|=4:r===null||r.memoizedState.isDehydrated&&!(s.flags&256)||(s.flags|=1024,Ba!==null&&(_2(Ba),Ba=null))),c2(r,s),Fs(s),null;case 5:_S(s);var v=Jd(x_.current);if(c=s.type,r!==null&&s.stateNode!=null)QM(r,s,c,m,v),r.ref!==s.ref&&(s.flags|=512,s.flags|=2097152);else{if(!m){if(s.stateNode===null)throw Error(Zt(166));return Fs(s),null}if(r=Jd(Pl.current),Jy(s)){m=s.stateNode,c=s.type;var S=s.memoizedProps;switch(m[El]=s,m[__]=S,r=(s.mode&1)!==0,c){case"dialog":Sn("cancel",m),Sn("close",m);break;case"iframe":case"object":case"embed":Sn("load",m);break;case"video":case"audio":for(v=0;v<Wg.length;v++)Sn(Wg[v],m);break;case"source":Sn("error",m);break;case"img":case"image":case"link":Sn("error",m),Sn("load",m);break;case"details":Sn("toggle",m);break;case"input":tA(m,S),Sn("invalid",m);break;case"select":m._wrapperState={wasMultiple:!!S.multiple},Sn("invalid",m);break;case"textarea":iA(m,S),Sn("invalid",m)}D1(c,S),v=null;for(var C in S)if(S.hasOwnProperty(C)){var o=S[C];C==="children"?typeof o=="string"?m.textContent!==o&&(S.suppressHydrationWarning!==!0&&Ky(m.textContent,o,r),v=["children",o]):typeof o=="number"&&m.textContent!==""+o&&(S.suppressHydrationWarning!==!0&&Ky(m.textContent,o,r),v=["children",""+o]):a_.hasOwnProperty(C)&&o!=null&&C==="onScroll"&&Sn("scroll",m)}switch(c){case"input":$y(m),rA(m,S,!0);break;case"textarea":$y(m),nA(m);break;case"select":case"option":break;default:typeof S.onClick=="function"&&(m.onclick=Ox)}m=v,s.updateQueue=m,m!==null&&(s.flags|=4)}else{C=v.nodeType===9?v:v.ownerDocument,r==="http://www.w3.org/1999/xhtml"&&(r=Ak(c)),r==="http://www.w3.org/1999/xhtml"?c==="script"?(r=C.createElement("div"),r.innerHTML="<script><\/script>",r=r.removeChild(r.firstChild)):typeof m.is=="string"?r=C.createElement(c,{is:m.is}):(r=C.createElement(c),c==="select"&&(C=r,m.multiple?C.multiple=!0:m.size&&(C.size=m.size))):r=C.createElementNS(r,c),r[El]=s,r[__]=m,JM(r,s,!1,!1),s.stateNode=r;e:{switch(C=j1(c,m),c){case"dialog":Sn("cancel",r),Sn("close",r),v=m;break;case"iframe":case"object":case"embed":Sn("load",r),v=m;break;case"video":case"audio":for(v=0;v<Wg.length;v++)Sn(Wg[v],r);v=m;break;case"source":Sn("error",r),v=m;break;case"img":case"image":case"link":Sn("error",r),Sn("load",r),v=m;break;case"details":Sn("toggle",r),v=m;break;case"input":tA(r,m),v=M1(r,m),Sn("invalid",r);break;case"option":v=m;break;case"select":r._wrapperState={wasMultiple:!!m.multiple},v=Dn({},m,{value:void 0}),Sn("invalid",r);break;case"textarea":iA(r,m),v=L1(r,m),Sn("invalid",r);break;default:v=m}D1(c,v),o=v;for(S in o)if(o.hasOwnProperty(S)){var L=o[S];S==="style"?Mk(r,L):S==="dangerouslySetInnerHTML"?(L=L?L.__html:void 0,L!=null&&Pk(r,L)):S==="children"?typeof L=="string"?(c!=="textarea"||L!=="")&&l_(r,L):typeof L=="number"&&l_(r,""+L):S!=="suppressContentEditableWarning"&&S!=="suppressHydrationWarning"&&S!=="autoFocus"&&(a_.hasOwnProperty(S)?L!=null&&S==="onScroll"&&Sn("scroll",r):L!=null&&Z2(r,S,L,C))}switch(c){case"input":$y(r),rA(r,m,!1);break;case"textarea":$y(r),nA(r);break;case"option":m.value!=null&&r.setAttribute("value",""+Ou(m.value));break;case"select":r.multiple=!!m.multiple,S=m.value,S!=null?hp(r,!!m.multiple,S,!1):m.defaultValue!=null&&hp(r,!!m.multiple,m.defaultValue,!0);break;default:typeof v.onClick=="function"&&(r.onclick=Ox)}switch(c){case"button":case"input":case"select":case"textarea":m=!!m.autoFocus;break e;case"img":m=!0;break e;default:m=!1}}m&&(s.flags|=4)}s.ref!==null&&(s.flags|=512,s.flags|=2097152)}return Fs(s),null;case 6:if(r&&s.stateNode!=null)eN(r,s,r.memoizedProps,m);else{if(typeof m!="string"&&s.stateNode===null)throw Error(Zt(166));if(c=Jd(x_.current),Jd(Pl.current),Jy(s)){if(m=s.stateNode,c=s.memoizedProps,m[El]=s,(S=m.nodeValue!==c)&&(r=qo,r!==null))switch(r.tag){case 3:Ky(m.nodeValue,c,(r.mode&1)!==0);break;case 5:r.memoizedProps.suppressHydrationWarning!==!0&&Ky(m.nodeValue,c,(r.mode&1)!==0)}S&&(s.flags|=4)}else m=(c.nodeType===9?c:c.ownerDocument).createTextNode(m),m[El]=s,s.stateNode=m}return Fs(s),null;case 13:if(Tn(Ln),m=s.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(Mn&&Go!==null&&s.mode&1&&!(s.flags&128))yM(),Sp(),s.flags|=98560,S=!1;else if(S=Jy(s),m!==null&&m.dehydrated!==null){if(r===null){if(!S)throw Error(Zt(318));if(S=s.memoizedState,S=S!==null?S.dehydrated:null,!S)throw Error(Zt(317));S[El]=s}else Sp(),!(s.flags&128)&&(s.memoizedState=null),s.flags|=4;Fs(s),S=!1}else Ba!==null&&(_2(Ba),Ba=null),S=!0;if(!S)return s.flags&65536?s:null}return s.flags&128?(s.lanes=c,s):(m=m!==null,m!==(r!==null&&r.memoizedState!==null)&&m&&(s.child.flags|=8192,s.mode&1&&(r===null||Ln.current&1?cs===0&&(cs=3):kS())),s.updateQueue!==null&&(s.flags|=4),Fs(s),null);case 4:return Ep(),c2(r,s),r===null&&m_(s.stateNode.containerInfo),Fs(s),null;case 10:return fS(s.type._context),Fs(s),null;case 17:return Eo(s.type)&&Dx(),Fs(s),null;case 19:if(Tn(Ln),S=s.memoizedState,S===null)return Fs(s),null;if(m=(s.flags&128)!==0,C=S.rendering,C===null)if(m)Bg(S,!1);else{if(cs!==0||r!==null&&r.flags&128)for(r=s.child;r!==null;){if(C=$x(r),C!==null){for(s.flags|=128,Bg(S,!1),m=C.updateQueue,m!==null&&(s.updateQueue=m,s.flags|=4),s.subtreeFlags=0,m=c,c=s.child;c!==null;)S=c,r=m,S.flags&=14680066,C=S.alternate,C===null?(S.childLanes=0,S.lanes=r,S.child=null,S.subtreeFlags=0,S.memoizedProps=null,S.memoizedState=null,S.updateQueue=null,S.dependencies=null,S.stateNode=null):(S.childLanes=C.childLanes,S.lanes=C.lanes,S.child=C.child,S.subtreeFlags=0,S.deletions=null,S.memoizedProps=C.memoizedProps,S.memoizedState=C.memoizedState,S.updateQueue=C.updateQueue,S.type=C.type,r=C.dependencies,S.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),c=c.sibling;return xn(Ln,Ln.current&1|2),s.child}r=r.sibling}S.tail!==null&&Wn()>Cp&&(s.flags|=128,m=!0,Bg(S,!1),s.lanes=4194304)}else{if(!m)if(r=$x(C),r!==null){if(s.flags|=128,m=!0,c=r.updateQueue,c!==null&&(s.updateQueue=c,s.flags|=4),Bg(S,!0),S.tail===null&&S.tailMode==="hidden"&&!C.alternate&&!Mn)return Fs(s),null}else 2*Wn()-S.renderingStartTime>Cp&&c!==1073741824&&(s.flags|=128,m=!0,Bg(S,!1),s.lanes=4194304);S.isBackwards?(C.sibling=s.child,s.child=C):(c=S.last,c!==null?c.sibling=C:s.child=C,S.last=C)}return S.tail!==null?(s=S.tail,S.rendering=s,S.tail=s.sibling,S.renderingStartTime=Wn(),s.sibling=null,c=Ln.current,xn(Ln,m?c&1|2:c&1),s):(Fs(s),null);case 22:case 23:return PS(),m=s.memoizedState!==null,r!==null&&r.memoizedState!==null!==m&&(s.flags|=8192),m&&s.mode&1?$o&1073741824&&(Fs(s),s.subtreeFlags&6&&(s.flags|=8192)):Fs(s),null;case 24:return null;case 25:return null}throw Error(Zt(156,s.tag))}function wz(r,s){switch(cS(s),s.tag){case 1:return Eo(s.type)&&Dx(),r=s.flags,r&65536?(s.flags=r&-65537|128,s):null;case 3:return Ep(),Tn(To),Tn(Vs),yS(),r=s.flags,r&65536&&!(r&128)?(s.flags=r&-65537|128,s):null;case 5:return _S(s),null;case 13:if(Tn(Ln),r=s.memoizedState,r!==null&&r.dehydrated!==null){if(s.alternate===null)throw Error(Zt(340));Sp()}return r=s.flags,r&65536?(s.flags=r&-65537|128,s):null;case 19:return Tn(Ln),null;case 4:return Ep(),null;case 10:return fS(s.type._context),null;case 22:case 23:return PS(),null;case 24:return null;default:return null}}var tx=!1,Bs=!1,Sz=typeof WeakSet=="function"?WeakSet:Set,kr=null;function up(r,s){var c=r.ref;if(c!==null)if(typeof c=="function")try{c(null)}catch(m){Bn(r,s,m)}else c.current=null}function u2(r,s,c){try{c()}catch(m){Bn(r,s,m)}}var WA=!1;function Tz(r,s){if(W1=Nx,r=sM(),aS(r)){if("selectionStart"in r)var c={start:r.selectionStart,end:r.selectionEnd};else e:{c=(c=r.ownerDocument)&&c.defaultView||window;var m=c.getSelection&&c.getSelection();if(m&&m.rangeCount!==0){c=m.anchorNode;var v=m.anchorOffset,S=m.focusNode;m=m.focusOffset;try{c.nodeType,S.nodeType}catch{c=null;break e}var C=0,o=-1,L=-1,F=0,Z=0,$=r,W=null;t:for(;;){for(var ee;$!==c||v!==0&&$.nodeType!==3||(o=C+v),$!==S||m!==0&&$.nodeType!==3||(L=C+m),$.nodeType===3&&(C+=$.nodeValue.length),(ee=$.firstChild)!==null;)W=$,$=ee;for(;;){if($===r)break t;if(W===c&&++F===v&&(o=C),W===S&&++Z===m&&(L=C),(ee=$.nextSibling)!==null)break;$=W,W=$.parentNode}$=ee}c=o===-1||L===-1?null:{start:o,end:L}}else c=null}c=c||{start:0,end:0}}else c=null;for(Z1={focusedElem:r,selectionRange:c},Nx=!1,kr=s;kr!==null;)if(s=kr,r=s.child,(s.subtreeFlags&1028)!==0&&r!==null)r.return=s,kr=r;else for(;kr!==null;){s=kr;try{var ie=s.alternate;if(s.flags&1024)switch(s.tag){case 0:case 11:case 15:break;case 1:if(ie!==null){var ae=ie.memoizedProps,ke=ie.memoizedState,le=s.stateNode,se=le.getSnapshotBeforeUpdate(s.elementType===s.type?ae:ja(s.type,ae),ke);le.__reactInternalSnapshotBeforeUpdate=se}break;case 3:var J=s.stateNode.containerInfo;J.nodeType===1?J.textContent="":J.nodeType===9&&J.documentElement&&J.removeChild(J.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(Zt(163))}}catch(Ee){Bn(s,s.return,Ee)}if(r=s.sibling,r!==null){r.return=s.return,kr=r;break}kr=s.return}return ie=WA,WA=!1,ie}function t_(r,s,c){var m=s.updateQueue;if(m=m!==null?m.lastEffect:null,m!==null){var v=m=m.next;do{if((v.tag&r)===r){var S=v.destroy;v.destroy=void 0,S!==void 0&&u2(s,c,S)}v=v.next}while(v!==m)}}function yv(r,s){if(s=s.updateQueue,s=s!==null?s.lastEffect:null,s!==null){var c=s=s.next;do{if((c.tag&r)===r){var m=c.create;c.destroy=m()}c=c.next}while(c!==s)}}function d2(r){var s=r.ref;if(s!==null){var c=r.stateNode;switch(r.tag){case 5:r=c;break;default:r=c}typeof s=="function"?s(r):s.current=r}}function tN(r){var s=r.alternate;s!==null&&(r.alternate=null,tN(s)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(s=r.stateNode,s!==null&&(delete s[El],delete s[__],delete s[K1],delete s[oz],delete s[az])),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}function rN(r){return r.tag===5||r.tag===3||r.tag===4}function ZA(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||rN(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}function h2(r,s,c){var m=r.tag;if(m===5||m===6)r=r.stateNode,s?c.nodeType===8?c.parentNode.insertBefore(r,s):c.insertBefore(r,s):(c.nodeType===8?(s=c.parentNode,s.insertBefore(r,c)):(s=c,s.appendChild(r)),c=c._reactRootContainer,c!=null||s.onclick!==null||(s.onclick=Ox));else if(m!==4&&(r=r.child,r!==null))for(h2(r,s,c),r=r.sibling;r!==null;)h2(r,s,c),r=r.sibling}function f2(r,s,c){var m=r.tag;if(m===5||m===6)r=r.stateNode,s?c.insertBefore(r,s):c.appendChild(r);else if(m!==4&&(r=r.child,r!==null))for(f2(r,s,c),r=r.sibling;r!==null;)f2(r,s,c),r=r.sibling}var Ps=null,za=!1;function mu(r,s,c){for(c=c.child;c!==null;)iN(r,s,c),c=c.sibling}function iN(r,s,c){if(Al&&typeof Al.onCommitFiberUnmount=="function")try{Al.onCommitFiberUnmount(uv,c)}catch{}switch(c.tag){case 5:Bs||up(c,s);case 6:var m=Ps,v=za;Ps=null,mu(r,s,c),Ps=m,za=v,Ps!==null&&(za?(r=Ps,c=c.stateNode,r.nodeType===8?r.parentNode.removeChild(c):r.removeChild(c)):Ps.removeChild(c.stateNode));break;case 18:Ps!==null&&(za?(r=Ps,c=c.stateNode,r.nodeType===8?i1(r.parentNode,c):r.nodeType===1&&i1(r,c),h_(r)):i1(Ps,c.stateNode));break;case 4:m=Ps,v=za,Ps=c.stateNode.containerInfo,za=!0,mu(r,s,c),Ps=m,za=v;break;case 0:case 11:case 14:case 15:if(!Bs&&(m=c.updateQueue,m!==null&&(m=m.lastEffect,m!==null))){v=m=m.next;do{var S=v,C=S.destroy;S=S.tag,C!==void 0&&(S&2||S&4)&&u2(c,s,C),v=v.next}while(v!==m)}mu(r,s,c);break;case 1:if(!Bs&&(up(c,s),m=c.stateNode,typeof m.componentWillUnmount=="function"))try{m.props=c.memoizedProps,m.state=c.memoizedState,m.componentWillUnmount()}catch(o){Bn(c,s,o)}mu(r,s,c);break;case 21:mu(r,s,c);break;case 22:c.mode&1?(Bs=(m=Bs)||c.memoizedState!==null,mu(r,s,c),Bs=m):mu(r,s,c);break;default:mu(r,s,c)}}function XA(r){var s=r.updateQueue;if(s!==null){r.updateQueue=null;var c=r.stateNode;c===null&&(c=r.stateNode=new Sz),s.forEach(function(m){var v=Rz.bind(null,r,m);c.has(m)||(c.add(m),m.then(v,v))})}}function Oa(r,s){var c=s.deletions;if(c!==null)for(var m=0;m<c.length;m++){var v=c[m];try{var S=r,C=s,o=C;e:for(;o!==null;){switch(o.tag){case 5:Ps=o.stateNode,za=!1;break e;case 3:Ps=o.stateNode.containerInfo,za=!0;break e;case 4:Ps=o.stateNode.containerInfo,za=!0;break e}o=o.return}if(Ps===null)throw Error(Zt(160));iN(S,C,v),Ps=null,za=!1;var L=v.alternate;L!==null&&(L.return=null),v.return=null}catch(F){Bn(v,s,F)}}if(s.subtreeFlags&12854)for(s=s.child;s!==null;)nN(s,r),s=s.sibling}function nN(r,s){var c=r.alternate,m=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:if(Oa(s,r),wl(r),m&4){try{t_(3,r,r.return),yv(3,r)}catch(ae){Bn(r,r.return,ae)}try{t_(5,r,r.return)}catch(ae){Bn(r,r.return,ae)}}break;case 1:Oa(s,r),wl(r),m&512&&c!==null&&up(c,c.return);break;case 5:if(Oa(s,r),wl(r),m&512&&c!==null&&up(c,c.return),r.flags&32){var v=r.stateNode;try{l_(v,"")}catch(ae){Bn(r,r.return,ae)}}if(m&4&&(v=r.stateNode,v!=null)){var S=r.memoizedProps,C=c!==null?c.memoizedProps:S,o=r.type,L=r.updateQueue;if(r.updateQueue=null,L!==null)try{o==="input"&&S.type==="radio"&&S.name!=null&&Ik(v,S),j1(o,C);var F=j1(o,S);for(C=0;C<L.length;C+=2){var Z=L[C],$=L[C+1];Z==="style"?Mk(v,$):Z==="dangerouslySetInnerHTML"?Pk(v,$):Z==="children"?l_(v,$):Z2(v,Z,$,F)}switch(o){case"input":N1(v,S);break;case"textarea":Ck(v,S);break;case"select":var W=v._wrapperState.wasMultiple;v._wrapperState.wasMultiple=!!S.multiple;var ee=S.value;ee!=null?hp(v,!!S.multiple,ee,!1):W!==!!S.multiple&&(S.defaultValue!=null?hp(v,!!S.multiple,S.defaultValue,!0):hp(v,!!S.multiple,S.multiple?[]:"",!1))}v[__]=S}catch(ae){Bn(r,r.return,ae)}}break;case 6:if(Oa(s,r),wl(r),m&4){if(r.stateNode===null)throw Error(Zt(162));v=r.stateNode,S=r.memoizedProps;try{v.nodeValue=S}catch(ae){Bn(r,r.return,ae)}}break;case 3:if(Oa(s,r),wl(r),m&4&&c!==null&&c.memoizedState.isDehydrated)try{h_(s.containerInfo)}catch(ae){Bn(r,r.return,ae)}break;case 4:Oa(s,r),wl(r);break;case 13:Oa(s,r),wl(r),v=r.child,v.flags&8192&&(S=v.memoizedState!==null,v.stateNode.isHidden=S,!S||v.alternate!==null&&v.alternate.memoizedState!==null||(CS=Wn())),m&4&&XA(r);break;case 22:if(Z=c!==null&&c.memoizedState!==null,r.mode&1?(Bs=(F=Bs)||Z,Oa(s,r),Bs=F):Oa(s,r),wl(r),m&8192){if(F=r.memoizedState!==null,(r.stateNode.isHidden=F)&&!Z&&r.mode&1)for(kr=r,Z=r.child;Z!==null;){for($=kr=Z;kr!==null;){switch(W=kr,ee=W.child,W.tag){case 0:case 11:case 14:case 15:t_(4,W,W.return);break;case 1:up(W,W.return);var ie=W.stateNode;if(typeof ie.componentWillUnmount=="function"){m=W,c=W.return;try{s=m,ie.props=s.memoizedProps,ie.state=s.memoizedState,ie.componentWillUnmount()}catch(ae){Bn(m,c,ae)}}break;case 5:up(W,W.return);break;case 22:if(W.memoizedState!==null){KA($);continue}}ee!==null?(ee.return=W,kr=ee):KA($)}Z=Z.sibling}e:for(Z=null,$=r;;){if($.tag===5){if(Z===null){Z=$;try{v=$.stateNode,F?(S=v.style,typeof S.setProperty=="function"?S.setProperty("display","none","important"):S.display="none"):(o=$.stateNode,L=$.memoizedProps.style,C=L!=null&&L.hasOwnProperty("display")?L.display:null,o.style.display=kk("display",C))}catch(ae){Bn(r,r.return,ae)}}}else if($.tag===6){if(Z===null)try{$.stateNode.nodeValue=F?"":$.memoizedProps}catch(ae){Bn(r,r.return,ae)}}else if(($.tag!==22&&$.tag!==23||$.memoizedState===null||$===r)&&$.child!==null){$.child.return=$,$=$.child;continue}if($===r)break e;for(;$.sibling===null;){if($.return===null||$.return===r)break e;Z===$&&(Z=null),$=$.return}Z===$&&(Z=null),$.sibling.return=$.return,$=$.sibling}}break;case 19:Oa(s,r),wl(r),m&4&&XA(r);break;case 21:break;default:Oa(s,r),wl(r)}}function wl(r){var s=r.flags;if(s&2){try{e:{for(var c=r.return;c!==null;){if(rN(c)){var m=c;break e}c=c.return}throw Error(Zt(160))}switch(m.tag){case 5:var v=m.stateNode;m.flags&32&&(l_(v,""),m.flags&=-33);var S=ZA(r);f2(r,S,v);break;case 3:case 4:var C=m.stateNode.containerInfo,o=ZA(r);h2(r,o,C);break;default:throw Error(Zt(161))}}catch(L){Bn(r,r.return,L)}r.flags&=-3}s&4096&&(r.flags&=-4097)}function Ez(r,s,c){kr=r,sN(r)}function sN(r,s,c){for(var m=(r.mode&1)!==0;kr!==null;){var v=kr,S=v.child;if(v.tag===22&&m){var C=v.memoizedState!==null||tx;if(!C){var o=v.alternate,L=o!==null&&o.memoizedState!==null||Bs;o=tx;var F=Bs;if(tx=C,(Bs=L)&&!F)for(kr=v;kr!==null;)C=kr,L=C.child,C.tag===22&&C.memoizedState!==null?JA(v):L!==null?(L.return=C,kr=L):JA(v);for(;S!==null;)kr=S,sN(S),S=S.sibling;kr=v,tx=o,Bs=F}YA(r)}else v.subtreeFlags&8772&&S!==null?(S.return=v,kr=S):YA(r)}}function YA(r){for(;kr!==null;){var s=kr;if(s.flags&8772){var c=s.alternate;try{if(s.flags&8772)switch(s.tag){case 0:case 11:case 15:Bs||yv(5,s);break;case 1:var m=s.stateNode;if(s.flags&4&&!Bs)if(c===null)m.componentDidMount();else{var v=s.elementType===s.type?c.memoizedProps:ja(s.type,c.memoizedProps);m.componentDidUpdate(v,c.memoizedState,m.__reactInternalSnapshotBeforeUpdate)}var S=s.updateQueue;S!==null&&LA(s,S,m);break;case 3:var C=s.updateQueue;if(C!==null){if(c=null,s.child!==null)switch(s.child.tag){case 5:c=s.child.stateNode;break;case 1:c=s.child.stateNode}LA(s,C,c)}break;case 5:var o=s.stateNode;if(c===null&&s.flags&4){c=o;var L=s.memoizedProps;switch(s.type){case"button":case"input":case"select":case"textarea":L.autoFocus&&c.focus();break;case"img":L.src&&(c.src=L.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(s.memoizedState===null){var F=s.alternate;if(F!==null){var Z=F.memoizedState;if(Z!==null){var $=Z.dehydrated;$!==null&&h_($)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(Zt(163))}Bs||s.flags&512&&d2(s)}catch(W){Bn(s,s.return,W)}}if(s===r){kr=null;break}if(c=s.sibling,c!==null){c.return=s.return,kr=c;break}kr=s.return}}function KA(r){for(;kr!==null;){var s=kr;if(s===r){kr=null;break}var c=s.sibling;if(c!==null){c.return=s.return,kr=c;break}kr=s.return}}function JA(r){for(;kr!==null;){var s=kr;try{switch(s.tag){case 0:case 11:case 15:var c=s.return;try{yv(4,s)}catch(L){Bn(s,c,L)}break;case 1:var m=s.stateNode;if(typeof m.componentDidMount=="function"){var v=s.return;try{m.componentDidMount()}catch(L){Bn(s,v,L)}}var S=s.return;try{d2(s)}catch(L){Bn(s,S,L)}break;case 5:var C=s.return;try{d2(s)}catch(L){Bn(s,C,L)}}}catch(L){Bn(s,s.return,L)}if(s===r){kr=null;break}var o=s.sibling;if(o!==null){o.return=s.return,kr=o;break}kr=s.return}}var Iz=Math.ceil,Hx=wc.ReactCurrentDispatcher,ES=wc.ReactCurrentOwner,pa=wc.ReactCurrentBatchConfig,Hi=0,bs=null,ts=null,ks=0,$o=0,dp=Fu(0),cs=0,S_=null,oh=0,xv=0,IS=0,r_=null,bo=null,CS=0,Cp=1/0,dc=null,Wx=!1,p2=null,Nu=null,rx=!1,Eu=null,Zx=0,i_=0,m2=null,bx=-1,wx=0;function ao(){return Hi&6?Wn():bx!==-1?bx:bx=Wn()}function Ru(r){return r.mode&1?Hi&2&&ks!==0?ks&-ks:cz.transition!==null?(wx===0&&(wx=$k()),wx):(r=rn,r!==0||(r=window.event,r=r===void 0?16:Yk(r.type)),r):1}function Va(r,s,c,m){if(50<i_)throw i_=0,m2=null,Error(Zt(185));R_(r,c,m),(!(Hi&2)||r!==bs)&&(r===bs&&(!(Hi&2)&&(xv|=c),cs===4&&wu(r,ks)),Io(r,m),c===1&&Hi===0&&!(s.mode&1)&&(Cp=Wn()+500,mv&&Bu()))}function Io(r,s){var c=r.callbackNode;cj(r,s);var m=Mx(r,r===bs?ks:0);if(m===0)c!==null&&aA(c),r.callbackNode=null,r.callbackPriority=0;else if(s=m&-m,r.callbackPriority!==s){if(c!=null&&aA(c),s===1)r.tag===0?lz(QA.bind(null,r)):mM(QA.bind(null,r)),nz(function(){!(Hi&6)&&Bu()}),c=null;else{switch(Gk(m)){case 1:c=Q2;break;case 4:c=Uk;break;case 16:c=kx;break;case 536870912:c=Vk;break;default:c=kx}c=fN(c,oN.bind(null,r))}r.callbackPriority=s,r.callbackNode=c}}function oN(r,s){if(bx=-1,wx=0,Hi&6)throw Error(Zt(327));var c=r.callbackNode;if(_p()&&r.callbackNode!==c)return null;var m=Mx(r,r===bs?ks:0);if(m===0)return null;if(m&30||m&r.expiredLanes||s)s=Xx(r,m);else{s=m;var v=Hi;Hi|=2;var S=lN();(bs!==r||ks!==s)&&(dc=null,Cp=Wn()+500,th(r,s));do try{Pz();break}catch(o){aN(r,o)}while(!0);hS(),Hx.current=S,Hi=v,ts!==null?s=0:(bs=null,ks=0,s=cs)}if(s!==0){if(s===2&&(v=V1(r),v!==0&&(m=v,s=g2(r,v))),s===1)throw c=S_,th(r,0),wu(r,m),Io(r,Wn()),c;if(s===6)wu(r,m);else{if(v=r.current.alternate,!(m&30)&&!Cz(v)&&(s=Xx(r,m),s===2&&(S=V1(r),S!==0&&(m=S,s=g2(r,S))),s===1))throw c=S_,th(r,0),wu(r,m),Io(r,Wn()),c;switch(r.finishedWork=v,r.finishedLanes=m,s){case 0:case 1:throw Error(Zt(345));case 2:Gd(r,bo,dc);break;case 3:if(wu(r,m),(m&130023424)===m&&(s=CS+500-Wn(),10<s)){if(Mx(r,0)!==0)break;if(v=r.suspendedLanes,(v&m)!==m){ao(),r.pingedLanes|=r.suspendedLanes&v;break}r.timeoutHandle=Y1(Gd.bind(null,r,bo,dc),s);break}Gd(r,bo,dc);break;case 4:if(wu(r,m),(m&4194240)===m)break;for(s=r.eventTimes,v=-1;0<m;){var C=31-Ua(m);S=1<<C,C=s[C],C>v&&(v=C),m&=~S}if(m=v,m=Wn()-m,m=(120>m?120:480>m?480:1080>m?1080:1920>m?1920:3e3>m?3e3:4320>m?4320:1960*Iz(m/1960))-m,10<m){r.timeoutHandle=Y1(Gd.bind(null,r,bo,dc),m);break}Gd(r,bo,dc);break;case 5:Gd(r,bo,dc);break;default:throw Error(Zt(329))}}}return Io(r,Wn()),r.callbackNode===c?oN.bind(null,r):null}function g2(r,s){var c=r_;return r.current.memoizedState.isDehydrated&&(th(r,s).flags|=256),r=Xx(r,s),r!==2&&(s=bo,bo=c,s!==null&&_2(s)),r}function _2(r){bo===null?bo=r:bo.push.apply(bo,r)}function Cz(r){for(var s=r;;){if(s.flags&16384){var c=s.updateQueue;if(c!==null&&(c=c.stores,c!==null))for(var m=0;m<c.length;m++){var v=c[m],S=v.getSnapshot;v=v.value;try{if(!$a(S(),v))return!1}catch{return!1}}}if(c=s.child,s.subtreeFlags&16384&&c!==null)c.return=s,s=c;else{if(s===r)break;for(;s.sibling===null;){if(s.return===null||s.return===r)return!0;s=s.return}s.sibling.return=s.return,s=s.sibling}}return!0}function wu(r,s){for(s&=~IS,s&=~xv,r.suspendedLanes|=s,r.pingedLanes&=~s,r=r.expirationTimes;0<s;){var c=31-Ua(s),m=1<<c;r[c]=-1,s&=~m}}function QA(r){if(Hi&6)throw Error(Zt(327));_p();var s=Mx(r,0);if(!(s&1))return Io(r,Wn()),null;var c=Xx(r,s);if(r.tag!==0&&c===2){var m=V1(r);m!==0&&(s=m,c=g2(r,m))}if(c===1)throw c=S_,th(r,0),wu(r,s),Io(r,Wn()),c;if(c===6)throw Error(Zt(345));return r.finishedWork=r.current.alternate,r.finishedLanes=s,Gd(r,bo,dc),Io(r,Wn()),null}function AS(r,s){var c=Hi;Hi|=1;try{return r(s)}finally{Hi=c,Hi===0&&(Cp=Wn()+500,mv&&Bu())}}function ah(r){Eu!==null&&Eu.tag===0&&!(Hi&6)&&_p();var s=Hi;Hi|=1;var c=pa.transition,m=rn;try{if(pa.transition=null,rn=1,r)return r()}finally{rn=m,pa.transition=c,Hi=s,!(Hi&6)&&Bu()}}function PS(){$o=dp.current,Tn(dp)}function th(r,s){r.finishedWork=null,r.finishedLanes=0;var c=r.timeoutHandle;if(c!==-1&&(r.timeoutHandle=-1,iz(c)),ts!==null)for(c=ts.return;c!==null;){var m=c;switch(cS(m),m.tag){case 1:m=m.type.childContextTypes,m!=null&&Dx();break;case 3:Ep(),Tn(To),Tn(Vs),yS();break;case 5:_S(m);break;case 4:Ep();break;case 13:Tn(Ln);break;case 19:Tn(Ln);break;case 10:fS(m.type._context);break;case 22:case 23:PS()}c=c.return}if(bs=r,ts=r=Lu(r.current,null),ks=$o=s,cs=0,S_=null,IS=xv=oh=0,bo=r_=null,Kd!==null){for(s=0;s<Kd.length;s++)if(c=Kd[s],m=c.interleaved,m!==null){c.interleaved=null;var v=m.next,S=c.pending;if(S!==null){var C=S.next;S.next=v,m.next=C}c.pending=m}Kd=null}return r}function aN(r,s){do{var c=ts;try{if(hS(),yx.current=qx,Gx){for(var m=On.memoizedState;m!==null;){var v=m.queue;v!==null&&(v.pending=null),m=m.next}Gx=!1}if(sh=0,xs=ls=On=null,e_=!1,v_=0,ES.current=null,c===null||c.return===null){cs=1,S_=s,ts=null;break}e:{var S=r,C=c.return,o=c,L=s;if(s=ks,o.flags|=32768,L!==null&&typeof L=="object"&&typeof L.then=="function"){var F=L,Z=o,$=Z.tag;if(!(Z.mode&1)&&($===0||$===11||$===15)){var W=Z.alternate;W?(Z.updateQueue=W.updateQueue,Z.memoizedState=W.memoizedState,Z.lanes=W.lanes):(Z.updateQueue=null,Z.memoizedState=null)}var ee=BA(C);if(ee!==null){ee.flags&=-257,UA(ee,C,o,S,s),ee.mode&1&&FA(S,F,s),s=ee,L=F;var ie=s.updateQueue;if(ie===null){var ae=new Set;ae.add(L),s.updateQueue=ae}else ie.add(L);break e}else{if(!(s&1)){FA(S,F,s),kS();break e}L=Error(Zt(426))}}else if(Mn&&o.mode&1){var ke=BA(C);if(ke!==null){!(ke.flags&65536)&&(ke.flags|=256),UA(ke,C,o,S,s),uS(Ip(L,o));break e}}S=L=Ip(L,o),cs!==4&&(cs=2),r_===null?r_=[S]:r_.push(S),S=C;do{switch(S.tag){case 3:S.flags|=65536,s&=-s,S.lanes|=s;var le=GM(S,L,s);RA(S,le);break e;case 1:o=L;var se=S.type,J=S.stateNode;if(!(S.flags&128)&&(typeof se.getDerivedStateFromError=="function"||J!==null&&typeof J.componentDidCatch=="function"&&(Nu===null||!Nu.has(J)))){S.flags|=65536,s&=-s,S.lanes|=s;var Ee=qM(S,o,s);RA(S,Ee);break e}}S=S.return}while(S!==null)}uN(c)}catch(je){s=je,ts===c&&c!==null&&(ts=c=c.return);continue}break}while(!0)}function lN(){var r=Hx.current;return Hx.current=qx,r===null?qx:r}function kS(){(cs===0||cs===3||cs===2)&&(cs=4),bs===null||!(oh&268435455)&&!(xv&268435455)||wu(bs,ks)}function Xx(r,s){var c=Hi;Hi|=2;var m=lN();(bs!==r||ks!==s)&&(dc=null,th(r,s));do try{Az();break}catch(v){aN(r,v)}while(!0);if(hS(),Hi=c,Hx.current=m,ts!==null)throw Error(Zt(261));return bs=null,ks=0,cs}function Az(){for(;ts!==null;)cN(ts)}function Pz(){for(;ts!==null&&!ej();)cN(ts)}function cN(r){var s=hN(r.alternate,r,$o);r.memoizedProps=r.pendingProps,s===null?uN(r):ts=s,ES.current=null}function uN(r){var s=r;do{var c=s.alternate;if(r=s.return,s.flags&32768){if(c=wz(c,s),c!==null){c.flags&=32767,ts=c;return}if(r!==null)r.flags|=32768,r.subtreeFlags=0,r.deletions=null;else{cs=6,ts=null;return}}else if(c=bz(c,s,$o),c!==null){ts=c;return}if(s=s.sibling,s!==null){ts=s;return}ts=s=r}while(s!==null);cs===0&&(cs=5)}function Gd(r,s,c){var m=rn,v=pa.transition;try{pa.transition=null,rn=1,kz(r,s,c,m)}finally{pa.transition=v,rn=m}return null}function kz(r,s,c,m){do _p();while(Eu!==null);if(Hi&6)throw Error(Zt(327));c=r.finishedWork;var v=r.finishedLanes;if(c===null)return null;if(r.finishedWork=null,r.finishedLanes=0,c===r.current)throw Error(Zt(177));r.callbackNode=null,r.callbackPriority=0;var S=c.lanes|c.childLanes;if(uj(r,S),r===bs&&(ts=bs=null,ks=0),!(c.subtreeFlags&2064)&&!(c.flags&2064)||rx||(rx=!0,fN(kx,function(){return _p(),null})),S=(c.flags&15990)!==0,c.subtreeFlags&15990||S){S=pa.transition,pa.transition=null;var C=rn;rn=1;var o=Hi;Hi|=4,ES.current=null,Tz(r,c),nN(c,r),Yj(Z1),Nx=!!W1,Z1=W1=null,r.current=c,Ez(c),tj(),Hi=o,rn=C,pa.transition=S}else r.current=c;if(rx&&(rx=!1,Eu=r,Zx=v),S=r.pendingLanes,S===0&&(Nu=null),nj(c.stateNode),Io(r,Wn()),s!==null)for(m=r.onRecoverableError,c=0;c<s.length;c++)v=s[c],m(v.value,{componentStack:v.stack,digest:v.digest});if(Wx)throw Wx=!1,r=p2,p2=null,r;return Zx&1&&r.tag!==0&&_p(),S=r.pendingLanes,S&1?r===m2?i_++:(i_=0,m2=r):i_=0,Bu(),null}function _p(){if(Eu!==null){var r=Gk(Zx),s=pa.transition,c=rn;try{if(pa.transition=null,rn=16>r?16:r,Eu===null)var m=!1;else{if(r=Eu,Eu=null,Zx=0,Hi&6)throw Error(Zt(331));var v=Hi;for(Hi|=4,kr=r.current;kr!==null;){var S=kr,C=S.child;if(kr.flags&16){var o=S.deletions;if(o!==null){for(var L=0;L<o.length;L++){var F=o[L];for(kr=F;kr!==null;){var Z=kr;switch(Z.tag){case 0:case 11:case 15:t_(8,Z,S)}var $=Z.child;if($!==null)$.return=Z,kr=$;else for(;kr!==null;){Z=kr;var W=Z.sibling,ee=Z.return;if(tN(Z),Z===F){kr=null;break}if(W!==null){W.return=ee,kr=W;break}kr=ee}}}var ie=S.alternate;if(ie!==null){var ae=ie.child;if(ae!==null){ie.child=null;do{var ke=ae.sibling;ae.sibling=null,ae=ke}while(ae!==null)}}kr=S}}if(S.subtreeFlags&2064&&C!==null)C.return=S,kr=C;else e:for(;kr!==null;){if(S=kr,S.flags&2048)switch(S.tag){case 0:case 11:case 15:t_(9,S,S.return)}var le=S.sibling;if(le!==null){le.return=S.return,kr=le;break e}kr=S.return}}var se=r.current;for(kr=se;kr!==null;){C=kr;var J=C.child;if(C.subtreeFlags&2064&&J!==null)J.return=C,kr=J;else e:for(C=se;kr!==null;){if(o=kr,o.flags&2048)try{switch(o.tag){case 0:case 11:case 15:yv(9,o)}}catch(je){Bn(o,o.return,je)}if(o===C){kr=null;break e}var Ee=o.sibling;if(Ee!==null){Ee.return=o.return,kr=Ee;break e}kr=o.return}}if(Hi=v,Bu(),Al&&typeof Al.onPostCommitFiberRoot=="function")try{Al.onPostCommitFiberRoot(uv,r)}catch{}m=!0}return m}finally{rn=c,pa.transition=s}}return!1}function eP(r,s,c){s=Ip(c,s),s=GM(r,s,1),r=Mu(r,s,1),s=ao(),r!==null&&(R_(r,1,s),Io(r,s))}function Bn(r,s,c){if(r.tag===3)eP(r,r,c);else for(;s!==null;){if(s.tag===3){eP(s,r,c);break}else if(s.tag===1){var m=s.stateNode;if(typeof s.type.getDerivedStateFromError=="function"||typeof m.componentDidCatch=="function"&&(Nu===null||!Nu.has(m))){r=Ip(c,r),r=qM(s,r,1),s=Mu(s,r,1),r=ao(),s!==null&&(R_(s,1,r),Io(s,r));break}}s=s.return}}function Mz(r,s,c){var m=r.pingCache;m!==null&&m.delete(s),s=ao(),r.pingedLanes|=r.suspendedLanes&c,bs===r&&(ks&c)===c&&(cs===4||cs===3&&(ks&130023424)===ks&&500>Wn()-CS?th(r,0):IS|=c),Io(r,s)}function dN(r,s){s===0&&(r.mode&1?(s=Hy,Hy<<=1,!(Hy&130023424)&&(Hy=4194304)):s=1);var c=ao();r=xc(r,s),r!==null&&(R_(r,s,c),Io(r,c))}function Nz(r){var s=r.memoizedState,c=0;s!==null&&(c=s.retryLane),dN(r,c)}function Rz(r,s){var c=0;switch(r.tag){case 13:var m=r.stateNode,v=r.memoizedState;v!==null&&(c=v.retryLane);break;case 19:m=r.stateNode;break;default:throw Error(Zt(314))}m!==null&&m.delete(s),dN(r,c)}var hN;hN=function(r,s,c){if(r!==null)if(r.memoizedProps!==s.pendingProps||To.current)So=!0;else{if(!(r.lanes&c)&&!(s.flags&128))return So=!1,vz(r,s,c);So=!!(r.flags&131072)}else So=!1,Mn&&s.flags&1048576&&gM(s,Fx,s.index);switch(s.lanes=0,s.tag){case 2:var m=s.type;vx(r,s),r=s.pendingProps;var v=wp(s,Vs.current);gp(s,c),v=vS(null,s,m,r,v,c);var S=bS();return s.flags|=1,typeof v=="object"&&v!==null&&typeof v.render=="function"&&v.$$typeof===void 0?(s.tag=1,s.memoizedState=null,s.updateQueue=null,Eo(m)?(S=!0,jx(s)):S=!1,s.memoizedState=v.state!==null&&v.state!==void 0?v.state:null,mS(s),v.updater=_v,s.stateNode=v,v._reactInternals=s,i2(s,m,r,c),s=o2(null,s,m,!0,S,c)):(s.tag=0,Mn&&S&&lS(s),so(null,s,v,c),s=s.child),s;case 16:m=s.elementType;e:{switch(vx(r,s),r=s.pendingProps,v=m._init,m=v(m._payload),s.type=m,v=s.tag=Oz(m),r=ja(m,r),v){case 0:s=s2(null,s,m,r,c);break e;case 1:s=GA(null,s,m,r,c);break e;case 11:s=VA(null,s,m,r,c);break e;case 14:s=$A(null,s,m,ja(m.type,r),c);break e}throw Error(Zt(306,m,""))}return s;case 0:return m=s.type,v=s.pendingProps,v=s.elementType===m?v:ja(m,v),s2(r,s,m,v,c);case 1:return m=s.type,v=s.pendingProps,v=s.elementType===m?v:ja(m,v),GA(r,s,m,v,c);case 3:e:{if(XM(s),r===null)throw Error(Zt(387));m=s.pendingProps,S=s.memoizedState,v=S.element,wM(r,s),Vx(s,m,null,c);var C=s.memoizedState;if(m=C.element,S.isDehydrated)if(S={element:m,isDehydrated:!1,cache:C.cache,pendingSuspenseBoundaries:C.pendingSuspenseBoundaries,transitions:C.transitions},s.updateQueue.baseState=S,s.memoizedState=S,s.flags&256){v=Ip(Error(Zt(423)),s),s=qA(r,s,m,c,v);break e}else if(m!==v){v=Ip(Error(Zt(424)),s),s=qA(r,s,m,c,v);break e}else for(Go=ku(s.stateNode.containerInfo.firstChild),qo=s,Mn=!0,Ba=null,c=vM(s,null,m,c),s.child=c;c;)c.flags=c.flags&-3|4096,c=c.sibling;else{if(Sp(),m===v){s=vc(r,s,c);break e}so(r,s,m,c)}s=s.child}return s;case 5:return SM(s),r===null&&e2(s),m=s.type,v=s.pendingProps,S=r!==null?r.memoizedProps:null,C=v.children,X1(m,v)?C=null:S!==null&&X1(m,S)&&(s.flags|=32),ZM(r,s),so(r,s,C,c),s.child;case 6:return r===null&&e2(s),null;case 13:return YM(r,s,c);case 4:return gS(s,s.stateNode.containerInfo),m=s.pendingProps,r===null?s.child=Tp(s,null,m,c):so(r,s,m,c),s.child;case 11:return m=s.type,v=s.pendingProps,v=s.elementType===m?v:ja(m,v),VA(r,s,m,v,c);case 7:return so(r,s,s.pendingProps,c),s.child;case 8:return so(r,s,s.pendingProps.children,c),s.child;case 12:return so(r,s,s.pendingProps.children,c),s.child;case 10:e:{if(m=s.type._context,v=s.pendingProps,S=s.memoizedProps,C=v.value,xn(Bx,m._currentValue),m._currentValue=C,S!==null)if($a(S.value,C)){if(S.children===v.children&&!To.current){s=vc(r,s,c);break e}}else for(S=s.child,S!==null&&(S.return=s);S!==null;){var o=S.dependencies;if(o!==null){C=S.child;for(var L=o.firstContext;L!==null;){if(L.context===m){if(S.tag===1){L=gc(-1,c&-c),L.tag=2;var F=S.updateQueue;if(F!==null){F=F.shared;var Z=F.pending;Z===null?L.next=L:(L.next=Z.next,Z.next=L),F.pending=L}}S.lanes|=c,L=S.alternate,L!==null&&(L.lanes|=c),t2(S.return,c,s),o.lanes|=c;break}L=L.next}}else if(S.tag===10)C=S.type===s.type?null:S.child;else if(S.tag===18){if(C=S.return,C===null)throw Error(Zt(341));C.lanes|=c,o=C.alternate,o!==null&&(o.lanes|=c),t2(C,c,s),C=S.sibling}else C=S.child;if(C!==null)C.return=S;else for(C=S;C!==null;){if(C===s){C=null;break}if(S=C.sibling,S!==null){S.return=C.return,C=S;break}C=C.return}S=C}so(r,s,v.children,c),s=s.child}return s;case 9:return v=s.type,m=s.pendingProps.children,gp(s,c),v=ga(v),m=m(v),s.flags|=1,so(r,s,m,c),s.child;case 14:return m=s.type,v=ja(m,s.pendingProps),v=ja(m.type,v),$A(r,s,m,v,c);case 15:return HM(r,s,s.type,s.pendingProps,c);case 17:return m=s.type,v=s.pendingProps,v=s.elementType===m?v:ja(m,v),vx(r,s),s.tag=1,Eo(m)?(r=!0,jx(s)):r=!1,gp(s,c),$M(s,m,v),i2(s,m,v,c),o2(null,s,m,!0,r,c);case 19:return KM(r,s,c);case 22:return WM(r,s,c)}throw Error(Zt(156,s.tag))};function fN(r,s){return Bk(r,s)}function Lz(r,s,c,m){this.tag=r,this.key=c,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=s,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=m,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function fa(r,s,c,m){return new Lz(r,s,c,m)}function MS(r){return r=r.prototype,!(!r||!r.isReactComponent)}function Oz(r){if(typeof r=="function")return MS(r)?1:0;if(r!=null){if(r=r.$$typeof,r===Y2)return 11;if(r===K2)return 14}return 2}function Lu(r,s){var c=r.alternate;return c===null?(c=fa(r.tag,s,r.key,r.mode),c.elementType=r.elementType,c.type=r.type,c.stateNode=r.stateNode,c.alternate=r,r.alternate=c):(c.pendingProps=s,c.type=r.type,c.flags=0,c.subtreeFlags=0,c.deletions=null),c.flags=r.flags&14680064,c.childLanes=r.childLanes,c.lanes=r.lanes,c.child=r.child,c.memoizedProps=r.memoizedProps,c.memoizedState=r.memoizedState,c.updateQueue=r.updateQueue,s=r.dependencies,c.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext},c.sibling=r.sibling,c.index=r.index,c.ref=r.ref,c}function Sx(r,s,c,m,v,S){var C=2;if(m=r,typeof r=="function")MS(r)&&(C=1);else if(typeof r=="string")C=5;else e:switch(r){case tp:return rh(c.children,v,S,s);case X2:C=8,v|=8;break;case C1:return r=fa(12,c,s,v|2),r.elementType=C1,r.lanes=S,r;case A1:return r=fa(13,c,s,v),r.elementType=A1,r.lanes=S,r;case P1:return r=fa(19,c,s,v),r.elementType=P1,r.lanes=S,r;case Sk:return vv(c,v,S,s);default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case bk:C=10;break e;case wk:C=9;break e;case Y2:C=11;break e;case K2:C=14;break e;case xu:C=16,m=null;break e}throw Error(Zt(130,r==null?r:typeof r,""))}return s=fa(C,c,s,v),s.elementType=r,s.type=m,s.lanes=S,s}function rh(r,s,c,m){return r=fa(7,r,m,s),r.lanes=c,r}function vv(r,s,c,m){return r=fa(22,r,m,s),r.elementType=Sk,r.lanes=c,r.stateNode={isHidden:!1},r}function d1(r,s,c){return r=fa(6,r,null,s),r.lanes=c,r}function h1(r,s,c){return s=fa(4,r.children!==null?r.children:[],r.key,s),s.lanes=c,s.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},s}function Dz(r,s,c,m,v){this.tag=s,this.containerInfo=r,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Hw(0),this.expirationTimes=Hw(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Hw(0),this.identifierPrefix=m,this.onRecoverableError=v,this.mutableSourceEagerHydrationData=null}function NS(r,s,c,m,v,S,C,o,L){return r=new Dz(r,s,c,o,L),s===1?(s=1,S===!0&&(s|=8)):s=0,S=fa(3,null,null,s),r.current=S,S.stateNode=r,S.memoizedState={element:m,isDehydrated:c,cache:null,transitions:null,pendingSuspenseBoundaries:null},mS(S),r}function jz(r,s,c){var m=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:ep,key:m==null?null:""+m,children:r,containerInfo:s,implementation:c}}function pN(r){if(!r)return Du;r=r._reactInternals;e:{if(uh(r)!==r||r.tag!==1)throw Error(Zt(170));var s=r;do{switch(s.tag){case 3:s=s.stateNode.context;break e;case 1:if(Eo(s.type)){s=s.stateNode.__reactInternalMemoizedMergedChildContext;break e}}s=s.return}while(s!==null);throw Error(Zt(171))}if(r.tag===1){var c=r.type;if(Eo(c))return pM(r,c,s)}return s}function mN(r,s,c,m,v,S,C,o,L){return r=NS(c,m,!0,r,v,S,C,o,L),r.context=pN(null),c=r.current,m=ao(),v=Ru(c),S=gc(m,v),S.callback=s??null,Mu(c,S,v),r.current.lanes=v,R_(r,v,m),Io(r,m),r}function bv(r,s,c,m){var v=s.current,S=ao(),C=Ru(v);return c=pN(c),s.context===null?s.context=c:s.pendingContext=c,s=gc(S,C),s.payload={element:r},m=m===void 0?null:m,m!==null&&(s.callback=m),r=Mu(v,s,C),r!==null&&(Va(r,v,C,S),_x(r,v,C)),C}function Yx(r){if(r=r.current,!r.child)return null;switch(r.child.tag){case 5:return r.child.stateNode;default:return r.child.stateNode}}function tP(r,s){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var c=r.retryLane;r.retryLane=c!==0&&c<s?c:s}}function RS(r,s){tP(r,s),(r=r.alternate)&&tP(r,s)}function zz(){return null}var gN=typeof reportError=="function"?reportError:function(r){console.error(r)};function LS(r){this._internalRoot=r}wv.prototype.render=LS.prototype.render=function(r){var s=this._internalRoot;if(s===null)throw Error(Zt(409));bv(r,s,null,null)};wv.prototype.unmount=LS.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var s=r.containerInfo;ah(function(){bv(null,r,null,null)}),s[yc]=null}};function wv(r){this._internalRoot=r}wv.prototype.unstable_scheduleHydration=function(r){if(r){var s=Wk();r={blockedOn:null,target:r,priority:s};for(var c=0;c<bu.length&&s!==0&&s<bu[c].priority;c++);bu.splice(c,0,r),c===0&&Xk(r)}};function OS(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}function Sv(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11&&(r.nodeType!==8||r.nodeValue!==" react-mount-point-unstable "))}function rP(){}function Fz(r,s,c,m,v){if(v){if(typeof m=="function"){var S=m;m=function(){var F=Yx(C);S.call(F)}}var C=mN(s,m,r,0,null,!1,!1,"",rP);return r._reactRootContainer=C,r[yc]=C.current,m_(r.nodeType===8?r.parentNode:r),ah(),C}for(;v=r.lastChild;)r.removeChild(v);if(typeof m=="function"){var o=m;m=function(){var F=Yx(L);o.call(F)}}var L=NS(r,0,!1,null,null,!1,!1,"",rP);return r._reactRootContainer=L,r[yc]=L.current,m_(r.nodeType===8?r.parentNode:r),ah(function(){bv(s,L,c,m)}),L}function Tv(r,s,c,m,v){var S=c._reactRootContainer;if(S){var C=S;if(typeof v=="function"){var o=v;v=function(){var L=Yx(C);o.call(L)}}bv(s,C,r,v)}else C=Fz(c,s,r,v,m);return Yx(C)}qk=function(r){switch(r.tag){case 3:var s=r.stateNode;if(s.current.memoizedState.isDehydrated){var c=Hg(s.pendingLanes);c!==0&&(eS(s,c|1),Io(s,Wn()),!(Hi&6)&&(Cp=Wn()+500,Bu()))}break;case 13:ah(function(){var m=xc(r,1);if(m!==null){var v=ao();Va(m,r,1,v)}}),RS(r,1)}};tS=function(r){if(r.tag===13){var s=xc(r,134217728);if(s!==null){var c=ao();Va(s,r,134217728,c)}RS(r,134217728)}};Hk=function(r){if(r.tag===13){var s=Ru(r),c=xc(r,s);if(c!==null){var m=ao();Va(c,r,s,m)}RS(r,s)}};Wk=function(){return rn};Zk=function(r,s){var c=rn;try{return rn=r,s()}finally{rn=c}};F1=function(r,s,c){switch(s){case"input":if(N1(r,c),s=c.name,c.type==="radio"&&s!=null){for(c=r;c.parentNode;)c=c.parentNode;for(c=c.querySelectorAll("input[name="+JSON.stringify(""+s)+'][type="radio"]'),s=0;s<c.length;s++){var m=c[s];if(m!==r&&m.form===r.form){var v=pv(m);if(!v)throw Error(Zt(90));Ek(m),N1(m,v)}}}break;case"textarea":Ck(r,c);break;case"select":s=c.value,s!=null&&hp(r,!!c.multiple,s,!1)}};Lk=AS;Ok=ah;var Bz={usingClientEntryPoint:!1,Events:[O_,sp,pv,Nk,Rk,AS]},Ug={findFiberByHostInstance:Yd,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},Uz={bundleType:Ug.bundleType,version:Ug.version,rendererPackageName:Ug.rendererPackageName,rendererConfig:Ug.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:wc.ReactCurrentDispatcher,findHostInstanceByFiber:function(r){return r=zk(r),r===null?null:r.stateNode},findFiberByHostInstance:Ug.findFiberByHostInstance||zz,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var ix=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!ix.isDisabled&&ix.supportsFiber)try{uv=ix.inject(Uz),Al=ix}catch{}}Xo.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Bz;Xo.createPortal=function(r,s){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!OS(s))throw Error(Zt(200));return jz(r,s,null,c)};Xo.createRoot=function(r,s){if(!OS(r))throw Error(Zt(299));var c=!1,m="",v=gN;return s!=null&&(s.unstable_strictMode===!0&&(c=!0),s.identifierPrefix!==void 0&&(m=s.identifierPrefix),s.onRecoverableError!==void 0&&(v=s.onRecoverableError)),s=NS(r,1,!1,null,null,c,!1,m,v),r[yc]=s.current,m_(r.nodeType===8?r.parentNode:r),new LS(s)};Xo.findDOMNode=function(r){if(r==null)return null;if(r.nodeType===1)return r;var s=r._reactInternals;if(s===void 0)throw typeof r.render=="function"?Error(Zt(188)):(r=Object.keys(r).join(","),Error(Zt(268,r)));return r=zk(s),r=r===null?null:r.stateNode,r};Xo.flushSync=function(r){return ah(r)};Xo.hydrate=function(r,s,c){if(!Sv(s))throw Error(Zt(200));return Tv(null,r,s,!0,c)};Xo.hydrateRoot=function(r,s,c){if(!OS(r))throw Error(Zt(405));var m=c!=null&&c.hydratedSources||null,v=!1,S="",C=gN;if(c!=null&&(c.unstable_strictMode===!0&&(v=!0),c.identifierPrefix!==void 0&&(S=c.identifierPrefix),c.onRecoverableError!==void 0&&(C=c.onRecoverableError)),s=mN(s,null,r,1,c??null,v,!1,S,C),r[yc]=s.current,m_(r),m)for(r=0;r<m.length;r++)c=m[r],v=c._getVersion,v=v(c._source),s.mutableSourceEagerHydrationData==null?s.mutableSourceEagerHydrationData=[c,v]:s.mutableSourceEagerHydrationData.push(c,v);return new wv(s)};Xo.render=function(r,s,c){if(!Sv(s))throw Error(Zt(200));return Tv(null,r,s,!1,c)};Xo.unmountComponentAtNode=function(r){if(!Sv(r))throw Error(Zt(40));return r._reactRootContainer?(ah(function(){Tv(null,null,r,!1,function(){r._reactRootContainer=null,r[yc]=null})}),!0):!1};Xo.unstable_batchedUpdates=AS;Xo.unstable_renderSubtreeIntoContainer=function(r,s,c,m){if(!Sv(c))throw Error(Zt(200));if(r==null||r._reactInternals===void 0)throw Error(Zt(38));return Tv(r,s,c,!1,m)};Xo.version="18.3.1-next-f1338f8080-20240426";function _N(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(_N)}catch(r){console.error(r)}}_N(),_k.exports=Xo;var Vz=_k.exports,T_,iP=Vz;T_=iP.createRoot,iP.hydrateRoot;var yN={exports:{}};(function(r,s){(function(c,m){r.exports=m()})(Ho,function(){var c,m,v;function S(o,L){if(!c)c=L;else if(!m)m=L;else{var F="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+c+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",Z={};c(Z),v=L(Z),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(v.workerUrl=window.URL.createObjectURL(new Blob([F],{type:"text/javascript"})))}}S(["exports"],function(o){var L=1e-6,F=typeof Float32Array<"u"?Float32Array:Array;function Z(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],p=i*f-u*l;return p?(n[0]=f*(p=1/p),n[1]=-l*p,n[2]=-u*p,n[3]=i*p,n):null}function $(){var n=new F(9);return F!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function W(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],p=e[4],y=e[5],w=e[6],E=e[7],A=e[8];return n[0]=p*A-y*E,n[1]=u*E-l*A,n[2]=l*y-u*p,n[3]=y*w-f*A,n[4]=i*A-u*w,n[5]=u*f-i*y,n[6]=f*E-p*w,n[7]=l*w-i*E,n[8]=i*p-l*f,n}function ee(n,e,i){var l=e[0],u=e[1],f=e[2],p=e[3],y=e[4],w=e[5],E=e[6],A=e[7],P=e[8],M=i[0],O=i[1],D=i[2],V=i[3],G=i[4],q=i[5],te=i[6],re=i[7],oe=i[8];return n[0]=M*l+O*p+D*E,n[1]=M*u+O*y+D*A,n[2]=M*f+O*w+D*P,n[3]=V*l+G*p+q*E,n[4]=V*u+G*y+q*A,n[5]=V*f+G*w+q*P,n[6]=te*l+re*p+oe*E,n[7]=te*u+re*y+oe*A,n[8]=te*f+re*w+oe*P,n}function ie(){var n=new F(16);return F!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function ae(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function ke(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],p=e[4],y=e[5],w=e[6],E=e[7],A=e[8],P=e[9],M=e[10],O=e[11],D=e[12],V=e[13],G=e[14],q=e[15],te=i*y-l*p,re=i*w-u*p,oe=i*E-f*p,xe=l*w-u*y,ve=l*E-f*y,Se=u*E-f*w,Ce=A*V-P*D,Ae=A*G-M*D,Qe=A*q-O*D,Oe=P*G-M*V,et=P*q-O*V,ct=M*q-O*G,rt=te*ct-re*et+oe*Oe+xe*Qe-ve*Ae+Se*Ce;return rt?(n[0]=(y*ct-w*et+E*Oe)*(rt=1/rt),n[1]=(u*et-l*ct-f*Oe)*rt,n[2]=(V*Se-G*ve+q*xe)*rt,n[3]=(M*ve-P*Se-O*xe)*rt,n[4]=(w*Qe-p*ct-E*Ae)*rt,n[5]=(i*ct-u*Qe+f*Ae)*rt,n[6]=(G*oe-D*Se-q*re)*rt,n[7]=(A*Se-M*oe+O*re)*rt,n[8]=(p*et-y*Qe+E*Ce)*rt,n[9]=(l*Qe-i*et-f*Ce)*rt,n[10]=(D*ve-V*oe+q*te)*rt,n[11]=(P*oe-A*ve-O*te)*rt,n[12]=(y*Ae-p*Oe-w*Ce)*rt,n[13]=(i*Oe-l*Ae+u*Ce)*rt,n[14]=(V*re-D*xe-G*te)*rt,n[15]=(A*xe-P*re+M*te)*rt,n):null}function le(n,e,i){var l=e[0],u=e[1],f=e[2],p=e[3],y=e[4],w=e[5],E=e[6],A=e[7],P=e[8],M=e[9],O=e[10],D=e[11],V=e[12],G=e[13],q=e[14],te=e[15],re=i[0],oe=i[1],xe=i[2],ve=i[3];return n[0]=re*l+oe*y+xe*P+ve*V,n[1]=re*u+oe*w+xe*M+ve*G,n[2]=re*f+oe*E+xe*O+ve*q,n[3]=re*p+oe*A+xe*D+ve*te,n[4]=(re=i[4])*l+(oe=i[5])*y+(xe=i[6])*P+(ve=i[7])*V,n[5]=re*u+oe*w+xe*M+ve*G,n[6]=re*f+oe*E+xe*O+ve*q,n[7]=re*p+oe*A+xe*D+ve*te,n[8]=(re=i[8])*l+(oe=i[9])*y+(xe=i[10])*P+(ve=i[11])*V,n[9]=re*u+oe*w+xe*M+ve*G,n[10]=re*f+oe*E+xe*O+ve*q,n[11]=re*p+oe*A+xe*D+ve*te,n[12]=(re=i[12])*l+(oe=i[13])*y+(xe=i[14])*P+(ve=i[15])*V,n[13]=re*u+oe*w+xe*M+ve*G,n[14]=re*f+oe*E+xe*O+ve*q,n[15]=re*p+oe*A+xe*D+ve*te,n}function se(n,e,i){var l,u,f,p,y,w,E,A,P,M,O,D,V=i[0],G=i[1],q=i[2];return e===n?(n[12]=e[0]*V+e[4]*G+e[8]*q+e[12],n[13]=e[1]*V+e[5]*G+e[9]*q+e[13],n[14]=e[2]*V+e[6]*G+e[10]*q+e[14],n[15]=e[3]*V+e[7]*G+e[11]*q+e[15]):(u=e[1],f=e[2],p=e[3],y=e[4],w=e[5],E=e[6],A=e[7],P=e[8],M=e[9],O=e[10],D=e[11],n[0]=l=e[0],n[1]=u,n[2]=f,n[3]=p,n[4]=y,n[5]=w,n[6]=E,n[7]=A,n[8]=P,n[9]=M,n[10]=O,n[11]=D,n[12]=l*V+y*G+P*q+e[12],n[13]=u*V+w*G+M*q+e[13],n[14]=f*V+E*G+O*q+e[14],n[15]=p*V+A*G+D*q+e[15]),n}function J(n,e,i){var l=i[0],u=i[1],f=i[2];return n[0]=e[0]*l,n[1]=e[1]*l,n[2]=e[2]*l,n[3]=e[3]*l,n[4]=e[4]*u,n[5]=e[5]*u,n[6]=e[6]*u,n[7]=e[7]*u,n[8]=e[8]*f,n[9]=e[9]*f,n[10]=e[10]*f,n[11]=e[11]*f,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function Ee(n,e,i){var l=Math.sin(i),u=Math.cos(i),f=e[4],p=e[5],y=e[6],w=e[7],E=e[8],A=e[9],P=e[10],M=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=f*u+E*l,n[5]=p*u+A*l,n[6]=y*u+P*l,n[7]=w*u+M*l,n[8]=E*u-f*l,n[9]=A*u-p*l,n[10]=P*u-y*l,n[11]=M*u-w*l,n}function je(n,e,i){var l=Math.sin(i),u=Math.cos(i),f=e[0],p=e[1],y=e[2],w=e[3],E=e[8],A=e[9],P=e[10],M=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=f*u-E*l,n[1]=p*u-A*l,n[2]=y*u-P*l,n[3]=w*u-M*l,n[8]=f*l+E*u,n[9]=p*l+A*u,n[10]=y*l+P*u,n[11]=w*l+M*u,n}function Xe(n,e,i){var l=Math.sin(i),u=Math.cos(i),f=e[0],p=e[1],y=e[2],w=e[3],E=e[4],A=e[5],P=e[6],M=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=f*u+E*l,n[1]=p*u+A*l,n[2]=y*u+P*l,n[3]=w*u+M*l,n[4]=E*u-f*l,n[5]=A*u-p*l,n[6]=P*u-y*l,n[7]=M*u-w*l,n}function tt(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function it(n,e,i){var l,u,f,p=i[0],y=i[1],w=i[2],E=Math.sqrt(p*p+y*y+w*w);return E<L?null:(p*=E=1/E,y*=E,w*=E,l=Math.sin(e),u=Math.cos(e),n[0]=p*p*(f=1-u)+u,n[1]=y*p*f+w*l,n[2]=w*p*f-y*l,n[3]=0,n[4]=p*y*f-w*l,n[5]=y*y*f+u,n[6]=w*y*f+p*l,n[7]=0,n[8]=p*w*f+y*l,n[9]=y*w*f-p*l,n[10]=w*w*f+u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function We(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],p=i+i,y=l+l,w=u+u,E=i*p,A=l*p,P=l*y,M=u*p,O=u*y,D=u*w,V=f*p,G=f*y,q=f*w;return n[0]=1-P-D,n[1]=A+q,n[2]=M-G,n[3]=0,n[4]=A-q,n[5]=1-E-D,n[6]=O+V,n[7]=0,n[8]=M+G,n[9]=O-V,n[10]=1-E-P,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}var Ct=le;function Nt(){var n=new F(3);return F!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function Wt(n){var e=new F(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function fr(n){var e=n[0],i=n[1],l=n[2];return Math.sqrt(e*e+i*i+l*l)}function dr(n,e,i){var l=new F(3);return l[0]=n,l[1]=e,l[2]=i,l}function cr(n,e,i,l){return n[0]=e,n[1]=i,n[2]=l,n}function Ut(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n[2]=e[2]+i[2],n}function jr(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n[2]=e[2]-i[2],n}function Ht(n,e,i){return n[0]=e[0]*i[0],n[1]=e[1]*i[1],n[2]=e[2]*i[2],n}function xr(n,e,i){return n[0]=Math.min(e[0],i[0]),n[1]=Math.min(e[1],i[1]),n[2]=Math.min(e[2],i[2]),n}function Rt(n,e,i){return n[0]=Math.max(e[0],i[0]),n[1]=Math.max(e[1],i[1]),n[2]=Math.max(e[2],i[2]),n}function rr(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n}function Nr(n,e,i,l){return n[0]=e[0]+i[0]*l,n[1]=e[1]+i[1]*l,n[2]=e[2]+i[2]*l,n}function Un(n,e){var i=e[0]-n[0],l=e[1]-n[1],u=e[2]-n[2];return i*i+l*l+u*u}function us(n){var e=n[0],i=n[1],l=n[2];return e*e+i*i+l*l}function rs(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function Yr(n,e){var i=e[0],l=e[1],u=e[2],f=i*i+l*l+u*u;return f>0&&(f=1/Math.sqrt(f)),n[0]=e[0]*f,n[1]=e[1]*f,n[2]=e[2]*f,n}function vi(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function Vi(n,e,i){var l=e[0],u=e[1],f=e[2],p=i[0],y=i[1],w=i[2];return n[0]=u*w-f*y,n[1]=f*p-l*w,n[2]=l*y-u*p,n}function Vn(n,e,i,l){var u=e[0],f=e[1],p=e[2];return n[0]=u+l*(i[0]-u),n[1]=f+l*(i[1]-f),n[2]=p+l*(i[2]-p),n}function or(n,e,i){var l=e[0],u=e[1],f=e[2],p=i[3]*l+i[7]*u+i[11]*f+i[15];return n[0]=(i[0]*l+i[4]*u+i[8]*f+i[12])/(p=p||1),n[1]=(i[1]*l+i[5]*u+i[9]*f+i[13])/p,n[2]=(i[2]*l+i[6]*u+i[10]*f+i[14])/p,n}function pr(n,e,i){var l=e[0],u=e[1],f=e[2];return n[0]=l*i[0]+u*i[3]+f*i[6],n[1]=l*i[1]+u*i[4]+f*i[7],n[2]=l*i[2]+u*i[5]+f*i[8],n}function $r(n,e,i){var l=i[0],u=i[1],f=i[2],p=i[3],y=e[0],w=e[1],E=e[2],A=u*E-f*w,P=f*y-l*E,M=l*w-u*y;return n[0]=y+p*(A+=A)+u*(M+=M)-f*(P+=P),n[1]=w+p*P+f*A-l*M,n[2]=E+p*M+l*P-u*A,n}function Di(n){return n[0]=0,n[1]=0,n[2]=0,n}function oi(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}var Gr=jr,un=Ht,Zn=fr;function po(){var n=new F(4);return F!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function In(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n[3]=e[3]*i,n}function ji(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],p=i*i+l*l+u*u+f*f;return p>0&&(p=1/Math.sqrt(p)),n[0]=i*p,n[1]=l*p,n[2]=u*p,n[3]=f*p,n}function on(n,e,i){var l=e[0],u=e[1],f=e[2],p=e[3];return n[0]=i[0]*l+i[4]*u+i[8]*f+i[12]*p,n[1]=i[1]*l+i[5]*u+i[9]*f+i[13]*p,n[2]=i[2]*l+i[6]*u+i[10]*f+i[14]*p,n[3]=i[3]*l+i[7]*u+i[11]*f+i[15]*p,n}function $s(){var n=new F(4);return F!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function Ts(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function Co(n,e,i){i*=.5;var l=e[0],u=e[1],f=e[2],p=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=l*w+p*y,n[1]=u*w+f*y,n[2]=f*w-u*y,n[3]=p*w-l*y,n}function Rl(n,e,i){i*=.5;var l=e[0],u=e[1],f=e[2],p=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=l*w-f*y,n[1]=u*w+p*y,n[2]=f*w+l*y,n[3]=p*w-u*y,n}Nt(),po();var Es,Gs,$u,ya=ji,Tc=(Es=Nt(),Gs=dr(1,0,0),$u=dr(0,1,0),function(n,e,i){var l=vi(e,i);return l<-.999999?(Vi(Es,Gs,e),Zn(Es)<1e-6&&Vi(Es,$u,e),Yr(Es,Es),function(u,f,p){p*=.5;var y=Math.sin(p);u[0]=y*f[0],u[1]=y*f[1],u[2]=y*f[2],u[3]=Math.cos(p)}(n,Es,Math.PI),n):l>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(Vi(Es,e,i),n[0]=Es[0],n[1]=Es[1],n[2]=Es[2],n[3]=1+l,ya(n,n))});function $n(){var n=new F(2);return F!=Float32Array&&(n[0]=0,n[1]=0),n}function Ao(n,e){var i=new F(2);return i[0]=n,i[1]=e,i}function Gu(n,e,i){return n[0]=e,n[1]=i,n}function Za(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n}function Jo(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n}function xa(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n}function Ll(n){var e=n[0],i=n[1];return Math.sqrt(e*e+i*i)}function Ui(n,e){var i=e[0],l=e[1],u=i*i+l*l;return u>0&&(u=1/Math.sqrt(u)),n[0]=e[0]*u,n[1]=e[1]*u,n}function jn(n,e){return n[0]*e[0]+n[1]*e[1]}$s(),$s(),$();var qu,Ol,Po=Jo;function Hu(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}$n();var Wu=function(){if(Ol)return qu;function n(e,i,l,u){this.cx=3*e,this.bx=3*(l-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(u-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=l,this.p2y=u}return Ol=1,qu=n,n.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var l=e,u=0;u<8;u++){var f=this.sampleCurveX(l)-e;if(Math.abs(f)<i)return l;var p=this.sampleCurveDerivativeX(l);if(Math.abs(p)<1e-6)break;l-=f/p}var y=0,w=1;for(l=e,u=0;u<20&&(f=this.sampleCurveX(l),!(Math.abs(f-e)<i));u++)e>f?y=l:w=l,l=.5*(w-y)+y;return l},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},qu}(),fh=Hu(Wu);function ft(n,e){this.x=n,this.y=e}function va(n,e){if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!va(n[i],e[i]))return!1;return!0}if(typeof n=="object"&&n!==null&&e!==null){if(typeof e!="object"||Object.keys(n).length!==Object.keys(e).length)return!1;for(const i in n)if(!va(n[i],e[i]))return!1;return!0}return n===e}ft.prototype={clone(){return new ft(this.x,this.y)},add(n){return this.clone()._add(n)},sub(n){return this.clone()._sub(n)},multByPoint(n){return this.clone()._multByPoint(n)},divByPoint(n){return this.clone()._divByPoint(n)},mult(n){return this.clone()._mult(n)},div(n){return this.clone()._div(n)},rotate(n){return this.clone()._rotate(n)},rotateAround(n,e){return this.clone()._rotateAround(n,e)},matMult(n){return this.clone()._matMult(n)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(n){return this.x===n.x&&this.y===n.y},dist(n){return Math.sqrt(this.distSqr(n))},distSqr(n){const e=n.x-this.x,i=n.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith(n){return this.angleWithSep(n.x,n.y)},angleWithSep(n,e){return Math.atan2(this.x*e-this.y*n,this.x*n+this.y*e)},_matMult(n){const e=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=e,this},_add(n){return this.x+=n.x,this.y+=n.y,this},_sub(n){return this.x-=n.x,this.y-=n.y,this},_mult(n){return this.x*=n,this.y*=n,this},_div(n){return this.x/=n,this.y/=n,this},_multByPoint(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint(n){return this.x/=n.x,this.y/=n.y,this},_unit(){return this._div(this.mag()),this},_perp(){const n=this.y;return this.y=this.x,this.x=-n,this},_rotate(n){const e=Math.cos(n),i=Math.sin(n),l=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=l,this},_rotateAround(n,e){const i=Math.cos(n),l=Math.sin(n),u=e.y+l*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-l*(this.y-e.y),this.y=u,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:ft},ft.convert=function(n){if(n instanceof ft)return n;if(Array.isArray(n))return new ft(+n[0],+n[1]);if(n.x!==void 0&&n.y!==void 0)return new ft(+n.x,+n.y);throw new Error("Expected [x, y] or {x, y} point format")};const Fp=Math.PI/180,Ec=180/Math.PI;function Re(n){return n*Fp}function X(n){return n*Ec}const Q=[[0,0],[1,0],[1,1],[0,1]];function he(n){if(n<=0)return 0;if(n>=1)return 1;const e=n*n,i=e*n;return 4*(n<.5?i:3*(n-e)+i-.75)}function Te(n,e,i,l){const u=new fh(n,e,i,l);return function(f){return u.solve(f)}}const we=Te(.25,.1,.25,1);function be(n,e,i){return Math.min(i,Math.max(e,n))}function Ge(n,e,i){return(i=be((i-n)/(e-n),0,1))*i*(3-2*i)}function Me(n,e,i){const l=i-e,u=((n-e)%l+l)%l+e;return u===e?i:u}function qe(n,e,i){if(!n.length)return i(null,[]);let l=n.length;const u=new Array(n.length);let f=null;n.forEach((p,y)=>{e(p,(w,E)=>{w&&(f=w),u[y]=E,--l==0&&i(f,u)})})}let yt=1;function ot(){return yt++}function Gt(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log2(n)))}function tr(n,e){n.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function ar(n,e,i){const l={};for(const u in n)l[u]=e.call(this,n[u],u,n);return l}function Rr(n,e,i){const l={};for(const u in n)e.call(this,n[u],u,n)&&(l[u]=n[u]);return l}function Mr(n){return Array.isArray(n)?n.map(Mr):typeof n=="object"&&n?ar(n,Mr):n}function zr(n,e){for(let i=0;i<n.length;i++)if(e.indexOf(n[i])>=0)return!0;return!1}const pi={};function Lr(n){pi[n]||(typeof console<"u"&&console.warn(n),pi[n]=!0)}function Yi(n,e,i){return(i.y-n.y)*(e.x-n.x)>(e.y-n.y)*(i.x-n.x)}function dn(n){let e=0;for(let i,l,u=0,f=n.length,p=f-1;u<f;p=u++)i=n[u],l=n[p],e+=(l.x-i.x)*(i.y+l.y);return e}function hn([n,e,i]){const l=Re(e+90),u=Re(i);return{x:n*Math.cos(l)*Math.sin(u),y:n*Math.sin(l)*Math.sin(u),z:n*Math.cos(u),azimuthal:e,polar:i}}function fi(n){return(typeof self<"u"||n!==void 0)&&typeof WorkerGlobalScope<"u"&&(n!==void 0?n:self)instanceof WorkerGlobalScope}function Qr(n){const e={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,l,u,f)=>{const p=u||f;return e[l]=!p||p.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Wi=null;function Zi(n,e){return[n[4*e],n[4*e+1],n[4*e+2],n[4*e+3]]}function Ti(n,e,i,l){for(;e<i;){const u=e+i>>1;n[u]<l?e=u+1:i=u}return e}function Gn(n,e,i,l){for(;e<i;){const u=e+i>>1;n[u]<=l?e=u+1:i=u}return e}function ds(n){return n>0?1/(1.001-n):1+n}function qs(n){return n>0?1-1/(1.001-n):-n}function ba(n,e,i){return(n-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const is={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!is.API_URL)return null;try{const n=new URL(is.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Ic(n){return is.API_URL_REGEX.test(n)}function Z_(n){return is.API_SPRITE_REGEX.test(n)}let Xa,Cc,Zu,Xu,Ya,Yu;function Bp(){return Xa==null&&(Xa=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Xa}const Qo={now:()=>Xu!==void 0?Xu:performance.now(),setNow(n){Xu=n},restoreNow(){Xu=void 0},frame(n){const e=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(n,e=0){const{width:i,height:l}=n;Ya||(Ya=document.createElement("canvas"));const u=Ya.getContext("2d",{willReadFrequently:!0});if(!u)throw new Error("failed to create canvas 2d context");return(i>Ya.width||l>Ya.height)&&(Ya.width=i,Ya.height=l),u.clearRect(-e,-e,i+2*e,l+2*e),u.drawImage(n,0,0,i,l),u.getImageData(-e,-e,i+2*e,l+2*e)},resolveURL:n=>(Cc||(Cc=document.createElement("a")),Cc.href=n,Cc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Zu==null&&(Zu=window.matchMedia("(prefers-reduced-motion: reduce)")),Zu.matches)},hasCanvasFingerprintNoise(){if(Yu!==void 0)return Yu;if(!Bp())return Yu=!1,!1;const n=new OffscreenCanvas(85,1),e=n.getContext("2d",{willReadFrequently:!0});let i=0;for(let u=0;u<n.width;++u)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(u,0,1,1);const l=e.getImageData(0,0,n.width,n.height);i=0;for(let u=0;u<l.data.length;++u)if(u%4!=3&&i++!==l.data[u])return Yu=!0,!0;return Yu=!1,!1}};function Up(n,e){const i=n.indexOf("?");if(i<0)return`${n}?${new URLSearchParams(e).toString()}`;const l=new URLSearchParams(n.slice(i));for(const u in e)l.set(u,e[u]);return`${n.slice(0,i)}?${l.toString()}`}function ph(n,e={persistentParams:[]}){const i=n.indexOf("?");if(i<0)return n;const l=new URLSearchParams,u=new URLSearchParams(n.slice(i));for(const p of e.persistentParams){const y=u.get(p);y&&l.set(p,y)}const f=l.toString();return`${n.slice(0,i)}${f.length>0?`?${f}`:""}`}const Hs="mapbox-tiles";let ko=500,wa=50;const Mo=["language","worldview","jobid"];let hs,Dl;function Vp(){try{return caches}catch{}}function Ku(){const n=Vp();n&&hs==null&&(hs=n.open(Hs))}let Ka=1/0;const Ju={supported:!1,testSupport:function(n){!Ws&&Ac&&($p?Pc(n):Qu=n)}};let Qu,Ac,Ws=!1,$p=!1;const mh=typeof self<"u"?self:{};function Pc(n){const e=n.createTexture();n.bindTexture(n.TEXTURE_2D,e);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,Ac),n.isContextLost())return;Ju.supported=!0}catch{}n.deleteTexture(e),Ws=!0}mh.document&&(Ac=mh.document.createElement("img"),Ac.onload=function(){Qu&&Pc(Qu),Qu=null,$p=!0},Ac.onerror=function(){Ws=!0,Qu=null},Ac.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const gh={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(gh);class Gp extends Error{constructor(e,i,l){i===401&&Ic(l)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=l}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const _h=fi()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Ur=function(n,e){if(!(/^file:/.test(i=n.url)||/^file:/.test(_h())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(l,u){const f=new AbortController,p=new Request(l.url,{method:l.method||"GET",body:l.body,credentials:l.credentials,headers:l.headers,referrer:_h(),referrerPolicy:l.referrerPolicy,signal:f.signal});let y=!1,w=!1;const E=(A=p.url).indexOf("sku=")>0&&Ic(A);var A;l.type==="json"&&p.headers.set("Accept","application/json");const P=(O,D,V)=>{if(w)return;if(O&&O.message!=="SecurityError"&&Lr(O.toString()),D&&V)return M(D);const G=Date.now();fetch(p).then(q=>{if(q.ok){const te=E?q.clone():null;return M(q,te,G)}return u(new Gp(q.statusText,q.status,l.url))}).catch(q=>{q.name!=="AbortError"&&u(new Error(`${q.message} ${l.url}`))})},M=(O,D,V)=>{(l.type==="arrayBuffer"?O.arrayBuffer():l.type==="json"?O.json():O.text()).then(G=>{w||(D&&V&&function(q,te,re){if(Ku(),hs==null)return;const oe=Qr(te.headers.get("Cache-Control")||"");if(oe["no-store"])return;const xe={status:te.status,statusText:te.statusText,headers:new Headers};te.headers.forEach((Ce,Ae)=>xe.headers.set(Ae,Ce)),oe["max-age"]&&xe.headers.set("Expires",new Date(re+1e3*oe["max-age"]).toUTCString());const ve=xe.headers.get("Expires");if(!ve||new Date(ve).getTime()-re<42e4)return;let Se=ph(q.url,{persistentParams:Mo});if(te.status===206){const Ce=q.headers.get("Range");if(!Ce)return;xe.status=200,Se=Up(Se,{range:Ce})}(function(Ce,Ae){if(Dl===void 0)try{new Response(new ReadableStream),Dl=!0}catch{Dl=!1}Dl?Ae(Ce.body):Ce.blob().then(Ae).catch(Qe=>Lr(Qe.message))})(te,Ce=>{const Ae=new Response((Qe=te.status)!==200&&Qe!==404&&[101,103,204,205,304].includes(Qe)?null:Ce,xe);var Qe;Ku(),hs!=null&&hs.then(Oe=>Oe.put(Se,Ae)).catch(Oe=>Lr(Oe.message))})}(p,D,V),y=!0,u(null,G,O.headers.get("Cache-Control"),O.headers.get("Expires")))}).catch(G=>{w||u(new Error(G.message))})};return E?function(O,D){if(Ku(),hs==null)return D(null);hs.then(V=>{let G=ph(O.url,{persistentParams:Mo});const q=O.headers.get("Range");q&&(G=Up(G,{range:q})),V.match(G).then(te=>{const re=function(oe){if(!oe)return!1;const xe=new Date(oe.headers.get("Expires")||0),ve=Qr(oe.headers.get("Cache-Control")||"");return Number(xe)>Date.now()&&!ve["no-cache"]}(te);V.delete(G).catch(D),re&&V.put(G,te.clone()).catch(D),D(null,te,re)}).catch(D)}).catch(D)}(p,P):P(null,null),{cancel:()=>{w=!0,y||f.abort()}}}(n,e);if(fi(self)&&self.worker.actor)return self.worker.actor.send("getResource",n,e,void 0,!0)}var i;return function(l,u){const f=new XMLHttpRequest;f.open(l.method||"GET",l.url,!0),l.type==="arrayBuffer"&&(f.responseType="arraybuffer");for(const p in l.headers)f.setRequestHeader(p,l.headers[p]);return l.type==="json"&&(f.responseType="text",f.setRequestHeader("Accept","application/json")),f.withCredentials=l.credentials==="include",f.onerror=()=>{u(new Error(f.statusText))},f.onload=()=>{if((f.status>=200&&f.status<300||f.status===0)&&f.response!==null){let p=f.response;if(l.type==="json")try{p=JSON.parse(f.response)}catch(y){return u(y)}u(null,p,f.getResponseHeader("Cache-Control"),f.getResponseHeader("Expires"))}else u(new Gp(f.statusText,f.status,l.url))},f.send(l.body),{cancel:()=>f.abort()}}(n,e)},kc=function(n,e){return Ur(Object.assign(n,{type:"arrayBuffer"}),e)};function X_(n){const e=document.createElement("a");return e.href=n,e.protocol===location.protocol&&e.host===location.host}const Y_="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let yh,Ja;yh=[],Ja=0;const Mc=function(n,e){if(Ju.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),Ja>=is.MAX_PARALLEL_IMAGE_REQUESTS){const f={requestParameters:n,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return yh.push(f),f}Ja++;let i=!1;const l=()=>{if(!i)for(i=!0,Ja--;yh.length&&Ja<is.MAX_PARALLEL_IMAGE_REQUESTS;){const f=yh.shift(),{requestParameters:p,callback:y,cancelled:w}=f;w||(f.cancel=Mc(p,y).cancel)}},u=kc(n,(f,p,y,w)=>{l(),f?e(f):p&&(self.createImageBitmap?function(E,A){const P=new Blob([new Uint8Array(E)],{type:"image/png"});createImageBitmap(P).then(M=>{A(null,M)}).catch(M=>{A(new Error(`Could not load image because of ${M.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(p,(E,A)=>e(E,A,y,w)):function(E,A){const P=new Image;P.onload=()=>{A(null,P),URL.revokeObjectURL(P.src),P.onload=null,requestAnimationFrame(()=>{P.src=Y_})},P.onerror=()=>A(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const M=new Blob([new Uint8Array(E)],{type:"image/png"});P.src=E.byteLength?URL.createObjectURL(M):Y_}(p,(E,A)=>e(E,A,y,w)))});return{cancel:()=>{u.cancel(),l()}}};var ed,xh,K_,jl={exports:{}},J_={exports:{}},qp={exports:{}},Nc=function(){if(K_)return jl.exports;K_=1;var n=(ed||(ed=1,J_.exports=function(i,l){var u,f,p,y,w,E,A,P;for(f=i.length-(u=3&i.length),p=l,w=3432918353,E=461845907,P=0;P<f;)A=255&i.charCodeAt(P)|(255&i.charCodeAt(++P))<<8|(255&i.charCodeAt(++P))<<16|(255&i.charCodeAt(++P))<<24,++P,p=27492+(65535&(y=5*(65535&(p=(p^=A=(65535&(A=(A=(65535&A)*w+(((A>>>16)*w&65535)<<16)&4294967295)<<15|A>>>17))*E+(((A>>>16)*E&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(A=0,u){case 3:A^=(255&i.charCodeAt(P+2))<<16;case 2:A^=(255&i.charCodeAt(P+1))<<8;case 1:p^=A=(65535&(A=(A=(65535&(A^=255&i.charCodeAt(P)))*w+(((A>>>16)*w&65535)<<16)&4294967295)<<15|A>>>17))*E+(((A>>>16)*E&65535)<<16)&4294967295}return p^=i.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0}),J_.exports),e=(xh||(xh=1,qp.exports=function(i,l){for(var u,f=i.length,p=l^f,y=0;f>=4;)u=1540483477*(65535&(u=255&i.charCodeAt(y)|(255&i.charCodeAt(++y))<<8|(255&i.charCodeAt(++y))<<16|(255&i.charCodeAt(++y))<<24))+((1540483477*(u>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(u=1540483477*(65535&(u^=u>>>24))+((1540483477*(u>>>16)&65535)<<16)),f-=4,++y;switch(f){case 3:p^=(255&i.charCodeAt(y+2))<<16;case 2:p^=(255&i.charCodeAt(y+1))<<8;case 1:p=1540483477*(65535&(p^=255&i.charCodeAt(y)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0}),qp.exports);return jl.exports=n,jl.exports.murmur3=n,jl.exports.murmur2=e,jl.exports}(),vh=Hu(Nc);class No{constructor(e,...i){Object.assign(this,i[0]||{}),this.type=e}}class td extends No{constructor(e,i={}){super("error",Object.assign({error:e},i))}}function bh(n,e,i){i[n]&&i[n].indexOf(e)!==-1||(i[n]=i[n]||[],i[n].push(e))}function Zs(n,e,i){if(i&&i[n]){const l=i[n].indexOf(e);l!==-1&&i[n].splice(l,1)}}class zl{on(e,i){return this._listeners=this._listeners||{},bh(e,i,this._listeners),this}off(e,i){return Zs(e,i,this._listeners),Zs(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},bh(e,i,this._oneTimeListeners),this):new Promise(l=>{this.once(e,l)})}fire(e,i){const l=typeof e=="string"?new No(e,i):e,u=l.type;if(this.listens(u)){l.target=this;const f=this._listeners&&this._listeners[u]?this._listeners[u].slice():[];for(const w of f)w.call(this,l);const p=this._oneTimeListeners&&this._oneTimeListeners[u]?this._oneTimeListeners[u].slice():[];for(const w of p)Zs(u,w,this._oneTimeListeners),w.call(this,l);const y=this._eventedParent;if(y){const w=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(l,w),y.fire(l)}}else l instanceof td&&console.error(l.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Xs{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Xs(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,l]=e.split("");return new Xs({name:i,iconsetId:l})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Xs.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Hp,wh={},Wp=function(){if(Hp)return wh;Hp=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(f){return(f=Math.round(f))<0?0:f>255?255:f}function i(f){return e(f[f.length-1]==="%"?parseFloat(f)/100*255:parseInt(f))}function l(f){return(p=f[f.length-1]==="%"?parseFloat(f)/100:parseFloat(f))<0?0:p>1?1:p;var p}function u(f,p,y){return y<0?y+=1:y>1&&(y-=1),6*y<1?f+(p-f)*y*6:2*y<1?p:3*y<2?f+(p-f)*(2/3-y)*6:f}try{wh.parseCSSColor=function(f){var p,y=f.replace(/ /g,"").toLowerCase();if(y in n)return n[y].slice();if(y[0]==="#")return y.length===4?(p=parseInt(y.substr(1),16))>=0&&p<=4095?[(3840&p)>>4|(3840&p)>>8,240&p|(240&p)>>4,15&p|(15&p)<<4,1]:null:y.length===7&&(p=parseInt(y.substr(1),16))>=0&&p<=16777215?[(16711680&p)>>16,(65280&p)>>8,255&p,1]:null;var w=y.indexOf("("),E=y.indexOf(")");if(w!==-1&&E+1===y.length){var A=y.substr(0,w),P=y.substr(w+1,E-(w+1)).split(","),M=1;switch(A){case"rgba":if(P.length!==4)return null;M=l(P.pop());case"rgb":return P.length!==3?null:[i(P[0]),i(P[1]),i(P[2]),M];case"hsla":if(P.length!==4)return null;M=l(P.pop());case"hsl":if(P.length!==3)return null;var O=(parseFloat(P[0])%360+360)%360/360,D=l(P[1]),V=l(P[2]),G=V<=.5?V*(D+1):V+D-V*D,q=2*V-G;return[e(255*u(q,G,O+1/3)),e(255*u(q,G,O)),e(255*u(q,G,O-1/3)),M];default:return null}}return null}}catch{}return wh}();class ti{constructor(e,i,l,u=1){this.r=e,this.g=i,this.b=l,this.a=u}static parse(e){if(!e)return;if(e instanceof ti)return e;if(typeof e!="string")return;const i=Wp.parseCSSColor(e);return i?new ti(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,l,u]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*l)},${u})`}toNonPremultipliedRenderColor(e){const{r:i,g:l,b:u,a:f}=this;return new Q_(e,i,l,u,f)}toPremultipliedRenderColor(e){const{r:i,g:l,b:u,a:f}=this;return new Sh(e,i*f,l*f,u*f,f)}clone(){return new ti(this.r,this.g,this.b,this.a)}}class Zp{constructor(e,i,l,u,f,p=!1){if(this.premultiplied=!1,this.premultiplied=p,e){const y=e.image.height,w=y*y;this.premultiplied?(i=f===0?0:i/f*(y-1),l=f===0?0:l/f*(y-1),u=f===0?0:u/f*(y-1)):(i*=y-1,l*=y-1,u*=y-1);const E=Math.floor(i),A=Math.floor(l),P=Math.floor(u),M=Math.ceil(i),O=Math.ceil(l),D=Math.ceil(u),V=i-E,G=l-A,q=u-P,te=e.image.data,re=4*(E+A*w+P*y),oe=4*(E+A*w+D*y),xe=4*(E+O*w+P*y),ve=4*(E+O*w+D*y),Se=4*(M+A*w+P*y),Ce=4*(M+A*w+D*y),Ae=4*(M+O*w+P*y),Qe=4*(M+O*w+D*y);if(re<0||Qe>=te.length)throw new Error("out of range");this.r=Yt(Yt(Yt(te[re],te[oe],q),Yt(te[xe],te[ve],q),G),Yt(Yt(te[Se],te[Ce],q),Yt(te[Ae],te[Qe],q),G),V)/255*(this.premultiplied?f:1),this.g=Yt(Yt(Yt(te[re+1],te[oe+1],q),Yt(te[xe+1],te[ve+1],q),G),Yt(Yt(te[Se+1],te[Ce+1],q),Yt(te[Ae+1],te[Qe+1],q),G),V)/255*(this.premultiplied?f:1),this.b=Yt(Yt(Yt(te[re+2],te[oe+2],q),Yt(te[xe+2],te[ve+2],q),G),Yt(Yt(te[Se+2],te[Ce+2],q),Yt(te[Ae+2],te[Qe+2],q),G),V)/255*(this.premultiplied?f:1),this.a=f}else this.r=i,this.g=l,this.b=u,this.a=f}toArray(){const{r:e,g:i,b:l,a:u}=this;return[255*e,255*i,255*l,u]}toHslaArray(){let{r:e,g:i,b:l,a:u}=this;if(this.premultiplied){if(u===0)return[0,0,0,0];const D=1/u;e*=D,i*=D,l*=D}const f=Math.min(Math.max(e,0),1),p=Math.min(Math.max(i,0),1),y=Math.min(Math.max(l,0),1),w=Math.min(f,p,y),E=Math.max(f,p,y),A=E-w,P=.5*(w+E);if(A===0)return[0,0,100*P,u];const M=P>.5?A/(2-E-w):A/(E+w);let O;switch(E){case f:O=60*((p-y)/A+(p<y?6:0));break;case p:O=60*((y-f)/A+2);break;default:O=60*((f-p)/A+4)}return[O,100*M,100*P,u]}toArray01(){const{r:e,g:i,b:l,a:u}=this;return[e,i,l,u]}toArray01Scaled(e){const{r:i,g:l,b:u}=this;return[i*e,l*e,u*e]}toArray01Linear(){const{r:e,g:i,b:l,a:u}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(l,2.2),u]}}class Q_ extends Zp{constructor(e,i,l,u,f){super(e,i,l,u,f,!1)}}class Sh extends Zp{constructor(e,i,l,u,f){super(e,i,l,u,f,!0)}}function Yt(n,e,i){return n*(1-i)+e*i}function Xp(n,e,i){return n.map((l,u)=>Yt(l,e[u],i))}ti.black=new ti(0,0,0,1),ti.white=new ti(1,1,1,1),ti.transparent=new ti(0,0,0,0),ti.red=new ti(1,0,0,1),ti.blue=new ti(0,0,1,1);var Ys=Object.freeze({__proto__:null,array:Xp,color:function(n,e,i){return new ti(Yt(n.r,e.r,i),Yt(n.g,e.g,i),Yt(n.b,e.b,i),Yt(n.a,e.a,i))},number:Yt});class Ro extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class Th{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[l,u]of i)this.bindings[l]=u}concat(e){return new Th(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const ea={kind:"null"},Vt={kind:"number"},ri={kind:"string"},ai={kind:"boolean"},Ns={kind:"color"},Fl={kind:"object"},Kr={kind:"value"},Eh={kind:"collator"},Qa={kind:"formatted"},rd={kind:"resolvedImage"};function ns(n,e){return{kind:"array",itemType:n,N:e}}function fn(n){if(n.kind==="array"){const e=fn(n.itemType);return typeof n.N=="number"?`array<${e}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${e}>`}return n.kind}const Vv=[ea,Vt,ri,ai,Ns,Qa,Fl,ns(Kr),rd];function id(n,e){if(e.kind==="error")return null;if(n.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!id(n.itemType,e.itemType))&&(typeof n.N!="number"||n.N===e.N))return null}else{if(n.kind===e.kind)return null;if(n.kind==="value"){for(const i of Vv)if(!id(i,e))return null}}return`Expected ${fn(n)} but found ${fn(e)} instead.`}function Yp(n,e){return e.some(i=>i.kind===n.kind)}function nd(n,e){return e.some(i=>i==="null"?n===null:i==="array"?Array.isArray(n):i==="object"?n&&!Array.isArray(n)&&typeof n=="object":i===typeof n)}function sd(n,e){return n.kind==="array"&&e.kind==="array"?n.N===e.N&&sd(n.itemType,e.itemType):n.kind===e.kind}class el{constructor(e,i,l){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=l,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ih{constructor(e,i,l,u,f){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=l,this.fontStack=u,this.textColor=f}}class fs{constructor(e){this.sections=e}static fromString(e){return new fs([new Ih(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof fs?e:fs.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const u=i.image.getPrimary().id.toString();e.push(["image",u]);continue}e.push(i.text);const l={};i.fontStack&&(l["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(l["font-scale"]=i.scale),i.textColor&&(l["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(l)}return e}}class Lo{constructor(e,i={}){if(this.id=Xs.from(e),this.options=Object.assign({},i),i.transform){const{a:l,b:u,c:f,d:p,e:y,f:w}=i.transform;this.options.transform=new DOMMatrix([l,u,f,p,y,w])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:l,d:u,e:f,f:p}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:l,d:u,e:f,f:p}})}static parse(e){let i,l,u,f;try{({name:i,iconsetId:l,params:u,transform:f}=JSON.parse(e)||{})}catch{return null}if(!i)return null;const{a:p,b:y,c:w,d:E,e:A,f:P}=f||{};return new Lo({name:i,iconsetId:l},{params:u,transform:new DOMMatrix([p,y,w,E,A,P])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class Is{constructor(e,i,l,u,f=!1){this.primaryId=Xs.from(e),this.primaryOptions=i,l&&(this.secondaryId=Xs.from(l)),this.secondaryOptions=u,this.available=f}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Lo(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Lo(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Is.build({name:e}):e}static build(e,i,l,u){return!e||typeof e=="object"&&!("name"in e)?null:new Is(e,l,i,u)}}function e0(n,e,i,l){return typeof n=="number"&&n>=0&&n<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?l===void 0||typeof l=="number"&&l>=0&&l<=1?null:`Invalid rgba value [${[n,e,i,l].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof l=="number"?[n,e,i,l]:[n,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Rc(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof ti||n instanceof el||n instanceof fs||n instanceof Is)return!0;if(Array.isArray(n)){for(const e of n)if(!Rc(e))return!1;return!0}if(typeof n=="object"){for(const e in n)if(!Rc(n[e]))return!1;return!0}return!1}function Cn(n){if(n===null)return ea;if(typeof n=="string")return ri;if(typeof n=="boolean")return ai;if(typeof n=="number")return Vt;if(n instanceof ti)return Ns;if(n instanceof el)return Eh;if(n instanceof fs)return Qa;if(n instanceof Is)return rd;if(Array.isArray(n)){const e=n.length;let i;for(const l of n){const u=Cn(l);if(i){if(i===u)continue;i=Kr;break}i=u}return ns(i||Kr,e)}return Fl}function Cs(n){const e=typeof n;return n===null?"":e==="string"||e==="number"||e==="boolean"?String(n):n instanceof fs||n instanceof Is||n instanceof ti?n.toString():JSON.stringify(n)}class vr{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Rc(e[1]))return i.error("invalid value");const l=e[1];let u=Cn(l);const f=i.expectedType;return u.kind!=="array"||u.N!==0||!f||f.kind!=="array"||typeof f.N=="number"&&f.N!==0||(u=f),new vr(u,l)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof ti?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof fs?this.value.serialize():this.value}}class At{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const od={string:ri,number:Vt,boolean:ai,object:Fl};class Jt{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let l,u=1;const f=e[0];if(f==="array"){let y,w;if(e.length>2){const E=e[1];if(typeof E!="string"||!(E in od)||E==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);y=od[E],u++}else y=Kr;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);w=e[2],u++}l=ns(y,w)}else l=od[f];const p=[];for(;u<e.length;u++){const y=i.parse(e[u],u,Kr);if(!y)return null;p.push(y)}return new Jt(l,p)}evaluate(e){for(let i=0;i<this.args.length;i++){const l=this.args[i].evaluate(e);if(!id(this.type,Cn(l)))return l;if(i===this.args.length-1)throw new At(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${fn(Cn(l))} but was expected to be of type ${fn(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const l=e.itemType;if(l.kind==="string"||l.kind==="number"||l.kind==="boolean"){i.push(l.kind);const u=e.N;(typeof u=="number"||this.args.length>1)&&i.push(u)}}return i.concat(this.args.map(l=>l.serialize()))}}class Bl{constructor(e){this.type=Qa,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const l=e[1];if(!Array.isArray(l)&&typeof l=="object")return i.error("First argument must be an image or text section.");const u=[];let f=!1;for(let p=1;p<=e.length-1;++p){const y=e[p];if(f&&typeof y=="object"&&!Array.isArray(y)){f=!1;let w=null;if(y["font-scale"]&&(w=i.parseObjectValue(y["font-scale"],p,"font-scale",Vt),!w))return null;let E=null;if(y["text-font"]&&(E=i.parseObjectValue(y["text-font"],p,"text-font",ns(ri)),!E))return null;let A=null;if(y["text-color"]&&(A=i.parseObjectValue(y["text-color"],p,"text-color",Ns),!A))return null;const P=u[u.length-1];P.scale=w,P.font=E,P.textColor=A}else{const w=i.parse(e[p],p,Kr);if(!w)return null;const E=w.type.kind;if(E!=="string"&&E!=="value"&&E!=="null"&&E!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");f=!0,u.push({content:w,scale:null,font:null,textColor:null})}}return new Bl(u)}evaluate(e){return new fs(this.sections.map(i=>{const l=i.content.evaluate(e);return sd(Cn(l),rd)?new Ih("",l,null,null,null):new Ih(Cs(l),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const l={};i.scale&&(l["font-scale"]=i.scale.serialize()),i.font&&(l["text-font"]=i.font.serialize()),i.textColor&&(l["text-color"]=i.textColor.serialize()),e.push(l)}return e}}class Lc{constructor(e,i,l,u){this._imageWarnHistory={},this.type=rd,this.namePrimary=e,this.nameSecondary=i,l&&(this.paramsPrimary=l.params,this.iconsetIdPrimary=l.iconset?l.iconset.id:void 0),u&&(this.paramsSecondary=u.params,this.iconsetIdSecondary=u.iconset?u.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let l=1;const u=[];function f(){if(l<e.length){const y=i.parse(e[l],l++,ri);return y?(u.push({image:y,options:{}}),!0):(i.error(u.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function p(){if(l<e.length){const w=e[l];if((y=w)===null||typeof y!="object"||Array.isArray(y))return!0;const E=w.params,A=w.iconset,P=i.concat(l);if(!E&&!A)return l++,!0;if(E){if(typeof E!="object"||E.constructor!==Object)return P.error('Image options "params" should be an object'),!1;const M={},O=P.concat(void 0,"params");for(const D in E){if(!D)return O.error("Image parameter name should be non-empty"),!1;const V=O.concat(void 0,D).parse(E[D],void 0,Ns,void 0,{typeAnnotation:"coerce"});if(!V)return!1;M[D]=V}u[u.length-1].options.params=M}if(A){if(typeof A!="object"||A.constructor!==Object)return P.error('Image options "iconset" should be an object'),!1;if(!A.id)return P.error('Image options "iconset" should have an "id" property'),!1;u[u.length-1].options.iconset=A}return l++,!0}var y;return!0}for(let y=0;y<2;y++)if(!f()||!p())return;return new Lc(u[0].image,u[1]?u[1].image:void 0,u[0].options,u[1]?u[1].options:void 0)}evaluateParams(e,i){const l={};if(i){for(const u in i)if(i[u])try{l[u]=i[u].evaluate(e)}catch{continue}if(Object.keys(l).length!==0)return{params:l}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},l=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,u=Is.build(i,l,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(u&&e.availableImages){const f=u.getPrimary().id;if(u.available=e.availableImages.some(p=>Xs.isEqual(p,f)),u.available){const p=u.getSecondary()?u.getSecondary().id:null;p&&(u.available=e.availableImages.some(y=>Xs.isEqual(y,p)))}}return u}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const l={};if(i&&(l.iconset={id:i}),e){l.params={};for(const u in e)e[u]&&(l.params[u]=e[u].serialize())}return Object.keys(l).length>0?l:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function ir(n){return ad(n)?"string":ld(n)?"number":Jp(n)?"boolean":Array.isArray(n)?"array":n===null?"null":Kp(n)?"object":typeof n}function Kp(n){return n!=null&&!Array.isArray(n)&&typeof n!="function"&&!(n instanceof String||n instanceof Number||n instanceof Boolean)&&typeof n=="object"}function ad(n){return typeof n=="string"||n instanceof String}function ld(n){return typeof n=="number"||n instanceof Number}function Jp(n){return typeof n=="boolean"||n instanceof Boolean}const Ch={"to-boolean":ai,"to-color":Ns,"to-number":Vt,"to-string":ri};class nn{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const l=e[0],u=[];let f=ea;if(l==="to-array"){if(!Array.isArray(e[1]))return null;const p=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);f=ns(i.expectedType.itemType,p)}else{if(!(p>0&&Rc(e[1][0])))return null;f=ns(Cn(e[1][0]),p)}for(let y=0;y<p;y++){const w=e[1][y];let E;if(Array.isArray(w))E=i.parse(w,void 0,f.itemType);else{const A=ir(w);if(A!==f.itemType.kind)return i.error(`Expected ${f.itemType.kind} but found ${A}.`);E=i.registry.literal.parse(["literal",w===void 0?null:w],i)}if(!E)return null;u.push(E)}}else{if((l==="to-boolean"||l==="to-string")&&e.length!==2)return i.error("Expected one argument.");f=Ch[l];for(let p=1;p<e.length;p++){const y=i.parse(e[p],p,Kr);if(!y)return null;u.push(y)}}return new nn(f,u)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,l;for(const u of this.args){if(i=u.evaluate(e),l=null,i instanceof ti)return i;if(typeof i=="string"){const f=e.parseColor(i);if(f)return f}else if(Array.isArray(i)&&(l=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:e0(i[0],i[1],i[2],i[3]),!l))return new ti(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new At(l||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const l of this.args){if(i=l.evaluate(e),i===null)return 0;const u=Number(i);if(!isNaN(u))return u}throw new At(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?fs.fromString(Cs(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Is.build(Cs(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Cs(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Bl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Lc(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const Qp=["Unknown","Point","LineString","Polygon"];class Sa{constructor(e,i,l){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i,this.iconImageUseTheme=l}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Qp[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:l,y:u}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(l*i-e[0])+this.featureDistanceData.bearing[1]*(u*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=ti.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class ps{constructor(e,i,l,u,f){this.name=e,this.type=i,this._evaluate=l,this.args=u,this._overloadIndex=f}evaluate(e){if(!this._evaluate){const i=ps.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const l=e[0],u=ps.definitions[l];if(!u)return i.error(`Unknown expression "${l}". If you wanted a literal array, use ["literal", [...]].`,0);const f=Array.isArray(u)?u[0]:u.type,p=Array.isArray(u)?[[u[1],u[2]]]:u.overloads,y=[];let w=null,E=-1;for(const[A,P]of p){if(Array.isArray(A)&&A.length!==e.length-1)continue;y.push(A),E++,w=new Vh(i.registry,i.path,null,i.scope,void 0,i._scope,i.options,i.iconImageUseTheme);const M=[];let O=!1;for(let D=1;D<e.length;D++){const V=e[D],G=Array.isArray(A)?A[D-1]:A.type,q=w.parse(V,1+M.length,G);if(!q){O=!0;break}M.push(q)}if(!O)if(Array.isArray(A)&&A.length!==M.length)w.error(`Expected ${A.length} arguments, but found ${M.length} instead.`);else{for(let D=0;D<M.length;D++){const V=Array.isArray(A)?A[D]:A.type,G=M[D];w.concat(D+1).checkSubtype(V,G.type)}if(w.errors.length===0)return new ps(l,f,P,M,E)}}if(y.length===1)i.errors.push(...w.errors);else{const A=(y.length?y:p.map(([M])=>M)).map(tl).join(" | "),P=[];for(let M=1;M<e.length;M++){const O=i.parse(e[M],1+P.length);if(!O)return null;P.push(fn(O.type))}i.error(`Expected arguments of type ${A}, but found (${P.join(", ")}) instead.`)}return null}static register(e,i){ps.definitions=i;for(const l in i)e[l]=ps}}function tl(n){return Array.isArray(n)?`(${n.map(fn).join(", ")})`:`(${fn(n.type)}...)`}class qn{constructor(e,i,l){this.type=Eh,this.locale=l,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const l=e[1];if(typeof l!="object"||Array.isArray(l))return i.error("Collator options argument must be an object.");const u=l["case-sensitive"]===void 0?i.parse(!1,1,ai):i.parseObjectValue(l["case-sensitive"],1,"case-sensitive",ai);if(!u)return null;const f=l["diacritic-sensitive"]===void 0?i.parse(!1,1,ai):i.parseObjectValue(l["diacritic-sensitive"],1,"diacritic-sensitive",ai);if(!f)return null;let p=null;return l.locale&&(p=i.parseObjectValue(l.locale,1,"locale",ri),!p)?null:new qn(u,f,p)}evaluate(e){return new el(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function t0(n,e,i=0,l=n.length-1,u=$v){for(;l>i;){if(l-i>600){const w=l-i+1,E=e-i+1,A=Math.log(w),P=.5*Math.exp(2*A/3),M=.5*Math.sqrt(A*P*(w-P)/w)*(E-w/2<0?-1:1);t0(n,e,Math.max(i,Math.floor(e-E*P/w+M)),Math.min(l,Math.floor(e+(w-E)*P/w+M)),u)}const f=n[e];let p=i,y=l;for(cd(n,i,e),u(n[l],f)>0&&cd(n,i,l);p<y;){for(cd(n,p,y),p++,y--;u(n[p],f)<0;)p++;for(;u(n[y],f)>0;)y--}u(n[i],f)===0?cd(n,i,y):(y++,cd(n,y,l)),y<=e&&(i=y+1),e<=y&&(l=y-1)}}function cd(n,e,i){const l=n[e];n[e]=n[i],n[i]=l}function $v(n,e){return n<e?-1:n>e?1:0}function Ah(n){let e=0;for(let i,l,u=0,f=n.length,p=f-1;u<f;p=u++)i=n[u],l=n[p],e+=(l.x-i.x)*(i.y+l.y);return e}function Oc(n,e){n[0]=Math.min(n[0],e[0]),n[1]=Math.min(n[1],e[1]),n[2]=Math.max(n[2],e[0]),n[3]=Math.max(n[3],e[1])}function Oo(n,e){return!(n[0]<=e[0]||n[2]>=e[2]||n[1]<=e[1]||n[3]>=e[3])}function Gv(n,e,i){const l=n[0]-e[0],u=n[1]-e[1],f=n[0]-i[0],p=n[1]-i[1];return l*p-f*u==0&&l*f<=0&&u*p<=0}function Dc(n,e,i=!1){let l=!1;for(let y=0,w=e.length;y<w;y++){const E=e[y];for(let A=0,P=E.length,M=P-1;A<P;M=A++){const O=E[M],D=E[A];if(Gv(n,O,D))return i;(f=O)[1]>(u=n)[1]!=(p=D)[1]>u[1]&&u[0]<(p[0]-f[0])*(u[1]-f[1])/(p[1]-f[1])+f[0]&&(l=!l)}}var u,f,p;return l}function r0(n,e,i,l){const u=l[0]-i[0],f=l[1]-i[1],p=(n[0]-i[0])*f-u*(n[1]-i[1]),y=(e[0]-i[0])*f-u*(e[1]-i[1]);return p>0&&y<0||p<0&&y>0}function Ph(n,e,i,l){return(u=[l[0]-i[0],l[1]-i[1]])[0]*(f=[e[0]-n[0],e[1]-n[1]])[1]-u[1]*f[0]!=0&&!(!r0(n,e,i,l)||!r0(i,l,n,e));var u,f}function kh(n){const e=new ft(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new ft(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const l of n[0])e.x>l.x&&(e.x=l.x),e.y>l.y&&(e.y=l.y),i.x<l.x&&(i.x=l.x),i.y<l.y&&(i.y=l.y);return{min:e,max:i}}const rl=8192;function Ul(n,e){const i=(180+n[0])/360,l=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,u=Math.pow(2,e.z);return[Math.round(i*u*rl),Math.round(l*u*rl)]}function qv(n,e){for(let i=0;i<e.length;i++)if(Dc(n,e[i]))return!0;return!1}function Hv(n,e,i){for(const l of i)for(let u=0,f=l.length,p=f-1;u<f;p=u++)if(Ph(n,e,l[p],l[u]))return!0;return!1}function Mh(n,e){for(let i=0;i<n.length;++i)if(!Dc(n[i],e))return!1;for(let i=0;i<n.length-1;++i)if(Hv(n[i],n[i+1],e))return!1;return!0}function i0(n,e){for(let i=0;i<e.length;i++)if(Mh(n,e[i]))return!0;return!1}function Nh(n,e,i){const l=[];for(let u=0;u<n.length;u++){const f=[];for(let p=0;p<n[u].length;p++){const y=Ul(n[u][p],i);Oc(e,y),f.push(y)}l.push(f)}return l}function mo(n,e,i){const l=[];for(let u=0;u<n.length;u++){const f=Nh(n[u],e,i);l.push(f)}return l}function n0(n,e,i,l){if(n[0]<i[0]||n[0]>i[2]){const u=.5*l;let f=n[0]-i[0]>u?-l:i[0]-n[0]>u?l:0;f===0&&(f=n[0]-i[2]>u?-l:i[2]-n[0]>u?l:0),n[0]+=f}Oc(e,n)}function s0(n,e,i,l){const u=Math.pow(2,l.z)*rl,f=[l.x*rl,l.y*rl],p=[];if(!n)return p;for(const y of n)for(const w of y){const E=[w.x+f[0],w.y+f[1]];n0(E,e,i,u),p.push(E)}return p}function o0(n,e,i,l){const u=Math.pow(2,l.z)*rl,f=[l.x*rl,l.y*rl],p=[];if(!n)return p;for(const w of n){const E=[];for(const A of w){const P=[A.x+f[0],A.y+f[1]];Oc(e,P),E.push(P)}p.push(E)}if(e[2]-e[0]<=u/2){(y=e)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(const w of p)for(const E of w)n0(E,e,i,u)}var y;return p}class Vl{constructor(e,i){this.type=ai,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Rc(e[1])){const l=e[1];if(l.type==="FeatureCollection")for(let u=0;u<l.features.length;++u){const f=l.features[u].geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new Vl(l,l.features[u].geometry)}else if(l.type==="Feature"){const u=l.geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new Vl(l,l.geometry)}else if(l.type==="Polygon"||l.type==="MultiPolygon")return new Vl(l,l)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,l){const u=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=i.canonicalID();if(!p)return!1;if(l.type==="Polygon"){const y=Nh(l.coordinates,f,p),w=s0(i.geometry(),u,f,p);if(!Oo(u,f))return!1;for(const E of w)if(!Dc(E,y))return!1}if(l.type==="MultiPolygon"){const y=mo(l.coordinates,f,p),w=s0(i.geometry(),u,f,p);if(!Oo(u,f))return!1;for(const E of w)if(!qv(E,y))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,l){const u=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],p=i.canonicalID();if(!p)return!1;if(l.type==="Polygon"){const y=Nh(l.coordinates,f,p),w=o0(i.geometry(),u,f,p);if(!Oo(u,f))return!1;for(const E of w)if(!Mh(E,y))return!1}if(l.type==="MultiPolygon"){const y=mo(l.coordinates,f,p),w=o0(i.geometry(),u,f,p);if(!Oo(u,f))return!1;for(const E of w)if(!i0(E,y))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const ud={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},em=1/298.257223563,tm=em*(2-em),jc=Math.PI/180;class zc{static fromTile(e,i,l){const u=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),f=Math.atan(.5*(Math.exp(u)-Math.exp(-u)))/jc;return new zc(f,l)}static get units(){return ud}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!ud[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(ud).join(", ")}`);const l=6378.137*jc*(i?ud[i]:1),u=Math.cos(e*jc),f=1/(1-tm*(1-u*u)),p=Math.sqrt(f);this.kx=l*p*u,this.ky=l*p*f*(1-tm)}distance(e,i){const l=Ks(e[0]-i[0])*this.kx,u=(e[1]-i[1])*this.ky;return Math.sqrt(l*l+u*u)}bearing(e,i){const l=Ks(i[0]-e[0])*this.kx;return Math.atan2(l,(i[1]-e[1])*this.ky)/jc}destination(e,i,l){const u=l*jc;return this.offset(e,Math.sin(u)*i,Math.cos(u)*i)}offset(e,i,l){return[e[0]+i/this.kx,e[1]+l/this.ky]}lineDistance(e){let i=0;for(let l=0;l<e.length-1;l++)i+=this.distance(e[l],e[l+1]);return i}area(e){let i=0;for(let l=0;l<e.length;l++){const u=e[l];for(let f=0,p=u.length,y=p-1;f<p;y=f++)i+=Ks(u[f][0]-u[y][0])*(u[f][1]+u[y][1])*(l?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let l=0;if(i<=0)return e[0];for(let u=0;u<e.length-1;u++){const f=e[u],p=e[u+1],y=this.distance(f,p);if(l+=y,l>i)return Rh(f,p,(i-(l-y))/y)}return e[e.length-1]}pointToSegmentDistance(e,i,l){let[u,f]=i,p=Ks(l[0]-u)*this.kx,y=(l[1]-f)*this.ky;if(p!==0||y!==0){const w=(Ks(e[0]-u)*this.kx*p+(e[1]-f)*this.ky*y)/(p*p+y*y);w>1?(u=l[0],f=l[1]):w>0&&(u+=p/this.kx*w,f+=y/this.ky*w)}return p=Ks(e[0]-u)*this.kx,y=(e[1]-f)*this.ky,Math.sqrt(p*p+y*y)}pointOnLine(e,i){let l=1/0,u=e[0][0],f=e[0][1],p=0,y=0;for(let w=0;w<e.length-1;w++){let E=e[w][0],A=e[w][1],P=Ks(e[w+1][0]-E)*this.kx,M=(e[w+1][1]-A)*this.ky,O=0;P===0&&M===0||(O=(Ks(i[0]-E)*this.kx*P+(i[1]-A)*this.ky*M)/(P*P+M*M),O>1?(E=e[w+1][0],A=e[w+1][1]):O>0&&(E+=P/this.kx*O,A+=M/this.ky*O)),P=Ks(i[0]-E)*this.kx,M=(i[1]-A)*this.ky;const D=P*P+M*M;D<l&&(l=D,u=E,f=A,p=w,y=O)}return{point:[u,f],index:p,t:Math.max(0,Math.min(1,y))}}lineSlice(e,i,l){let u=this.pointOnLine(l,e),f=this.pointOnLine(l,i);if(u.index>f.index||u.index===f.index&&u.t>f.t){const E=u;u=f,f=E}const p=[u.point],y=u.index+1,w=f.index;!rm(l[y],p[0])&&y<=w&&p.push(l[y]);for(let E=y+1;E<=w;E++)p.push(l[E]);return rm(l[w],f.point)||p.push(f.point),p}lineSliceAlong(e,i,l){let u=0;const f=[];for(let p=0;p<l.length-1;p++){const y=l[p],w=l[p+1],E=this.distance(y,w);if(u+=E,u>e&&f.length===0&&f.push(Rh(y,w,(e-(u-E))/E)),u>=i)return f.push(Rh(y,w,(i-(u-E))/E)),f;u>e&&f.push(w)}return f}bufferPoint(e,i){const l=i/this.ky,u=i/this.kx;return[e[0]-u,e[1]-l,e[0]+u,e[1]+l]}bufferBBox(e,i){const l=i/this.ky,u=i/this.kx;return[e[0]-u,e[1]-l,e[2]+u,e[3]+l]}insideBBox(e,i){return Ks(e[0]-i[0])>=0&&Ks(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function rm(n,e){return n[0]===e[0]&&n[1]===e[1]}function Rh(n,e,i){const l=Ks(e[0]-n[0]);return[n[0]+l*i,n[1]+(e[1]-n[1])*i]}function Ks(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class Lh{constructor(e=[],i=(l,u)=>l<u?-1:l>u?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let l=(this.length>>1)-1;l>=0;l--)this._down(l)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:l}=this,u=i[e];for(;e>0;){const f=e-1>>1,p=i[f];if(l(u,p)>=0)break;i[e]=p,e=f}i[e]=u}_down(e){const{data:i,compare:l}=this,u=this.length>>1,f=i[e];for(;e<u;){let p=1+(e<<1);const y=p+1;if(y<this.length&&l(i[y],i[p])<0&&(p=y),l(i[p],f)>=0)break;i[e]=i[p],e=p}i[e]=f}}var vt=8192;function im(n,e){return e.dist-n.dist}const Fc=100,Bc=50;function dd(n){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==n[i])return!1;return!0}function hd(n){return n[1]-n[0]+1}function ta(n,e){const i=n[1]>=n[0]&&n[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Oh(n,e){if(n[0]>n[1])return[null,null];const i=hd(n);if(e){if(i===2)return[n,null];const l=Math.floor(i/2);return[[n[0],n[0]+l],[n[0]+l,n[1]]]}{if(i===1)return[n,null];const l=Math.floor(i/2)-1;return[[n[0],n[0]+l],[n[0]+l+1,n[1]]]}}function go(n,e){const i=[1/0,1/0,-1/0,-1/0];if(!ta(e,n.length))return i;for(let l=e[0];l<=e[1];++l)Oc(i,n[l]);return i}function Or(n){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<n.length;++i)for(let l=0;l<n[i].length;++l)Oc(e,n[i][l]);return e}function Uc(n,e,i){if(dd(n)||dd(e))return NaN;let l=0,u=0;return n[2]<e[0]&&(l=e[0]-n[2]),n[0]>e[2]&&(l=n[0]-e[2]),n[1]>e[3]&&(u=n[1]-e[3]),n[3]<e[1]&&(u=e[1]-n[3]),i.distance([0,0],[l,u])}function Wv(n){return 360*n-180}function Zv(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Dh(n,e){const i=Math.pow(2,e.z),l=(n.y/vt+e.y)/i;return[Wv((n.x/vt+e.x)/i),Zv(l)]}function Xv(n,e){const i=[];for(let l=0;l<n.length;++l)i.push(Dh(n[l],e));return i}function zi(n,e,i){const l=i.pointOnLine(e,n).point;return i.distance(n,l)}function a0(n,e,i,l,u){const f=i.slice(l[0],l[1]+1);let p=1/0;for(let y=e[0];y<=e[1];++y)if((p=Math.min(p,zi(n[y],f,u)))===0)return 0;return p}function nm(n,e,i,l,u){const f=Math.min(u.pointToSegmentDistance(n,i,l),u.pointToSegmentDistance(e,i,l)),p=Math.min(u.pointToSegmentDistance(i,n,e),u.pointToSegmentDistance(l,n,e));return Math.min(f,p)}function Yv(n,e,i,l,u){if(!ta(e,n.length)||!ta(l,i.length))return NaN;let f=1/0;for(let p=e[0];p<e[1];++p)for(let y=l[0];y<l[1];++y){if(Ph(n[p],n[p+1],i[y],i[y+1]))return 0;f=Math.min(f,nm(n[p],n[p+1],i[y],i[y+1],u))}return f}function Kv(n,e,i,l,u){if(!ta(e,n.length)||!ta(l,i.length))return NaN;let f=1/0;for(let p=e[0];p<=e[1];++p)for(let y=l[0];y<=l[1];++y)if((f=Math.min(f,u.distance(n[p],i[y])))===0)return f;return f}function Jv(n,e,i){if(Dc(n,e,!0))return 0;let l=1/0;for(const u of e){const f=u.length;if(f<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(u[0]!==u[f-1]&&(l=Math.min(l,i.pointToSegmentDistance(n,u[f-1],u[0])))===0||(l=Math.min(l,zi(n,u,i)))===0)return l}return l}function Qv(n,e,i,l){if(!ta(e,n.length))return NaN;for(let f=e[0];f<=e[1];++f)if(Dc(n[f],i,!0))return 0;let u=1/0;for(let f=e[0];f<e[1];++f)for(const p of i)for(let y=0,w=p.length,E=w-1;y<w;E=y++){if(Ph(n[f],n[f+1],p[E],p[y]))return 0;u=Math.min(u,nm(n[f],n[f+1],p[E],p[y],l))}return u}function l0(n,e){for(const i of n)for(let l=0;l<=i.length-1;++l)if(Dc(i[l],e,!0))return!0;return!1}function eb(n,e,i,l=1/0){const u=Or(n),f=Or(e);if(l!==1/0&&Uc(u,f,i)>=l)return l;if(Oo(u,f)){if(l0(n,e))return 0}else if(l0(e,n))return 0;let p=l;for(const y of n)for(let w=0,E=y.length,A=E-1;w<E;A=w++)for(const P of e)for(let M=0,O=P.length,D=O-1;M<O;D=M++){if(Ph(y[A],y[w],P[D],P[M]))return 0;p=Math.min(p,nm(y[A],y[w],P[D],P[M],i))}return p}function jh(n,e,i,l,u,f,p){if(f===null||p===null)return;const y=Uc(go(l,f),go(u,p),i);y<e&&n.push({dist:y,range1:f,range2:p})}function tb(n,e,i,l,u=1/0){let f=Math.min(l.distance(n[0],i[0][0]),u);if(f===0)return f;const p=new Lh([{dist:0,range1:[0,n.length-1],range2:[0,0]}],im),y=e?Bc:Fc,w=Or(i);for(;p.length;){const E=p.pop();if(E.dist>=f)continue;const A=E.range1;if(hd(A)<=y){if(!ta(A,n.length))return NaN;if(e){const P=Qv(n,A,i,l);if((f=Math.min(f,P))===0)return f}else for(let P=A[0];P<=A[1];++P){const M=Jv(n[P],i,l);if((f=Math.min(f,M))===0)return f}}else{const P=Oh(A,e);if(P[0]!==null){const M=Uc(go(n,P[0]),w,l);M<f&&p.push({dist:M,range1:P[0],range2:[0,0]})}if(P[1]!==null){const M=Uc(go(n,P[1]),w,l);M<f&&p.push({dist:M,range1:P[1],range2:[0,0]})}}}return f}function c0(n,e,i,l,u,f=1/0){let p=Math.min(f,u.distance(n[0],i[0]));if(p===0)return p;const y=new Lh([{dist:0,range1:[0,n.length-1],range2:[0,i.length-1]}],im),w=e?Bc:Fc,E=l?Bc:Fc;for(;y.length;){const A=y.pop();if(A.dist>=p)continue;const P=A.range1,M=A.range2;if(hd(P)<=w&&hd(M)<=E){if(!ta(P,n.length)||!ta(M,i.length))return NaN;if(e&&l?p=Math.min(p,Yv(n,P,i,M,u)):e||l?e&&!l?p=Math.min(p,a0(i,M,n,P,u)):!e&&l&&(p=Math.min(p,a0(n,P,i,M,u))):p=Math.min(p,Kv(n,P,i,M,u)),p===0)return p}else{const O=Oh(P,e),D=Oh(M,l);jh(y,p,u,n,i,O[0],D[0]),jh(y,p,u,n,i,O[0],D[1]),jh(y,p,u,n,i,O[1],D[0]),jh(y,p,u,n,i,O[1],D[1])}}return p}function sm(n,e,i,l,u=1/0){let f=u;const p=go(n,[0,n.length-1]);for(const y of i)if(!(f!==1/0&&Uc(p,go(y,[0,y.length-1]),l)>=f)&&(f=Math.min(f,c0(n,e,y,!0,l,f)),f===0))return f;return f}function zh(n,e,i,l,u=1/0){let f=u;const p=go(n,[0,n.length-1]);for(const y of i){if(f!==1/0&&Uc(p,Or(y),l)>=f)continue;const w=tb(n,e,y,l,f);if(isNaN(w))return w;if((f=Math.min(f,w))===0)return f}return f}function om(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class $l{constructor(e,i){this.type=Vt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(Rc(e[1])){const l=e[1];if(l.type==="FeatureCollection"){for(let u=0;u<l.features.length;++u)if(om(l.features[u].geometry.type))return new $l(l,l.features[u].geometry)}else if(l.type==="Feature"){if(om(l.geometry.type))return new $l(l,l.geometry)}else if(om(l.type))return new $l(l,l)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),l=e.canonicalID();if(i!=null&&l!=null){if(e.geometryType()==="Point")return function(u,f,p){const y=[];for(const E of u)for(const A of E)y.push(Dh(A,f));const w=new zc(y[0][1],"meters");return p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString"?c0(y,!1,p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",w):p.type==="MultiLineString"?sm(y,!1,p.coordinates,w):p.type==="Polygon"||p.type==="MultiPolygon"?zh(y,!1,p.type==="Polygon"?[p.coordinates]:p.coordinates,w):null}(i,l,this.geometries);if(e.geometryType()==="LineString")return function(u,f,p){const y=[];for(const E of u){const A=[];for(const P of E)A.push(Dh(P,f));y.push(A)}const w=new zc(y[0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return sm(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,w);if(p.type==="MultiLineString"){let E=1/0;for(let A=0;A<p.coordinates.length;A++){const P=sm(p.coordinates[A],!0,y,w,E);if(isNaN(P))return P;if((E=Math.min(E,P))===0)return E}return E}if(p.type==="Polygon"||p.type==="MultiPolygon"){let E=1/0;for(let A=0;A<y.length;A++){const P=zh(y[A],!0,p.type==="Polygon"?[p.coordinates]:p.coordinates,w,E);if(isNaN(P))return P;if((E=Math.min(E,P))===0)return E}return E}return null}(i,l,this.geometries);if(e.geometryType()==="Polygon")return function(u,f,p){const y=[];for(const E of function(A,P){const M=A.length;if(M<=1)return[A];const O=[];let D,V;for(let G=0;G<M;G++){const q=Ah(A[G]);q!==0&&(A[G].area=Math.abs(q),V===void 0&&(V=q<0),V===q<0?(D&&O.push(D),D=[A[G]]):D.push(A[G]))}return D&&O.push(D),O}(u)){const A=[];for(let P=0;P<E.length;++P)A.push(Xv(E[P],f));y.push(A)}const w=new zc(y[0][0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return zh(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,w);if(p.type==="MultiLineString"){let E=1/0;for(let A=0;A<p.coordinates.length;A++){const P=zh(p.coordinates[A],!0,y,w,E);if(isNaN(P))return P;if((E=Math.min(E,P))===0)return E}return E}return p.type==="Polygon"||p.type==="MultiPolygon"?function(E,A,P){let M=1/0;for(const O of E)for(const D of A){const V=eb(O,D,P,M);if(isNaN(V))return V;if((M=Math.min(M,V))===0)return M}return M}(p.type==="Polygon"?[p.coordinates]:p.coordinates,y,w):null}(i,l,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Vc(n){if(n instanceof ps&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof Vl||n instanceof $l)return!1;if(n instanceof Gc)return n.featureConstant;let e=!0;return n.eachChild(i=>{e&&!Vc(i)&&(e=!1)}),e}function Fh(n){if(n instanceof ps&&n.name==="feature-state")return!1;let e=!0;return n.eachChild(i=>{e&&!Fh(i)&&(e=!1)}),e}function Bh(n){if(n instanceof Gc)return new Set([n.key]);let e=new Set;return n.eachChild(i=>{e=new Set([...e,...Bh(i)])}),e}function $c(n,e){if(n instanceof ps&&e.indexOf(n.name)>=0)return!1;let i=!0;return n.eachChild(l=>{i&&!$c(l,e)&&(i=!1)}),i}function u0(n,e,i){return[n,e,i].filter(Boolean).join("")}function am(n,e){switch(n){case"string":return Cs(e);case"number":return+e;case"boolean":return!!e;case"color":return ti.parse(e);case"formatted":return fs.fromString(Cs(e));case"resolvedImage":return Is.build(Cs(e))}return e}function d0(n,e,i,l){return l!==void 0&&(n=l*Math.round(n/l)),e!==void 0&&n<e&&(n=e),i!==void 0&&n>i&&(n=i),n}class Gc{constructor(e,i,l,u=!1){this.type=e,this.key=i,this.scope=l,this.featureConstant=u}static parse(e,i){let l=i.expectedType;if(l==null&&(l=Kr),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const u=i.parse(e[1],1);if(!(u instanceof vr))return i.error("Key name of 'config' expression must be a string literal.");let f,p=!0;const y=Cs(u.value);if(e.length>=3){const w=i.parse(e[2],2);if(!(w instanceof vr))return i.error("Scope of 'config' expression must be a string literal.");f=Cs(w.value)}if(i.options){const w=u0(y,f,i._scope),E=i.options.get(w);E&&(p=Vc(E.value||E.default))}return new Gc(l,y,f,p)}evaluate(e){const i=u0(this.key,this.scope,e.scope),l=e.getConfig(i);if(!l)return null;const{type:u,value:f,values:p,minValue:y,maxValue:w,stepValue:E}=l,A=l.default.evaluate(e);let P=A;if(f){const M=e.scope;e.scope=(M||"").split("").slice(1).join(""),P=f.evaluate(e),e.scope=M}return u&&(P=am(u,P)),P===void 0||y===void 0&&w===void 0&&E===void 0||(typeof P=="number"?P=d0(P,y,w,E):Array.isArray(P)&&(P=P.map(M=>typeof M=="number"?d0(M,y,w,E):M))),f!==void 0&&P!==void 0&&p&&!p.includes(P)&&(P=A,u&&(P=am(u,P))),(u&&u!==this.type||P!==void 0&&!sd(Cn(P),this.type))&&(P=am(this.type.kind,P)),P}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Uh{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const l=e[1];return i.scope.has(l)?new Uh(l,i.scope.get(l)):i.error(`Unknown variable "${l}". Make sure "${l}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Vh{constructor(e,i=[],l,u=new Th,f=[],p,y,w){this.registry=e,this.path=i,this.key=i.map(E=>typeof E=="string"?`['${E}']`:`[${E}]`).join(""),this.scope=u,this.errors=f,this.expectedType=l,this._scope=p,this.options=y,this.iconImageUseTheme=w}parse(e,i,l,u,f={}){return i||l?this.concat(i,null,l,u)._parse(e,f):this._parse(e,f)}parseObjectValue(e,i,l,u,f,p={}){return this.concat(i,l,u,f)._parse(e,p)}_parse(e,i){function l(u,f,p){return p==="assert"?new Jt(f,[u]):p==="coerce"?new nn(f,[u]):u}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const u=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(u){let f=u.parse(e,this);if(!f)return null;if(this.expectedType){const p=this.expectedType,y=f.type;if(p.kind!=="string"&&p.kind!=="number"&&p.kind!=="boolean"&&p.kind!=="object"&&p.kind!=="array"||y.kind!=="value")if(p.kind!=="color"&&p.kind!=="formatted"&&p.kind!=="resolvedImage"||y.kind!=="value"&&y.kind!=="string"){if(this.checkSubtype(p,y))return null}else f=l(f,p,i.typeAnnotation||"coerce");else f=l(f,p,i.typeAnnotation||"assert")}if(!(f instanceof vr)&&f.type.kind!=="resolvedImage"&&lm(f)){const p=new Sa(this._scope,this.options,this.iconImageUseTheme);try{f=new vr(f.type,f.evaluate(p))}catch(y){return this.error(y.message),null}}return f}return nn.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,l,u){let f=typeof e=="number"?this.path.concat(e):this.path;f=typeof i=="string"?f.concat(i):f;const p=u?this.scope.concat(u):this.scope;return new Vh(this.registry,f,l||null,p,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...i){const l=`${this.key}${i.map(u=>`[${u}]`).join("")}`;this.errors.push(new Ro(l,e))}checkSubtype(e,i){const l=id(e,i);return l&&this.error(l),l}}function lm(n){if(n instanceof Uh)return lm(n.boundExpression);if(n instanceof ps&&n.name==="error"||n instanceof qn||n instanceof Vl||n instanceof $l||n instanceof Gc)return!1;const e=n instanceof nn||n instanceof Jt;let i=!0;return n.eachChild(l=>{i=e?i&&lm(l):i&&l instanceof vr}),!!i&&Vc(n)&&$c(n,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function $h(n,e){const i=n.length-1;let l,u,f=0,p=i,y=0;for(;f<=p;)if(y=Math.floor((f+p)/2),l=n[y],u=n[y+1],l<=e){if(y===i||e<u)return y;f=y+1}else{if(!(l>e))throw new At("Input is not a number.");p=y-1}return 0}class fd{constructor(e,i,l){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[u,f]of l)this.labels.push(u),this.outputs.push(f)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const l=i.parse(e[1],1,Vt);if(!l)return null;const u=[];let f=null;i.expectedType&&i.expectedType.kind!=="value"&&(f=i.expectedType);for(let p=1;p<e.length;p+=2){const y=p===1?-1/0:e[p],w=e[p+1],E=p,A=p+1;if(typeof y!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',E);if(u.length&&u[u.length-1][0]>=y)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',E);const P=i.parse(w,A,f);if(!P)return null;f=f||P.type,u.push([y,P])}return new fd(f,l,u)}evaluate(e){const i=this.labels,l=this.outputs;if(i.length===1)return l[0].evaluate(e);const u=this.input.evaluate(e);if(u<=i[0])return l[0].evaluate(e);const f=i.length;return u>=i[f-1]?l[f-1].evaluate(e):l[$h(i,u)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const h0=.95047,f0=1.08883,p0=4/29,il=6/29,m0=3*il*il,g0=il*il*il,rb=Math.PI/180,ib=180/Math.PI;function cm(n){return n>g0?Math.pow(n,1/3):n/m0+p0}function Gh(n){return n>il?n*n*n:m0*(n-p0)}function qh(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function nl(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function um(n){const e=nl(n.r),i=nl(n.g),l=nl(n.b),u=cm((.4124564*e+.3575761*i+.1804375*l)/h0),f=cm((.2126729*e+.7151522*i+.072175*l)/1);return{l:116*f-16,a:500*(u-f),b:200*(f-cm((.0193339*e+.119192*i+.9503041*l)/f0)),alpha:n.a}}function dm(n){let e=(n.l+16)/116,i=isNaN(n.a)?e:e+n.a/500,l=isNaN(n.b)?e:e-n.b/200;return e=1*Gh(e),i=h0*Gh(i),l=f0*Gh(l),new ti(qh(3.2404542*i-1.5371385*e-.4985314*l),qh(-.969266*i+1.8760108*e+.041556*l),qh(.0556434*i-.2040259*e+1.0572252*l),n.alpha)}function nb(n,e,i){const l=e-n;return n+i*(l>180||l<-180?l-360*Math.round(l/360):l)}const Gl={forward:um,reverse:dm,interpolate:function(n,e,i){return{l:Yt(n.l,e.l,i),a:Yt(n.a,e.a,i),b:Yt(n.b,e.b,i),alpha:Yt(n.alpha,e.alpha,i)}}},ql={forward:function(n){const{l:e,a:i,b:l}=um(n),u=Math.atan2(l,i)*ib;return{h:u<0?u+360:u,c:Math.sqrt(i*i+l*l),l:e,alpha:n.a}},reverse:function(n){const e=n.h*rb,i=n.c;return dm({l:n.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:n.alpha})},interpolate:function(n,e,i){return{h:nb(n.h,e.h,i),c:Yt(n.c,e.c,i),l:Yt(n.l,e.l,i),alpha:Yt(n.alpha,e.alpha,i)}}};var _0=Object.freeze({__proto__:null,hcl:ql,lab:Gl});class Js{constructor(e,i,l,u,f){this.type=e,this.operator=i,this.interpolation=l,this.input=u,this.labels=[],this.outputs=[];for(const[p,y]of f)this.labels.push(p),this.outputs.push(y)}static interpolationFactor(e,i,l,u){let f=0;if(e.name==="exponential")f=Hh(i,e.base,l,u);else if(e.name==="linear")f=Hh(i,1,l,u);else if(e.name==="cubic-bezier"){const p=e.controlPoints;f=new fh(p[0],p[1],p[2],p[3]).solve(Hh(i,1,l,u))}return f}static parse(e,i){let[l,u,f,...p]=e;if(!Array.isArray(u)||u.length===0)return i.error("Expected an interpolation type expression.",1);if(u[0]==="linear")u={name:"linear"};else if(u[0]==="exponential"){const E=u[1];if(typeof E!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);u={name:"exponential",base:E}}else{if(u[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(u[0])}`,1,0);{const E=u.slice(1);if(E.length!==4||E.some(A=>typeof A!="number"||A<0||A>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);u={name:"cubic-bezier",controlPoints:E}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(f=i.parse(f,2,Vt),!f)return null;const y=[];let w=null;l==="interpolate-hcl"||l==="interpolate-lab"?w=Ns:i.expectedType&&i.expectedType.kind!=="value"&&(w=i.expectedType);for(let E=0;E<p.length;E+=2){const A=p[E],P=p[E+1],M=E+3,O=E+4;if(typeof A!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',M);if(y.length&&y[y.length-1][0]>=A)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',M);const D=i.parse(P,O,w);if(!D)return null;w=w||D.type,y.push([A,D])}return w.kind==="number"||w.kind==="color"||w.kind==="array"&&w.itemType.kind==="number"&&typeof w.N=="number"?new Js(w,l,u,f,y):i.error(`Type ${fn(w)} is not interpolatable.`)}evaluate(e){const i=this.labels,l=this.outputs;if(i.length===1)return l[0].evaluate(e);const u=this.input.evaluate(e);if(u<=i[0])return l[0].evaluate(e);const f=i.length;if(u>=i[f-1])return l[f-1].evaluate(e);const p=$h(i,u),y=Js.interpolationFactor(this.interpolation,u,i[p],i[p+1]),w=l[p].evaluate(e),E=l[p+1].evaluate(e);return this.operator==="interpolate"?Ys[this.type.kind.toLowerCase()](w,E,y):this.operator==="interpolate-hcl"?ql.reverse(ql.interpolate(ql.forward(w),ql.forward(E),y)):Gl.reverse(Gl.interpolate(Gl.forward(w),Gl.forward(E),y))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let l=0;l<this.labels.length;l++)i.push(this.labels[l],this.outputs[l].serialize());return i}}function Hh(n,e,i,l){const u=l-i,f=n-i;return u===0?0:e===1?f/u:(Math.pow(e,f)-1)/(Math.pow(e,u)-1)}class pd{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let l=null;const u=i.expectedType;u&&u.kind!=="value"&&(l=u);const f=[];for(const y of e.slice(1)){const w=i.parse(y,1+f.length,l,void 0,{typeAnnotation:"omit"});if(!w)return null;l=l||w.type,f.push(w)}const p=u&&f.some(y=>id(u,y.type));return new pd(p?Kr:l,f)}evaluate(e){let i,l=null,u=0;for(const f of this.args){if(u++,l=f.evaluate(e),l&&l instanceof Is&&!l.available&&(i||(i=l),l=null,u===this.args.length))return i;if(l!==null)break}return l}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Wh{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const l=[];for(let f=1;f<e.length-1;f+=2){const p=e[f];if(typeof p!="string")return i.error(`Expected string, but found ${typeof p} instead.`,f);if(/[^a-zA-Z0-9_]/.test(p))return i.error("Variable names must contain only alphanumeric characters or '_'.",f);const y=i.parse(e[f+1],f+1);if(!y)return null;l.push([p,y])}const u=i.parse(e[e.length-1],e.length-1,i.expectedType,l);return u?new Wh(l,u):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,l]of this.bindings)e.push(i,l.serialize());return e.push(this.result.serialize()),e}}class hm{constructor(e,i,l){this.type=e,this.index=i,this.input=l}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Vt),u=i.parse(e[2],2,ns(i.expectedType||Kr));return l&&u?new hm(u.type.itemType,l,u):null}evaluate(e){const i=this.index.evaluate(e),l=this.input.evaluate(e);if(i<0)throw new At("Array index out of bounds: negative index");if(i>=l.length)throw new At("Array index out of bounds: index exceeds array size");if(i!==Math.floor(i))throw new At("Array index must be an integer. Use at-interpolated for fractional indices");return l[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class fm{constructor(e,i,l){this.type=e,this.index=i,this.input=l}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Vt),u=i.parse(e[2],2,ns(i.expectedType||Kr));return l&&u?new fm(u.type.itemType,l,u):null}evaluate(e){const i=this.index.evaluate(e),l=this.input.evaluate(e);if(i<0)throw new At(`Array index out of bounds: ${i} < 0.`);if(i>l.length-1)throw new At(`Array index out of bounds: ${i} > ${l.length-1}.`);if(i===Math.floor(i))return l[i];const u=Math.floor(i),f=Math.ceil(i),p=l[u],y=l[f];if(typeof p!="number"||typeof y!="number")throw new At(`Cannot interpolate between non-number values at index ${i}.`);const w=i-u;return p*(1-w)+y*w}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Zh{constructor(e,i){this.type=ai,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Kr),u=i.parse(e[2],2,Kr);return l&&u?Yp(l.type,[ai,ri,Vt,ea,Kr])?new Zh(l,u):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${fn(l.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),l=this.haystack.evaluate(e);if(l==null)return!1;if(!nd(i,["boolean","string","number","null"]))throw new At(`Expected first argument to be of type boolean, string, number or null, but found ${fn(Cn(i))} instead.`);if(!nd(l,["string","array"]))throw new At(`Expected second argument to be of type array or string, but found ${fn(Cn(l))} instead.`);return l.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class md{constructor(e,i,l){this.type=Vt,this.needle=e,this.haystack=i,this.fromIndex=l}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Kr),u=i.parse(e[2],2,Kr);if(!l||!u)return null;if(!Yp(l.type,[ai,ri,Vt,ea,Kr]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${fn(l.type)} instead`);if(e.length===4){const f=i.parse(e[3],3,Vt);return f?new md(l,u,f):null}return new md(l,u)}evaluate(e){const i=this.needle.evaluate(e),l=this.haystack.evaluate(e);if(!nd(i,["boolean","string","number","null"]))throw new At(`Expected first argument to be of type boolean, string, number or null, but found ${fn(Cn(i))} instead.`);if(!nd(l,["string","array"]))throw new At(`Expected second argument to be of type array or string, but found ${fn(Cn(l))} instead.`);if(this.fromIndex){const u=this.fromIndex.evaluate(e);return l.indexOf(i,u)}return l.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class qc{constructor(e,i,l,u,f,p){this.inputType=e,this.type=i,this.input=l,this.cases=u,this.outputs=f,this.otherwise=p}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let l,u;i.expectedType&&i.expectedType.kind!=="value"&&(u=i.expectedType);const f={},p=[];for(let E=2;E<e.length-1;E+=2){let A=e[E];const P=e[E+1];Array.isArray(A)||(A=[A]);const M=i.concat(E);if(A.length===0)return M.error("Expected at least one branch label.");for(const D of A){if(typeof D!="number"&&typeof D!="string")return M.error("Branch labels must be numbers or strings.");if(typeof D=="number"&&Math.abs(D)>Number.MAX_SAFE_INTEGER)return M.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof D=="number"&&Math.floor(D)!==D)return M.error("Numeric branch labels must be integer values.");if(l){if(M.checkSubtype(l,Cn(D)))return null}else l=Cn(D);if(f[String(D)]!==void 0)return M.error("Branch labels must be unique.");f[String(D)]=p.length}const O=i.parse(P,E,u);if(!O)return null;u=u||O.type,p.push(O)}const y=i.parse(e[1],1,Kr);if(!y)return null;const w=i.parse(e[e.length-1],e.length-1,u);return w?y.type.kind!=="value"&&i.concat(1).checkSubtype(l,y.type)?null:new qc(l,u,y,f,p,w):null}evaluate(e){const i=this.input.evaluate(e);return(sd(Cn(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),l=[],u={};for(const p of i){const y=u[this.cases[p]];y===void 0?(u[this.cases[p]]=l.length,l.push([this.cases[p],[p]])):l[y][1].push(p)}const f=p=>this.inputType.kind==="number"?Number(p):p;for(const[p,y]of l)e.push(y.length===1?f(y[0]):y.map(f)),e.push(this.outputs[p].serialize());return e.push(this.otherwise.serialize()),e}}class pm{constructor(e,i,l){this.type=e,this.branches=i,this.otherwise=l}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let l;i.expectedType&&i.expectedType.kind!=="value"&&(l=i.expectedType);const u=[];for(let p=1;p<e.length-1;p+=2){const y=i.parse(e[p],p,ai);if(!y)return null;const w=i.parse(e[p+1],p+1,l);if(!w)return null;u.push([y,w]),l=l||w.type}const f=i.parse(e[e.length-1],e.length-1,l);return f?new pm(l,u,f):null}evaluate(e){for(const[i,l]of this.branches)if(i.evaluate(e))return l.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,l]of this.branches)e(i),e(l);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class gd{constructor(e,i,l,u){this.type=e,this.input=i,this.beginIndex=l,this.endIndex=u}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,Kr),u=i.parse(e[2],2,Vt);if(!l||!u)return null;if(!Yp(l.type,[ns(Kr),ri,Kr]))return i.error(`Expected first argument to be of type array or string, but found ${fn(l.type)} instead`);if(e.length===4){const f=i.parse(e[3],3,Vt);return f?new gd(l.type,l,u,f):null}return new gd(l.type,l,u)}evaluate(e){const i=this.input.evaluate(e),l=this.beginIndex.evaluate(e);if(!nd(i,["string","array"]))throw new At(`Expected first argument to be of type array or string, but found ${fn(Cn(i))} instead.`);if(this.endIndex){const u=this.endIndex.evaluate(e);return i.slice(l,u)}return i.slice(l)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class mm{constructor(e,i){this.type=ns(ri),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const l=i.parse(e[1],1,ri),u=i.parse(e[2],2,ri);return l&&u?new mm(l,u):void 0}evaluate(e){const i=this.str.evaluate(e),l=this.delimiter.evaluate(e);return i.split(l)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function y0(n,e){return n==="=="||n==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function gm(n,e,i,l){return l.compare(e,i)===0}function Hl(n,e,i){const l=n!=="=="&&n!=="!=";return class xN{constructor(f,p,y){this.type=ai,this.lhs=f,this.rhs=p,this.collator=y,this.hasUntypedArgument=f.type.kind==="value"||p.type.kind==="value"}static parse(f,p){if(f.length!==3&&f.length!==4)return p.error("Expected two or three arguments.");const y=f[0];let w=p.parse(f[1],1,Kr);if(!w)return null;if(!y0(y,w.type))return p.concat(1).error(`"${y}" comparisons are not supported for type '${fn(w.type)}'.`);let E=p.parse(f[2],2,Kr);if(!E)return null;if(!y0(y,E.type))return p.concat(2).error(`"${y}" comparisons are not supported for type '${fn(E.type)}'.`);if(w.type.kind!==E.type.kind&&w.type.kind!=="value"&&E.type.kind!=="value")return p.error(`Cannot compare types '${fn(w.type)}' and '${fn(E.type)}'.`);l&&(w.type.kind==="value"&&E.type.kind!=="value"?w=new Jt(E.type,[w]):w.type.kind!=="value"&&E.type.kind==="value"&&(E=new Jt(w.type,[E])));let A=null;if(f.length===4){if(w.type.kind!=="string"&&E.type.kind!=="string"&&w.type.kind!=="value"&&E.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(A=p.parse(f[3],3,Eh),!A)return null}return new xN(w,E,A)}evaluate(f){const p=this.lhs.evaluate(f),y=this.rhs.evaluate(f);if(l&&this.hasUntypedArgument){const w=Cn(p),E=Cn(y);if(w.kind!==E.kind||w.kind!=="string"&&w.kind!=="number")throw new At(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${w.kind}, ${E.kind}) instead.`)}if(this.collator&&!l&&this.hasUntypedArgument){const w=Cn(p),E=Cn(y);if(w.kind!=="string"||E.kind!=="string")return e(f,p,y)}return this.collator?i(f,p,y,this.collator.evaluate(f)):e(f,p,y)}eachChild(f){f(this.lhs),f(this.rhs),this.collator&&f(this.collator)}outputDefined(){return!0}serialize(){const f=[n];return this.eachChild(p=>{f.push(p.serialize())}),f}}}const sb=Hl("==",function(n,e,i){return e===i},gm),ob=Hl("!=",function(n,e,i){return e!==i},function(n,e,i,l){return!gm(0,e,i,l)}),ab=Hl("<",function(n,e,i){return e<i},function(n,e,i,l){return l.compare(e,i)<0}),Xh=Hl(">",function(n,e,i){return e>i},function(n,e,i,l){return l.compare(e,i)>0}),lb=Hl("<=",function(n,e,i){return e<=i},function(n,e,i,l){return l.compare(e,i)<=0}),cb=Hl(">=",function(n,e,i){return e>=i},function(n,e,i,l){return l.compare(e,i)>=0});class _m{constructor(e,i,l,u,f,p){this.type=ri,this.number=e,this.locale=i,this.currency=l,this.unit=u,this.minFractionDigits=f,this.maxFractionDigits=p}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const l=i.parse(e[1],1,Vt);if(!l)return null;const u=e[2];if(typeof u!="object"||Array.isArray(u))return i.error("NumberFormat options argument must be an object.");let f=null;if(u.locale&&(f=i.parseObjectValue(u.locale,2,"locale",ri),!f))return null;let p=null;if(u.currency&&(p=i.parseObjectValue(u.currency,2,"currency",ri),!p))return null;let y=null;if(u.unit&&(y=i.parseObjectValue(u.unit,2,"unit",ri),!y))return null;let w=null;if(u["min-fraction-digits"]&&(w=i.parseObjectValue(u["min-fraction-digits"],2,"min-fraction-digits",Vt),!w))return null;let E=null;return u["max-fraction-digits"]&&(E=i.parseObjectValue(u["max-fraction-digits"],2,"max-fraction-digits",Vt),!E)?null:new _m(l,f,p,y,w,E)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class ym{constructor(e){this.type=Vt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const l=i.parse(e[1],1);return l?l.type.kind!=="array"&&l.type.kind!=="string"&&l.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${fn(l.type)} instead.`):new ym(l):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new At(`Expected value to be of type string or array, but found ${fn(Cn(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function xm(n){return function(){n=1831565813+(n|=0)|0;let e=Math.imul(n^n>>>15,1|n);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Hc={"==":sb,"!=":ob,">":Xh,"<":ab,">=":cb,"<=":lb,array:Jt,at:hm,"at-interpolated":fm,boolean:Jt,case:pm,coalesce:pd,collator:qn,format:Bl,image:Lc,in:Zh,"index-of":md,interpolate:Js,"interpolate-hcl":Js,"interpolate-lab":Js,length:ym,let:Wh,literal:vr,match:qc,number:Jt,"number-format":_m,object:Jt,slice:gd,step:fd,string:Jt,"to-boolean":nn,"to-color":nn,"to-number":nn,"to-string":nn,var:Uh,within:Vl,distance:$l,config:Gc,split:mm};function x0(n,[e,i,l,u]){e=e.evaluate(n),i=i.evaluate(n),l=l.evaluate(n);const f=u?u.evaluate(n):1,p=e0(e,i,l,f);if(p)throw new At(p);return new ti(e/255,i/255,l/255,f)}function vm(n,[e,i,l,u]){e=e.evaluate(n),i=i.evaluate(n),l=l.evaluate(n);const f=u?u.evaluate(n):1,p=function(E,A,P,M){return typeof E=="number"&&E>=0&&E<=360?typeof A=="number"&&A>=0&&A<=100&&typeof P=="number"&&P>=0&&P<=100?M===void 0||typeof M=="number"&&M>=0&&M<=1?null:`Invalid hsla value [${[E,A,P,M].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof M=="number"?[E,A,P,M]:[E,A,P]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof M=="number"?[E,A,P,M]:[E,A,P]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,l,f);if(p)throw new At(p);const y=`hsla(${e}, ${i}%, ${l}%, ${f})`,w=ti.parse(y);if(!w)throw new At(`Failed to parse HSLA color: ${y}`);return w}function bm(n,e){return n in e}function Yh(n,e){const i=e[n];return i===void 0?null:i}function Wl(n){return{type:n}}function Zl(n){return{result:"success",value:n}}function sl(n){return{result:"error",value:n}}function wm(n,e){return!!n&&!!n.parameters&&n.parameters.indexOf(e)>-1}function Kh(n){return n["property-type"]==="data-driven"}function Sm(n){return wm(n.expression,"measure-light")}function Tm(n){return wm(n.expression,"zoom")}function Jh(n){return!!n.expression&&n.expression.interpolated}function Qh(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function Em(n){return n}function ef(n,e){const i=e.type==="color",l=n.stops&&typeof n.stops[0][0]=="object",u=l||!(l||n.property!==void 0),f=n.type||(Jh(e)?"exponential":"interval");if(i&&((n=Object.assign({},n)).stops&&(n.stops=n.stops.map(E=>[E[0],ti.parse(E[1])])),n.default=ti.parse(n.default?n.default:e.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!_0[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let p,y,w;if(f==="exponential")p=v0;else if(f==="interval")p=ol;else if(f==="categorical"){p=ub,y=Object.create(null);for(const E of n.stops)y[E[0]]=E[1];w=typeof n.stops[0][0]}else{if(f!=="identity")throw new Error(`Unknown function type "${f}"`);p=db}if(l){const E={},A=[];for(let O=0;O<n.stops.length;O++){const D=n.stops[O],V=D[0].zoom;E[V]===void 0&&(E[V]={zoom:V,type:n.type,property:n.property,default:n.default,stops:[]},A.push(V)),E[V].stops.push([D[0].value,D[1]])}const P=[];for(const O of A)P.push([E[O].zoom,ef(E[O],e)]);const M={name:"linear"};return{kind:"composite",interpolationType:M,interpolationFactor:Js.interpolationFactor.bind(void 0,M),zoomStops:P.map(O=>O[0]),evaluate:({zoom:O},D)=>v0({stops:P,base:n.base},e,O).evaluate(O,D)}}if(u){const E=f==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:E,interpolationFactor:Js.interpolationFactor.bind(void 0,E),zoomStops:n.stops.map(A=>A[0]),evaluate:({zoom:A})=>p(n,e,A,y,w)}}return{kind:"source",evaluate(E,A){const P=A&&A.properties?A.properties[n.property]:void 0;return P===void 0?Wc(n.default,e.default):p(n,e,P,y,w)}}}function Wc(n,e,i){return n!==void 0?n:e!==void 0?e:i!==void 0?i:void 0}function ub(n,e,i,l,u){return Wc(typeof i===u?l[i]:void 0,n.default,e.default)}function ol(n,e,i){if(!ld(i))return Wc(n.default,e.default);const l=n.stops.length;if(l===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[l-1][0])return n.stops[l-1][1];const u=$h(n.stops.map(f=>f[0]),i);return n.stops[u][1]}function v0(n,e,i){const l=n.base!==void 0?n.base:1;if(!ld(i))return Wc(n.default,e.default);const u=n.stops.length;if(u===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[u-1][0])return n.stops[u-1][1];const f=$h(n.stops.map(A=>A[0]),i),p=function(A,P,M,O){const D=O-M,V=A-M;return D===0?0:P===1?V/D:(Math.pow(P,V)-1)/(Math.pow(P,D)-1)}(i,l,n.stops[f][0],n.stops[f+1][0]),y=n.stops[f][1],w=n.stops[f+1][1];let E=Ys[e.type]||Em;if(n.colorSpace&&n.colorSpace!=="rgb"){const A=_0[n.colorSpace];E=(P,M)=>A.reverse(A.interpolate(A.forward(P),A.forward(M),p))}return typeof y.evaluate=="function"?{evaluate(...A){const P=y.evaluate.apply(void 0,A),M=w.evaluate.apply(void 0,A);if(P!==void 0&&M!==void 0)return E(P,M,p)}}:E(y,w,p)}function db(n,e,i){return e.type==="color"?i=ti.parse(i):e.type==="formatted"?i=fs.fromString(i.toString()):e.type==="resolvedImage"?i=Is.build(i.toString()):ir(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),Wc(i,n.default,e.default)}ps.register(Hc,{error:[{kind:"error"},[ri],(n,[e])=>{throw new At(e.evaluate(n))}],typeof:[ri,[Kr],(n,[e])=>fn(Cn(e.evaluate(n)))],"to-rgba":[ns(Vt,4),[Ns],(n,[e])=>e.evaluate(n).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[ns(Vt,4),[Ns],(n,[e])=>e.evaluate(n).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Ns,[Vt,Vt,Vt],x0],rgba:[Ns,[Vt,Vt,Vt,Vt],x0],hsl:[Ns,[Vt,Vt,Vt],vm],hsla:[Ns,[Vt,Vt,Vt,Vt],vm],has:{type:ai,overloads:[[[ri],(n,[e])=>bm(e.evaluate(n),n.properties())],[[ri,Fl],(n,[e,i])=>bm(e.evaluate(n),i.evaluate(n))]]},get:{type:Kr,overloads:[[[ri],(n,[e])=>Yh(e.evaluate(n),n.properties())],[[ri,Fl],(n,[e,i])=>Yh(e.evaluate(n),i.evaluate(n))]]},"feature-state":[Kr,[ri],(n,[e])=>Yh(e.evaluate(n),n.featureState||{})],properties:[Fl,[],n=>n.properties()],"geometry-type":[ri,[],n=>n.geometryType()],worldview:[ri,[],n=>n.globals.worldview||""],id:[Kr,[],n=>n.id()],zoom:[Vt,[],n=>n.globals.zoom],pitch:[Vt,[],n=>n.globals.pitch||0],"distance-from-center":[Vt,[],n=>n.distanceFromCenter()],"measure-light":[Vt,[ri],(n,[e])=>n.measureLight(e.evaluate(n))],"heatmap-density":[Vt,[],n=>n.globals.heatmapDensity||0],"line-progress":[Vt,[],n=>n.globals.lineProgress||0],"raster-value":[Vt,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[Vt,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[Vt,[],n=>n.globals.skyRadialProgress||0],accumulated:[Kr,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[Vt,Wl(Vt),(n,e)=>{let i=0;for(const l of e)i+=l.evaluate(n);return i}],"*":[Vt,Wl(Vt),(n,e)=>{let i=1;for(const l of e)i*=l.evaluate(n);return i}],"-":{type:Vt,overloads:[[[Vt,Vt],(n,[e,i])=>e.evaluate(n)-i.evaluate(n)],[[Vt],(n,[e])=>-e.evaluate(n)]]},"/":[Vt,[Vt,Vt],(n,[e,i])=>e.evaluate(n)/i.evaluate(n)],"%":[Vt,[Vt,Vt],(n,[e,i])=>e.evaluate(n)%i.evaluate(n)],ln2:[Vt,[],()=>Math.LN2],pi:[Vt,[],()=>Math.PI],e:[Vt,[],()=>Math.E],"^":[Vt,[Vt,Vt],(n,[e,i])=>Math.pow(e.evaluate(n),i.evaluate(n))],sqrt:[Vt,[Vt],(n,[e])=>Math.sqrt(e.evaluate(n))],log10:[Vt,[Vt],(n,[e])=>Math.log(e.evaluate(n))/Math.LN10],ln:[Vt,[Vt],(n,[e])=>Math.log(e.evaluate(n))],log2:[Vt,[Vt],(n,[e])=>Math.log2(e.evaluate(n))],sin:[Vt,[Vt],(n,[e])=>Math.sin(e.evaluate(n))],cos:[Vt,[Vt],(n,[e])=>Math.cos(e.evaluate(n))],tan:[Vt,[Vt],(n,[e])=>Math.tan(e.evaluate(n))],asin:[Vt,[Vt],(n,[e])=>Math.asin(e.evaluate(n))],acos:[Vt,[Vt],(n,[e])=>Math.acos(e.evaluate(n))],atan:[Vt,[Vt],(n,[e])=>Math.atan(e.evaluate(n))],min:[Vt,Wl(Vt),(n,e)=>Math.min(...e.map(i=>i.evaluate(n)))],max:[Vt,Wl(Vt),(n,e)=>Math.max(...e.map(i=>i.evaluate(n)))],abs:[Vt,[Vt],(n,[e])=>Math.abs(e.evaluate(n))],round:[Vt,[Vt],(n,[e])=>{const i=e.evaluate(n);return i<0?-Math.round(-i):Math.round(i)}],floor:[Vt,[Vt],(n,[e])=>Math.floor(e.evaluate(n))],ceil:[Vt,[Vt],(n,[e])=>Math.ceil(e.evaluate(n))],"filter-==":[ai,[ri,Kr],(n,[e,i])=>n.properties()[e.value]===i.value],"filter-id-==":[ai,[Kr],(n,[e])=>n.id()===e.value],"filter-type-==":[ai,[ri],(n,[e])=>n.geometryType()===e.value],"filter-<":[ai,[ri,Kr],(n,[e,i])=>{const l=n.properties()[e.value],u=i.value;return typeof l==typeof u&&l<u}],"filter-id-<":[ai,[Kr],(n,[e])=>{const i=n.id(),l=e.value;return typeof i==typeof l&&i<l}],"filter->":[ai,[ri,Kr],(n,[e,i])=>{const l=n.properties()[e.value],u=i.value;return typeof l==typeof u&&l>u}],"filter-id->":[ai,[Kr],(n,[e])=>{const i=n.id(),l=e.value;return typeof i==typeof l&&i>l}],"filter-<=":[ai,[ri,Kr],(n,[e,i])=>{const l=n.properties()[e.value],u=i.value;return typeof l==typeof u&&l<=u}],"filter-id-<=":[ai,[Kr],(n,[e])=>{const i=n.id(),l=e.value;return typeof i==typeof l&&i<=l}],"filter->=":[ai,[ri,Kr],(n,[e,i])=>{const l=n.properties()[e.value],u=i.value;return typeof l==typeof u&&l>=u}],"filter-id->=":[ai,[Kr],(n,[e])=>{const i=n.id(),l=e.value;return typeof i==typeof l&&i>=l}],"filter-has":[ai,[Kr],(n,[e])=>e.value in n.properties()],"filter-has-id":[ai,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[ai,[ns(ri)],(n,[e])=>e.value.indexOf(n.geometryType())>=0],"filter-id-in":[ai,[ns(Kr)],(n,[e])=>e.value.indexOf(n.id())>=0],"filter-in-small":[ai,[ri,ns(Kr)],(n,[e,i])=>i.value.indexOf(n.properties()[e.value])>=0],"filter-in-large":[ai,[ri,ns(Kr)],(n,[e,i])=>function(l,u,f,p){for(;f<=p;){const y=f+p>>1;if(u[y]===l)return!0;u[y]>l?p=y-1:f=y+1}return!1}(n.properties()[e.value],i.value,0,i.value.length-1)],all:{type:ai,overloads:[[[ai,ai],(n,[e,i])=>e.evaluate(n)&&i.evaluate(n)],[Wl(ai),(n,e)=>{for(const i of e)if(!i.evaluate(n))return!1;return!0}]]},any:{type:ai,overloads:[[[ai,ai],(n,[e,i])=>e.evaluate(n)||i.evaluate(n)],[Wl(ai),(n,e)=>{for(const i of e)if(i.evaluate(n))return!0;return!1}]]},"!":[ai,[ai],(n,[e])=>!e.evaluate(n)],"is-supported-script":[ai,[ri],(n,[e])=>{const i=n.globals&&n.globals.isSupportedScript;return!i||i(e.evaluate(n))}],upcase:[ri,[ri],(n,[e])=>e.evaluate(n).toUpperCase()],downcase:[ri,[ri],(n,[e])=>e.evaluate(n).toLowerCase()],concat:[ri,Wl(Kr),(n,e)=>e.map(i=>Cs(i.evaluate(n))).join("")],"resolved-locale":[ri,[Eh],(n,[e])=>e.evaluate(n).resolvedLocale()],random:[Vt,[Vt,Vt,Kr],(n,e)=>{const[i,l,u]=e.map(p=>p.evaluate(n));if(i>l||i===l)return i;let f;if(typeof u=="string")f=function(p){let y=0;if(p.length===0)return y;for(let w=0;w<p.length;w++)y=(y<<5)-y+p.charCodeAt(w),y|=0;return y}(u);else{if(typeof u!="number")throw new At(`Invalid seed input: ${u}`);f=u}return i+xm(f)()*(l-i)}]});class tf{constructor(e,i,l,u,f){this.expression=e,this._warningHistory={},this._evaluator=new Sa(l,u,f),this._defaultValue=i?function(p){return p.type==="color"&&(Qh(p.default)||Array.isArray(p.default))?new ti(0,0,0,0):p.type==="color"?ti.parse(p.default)||null:p.default===void 0?null:p.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=Bh(e)}evaluateWithoutErrorHandling(e,i,l,u,f,p,y,w){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=l,this._evaluator.canonical=u||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=w||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,l,u,f,p,y,w,E){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=l||null,this._evaluator.canonical=u||null,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=p||null,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=w||null,this._evaluator.iconImageUseTheme=E||null;try{const A=this.expression.evaluate(this._evaluator);if(A==null||typeof A=="number"&&A!=A)return this._defaultValue;if(this._enumValues&&!(A in this._enumValues))throw new At(`Expected value to be one of ${Object.keys(this._enumValues).map(P=>JSON.stringify(P)).join(", ")}, but found ${JSON.stringify(A)} instead.`);return A}catch(A){return this._warningHistory[A.message]||(this._warningHistory[A.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${A.message}`)),this._defaultValue}}}function Im(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in Hc}function ra(n,e,i,l,u){const f=new Vh(Hc,[],e?function(y){const w={color:Ns,string:ri,number:Vt,enum:ri,boolean:ai,formatted:Qa,resolvedImage:rd};return y.type==="array"?ns(w[y.value]||Kr,y.length):w[y.type]}(e):void 0,void 0,void 0,i,l,u),p=f.parse(n,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return p?Zl(new tf(p,e,i,l,u)):sl(f.errors)}class _d{constructor(e,i,l,u){this.kind=e,this._styleExpression=i,this.isLightConstant=l,this.isLineProgressConstant=u,this.isStateDependent=e!=="constant"&&!Fh(i.expression),this.configDependencies=Bh(i.expression)}evaluateWithoutErrorHandling(e,i,l,u,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,i,l,u,f,p)}evaluate(e,i,l,u,f,p,y){return this._styleExpression.evaluate(e,i,l,u,f,p,void 0,void 0,y)}}class al{constructor(e,i,l,u,f,p){this.kind=e,this.zoomStops=l,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Fh(i.expression),this.isLightConstant=f,this.isLineProgressConstant=p,this.configDependencies=Bh(i.expression),this.interpolationType=u}evaluateWithoutErrorHandling(e,i,l,u,f,p){return this._styleExpression.evaluateWithoutErrorHandling(e,i,l,u,f,p)}evaluate(e,i,l,u,f,p){return this._styleExpression.evaluate(e,i,l,u,f,p)}interpolationFactor(e,i,l){return this.interpolationType?Js.interpolationFactor(this.interpolationType,e,i,l):0}}function Cm(n,e,i,l,u){if((n=ra(n,e,i,l,u)).result==="error")return n;const f=n.value.expression,p=Vc(f);if(!p&&!Kh(e))return sl([new Ro("","data expressions not supported")]);const y=$c(f,["zoom","pitch","distance-from-center"]);if(!y&&!Tm(e))return sl([new Ro("","zoom expressions not supported")]);const w=$c(f,["measure-light"]);if(!w&&!Sm(e))return sl([new Ro("","measure-light expression not supported")]);const E=$c(f,["line-progress"]);if(!E&&!function(M){return wm(M.expression,"line-progress")}(e))return sl([new Ro("","line-progress expression not supported")]);const A=e.expression&&e.expression.relaxZoomRestriction,P=nf(f);return P||y||A?P instanceof Ro?sl([P]):P instanceof Js&&!Jh(e)?sl([new Ro("",'"interpolate" expressions cannot be used with this property')]):Zl(P?new al(p&&E?"camera":"composite",n.value,P.labels,P instanceof Js?P.interpolation:void 0,w,E):new _d(p&&E?"constant":"source",n.value,w,E)):sl([new Ro("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class rf{constructor(e,i){this._parameters=e,this._specification=i,Object.assign(this,ef(this._parameters,this._specification))}static deserialize(e){return new rf(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function nf(n){let e=null;if(n instanceof Wh)e=nf(n.result);else if(n instanceof pd){for(const i of n.args)if(e=nf(i),e)break}else(n instanceof fd||n instanceof Js)&&n.input instanceof ps&&n.input.name==="zoom"&&(e=n);return e instanceof Ro||n.eachChild(i=>{const l=nf(i);l instanceof Ro?e=l:e&&l&&e!==l&&(e=new Ro("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var yd,sf,b0=function(){if(sf)return yd;sf=1,yd=e;var n=3;function e(i,l,u){var f=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var p=new Int32Array(this.arrayBuffer);i=p[0],this.d=(l=p[1])+2*(u=p[2]);for(var y=0;y<this.d*this.d;y++){var w=p[n+y],E=p[n+y+1];f.push(w===E?null:p.subarray(w,E))}var A=p[n+f.length+1];this.keys=p.subarray(p[n+f.length],A),this.bboxes=p.subarray(A),this.insert=this._insertReadonly}else{this.d=l+2*u;for(var P=0;P<this.d*this.d;P++)f.push([]);this.keys=[],this.bboxes=[]}this.n=l,this.extent=i,this.padding=u,this.scale=l/i,this.uid=0;var M=u/l*i;this.min=-M,this.max=i+M}return e.prototype.insert=function(i,l,u,f,p){this._forEachCell(l,u,f,p,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(l),this.bboxes.push(u),this.bboxes.push(f),this.bboxes.push(p)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,l,u,f,p,y){this.cells[p].push(y)},e.prototype.query=function(i,l,u,f,p){var y=this.min,w=this.max;if(i<=y&&l<=y&&w<=u&&w<=f&&!p)return Array.prototype.slice.call(this.keys);var E=[];return this._forEachCell(i,l,u,f,this._queryCell,E,{},p),E},e.prototype._queryCell=function(i,l,u,f,p,y,w,E){var A=this.cells[p];if(A!==null)for(var P=this.keys,M=this.bboxes,O=0;O<A.length;O++){var D=A[O];if(w[D]===void 0){var V=4*D;(E?E(M[V+0],M[V+1],M[V+2],M[V+3]):i<=M[V+2]&&l<=M[V+3]&&u>=M[V+0]&&f>=M[V+1])?(w[D]=!0,y.push(P[D])):w[D]=!1}}},e.prototype._forEachCell=function(i,l,u,f,p,y,w,E){for(var A=this._convertToCellCoord(i),P=this._convertToCellCoord(l),M=this._convertToCellCoord(u),O=this._convertToCellCoord(f),D=A;D<=M;D++)for(var V=P;V<=O;V++){var G=this.d*V+D;if((!E||E(this._convertFromCellCoord(D),this._convertFromCellCoord(V),this._convertFromCellCoord(D+1),this._convertFromCellCoord(V+1)))&&p.call(this,i,l,u,f,G,y,w,E))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,l=n+this.cells.length+1+1,u=0,f=0;f<this.cells.length;f++)u+=this.cells[f].length;var p=new Int32Array(l+u+this.keys.length+this.bboxes.length);p[0]=this.extent,p[1]=this.n,p[2]=this.padding;for(var y=l,w=0;w<i.length;w++){var E=i[w];p[n+w]=y,p.set(E,y),y+=E.length}return p[n+i.length]=y,p.set(this.keys,y),p[n+i.length+1]=y+=this.keys.length,p.set(this.bboxes,y),y+=this.bboxes.length,p.buffer},yd}(),Xl=Hu(b0);const Zc={};function Pt(n,e,i={}){Object.defineProperty(n,"_classRegistryKey",{value:e,writable:!1}),Zc[e]={klass:n,omit:i.omit||[]}}Pt(Object,"Object"),Xl.serialize=function(n,e){const i=n.toArrayBuffer();return e&&e.add(i),{buffer:i}},Xl.deserialize=function(n){return new Xl(n.buffer)},Object.defineProperty(Xl,"name",{value:"Grid"}),Pt(Xl,"Grid"),delete ft.prototype.constructor,typeof DOMMatrix<"u"&&Pt(DOMMatrix,"DOMMatrix"),Pt(ti,"Color"),Pt(Error,"Error"),Pt(fs,"Formatted"),Pt(Ih,"FormattedSection"),Pt(Gp,"AJAXError"),Pt(Is,"ResolvedImage"),Pt(rf,"StylePropertyFunction"),Pt(tf,"StyleExpression",{omit:["_evaluator"]}),Pt(Xs,"ImageId"),Pt(Lo,"ImageVariant"),Pt(al,"ZoomDependentExpression"),Pt(_d,"ZoomConstantExpression"),Pt(ps,"CompoundExpression",{omit:["_evaluate"]});for(const n in Hc)Zc[Hc[n]._classRegistryKey]||Pt(Hc[n],`Expression${n}`);function Am(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function Ta(n){return self.ImageBitmap&&n instanceof ImageBitmap}function ll(n,e){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(Am(n)||Ta(n))return e&&e.add(n),n;if(ArrayBuffer.isView(n))return e&&e.add(n.buffer),n;if(n instanceof ImageData)return e&&e.add(n.data.buffer),n;if(Array.isArray(n)){const i=[];for(const l of n)i.push(ll(l,e));return i}if(n instanceof Map){const i={$name:"Map",entries:[]};for(const[l,u]of n.entries())i.entries.push(ll(l),ll(u,e));return i}if(n instanceof Set){const i={$name:"Set"};let l=0;for(const u of n.values())i[++l]=ll(u);return i}if(n instanceof DOMMatrix){const i={$name:"DOMMatrix"},l=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const u of l)i[u]=n[u];return i}if(typeof n=="bigint")return{$name:"BigInt",value:n.toString()};if(typeof n=="object"){const i=n.constructor,l=i._classRegistryKey;if(!l)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const u=i.serialize?i.serialize(n,e):{};if(!i.serialize){for(const f in n)n.hasOwnProperty(f)&&(Zc[l].omit.indexOf(f)>=0||(u[f]=ll(n[f],e)));n instanceof Error&&(u.message=n.message)}if(u.$name)throw new Error("$name property is reserved for worker serialization logic.");return l!=="Object"&&(u.$name=l),u}throw new Error("can't serialize object of type "+typeof n)}function cl(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||Am(n)||Ta(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(cl);if(typeof n=="object"){const e=n.$name||"Object";if(e==="Map"){const u=n.entries||[],f=new Map;for(let p=0;p<u.length;p+=2)f.set(cl(u[p]),cl(u[p+1]));return f}if(e==="Set"){const u=new Set;for(const f of Object.keys(n))f!=="$name"&&u.add(cl(n[f]));return u}if(e==="DOMMatrix"){let u;return u=n.is2D?[n.a,n.b,n.c,n.d,n.e,n.f]:[n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44],new DOMMatrix(u)}if(e==="BigInt")return BigInt(n.value);const{klass:i}=Zc[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(n);const l=Object.create(i.prototype);for(const u of Object.keys(n))u!=="$name"&&(l[u]=cl(n[u]));return l}throw new Error("can't deserialize object of type "+typeof n)}const Xt={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,Osage:n=>n>=66736&&n<=66815,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function Pm(n){for(const e of n)if(af(e.charCodeAt(0)))return!0;return!1}function w0(n){for(const e of n)if(!of(e.charCodeAt(0)))return!1;return!0}function of(n){return!(Xt.Arabic(n)||Xt["Arabic Supplement"](n)||Xt["Arabic Extended-A"](n)||Xt["Arabic Presentation Forms-A"](n)||Xt["Arabic Presentation Forms-B"](n))}function af(n){return!(n!==746&&n!==747&&(n<4352||!(Xt["Bopomofo Extended"](n)||Xt.Bopomofo(n)||Xt["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||Xt["CJK Compatibility Ideographs"](n)||Xt["CJK Compatibility"](n)||Xt["CJK Radicals Supplement"](n)||Xt["CJK Strokes"](n)||!(!Xt["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||Xt["CJK Unified Ideographs Extension A"](n)||Xt["CJK Unified Ideographs"](n)||Xt["Enclosed CJK Letters and Months"](n)||Xt["Hangul Compatibility Jamo"](n)||Xt["Hangul Jamo Extended-A"](n)||Xt["Hangul Jamo Extended-B"](n)||Xt["Hangul Jamo"](n)||Xt["Hangul Syllables"](n)||Xt.Hiragana(n)||Xt["Ideographic Description Characters"](n)||Xt.Kanbun(n)||Xt["Kangxi Radicals"](n)||Xt["Katakana Phonetic Extensions"](n)||Xt.Katakana(n)&&n!==12540||!(!Xt["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!Xt["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||Xt["Unified Canadian Aboriginal Syllabics"](n)||Xt["Unified Canadian Aboriginal Syllabics Extended"](n)||Xt["Vertical Forms"](n)||Xt["Yijing Hexagram Symbols"](n)||Xt["Yi Syllables"](n)||Xt["Yi Radicals"](n))))}function lf(n){return!(af(n)||function(e){return!!(Xt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Xt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Xt["Letterlike Symbols"](e)||Xt["Number Forms"](e)||Xt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Xt["Control Pictures"](e)&&e!==9251||Xt["Optical Character Recognition"](e)||Xt["Enclosed Alphanumerics"](e)||Xt["Geometric Shapes"](e)||Xt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Xt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Xt["CJK Symbols and Punctuation"](e)||Xt.Katakana(e)||Xt["Private Use Area"](e)||Xt["CJK Compatibility Forms"](e)||Xt["Small Form Variants"](e)||Xt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(n))}function hb(n){return Xt.Arabic(n)||Xt["Arabic Supplement"](n)||Xt["Arabic Extended-A"](n)||Xt["Arabic Presentation Forms-A"](n)||Xt["Arabic Presentation Forms-B"](n)}function S0(n){return n>=1424&&n<=2303||Xt["Arabic Presentation Forms-A"](n)||Xt["Arabic Presentation Forms-B"](n)}function fb(n,e){return!(!e&&S0(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||Xt.Khmer(n))}function pb(n){for(const e of n)if(S0(e.charCodeAt(0)))return!0;return!1}const Rs={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let km=null,ms=Rs.unavailable,ul=null;const T0=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(ms=Rs.error),km&&km(n)};function Mm(){Nm.fire(new No("pluginStateChange",{pluginStatus:ms,pluginURL:ul}))}const Nm=new zl,cf=function(){return ms},Yl=function(){if(ms!==Rs.deferred||!ul)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ms=Rs.loading,Mm(),ul&&kc({url:ul},n=>{n?T0(n):(ms=Rs.loaded,Mm())})},ia={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ms===Rs.loaded||ia.applyArabicShaping!=null,isLoading:()=>ms===Rs.loading,setState(n){ms=n.pluginStatus,ul=n.pluginURL},isParsing:()=>ms===Rs.parsing,isParsed:()=>ms===Rs.parsed,getPluginURL:()=>ul};class gi{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,l){for(const u of i)if(!fb(u.charCodeAt(0),l))return!1;return!0}(e,ia.isLoaded())}}class Kl{constructor(e,i,l,u,f){this.property=e,this.value=i,this.expression=function(p,y,w,E,A){if(Qh(p))return new rf(p,y);if(Im(p)||Array.isArray(p)&&p.length>0){const P=Cm(p,y,w,E,A);if(P.result==="error")throw new Error(P.value.map(M=>`${M.key}: ${M.message}`).join(", "));return P.value}{let P=p;return typeof p=="string"&&y.type==="color"&&(P=ti.parse(p)),{kind:"constant",configDependencies:new Set,evaluate:()=>P}}}(i===void 0?e.specification.default:i,e.specification,l,u,f)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,l,u){return this.property.possiblyEvaluate(this,e,i,l,u)}}class Rm{constructor(e,i,l,u){this.property=e,this.value=new Kl(e,void 0,i,l,u)}transitioned(e,i){return new Ea(this.property,this.value,i,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new Ea(this.property,this.value,null,{},0)}}class E0{constructor(e,i,l,u){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=l,this._iconImageUseTheme=u,this.configDependencies=new Set}getValue(e){return Mr(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Rm(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new Kl(this._values[e].property,i===null?void 0:Mr(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const l=this._properties.properties;if(e)for(const u in e){const f=e[u];if(u.endsWith("-transition")){const p=u.slice(0,-11);l[p]&&this.setTransition(p,f)}else l.hasOwnProperty(u)&&this.setValue(u,f)}}getTransition(e){return Mr(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Rm(this._values[e].property)),this._values[e].transition=Mr(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const l=this.getValue(i);l!==void 0&&(e[i]=l);const u=this.getTransition(i);u!==void 0&&(e[`${i}-transition`]=u)}return e}transitioned(e,i){const l=new Lm(this._properties);for(const u of Object.keys(this._values))l._values[u]=this._values[u].transitioned(e,i._values[u]);return l}untransitioned(){const e=new Lm(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class Ea{constructor(e,i,l,u,f){const p=u.delay||0,y=u.duration||0;f=f||0,this.property=e,this.value=i,this.begin=f+p,this.end=this.begin+y,e.specification.transition&&(u.delay||u.duration)&&(this.prior=l)}possiblyEvaluate(e,i,l){const u=e.now||0,f=this.value.possiblyEvaluate(e,i,l),p=this.prior;if(p){if(u>this.end)return this.prior=null,f;if(this.value.isDataDriven())return this.prior=null,f;if(u<this.begin)return p.possiblyEvaluate(e,i,l);{const y=(u-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(e,i,l),f,he(y))}}return f}}class Lm{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,l){const u=new ec(this._properties);for(const f of Object.keys(this._values))u._values[f]=this._values[f].possiblyEvaluate(e,i,l);return u}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Jl{constructor(e,i,l,u){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=l,this._iconImageUseTheme=u,this.configDependencies=new Set}getValue(e){return Mr(this._values[e].value)}setValue(e,i){this._values[e]=new Kl(this._values[e].property,i===null?void 0:Mr(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const l=this.getValue(i);l!==void 0&&(e[i]=l)}return e}possiblyEvaluate(e,i,l,u){const f=new ec(this._properties);for(const p of Object.keys(this._values))f._values[p]=this._values[p].possiblyEvaluate(e,i,l,u);return f}}class Ql{constructor(e,i,l,u){this.property=e,this.value=i,this.parameters=l,this.iconImageUseTheme=u}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,l,u){return this.property.evaluate(this.value,this.parameters,e,i,l,u,this.iconImageUseTheme)}}class ec{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class mt{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,l){const u=Ys[this.specification.type];return u?u(e,i,l):e}}class Tt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,l,u,f){return e.expression.kind==="constant"||e.expression.kind==="camera"?new Ql(this,{kind:"constant",value:e.expression.evaluate(i,null,{},l,u,void 0,f)},i):new Ql(this,e.expression,i,f)}interpolate(e,i,l){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new Ql(this,{kind:"constant",value:void 0},e.parameters);const u=Ys[this.specification.type];return u?new Ql(this,{kind:"constant",value:u(e.value.value,i.value.value,l)},e.parameters):e}evaluate(e,i,l,u,f,p,y){return e.kind==="constant"?e.value:e.evaluate(i,l,u,f,p,void 0,y)}}class Xc{constructor(e){this.specification=e}possiblyEvaluate(e,i,l,u){return!!e.expression.evaluate(i,null,{},l,u)}interpolate(){return!1}}class $i{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new gi(0,{});for(const l in e){const u=e[l];u.specification.overridable&&this.overridableProperties.push(l);const f=this.defaultPropertyValues[l]=new Kl(u,void 0),p=this.defaultTransitionablePropertyValues[l]=new Rm(u);this.defaultTransitioningPropertyValues[l]=p.untransitioned(),this.defaultPossiblyEvaluatedValues[l]=f.possiblyEvaluate(i)}}}Pt(Tt,"DataDrivenProperty"),Pt(mt,"DataConstantProperty"),Pt(Xc,"ColorRampProperty");var Le=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function uf(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function tc(n){if(Array.isArray(n))return n.map(tc);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const e={};for(const i in n)e[i]=tc(n[i]);return e}return uf(n)}function df(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!df(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function xd(n,e="",i=null,l="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};df(n)||(n=hf(n));const u=n;let f=!0;try{f=function(A){if(!Yc(A))return A;let P=tc(A);return Do(P),P=I0(P),P}(u)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(u,null,2)}
        `)}let p=null,y=null;if(l!=="background"&&l!=="sky"&&l!=="slot"){y=Le[`filter_${l}`];const A=ra(f,y,e,i);if(A.result==="error")throw new Error(A.value.map(P=>`${P.key}: ${P.message}`).join(", "));p=(P,M,O)=>A.value.evaluate(P,M,{},O)}let w=null,E=null;if(f!==u){const A=ra(u,y,e,i);if(A.result==="error")throw new Error(A.value.map(P=>`${P.key}: ${P.message}`).join(", "));w=(P,M,O,D,V)=>A.value.evaluate(P,M,{},O,void 0,void 0,D,V),E=!Vc(A.value.expression)}return{filter:p,dynamicFilter:w||void 0,needGeometry:A0(f),needFeature:!!E}}function I0(n){if(!Array.isArray(n))return n;const e=function(i){if(C0.has(i[0])){for(let l=1;l<i.length;l++)if(Yc(i[l]))return!0}return i}(n);return e===!0?e:e.map(i=>I0(i))}function Do(n){let e=!1;const i=[];if(n[0]==="case"){for(let l=1;l<n.length-1;l+=2)e=e||Yc(n[l]),i.push(n[l+1]);i.push(n[n.length-1])}else if(n[0]==="match"){e=e||Yc(n[1]);for(let l=2;l<n.length-1;l+=2)i.push(n[l+1]);i.push(n[n.length-1])}else if(n[0]==="step"){e=e||Yc(n[1]);for(let l=1;l<n.length-1;l+=2)i.push(n[l+1])}e&&(n.length=0,n.push("any",...i));for(let l=1;l<n.length;l++)Do(n[l])}function Yc(n){if(!Array.isArray(n))return!1;if((e=n[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<n.length;i++)if(Yc(n[i]))return!0;return!1}const C0=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function mb(n,e){return n<e?-1:n>e?1:0}function A0(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let e=1;e<n.length;e++)if(A0(n[e]))return!0;return!1}function hf(n){if(!n)return!0;const e=n[0];return n.length<=1?e!=="any":e==="=="?Om(n[1],n[2],"=="):e==="!="?ff(Om(n[1],n[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Om(n[1],n[2],e):e==="any"?(i=n.slice(1),["any"].concat(i.map(hf))):e==="all"?["all"].concat(n.slice(1).map(hf)):e==="none"?["all"].concat(n.slice(1).map(hf).map(ff)):e==="in"?P0(n[1],n.slice(2)):e==="!in"?ff(P0(n[1],n.slice(2))):e==="has"?k0(n[1]):e!=="!has"||ff(k0(n[1]));var i}function Om(n,e,i){switch(n){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,n,e]}}function P0(n,e){if(e.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",n,["literal",e.sort(mb)]]:["filter-in-small",n,["literal",e]]}}function k0(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function ff(n){return["!",n]}const vd="";function Kc(n,e){return e?`${n}${vd}${e}`:n}let Dm;const M0=()=>Dm||(Dm=new $i({"icon-size":new Tt(Le.layout_symbol["icon-size"]),"icon-image":new Tt(Le.layout_symbol["icon-image"]),"icon-rotate":new Tt(Le.layout_symbol["icon-rotate"]),"icon-offset":new Tt(Le.layout_symbol["icon-offset"])}));class gb{constructor(e,i,l,u,f,p){const y=ra(e,Le.appearance.condition);if(y.result==="success"&&(this.condition=y.value),this.name=i,l){this.properties=new ec(M0()),this.unevaluatedLayout=new Jl(M0(),u,f,p);for(const w in l)this.unevaluatedLayout.setValue(w,l[w])}}isActive(e){return!(this.condition||!e.isHidden||this.name!=="hidden")||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.properties&&(e.properties=this.properties),e}}const N0="-transition",R0=new Set(["fill","line","background","hillshade","raster"]);class ss extends zl{constructor(e,i,l,u,f,p){if(super(),this.id=e.id,this.fqid=Kc(this.id,l),this.type=e.type,this.scope=l,this.lut=u,this.options=f,this.iconImageUseTheme=p,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const y=ra(this.filter,Le[`filter_${e.type}`]);y.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...y.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),e.appearances&&e.appearances.forEach(y=>{this.appearances.push(new gb(y.condition,y.name,y.properties,this.scope,f,this.iconImageUseTheme))}),i.layout&&(this._unevaluatedLayout=new Jl(i.layout,this.scope,f,this.iconImageUseTheme),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new E0(i.paint,this.scope,f);for(const y in e.paint)this.setPaintProperty(y,e.paint[y]);for(const y in e.layout)this.setLayoutProperty(y,e.layout[y]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new ec(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&R0.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const l=this._unevaluatedLayout;l._properties.properties[e]&&(l.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...l.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(N0)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const l=this._transitionablePaint,u=l._properties.properties;if(e.endsWith(N0)){const P=e.slice(0,-11);return u[P]&&l.setTransition(P,i||void 0),!1}if(!u[e])return!1;const f=l._values[e],p=f.value.isDataDriven(),y=f.value;l.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...l.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const w=l._values[e].value,E=w.isDataDriven(),A=e.endsWith("pattern")||e==="line-dasharray";return E||p||A||this._handleOverridablePaintPropertyUpdate(e,y,w)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,l){return null}_handleOverridablePaintPropertyUpdate(e,i,l){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(e.appearances=this.appearances.map(i=>i.serialize())),Rr(e,(i,l)=>!(i===void 0||l==="layout"&&!Object.keys(i).length||l==="paint"&&!Object.keys(i).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof Ql&&Kh(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=xd(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRadius(e){}queryIntersectsFeature(e,i,l,u,f,p,y,w,E){}}const dl={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Jc{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ei{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Dr(n,e=1){let i=0,l=0;return{members:n.map(u=>{const f=dl[u.type].BYTES_PER_ELEMENT,p=i=L0(i,Math.max(e,f)),y=u.components||1;return l=Math.max(l,f),i+=f*y,{name:u.name,type:u.type,components:y,offset:p}}),size:L0(i,Math.max(l,e)),alignment:e}}function L0(n,e){return Math.ceil(n/e)*e}class hl extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const l=this.length;return this.resize(l+1),this.emplace(l,e,i)}emplace(e,i,l){const u=2*e;return this.int16[u+0]=i,this.int16[u+1]=l,e}}hl.prototype.bytesPerElement=4,Pt(hl,"StructArrayLayout2i4");class rc extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,l)}emplace(e,i,l,u){const f=3*e;return this.int16[f+0]=i,this.int16[f+1]=l,this.int16[f+2]=u,e}}rc.prototype.bytesPerElement=6,Pt(rc,"StructArrayLayout3i6");class ic extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,u){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,l,u)}emplace(e,i,l,u,f){const p=4*e;return this.int16[p+0]=i,this.int16[p+1]=l,this.int16[p+2]=u,this.int16[p+3]=f,e}}ic.prototype.bytesPerElement=8,Pt(ic,"StructArrayLayout4i8");class fl extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}fl.prototype.bytesPerElement=4,Pt(fl,"StructArrayLayout1f4");class jm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,l)}emplace(e,i,l,u){const f=4*e,p=2*e;return this.int16[f+0]=i,this.int16[f+1]=l,this.float32[p+1]=u,e}}jm.prototype.bytesPerElement=8,Pt(jm,"StructArrayLayout2i1f8");class pf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,l)}emplace(e,i,l,u){const f=4*e;return this.int16[f+0]=i,this.int16[f+1]=l,this.int16[f+2]=u,e}}pf.prototype.bytesPerElement=8,Pt(pf,"StructArrayLayout3i8");class zm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,u,f)}emplace(e,i,l,u,f,p){const y=5*e;return this.int16[y+0]=i,this.int16[y+1]=l,this.int16[y+2]=u,this.int16[y+3]=f,this.int16[y+4]=p,e}}zm.prototype.bytesPerElement=10,Pt(zm,"StructArrayLayout5i10");class mf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,u,f,p,y)}emplace(e,i,l,u,f,p,y,w){const E=6*e,A=12*e,P=3*e;return this.int16[E+0]=i,this.int16[E+1]=l,this.uint8[A+4]=u,this.uint8[A+5]=f,this.uint8[A+6]=p,this.uint8[A+7]=y,this.float32[P+2]=w,e}}mf.prototype.bytesPerElement=12,Pt(mf,"StructArrayLayout2i4ub1f12");class As extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,l)}emplace(e,i,l,u){const f=3*e;return this.float32[f+0]=i,this.float32[f+1]=l,this.float32[f+2]=u,e}}As.prototype.bytesPerElement=12,Pt(As,"StructArrayLayout3f12");class pl extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,u,f)}emplace(e,i,l,u,f,p){const y=6*e,w=3*e;return this.uint16[y+0]=i,this.uint16[y+1]=l,this.uint16[y+2]=u,this.uint16[y+3]=f,this.float32[w+2]=p,e}}pl.prototype.bytesPerElement=12,Pt(pl,"StructArrayLayout4ui1f12");class Qc extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,u){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,l,u)}emplace(e,i,l,u,f){const p=4*e;return this.uint16[p+0]=i,this.uint16[p+1]=l,this.uint16[p+2]=u,this.uint16[p+3]=f,e}}Qc.prototype.bytesPerElement=8,Pt(Qc,"StructArrayLayout4ui8");class gf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,l,u,f,p)}emplace(e,i,l,u,f,p,y){const w=6*e;return this.int16[w+0]=i,this.int16[w+1]=l,this.int16[w+2]=u,this.int16[w+3]=f,this.int16[w+4]=p,this.int16[w+5]=y,e}}gf.prototype.bytesPerElement=12,Pt(gf,"StructArrayLayout6i12");class Fm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E,A,P,M){const O=this.length;return this.resize(O+1),this.emplace(O,e,i,l,u,f,p,y,w,E,A,P,M)}emplace(e,i,l,u,f,p,y,w,E,A,P,M,O){const D=12*e;return this.int16[D+0]=i,this.int16[D+1]=l,this.int16[D+2]=u,this.int16[D+3]=f,this.uint16[D+4]=p,this.uint16[D+5]=y,this.uint16[D+6]=w,this.uint16[D+7]=E,this.int16[D+8]=A,this.int16[D+9]=P,this.int16[D+10]=M,this.int16[D+11]=O,e}}Fm.prototype.bytesPerElement=24,Pt(Fm,"StructArrayLayout4i4ui4i24");class Bm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,l,u,f,p)}emplace(e,i,l,u,f,p,y){const w=10*e,E=5*e;return this.int16[w+0]=i,this.int16[w+1]=l,this.int16[w+2]=u,this.float32[E+2]=f,this.float32[E+3]=p,this.float32[E+4]=y,e}}Bm.prototype.bytesPerElement=20,Pt(Bm,"StructArrayLayout3i3f20");class jo extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,l,u)}emplace(e,i,l,u,f){const p=4*e;return this.float32[p+0]=i,this.float32[p+1]=l,this.float32[p+2]=u,this.float32[p+3]=f,e}}jo.prototype.bytesPerElement=16,Pt(jo,"StructArrayLayout4f16");class eu extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}eu.prototype.bytesPerElement=4,Pt(eu,"StructArrayLayout1ul4");class pn extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const l=this.length;return this.resize(l+1),this.emplace(l,e,i)}emplace(e,i,l){const u=2*e;return this.uint16[u+0]=i,this.uint16[u+1]=l,e}}pn.prototype.bytesPerElement=4,Pt(pn,"StructArrayLayout2ui4");class tu extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E,A,P,M,O){const D=this.length;return this.resize(D+1),this.emplace(D,e,i,l,u,f,p,y,w,E,A,P,M,O)}emplace(e,i,l,u,f,p,y,w,E,A,P,M,O,D){const V=20*e,G=10*e;return this.int16[V+0]=i,this.int16[V+1]=l,this.int16[V+2]=u,this.int16[V+3]=f,this.int16[V+4]=p,this.float32[G+3]=y,this.float32[G+4]=w,this.float32[G+5]=E,this.float32[G+6]=A,this.int16[V+14]=P,this.uint32[G+8]=M,this.uint16[V+18]=O,this.uint16[V+19]=D,e}}tu.prototype.bytesPerElement=40,Pt(tu,"StructArrayLayout5i4f1i1ul2ui40");class _f extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,u,f,p,y)}emplace(e,i,l,u,f,p,y,w){const E=8*e;return this.int16[E+0]=i,this.int16[E+1]=l,this.int16[E+2]=u,this.int16[E+4]=f,this.int16[E+5]=p,this.int16[E+6]=y,this.int16[E+7]=w,e}}_f.prototype.bytesPerElement=16,Pt(_f,"StructArrayLayout3i2i2i16");class Um extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,u,f)}emplace(e,i,l,u,f,p){const y=4*e,w=8*e;return this.float32[y+0]=i,this.float32[y+1]=l,this.float32[y+2]=u,this.int16[w+6]=f,this.int16[w+7]=p,e}}Um.prototype.bytesPerElement=16,Pt(Um,"StructArrayLayout2f1f2i16");class Vm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,l,u,f,p)}emplace(e,i,l,u,f,p,y){const w=20*e,E=5*e;return this.uint8[w+0]=i,this.uint8[w+1]=l,this.float32[E+1]=u,this.float32[E+2]=f,this.float32[E+3]=p,this.float32[E+4]=y,e}}Vm.prototype.bytesPerElement=20,Pt(Vm,"StructArrayLayout2ub4f20");class bn extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,l)}emplace(e,i,l,u){const f=3*e;return this.uint16[f+0]=i,this.uint16[f+1]=l,this.uint16[f+2]=u,e}}bn.prototype.bytesPerElement=6,Pt(bn,"StructArrayLayout3ui6");class bd extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re,oe,xe){const ve=this.length;return this.resize(ve+1),this.emplace(ve,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re,oe,xe)}emplace(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re,oe,xe,ve){const Se=30*e,Ce=15*e,Ae=60*e;return this.int16[Se+0]=i,this.int16[Se+1]=l,this.int16[Se+2]=u,this.float32[Ce+2]=f,this.float32[Ce+3]=p,this.uint16[Se+8]=y,this.uint16[Se+9]=w,this.uint32[Ce+5]=E,this.uint32[Ce+6]=A,this.uint32[Ce+7]=P,this.uint16[Se+16]=M,this.uint16[Se+17]=O,this.uint16[Se+18]=D,this.float32[Ce+10]=V,this.float32[Ce+11]=G,this.uint8[Ae+48]=q,this.uint8[Ae+49]=te,this.uint8[Ae+50]=re,this.uint32[Ce+13]=oe,this.int16[Se+28]=xe,this.uint8[Ae+58]=ve,e}}bd.prototype.bytesPerElement=60,Pt(bd,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class $m extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re,oe,xe,ve,Se,Ce,Ae,Qe,Oe,et,ct,rt,st,ht,Ke){const at=this.length;return this.resize(at+1),this.emplace(at,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re,oe,xe,ve,Se,Ce,Ae,Qe,Oe,et,ct,rt,st,ht,Ke)}emplace(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re,oe,xe,ve,Se,Ce,Ae,Qe,Oe,et,ct,rt,st,ht,Ke,at){const $e=20*e,Be=40*e,pt=80*e;return this.float32[$e+0]=i,this.float32[$e+1]=l,this.int16[Be+4]=u,this.int16[Be+5]=f,this.int16[Be+6]=p,this.int16[Be+7]=y,this.int16[Be+8]=w,this.int16[Be+9]=E,this.int16[Be+10]=A,this.int16[Be+11]=P,this.int16[Be+12]=M,this.uint16[Be+13]=O,this.uint16[Be+14]=D,this.uint16[Be+15]=V,this.uint16[Be+16]=G,this.uint16[Be+17]=q,this.uint16[Be+18]=te,this.uint16[Be+19]=re,this.uint16[Be+20]=oe,this.uint16[Be+21]=xe,this.uint16[Be+22]=ve,this.uint16[Be+23]=Se,this.uint16[Be+24]=Ce,this.uint16[Be+25]=Ae,this.uint16[Be+26]=Qe,this.uint16[Be+27]=Oe,this.uint32[$e+14]=et,this.float32[$e+15]=ct,this.float32[$e+16]=rt,this.float32[$e+17]=st,this.float32[$e+18]=ht,this.uint8[pt+76]=Ke,this.uint16[Be+39]=at,e}}$m.prototype.bytesPerElement=80,Pt($m,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class wd extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,l,u,f,p)}emplace(e,i,l,u,f,p,y){const w=6*e;return this.float32[w+0]=i,this.float32[w+1]=l,this.float32[w+2]=u,this.float32[w+3]=f,this.float32[w+4]=p,this.float32[w+5]=y,e}}wd.prototype.bytesPerElement=24,Pt(wd,"StructArrayLayout6f24");class nc extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,l,u,f)}emplace(e,i,l,u,f,p){const y=5*e;return this.float32[y+0]=i,this.float32[y+1]=l,this.float32[y+2]=u,this.float32[y+3]=f,this.float32[y+4]=p,e}}nc.prototype.bytesPerElement=20,Pt(nc,"StructArrayLayout5f20");class Gm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,u,f,p,y)}emplace(e,i,l,u,f,p,y,w){const E=7*e;return this.float32[E+0]=i,this.float32[E+1]=l,this.float32[E+2]=u,this.float32[E+3]=f,this.float32[E+4]=p,this.float32[E+5]=y,this.float32[E+6]=w,e}}Gm.prototype.bytesPerElement=28,Pt(Gm,"StructArrayLayout7f28");class yf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E,A,P){const M=this.length;return this.resize(M+1),this.emplace(M,e,i,l,u,f,p,y,w,E,A,P)}emplace(e,i,l,u,f,p,y,w,E,A,P,M){const O=11*e;return this.float32[O+0]=i,this.float32[O+1]=l,this.float32[O+2]=u,this.float32[O+3]=f,this.float32[O+4]=p,this.float32[O+5]=y,this.float32[O+6]=w,this.float32[O+7]=E,this.float32[O+8]=A,this.float32[O+9]=P,this.float32[O+10]=M,e}}yf.prototype.bytesPerElement=44,Pt(yf,"StructArrayLayout11f44");class Sd extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E){const A=this.length;return this.resize(A+1),this.emplace(A,e,i,l,u,f,p,y,w,E)}emplace(e,i,l,u,f,p,y,w,E,A){const P=9*e;return this.float32[P+0]=i,this.float32[P+1]=l,this.float32[P+2]=u,this.float32[P+3]=f,this.float32[P+4]=p,this.float32[P+5]=y,this.float32[P+6]=w,this.float32[P+7]=E,this.float32[P+8]=A,e}}Sd.prototype.bytesPerElement=36,Pt(Sd,"StructArrayLayout9f36");class ru extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const l=this.length;return this.resize(l+1),this.emplace(l,e,i)}emplace(e,i,l){const u=2*e;return this.float32[u+0]=i,this.float32[u+1]=l,e}}ru.prototype.bytesPerElement=8,Pt(ru,"StructArrayLayout2f8");class xf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,l,u){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,l,u)}emplace(e,i,l,u,f){const p=6*e;return this.uint32[3*e+0]=i,this.uint16[p+2]=l,this.uint16[p+3]=u,this.uint16[p+4]=f,e}}xf.prototype.bytesPerElement=12,Pt(xf,"StructArrayLayout1ul3ui12");class vf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}vf.prototype.bytesPerElement=2,Pt(vf,"StructArrayLayout1ui2");class qm extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G){const q=this.length;return this.resize(q+1),this.emplace(q,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G)}emplace(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q){const te=16*e;return this.float32[te+0]=i,this.float32[te+1]=l,this.float32[te+2]=u,this.float32[te+3]=f,this.float32[te+4]=p,this.float32[te+5]=y,this.float32[te+6]=w,this.float32[te+7]=E,this.float32[te+8]=A,this.float32[te+9]=P,this.float32[te+10]=M,this.float32[te+11]=O,this.float32[te+12]=D,this.float32[te+13]=V,this.float32[te+14]=G,this.float32[te+15]=q,e}}qm.prototype.bytesPerElement=64,Pt(qm,"StructArrayLayout16f64");class iu extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,l,u,f,p,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,l,u,f,p,y)}emplace(e,i,l,u,f,p,y,w){const E=10*e,A=5*e;return this.uint16[E+0]=i,this.uint16[E+1]=l,this.uint16[E+2]=u,this.uint16[E+3]=f,this.float32[A+2]=p,this.float32[A+3]=y,this.float32[A+4]=w,e}}iu.prototype.bytesPerElement=20,Pt(iu,"StructArrayLayout4ui3f20");class nu extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}nu.prototype.bytesPerElement=2,Pt(nu,"StructArrayLayout1i2");class bf extends Ei{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}bf.prototype.bytesPerElement=1,Pt(bf,"StructArrayLayout1ub1");class O0 extends Jc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}O0.prototype.size=40;class Hm extends tu{get(e){return new O0(this,e)}}Pt(Hm,"CollisionBoxArray");class D0 extends Jc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}D0.prototype.size=60;class wf extends bd{get(e){return new D0(this,e)}}Pt(wf,"PlacedSymbolArray");class j0 extends Jc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}j0.prototype.size=80;class z0 extends $m{get(e){return new j0(this,e)}}Pt(z0,"SymbolInstanceArray");class F0 extends fl{getoffsetX(e){return this.float32[1*e+0]}}Pt(F0,"GlyphOffsetArray");class B0 extends hl{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Pt(B0,"SymbolLineVertexArray");class Wm extends Jc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Wm.prototype.size=12;class U0 extends xf{get(e){return new Wm(this,e)}}Pt(U0,"FeatureIndexArray");class V0 extends pn{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Pt(V0,"FillExtrusionCentroidArray");class $0 extends Jc{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}$0.prototype.size=6;class G0 extends rc{get(e){return new $0(this,e)}}Pt(G0,"FillExtrusionWallArray");const _b=Dr([{name:"a_pos",components:2,type:"Int16"}],4),yb=Dr([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),xb=Dr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Fi{constructor(e=[]){this.segments=e}_prepareSegment(e,i,l,u){let f=this.segments[this.segments.length-1];return e>Fi.MAX_VERTEX_ARRAY_LENGTH&&Lr(`Max vertices per segment is ${Fi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!f||f.vertexLength+e>Fi.MAX_VERTEX_ARRAY_LENGTH||f.sortKey!==u)&&(f={vertexOffset:i,primitiveOffset:l,vertexLength:0,primitiveLength:0},u!==void 0&&(f.sortKey=u),this.segments.push(f)),f}prepareSegment(e,i,l,u){return this._prepareSegment(e,i.length,l.length,u)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,l,u){return new Fi([{vertexOffset:e,primitiveOffset:i,vertexLength:l,primitiveLength:u,vaos:{},sortKey:0}])}}function Td(n,e){return 256*(n=be(Math.floor(n),0,255))+be(Math.floor(e),0,255)}Fi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Pt(Fi,"SegmentVector");const vb=Dr([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),bb=Dr([{name:"a_pattern_b",components:4,type:"Uint16"}]),Sf=Dr([{name:"a_dash",components:4,type:"Uint16"}]);class Ed{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,l,u){this.ids.push(Zm(e)),this.positions.push(i,l,u)}eachPosition(e,i){const l=Zm(e);let u=0,f=this.ids.length-1;for(;u<f;){const p=u+f>>1;this.ids[p]>=l?f=p:u=p+1}for(;this.ids[u]===l;)i(this.positions[3*u],this.positions[3*u+1],this.positions[3*u+2]),u++}static serialize(e,i){const l=new Float64Array(e.ids),u=new Uint32Array(e.positions);return Xm(l,u,0,l.length-1),i&&(i.add(l.buffer),i.add(u.buffer)),{ids:l,positions:u}}static deserialize(e){const i=new Ed;let l;i.ids=e.ids,i.positions=e.positions;for(const u of i.ids)u!==l&&i.uniqueIds.push(u),l=u;return i.indexed=!0,i}}function Zm(n){const e=+n;return Number.isSafeInteger(e)?e:vh(String(n))}function Xm(n,e,i,l){for(;i<l;){const u=n[i+l>>1];let f=i-1,p=l+1;for(;;){do f++;while(n[f]<u);do p--;while(n[p]>u);if(f>=p)break;Id(n,f,p),Id(e,3*f,3*p),Id(e,3*f+1,3*p+1),Id(e,3*f+2,3*p+2)}p-i<l-p?(Xm(n,e,i,p),i=p+1):(Xm(n,e,p+1,l),l=p)}}function Id(n,e,i){const l=n[e];n[e]=n[i],n[i]=l}Pt(Ed,"FeaturePositionMap");class na{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,l){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Cd extends na{constructor(e){super(e),this.current=0}set(e,i,l){this.fetchUniformLocation(e,i)&&this.current!==l&&(this.current=l,this.gl.uniform1i(this.location,l))}}class Qi extends na{constructor(e){super(e),this.current=0}set(e,i,l){this.fetchUniformLocation(e,i)&&this.current!==l&&(this.current=l,this.gl.uniform1f(this.location,l))}}class sa extends na{constructor(e){super(e),this.current=[0,0]}set(e,i,l){this.fetchUniformLocation(e,i)&&(l[0]===this.current[0]&&l[1]===this.current[1]||(this.current=l,this.gl.uniform2f(this.location,l[0],l[1])))}}class Ad extends na{constructor(e){super(e),this.current=[0,0,0]}set(e,i,l){this.fetchUniformLocation(e,i)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]||(this.current=l,this.gl.uniform3f(this.location,l[0],l[1],l[2])))}}class Pd extends na{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,l){this.fetchUniformLocation(e,i)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]&&l[3]===this.current[3]||(this.current=l,this.gl.uniform4f(this.location,l[0],l[1],l[2],l[3])))}}class q0 extends na{constructor(e){super(e),this.current=ti.transparent.toPremultipliedRenderColor(null)}set(e,i,l){this.fetchUniformLocation(e,i)&&(l.r===this.current.r&&l.g===this.current.g&&l.b===this.current.b&&l.a===this.current.a||(this.current=l,this.gl.uniform4f(this.location,l.r,l.g,l.b,l.a)))}}const wb=new Float32Array(16);class kd extends na{constructor(e){super(e),this.current=wb}set(e,i,l){if(this.fetchUniformLocation(e,i)){if(l[12]!==this.current[12]||l[0]!==this.current[0])return this.current=l,void this.gl.uniformMatrix4fv(this.location,!1,l);for(let u=1;u<16;u++)if(l[u]!==this.current[u]){this.current=l,this.gl.uniformMatrix4fv(this.location,!1,l);break}}}}const Sb=new Float32Array(9),Tb=new Float32Array(4);class Tf extends na{constructor(e){super(e),this.current=Tb}set(e,i,l){if(this.fetchUniformLocation(e,i)){for(let u=0;u<4;u++)if(l[u]!==this.current[u]){this.current=l,this.gl.uniformMatrix2fv(this.location,!1,l);break}}}}function Md(n){return[Td(255*n.r,255*n.g),Td(255*n.b,255*n.a)]}class Qs{constructor(e,i,l,u){this.value=e,this.uniformNames=i.map(f=>`u_${f}`),this.type=l,this.context=u}setUniform(e,i,l,u,f){const p=u.constantOr(this.value);i.set(e,f,p instanceof ti?p.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):p)}getBinding(e,i){return this.type==="color"?new q0(e):new Qi(e)}}class sc{constructor(e,i){this.uniformNames=i.map(l=>`u_${l}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,l,u,f){let p=null;f!=="u_pattern"&&f!=="u_dash"||(p=this.pattern),f==="u_pattern_b"&&(p=this.patternTransition),f==="u_pixel_ratio"&&(p=this.pixelRatio),p&&i.set(e,f,p)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new Pd(e):new Qi(e)}}class ml{constructor(e,i,l,u){this.expression=e,this.type=l,this.maxValue=0,this.paintVertexAttributes=i.map(f=>({name:`a_${f}`,type:"Float32",components:l==="color"?2:1,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,i,l,u,f,p,y,w){const E=this.paintVertexArray.length,A=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new gi(0,{brightness:p,worldview:w}),i,{},f,u,y):this.expression.kind==="constant"&&this.expression.value,P=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new gi(0,{brightness:p,worldview:w}),i,{},f,u,y):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(E,e,A,P?null:this.context.lut)}updatePaintArray(e,i,l,u,f,p,y,w){const E=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:y,worldview:w},l,u,void 0,f):this.expression.kind==="constant"&&this.expression.value,A=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new gi(0,{brightness:y,worldview:w}),l,u,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,i,E,A?null:this.context.lut)}_setPaintValue(e,i,l,u){if(this.type==="color"){const f=Md(l.toPremultipliedRenderColor(u));for(let p=e;p<i;p++)this.paintVertexArray.emplace(p,f[0],f[1])}else{for(let f=e;f<i;f++)this.paintVertexArray.emplace(f,l);this.maxValue=Math.max(this.maxValue,Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ia{constructor(e,i,l,u,f,p){this.expression=e,this.uniformNames=i.map(y=>`u_${y}_t`),this.type=l,this.useIntegerZoom=u,this.context=f,this.maxValue=0,this.paintVertexAttributes=i.map(y=>({name:`a_${y}`,type:"Float32",components:l==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,i,l,u,f,p,y,w){const E=this.expression.evaluate(new gi(this.context.zoom,{brightness:p,worldview:w}),i,{},f,u,y),A=this.expression.evaluate(new gi(this.context.zoom+1,{brightness:p,worldview:w}),i,{},f,u,y),P=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new gi(0,{brightness:p,worldview:w}),i,{},f,u,y):this.lutExpression.value)==="none",M=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(M,e,E,A,P?null:this.context.lut)}updatePaintArray(e,i,l,u,f,p,y,w){const E=this.expression.evaluate({zoom:this.context.zoom,brightness:y,worldview:w},l,u,void 0,f),A=this.expression.evaluate({zoom:this.context.zoom+1,brightness:y,worldview:w},l,u,void 0,f),P=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new gi(0,{brightness:y,worldview:w}),l,u,void 0,f):this.lutExpression.value)==="none";this._setPaintValue(e,i,E,A,P?null:this.context.lut)}_setPaintValue(e,i,l,u,f){if(this.type==="color"){const p=Md(l.toPremultipliedRenderColor(f)),y=Md(l.toPremultipliedRenderColor(f));for(let w=e;w<i;w++)this.paintVertexArray.emplace(w,p[0],p[1],y[0],y[1])}else{for(let p=e;p<i;p++)this.paintVertexArray.emplace(p,l,u);this.maxValue=Math.max(this.maxValue,Math.abs(l),Math.abs(u))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,l,u,f){const p=this.useIntegerZoom?Math.floor(l.zoom):l.zoom,y=be(this.expression.interpolationFactor(p,this.context.zoom,this.context.zoom+1),0,1);i.set(e,f,y)}getBinding(e,i){return new Qi(e)}}class Ca{constructor(e,i,l,u,f){this.expression=e,this.layerId=f,this.paintVertexAttributes=(l==="array"?Sf:vb).members;for(let p=0;p<i.length;++p);this.paintVertexArray=new u,this.paintTransitionVertexArray=new Qc}populatePaintArray(e,i,l,u){const f=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(f,e,i.patterns&&i.patterns[this.layerId],l)}updatePaintArray(e,i,l,u,f,p,y){this._setPaintValues(e,i,l.patterns&&l.patterns[this.layerId],p)}_setPaintValues(e,i,l,u){if(!u||!l)return;const f=u[l[0]],p=u[l[1]];if(f){if(f){const{tl:y,br:w,pixelRatio:E}=f;for(let A=e;A<i;A++)this.paintVertexArray.emplace(A,y[0],y[1],w[0],w[1],E)}if(p){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:y,br:w}=p;for(let E=e;E<i;E++)this.paintTransitionVertexArray.emplace(E,y[0],y[1],w[0],w[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,bb.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class oc{constructor(e,i,l=()=>!0){this.binders={},this._buffers=[],this.context=i;const u=[];for(const f in e.paint._values){const p=e.paint.get(f);if(f.endsWith("-use-theme")||!l(f)||!(p instanceof Ql&&Kh(p.property.specification)))continue;const y=iT(f,e.type),w=p.value,E=p.property.specification.type,A=!!p.property.useIntegerZoom,P=f==="line-dasharray"||f.endsWith("pattern"),M=e.paint.get(`${f}-use-theme`),O=f==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||M&&M.value.kind!=="constant";if(w.kind!=="constant"||O)if(w.kind==="source"||O||P){const D=a(f,E,"source");this.binders[f]=P?new Ca(w,y,E,D,e.id):new ml(w,y,E,D),u.push(`/a_${f}`)}else{const D=a(f,E,"composite");this.binders[f]=new Ia(w,y,E,A,i,D),u.push(`/z_${f}`)}else this.binders[f]=P?new sc(w.value,y):new Qs(w.value,y,E,i),u.push(`/u_${f}`);M&&(this.binders[f].lutExpression=M.value)}this.cacheKey=u.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof ml||i instanceof Ia?i.maxValue:0}populatePaintArrays(e,i,l,u,f,p,y,w){for(const E in this.binders){const A=this.binders[E];A.context=this.context,(A instanceof ml||A instanceof Ia||A instanceof Ca)&&A.populatePaintArray(e,i,l,u,f,p,y,w)}}setConstantPatternPositions(e,i){for(const l in this.binders){const u=this.binders[l];u instanceof sc&&u.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof Ca?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,l,u,f,p,y,w,E,A){let P=!1;const M=Object.keys(e),O=M.length!==0&&!w,D=O?M:i.uniqueIds;this.context.lut=f.lut;for(const V in this.binders){const G=this.binders[V];if(G.context=this.context,(G instanceof ml||G instanceof Ia||G instanceof Ca)&&G.expression&&G.expression.kind&&G.expression.kind!=="constant"&&(G.expression.isStateDependent===!0||G.expression.isLightConstant===!1)){const q=f.paint.get(V);G.expression=q.value;for(const te of D){const re=e[te.toString()];i.eachPosition(te,(oe,xe,ve)=>{const Se=u.feature(oe);G.updatePaintArray(xe,ve,Se,re,p,y,E,A)})}if(!O)for(const te of l.uniqueIds){const re=e[te.toString()];l.eachPosition(te,(oe,xe,ve)=>{const Se=u.feature(oe);G.updatePaintArray(xe,ve,Se,re,p,y,E,A)})}P=!0}}return P}defines(){const e=[];for(const i in this.binders){const l=this.binders[i];(l instanceof Qs||l instanceof sc)&&e.push(...l.uniformNames.map(u=>`#define HAS_UNIFORM_${u}`))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const l in this.binders){const u=this.binders[l];if(u instanceof Qs||u instanceof sc||u instanceof Ia)for(const f of u.uniformNames)i.push({name:f,property:l,binding:u.getBinding(e,f)})}return i}setUniforms(e,i,l,u,f){for(const{name:p,property:y,binding:w}of l)this.binders[y].setUniform(e,w,f,u.get(y),p)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof ml||i instanceof Ia||i instanceof Ca)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof Ca&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const l=this.binders[i];(l instanceof ml||l instanceof Ia||l instanceof Ca)&&l.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof ml||i instanceof Ia||i instanceof Ca)&&i.destroy()}}}class zo{constructor(e,i,l=()=>!0){this.programConfigurations={};for(const u of e)this.programConfigurations[u.id]=new oc(u,i,l);this.needsUpload=!1,this._featureMap=new Ed,this._featureMapWithoutIds=new Ed,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,l,u,f,p,y,w,E){for(const A in this.programConfigurations)this.programConfigurations[A].populatePaintArrays(e,i,u,f,p,y,w,E);i.id!==void 0?this._featureMap.add(i.id,l,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,l,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,l,u,f,p,y,w){for(const E of l)this.needsUpload=this.programConfigurations[E.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,E,u,f,p,y||0,w)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const H0={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function iT(n,e){return H0[n]||[n.replace(`${e}-`,"").replace(/-/g,"_")]}const h={"line-pattern":{source:pl,composite:pl},"fill-pattern":{source:pl,composite:pl},"fill-extrusion-pattern":{source:pl,composite:pl},"line-dasharray":{source:Qc,composite:Qc}},t={color:{source:ru,composite:jo},number:{source:fl,composite:ru}};function a(n,e,i){const l=h[n];return l&&l[i]||t[e][i]}Pt(Qs,"ConstantBinder"),Pt(sc,"PatternConstantBinder"),Pt(ml,"SourceExpressionBinder"),Pt(Ca,"PatternCompositeBinder"),Pt(Ia,"CompositeExpressionBinder"),Pt(oc,"ProgramConfiguration",{omit:["_buffers"]}),Pt(zo,"ProgramConfigurationSet");const d=vt/Math.PI/2,g=5,_=6,b=16383,T=64,I=[T,32,16],k=-d,N=d;function j(n,e,i,l=d){return i=Re(i),[n*Math.sin(i)*l,-e*l,n*Math.cos(i)*l]}function R(n,e,i){return j(Math.cos(Re(n)),Math.sin(Re(n)),e,i)}const z=63710088e-1,B=2*Math.PI*z;class U{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new U(Me(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,l=this.lat*i,u=e.lat*i,f=Math.sin(l)*Math.sin(u)+Math.cos(l)*Math.cos(u)*Math.cos((e.lng-this.lng)*i);return z*Math.acos(Math.min(f,1))}toBounds(e=0){const i=360*e/40075017,l=i/Math.cos(Math.PI/180*this.lat);return new Y({lng:this.lng-l,lat:this.lat-i},{lng:this.lng+l,lat:this.lat+i})}toEcef(e){return R(this.lat,this.lng,d+e*d/z)}static convert(e){if(e instanceof U)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new U(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new U(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class Y{constructor(e,i){e&&(i?this.setSouthWest(e).setNorthEast(i):Array.isArray(e)&&e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof U?new U(e.lng,e.lat):U.convert(e),this}setSouthWest(e){return this._sw=e instanceof U?new U(e.lng,e.lat):U.convert(e),this}extend(e){const i=this._sw,l=this._ne;let u,f;if(e instanceof U)u=e,f=e;else{if(!(e instanceof Y))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Y.convert(e)):this.extend(U.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(U.convert(e)):this;if(u=e._sw,f=e._ne,!u||!f)return this}return i||l?(i.lng=Math.min(u.lng,i.lng),i.lat=Math.min(u.lat,i.lat),l.lng=Math.max(f.lng,l.lng),l.lat=Math.max(f.lat,l.lat)):(this._sw=new U(u.lng,u.lat),this._ne=new U(f.lng,f.lat)),this}getCenter(){return new U((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new U(this.getWest(),this.getNorth())}getSouthEast(){return new U(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:l}=U.convert(e);let u=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=l&&l<=this._ne.lat&&u}static convert(e){if(e)return e instanceof Y?e:new Y(e)}}const H=0,K=25.5;function ne(n){return B*Math.cos(n*Math.PI/180)}function ce(n){return(180+n)/360}function ge(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function pe(n,e){return n/ne(e)}function _e(n){return 360*n-180}function me(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function fe(n,e){return n*ne(me(e))}const ye=85.051129;function Fe(n){return Math.cos(Re(be(n,-ye,ye)))}function Pe(n,e){const i=be(e,H,K),l=Math.pow(2,i);return Fe(n)*B/(512*l)}function Ze(n){return 1/Math.cos(n*Math.PI/180)}function De(n,e=0){const i=Math.exp(Math.PI*(1-(n.y+e/vt)/(1<<n.z)*2));return 80150034*i/(i*i+1)/vt/(1<<n.z)}class He{constructor(e,i,l=0){this.x=+e,this.y=+i,this.z=+l}static fromLngLat(e,i=0){const l=U.convert(e);return new He(ce(l.lng),ge(l.lat),pe(i,l.lat))}toLngLat(){return new U(_e(this.x),me(this.y))}toAltitude(){return fe(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/B*Ze(me(this.y))}}function _t(n,e,i,l,u,f,p,y,w){const E=(e+l)/2,A=(i+u)/2,P=new ft(E,A);y(P),function(M,O,D,V,G,q){const te=D-G,re=V-q;return Math.abs((V-O)*te-(D-M)*re)/Math.hypot(te,re)}(P.x,P.y,f.x,f.y,p.x,p.y)>=w?(_t(n,e,i,E,A,f,P,y,w),_t(n,E,A,l,u,P,p,y,w)):n.push(p)}function ze(n,e,i){let l=n[0],u=l.x,f=l.y;e(l);const p=[l];for(let y=1;y<n.length;y++){const w=n[y],{x:E,y:A}=w;e(w),_t(p,u,f,E,A,l,w,e,i),u=E,f=A,l=w}return p}function Ie(n,e,i,l){if(l(e,i)){const u=e.add(i)._mult(.5);Ie(n,e,u,l),Ie(n,u,i,l)}else n.push(i)}function Ye(n,e){let i=n[0];const l=[i];for(let u=1;u<n.length;u++){const f=n[u];Ie(l,i,f,e),i=f}return l}const Ue=Math.pow(2,14)-1,nt=-Ue-1;function gt(n,e){const i=Math.round(n.x*e),l=Math.round(n.y*e);return n.x=be(i,nt,Ue),n.y=be(l,nt,Ue),(i<n.x||i>n.x+1||l<n.y||l>n.y+1)&&Lr("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function Et(n,e,i){const l=n.loadGeometry(),u=n.extent,f=vt/u;if(e&&i&&i.projection.isReprojectedInTileSpace){const p=1<<e.z,{scale:y,x:w,y:E,projection:A}=i,P=M=>{const O=_e((e.x+M.x/u)/p),D=me((e.y+M.y/u)/p),V=A.project(O,D);M.x=(V.x*y-w)*u,M.y=(V.y*y-E)*u};for(let M=0;M<l.length;M++)if(n.type!==1)l[M]=ze(l[M],P,1);else{const O=[];for(const D of l[M])D.x<0||D.x>=u||D.y<0||D.y>=u||(P(D),O.push(D));l[M]=O}}for(const p of l)for(const y of p)gt(y,f);return l}function dt(n,e){return{type:n.type,id:n.id,properties:n.properties,geometry:e?Et(n):[]}}class lt{constructor(e,i,l,u,f){this.properties={},this.extent=l,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=u,this._values=f,e.readFields(Ft,this,i)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos,l=[];let u,f=1,p=0,y=0,w=0;for(;e.pos<i;){if(p<=0){const E=e.readVarint();f=7&E,p=E>>3}if(p--,f===1||f===2)y+=e.readSVarint(),w+=e.readSVarint(),f===1&&(u&&l.push(u),u=[]),u&&u.push(new ft(y,w));else{if(f!==7)throw new Error(`unknown command ${f}`);u&&u.push(u[0].clone())}}return u&&l.push(u),l}bbox(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos;let l=1,u=0,f=0,p=0,y=1/0,w=-1/0,E=1/0,A=-1/0;for(;e.pos<i;){if(u<=0){const P=e.readVarint();l=7&P,u=P>>3}if(u--,l===1||l===2)f+=e.readSVarint(),p+=e.readSVarint(),f<y&&(y=f),f>w&&(w=f),p<E&&(E=p),p>A&&(A=p);else if(l!==7)throw new Error(`unknown command ${l}`)}return[y,E,w,A]}toGeoJSON(e,i,l){const u=this.extent*Math.pow(2,l),f=this.extent*e,p=this.extent*i,y=this.loadGeometry();function w(M){return[360*(M.x+f)/u-180,360/Math.PI*Math.atan(Math.exp((1-2*(M.y+p)/u)*Math.PI))-90]}function E(M){return M.map(w)}let A;if(this.type===1){const M=[];for(const D of y)M.push(D[0]);const O=E(M);A=M.length===1?{type:"Point",coordinates:O[0]}:{type:"MultiPoint",coordinates:O}}else if(this.type===2){const M=y.map(E);A=M.length===1?{type:"LineString",coordinates:M[0]}:{type:"MultiLineString",coordinates:M}}else{if(this.type!==3)throw new Error("unknown feature type");{const M=function(D){const V=D.length;if(V<=1)return[D];const G=[];let q,te;for(let re=0;re<V;re++){const oe=Dt(D[re]);oe!==0&&(te===void 0&&(te=oe<0),te===oe<0?(q&&G.push(q),q=[D[re]]):q&&q.push(D[re]))}return q&&G.push(q),G}(y),O=[];for(const D of M)O.push(D.map(E));A=O.length===1?{type:"Polygon",coordinates:O[0]}:{type:"MultiPolygon",coordinates:O}}}const P={type:"Feature",geometry:A,properties:this.properties};return this.id!=null&&(P.id=this.id),P}}function Ft(n,e,i){n===1?e.id=i.readVarint():n===2?function(l,u){const f=l.readVarint()+l.pos;for(;l.pos<f;){const p=u._keys[l.readVarint()],y=u._values[l.readVarint()];u.properties[p]=y}}(i,e):n===3?e.type=i.readVarint():n===4&&(e._geometry=i.pos)}function Dt(n){let e=0;for(let i,l,u=0,f=n.length,p=f-1;u<f;p=u++)i=n[u],l=n[p],e+=(l.x-i.x)*(i.y+l.y);return e}lt.types=["Unknown","Point","LineString","Polygon"];class zt{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Ot,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const i=this._pbf.readVarint()+this._pbf.pos;return new lt(this._pbf,i,this.extent,this._keys,this._values)}}function Ot(n,e,i){n===15?e.version=i.readVarint():n===1?e.name=i.readString():n===5?e.extent=i.readVarint():n===2?e._features.push(i.pos):n===3?e._keys.push(i.readString()):n===4&&e._values.push(function(l){let u=null;const f=l.readVarint()+l.pos;for(;l.pos<f;){const p=l.readVarint()>>3;u=p===1?l.readString():p===2?l.readFloat():p===3?l.readDouble():p===4?l.readVarint64():p===5?l.readVarint():p===6?l.readSVarint():p===7?l.readBoolean():null}if(u==null)throw new Error("unknown feature value");return u}(i))}class nr{constructor(e,i){this.layers=e.readFields(gr,{},i)}}function gr(n,e,i){if(n===3){const l=new zt(i,i.readVarint()+i.pos);l.length&&(e[l.name]=l)}}const br="3d_elevation_id",ii="level";class lr{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,l){return this.get(e,!0,i,l)}optional(e,i,l){return this.get(e,!1,i,l)}success(){return this._valid}get(e,i,l,u){const f=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&f!==void 0&&!Number.isNaN(f)?l(u?u(f):f):i&&(this._valid=!1),this}}class qr{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,l){return this.featureFunc(e,i,l)}parseVertex(e,i,l){return this.vertexFunc(e,i,l)}}const ei=new qr((n,e,i)=>n.reset(e).require(br,l=>{i.id=l}).optional("fixed_height_relative",l=>{i.constantHeight=l},_r.decodeRelativeHeight).geometry(l=>{i.bounds=l},kh).success(),(n,e,i)=>n.reset(e).require(br,l=>{i.id=l}).require("elevation_idx",l=>{i.idx=l}).require("extent",l=>{i.extent=l}).require("height_relative",l=>{i.height=l},_r.decodeRelativeHeight).geometry(l=>{i.position=l},_r.getPoint).success()),Ii=new qr((n,e,i)=>n.reset(e).require(br,l=>{i.id=l}).optional("fixed_height",l=>{i.constantHeight=l},_r.decodeMetricHeight).geometry(l=>{i.bounds=l},kh).success(),(n,e,i)=>n.reset(e).require(br,l=>{i.id=l}).require("elevation_idx",l=>{i.idx=l}).require("extent",l=>{i.extent=l}).require("height",l=>{i.height=l},_r.decodeMetricHeight).geometry(l=>{i.position=l},_r.getPoint).success());class _r{static getPoint(e){return Ao(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?e==="1.0.1"?Ii:void 0:ei}static parse(e){const i=[],l=[],u=e.length,f=new lr;for(let p=0;p<u;p++){const y=e.feature(p),w=y.properties.version,E=_r.getVersionSchema(w);if(E===void 0){Lr(`Unknown elevation feature version number ${w||"(unknown)"}`);continue}const A=y.properties.type;if(!A)continue;const P=lt.types[y.type];if(P==="Point"&&A==="curve_point"){const M={};E.parseVertex(f,y,M)&&i.push(M)}else if(P==="Polygon"&&A==="curve_meta"){const M={};E.parseFeature(f,y,M)&&l.push(M)}}return{vertices:i,features:l}}}class Xr{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,l){const u=jn(i,this.dir);if(Math.abs(u)<1e-6)return!1;const f=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/u;return l[0]=this.pos[0]+this.dir[0]*f,l[1]=this.pos[1]+this.dir[1]*f,!0}}class Wr{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,l){const u=vi(i,this.dir);if(Math.abs(u)<1e-6)return!1;const f=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/u;return l[0]=this.pos[0]+this.dir[0]*f,l[1]=this.pos[1]+this.dir[1]*f,l[2]=this.pos[2]+this.dir[2]*f,!0}closestPointOnSphere(e,i,l){if(function(O,D){var V=O[0],G=O[1],q=O[2],te=D[0],re=D[1],oe=D[2];return Math.abs(V-te)<=L*Math.max(1,Math.abs(V),Math.abs(te))&&Math.abs(G-re)<=L*Math.max(1,Math.abs(G),Math.abs(re))&&Math.abs(q-oe)<=L*Math.max(1,Math.abs(q),Math.abs(oe))}(this.pos,e)||i===0)return l[0]=l[1]=l[2]=0,!1;const[u,f,p]=this.dir,y=this.pos[0]-e[0],w=this.pos[1]-e[1],E=this.pos[2]-e[2],A=u*u+f*f+p*p,P=2*(y*u+w*f+E*p),M=P*P-4*A*(y*y+w*w+E*E-i*i);if(M<0){const O=Math.max(-P/2,0),D=y+u*O,V=w+f*O,G=E+p*O,q=Math.hypot(D,V,G);return l[0]=D*i/q,l[1]=V*i/q,l[2]=G*i/q,!1}{const O=(-P-Math.sqrt(M))/(2*A);if(O<0){const D=Math.hypot(y,w,E);return l[0]=y*i/D,l[1]=w*i/D,l[2]=E*i/D,!1}return l[0]=y+u*O,l[1]=w+f*O,l[2]=E+p*O,!0}}}class Jr{constructor(e,i,l,u,f){this.TL=e,this.TR=i,this.BR=l,this.BL=u,this.horizon=f}static fromInvProjectionMatrix(e,i,l){const u=[-1,1,1],f=[1,1,1],p=[1,-1,1],y=[-1,-1,1],w=or(u,u,e),E=or(f,f,e),A=or(p,p,e),P=or(y,y,e);return new Jr(w,E,A,P,i/l)}}function Pi(n,e,i){let l=1/0,u=-1/0;const f=[];for(const p of n){Gr(f,p,e);const y=vi(f,i);l=Math.min(l,y),u=Math.max(u,y)}return[l,u]}function Ki(n,e){let i=!0;for(let l=0;l<n.planes.length;l++){const u=n.planes[l];let f=0;for(let p=0;p<e.length;p++)f+=+(vi(u,e[p])+u[3]>=0);if(f===0)return 0;f!==e.length&&(i=!1)}return i?2:1}function An(n,e){for(const i of n.projections){const l=Pi(e,n.points[0],i.axis);if(i.projection[1]<l[0]||i.projection[0]>l[1])return 0}return 1}function ki(n,e){let i=0;const l=[0,0,0,0];for(let p=0;p<n.length;p++)l[0]=n[p][0],l[1]=n[p][1],l[2]=n[p][2],l[3]=1,(u=l)[0]*(f=e)[0]+u[1]*f[1]+u[2]*f[2]+u[3]*f[3]>=0&&i++;var u,f;return i}class wr{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Qt.fromPoints(this.points),this.projections=[],this.frustumEdges=[Gr([],this.points[2],this.points[3]),Gr([],this.points[0],this.points[3]),Gr([],this.points[4],this.points[0]),Gr([],this.points[5],this.points[1]),Gr([],this.points[6],this.points[2]),Gr([],this.points[7],this.points[3])];for(const l of this.frustumEdges){const u=[0,-l[2],l[1]],f=[l[2],0,-l[0]];this.projections.push({axis:u,projection:Pi(this.points,this.points[0],u)}),this.projections.push({axis:f,projection:Pi(this.points,this.points[0],f)})}}static fromInvProjectionMatrix(e,i,l,u){const f=Math.pow(2,l),p=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(E=>{const A=on([],E,e),P=1/A[3]/i*f;return(M=A)[0]=(O=A)[0]*(D=[P,P,u?1/A[3]:P,P])[0],M[1]=O[1]*D[1],M[2]=O[2]*D[2],M[3]=O[3]*D[3],M;var M,O,D}),y=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(E=>{const A=Yr([],Vi([],Gr([],p[E[0]],p[E[1]]),Gr([],p[E[2]],p[E[1]]))),P=-vi(A,p[E[1]]);return A.concat(P)}),w=[];for(let E=0;E<p.length;E++)w.push([p[E][0],p[E][1],p[E][2]]);return new wr(w,y)}intersectsPrecise(e,i,l){for(let u=0;u<i.length;u++)if(!ki(e,i[u]))return 0;for(let u=0;u<this.planes.length;u++)if(!ki(e,this.planes[u]))return 0;for(const u of l)for(const f of this.frustumEdges){const p=Vi([],u,f),y=fr(p);if(y===0)continue;rr(p,p,1/y);const w=Pi(this.points,this.points[0],p),E=Pi(e,this.points[0],p);if(w[0]>E[1]||E[0]>w[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const l=i[3];if(vi([i[0],i[1],i[2]],e)+l<0)return!1}return!0}}class Qt{static fromPoints(e){const i=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(const u of e)xr(i,i,u),Rt(l,l,u);return new Qt(i,l)}static fromTileIdAndHeight(e,i,l){const u=1<<e.canonical.z,f=e.canonical.x,p=e.canonical.y;return new Qt([f/u,p/u,i],[(f+1)/u,(p+1)/u,l])}static applyTransform(e,i){const l=e.getCorners();for(let u=0;u<l.length;++u)or(l[u],l[u],i);return Qt.fromPoints(l)}static applyTransformFast(e,i){const l=[i[12],i[13],i[14]],u=[...l];for(let f=0;f<3;f++)for(let p=0;p<3;p++){const y=i[4*p+f],w=y*e.min[p],E=y*e.max[p];l[f]+=Math.min(w,E),u[f]+=Math.max(w,E)}return new Qt(l,u)}static projectAabbCorners(e,i){const l=e.getCorners();for(let u=0;u<l.length;++u)or(l[u],l[u],i);return l}constructor(e,i){this.min=e,this.max=i,this.center=rr([],Ut([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],l=Wt(this.min),u=Wt(this.max);for(let f=0;f<i.length;f++)l[f]=i[f]?this.min[f]:this.center[f],u[f]=i[f]?this.center[f]:this.max[f];return u[2]=this.max[2],new Qt(l,u)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Ki(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Ki(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?An(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?An(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}Pt(Qt,"Aabb");class ni{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,l=i[1],u=-i[0],f=(e.extent+1)*this.metersToTile;return[new ft(Math.trunc(e.position[0]+l*f),Math.trunc(e.position[1]+u*f)),new ft(Math.trunc(e.position[0]-l*f),Math.trunc(e.position[1]-u*f))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Gi{constructor(e,i,l,u,f,p){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[$n(),$n(),$n(),$n(),$n(),$n(),$n()],this.id=e,this.heightRange={min:l,max:l},this.safeArea=i,this.constantHeight=l,this.constantHeight==null&&(this.constantHeight!=null||u.length!==0)){this.vertices=u,this.edges=f,this.edges=this.edges.filter(y=>{return y.a<this.vertices.length&&y.b<this.vertices.length&&!((w=this.vertices[y.a].position)[0]===(E=this.vertices[y.b].position)[0]&&w[1]===E[1]);var w,E}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const y of this.vertices)this.vertexProps.push({dir:Ao(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,y.height),this.heightRange.max=Math.max(this.heightRange.max,y.height);for(const y of this.edges){const w=this.vertices[y.a].position,E=this.vertices[y.b].position,A=Jo($n(),E,w),P=Ll(A),M=xa($n(),A,1/P);this.edgeProps.push({vec:A,dir:M,len:P});const O=this.vertexProps[y.a].dir,D=this.vertexProps[y.b].dir;Za(O,O,M),Za(D,D,M)}for(const y of this.vertexProps)y.dir[0]===0&&y.dir[1]===0||Ui(y.dir,y.dir);this.tessellate(p)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[l,u]=i;return Yt(this.vertices[this.edges[l].a].height,this.vertices[this.edges[l].b].height,u)}computeSlopeNormal(e,i){const l=this.getClosestEdge(e);if(!l)return dr(0,0,1);const u=l[0],f=this.edges[u],p=this.edgeProps[u].vec,y=dr(p[0],p[1],(this.vertices[f.b].height-this.vertices[f.a].height)*i),w=dr(y[1],-y[0],0);Vi(w,w,y);const E=fr(w);return E>0?rr(w,w,1/E):cr(w,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,l=Number.POSITIVE_INFINITY,u=0;const[f,p,y,w,E,A,P]=this._tmpVec2;Gu(P,e.x,e.y);const M=new Xr(P,null);for(let O=0;O<this.edges.length;O++){const D=this.edges[O],V=this.edgeProps[O].dir;M.dir=V;const G=this.vertices[D.a].position,q=this.vertices[D.b].position,te=M.intersectsPlane(G,this.vertexProps[D.a].dir,f),re=M.intersectsPlane(q,this.vertexProps[D.b].dir,p);if(!te||!re)continue;Jo(y,p,f),Jo(w,P,f);const oe=jn(y,y),xe=oe>0?jn(w,y)/oe:0,ve=be(xe,0,1),Se=Math.abs((xe-ve)*this.edgeProps[O].len);Jo(E,P,G),Gu(A,V[1],-V[0]);const Ce=Se+Math.abs(jn(E,A));Ce<l&&(i=O,l=Ce,u=ve)}return[i,u]}tessellate(e){const i=Nt(),l=Nt(),u=Nt(),f=Nt();for(let p=this.edges.length-1;p>=0;--p){const y=this.edges[p].a,w=this.edges[p].b,{position:E,height:A,extent:P}=this.vertices[y],{position:M,height:O,extent:D}=this.vertices[w],V=this.vertexProps[y].dir,G=this.vertexProps[w].dir;if(cr(i,E[0]/e,E[1]/e,A),cr(l,M[0]/e,M[1]/e,O),cr(u,V[1],-V[0],0),rr(u,u,P),cr(f,G[1],-G[0],0),rr(f,f,D),this.distSqLines(dr(i[0]+.5*u[0],i[1]+.5*u[1],i[2]+.5*u[2]),dr(l[0]-.5*f[0],l[1]-.5*f[1],l[2]-.5*f[2]),dr(i[0]-.5*u[0],i[1]-.5*u[1],i[2]-.5*u[2]),dr(l[0]+.5*f[0],l[1]+.5*f[1],l[2]+.5*f[2]))<=.0025000000000000005)continue;const q=this.vertices.length,te=Za($n(),E,M);this.vertices.push({position:xa(te,te,.5),height:.5*(A+O),extent:.5*(P+D)});const re=Za($n(),V,G);this.vertexProps.push({dir:Ui(re,re)}),this.edges.splice(p,1),this.edgeProps.splice(p,1),this.edges.push({a:y,b:q}),this.edges.push({a:q,b:w});const oe=Jo($n(),this.vertices[q].position,E),xe=Ll(oe),ve={vec:oe,dir:xa($n(),oe,1/xe),len:xe};this.edgeProps.push(ve),this.edgeProps.push(ve)}}distSqLines(e,i,l,u){const f=jr(Nt(),i,e),p=jr(Nt(),u,l),y=jr(Nt(),e,l),w=vi(f,f),E=vi(f,p),A=vi(f,y),P=vi(p,p),M=vi(p,y),O=w*P-E*E;if(O===0)return Un(Vn(f,l,u,vi(y,p)/vi(p,p)),e);const D=(w*M-E*A)/O;return Un(Vn(f,e,i,(E*M-A*P)/O),Vn(p,l,u,D))}}class Ri{static parseFrom(e,i){const l=_r.parse(e);if(!l)return[];let{vertices:u,features:f}=l;const p=1/De(i);f.sort((A,P)=>A.id-P.id),u.sort((A,P)=>A.id-P.id||A.idx-P.idx),u=u.filter((A,P,M)=>P===M.findIndex(O=>O.id===A.id&&O.idx===A.idx));const y=new Array;let w=0;const E=u.length;for(const A of f){if(A.constantHeight){y.push(new Gi(A.id,A.bounds,A.constantHeight));continue}for(;w!==E&&u[w].id<A.id;)w++;if(w===E||u[w].id!==A.id)continue;const P=new Array,M=new Array,O=w;for(;w!==E&&u[w].id===A.id;){const D=u[w];if(P.push({position:D.position,height:D.height,extent:D.extent}),w!==O&&u[w-1].idx===D.idx-1){const V=w-O;M.push({a:V-1,b:V})}w++}y.push(new Gi(A.id,A.bounds,void 0,P,M,p))}return y}static getElevationFeature(e,i){if(!i)return;const l=+e.properties[br];return Number.isNaN(l)?void 0:i.find(u=>u.id===l)}}class sn{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*vt,this.yOffset=(e.y*this.zScale-i.y)*vt)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,l){const u=this.constantElevation(i,l);return u??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),l))}computeBiasedHeight(e,i){return i<=0?e:e+i*Ge(0,i,e>=0?e:Math.abs(.5*e))}}Pt(Gi,"ElevationFeature");class zn{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new hl,this.indexArray=new bn,this.segments=new Fi,this.programConfigurations=new zo(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new fl),this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,l,u){const f=this.layers[0],p=[];let y=null;f.type==="circle"&&(y=f.layout.get("circle-sort-key"));for(const{feature:E,id:A,index:P,sourceLayerIndex:M}of e){const O=this.layers[0]._featureFilter.needGeometry,D=dt(E,O);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom,{worldview:this.worldview}),D,l))continue;const V=y?y.evaluate(D,{},l):void 0,G={id:A,properties:E.properties,type:E.type,sourceLayerIndex:M,index:P,geometry:O?D.geometry:Et(E,l,u),patterns:{},sortKey:V};p.push(G)}y&&p.sort((E,A)=>E.sortKey-A.sortKey);let w=null;u.projection.name==="globe"&&(this.globeExtVertexArray=new gf,w=u.projection);for(const E of p){const{geometry:A,index:P,sourceLayerIndex:M}=E,O=e[P].feature;this.addFeature(E,A,P,i.availableImages,l,w,i.brightness,i.elevationFeatures),i.featureIndex.insert(O,A,P,M,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,l,u,f,p,y){this.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_b.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,xb.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,yb.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,l,u,f,p,y,w){let E;this.elevationMode!=="none"&&(E=Ri.getElevationFeature(e,w));for(const A of i)for(const P of A){const M=P.x,O=P.y;if(M<0||M>=vt||O<0||O>=vt)continue;if(p){const G=p.projectTilePoint(M,O,f),q=p.upVector(f,M,O);this.addGlobeExtVertex(G,q),this.addGlobeExtVertex(G,q),this.addGlobeExtVertex(G,q),this.addGlobeExtVertex(G,q)}const D=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),V=D.vertexLength;if(this.addCircleVertex(M,O,-1,-1),this.addCircleVertex(M,O,1,-1),this.addCircleVertex(M,O,1,1),this.addCircleVertex(M,O,-1,1),this.elevationMode!=="none"){const G=E?E.pointElevation(new ft(M,O)):0;this.hasElevation=this.hasElevation||G!==0;for(let q=0;q<4;q++)this.elevatedLayoutVertexArray.emplaceBack(G)}this.indexArray.emplaceBack(V,V+1,V+2),this.indexArray.emplaceBack(V,V+2,V+3),D.vertexLength+=4,D.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,{},u,f,y,void 0,this.worldview)}addCircleVertex(e,i,l,u){this.layoutVertexArray.emplaceBack(2*e+(l+1)/2,2*i+(u+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function eo(n,e){for(let i=0;i<n.length;i++)if(Pn(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(Pn(n,e[i]))return!0;return!!gs(n,e)}function to(n,e,i){return!!Pn(n,e)||!!Ji(e,n,i)}function Ls(n,e){if(n.length===1)return mn(e,n[0]);for(let i=0;i<e.length;i++){const l=e[i];for(let u=0;u<l.length;u++)if(Pn(n,l[u]))return!0}for(let i=0;i<n.length;i++)if(mn(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(gs(n,e[i]))return!0;return!1}function Os(n,e,i){if(n.length>1){if(gs(n,e))return!0;for(let l=0;l<e.length;l++)if(Ji(e[l],n,i))return!0}for(let l=0;l<n.length;l++)if(Ji(n[l],e,i))return!0;return!1}function gs(n,e){if(n.length===0||e.length===0)return!1;for(let i=0;i<n.length-1;i++){const l=n[i],u=n[i+1];for(let f=0;f<e.length-1;f++)if(_o(l,u,e[f],e[f+1]))return!0}return!1}function _o(n,e,i,l){return Yi(n,i,l)!==Yi(e,i,l)&&Yi(n,e,i)!==Yi(n,e,l)}function Fo(n,e,i){return(n.x-i.x)*(e.y-i.y)-(n.y-i.y)*(e.x-i.x)}function Xi(n,e,i,l){const u=Fo(n,e,l),f=Fo(n,e,i);if(Math.sign(u)===Math.sign(f))return;const p=Fo(i,l,n),y=p+f-u;return Math.sign(p)!==Math.sign(y)?[p/(p-y),f/(f-u)]:void 0}function Ji(n,e,i){const l=i*i;if(e.length===1)return n.distSqr(e[0])<l;for(let u=1;u<e.length;u++)if(Li(n,e[u-1],e[u])<l)return!0;return!1}function Li(n,e,i){const l=e.distSqr(i);if(l===0)return n.distSqr(e);const u=((n.x-e.x)*(i.x-e.x)+(n.y-e.y)*(i.y-e.y))/l;return n.distSqr(u<0?e:u>1?i:i.sub(e)._mult(u)._add(e))}function mn(n,e){let i,l,u,f=!1;for(let p=0;p<n.length;p++){i=n[p];for(let y=0,w=i.length-1;y<i.length;w=y++)l=i[y],u=i[w],l.y>e.y!=u.y>e.y&&e.x<(u.x-l.x)*(e.y-l.y)/(u.y-l.y)+l.x&&(f=!f)}return f}function Pn(n,e){let i=!1;for(let l=0,u=n.length-1;l<n.length;u=l++){const f=n[l],p=n[u];f.y>e.y!=p.y>e.y&&e.x<(p.x-f.x)*(e.y-f.y)/(p.y-f.y)+f.x&&(i=!i)}return i}function en(n,e,i,l,u){for(const p of n)if(e<=p.x&&i<=p.y&&l>=p.x&&u>=p.y)return!0;const f=[new ft(e,i),new ft(e,u),new ft(l,u),new ft(l,i)];if(n.length>2){for(const p of f)if(Pn(n,p))return!0}for(let p=0;p<n.length-1;p++)if(Xn(n[p],n[p+1],f))return!0;return!1}function Xn(n,e,i){const l=i[0],u=i[2];if(n.x<l.x&&e.x<l.x||n.x>u.x&&e.x>u.x||n.y<l.y&&e.y<l.y||n.y>u.y&&e.y>u.y)return!1;const f=Yi(n,e,i[0]);return f!==Yi(n,e,i[1])||f!==Yi(n,e,i[2])||f!==Yi(n,e,i[3])}function oa(n,e,i,l,u,f){let p=e.y-n.y,y=n.x-e.x;if(f=f||0){const w=p*p+y*y;if(w===0)return!0;const E=Math.sqrt(w);p/=E,y/=E}return!((i.x-n.x)*p+(i.y-n.y)*y-f<0||(l.x-n.x)*p+(l.y-n.y)*y-f<0||(u.x-n.x)*p+(u.y-n.y)*y-f<0)}function Aa(n,e,i,l,u,f,p){return!(oa(n,e,l,u,f,p)||oa(e,i,l,u,f,p)||oa(i,n,l,u,f,p)||oa(l,u,n,e,i,p)||oa(u,f,n,e,i,p)||oa(f,l,n,e,i,p))}function Bo(n,e,i){const l=e.paint.get(n).value;return l.kind==="constant"?l.value:i.programConfigurations.get(e.id).getMaxValue(n)}function gl(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function _l(n,e,i,l,u){if(!e[0]&&!e[1])return n;const f=ft.convert(e)._mult(u);i==="viewport"&&f._rotate(-l);const p=[];for(let y=0;y<n.length;y++)p.push(n[y].sub(f));return p}function aa(n,e,i,l){const u=ft.convert(n)._mult(l);return e==="viewport"&&u._rotate(-i),u}let su,Pa;function la(n,e,i){var l=2*Math.PI*6378137/256/Math.pow(2,i);return[n*l-2*Math.PI*6378137/2,e*l-2*Math.PI*6378137/2]}Pt(zn,"CircleBucket",{omit:["layers"]});class ka{constructor(e,i,l){this.z=e,this.x=i,this.y=l,this.key=If(0,e,e,i,l)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){const l=function(f,p,y){var w=la(256*f,256*(p=Math.pow(2,y)-p-1),y),E=la(256*(f+1),256*(p+1),y);return w[0]+","+w[1]+","+E[0]+","+E[1]}(this.x,this.y,this.z),u=function(f,p,y){let w,E="";for(let A=f;A>0;A--)w=1<<A-1,E+=(p&w?1:0)+(y&w?2:0);return E}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",u).replace("{bbox-epsg-3857}",l)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Ef{constructor(e,i){this.wrap=e,this.canonical=i,this.key=If(e,i.z,i.z,i.x,i.y)}}class _s{constructor(e,i,l,u,f){this.overscaledZ=e,this.wrap=i,this.canonical=new ka(l,+u,+f),this.key=i===0&&e===l?this.canonical.key:If(i,e,l,u,f)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new _s(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new _s(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return If(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const l=this.canonical.z-e;return If(this.wrap*+i,e,e,this.canonical.x>>l,this.canonical.y>>l)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new _s(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,l=2*this.canonical.x,u=2*this.canonical.y;return[new _s(i,this.wrap,i,l,u),new _s(i,this.wrap,i,l+1,u),new _s(i,this.wrap,i,l,u+1),new _s(i,this.wrap,i,l+1,u+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new _s(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new _s(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Ef(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function If(n,e,i,l,u){const f=1<<Math.min(i,22);let p=f*(u%f)+l%f;return n&&i<22&&(p+=f*f*((n<0?-2*n-1:2*n)%(1<<2*(22-i)))),16*(32*p+i)+(e-i)}const zR=[n=>{let e=n.canonical.x-1,i=n.wrap;return e<0&&(e=(1<<n.canonical.z)-1,i--),new _s(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>{let e=n.canonical.x+1,i=n.wrap;return e===1<<n.canonical.z&&(e=0,i++),new _s(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>new _s(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new _s(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];Pt(ka,"CanonicalTileID"),Pt(_s,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const FR=Dr([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:W0}=FR,BR=Dr([{name:"a_pos_3",components:3,type:"Int16"}]);var nT=Dr([{name:"a_pos",type:"Int16",components:2}]);function Z0(n){return n*d/z}const UR=[new Qt([k,k,k],[N,N,N]),new Qt([k,k,k],[0,0,N]),new Qt([0,k,k],[N,0,N]),new Qt([k,0,k],[0,N,N]),new Qt([0,0,k],[N,N,N])];function sT(n,e,i,l=!0){const u=rr([],n._camera.position,n.worldSize),f=[e,i,1,1];on(f,f,n.pixelMatrixInverse),In(f,f,1/f[3]);const p=Yr([],Gr([],f,u)),y=n.globeMatrix,w=[y[12],y[13],y[14]],E=Gr([],w,u),A=fr(E),P=Yr([],E),M=n.worldSize/(2*Math.PI),O=vi(P,p),D=Math.asin(M/A);if(D<Math.acos(O)){if(!l)return null;const Qe=[],Oe=[];rr(Qe,p,A/O),Yr(Oe,Gr(Oe,Qe,E)),Yr(p,Ut(p,E,rr(p,Oe,Math.tan(D)*A)))}const V=[];new Wr(u,p).closestPointOnSphere(w,M,V);const G=Yr([],Zi(y,0)),q=Yr([],Zi(y,1)),te=Yr([],Zi(y,2)),re=vi(G,V),oe=vi(q,V),xe=vi(te,V),ve=X(Math.asin(-oe/M));let Se=X(Math.atan2(re,xe));Se=n.center.lng+function(Qe,Oe){const et=(Oe-Qe+180)%360-180;return et<-180?et+360:et}(n.center.lng,Se);const Ce=ce(Se),Ae=be(ge(ve),0,1);return new He(Ce,Ae)}class VR{constructor(e,i,l){this.a=Gr([],e,l),this.b=Gr([],i,l),this.center=l;const u=Yr([],this.a),f=Yr([],this.b);this.angle=Math.acos(vi(u,f))}}function Eb(n,e){if(n.angle===0)return null;let i;return i=n.a[e]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[e]/n.a[e]/Math.sin(n.angle)-1/Math.tan(n.angle)),i<0||i>1?null:function(l,u,f,p){const y=Math.sin(f);return l*(Math.sin((1-p)*f)/y)+u*(Math.sin(p*f)/y)}(n.a[e],n.b[e],n.angle,be(i,0,1))+n.center[e]}function yl(n){if(n.z<=1)return UR[n.z+2*n.y+n.x];const e=Ib(X0(n));return Qt.fromPoints(e)}function ac(n,e,i){return rr(n,n,1-i),Nr(n,n,e,i)}function oT(n,e,i){for(const l of n)or(l,l,e),rr(l,l,i)}function aT(n,e,i,l){const u=e/n.worldSize,f=n.globeMatrix;if(i.z<=1){const Ae=yl(i).getCorners();return oT(Ae,f,u),Qt.fromPoints(Ae)}const p=X0(i,l),y=Ib(p,d+Z0(n._tileCoverLift));oT(y,f,u);const w=Number.MAX_VALUE,E=[-w,-w,-w],A=[w,w,w];if(p.contains(n.center)){for(const Oe of y)xr(A,A,Oe),Rt(E,E,Oe);E[2]=0;const Ae=n.point,Qe=[Ae.x*u,Ae.y*u,0];return xr(A,A,Qe),Rt(E,E,Qe),new Qt(A,E)}if(n._tileCoverLift>0){for(const Ae of y)xr(A,A,Ae),Rt(E,E,Ae);return new Qt(A,E)}const P=[f[12]*u,f[13]*u,f[14]*u],M=p.getCenter(),O=be(n.center.lat,-ye,ye),D=be(M.lat,-ye,ye),V=ce(n.center.lng),G=ge(O);let q=V-ce(M.lng);const te=G-ge(D);q>.5?q-=1:q<-.5&&(q+=1);let re=0;Math.abs(q)>Math.abs(te)?re=q>=0?1:3:(re=te>=0?0:2,Nr(P,P,[f[4]*u,f[5]*u,f[6]*u],-Math.sin(Re(te>=0?p.getSouth():p.getNorth()))*d));const oe=y[re],xe=y[(re+1)%4],ve=new VR(oe,xe,P),Se=[Eb(ve,0)||oe[0],Eb(ve,1)||oe[1],Eb(ve,2)||oe[2]],Ce=ou(n.zoom);if(Ce>0){const Ae=function({x:Oe,y:et,z:ct},rt,st,ht,Ke){const at=1/(1<<ct);let $e=Oe*at,Be=$e+at,pt=et*at,ut=pt+at,$t=0;const It=($e+Be)/2-ht;return It>.5?$t=-1:It<-.5&&($t=1),$e=(($e+$t)*rt-(ht*=rt))*st+ht,Be=((Be+$t)*rt-ht)*st+ht,pt=(pt*rt-(Ke*=rt))*st+Ke,ut=(ut*rt-Ke)*st+Ke,[[$e,ut,0],[Be,ut,0],[Be,pt,0],[$e,pt,0]]}(i,e,n._pixelsPerMercatorPixel,V,G);for(let Oe=0;Oe<y.length;Oe++)ac(y[Oe],Ae[Oe],Ce);const Qe=Ut([],Ae[re],Ae[(re+1)%4]);rr(Qe,Qe,.5),ac(Se,Qe,Ce)}for(const Ae of y)xr(A,A,Ae),Rt(E,E,Ae);return A[2]=Math.min(oe[2],xe[2]),xr(A,A,Se),Rt(E,E,Se),new Qt(A,E)}function X0({x:n,y:e,z:i},l=!1){const u=1/(1<<i),f=new U(_e(n*u),e===(1<<i)-1&&l?-90:me((e+1)*u)),p=new U(_e((n+1)*u),e===0&&l?90:me(e*u));return new Y(f,p)}function Ib(n,e=d){const i=Re(n.getNorth()),l=Re(n.getSouth()),u=Math.cos(i),f=Math.cos(l),p=Math.sin(i),y=Math.sin(l),w=n.getWest(),E=n.getEast();return[j(f,y,w,e),j(f,y,E,e),j(u,p,E,e),j(u,p,w,e)]}function Ym(n,e,i,l){const u=1<<i.z,f=(n/vt+i.x)/u;return R(me((e/vt+i.y)/u),_e(f),l)}function Y0({min:n,max:e}){return b/Math.max(e[0]-n[0],e[1]-n[1],e[2]-n[2])}const lT=new Float64Array(16);function K0(n){const e=Y0(n),i=tt(lT,[e,e,e]);return se(i,i,rs([],n.min))}function Cb(n){const e=(l=n.min,(i=lT)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=l[0],i[13]=l[1],i[14]=l[2],i[15]=1,i);var i,l;const u=1/Y0(n);return J(e,e,[u,u,u])}function Ab(n){const e=vt/(2*Math.PI);return n/(2*Math.PI)/e}function cT(n,e){return vt/(512*Math.pow(2,n))*Y0(yl(e))}function uT(n,e,i,l,u){const f=Ab(i),p=[n,e,-i/(2*Math.PI)],y=ae(new Float64Array(16));return se(y,y,p),J(y,y,[f,f,f]),Ee(y,y,Re(-u)),je(y,y,Re(-l)),y}function ou(n){return Ge(g,_,n)}function dT(n,e){const i=R(e.lat,e.lng),l=function(D){const V=R(D._center.lat,D._center.lng);let G=Vi([],dr(0,1,0),V);const q=it([],-D.angle,V);G=or(G,G,q),it(q,-D._pitch,G);const te=Yr([],V);return rr(te,te,Z0(D.cameraToCenterDistance/D.pixelsPerMeter)),or(te,te,q),Ut([],V,te)}(n);return p=(u=jr([],l,i))[0],y=u[1],w=u[2],E=(f=i)[0],A=f[1],P=f[2],O=(M=Math.sqrt((p*p+y*y+w*w)*(E*E+A*A+P*P)))&&vi(u,f)/M,Math.acos(Math.min(Math.max(O,-1),1));var u,f,p,y,w,E,A,P,M,O}function Pb(n,e){return dT(n,e)>Math.PI/2*1.01}const hT=Re(85),$R=Math.cos(hT),GR=Math.sin(hT),qR=ie(),fT=n=>{const e=[];return n.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function pT(n,e,i,l,u,f,p,y,w){if(f&&n.queryGeometry.isAboveHorizon)return!1;f&&(w*=n.pixelToTileUnitsFactor);const E=n.tileID.canonical,A=i.projection.upVectorScale(E,i.center.lat,i.worldSize).metersToTile;for(const P of e)for(const M of P){const O=M.add(y),D=u&&i.elevation?i.elevation.exaggeration()*u.getElevationAt(O.x,O.y,!0):0,V=i.projection.projectTilePoint(O.x,O.y,E);if(D>0){const re=i.projection.upVector(E,O.x,O.y);V.x+=re[0]*A*D,V.y+=re[1]*A*D,V.z+=re[2]*A*D}const G=f?O:HR(V.x,V.y,V.z,l),q=f?n.tilespaceRays.map(re=>ZR(re,D)):n.queryGeometry.screenGeometry,te=on([],[V.x,V.y,V.z,1],l);if(!p&&f?w*=te[3]/i.cameraToCenterDistance:p&&!f&&(w*=i.cameraToCenterDistance/te[3]),f){const re=me((M.y/vt+E.y)/(1<<E.z));w/=i.projection.pixelsPerMeter(re,1)/pe(1,re)}if(to(q,G,w))return!0}return!1}function HR(n,e,i,l){const u=on([],[n,e,i,1],l);return new ft(u[0]/u[3],u[1]/u[3])}const mT=dr(0,0,0),WR=dr(0,0,1);function ZR(n,e){const i=Nt();return mT[2]=e,n.intersectsPlane(mT,WR,i),new ft(i[0],i[1])}class gT extends zn{}let _T,yT,xT,vT;function bT(n,{width:e,height:i},l,u){if(u){if(u instanceof Uint8ClampedArray)u=new Uint8Array(u.buffer);else if(u.length!==e*i*l)throw new RangeError("mismatched image size")}else u=new Uint8Array(e*i*l);return n.width=e,n.height=i,n.data=u,n}function wT(n,e,i){const{width:l,height:u}=e;l===n.width&&u===n.height||(kb(n,e,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,l),height:Math.min(n.height,u)},i,null),n.width=l,n.height=u,n.data=e.data)}function kb(n,e,i,l,u,f,p,y){if(u.width===0||u.height===0)return e;if(u.width>n.width||u.height>n.height||i.x>n.width-u.width||i.y>n.height-u.height)throw new RangeError("out of range source coordinates for image copy");if(u.width>e.width||u.height>e.height||l.x>e.width-u.width||l.y>e.height-u.height)throw new RangeError("out of range destination coordinates for image copy");const w=n.data,E=e.data,A=f===4&&y;for(let P=0;P<u.height;P++){const M=((i.y+P)*n.width+i.x)*f,O=((l.y+P)*e.width+l.x)*f;if(A)for(let D=0;D<u.width;D++){const V=M+D*f+3,G=O+D*f;E[G+0]=255,E[G+1]=255,E[G+2]=255,E[G+3]=w[V]}else if(p)for(let D=0;D<u.width;D++){const V=M+D*f,G=O+D*f,q=new ti(w[V+0]/255,w[V+1]/255,w[V+2]/255,w[V+3]).toNonPremultipliedRenderColor(p).toArray();E[G+0]=q[0],E[G+1]=q[1],E[G+2]=q[2],E[G+3]=q[3]}else for(let D=0;D<u.width*f;D++)E[O+D]=w[M+D]}return e}Pt(gT,"HeatmapBucket",{omit:["layers"]});class au{constructor(e,i){bT(this,e,1,i)}resize(e){wT(this,new au(e),1)}clone(){return new au({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,l,u,f){kb(e,i,l,u,f,1,null)}}class Yn{constructor(e,i){bT(this,e,4,i)}resize(e){wT(this,new Yn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Yn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,l,u,f,p,y){kb(e,i,l,u,f,4,p,y)}}class ST{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Km(n){const e={},i=n.resolution||256,l=n.clips?n.clips.length:1,u=n.image||new Yn({width:i,height:l}),f=(p,y,w)=>{e[n.evaluationKey]=w;const E=n.expression.evaluate(e),A=E?E.toNonPremultipliedRenderColor(null):null;A&&(u.data[p+y+0]=Math.floor(255*A.r),u.data[p+y+1]=Math.floor(255*A.g),u.data[p+y+2]=Math.floor(255*A.b),u.data[p+y+3]=Math.floor(255*A.a))};if(n.clips)for(let p=0,y=0;p<l;++p,y+=4*i)for(let w=0,E=0;w<i;w++,E+=4){const A=w/(i-1),{start:P,end:M}=n.clips[p];f(y,E,P*(1-A)+M*A)}else for(let p=0,y=0;p<i;p++,y+=4)f(0,y,p/(i-1));return u}Pt(au,"AlphaImage"),Pt(Yn,"RGBAImage");const XR=Dr([{name:"a_pos",components:2,type:"Int16"}],4),YR=Dr([{name:"a_road_z_offset",components:1,type:"Float32"}],4),KR=Dr([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),JR=Dr([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Cf(n,e,i=2){const l=e&&e.length,u=l?e[0]*i:n.length;let f=TT(n,0,u,i,!0);const p=[];if(!f||f.next===f.prev)return p;let y,w,E;if(l&&(f=function(A,P,M,O){const D=[];for(let V=0,G=P.length;V<G;V++){const q=TT(A,P[V]*O,V<G-1?P[V+1]*O:A.length,O,!1);q===q.next&&(q.steiner=!0),D.push(o3(q))}D.sort(i3);for(let V=0;V<D.length;V++)M=n3(D[V],M);return M}(n,e,f,i)),n.length>80*i){y=n[0],w=n[1];let A=y,P=w;for(let M=i;M<u;M+=i){const O=n[M],D=n[M+1];O<y&&(y=O),D<w&&(w=D),O>A&&(A=O),D>P&&(P=D)}E=Math.max(A-y,P-w),E=E!==0?32767/E:0}return Jm(f,p,i,y,w,E,0),p}function TT(n,e,i,l,u){let f;if(u===function(p,y,w,E){let A=0;for(let P=y,M=w-E;P<w;P+=E)A+=(p[M]-p[P])*(p[P+1]+p[M+1]),M=P;return A}(n,e,i,l)>0)for(let p=e;p<i;p+=l)f=AT(p/l|0,n[p],n[p+1],f);else for(let p=i-l;p>=e;p-=l)f=AT(p/l|0,n[p],n[p+1],f);return f&&Af(f,f.next)&&(tg(f),f=f.next),f}function Nd(n,e){if(!n)return n;e||(e=n);let i,l=n;do if(i=!1,l.steiner||!Af(l,l.next)&&Rn(l.prev,l,l.next)!==0)l=l.next;else{if(tg(l),l=e=l.prev,l===l.next)break;i=!0}while(i||l!==e);return e}function Jm(n,e,i,l,u,f,p){if(!n)return;!p&&f&&function(w,E,A,P){let M=w;do M.z===0&&(M.z=Mb(M.x,M.y,E,A,P)),M.prevZ=M.prev,M.nextZ=M.next,M=M.next;while(M!==w);M.prevZ.nextZ=null,M.prevZ=null,function(O){let D,V=1;do{let G,q=O;O=null;let te=null;for(D=0;q;){D++;let re=q,oe=0;for(let ve=0;ve<V&&(oe++,re=re.nextZ,re);ve++);let xe=V;for(;oe>0||xe>0&&re;)oe!==0&&(xe===0||!re||q.z<=re.z)?(G=q,q=q.nextZ,oe--):(G=re,re=re.nextZ,xe--),te?te.nextZ=G:O=G,G.prevZ=te,te=G;q=re}te.nextZ=null,V*=2}while(D>1)}(M)}(n,l,u,f);let y=n;for(;n.prev!==n.next;){const w=n.prev,E=n.next;if(f?e3(n,l,u,f):QR(n))e.push(w.i,n.i,E.i),tg(n),n=E.next,y=E.next;else if((n=E)===y){p?p===1?Jm(n=t3(Nd(n),e),e,i,l,u,f,2):p===2&&r3(n,e,i,l,u,f):Jm(Nd(n),e,i,l,u,f,1);break}}}function QR(n){const e=n.prev,i=n,l=n.next;if(Rn(e,i,l)>=0)return!1;const u=e.x,f=i.x,p=l.x,y=e.y,w=i.y,E=l.y,A=Math.min(u,f,p),P=Math.min(y,w,E),M=Math.max(u,f,p),O=Math.max(y,w,E);let D=l.next;for(;D!==e;){if(D.x>=A&&D.x<=M&&D.y>=P&&D.y<=O&&Qm(u,y,f,w,p,E,D.x,D.y)&&Rn(D.prev,D,D.next)>=0)return!1;D=D.next}return!0}function e3(n,e,i,l){const u=n.prev,f=n,p=n.next;if(Rn(u,f,p)>=0)return!1;const y=u.x,w=f.x,E=p.x,A=u.y,P=f.y,M=p.y,O=Math.min(y,w,E),D=Math.min(A,P,M),V=Math.max(y,w,E),G=Math.max(A,P,M),q=Mb(O,D,e,i,l),te=Mb(V,G,e,i,l);let re=n.prevZ,oe=n.nextZ;for(;re&&re.z>=q&&oe&&oe.z<=te;){if(re.x>=O&&re.x<=V&&re.y>=D&&re.y<=G&&re!==u&&re!==p&&Qm(y,A,w,P,E,M,re.x,re.y)&&Rn(re.prev,re,re.next)>=0||(re=re.prevZ,oe.x>=O&&oe.x<=V&&oe.y>=D&&oe.y<=G&&oe!==u&&oe!==p&&Qm(y,A,w,P,E,M,oe.x,oe.y)&&Rn(oe.prev,oe,oe.next)>=0))return!1;oe=oe.nextZ}for(;re&&re.z>=q;){if(re.x>=O&&re.x<=V&&re.y>=D&&re.y<=G&&re!==u&&re!==p&&Qm(y,A,w,P,E,M,re.x,re.y)&&Rn(re.prev,re,re.next)>=0)return!1;re=re.prevZ}for(;oe&&oe.z<=te;){if(oe.x>=O&&oe.x<=V&&oe.y>=D&&oe.y<=G&&oe!==u&&oe!==p&&Qm(y,A,w,P,E,M,oe.x,oe.y)&&Rn(oe.prev,oe,oe.next)>=0)return!1;oe=oe.nextZ}return!0}function t3(n,e){let i=n;do{const l=i.prev,u=i.next.next;!Af(l,u)&&IT(l,i,i.next,u)&&eg(l,u)&&eg(u,l)&&(e.push(l.i,i.i,u.i),tg(i),tg(i.next),i=n=u),i=i.next}while(i!==n);return Nd(i)}function r3(n,e,i,l,u,f){let p=n;do{let y=p.next.next;for(;y!==p.prev;){if(p.i!==y.i&&a3(p,y)){let w=CT(p,y);return p=Nd(p,p.next),w=Nd(w,w.next),Jm(p,e,i,l,u,f,0),void Jm(w,e,i,l,u,f,0)}y=y.next}p=p.next}while(p!==n)}function i3(n,e){let i=n.x-e.x;return i===0&&(i=n.y-e.y,i===0)&&(i=(n.next.y-n.y)/(n.next.x-n.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function n3(n,e){const i=function(u,f){let p=f;const y=u.x,w=u.y;let E,A=-1/0;if(Af(u,p))return p;do{if(Af(u,p.next))return p.next;if(w<=p.y&&w>=p.next.y&&p.next.y!==p.y){const V=p.x+(w-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(V<=y&&V>A&&(A=V,E=p.x<p.next.x?p:p.next,V===y))return E}p=p.next}while(p!==f);if(!E)return null;const P=E,M=E.x,O=E.y;let D=1/0;p=E;do{if(y>=p.x&&p.x>=M&&y!==p.x&&ET(w<O?y:A,w,M,O,w<O?A:y,w,p.x,p.y)){const V=Math.abs(w-p.y)/(y-p.x);eg(p,u)&&(V<D||V===D&&(p.x>E.x||p.x===E.x&&s3(E,p)))&&(E=p,D=V)}p=p.next}while(p!==P);return E}(n,e);if(!i)return e;const l=CT(i,n);return Nd(l,l.next),Nd(i,i.next)}function s3(n,e){return Rn(n.prev,n,e.prev)<0&&Rn(e.next,n,n.next)<0}function Mb(n,e,i,l,u){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*u|0)|n<<8))|n<<4))|n<<2))|n<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-l)*u|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function o3(n){let e=n,i=n;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==n);return i}function ET(n,e,i,l,u,f,p,y){return(u-p)*(e-y)>=(n-p)*(f-y)&&(n-p)*(l-y)>=(i-p)*(e-y)&&(i-p)*(f-y)>=(u-p)*(l-y)}function Qm(n,e,i,l,u,f,p,y){return!(n===p&&e===y)&&ET(n,e,i,l,u,f,p,y)}function a3(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!function(i,l){let u=i;do{if(u.i!==i.i&&u.next.i!==i.i&&u.i!==l.i&&u.next.i!==l.i&&IT(u,u.next,i,l))return!0;u=u.next}while(u!==i);return!1}(n,e)&&(eg(n,e)&&eg(e,n)&&function(i,l){let u=i,f=!1;const p=(i.x+l.x)/2,y=(i.y+l.y)/2;do u.y>y!=u.next.y>y&&u.next.y!==u.y&&p<(u.next.x-u.x)*(y-u.y)/(u.next.y-u.y)+u.x&&(f=!f),u=u.next;while(u!==i);return f}(n,e)&&(Rn(n.prev,n,e.prev)||Rn(n,e.prev,e))||Af(n,e)&&Rn(n.prev,n,n.next)>0&&Rn(e.prev,e,e.next)>0)}function Rn(n,e,i){return(e.y-n.y)*(i.x-e.x)-(e.x-n.x)*(i.y-e.y)}function Af(n,e){return n.x===e.x&&n.y===e.y}function IT(n,e,i,l){const u=Q0(Rn(n,e,i)),f=Q0(Rn(n,e,l)),p=Q0(Rn(i,l,n)),y=Q0(Rn(i,l,e));return u!==f&&p!==y||!(u!==0||!J0(n,i,e))||!(f!==0||!J0(n,l,e))||!(p!==0||!J0(i,n,l))||!(y!==0||!J0(i,e,l))}function J0(n,e,i){return e.x<=Math.max(n.x,i.x)&&e.x>=Math.min(n.x,i.x)&&e.y<=Math.max(n.y,i.y)&&e.y>=Math.min(n.y,i.y)}function Q0(n){return n>0?1:n<0?-1:0}function eg(n,e){return Rn(n.prev,n,n.next)<0?Rn(n,e,n.next)>=0&&Rn(n,n.prev,e)>=0:Rn(n,e,n.prev)<0||Rn(n,n.next,e)<0}function CT(n,e){const i=Nb(n.i,n.x,n.y),l=Nb(e.i,e.x,e.y),u=n.next,f=e.prev;return n.next=e,e.prev=n,i.next=u,u.prev=i,l.next=i,i.prev=l,f.next=l,l.prev=f,l}function AT(n,e,i,l){const u=Nb(n,e,i);return l?(u.next=l.next,u.prev=l,l.next.prev=u,l.next=u):(u.prev=u,u.next=u),u}function tg(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function Nb(n,e,i){return{i:n,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function rg(n,e){const i=n.length;if(i<=1)return[n];const l=[];let u,f;for(let p=0;p<i;p++){const y=dn(n[p]);y!==0&&(n[p].area=Math.abs(y),f===void 0&&(f=y<0),f===y<0?(u&&l.push(u),u=[n[p]]):u.push(n[p]))}if(u&&l.push(u),e>1)for(let p=0;p<l.length;p++)l[p].length<=e||(t0(l[p],e,1,l[p].length-1,l3),l[p]=l[p].slice(0,e));return l}function l3(n,e){return e.area-n.area}function PT(n,e,i=1){if(!n)return null;const l=typeof n=="string"?Is.from(n).getPrimary():n.getPrimary(),u=typeof n=="string"?null:n.getSecondary();for(const f of[l,u]){if(!f)continue;const p=f.id.toString();e.has(p)||e.set(p,[]),f.scaleSelf(i),e.get(p).push(f)}return{primary:l.toString(),secondary:u?u.toString():null}}function Rb(n,e,i,l){const u=l.patternDependencies;let f=!1;for(const p of e){const y=p.paint.get(`${n}-pattern`);y.isConstant()||(f=!0),PT(y.constantOr(null),u,i)&&(f=!0)}return f}function Lb(n,e,i,l,u,f){const p=f.patternDependencies;for(const y of e){const w=y.paint.get(`${n}-pattern`).value;if(w.kind!=="constant"){let E=w.evaluate({zoom:l},i,{},f.availableImages);E=E&&E.name?E.name:E;const A=PT(E,p,u);if(!A)continue;const{primary:P,secondary:M}=A;P&&(i.patterns[y.id]=[P,M].filter(Boolean))}}return i}class kT{constructor(){this.polygons=new Map}add(e,...i){const l=this.polygons.get(e);l?l.push(...i):this.polygons.set(e,i)}merge(e){for(const[i,l]of e.polygons)this.add(i,...l)}}class lc{constructor(){this.portals=[]}static isOnBorder(e,i){return e<=0&&i<=0||e>=vt&&i>=vt}static evaluate(e){if(e.length===0)return new lc;let i=[];for(const w of e)i.push(...w.portals);if(i.length===0)return new lc;for(const w of i){const E=w.va,A=w.vb;(lc.isOnBorder(E.x,A.x)||lc.isOnBorder(E.y,A.y))&&(w.type="border")}const l=i.filter(w=>w.type!=="unevaluated"),u=i.filter(w=>w.type==="unevaluated");if(u.length===0)return new lc;u.sort((w,E)=>w.hash===E.hash?w.isTunnel===E.isTunnel?0:w.isTunnel?-1:1:w.hash<E.hash?1:-1),i=l.concat(u);let f=l.length,p=f,y=f;do if(p++,p===i.length||i[f].hash!==i[p].hash){if(p-f==2){y<f&&(i[y]=i[f],i[f]=null);const w=i[y],E=i[p-1];w.type=w.isTunnel!==E.isTunnel?"tunnel":"polygon",w.connection={a:w.connection.a,b:E.connection.a},y++}f=p}while(f!==i.length);return i.splice(y),i.sort((w,E)=>w.hash<E.hash?1:-1),{portals:i}}}Pt(lc,"ElevationPortalGraph"),Pt(kT,"ElevationPolygons");class c3{constructor(e,i,l){this.outPositions=e,this.outNormals=i,this.outIndices=l,this.vertexLookup=new Map}addVertex(e,i,l){let u=e[2];l!=null&&(u*=l);const f=`${e[0]},${e[1]},${e[2]},${i[0]},${i[1]},${i[2]}`,p=this.vertexLookup.get(f);if(p!=null)return p;const y=this.outPositions.length;this.vertexLookup.set(f,y);const w=Math.trunc(16384*i[0]),E=Math.trunc(16384*i[1]),A=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],u),this.outNormals.emplaceBack(w,E,A),y}addTriangle(e,i,l){this.outIndices.emplaceBack(e,i,l)}addTriangles(e,i,l){if(e.length===0)return;const u=l.length===1,f=Nt(),p=Nt();for(let y=0;y<e.length;y+=3){const w=i[e[y+0]],E=i[e[y+1]],A=i[e[y+2]],P=u?l[0]:l[e[y+1]],M=u?l[0]:l[e[y+2]];cr(f,w.x,w.y,u?l[0]:l[e[y+0]]);const O=this.addVertex(f,p);cr(f,E.x,E.y,P);const D=this.addVertex(f,p);cr(f,A.x,A.y,M);const V=this.addVertex(f,p);this.outIndices.emplaceBack(O,D,V)}}addQuad(e,i,l,u,f,p){const y=this.addVertex(e,f,p),w=this.addVertex(i,f,p),E=this.addVertex(l,f,p),A=this.addVertex(u,f,p);this.addTriangle(y,w,E),this.addTriangle(E,A,y)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class ro{constructor(e,i,l,u){this.unevaluatedPortals=new lc,this.portalPolygons=new kT,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new jm,this.vertexNormals=new pf,this.indexArray=new bn,this.tileToMeters=De(e),this.bridgeProgramConfigurations=new zo(i,{zoom:l,lut:u},f=>f!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new zo(i,{zoom:l,lut:u},f=>f!=="fill-bridge-guard-rail-color")}addVertices(e,i){const l=this.unevalVertices.length;for(let u=0;u<e.length;u++)this.unevalVertices.push(e[u]),this.unevalHeights.push(i[u]);return l}addTriangles(e,i,l){const u=l?this.unevalTunnelTriangles:this.unevalTriangles;for(const f of e)u.push(f+i)}addRenderableRing(e,i,l,u,f,p){const y=[new ft(f.min.x,f.min.y),new ft(f.max.x,f.min.y),new ft(f.max.x,f.max.y),new ft(f.min.x,f.max.y)];for(let w=0;w<l-1;w++){const E=i+w,A=E+1,P=this.unevalVertices[E],M=this.unevalVertices[A];if(!(P.x>=f.min.x&&P.x<=f.max.x&&P.y>=f.min.y&&P.y<=f.max.y||M.x>=f.min.x&&M.x<=f.max.x&&M.y>=f.min.y&&M.y<=f.max.y||Xn(P,M,y))||this.isOnBorder(P.x,M.x)||this.isOnBorder(P.y,M.y))continue;const O=ro.computeEdgeHash(this.unevalVertices[E],this.unevalVertices[A]);let D,V=this.vertexHashLookup.get(ro.computePosHash(P));V!=null?D=V.next:(V=this.vertexHashLookup.get(ro.computePosHash(M)),D=V!=null?V.prev:O),this.unevalEdges.push({polygonIdx:e,a:E,b:A,hash:O,portalHash:D,isTunnel:u,type:"unevaluated",featureInfo:p})}}addPortalCandidates(e,i,l,u,f){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:f});const p=i[0];this.vertexHashLookup.clear();let y=ro.computeEdgeHash(p[p.length-2],p[p.length-1]);for(let w=0;w<p.length-1;w++){const E=p[w+0],A=p[w+1],P=Ao(A.x-E.x,A.y-E.y),M=Ll(P);if(M===0)continue;let O="unevaluated";const D=u.pointElevation(E),V=u.pointElevation(A);Math.abs(D)<.01&&Math.abs(V)<.01?O="entrance":(this.isOnBorder(E.x,A.x)||this.isOnBorder(E.y,A.y))&&(O="border");const G=ro.computeEdgeHash(E,A);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:E,vb:A,vab:P,length:M,hash:G,isTunnel:l,type:O});const q=ro.computePosHash(E);this.vertexHashLookup.set(q,{prev:y,next:G}),y=G}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),l=M=>{M.primitiveLength=this.indexArray.length-M.primitiveOffset},u=new c3(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const f=i(),p=i(),y=i(),w=(M,O)=>{M.sort((V,G)=>V.type===O&&G.type!==O?-1:V.type!==O&&G.type===O?1:0);const D=M.findIndex(V=>V.type!==O);return D>=0?D:M.length};let E=0;this.unevalEdges.length>0&&(E=w(this.unevalEdges,"none"),this.constructBridgeStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:E},this.tileToMeters)),l(y);const A=i(),P=i();if(this.unevalEdges.length>0){const M=this.unevalEdges.splice(E),O=w(M,"tunnel")+E;this.unevalEdges.push(...M),this.constructTunnelStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:E},{min:E,max:O})}l(A),u.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),l(P),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),l(p),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),l(f),this.maskSegments=Fi.simpleSegment(0,P.primitiveOffset,0,P.primitiveLength),this.depthSegments=Fi.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.renderableBridgeSegments=Fi.simpleSegment(0,y.primitiveOffset,0,y.primitiveLength),this.renderableTunnelSegments=Fi.simpleSegment(0,A.primitiveOffset,0,A.primitiveLength),this.shadowCasterSegments=Fi.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength)}update(e,i,l,u,f,p,y,w){this.bridgeProgramConfigurations.updatePaintArrays(e,i,f,l,u,p,y,w),this.tunnelProgramConfigurations.updatePaintArrays(e,i,f,l,u,p,y,w)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,KR.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,JR.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,l,u,f){const p=(y,w)=>{for(let E=0;E<w.length-1;E++){const A=w[E].featureIndex,P=w[E+1].vertexStart,M=e.feature(A);y.populatePaintArrays(P,M,A,{},l,i,u,void 0,f)}};p(this.bridgeProgramConfigurations,this.bridgeFeatureSections),p(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,l,u,f){const p=new Map;for(let y=u;y<f;y++){const w=l[y],E=w.a,A=w.b,P=ro.computePosHash(e[E]),M=ro.computePosHash(e[A]);let O=p.get(P);O||(O={},p.set(P,O));let D=p.get(M);D||(D={},p.set(M,D)),i[E]<=0&&i[A]<=0||(O.to=A,D.from=E)}return p}isTerminalVertex(e,i){const l=ro.computePosHash(this.unevalVertices[e]),u=i.get(l);return!u||!u.from||!u.to}constructBridgeStructures(e,i,l,u,f,p){e.clearVertexLookup();const y=this.computeVertexConnections(i,l,u,f.min,f.max),w=1/p,E=.5*w,A=(st,ht)=>cr(st,i[ht].x,i[ht].y,l[ht]*w),P=Nt(),M=Nt(),O=Nt(),D=Nt(),V=Nt(),G=(st,ht)=>{const Ke=y.get(ro.computePosHash(i[ht])),at=Ke.from,$e=Ke.to;if(!at||!$e)return;A(P,at),A(M,ht),A(O,$e),Di(D),oi(P,M)||(Gr(V,M,P),Yr(D,V)),oi(O,M)||(Gr(V,O,M),Ut(D,D,Yr(V,V)));const Be=Zn(D);return Be>0?rr(st,D,1/Be):void 0};let q=Number.POSITIVE_INFINITY;this.sortSubarray(u,f.min,f.max,(st,ht)=>st.featureInfo.featureIndex-ht.featureInfo.featureIndex);const te=Nt(),re=Nt(),oe=Nt(),xe=Nt(),ve=Nt(),Se=Nt(),Ce=Nt(),Ae=Nt(),Qe=Nt(),Oe=[Nt(),Nt(),Nt(),Nt()],et=[Nt(),Nt(),Nt(),Nt()],ct=[{coord:new ft(0,0),height:0},{coord:new ft(0,0),height:0}],rt=(st,ht)=>st>ht;for(let st=f.min;st<f.max;st++){const ht=u[st];if(!ht.featureInfo.guardRailEnabled||!this.prepareEdgePoints(ct,i,l,ht,rt))continue;const[Ke,at]=ct;if(cr(te,Ke.coord.x,Ke.coord.y,w*Ke.height),cr(re,at.coord.x,at.coord.y,w*at.height),oi(te,re))continue;Gr(oe,re,te),Yr(oe,oe);const $e=G(Ae,ht.a)||oe,Be=G(Qe,ht.b)||oe;cr(xe,$e[1],-$e[0],0),Yr(xe,xe),cr(ve,Be[1],-Be[0],0),Yr(ve,ve),Vi(Ae,xe,$e),Yr(Se,Ae),Vi(Ae,ve,Be),Yr(Ce,Ae),Ut(Oe[0],te,rr(Ae,Gr(Ae,xe,Se),E)),Ut(Oe[1],te,rr(Ae,Ut(Ae,xe,Se),E)),Ut(Oe[2],te,rr(Ae,Se,E)),Oe[3]=te,Ut(et[0],re,rr(Ae,Gr(Ae,ve,Ce),E)),Ut(et[1],re,rr(Ae,Ut(Ae,ve,Ce),E)),Ut(et[2],re,rr(Ae,Ce,E)),et[3]=re,q=this.addFeatureSection(ht.featureInfo.featureIndex,q,this.bridgeFeatureSections,e);const pt=e.addVertex(Oe[0],xe,p),ut=e.addVertex(Oe[1],xe,p),$t=e.addVertex(et[0],ve,p),It=e.addVertex(et[1],ve,p);e.addTriangle(pt,ut,$t),e.addTriangle(ut,It,$t);const Lt=e.addVertex(Oe[1],Se,p),xt=e.addVertex(Oe[2],Se,p),Bt=e.addVertex(et[1],Ce,p),sr=e.addVertex(et[2],Ce,p);e.addTriangle(Lt,xt,Bt),e.addTriangle(xt,sr,Bt),rs(xe,xe),rs(ve,ve);const St=e.addVertex(Oe[2],xe,p),jt=e.addVertex(Oe[3],xe,p),Kt=e.addVertex(et[2],ve,p),ur=e.addVertex(et[3],ve,p);e.addTriangle(St,jt,Kt),e.addTriangle(jt,ur,Kt);const Ir=this.isTerminalVertex(ht.a,y),mr=this.isTerminalVertex(ht.b,y);Ke.height<.01&&Ir&&e.addQuad(Oe[3],Oe[2],Oe[1],Oe[0],rs($e,$e),p),at.height<.01&&mr&&e.addQuad(et[0],et[1],et[2],et[3],Be,p)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,l,u,f,p){e.clearVertexLookup();let y=Number.POSITIVE_INFINITY;const w=(q,te)=>q.featureInfo.featureIndex-te.featureInfo.featureIndex;this.sortSubarray(u,f.min,f.max,w),this.sortSubarray(u,p.min,p.max,w);const E=q=>Yr(q,q),A=[{coord:new ft(0,0),height:0},{coord:new ft(0,0),height:0}],P=(q,te)=>q<te,M=Nt(),O=Nt(),D=Nt(),V=Nt(),G=Nt();for(let q=f.min;q<f.max;q++){if(!this.prepareEdgePoints(A,i,l,u[q],P))continue;const[te,re]=A,oe=E(cr(G,-(re.coord.y-te.coord.y),re.coord.x-te.coord.x,0));y=this.addFeatureSection(u[q].featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad(cr(M,te.coord.x,te.coord.y,te.height),cr(O,re.coord.x,re.coord.y,re.height),cr(D,re.coord.x,re.coord.y,u[q].isTunnel?-.1:0),cr(V,te.coord.x,te.coord.y,u[q].isTunnel?-.1:0),oe)}for(let q=p.min;q<p.max;q++){const te=u[q];te.isTunnel&&([te.a,te.b]=[te.b,te.a]);const re=i[te.a],oe=i[te.b],xe=E(cr(G,-(oe.y-re.y),oe.x-re.x,0));y=this.addFeatureSection(te.featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad(cr(M,oe.x,oe.y,0),cr(O,re.x,re.y,0),cr(D,re.x,re.y,l[te.a]+4),cr(V,oe.x,oe.y,l[te.b]+4),xe),e.addQuad(cr(M,re.x,re.y,0),cr(O,oe.x,oe.y,0),cr(D,oe.x,oe.y,l[te.b]+4),cr(V,re.x,re.y,l[te.a]+4),xe)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,l,u){e.coord.x=i,e.coord.y=l,e.height=u}prepareEdgePoints(e,i,l,u,f){let p=i[u.a].x,y=i[u.a].y,w=i[u.b].x,E=i[u.b].y,A=l[u.a],P=l[u.b];const M=f(A,0),O=f(P,0);if(M&&O)return this.setElevatedPoint(e[0],p,y,A),this.setElevatedPoint(e[1],w,E,P),!0;if(!M&&!O)return!1;if(M){if(!O){const D=P/(P-A);w=Yt(w,p,D),E=Yt(E,y,D),P=Yt(P,A,D)}}else{const D=A/(A-P);p=Yt(p,w,D),y=Yt(y,E,D),A=Yt(A,P,D)}return this.setElevatedPoint(e[0],p,y,A),this.setElevatedPoint(e[1],w,E,P),!0}prepareEdges(e,i){if(i.length===0)return;i.sort((y,w)=>y.hash===w.hash?w.polygonIdx-y.polygonIdx:w.hash>y.hash?1:-1);let l=0,u=0,f=0,p=i[l].polygonIdx;do u++,(u===i.length||i[l].hash!==i[u].hash)&&((u-l==1||i[u-1].polygonIdx!==p)&&(f<l&&(i[f]=i[l],i[l]=null),i[f].type="none",f++),l=u,l!==i.length&&(p=i[l].polygonIdx));while(l!==i.length);if(i.splice(f),i.length!==0&&e.length!==0){i.sort((E,A)=>E.portalHash<A.portalHash?1:-1);let y=0,w=0;for(;y!==i.length&&w!==e.length;){const E=i[y],A=e[w];E.portalHash>A.hash?y++:A.hash>E.portalHash?w++:(E.type=A.type,y++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=vt&&i>=vt}addFeatureSection(e,i,l,u){return e!==i&&(i=e,l.push({featureIndex:e,vertexStart:u.getVertexCount()}),u.clearVertexLookup()),i}sortSubarray(e,i,l,u){const f=e.slice(i,l);f.sort(u),e.splice(i,f.length,...f)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(ro.computePosHash(e))<<32n|BigInt(ro.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var MT,NT={exports:{}},RT=(MT||(MT=1,function(n,e){(function(i){function l(ue,de){return ue>de?1:ue<de?-1:0}var u=function(ue,de){ue===void 0&&(ue=l),de===void 0&&(de=!1),this._compare=ue,this._root=null,this._size=0,this._noDuplicates=!!de},f={size:{configurable:!0}};function p(ue,de,Ve,Je,wt){var bt=wt-Je;if(bt>0){var kt=Je+Math.floor(bt/2),qt={key:de[kt],data:Ve[kt],parent:ue};return qt.left=p(qt,de,Ve,Je,kt),qt.right=p(qt,de,Ve,kt+1,wt),qt}return null}function y(ue,de,Ve,Je,wt){if(!(Ve>=Je)){for(var bt=ue[Ve+Je>>1],kt=Ve-1,qt=Je+1;;){do kt++;while(wt(ue[kt],bt)<0);do qt--;while(wt(ue[qt],bt)>0);if(kt>=qt)break;var Cr=ue[kt];ue[kt]=ue[qt],ue[qt]=Cr,Cr=de[kt],de[kt]=de[qt],de[qt]=Cr}y(ue,de,Ve,qt,wt),y(ue,de,qt+1,Je,wt)}}u.prototype.rotateLeft=function(ue){var de=ue.right;de&&(ue.right=de.left,de.left&&(de.left.parent=ue),de.parent=ue.parent),ue.parent?ue===ue.parent.left?ue.parent.left=de:ue.parent.right=de:this._root=de,de&&(de.left=ue),ue.parent=de},u.prototype.rotateRight=function(ue){var de=ue.left;de&&(ue.left=de.right,de.right&&(de.right.parent=ue),de.parent=ue.parent),ue.parent?ue===ue.parent.left?ue.parent.left=de:ue.parent.right=de:this._root=de,de&&(de.right=ue),ue.parent=de},u.prototype._splay=function(ue){for(;ue.parent;){var de=ue.parent;de.parent?de.left===ue&&de.parent.left===de?(this.rotateRight(de.parent),this.rotateRight(de)):de.right===ue&&de.parent.right===de?(this.rotateLeft(de.parent),this.rotateLeft(de)):de.left===ue&&de.parent.right===de?(this.rotateRight(de),this.rotateLeft(de)):(this.rotateLeft(de),this.rotateRight(de)):de.left===ue?this.rotateRight(de):this.rotateLeft(de)}},u.prototype.splay=function(ue){for(var de,Ve,Je,wt,bt;ue.parent;)(Ve=(de=ue.parent).parent)&&Ve.parent?((Je=Ve.parent).left===Ve?Je.left=ue:Je.right=ue,ue.parent=Je):(ue.parent=null,this._root=ue),wt=ue.left,bt=ue.right,ue===de.left?(Ve&&(Ve.left===de?(de.right?(Ve.left=de.right,Ve.left.parent=Ve):Ve.left=null,de.right=Ve,Ve.parent=de):(wt?(Ve.right=wt,wt.parent=Ve):Ve.right=null,ue.left=Ve,Ve.parent=ue)),bt?(de.left=bt,bt.parent=de):de.left=null,ue.right=de,de.parent=ue):(Ve&&(Ve.right===de?(de.left?(Ve.right=de.left,Ve.right.parent=Ve):Ve.right=null,de.left=Ve,Ve.parent=de):(bt?(Ve.left=bt,bt.parent=Ve):Ve.left=null,ue.right=Ve,Ve.parent=ue)),wt?(de.right=wt,wt.parent=de):de.right=null,ue.left=de,de.parent=ue)},u.prototype.replace=function(ue,de){ue.parent?ue===ue.parent.left?ue.parent.left=de:ue.parent.right=de:this._root=de,de&&(de.parent=ue.parent)},u.prototype.minNode=function(ue){if(ue===void 0&&(ue=this._root),ue)for(;ue.left;)ue=ue.left;return ue},u.prototype.maxNode=function(ue){if(ue===void 0&&(ue=this._root),ue)for(;ue.right;)ue=ue.right;return ue},u.prototype.insert=function(ue,de){var Ve=this._root,Je=null,wt=this._compare;if(this._noDuplicates)for(;Ve;){if(Je=Ve,wt(Ve.key,ue)===0)return;Ve=wt(Ve.key,ue)<0?Ve.right:Ve.left}else for(;Ve;)Je=Ve,Ve=wt(Ve.key,ue)<0?Ve.right:Ve.left;return Ve={key:ue,data:de,left:null,right:null,parent:Je},Je?wt(Je.key,Ve.key)<0?Je.right=Ve:Je.left=Ve:this._root=Ve,this.splay(Ve),this._size++,Ve},u.prototype.find=function(ue){for(var de=this._root,Ve=this._compare;de;){var Je=Ve(de.key,ue);if(Je<0)de=de.right;else{if(!(Je>0))return de;de=de.left}}return null},u.prototype.contains=function(ue){for(var de=this._root,Ve=this._compare;de;){var Je=Ve(ue,de.key);if(Je===0)return!0;de=Je<0?de.left:de.right}return!1},u.prototype.remove=function(ue){var de=this.find(ue);if(!de)return!1;if(this.splay(de),de.left)if(de.right){var Ve=this.minNode(de.right);Ve.parent!==de&&(this.replace(Ve,Ve.right),Ve.right=de.right,Ve.right.parent=Ve),this.replace(de,Ve),Ve.left=de.left,Ve.left.parent=Ve}else this.replace(de,de.left);else this.replace(de,de.right);return this._size--,!0},u.prototype.removeNode=function(ue){if(!ue)return!1;if(this.splay(ue),ue.left)if(ue.right){var de=this.minNode(ue.right);de.parent!==ue&&(this.replace(de,de.right),de.right=ue.right,de.right.parent=de),this.replace(ue,de),de.left=ue.left,de.left.parent=de}else this.replace(ue,ue.left);else this.replace(ue,ue.right);return this._size--,!0},u.prototype.erase=function(ue){var de=this.find(ue);if(de){this.splay(de);var Ve=de.left,Je=de.right,wt=null;Ve&&(Ve.parent=null,wt=this.maxNode(Ve),this.splay(wt),this._root=wt),Je&&(Ve?wt.right=Je:this._root=Je,Je.parent=wt),this._size--}},u.prototype.pop=function(){var ue=this._root,de=null;if(ue){for(;ue.left;)ue=ue.left;de={key:ue.key,data:ue.data},this.remove(ue.key)}return de},u.prototype.next=function(ue){var de=ue;if(de)if(de.right)for(de=de.right;de&&de.left;)de=de.left;else for(de=ue.parent;de&&de.right===ue;)ue=de,de=de.parent;return de},u.prototype.prev=function(ue){var de=ue;if(de)if(de.left)for(de=de.left;de&&de.right;)de=de.right;else for(de=ue.parent;de&&de.left===ue;)ue=de,de=de.parent;return de},u.prototype.forEach=function(ue){for(var de=this._root,Ve=[],Je=!1,wt=0;!Je;)de?(Ve.push(de),de=de.left):Ve.length>0?(ue(de=Ve.pop(),wt++),de=de.right):Je=!0;return this},u.prototype.range=function(ue,de,Ve,Je){for(var wt=[],bt=this._compare,kt=this._root;wt.length!==0||kt;)if(kt)wt.push(kt),kt=kt.left;else{if(bt((kt=wt.pop()).key,de)>0)break;if(bt(kt.key,ue)>=0&&Ve.call(Je,kt))return this;kt=kt.right}return this},u.prototype.keys=function(){for(var ue=this._root,de=[],Ve=[],Je=!1;!Je;)ue?(de.push(ue),ue=ue.left):de.length>0?(ue=de.pop(),Ve.push(ue.key),ue=ue.right):Je=!0;return Ve},u.prototype.values=function(){for(var ue=this._root,de=[],Ve=[],Je=!1;!Je;)ue?(de.push(ue),ue=ue.left):de.length>0?(ue=de.pop(),Ve.push(ue.data),ue=ue.right):Je=!0;return Ve},u.prototype.at=function(ue){for(var de=this._root,Ve=[],Je=!1,wt=0;!Je;)if(de)Ve.push(de),de=de.left;else if(Ve.length>0){if(de=Ve.pop(),wt===ue)return de;wt++,de=de.right}else Je=!0;return null},u.prototype.load=function(ue,de,Ve){if(ue===void 0&&(ue=[]),de===void 0&&(de=[]),Ve===void 0&&(Ve=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var Je=ue.length;return Ve&&y(ue,de,0,Je-1,this._compare),this._root=p(null,ue,de,0,Je),this._size=Je,this},u.prototype.min=function(){var ue=this.minNode(this._root);return ue?ue.key:null},u.prototype.max=function(){var ue=this.maxNode(this._root);return ue?ue.key:null},u.prototype.isEmpty=function(){return this._root===null},f.size.get=function(){return this._size},u.createTree=function(ue,de,Ve,Je,wt){return new u(Ve,wt).load(ue,de,Je)},Object.defineProperties(u.prototype,f);var w=0,E=1,A=2,P=3,M=0,O=1,D=2,V=3;function G(ue,de,Ve){de===null?(ue.inOut=!1,ue.otherInOut=!0):(ue.isSubject===de.isSubject?(ue.inOut=!de.inOut,ue.otherInOut=de.otherInOut):(ue.inOut=!de.otherInOut,ue.otherInOut=de.isVertical()?!de.inOut:de.inOut),de&&(ue.prevInResult=!q(de,Ve)||de.isVertical()?de.prevInResult:de));var Je=q(ue,Ve);ue.resultTransition=Je?function(wt,bt){var kt,qt=!wt.inOut,Cr=!wt.otherInOut;switch(bt){case M:kt=qt&&Cr;break;case O:kt=qt||Cr;break;case V:kt=qt^Cr;break;case D:kt=wt.isSubject?qt&&!Cr:Cr&&!qt}return kt?1:-1}(ue,Ve):0}function q(ue,de){switch(ue.type){case w:switch(de){case M:return!ue.otherInOut;case O:return ue.otherInOut;case D:return ue.isSubject&&ue.otherInOut||!ue.isSubject&&!ue.otherInOut;case V:return!0}break;case A:return de===M||de===O;case P:return de===D;case E:return!1}return!1}var te=function(ue,de,Ve,Je,wt){this.left=de,this.point=ue,this.otherEvent=Ve,this.isSubject=Je,this.type=wt||w,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},re={inResult:{configurable:!0}};function oe(ue,de){return ue[0]===de[0]&&ue[1]===de[1]}te.prototype.isBelow=function(ue){var de=this.point,Ve=this.otherEvent.point;return this.left?(de[0]-ue[0])*(Ve[1]-ue[1])-(Ve[0]-ue[0])*(de[1]-ue[1])>0:(Ve[0]-ue[0])*(de[1]-ue[1])-(de[0]-ue[0])*(Ve[1]-ue[1])>0},te.prototype.isAbove=function(ue){return!this.isBelow(ue)},te.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},re.inResult.get=function(){return this.resultTransition!==0},te.prototype.clone=function(){var ue=new te(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ue.contourId=this.contourId,ue.resultTransition=this.resultTransition,ue.prevInResult=this.prevInResult,ue.isExteriorRing=this.isExteriorRing,ue.inOut=this.inOut,ue.otherInOut=this.otherInOut,ue},Object.defineProperties(te.prototype,re);var xe=11102230246251565e-32,ve=134217729,Se=(3+8*xe)*xe;function Ce(ue,de,Ve,Je,wt){var bt,kt,qt,Cr,Ar=de[0],Tr=Je[0],si=0,Mi=0;Tr>Ar==Tr>-Ar?(bt=Ar,Ar=de[++si]):(bt=Tr,Tr=Je[++Mi]);var Sr=0;if(si<ue&&Mi<Ve)for(Tr>Ar==Tr>-Ar?(qt=bt-((kt=Ar+bt)-Ar),Ar=de[++si]):(qt=bt-((kt=Tr+bt)-Tr),Tr=Je[++Mi]),bt=kt,qt!==0&&(wt[Sr++]=qt);si<ue&&Mi<Ve;)Tr>Ar==Tr>-Ar?(qt=bt-((kt=bt+Ar)-(Cr=kt-bt))+(Ar-Cr),Ar=de[++si]):(qt=bt-((kt=bt+Tr)-(Cr=kt-bt))+(Tr-Cr),Tr=Je[++Mi]),bt=kt,qt!==0&&(wt[Sr++]=qt);for(;si<ue;)qt=bt-((kt=bt+Ar)-(Cr=kt-bt))+(Ar-Cr),Ar=de[++si],bt=kt,qt!==0&&(wt[Sr++]=qt);for(;Mi<Ve;)qt=bt-((kt=bt+Tr)-(Cr=kt-bt))+(Tr-Cr),Tr=Je[++Mi],bt=kt,qt!==0&&(wt[Sr++]=qt);return bt===0&&Sr!==0||(wt[Sr++]=bt),Sr}function Ae(ue){return new Float64Array(ue)}var Qe=33306690738754716e-32,Oe=22204460492503146e-32,et=11093356479670487e-47,ct=Ae(4),rt=Ae(8),st=Ae(12),ht=Ae(16),Ke=Ae(4);function at(ue,de,Ve){var Je=function(wt,bt,kt,qt,Cr,Ar){var Tr=(bt-Ar)*(kt-Cr),si=(wt-Cr)*(qt-Ar),Mi=Tr-si;if(Tr===0||si===0||Tr>0!=si>0)return Mi;var Sr=Math.abs(Tr+si);return Math.abs(Mi)>=Qe*Sr?Mi:-function(_i,li,Zr,bi,wi,mi,yi){var ci,Pr,ui,Bi,er,Vr,Si,qi,Ci,gn,hi,an,Ds,Kn,Hn,js,bl,_n,kn=_i-wi,Jn=Zr-wi,ys=li-mi,os=bi-mi;ct[0]=(Hn=(qi=kn-(Si=(Vr=ve*kn)-(Vr-kn)))*(gn=os-(Ci=(Vr=ve*os)-(Vr-os)))-((Kn=kn*os)-Si*Ci-qi*Ci-Si*gn))-((hi=Hn-(bl=(qi=ys-(Si=(Vr=ve*ys)-(Vr-ys)))*(gn=Jn-(Ci=(Vr=ve*Jn)-(Vr-Jn)))-((js=ys*Jn)-Si*Ci-qi*Ci-Si*gn)))+(er=Hn-hi))+(er-bl),ct[1]=(Ds=Kn-((an=Kn+hi)-(er=an-Kn))+(hi-er))-((hi=Ds-js)+(er=Ds-hi))+(er-js),ct[2]=an-((_n=an+hi)-(er=_n-an))+(hi-er),ct[3]=_n;var pu=function(g$,WC){for(var ZC=WC[0],Bw=1;Bw<4;Bw++)ZC+=WC[Bw];return ZC}(0,ct),Rg=Oe*yi;if(pu>=Rg||-pu>=Rg||(ci=_i-(kn+(er=_i-kn))+(er-wi),ui=Zr-(Jn+(er=Zr-Jn))+(er-wi),Pr=li-(ys+(er=li-ys))+(er-mi),Bi=bi-(os+(er=bi-os))+(er-mi),ci===0&&Pr===0&&ui===0&&Bi===0)||(Rg=et*yi+Se*Math.abs(pu),(pu+=kn*Bi+os*ci-(ys*ui+Jn*Pr))>=Rg||-pu>=Rg))return pu;Ke[0]=(Hn=(qi=ci-(Si=(Vr=ve*ci)-(Vr-ci)))*(gn=os-(Ci=(Vr=ve*os)-(Vr-os)))-((Kn=ci*os)-Si*Ci-qi*Ci-Si*gn))-((hi=Hn-(bl=(qi=Pr-(Si=(Vr=ve*Pr)-(Vr-Pr)))*(gn=Jn-(Ci=(Vr=ve*Jn)-(Vr-Jn)))-((js=Pr*Jn)-Si*Ci-qi*Ci-Si*gn)))+(er=Hn-hi))+(er-bl),Ke[1]=(Ds=Kn-((an=Kn+hi)-(er=an-Kn))+(hi-er))-((hi=Ds-js)+(er=Ds-hi))+(er-js),Ke[2]=an-((_n=an+hi)-(er=_n-an))+(hi-er),Ke[3]=_n;var fD=Ce(4,ct,4,Ke,rt);Ke[0]=(Hn=(qi=kn-(Si=(Vr=ve*kn)-(Vr-kn)))*(gn=Bi-(Ci=(Vr=ve*Bi)-(Vr-Bi)))-((Kn=kn*Bi)-Si*Ci-qi*Ci-Si*gn))-((hi=Hn-(bl=(qi=ys-(Si=(Vr=ve*ys)-(Vr-ys)))*(gn=ui-(Ci=(Vr=ve*ui)-(Vr-ui)))-((js=ys*ui)-Si*Ci-qi*Ci-Si*gn)))+(er=Hn-hi))+(er-bl),Ke[1]=(Ds=Kn-((an=Kn+hi)-(er=an-Kn))+(hi-er))-((hi=Ds-js)+(er=Ds-hi))+(er-js),Ke[2]=an-((_n=an+hi)-(er=_n-an))+(hi-er),Ke[3]=_n;var pD=Ce(fD,rt,4,Ke,st);Ke[0]=(Hn=(qi=ci-(Si=(Vr=ve*ci)-(Vr-ci)))*(gn=Bi-(Ci=(Vr=ve*Bi)-(Vr-Bi)))-((Kn=ci*Bi)-Si*Ci-qi*Ci-Si*gn))-((hi=Hn-(bl=(qi=Pr-(Si=(Vr=ve*Pr)-(Vr-Pr)))*(gn=ui-(Ci=(Vr=ve*ui)-(Vr-ui)))-((js=Pr*ui)-Si*Ci-qi*Ci-Si*gn)))+(er=Hn-hi))+(er-bl),Ke[1]=(Ds=Kn-((an=Kn+hi)-(er=an-Kn))+(hi-er))-((hi=Ds-js)+(er=Ds-hi))+(er-js),Ke[2]=an-((_n=an+hi)-(er=_n-an))+(hi-er),Ke[3]=_n;var mD=Ce(pD,st,4,Ke,ht);return ht[mD-1]}(wt,bt,kt,qt,Cr,Ar,Sr)}(ue[0],ue[1],de[0],de[1],Ve[0],Ve[1]);return Je>0?-1:Je<0?1:0}function $e(ue,de){var Ve=ue.point,Je=de.point;return Ve[0]>Je[0]?1:Ve[0]<Je[0]?-1:Ve[1]!==Je[1]?Ve[1]>Je[1]?1:-1:function(wt,bt,kt,qt){return wt.left!==bt.left?wt.left?1:-1:at(kt,wt.otherEvent.point,bt.otherEvent.point)!==0?wt.isBelow(bt.otherEvent.point)?-1:1:!wt.isSubject&&bt.isSubject?1:-1}(ue,de,Ve)}function Be(ue,de,Ve){var Je=new te(de,!1,ue,ue.isSubject),wt=new te(de,!0,ue.otherEvent,ue.isSubject);return oe(ue.point,ue.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ue),Je.contourId=wt.contourId=ue.contourId,$e(wt,ue.otherEvent)>0&&(ue.otherEvent.left=!0,wt.left=!1),ue.otherEvent.otherEvent=wt,ue.otherEvent=Je,Ve.push(wt),Ve.push(Je),Ve}function pt(ue,de){return ue[0]*de[1]-ue[1]*de[0]}function ut(ue,de){return ue[0]*de[0]+ue[1]*de[1]}function $t(ue,de,Ve){var Je=function(Cr,Ar,Tr,si,Mi){var Sr=[Ar[0]-Cr[0],Ar[1]-Cr[1]],_i=[si[0]-Tr[0],si[1]-Tr[1]];function li(Vr,Si,qi){return[Vr[0]+Si*qi[0],Vr[1]+Si*qi[1]]}var Zr=[Tr[0]-Cr[0],Tr[1]-Cr[1]],bi=pt(Sr,_i),wi=bi*bi,mi=ut(Sr,Sr);if(wi>0){var yi=pt(Zr,_i)/bi;if(yi<0||yi>1)return null;var ci=pt(Zr,Sr)/bi;return ci<0||ci>1?null:yi===0||yi===1?[li(Cr,yi,Sr)]:ci===0||ci===1?[li(Tr,ci,_i)]:[li(Cr,yi,Sr)]}if((wi=(bi=pt(Zr,Sr))*bi)>0)return null;var Pr=ut(Sr,Zr)/mi,ui=Pr+ut(Sr,_i)/mi,Bi=Math.min(Pr,ui),er=Math.max(Pr,ui);return Bi<=1&&er>=0?Bi===1?[li(Cr,Bi>0?Bi:0,Sr)]:er===0?[li(Cr,er<1?er:1,Sr)]:[li(Cr,Bi>0?Bi:0,Sr),li(Cr,er<1?er:1,Sr)]:null}(ue.point,ue.otherEvent.point,de.point,de.otherEvent.point),wt=Je?Je.length:0;if(wt===0||wt===1&&(oe(ue.point,de.point)||oe(ue.otherEvent.point,de.otherEvent.point))||wt===2&&ue.isSubject===de.isSubject)return 0;if(wt===1)return oe(ue.point,Je[0])||oe(ue.otherEvent.point,Je[0])||Be(ue,Je[0],Ve),oe(de.point,Je[0])||oe(de.otherEvent.point,Je[0])||Be(de,Je[0],Ve),1;var bt=[],kt=!1,qt=!1;return oe(ue.point,de.point)?kt=!0:$e(ue,de)===1?bt.push(de,ue):bt.push(ue,de),oe(ue.otherEvent.point,de.otherEvent.point)?qt=!0:$e(ue.otherEvent,de.otherEvent)===1?bt.push(de.otherEvent,ue.otherEvent):bt.push(ue.otherEvent,de.otherEvent),kt&&qt||kt?(de.type=E,ue.type=de.inOut===ue.inOut?A:P,kt&&!qt&&Be(bt[1].otherEvent,bt[0].point,Ve),2):qt?(Be(bt[0],bt[1].point,Ve),3):bt[0]!==bt[3].otherEvent?(Be(bt[0],bt[1].point,Ve),Be(bt[1],bt[2].point,Ve),3):(Be(bt[0],bt[1].point,Ve),Be(bt[3].otherEvent,bt[2].point,Ve),3)}function It(ue,de){if(ue===de)return 0;if(at(ue.point,ue.otherEvent.point,de.point)!==0||at(ue.point,ue.otherEvent.point,de.otherEvent.point)!==0)return oe(ue.point,de.point)?ue.isBelow(de.otherEvent.point)?-1:1:ue.point[0]===de.point[0]?ue.point[1]<de.point[1]?-1:1:$e(ue,de)===1?de.isAbove(ue.point)?-1:1:ue.isBelow(de.point)?-1:1;if(ue.isSubject!==de.isSubject)return ue.isSubject?-1:1;var Ve=ue.point,Je=de.point;return Ve[0]===Je[0]&&Ve[1]===Je[1]?(Ve=ue.otherEvent.point)[0]===(Je=de.otherEvent.point)[0]&&Ve[1]===Je[1]?0:ue.contourId>de.contourId?1:-1:$e(ue,de)===1?1:-1}var Lt=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function xt(ue,de,Ve,Je){var wt,bt=ue+1,kt=de[ue].point,qt=de.length;for(bt<qt&&(wt=de[bt].point);bt<qt&&wt[0]===kt[0]&&wt[1]===kt[1];){if(!Ve[bt])return bt;++bt<qt&&(wt=de[bt].point)}for(bt=ue-1;Ve[bt]&&bt>Je;)bt--;return bt}Lt.prototype.isExterior=function(){return this.holeOf==null};var Bt=St,sr=St;function St(ue,de){if(!(this instanceof St))return new St(ue,de);if(this.data=ue||[],this.length=this.data.length,this.compare=de||jt,this.length>0)for(var Ve=(this.length>>1)-1;Ve>=0;Ve--)this._down(Ve)}function jt(ue,de){return ue<de?-1:ue>de?1:0}St.prototype={push:function(ue){this.data.push(ue),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var ue=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ue}},peek:function(){return this.data[0]},_up:function(ue){for(var de=this.data,Ve=this.compare,Je=de[ue];ue>0;){var wt=ue-1>>1,bt=de[wt];if(Ve(Je,bt)>=0)break;de[ue]=bt,ue=wt}de[ue]=Je},_down:function(ue){for(var de=this.data,Ve=this.compare,Je=this.length>>1,wt=de[ue];ue<Je;){var bt=1+(ue<<1),kt=bt+1,qt=de[bt];if(kt<this.length&&Ve(de[kt],qt)<0&&(bt=kt,qt=de[kt]),Ve(qt,wt)>=0)break;de[ue]=qt,ue=bt}de[ue]=wt}},Bt.default=sr;var Kt=Math.max,ur=Math.min,Ir=0;function mr(ue,de,Ve,Je,wt,bt){var kt,qt,Cr,Ar,Tr,si;for(kt=0,qt=ue.length-1;kt<qt;kt++)if(Ar=ue[kt+1],Tr=new te(Cr=ue[kt],!1,void 0,de),si=new te(Ar,!1,Tr,de),Tr.otherEvent=si,Cr[0]!==Ar[0]||Cr[1]!==Ar[1]){Tr.contourId=si.contourId=Ve,bt||(Tr.isExteriorRing=!1,si.isExteriorRing=!1),$e(Tr,si)>0?si.left=!0:Tr.left=!0;var Mi=Cr[0],Sr=Cr[1];wt[0]=ur(wt[0],Mi),wt[1]=ur(wt[1],Sr),wt[2]=Kt(wt[2],Mi),wt[3]=Kt(wt[3],Sr),Je.push(Tr),Je.push(si)}}var Mt=[];function hr(ue,de,Ve){typeof ue[0][0][0]=="number"&&(ue=[ue]),typeof de[0][0][0]=="number"&&(de=[de]);var Je=function(Sr,_i,li){var Zr=null;return Sr.length*_i.length==0&&(li===M?Zr=Mt:li===D?Zr=Sr:li!==O&&li!==V||(Zr=Sr.length===0?_i:Sr)),Zr}(ue,de,Ve);if(Je)return Je===Mt?null:Je;var wt=[1/0,1/0,-1/0,-1/0],bt=[1/0,1/0,-1/0,-1/0],kt=function(Sr,_i,li,Zr,bi){var wi,mi,yi,ci,Pr,ui,Bi=new Bt(null,$e);for(yi=0,ci=Sr.length;yi<ci;yi++)for(Pr=0,ui=(wi=Sr[yi]).length;Pr<ui;Pr++)(mi=Pr===0)&&Ir++,mr(wi[Pr],!0,Ir,Bi,li,mi);for(yi=0,ci=_i.length;yi<ci;yi++)for(Pr=0,ui=(wi=_i[yi]).length;Pr<ui;Pr++)mi=Pr===0,bi===D&&(mi=!1),mi&&Ir++,mr(wi[Pr],!1,Ir,Bi,Zr,mi);return Bi}(ue,de,wt,bt,Ve);if(Je=function(Sr,_i,li,Zr,bi){var wi=null;return(li[0]>Zr[2]||Zr[0]>li[2]||li[1]>Zr[3]||Zr[1]>li[3])&&(bi===M?wi=Mt:bi===D?wi=Sr:bi!==O&&bi!==V||(wi=Sr.concat(_i))),wi}(ue,de,wt,bt,Ve))return Je===Mt?null:Je;for(var qt=function(Sr){var _i,li,Zr=function(yi){var ci,Pr,ui,Bi,er=[];for(Pr=0,ui=yi.length;Pr<ui;Pr++)((ci=yi[Pr]).left&&ci.inResult||!ci.left&&ci.otherEvent.inResult)&&er.push(ci);for(var Vr=!1;!Vr;)for(Vr=!0,Pr=0,ui=er.length;Pr<ui;Pr++)Pr+1<ui&&$e(er[Pr],er[Pr+1])===1&&(Bi=er[Pr],er[Pr]=er[Pr+1],er[Pr+1]=Bi,Vr=!1);for(Pr=0,ui=er.length;Pr<ui;Pr++)(ci=er[Pr]).otherPos=Pr;for(Pr=0,ui=er.length;Pr<ui;Pr++)(ci=er[Pr]).left||(Bi=ci.otherPos,ci.otherPos=ci.otherEvent.otherPos,ci.otherEvent.otherPos=Bi);return er}(Sr),bi={},wi=[],mi=function(){if(!bi[_i]){var yi=wi.length,ci=function(er,Vr,Si){var qi=new Lt;if(er.prevInResult!=null){var Ci=er.prevInResult,gn=Ci.outputContourId;if(Ci.resultTransition>0){var hi=Vr[gn];if(hi.holeOf!=null){var an=hi.holeOf;Vr[an].holeIds.push(Si),qi.holeOf=an,qi.depth=Vr[gn].depth}else Vr[gn].holeIds.push(Si),qi.holeOf=gn,qi.depth=Vr[gn].depth+1}else qi.holeOf=null,qi.depth=Vr[gn].depth}else qi.holeOf=null,qi.depth=0;return qi}(Zr[_i],wi,yi),Pr=function(er){bi[er]=!0,er<Zr.length&&Zr[er]&&(Zr[er].outputContourId=yi)},ui=_i,Bi=_i;for(ci.points.push(Zr[_i].point);Pr(ui),Pr(ui=Zr[ui].otherPos),ci.points.push(Zr[ui].point),!((ui=xt(ui,Zr,bi,Bi))==Bi||ui>=Zr.length)&&Zr[ui];);wi.push(ci)}};for(_i=0,li=Zr.length;_i<li;_i++)mi();return wi}(function(Sr,_i,li,Zr,bi,wi){for(var mi,yi,ci,Pr=new u(It),ui=[],Bi=Math.min(Zr[2],bi[2]);Sr.length!==0;){var er=Sr.pop();if(ui.push(er),wi===M&&er.point[0]>Bi||wi===D&&er.point[0]>Zr[2])break;if(er.left){yi=mi=Pr.insert(er),mi=mi!==(ci=Pr.minNode())?Pr.prev(mi):null,yi=Pr.next(yi);var Vr=mi?mi.key:null;if(G(er,Vr,wi),yi&&$t(er,yi.key,Sr)===2&&(G(er,Vr,wi),G(yi.key,er,wi)),mi&&$t(mi.key,er,Sr)===2){var Si=mi;G(Vr,(Si=Si!==ci?Pr.prev(Si):null)?Si.key:null,wi),G(er,Vr,wi)}}else yi=mi=Pr.find(er=er.otherEvent),mi&&yi&&(mi=mi!==ci?Pr.prev(mi):null,yi=Pr.next(yi),Pr.remove(er),yi&&mi&&$t(mi.key,yi.key,Sr))}return ui}(kt,0,0,wt,bt,Ve)),Cr=[],Ar=0;Ar<qt.length;Ar++){var Tr=qt[Ar];if(Tr.isExterior()){for(var si=[Tr.points],Mi=0;Mi<Tr.holeIds.length;Mi++)si.push(qt[Tr.holeIds[Mi]].points);Cr.push(si)}}return Cr}var Fr={UNION:O,DIFFERENCE:D,INTERSECTION:M,XOR:V};i.diff=function(ue,de){return hr(ue,de,D)},i.intersection=function(ue,de){return hr(ue,de,M)},i.operations=Fr,i.union=function(ue,de){return hr(ue,de,O)},i.xor=function(ue,de){return hr(ue,de,V)},Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,NT.exports)),NT.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function ey(n,e,i,l){const u=[],f=l===0?(p,y,w,E,A,P)=>{p.push(new ft(P,w+(P-y)/(E-y)*(A-w)))}:(p,y,w,E,A,P)=>{p.push(new ft(y+(P-w)/(A-w)*(E-y),P))};for(const p of n){const y=[];for(const w of p){if(w.length<=2)continue;const E=[];for(let M=0;M<w.length-1;M++){const O=w[M].x,D=w[M].y,V=w[M+1].x,G=w[M+1].y,q=l===0?O:D,te=l===0?V:G;q<e?te>e&&f(E,O,D,V,G,e):q>i?te<i&&f(E,O,D,V,G,i):E.push(w[M]),te<e&&q>=e&&f(E,O,D,V,G,e),te>i&&q<=i&&f(E,O,D,V,G,i)}let A=w[w.length-1];const P=l===0?A.x:A.y;P>=e&&P<=i&&E.push(A),E.length&&(A=E[E.length-1],E[0].x===A.x&&E[0].y===A.y||E.push(E[0]),y.push(E))}y.length&&u.push(y)}return u}function u3(n,e){const i=Ob(n),l=Ob([e]),u=RT.intersection(i,l);return u==null?[]:LT(u)}function d3(n,e){let l=Ob(n,65536);const u=[];for(;e.valid();e.next()){const[f,p]=e.get(),y=f.x*65536,w=f.y*65536,E=p.x*65536,A=p.y*65536,P=E-y,M=A-w,O=Math.hypot(P,M);if(O===0)continue;const D=Math.trunc(M/O*3),V=-Math.trunc(P/O*3);u.push([[[y,w],[E,A],[E+D,A+V],[y+D,w+V],[y,w]]])}return u.length>0&&(l=RT.diff(l,u)),LT(l,1/65536)}function Ob(n,e=1){return[n.map(i=>i.map(l=>[l.x*e,l.y*e]))]}function LT(n,e=1){return n.map(i=>i.map((l,u)=>{const f=l.map(p=>new ft(p[0]*e,p[1]*e).round());return u>0&&f.reverse(),f}))}class Db{constructor(e,i){this.layoutVertexArray=new hl,this.indexArray=new bn,this.lineIndexArray=new pn,this.triangleSegments=new Fi,this.lineSegments=new Fi,this.programConfigurations=new zo(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new fl)}update(e,i,l,u,f,p,y,w){this.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y,w)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,XR.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,YR.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,l,u,f,p,y){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,l,u,f,p,void 0,y)}}class jb{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new Db(e,!1),this.elevationBufferData=new Db(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,l,u){this.hasPattern=Rb("fill",this.layers,this.pixelRatio,i);const f=this.layers[0].layout.get("fill-sort-key"),p=[];for(const{feature:y,id:w,index:E,sourceLayerIndex:A}of e){const P=this.layers[0]._featureFilter.needGeometry,M=dt(y,P);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom,{worldview:this.worldview}),M,l))continue;const O=f?f.evaluate(M,{},l,i.availableImages):void 0,D={id:w,properties:y.properties,type:y.type,sourceLayerIndex:A,index:E,geometry:P?M.geometry:Et(y,l,u),patterns:{},sortKey:O};p.push(D)}f&&p.sort((y,w)=>y.sortKey-w.sortKey);for(const y of p){const{geometry:w,index:E,sourceLayerIndex:A}=y;if(this.hasPattern){const P=Lb("fill",this.layers,y,this.zoom,this.pixelRatio,i);this.patternFeatures.push(P)}else this.addFeature(y,w,E,l,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[E].feature,w,E,A,this.index)}}update(e,i,l,u,f,p,y){this.bufferData.update(e,i,l,u,f,p,y,this.worldview),this.elevationBufferData.update(e,i,l,u,f,p,y,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,l,u,f,p,y,this.worldview)}addFeatures(e,i,l,u,f,p){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,i,l,u,p,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,l,u,f,p=[],y,w){const E=rg(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,E,u,l,w):this.addGeometry(E,this.bufferData),this.bufferData.populatePaintArrays(e,l,f,p,u,y,this.worldview),this.elevationBufferData.populatePaintArrays(e,l,f,p,u,y,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,l,u,f){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,l,u,f,this.worldview))}addElevatedRoadFeature(e,i,l,u,f){const p=new Array,y=Ri.getElevationFeature(e,f);if(!y)return void this.addGeometry(i,this.bufferData);{const E=this.clipPolygonsToTile(i,1);E.length>0&&p.push({polygons:E,elevationFeature:y,elevationTileID:l})}const w={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},l),featureIndex:u};for(const E of p)if(E.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new ro(E.elevationTileID,this.layers,this.zoom,this.lut));const P=E.elevationFeature.isTunnel();let M=0;e.properties.hasOwnProperty(ii)&&(M=+e.properties[ii]);for(const O of E.polygons)this.elevatedStructures.addPortalCandidates(E.elevationFeature.id,O,P,E.elevationFeature,M)}E.elevationFeature.constantHeight==null&&(E.polygons=this.prepareElevatedPolygons(E.polygons,E.elevationFeature,E.elevationTileID));const A=new sn(l,E.elevationTileID);this.addElevatedGeometry(E.polygons,A,E.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,u,w)}}addElevatedGeometry(e,i,l,u,f,p){const y={elevation:l,elevationSampler:i,bias:u,index:f,featureInfo:p},[w,E]=this.addGeometry(e,this.elevationBufferData,y);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:w,max:E}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,w),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,E))}addGeometry(e,i,l){let u=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,p=null;l&&(p=l.elevationSampler.constantElevation(l.elevation,l.bias),p!=null&&(u=p,f=p));const y=(w,E,A)=>{if(l!=null)if(E.push(w),p!=null)i.elevatedLayoutVertexArray.emplaceBack(p),A.push(p);else{const P=l.elevationSampler.pointElevation(w,l.elevation,l.bias);i.elevatedLayoutVertexArray.emplaceBack(P),A.push(P),u=Math.min(u,P),f=Math.max(f,P)}};for(const w of e){let E=0;for(const re of w)E+=re.length;const A=i.triangleSegments.prepareSegment(E,i.layoutVertexArray,i.indexArray),P=A.vertexLength,M=[],O=[],D=[],V=[],G=[],q=i.layoutVertexArray.length;for(const re of w){if(re.length===0)continue;re!==w[0]&&O.push(M.length/2);const oe=i.lineSegments.prepareSegment(re.length,i.layoutVertexArray,i.lineIndexArray),xe=oe.vertexLength;l&&G.push(i.layoutVertexArray.length-q),y(re[0],D,V),i.layoutVertexArray.emplaceBack(re[0].x,re[0].y),i.lineIndexArray.emplaceBack(xe+re.length-1,xe),M.push(re[0].x),M.push(re[0].y);for(let ve=1;ve<re.length;ve++)y(re[ve],D,V),i.layoutVertexArray.emplaceBack(re[ve].x,re[ve].y),i.lineIndexArray.emplaceBack(xe+ve-1,xe+ve),M.push(re[ve].x),M.push(re[ve].y);oe.vertexLength+=re.length,oe.primitiveLength+=re.length}const te=Cf(M,O);for(let re=0;re<te.length;re+=3)i.indexArray.emplaceBack(P+te[re],P+te[re+1],P+te[re+2]);if(te.length>0&&l&&this.elevationMode==="hd-road-base"){const re=l.elevation.isTunnel(),oe=l.elevation.safeArea,xe=this.elevatedStructures.addVertices(D,V);this.elevatedStructures.addTriangles(te,xe,re);const ve=G.length;if(ve>0){for(let Se=0;Se<ve-1;Se++)this.elevatedStructures.addRenderableRing(l.index,G[Se]+xe,G[Se+1]-G[Se],re,oe,l.featureInfo);this.elevatedStructures.addRenderableRing(l.index,G[ve-1]+xe,D.length-G[ve-1],re,oe,l.featureInfo)}}A.vertexLength+=E,A.primitiveLength+=te.length/3}return[u,f]}prepareElevatedPolygons(e,i,l){const u=1/De(l),f=[];for(const p of e){const y=d3(p,new ni(i,u));f.push(...y)}return f}clipPolygonsToTile(e,i){const l=-i,u=-i,f=vt+i,p=vt+i;let y=0;const w=[],E=[];for(;y<e.length;y++){const M=e[y],O=kh(M);(O.min.x>=l&&O.max.x<=f&&O.min.y>=u&&O.max.y<=p?w:E).push(M)}if(w.length===e.length)return e;const A=[new ft(l,u),new ft(f,u),new ft(f,p),new ft(l,p),new ft(l,u)],P=w;for(const M of E)P.push(...u3(M,A));return P}}let OT,DT,jT,zT;Pt(jb,"FillBucket",{omit:["layers","patternFeatures"]}),Pt(Db,"FillBufferData"),Pt(ro,"ElevatedStructures");class ty{constructor(e,i,l,u){if(this.triangleCount=i.length/3,this.min=new ft(0,0),this.max=new ft(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[f,p]=[e[0].clone(),e[0].clone()];for(let P=1;P<e.length;++P){const M=e[P];f.x=Math.min(f.x,M.x),f.y=Math.min(f.y,M.y),p.x=Math.max(p.x,M.x),p.y=Math.max(p.y,M.y)}if(u){const P=Math.ceil(Math.max(p.x-f.x,p.y-f.y)/u);l=Math.max(l,P)}if(l===0)return;this.min=f,this.max=p;const y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);const w=Math.max(y.x,y.y)/l;this.cellsX=Math.max(1,Math.ceil(y.x/w)),this.cellsY=Math.max(1,Math.ceil(y.y/w)),this.xScale=1/w,this.yScale=1/w;const E=[];for(let P=0;P<this.triangleCount;P++){const M=e[i[3*P+0]].sub(this.min),O=e[i[3*P+1]].sub(this.min),D=e[i[3*P+2]].sub(this.min),V=xl(Math.floor(Math.min(M.x,O.x,D.x)),this.xScale,this.cellsX),G=xl(Math.floor(Math.max(M.x,O.x,D.x)),this.xScale,this.cellsX),q=xl(Math.floor(Math.min(M.y,O.y,D.y)),this.yScale,this.cellsY),te=xl(Math.floor(Math.max(M.y,O.y,D.y)),this.yScale,this.cellsY),re=new ft(0,0),oe=new ft(0,0),xe=new ft(0,0),ve=new ft(0,0);for(let Se=q;Se<=te;++Se){re.y=oe.y=Se*w,xe.y=ve.y=(Se+1)*w;for(let Ce=V;Ce<=G;++Ce)re.x=xe.x=Ce*w,oe.x=ve.x=(Ce+1)*w,(Aa(M,O,D,re,oe,ve)||Aa(M,O,D,re,ve,xe))&&E.push({cellIdx:Se*this.cellsX+Ce,triIdx:P})}}if(E.length===0)return;E.sort((P,M)=>P.cellIdx-M.cellIdx||P.triIdx-M.triIdx);let A=0;for(;A<E.length;){const P=E[A].cellIdx,M={start:this.payload.length,len:0};for(;A<E.length&&E[A].cellIdx===P;)++M.len,this.payload.push(E[A++].triIdx);this.cells[P]=M}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const l=xl(e.x-this.min.x,this.xScale,this.cellsX),u=xl(e.y-this.min.y,this.yScale,this.cellsY),f=this.cells[u*this.cellsX+l];if(f){this._lazyInitLookup();for(let p=0;p<f.len;p++){const y=this.payload[f.start+p],w=Math.floor(y/8),E=1<<y%8;if(!(this.lookup[w]&E)&&(this.lookup[w]|=E,i.push(y),i.length===this.triangleCount))return}}}query(e,i,l){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const u=xl(e.x-this.min.x,this.xScale,this.cellsX),f=xl(i.x-this.min.x,this.xScale,this.cellsX),p=xl(e.y-this.min.y,this.yScale,this.cellsY),y=xl(i.y-this.min.y,this.yScale,this.cellsY);for(let w=p;w<=y;w++)for(let E=u;E<=f;E++){const A=this.cells[w*this.cellsX+E];if(A)for(let P=0;P<A.len;P++){const M=this.payload[A.start+P],O=Math.floor(M/8),D=1<<M%8;if(!(this.lookup[O]&D)&&(this.lookup[O]|=D,l.push(M),l.length===this.triangleCount))return}}}}function xl(n,e,i){return Math.max(0,Math.min(i-1,Math.floor(n*e)))}Pt(ty,"TriangleGridIndex");class FT{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,i){for(const l of this.footprints)i.push({footprint:l,id:e})}populate(e,i,l,u){const f=[];for(const{feature:p,id:y,index:w,sourceLayerIndex:E}of e){const A=this.layers[0]._featureFilter.needGeometry,P=dt(p,A);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom,{worldview:this.worldview}),P,l))continue;const M={id:y,properties:p.properties,type:p.type,sourceLayerIndex:E,index:w,geometry:A?P.geometry:Et(p,l,u),patterns:{}};f.push(M)}for(const p of f){const{geometry:y,index:w,sourceLayerIndex:E}=p;this.addFeature(p,y,w,l,{},i.availableImages,i.brightness),i.featureIndex.insert(e[w].feature,y,w,E,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,l,u,f,p,y){}destroy(){}addFeature(e,i,l,u,f,p=[],y){for(const w of rg(i,2)){const E=[],A=[],P=[],M=new ft(1/0,1/0),O=new ft(-1/0,-1/0);for(const G of w)if(G.length!==0){G!==w[0]&&P.push(A.length/2);for(let q=0;q<G.length;q++)A.push(G[q].x),A.push(G[q].y),E.push(G[q]),M.x=Math.min(M.x,G[q].x),M.y=Math.min(M.y,G[q].y),O.x=Math.max(O.x,G[q].x),O.y=Math.max(O.y,G[q].y)}const D=Cf(A,P),V=new ty(E,D,8,256);this.footprints.push({vertices:E,indices:D,grid:V,min:M,max:O})}}}Pt(FT,"ClipBucket",{omit:["layers"]});const h3=Dr([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),f3=Dr([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),p3=Dr([{name:"a_centroid_pos",components:2,type:"Uint16"}]),m3=Dr([{name:"a_join_normal_inside",components:3,type:"Int16"}]),g3=Dr([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),_3=Dr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:y3}=h3,ig=Number.MAX_SAFE_INTEGER,BT=ig-1;function UT(n,e,i,l){return n.order<e||n.order===ig||!(n.clipMask&i)||function(u,f){return f.length!==0&&f.find(p=>p===u)===void 0}(l,n.clipScope)}function ry(n,e){return n.x-e.x||n.y-e.y}function VT(n,e){return ry(n.min,e.min)===0&&ry(n.max,e.max)===0}function zb(n,e){return!(n.min.x>e.max.x||n.max.x<e.min.x||n.min.y>e.max.y||n.max.y<e.min.y)}function iy(n,e){if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(n[i].sourceId!==e[i].sourceId||!VT(n[i],e[i])||n[i].order!==e[i].order||n[i].clipMask!==e[i].clipMask||!va(n[i].clipScope,e[i].clipScope))return!1;return!0}function $T(n,e,i){const l=1/vt,u=1/(1<<i.canonical.z),f=(e.x*l+i.canonical.x)*u+i.wrap,p=(e.y*l+i.canonical.y)*u;return{min:new ft((n.x*l+i.canonical.x)*u+i.wrap,(n.y*l+i.canonical.y)*u),max:new ft(f,p)}}function x3(n,e,i){const l=1<<i.canonical.z,u=((e.x-i.wrap)*l-i.canonical.x)*vt,f=(e.y*l-i.canonical.y)*vt;return{min:new ft(((n.x-i.wrap)*l-i.canonical.x)*vt,(n.y*l-i.canonical.y)*vt),max:new ft(u,f)}}function Fb(n,e,i,l,u,f,p){const y=n.indices,w=n.vertices,E=[];for(let A=l;A<l+u;A+=3){const P=e[i[A+0]+f],M=e[i[A+1]+f],O=e[i[A+2]+f],D=Math.min(P.x,M.x,O.x),V=Math.max(P.x,M.x,O.x),G=Math.min(P.y,M.y,O.y),q=Math.max(P.y,M.y,O.y);E.length=0,n.grid.query(new ft(D,G),new ft(V,q),E);for(let te=0;te<E.length;te++){const re=E[te];if(Aa(w[y[3*re+0]],w[y[3*re+1]],w[y[3*re+2]],P,M,O,p))return!0}}return!1}function GT(n,e,i,l){if(!n||!i)return!1;let u=n.vertices;if(!e.canonical.equals(l.canonical)||e.wrap!==l.wrap){if(i.vertices.length<n.vertices.length)return GT(i,l,n,e);const f=e.canonical,p=l.canonical,y=Math.pow(2,p.z-f.z);u=n.vertices.map(w=>new ft((w.x+f.x*vt)*y-p.x*vt,(w.y+f.y*vt)*y-p.y*vt))}return Fb(i,u,n.indices,0,n.indices.length,0,0)}function qT(n,e,i,l){const u=Math.pow(2,l.z-i.z);return new ft((n+i.x*vt)*u-l.x*vt,(e+i.y*vt)*u-l.y*vt)}function Bb(n,e){const i=[];e.grid.queryPoint(n,i);const l=e.indices,u=e.vertices;for(let f=0;f<i.length;f++){const p=i[f];if(Pn([u[l[3*p+0]],u[l[3*p+1]],u[l[3*p+2]]],n))return!0}return!1}const Ub=[new ft(0,0),new ft(vt,0),new ft(vt,vt),new ft(0,vt)];function HT(n,e){const i=[];let l=[];if(!e||n.length<2)return[n];if(n.length===2)return Xn(n[0],n[1],Ub)?[n]:[];for(let u=0;u<n.length+2;u++){const f=n[u%n.length],p=n[(u+1)%n.length],y=Xn(u===0?n[n.length-1]:n[(u-1)%n.length],f,Ub),w=Xn(f,p,Ub),E=y||w;E&&l.push(f),E&&w||l.length>0&&(l.length>1&&i.push(l),l=[])}return l.length>1&&i.push(l),i}const Vb=lt.types,v3=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],b3=["fill-extrusion-flood-light-ground-radius"],w3=Math.pow(2,13),S3=Math.pow(2,15)-1,WT=new ft(0,1),lu=2147483648;function ng(n,e,i,l,u,f,p,y){n.emplaceBack((e<<1)+p,(i<<1)+f,(Math.floor(l*w3)<<1)+u,Math.round(y))}function sg(n,e,i){n.emplaceBack(e.x*vt,e.y*vt,i?1:0)}function ny(n,e,i,l,u,f){n.emplaceBack(e.x,e.y,(i.x<<1)+l,(i.y<<1)+u,f)}function og(n,e,i){n.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class ZT{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class XT{constructor(){this.centroidXY=new ft(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ft(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ft(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new ft(this.max.x-this.min.x,this.max.y-this.min.y)}}class YT{constructor(){this.acc=new ft(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,l){this.accCount++,this.acc._add(i);let u=!!this.borders;i.x<e.min.x?(e.min.x=i.x,u=!0):i.x>e.max.x&&(e.max.x=i.x,u=!0),i.y<e.min.y?(e.min.y=i.y,u=!0):i.y>e.max.y&&(e.max.y=i.y,u=!0),((i.x===0||i.x===vt)&&i.x===l.x)!=((i.y===0||i.y===vt)&&i.y===l.y)&&this.processBorderOverlap(i,l),u&&this.checkBorderIntersection(i,l)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Yt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>vt!=e.x>vt&&this.addBorderIntersection(1,Yt(i.y,e.y,(vt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Yt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>vt!=e.y>vt&&this.addBorderIntersection(3,Yt(i.x,e.x,(vt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const l=this.borders[e];i<l[0]&&(l[0]=i),i>l[1]&&(l[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const l=e.x===0?0:1;this.addBorderIntersection(l,i.y),this.addBorderIntersection(l,e.y)}else{const l=e.y===0?2:3;this.addBorderIntersection(l,i.x),this.addBorderIntersection(l,e.x)}}centroid(){return this.accCount===0?new ft(0,0):new ft(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function KT(n,e){const i=n.add(e)._unit(),l=be(n.x*i.x+n.y*i.y,-1,1);var u,f,p;return u=Math.acos(l),Math.min(4,Math.max(-4,Math.tan(u)))/4*S3*((f=n).x*(p=e).y-f.y*p.x<0?-1:1)}const T3=[n=>n.x<0,n=>n.x>vt,n=>n.y<0,n=>n.y>vt];function E3(n,e,i,l){const u=[4];if(l===0)return u;i._mult(l);const f=n.sub(i),p=e.sub(i),y=[n,e,f,p];for(let w=0;w<4;w++)for(const E of y)if(T3[w](E)){u.push(w);break}return u}class $b{constructor(e){this.vertexArray=new zm,this.indexArray=new bn,this.programConfigurations=new zo(e.layers,{zoom:e.zoom,lut:e.lut},i=>b3.includes(i)),this._segments=new Fi,this.hiddenByLandmarkVertexArray=new bf,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Fi}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,l,u=!1){const f=e.length;if(f>2){let p=Math.max(0,this._segments.get().length-1);const y=this._segments._prepareSegment(4*f,this.vertexArray.length,2*this._segmentToGroundQuads[p].length);let w;p!==this._segments.get().length-1&&(p++,this._segmentToGroundQuads[p]=[],this._segmentToRegionTriCounts[p]=[0,0,0,0,0]);{const E=e[0],A=e[1];w=KT(E.sub(e[f-1])._perp()._unit(),A.sub(E)._perp()._unit())}for(let E=0;E<f;E++){const A=E===f-1?0:E+1,P=e[E],M=e[A],O=e[A===f-1?0:A+1],D=M.sub(P)._perp()._unit(),V=KT(D,O.sub(M)._perp()._unit()),G=w,q=V;if(Gb(P,M,i)||u&&eE(P,i)&&eE(M,i)){w=V;continue}const te=y.vertexLength;ny(this.vertexArray,P,M,1,1,G),ny(this.vertexArray,P,M,1,0,G),ny(this.vertexArray,P,M,0,1,q),ny(this.vertexArray,P,M,0,0,q),y.vertexLength+=4;const re=E3(P,M,D,l);for(const oe of re)this._segmentToGroundQuads[p].push({id:te,region:oe}),this._segmentToRegionTriCounts[p][oe]+=2,y.primitiveLength+=2;w=V}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let l=0;l<i;l++)this._segmentToGroundQuads[l].sort((u,f)=>u.region-f.region);for(let l=0;l<i;l++){const u=this._segmentToGroundQuads[l],f=e[l],p=this._segmentToRegionTriCounts[l];p.reduce((w,E)=>w+E,0);let y=0;for(let w=0;w<=4;w++){const E=p[w];if(E!==0){let A=this.regionSegments[w];A||(A=this.regionSegments[w]=new Fi);const P={vertexOffset:f.vertexOffset,primitiveOffset:f.primitiveOffset+y,vertexLength:f.vertexLength,primitiveLength:E};A.get().push(P)}y+=E}for(let w=0;w<u.length;w++){const E=u[w].id;this.indexArray.emplaceBack(E,E+1,E+3),this.indexArray.emplaceBack(E,E+3,E+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,l,u,f,p,y){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,l,u,f,p,void 0,y)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,f3.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,l,u,f,p,y,w){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,l,u,f,p,y,w)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&lu))}updateHiddenByLandmarkRange(e,i,l){if(!this.hasData())return;const u=i+e;if(i!==0){for(let f=e;f<u;++f)this.hiddenByLandmarkVertexArray.emplace(f,l?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,g3.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class sy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new bn,this.footprintVertices=new hl,this.footprintSegments=[],this.layoutVertexArray=new ic,this.centroidVertexArray=new V0,this.wallVertexArray=new G0,this.indexArray=new bn,this.programConfigurations=new zo(e.layers,{zoom:e.zoom,lut:e.lut},i=>v3.includes(i)),this.segments=new Fi,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new $b(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,l,u){this.features=[],this.hasPattern=Rb("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=De(l),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:f,id:p,index:y,sourceLayerIndex:w}of e){const E=this.layers[0]._featureFilter.needGeometry,A=dt(f,E);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom,{worldview:this.worldview}),A,l))continue;const P={id:p,sourceLayerIndex:w,index:y,geometry:E?A.geometry:Et(f,l,u),properties:f.properties,type:f.type,patterns:{}},M=this.layoutVertexArray.length,O=Vb[P.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:f.id,feature:Lb("fill-extrusion",this.layers,P,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(const D of P.geometry)for(const V of HT(D,O))this.addFeature(f.id,P,[V],y,l,{},i.availableImages,u,i.brightness);else this.addFeature(f.id,P,P.geometry,y,l,{},i.availableImages,u,i.brightness);i.featureIndex.insert(f,P.geometry,y,w,this.index,M)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,l,u,f,p){for(const{featureId:y,feature:w}of this.features){const E=Vb[w.type]==="Polygon",{geometry:A}=w;if(this.wallMode)for(const P of A)for(const M of HT(P,E))this.addFeature(y,w,[M],w.index,i,l,u,f,p);else this.addFeature(y,w,A,w.index,i,l,u,f,p)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,l,u,f,p,y){this.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y,this.worldview),this.groundEffect.update(e,i,f,l,u,p,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,y3),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,m3.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,_3.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,p3.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,l,u,f,p,y,w,E){const A=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,P=[new ft(0,0),new ft(vt,vt)],M=w.projection,O=M.name==="globe",D=this.wallMode||Vb[i.type]==="Polygon",V=new YT;V.centroidDataIndex=this.centroidData.length;const G=new XT;G.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(G.buildingId=i.properties.building_id);const q=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},f)<=0,te=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},f);let re;if(G.height=te,G.vertexArrayOffset=this.layoutVertexArray.length,G.groundVertexArrayOffset=this.groundEffect.vertexArray.length,O&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new gf),this.wallMode){if(O)return void Lr("Non zero fill-extrusion-line-width is not yet supported on globe.");if(l.length!==1)return;re=function(Oe){const et=Oe[0].x===Oe[Oe.length-1].x&&Oe[0].y===Oe[Oe.length-1].y;(function(xt){let Bt=0;const sr=xt.length;for(let St=0;St<sr;St++)Bt+=(xt[(St+1)%sr].x-xt[St].x)*(xt[(St+1)%sr].y+xt[St].y);return Bt>=0})(Oe)||(Oe=Oe.reverse());const rt={geometry:[],joinNormals:[],indices:[]},st=[],ht=[],Ke=[];let at=Oe.length;for(;at>=2&&Oe[at-1].equals(Oe[at-2]);)at--;if(at<(et?3:2))return rt;let $e,Be,pt,ut,$t,It=0;for(;It<at-1&&Oe[It].equals(Oe[It+1]);)It++;et&&($e=Oe[at-2],$t=Oe[It].sub($e)._unit()._perp());for(let xt=It;xt<at;xt++){if(pt=xt===at-1?et?Oe[It+1]:void 0:Oe[xt+1],pt&&Oe[xt].equals(pt))continue;$t&&(ut=$t),$e&&(Be=$e),$e=Oe[xt],$t=pt?pt.sub($e)._unit()._perp():ut,ut=ut||$t;let Bt=ut.add($t);Bt.x===0&&Bt.y===0||Bt._unit();const sr=Bt.x*$t.x+Bt.y*$t.y,St=sr!==0?1/sr:1/0,jt=ut.x*$t.y-ut.y*$t.x>0;let Kt="miter";const ur=2;Kt==="miter"&&St>ur&&(Kt="bevel"),Kt==="bevel"&&(St>100&&(Kt="flipbevel"),St<ur&&(Kt="miter"));const Ir=(mr,Mt,hr,Fr)=>{const ue=new ft(mr.x,mr.y),de=new ft(mr.x,mr.y);ue.x+=Mt.x*Fr,ue.y+=Mt.y*Fr,de.x-=Mt.x*Math.max(hr,1),de.y-=Mt.y*Math.max(hr,1),Ke.push(Mt),st.push(ue),ht.push(de)};if(Kt==="miter")Bt._mult(St),Ir($e,Bt,0,0);else if(Kt==="flipbevel")Bt=$t.mult(-1),Ir($e,Bt,0,0),Ir($e,Bt.mult(-1),0,0);else{const mr=-Math.sqrt(St*St-1),Mt=jt?mr:0,hr=jt?0:mr;Be&&Ir($e,ut,Mt,hr),pt&&Ir($e,$t,Mt,hr)}}rt.geometry=[...st,...ht.reverse(),st[0]],rt.joinNormals=[...Ke,...Ke.reverse(),Ke[Ke.length-1]];const Lt=rt.geometry.length-1;for(let xt=0;xt<Lt/2;xt++)if(xt+1<Lt/2){let Bt=xt,sr=xt+1,St=Lt-1-xt,jt=Lt-2-xt;Bt=Bt===0?Lt-1:Bt-1,sr=sr===0?Lt-1:sr-1,St=St===0?Lt-1:St-1,jt=jt===0?Lt-1:jt-1,rt.indices.push(St),rt.indices.push(sr),rt.indices.push(Bt),rt.indices.push(St),rt.indices.push(jt),rt.indices.push(sr)}return rt}(l[0]),l=[re.geometry]}const oe=(Oe,et)=>Oe<(et.length-1)/2||Oe===et.length-1,xe=this.wallMode?[l]:rg(l,500);for(let Oe=xe.length-1;Oe>=0;Oe--){const et=xe[Oe];(et.length===0||(ve=et[0]).every(ct=>ct.x<=0)||ve.every(ct=>ct.x>=vt)||ve.every(ct=>ct.y<=0)||ve.every(ct=>ct.y>=vt))&&xe.splice(Oe,1)}var ve;let Se;if(O)Se=nE(xe,P,f);else{Se=[];for(const Oe of xe)Se.push({polygon:Oe,bounds:P})}const Ce=D?this.edgeRadius:0,Ae=Ce>0&&this.zoom<17,Qe=(Oe,et)=>{if(Oe.length===0)return!1;const ct=Oe[Oe.length-1];return et.x===ct.x&&et.y===ct.y};for(const{polygon:Oe,bounds:et}of Se){let ct=0,rt=0;for(const at of Oe)D&&!at[0].equals(at[at.length-1])&&at.push(at[0]),rt+=D?at.length-1:at.length;const st=this.segments.prepareSegment((D?5:4)*rt,this.layoutVertexArray,this.indexArray);G.footprintSegIdx<0&&(G.footprintSegIdx=this.footprintSegments.length),G.polygonSegIdx<0&&(G.polygonSegIdx=this.polygonSegments.length);const ht={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ke=new ZT;if(Ke.vertexOffset=this.footprintVertices.length,Ke.indexOffset=3*this.footprintIndices.length,Ke.ringIndices=[],D){const at=[],$e=[];ct=st.vertexLength;for(let pt=0;pt<Oe.length;pt++){const ut=Oe[pt];ut.length&&pt!==0&&$e.push(at.length/2);const $t=[];let It,Lt;It=ut[1].sub(ut[0])._perp()._unit(),Ke.ringIndices.push(ut.length-1);for(let xt=1;xt<ut.length;xt++){const Bt=ut[xt],sr=ut[xt===ut.length-1?1:xt+1],St=Bt.clone();if(Ce){Lt=sr.sub(Bt)._perp()._unit();const jt=It.add(Lt)._unit(),Kt=Ce*Math.min(4,1/(It.x*jt.x+It.y*jt.y));St.x+=Kt*jt.x,St.y+=Kt*jt.y,St.x=Math.round(St.x),St.y=Math.round(St.y),It=Lt}if(!q||Ce!==0&&!Ae||Qe($t,St)||$t.push(St),ng(this.layoutVertexArray,St.x,St.y,0,0,1,1,0),this.wallMode){const jt=oe(xt,ut);sg(this.wallVertexArray,re.joinNormals[xt],!jt)}st.vertexLength++,this.footprintVertices.emplaceBack(Bt.x,Bt.y),at.push(Bt.x,Bt.y),O&&og(this.layoutVertexExtArray,M.projectTilePoint(St.x,St.y,f),M.upVector(f,St.x,St.y))}q&&(Ce===0||Ae)&&($t.length!==0&&Qe($t,$t[0])&&$t.pop(),this.groundEffect.addData($t,et,A))}const Be=this.wallMode?re.indices:Cf(at,$e);for(let pt=0;pt<Be.length;pt+=3)this.footprintIndices.emplaceBack(Ke.vertexOffset+Be[pt+0],Ke.vertexOffset+Be[pt+1],Ke.vertexOffset+Be[pt+2]),this.indexArray.emplaceBack(ct+Be[pt],ct+Be[pt+2],ct+Be[pt+1]),st.primitiveLength++;Ke.indexCount+=Be.length,Ke.vertexCount+=this.footprintVertices.length-Ke.vertexOffset}for(let at=0;at<Oe.length;at++){const $e=Oe[at];V.startRing(G,$e[0]);let Be=$e.length>4&&tE($e[$e.length-2],$e[0],$e[1]),pt=Ce?I3($e[$e.length-2],$e[0],$e[1],Ce):0;const ut=[];let $t,It,Lt;It=$e[1].sub($e[0])._perp()._unit();let xt=!0;for(let Bt=1,sr=0;Bt<$e.length;Bt++){let St=$e[Bt-1],jt=$e[Bt];const Kt=$e[Bt===$e.length-1?1:Bt+1];if(V.appendEdge(G,jt,St),Gb(jt,St,et)){Ce&&(It=Kt.sub(jt)._perp()._unit(),xt=!xt);continue}const ur=jt.sub(St)._perp(),Ir=ur.x/(Math.abs(ur.x)+Math.abs(ur.y)),mr=ur.y>0?1:0,Mt=St.dist(jt);if(sr+Mt>32768&&(sr=0),Ce){Lt=Kt.sub(jt)._perp()._unit();let de=QT(St,jt,Kt,JT(It,Lt),Ce);isNaN(de)&&(de=0);const Ve=jt.sub(St)._unit();St=St.add(Ve.mult(pt))._round(),jt=jt.add(Ve.mult(-de))._round(),pt=de,It=Lt,q&&this.zoom>=17&&(Qe(ut,St)||ut.push(St),Qe(ut,jt)||ut.push(jt))}const hr=st.vertexLength,Fr=$e.length>4&&tE(St,jt,Kt);let ue=rE(sr,Be,xt);if(ng(this.layoutVertexArray,St.x,St.y,Ir,mr,0,0,ue),ng(this.layoutVertexArray,St.x,St.y,Ir,mr,0,1,ue),this.wallMode){const de=oe(Bt-1,$e),Ve=re.joinNormals[Bt-1];sg(this.wallVertexArray,Ve,de),sg(this.wallVertexArray,Ve,de)}if(sr+=Mt,ue=rE(sr,Fr,!xt),Be=Fr,ng(this.layoutVertexArray,jt.x,jt.y,Ir,mr,0,0,ue),ng(this.layoutVertexArray,jt.x,jt.y,Ir,mr,0,1,ue),this.wallMode){const de=oe(Bt,$e),Ve=re.joinNormals[Bt];sg(this.wallVertexArray,Ve,de),sg(this.wallVertexArray,Ve,de)}if(st.vertexLength+=4,this.indexArray.emplaceBack(hr+0,hr+1,hr+2),this.indexArray.emplaceBack(hr+1,hr+3,hr+2),st.primitiveLength+=2,Ce){const de=ct+(Bt===1?$e.length-2:Bt-2),Ve=Bt===1?ct:de+1;if(this.indexArray.emplaceBack(hr+1,de,hr+3),this.indexArray.emplaceBack(de,Ve,hr+3),st.primitiveLength+=2,$t===void 0&&($t=hr),!Gb(Kt,$e[Bt],et)){const Je=Bt===$e.length-1?$t:st.vertexLength;this.indexArray.emplaceBack(hr+2,hr+3,Je),this.indexArray.emplaceBack(hr+3,Je+1,Je),this.indexArray.emplaceBack(hr+3,Ve,Je+1),st.primitiveLength+=3}xt=!xt}if(O){const de=this.layoutVertexExtArray,Ve=M.projectTilePoint(St.x,St.y,f),Je=M.projectTilePoint(jt.x,jt.y,f),wt=M.upVector(f,St.x,St.y),bt=M.upVector(f,jt.x,jt.y);og(de,Ve,wt),og(de,Ve,wt),og(de,Je,bt),og(de,Je,bt)}}D&&(ct+=$e.length-1),q&&Ce&&this.zoom>=17&&(ut.length!==0&&Qe(ut,ut[0])&&ut.pop(),this.groundEffect.addData(ut,et,A,Ce>0))}this.footprintSegments.push(Ke),ht.triangleCount=this.indexArray.length-ht.triangleArrayOffset,this.polygonSegments.push(ht),++G.footprintSegLen,++G.polygonSegLen}if(G.vertexCount=this.layoutVertexArray.length-G.vertexArrayOffset,G.groundVertexCount=this.groundEffect.vertexArray.length-G.groundVertexArrayOffset,G.vertexCount!==0){if(G.centroidXY=V.borders?WT:this.encodeCentroid(V,G),this.centroidData.push(G),V.borders){this.featuresOnBorder.push(V);const Oe=this.featuresOnBorder.length-1;for(let et=0;et<V.borders.length;et++)V.borders[et][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[et].push(Oe)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,u,p,y,f,E,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,u,p,y,f,E,this.worldview),this.maxHeight=Math.max(this.maxHeight,te)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,l)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[l].borders[e][0])}splitToSubtiles(){const e=[];for(let y=0;y<this.centroidData.length;y++){const w=this.centroidData[y],E=+(w.min.y+w.max.y>vt),A=2*E+(+(w.min.x+w.max.x>vt)^E);for(let P=0;P<w.polygonSegLen;P++){const M=w.polygonSegIdx+P;e.push({centroidIdx:y,subtile:A,polygonSegmentIdx:M,triangleSegmentIdx:this.polygonSegments[M].triangleSegIdx})}}const i=new bn;e.sort((y,w)=>y.triangleSegmentIdx===w.triangleSegmentIdx?y.subtile-w.subtile:y.triangleSegmentIdx-w.triangleSegmentIdx);let l=0,u=0,f=0;for(const y of e){if(y.triangleSegmentIdx!==l)break;f++}const p=e.length;for(;u!==e.length;){l=e[u].triangleSegmentIdx;let y=0,w=u,E=u;for(let A=w;A<f&&e[A].subtile===y;A++)E++;for(;w!==f;){const A=e[w];y=A.subtile;const P=this.centroidData[A.centroidIdx].min.clone(),M=this.centroidData[A.centroidIdx].max.clone(),O={vertexOffset:this.segments.segments[l].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[l].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let D=w;D<E;D++){const V=e[D],G=this.polygonSegments[V.polygonSegmentIdx],q=this.centroidData[V.centroidIdx].min,te=this.centroidData[V.centroidIdx].max,re=this.indexArray.uint16;for(let oe=G.triangleArrayOffset;oe<G.triangleArrayOffset+G.triangleCount;oe++)i.emplaceBack(re[3*oe],re[3*oe+1],re[3*oe+2]);O.primitiveLength+=G.triangleCount,P.x=Math.min(P.x,q.x),P.y=Math.min(P.y,q.y),M.x=Math.max(M.x,te.x),M.y=Math.max(M.y,te.y)}O.primitiveLength>0&&this.triangleSubSegments.push({segment:O,min:P,max:M}),w=E;for(let D=w;D<f&&e[D].subtile===e[w].subtile;D++)E++}u=f;for(let A=u;A<p&&e[A].triangleSegmentIdx===e[u].triangleSegmentIdx;A++)f++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,l){const u=new Fi;if(this.wallMode){for(const V of this.triangleSubSegments)u.segments.push(V.segment);return u}let f=0,p=0;const y=1<<e.canonical.z;if(i){const V=i.getMinMaxForTile(e);V&&(f=V.min,p=V.max)}p+=this.maxHeight;const w=e.toUnwrapped();let E;const A=[w.canonical.x/y+w.wrap,w.canonical.y/y],P=[(w.canonical.x+1)/y+w.wrap,(w.canonical.y+1)/y],M=(V,G,q)=>[V[0]*(1-q[0])+G[0]*q[0],V[1]*(1-q[1])+G[1]*q[1]],O=[],D=[];for(const V of this.triangleSubSegments){O[0]=V.min.x/vt,O[1]=V.min.y/vt,D[0]=V.max.x/vt,D[1]=V.max.y/vt;const G=M(A,P,O),q=M(A,P,D);if(new Qt([G[0],G[1],f],[q[0],q[1],p]).intersectsPrecise(l)===0){E&&(u.segments.push(E),E=void 0);continue}const te=V.segment;E&&E.vertexOffset!==te.vertexOffset&&(u.segments.push(E),E=void 0),E?(E.vertexLength+=te.vertexLength,E.primitiveLength+=te.primitiveLength):E={vertexOffset:te.vertexOffset,primitiveLength:te.primitiveLength,vertexLength:te.vertexLength,primitiveOffset:te.primitiveOffset,sortKey:void 0,vaos:{}}}return E&&u.segments.push(E),u}encodeCentroid(e,i){const l=e.centroid(),u=i.span(),f=Math.min(7,Math.round(u.x*this.tileToMeter/10)),p=Math.min(7,Math.round(u.y*this.tileToMeter/10));return new ft(be(l.x,1,vt-1)<<3|f,be(l.y,1,vt-1)<<3|p)}encodeBorderCentroid(e){if(!e.borders)return new ft(0,0);const i=e.borders,l=Number.MAX_VALUE;if(i[0][0]!==l||i[1][0]!==l){const u=i[0][0]!==l?0:1;return new ft(6|(i[0][0]!==l?0:65528),(i[u][0]+i[u][1])/2<<3|6)}{const u=i[2][0]!==l?2:3;return new ft((i[u][0]+i[u][1])/2<<3|6,6|(i[2][0]!==l?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,l=e.vertexCount+e.vertexArrayOffset,u=e.flags&lu?WT:e.centroidXY,f=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==u.y||f!==u.x){for(let p=i;p<l;++p)this.centroidVertexArray.emplace(p,u.x,u.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,l){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped());if(iy(this.activeReplacements,u))return;if(this.activeReplacements=u,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const p of this.centroidData)p.flags&=2147483647;const f=[];for(const p of this.activeReplacements){if(p.order<l)continue;const y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));if(p.footprint.buildingId){const w=p.footprint.buildingId;for(const E of this.centroidData)E.buildingId===w&&(E.flags|=lu)}else for(const w of this.centroidData)if(!(w.flags&lu||p.min.x>w.max.x||w.min.x>p.max.x||p.min.y>w.max.y||w.min.y>p.max.y))for(let E=0;E<w.footprintSegLen;E++){const A=this.footprintSegments[w.footprintSegIdx+E];if(f.length=0,C3(this.footprintVertices,A.vertexOffset,A.vertexCount,p.footprintTileId.canonical,e.canonical,f),Fb(p.footprint,f,this.footprintIndices.uint16,A.indexOffset,A.indexCount,-A.vertexOffset,-y)){w.flags|=lu;break}}}for(const p of this.centroidData)this.writeCentroidToBuffer(p);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,l){let u=!1;for(let f=0;f<l.footprintSegLen;f++){const p=this.footprintSegments[l.footprintSegIdx+f];let y=0;for(const w of p.ringIndices){for(let E=y,A=w+y-1;E<w+y;A=E++){const P=this.footprintVertices.int16[2*(E+p.vertexOffset)+0],M=this.footprintVertices.int16[2*(E+p.vertexOffset)+1],O=this.footprintVertices.int16[2*(A+p.vertexOffset)+1];M>i!=O>i&&e<(this.footprintVertices.int16[2*(A+p.vertexOffset)+0]-P)*(i-M)/(O-M)+P&&(u=!u)}y=w}}return u}getHeightAtTileCoord(e,i){let l=Number.NEGATIVE_INFINITY,u=!0;const f=4*(e+vt)*vt+(i+vt);if(this.partLookup.hasOwnProperty(f)){const p=this.partLookup[f];return p?{height:p.height,hidden:!!(p.flags&lu)}:void 0}for(const p of this.centroidData)e>p.max.x||p.min.x>e||i>p.max.y||p.min.y>i||p.height<=l||this.footprintContainsPoint(e,i,p)&&(l=p.height,this.partLookup[f]=p,u=!!(p.flags&lu));if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:u};this.partLookup[f]=void 0}}function JT(n,e){const i=n.add(e)._unit();return n.x*i.x+n.y*i.y}function I3(n,e,i,l){const u=e.sub(n)._perp()._unit(),f=i.sub(e)._perp()._unit();return QT(n,e,i,JT(u,f),l)}function QT(n,e,i,l,u){const f=Math.sqrt(1-l*l);return Math.min(n.dist(e)/3,e.dist(i)/3,u*f/l)}function Gb(n,e,i){return n.x<i[0].x&&e.x<i[0].x||n.x>i[1].x&&e.x>i[1].x||n.y<i[0].y&&e.y<i[0].y||n.y>i[1].y&&e.y>i[1].y}function eE(n,e){return n.x<e[0].x||n.x>e[1].x||n.y<e[0].y||n.y>e[1].y}function tE(n,e,i){if(n.x<0||n.x>=vt||e.x<0||e.x>=vt||i.x<0||i.x>=vt)return!1;const l=i.sub(e),u=l.perp(),f=n.sub(e);return(l.x*f.x+l.y*f.y)/Math.sqrt((l.x*l.x+l.y*l.y)*(f.x*f.x+f.y*f.y))>-.866&&u.x*f.x+u.y*f.y<0}function rE(n,e,i){const l=e?2|n:-3&n;return i?1|l:-2&l}function iE(){const n=Math.PI/32,e=Math.tan(n),i=z;return i*Math.sqrt(1+2*e*e)-i}function nE(n,e,i){const l=1<<i.z,u=_e(i.x/l),f=_e((i.x+1)/l),p=me(i.y/l),y=me((i.y+1)/l);return function(w,E,A,P,M=0,O){const D=[];if(!w.length||!A||!P)return D;const V=(ve,Se)=>{for(const Ce of ve)D.push({polygon:Ce,bounds:Se})},G=Math.ceil(Math.log2(A)),q=Math.ceil(Math.log2(P)),te=G-q,re=[];for(let ve=0;ve<Math.abs(te);ve++)re.push(te>0?0:1);for(let ve=0;ve<Math.min(G,q);ve++)re.push(0),re.push(1);let oe=w;if(oe=ey(oe,E[0].y-M,E[1].y+M,1),oe=ey(oe,E[0].x-M,E[1].x+M,0),!oe.length)return D;const xe=[];for(re.length?xe.push({polygons:oe,bounds:E,depth:0}):V(oe,E);xe.length;){const ve=xe.pop(),Se=ve.depth,Ce=re[Se],Ae=ve.bounds[0],Qe=ve.bounds[1],Oe=Ce===0?Ae.x:Ae.y,et=Ce===0?Qe.x:Qe.y,ct=O?O(Ce,Oe,et):.5*(Oe+et),rt=ey(ve.polygons,Oe-M,ct+M,Ce),st=ey(ve.polygons,ct-M,et+M,Ce);if(rt.length){const ht=[Ae,new ft(Ce===0?ct:Qe.x,Ce===1?ct:Qe.y)];re.length>Se+1?xe.push({polygons:rt,bounds:ht,depth:Se+1}):V(rt,ht)}if(st.length){const ht=[new ft(Ce===0?ct:Ae.x,Ce===1?ct:Ae.y),Qe];re.length>Se+1?xe.push({polygons:st,bounds:ht,depth:Se+1}):V(st,ht)}}return D}(n,e,Math.ceil((f-u)/11.25),Math.ceil((p-y)/11.25),1,(w,E,A)=>{if(w===0)return .5*(E+A);{const P=me((i.y+E/vt)/l);return(ge(.5*(me((i.y+A/vt)/l)+P))*l-i.y)*vt}})}function C3(n,e,i,l,u,f){const p=Math.pow(2,l.z-u.z);for(let y=0;y<i;y++){let w=n.int16[2*(y+e)+0],E=n.int16[2*(y+e)+1];w=(w+u.x*vt)*p-l.x*vt,E=(E+u.y*vt)*p-l.y*vt,f.push(new ft(w,E))}}let sE,oE;Pt(sy,"FillExtrusionBucket",{omit:["layers","features"]}),Pt(XT,"PartData"),Pt(ZT,"FootprintSegment"),Pt(YT,"BorderCentroidData"),Pt($b,"GroundEffect");class Rd extends ft{constructor(e,i,l){super(e,i),this.z=l}}class aE extends Rd{constructor(e,i,l,u){super(e,i,l),this.w=u}}function lE(n,e,i,l){const u=i==="x"?"y":"x",f=(l-n[i])/(e[i]-n[i]);n[u]=Math.round(n[u]+(e[u]-n[u])*f),n[i]=l,n.hasOwnProperty("z")&&(n.z=Yt(n.z,e.z,f)),n.hasOwnProperty("w")&&(n.w=Yt(n.w,e.w,f))}function cE(n,e,i,l){const u=i,f=l;for(const p of["x","y"]){let y=n,w=e;y[p]>=w[p]&&(y=e,w=n),y[p]<u&&w[p]>u&&lE(y,w,p,u),y[p]<f&&w[p]>f&&lE(w,y,p,f)}}function oy(n,e,i,l,u,f){const p=[];for(let y=0;y<n.length;y++){const w=n[y];let E;const A=p.length;let P=0;for(let M=0;M<w.length-1;M++){let O=w[M],D=w[M+1],V=0;const G=P;let q,te;f&&(V=Math.hypot(D.x-O.x,D.y-O.y),P+=V,q=O,te=D),O.x<e&&D.x<e||(O.x<e?O=new ft(e,O.y+(e-O.x)/(D.x-O.x)*(D.y-O.y))._round():D.x<e&&(D=new ft(e,O.y+(e-O.x)/(D.x-O.x)*(D.y-O.y))._round()),O.y<i&&D.y<i||(O.y<i?O=new ft(O.x+(i-O.y)/(D.y-O.y)*(D.x-O.x),i)._round():D.y<i&&(D=new ft(O.x+(i-O.y)/(D.y-O.y)*(D.x-O.x),i)._round()),O.x>=l&&D.x>=l||(O.x>=l?O=new ft(l,O.y+(l-O.x)/(D.x-O.x)*(D.y-O.y))._round():D.x>=l&&(D=new ft(l,O.y+(l-O.x)/(D.x-O.x)*(D.y-O.y))._round()),O.y>=u&&D.y>=u||(O.y>=u?O=new ft(O.x+(u-O.y)/(D.y-O.y)*(D.x-O.x),u)._round():D.y>=u&&(D=new ft(O.x+(u-O.y)/(D.y-O.y)*(D.x-O.x),u)._round()),E&&O.equals(E[E.length-1])||(E=[O],p.push(E),f&&f.push({progress:{min:G+uE(q,te,O)*V,max:1},parentIndex:y,prevPoint:q,nextPoint:te})),E.push(D),f&&(f[f.length-1].progress.max=G+uE(q,te,D)*V,f[f.length-1].nextPoint=te)))))}if(f&&P>0)for(let M=A;M<p.length;M++)f[M].progress.min/=P,f[M].progress.max/=P}return p}function A3(n,e,i,l,u){if(n.length<2)return void l.push(n);const f=[];for(;e.valid();){const[E,A]=e.get();for(let P=0;P<n.length-1;P++){const M=n[P],O=n[P+1],D=Xi(M,O,E,A);if(D){const[V]=D,G=new ft(Yt(M.x,O.x,V),Yt(M.y,O.y,V));f.push({t:P+V,distance:0,point:G})}}e.next()}if(f.length===0)return void l.push(n);f.sort((E,A)=>E.t-A.t);let p=0,y=0,w=[];for(l.push(w);p!==n.length;){if(y===f.length){for(;p!==n.length;)w.length!==0&&w[w.length-1].equals(n[p])||w.push(n[p]),p++;break}f[y].t<=p?(w.length!==0&&w[w.length-1].equals(f[y].point)||w.push(f[y].point),Math.trunc(f[y].t),y++):(w.length!==0&&w[w.length-1].equals(n[p])||w.push(n[p]),p++)}}function uE(n,e,i){return n.x!==e.x?(i.x-n.x)/(e.x-n.x):n.y!==e.y?(i.y-n.y)/(e.y-n.y):0}function ag(n,e){return n.x*e.x+n.y*e.y}function dE(n,e){if(n.length===1){let i=0;const l=e[i++];let u;for(;!u||l.equals(u);)if(u=e[i++],!u)return 1/0;for(;i<e.length;i++){const f=e[i],p=n[0],y=u.sub(l),w=f.sub(l),E=p.sub(l),A=ag(y,y),P=ag(y,w),M=ag(w,w),O=ag(E,y),D=ag(E,w),V=A*M-P*P,G=(M*O-P*D)/V,q=(A*D-P*O)/V,te=l.z*(1-G-q)+u.z*G+f.z*q;if(isFinite(te))return te}return 1/0}{let i=1/0;for(const l of e)i=Math.min(i,l.z);return i}}function hE(n,e,i,l,u,f,p,y){const w=p*u.getElevationAt(n,e,!0,!0),E=f[0]!==0,A=E?f[1]===0?p*(f[0]/7-450):p*function(P,M,O){const D=Math.floor(M[0]/8),V=Math.floor(M[1]/8),G=10*(M[0]-8*D),q=10*(M[1]-8*V),te=P.getElevationAt(D,V,!0,!0),re=P.getMeterToDEM(O),oe=Math.floor(.5*(G*re-1)),xe=Math.floor(.5*(q*re-1)),ve=P.tileCoordToPixel(D,V),Se=2*oe+1,Ce=2*xe+1,Ae=function(st,ht,Ke,at,$e){return[st.getElevationAtPixel(ht,Ke,!0),st.getElevationAtPixel(ht+$e,Ke,!0),st.getElevationAtPixel(ht,Ke+$e,!0),st.getElevationAtPixel(ht+at,Ke+$e,!0)]}(P,ve.x-oe,ve.y-xe,Se,Ce),Qe=Math.abs(Ae[0]-Ae[1]),Oe=Math.abs(Ae[2]-Ae[3]),et=Math.abs(Ae[0]-Ae[2])+Math.abs(Ae[1]-Ae[3]),ct=Math.min(.25,.5*re*(Qe+Oe)/Se),rt=Math.min(.25,.5*re*et/Ce);return te+Math.max(ct*G,rt*q)}(u,f,y):w;return{base:w+(i===0?-1:i),top:E?Math.max(A+l,w+i+2):w+l}}class P3{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class k3{constructor(){this.tasks={},this.taskQueue=[],tr(["process"],this),this.invoker=new P3(this.process),this.nextId=0}add(e,i){const l=this.nextId++,u=function({type:f,isSymbolTile:p,zoom:y}){return y=y||0,f==="message"?0:f!=="maybePrepare"||p?f!=="parseTile"||p?f==="parseTile"&&p?300-y:f==="maybePrepare"&&p?400-y:500:200-y:100-y}(i);if(u===0){try{e()}finally{}return null}return this.tasks[l]={fn:e,metadata:i,priority:u,id:l},this.taskQueue.push(l),this.invoker.trigger(),{cancel:()=>{delete this.tasks[l]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(l=>!!this.tasks[l]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let u=0;u<this.taskQueue.length;u++){const f=this.tasks[this.taskQueue[u]];f.priority<i&&(i=f.priority,e=u)}if(e===null)return null;const l=this.taskQueue[e];return this.taskQueue.splice(e,1),l}remove(){this.invoker.remove()}}class fE{constructor(e,i,l){this.target=e,this.parent=i,this.mapId=l,this.callbacks={},this.cancelCallbacks={},tr(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new k3}send(e,i,l,u,f=!1,p){const y=Math.round(1e18*Math.random()).toString(36).substring(0,10);l&&(l.metadata=p,this.callbacks[y]=l);const w=new Set;return this.target.postMessage({id:y,type:e,hasCallback:!!l,targetMapId:u,mustQueue:f,sourceMapId:this.mapId,data:ll(i,w)},w),{cancel:()=>{l&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:u,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const l=i.id;if(l&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const u=this.cancelCallbacks[l];delete this.cancelCallbacks[l],u&&u.cancel()}else if(i.mustQueue||fi(self)){const u=this.callbacks[l],f=this.scheduler.add(()=>this.processTask(l,i),u&&u.metadata||{type:"message"});f&&(this.cancelCallbacks[l]=f)}else this.processTask(l,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const l=this.callbacks[e];delete this.callbacks[e],l&&(i.error?l(cl(i.error)):l(null,cl(i.data)))}else{const l=new Set,u=i.hasCallback?(p,y)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:p?ll(p):null,data:ll(y,l)},l)}:()=>{},f=cl(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,f,u);else if(this.parent.getWorkerSource){const p=i.type.split("."),{source:y,scope:w}=f;this.parent.getWorkerSource(i.sourceMapId,p[0],y,w)[p[1]](f,u)}else u(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var lg={workerUrl:"",workerClass:null,workerParams:void 0};const qb="mapboxgl_preloaded_worker_pool";class Ld{constructor(){this.active={}}acquire(e,i=Ld.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(lg.workerClass!=null?new lg.workerClass:new self.Worker(lg.workerUrl,lg.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[qb]}numActive(){return Object.keys(this.active).length}}Ld.workerCount=2;class Pf{constructor(e,i,l="Worker",u=Ld.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=ot();const f=this.workerPool.acquire(this.id,u);for(let p=0;p<f.length;p++){const y=new Pf.Actor(f[p],i,this.id);y.name=`${l} ${p}`,this.actors.push(y)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,l){qe(this.actors,(u,f)=>{u.send(e,i,f)},l=l||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let cg,Hb;function ay(){return cg||(cg=new Ld),cg}Pf.Actor=fE;class M3{constructor(e){this.module=e}createIntArray(e){const i=new Int32Array(e),l=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,l/i.BYTES_PER_ELEMENT),l}createFloatArray(e){const i=new Float32Array(e),l=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,l/i.BYTES_PER_ELEMENT),l}createStringBuffer(e){const i=this.module.malloc(e.length+1);for(let l=0;l<e.length;++l)this.module.heapU8[i+l]=e.charCodeAt(l);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.entranceColorRgb,l=e.facadeGlazingColorRgb,u=e.roofColorRgb,f=e.wallColorRgb,p=e.normalScale;this.module.setStyle(i[0],i[1],i[2],l[0],l[1],l[2],u[0],u[1],u[2],f[0],f[1],f[2],p[0],p[1],p[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,l){this.module.setFauxFacadeOptions(e?1:0,i?1:0,l)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){for(const y of e){const w=this.createStringBuffer(y.roofType),E=[0],A=[];for(const O of y.coordinates)if(Array.isArray(O)){for(const D of O)A.push(D.x),A.push(D.y);E.push(A.length)}const P=this.createIntArray(E),M=this.createFloatArray(A);this.module.addFeature(y.id,y.sourceId,y.minHeight,y.height,w,y.roofType.length,M,P,E.length-1),this.module.free(w),this.module.free(P),this.module.free(M)}for(const y of i){let w;w=y.entrances?JSON.parse(y.entrances):[];const E=this.createFloatArray(w),A=[];for(const M of y.coordinates)A.push(M.x),A.push(M.y);const P=this.createFloatArray(A);this.module.addFacade(y.sourceId,y.crossPerc,y.distanceToRoad,E,w.length,P,A.length),this.module.free(E),this.module.free(P)}if(!this.module.generateMesh()){const y=this.module.getLastError();return this.readStringBuffer(y)}const l=this.module.getMeshCount(),u=new Array(l);for(let y=0;y<l;y++){const w=this.module.getPositionsPtr(y),E=this.module.getPositionsLength(y),A=new Float32Array(this.module.heapF32.buffer,w,E),P=this.module.getNormalsPtr(y),M=this.module.getNormalsLength(y),O=new Float32Array(this.module.heapF32.buffer,P,M),D=this.module.getColorsPtr(y),V=this.module.getColorsLength(y),G=new Uint8Array(this.module.heapU8.buffer,D,V),q=this.module.getAOPtr(y),te=this.module.getAOLength(y),re=new Float32Array(this.module.heapF32.buffer,q,te),oe=this.module.getUVPtr(y),xe=this.module.getUVLength(y),ve=new Float32Array(this.module.heapF32.buffer,oe,xe),Se=this.module.getFauxFacadePtr(y),Ce=this.module.getFauxFacadeLength(y),Ae=new Uint8Array(this.module.heapU8.buffer,Se,Ce),Qe=this.module.getIndicesPtr(y),Oe=this.module.getIndicesLength(y),et=new Int32Array(this.module.heap32.buffer,Qe,Oe),ct=this.module.getBuildingPart(y),rt=this.readStringBuffer(ct);u[y]={positions:A,normals:O,colors:G,ao:re,uv:ve,isFauxFacade:Ae,indices:et,buildingPart:rt}}const f=this.module.getRingCount(),p=[];for(let y=0;y<f;y++){const w=this.module.getRingPtr(y),E=this.module.getRingLength(y),A=new Float32Array(this.module.heapF32.buffer,w,E);p.push(A)}return{meshes:u,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:p}}}let ug,Wb,Ma,kf,Zb,Mf=null,Nf=null,pE=null,ly=null;function mE(){return fi(self)&&self.worker.dracoUrl?self.worker.dracoUrl:Wb||is.DRACO_URL}function gE(){if(fi(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(kf)return kf;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return kf=WebAssembly.validate(n)?is.MESHOPT_SIMD_URL:is.MESHOPT_URL,kf}function N3(){return ly}const cy={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},R3={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},dg={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function _E(n,e,i){const l=i.json.bufferViews.length,u=i.buffers.length;e.bufferView=l,i.json.bufferViews[l]={buffer:u,byteLength:n.byteLength},i.buffers[u]=n}const Xb="KHR_draco_mesh_compression";function L3(n,e){const i=n.extensions&&n.extensions[Xb];if(!i)return;const l=new Ma.Decoder,u=bE(e,i.bufferView),f=new Ma.Mesh;if(!l.DecodeArrayToMesh(u,u.byteLength,f))throw new Error("Failed to decode Draco mesh");const p=e.json.accessors[n.indices],y=cy[p.componentType],w=p.count*y.BYTES_PER_ELEMENT,E=Ma._malloc(w);y===Uint16Array?l.GetTrianglesUInt16Array(f,w,E):l.GetTrianglesUInt32Array(f,w,E),_E(Ma.memory.buffer.slice(E,E+w),p,e),Ma._free(E);for(const A of Object.keys(i.attributes)){const P=l.GetAttributeByUniqueId(f,i.attributes[A]),M=e.json.accessors[n.attributes[A]],O=R3[M.componentType],D=M.count*dg[M.type]*cy[M.componentType].BYTES_PER_ELEMENT,V=Ma._malloc(D);l.GetAttributeDataArrayForAllPoints(f,P,Ma[O],D,V),_E(Ma.memory.buffer.slice(V,V+D),M,e),Ma._free(V)}l.destroy(),f.destroy(),delete n.extensions[Xb]}const uy="EXT_meshopt_compression";function O3(n,e){if(!n.extensions||!n.extensions[uy])return;const i=n.extensions[uy],l=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),u=new Uint8Array(i.count*i.byteStride);Zb.decodeGltfBuffer(u,i.count,i.byteStride,l,i.mode,i.filter),n.buffer=e.buffers.length,n.byteOffset=0,e.buffers[n.buffer]=u.buffer,delete n.extensions[uy]}const yE=1179937895,xE=new TextDecoder("utf8");function vE(n,e){return new URL(n,e).href}function D3(n,e,i,l){return fetch(vE(n.uri,l)).then(u=>u.arrayBuffer()).then(u=>{e.buffers[i]=u})}function bE(n,e){const i=n.json.bufferViews[e];return new Uint8Array(n.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function j3(n,e,i,l){if(n.uri){const u=vE(n.uri,l);return fetch(u).then(f=>f.blob()).then(f=>createImageBitmap(f)).then(f=>{e.images[i]=f})}if(n.bufferView!==void 0){const u=bE(e,n.bufferView),f=new Blob([u],{type:n.mimeType});return createImageBitmap(f).then(p=>{e.images[i]=p})}}function wE(n,e=0,i){const l={json:null,images:[],buffers:[]};if(new Uint32Array(n,e,1)[0]===yE){const A=new Uint32Array(n,e);let P=2;const M=(A[P++]>>2)-3,O=A[P++]>>2;if(P++,l.json=JSON.parse(xE.decode(A.subarray(P,P+O))),P+=O,P<M){const D=A[P++];P++;const V=e+(P<<2);l.buffers[0]=n.slice(V,V+D)}}else l.json=JSON.parse(xE.decode(new Uint8Array(n,e)));const{buffers:u,images:f,meshes:p,extensionsUsed:y,bufferViews:w}=l.json;let E=Promise.resolve();if(u){const A=[];for(let P=0;P<u.length;P++){const M=u[P];M.uri?A.push(D3(M,l,P,i)):l.buffers[P]||(l.buffers[P]=null)}E=Promise.all(A)}return E.then(()=>{const A=[],P=y&&y.includes(Xb),M=y&&y.includes(uy);if(P&&A.push(function(){if(!Ma)return ug??(ug=function(O){let D,V=null;function G(){D=new Uint8Array(V.buffer)}function q(){throw new Error("Unexpected Draco error.")}const te={a:{a:q,d:function(re,oe,xe){return D.copyWithin(re,oe,oe+xe)},c:function(re){const oe=D.length,xe=Math.max(re>>>0,Math.ceil(1.2*oe)),ve=Math.ceil((xe-oe)/65536);try{return V.grow(ve),G(),!0}catch{return!1}},b:q}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(O,te):O.then(re=>re.arrayBuffer()).then(re=>WebAssembly.instantiate(re,te))).then(re=>{const{Rb:oe,Qb:xe,P:ve,T:Se,X:Ce,Ja:Ae,La:Qe,Qa:Oe,Va:et,Wa:ct,eb:rt,jb:st,f:ht,e:Ke,yb:at,zb:$e,Ab:Be,Bb:pt,Db:ut,Gb:$t}=re.instance.exports;V=Ke;const It=(()=>{let Lt=0,xt=0,Bt=0,sr=0;return St=>{Bt&&(oe(sr),oe(Lt),xt+=Bt,Bt=Lt=0),Lt||(xt+=128,Lt=xe(xt));const jt=St.length+7&-8;let Kt=Lt;jt>=xt&&(Bt=jt,Kt=sr=xe(jt));for(let ur=0;ur<St.length;ur++)D[Kt+ur]=St[ur];return Kt}})();return G(),ht(),{memory:Ke,_free:oe,_malloc:xe,Mesh:class{constructor(){this.ptr=ve()}destroy(){Se(this.ptr)}},Decoder:class{constructor(){this.ptr=Ae()}destroy(){st(this.ptr)}DecodeArrayToMesh(Lt,xt,Bt){const sr=It(Lt),St=Qe(this.ptr,sr,xt,Bt.ptr);return!!Ce(St)}GetAttributeByUniqueId(Lt,xt){return{ptr:Oe(this.ptr,Lt.ptr,xt)}}GetTrianglesUInt16Array(Lt,xt,Bt){et(this.ptr,Lt.ptr,xt,Bt)}GetTrianglesUInt32Array(Lt,xt,Bt){ct(this.ptr,Lt.ptr,xt,Bt)}GetAttributeDataArrayForAllPoints(Lt,xt,Bt,sr,St){rt(this.ptr,Lt.ptr,xt.ptr,Bt,sr,St)}},DT_INT8:at(),DT_UINT8:$e(),DT_INT16:Be(),DT_UINT16:pt(),DT_UINT32:ut(),DT_FLOAT32:$t()}})}(fetch(mE())),ug.then(O=>{Ma=O,ug=void 0}))}()),M&&A.push(function(){if(Zb)return;const O=function(D){let V;const G=WebAssembly.instantiateStreaming(D,{}).then(re=>{V=re.instance,V.exports.__wasm_call_ctors()}),q={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},te={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:G,supported:!0,decodeGltfBuffer(re,oe,xe,ve,Se,Ce){(function(Ae,Qe,Oe,et,ct,rt,st){const ht=Ae.exports.sbrk,Ke=et+3&-4,at=ht(Ke*ct),$e=ht(rt.length),Be=new Uint8Array(Ae.exports.memory.buffer);Be.set(rt,$e);const pt=Qe(at,et,ct,$e,rt.length);if(pt===0&&st&&st(at,Ke,ct),Oe.set(Be.subarray(at,at+et*ct)),ht(at-ht(0)),pt!==0)throw new Error(`Malformed buffer data: ${pt}`)})(V,V.exports[te[Se]],re,oe,xe,ve,V.exports[q[Ce]])}}}(fetch(gE()));return O.ready.then(()=>{Zb=O})}()),f)for(let O=0;O<f.length;O++)A.push(j3(f[O],l,O,i));return(A.length?Promise.all(A):Promise.resolve()).then(()=>{if(P&&p)for(const{primitives:O}of p)for(const D of O)L3(D,l);if(M&&p&&w)for(const O of w)O3(O,l);return l})})}function Yb(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Kb(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Jb{constructor(e,i,l,u){this.context=e,this.format=l,this.useMipmap=u&&u.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:u&&u.premultiply})}update(e,i){const l=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,u=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:f}=this,{gl:p}=f,{x:y,y:w}=i&&i.position?i.position:{x:0,y:0},E=y+l,A=w+u;!this.size||this.size[0]===E&&this.size[1]===A||(p.bindTexture(p.TEXTURE_2D,null),p.deleteTexture(this.texture),this.texture=p.createTexture(),this.size=null),p.bindTexture(p.TEXTURE_2D,this.texture),f.pixelStoreUnpackFlipY.set(!1),f.pixelStoreUnpack.set(1),f.pixelStoreUnpackPremultiplyAlpha.set(this.format===p.RGBA8&&(!i||i.premultiply!==!1));const P=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&E>0&&A>0){const M=this.useMipmap?Math.floor(Math.log2(Math.max(E,A)))+1:1;p.texStorage2D(p.TEXTURE_2D,M,this.format,E,A),this.size=[E,A]}this.size&&(P?p.texSubImage2D(p.TEXTURE_2D,0,y,w,Yb(this.format),Kb(this.format),e):"data"in e&&e.data&&p.texSubImage2D(p.TEXTURE_2D,0,y,w,l,u,Yb(this.format),Kb(this.format),e.data)),this.useMipmap&&p.generateMipmap(p.TEXTURE_2D)}bind(e,i,l=!1){const{context:u}=this,{gl:f}=u;f.bindTexture(f.TEXTURE_2D,this.texture),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,e),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap&&!l?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,i),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,l,u,f){const{context:p}=this,{gl:y}=p;y.bindTexture(y.TEXTURE_2D,this.texture),i!==this.magFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?e===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),l!==this.wrapS&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,l),this.wrapS=l),u!==this.wrapT&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,u),this.wrapT=u),f!==this.compareMode&&(f?(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,f)):y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.NONE),this.compareMode=f)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class hg{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:l}=this,{gl:u}=l;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}}const z3=Dr([{name:"a_pos_3f",components:3,type:"Float32"}]),F3=Dr([{name:"a_color_3f",components:3,type:"Float32"}]),B3=Dr([{name:"a_color_4f",components:4,type:"Float32"}]),U3=Dr([{name:"a_uv_2f",components:2,type:"Float32"}]),V3=Dr([{name:"a_normal_3f",components:3,type:"Float32"}]),$3=Dr([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),G3=Dr([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function SE(n,e){const i=dy(n.projection,n.zoom,n.width,n.height),l=function(f,p,y,w,E){const A=new U(y.lng-180*cu,y.lat),P=new U(y.lng+180*cu,y.lat),M=f.project(A.lng,A.lat),O=f.project(P.lng,P.lat),D=-Math.atan2(O.y-M.y,O.x-M.x),V=He.fromLngLat(y);V.y=be(V.y,-1+cu,1-cu);const G=V.toLngLat(),q=f.project(G.lng,G.lat),te=He.fromLngLat(G);te.x+=cu;const re=te.toLngLat(),oe=f.project(re.lng,re.lat),xe=EE(oe.x-q.x,oe.y-q.y,D),ve=He.fromLngLat(G);ve.y+=cu;const Se=ve.toLngLat(),Ce=f.project(Se.lng,Se.lat),Ae=EE(Ce.x-q.x,Ce.y-q.y,D),Qe=Math.abs(xe.x)/Math.abs(Ae.y),Oe=ae([]);Xe(Oe,Oe,-D*(1-(E?0:w)));const et=ae([]);return J(et,et,[1,1-(1-Qe)*w,1]),et[4]=-Ae.x/Ae.y*w,Xe(et,et,D),le(et,Oe,et),et}(n.projection,0,n.center,i,e),u=TE(n);return J(l,l,[u,u,1]),l}function TE(n){const e=n.projection,i=dy(n.projection,n.zoom,n.width,n.height),l=Qb(e,n.center),u=Qb(e,U.convert(e.center));return Math.pow(2,l*i+(1-i)*u)}function dy(n,e,i,l,u=1/0){const f=n.range;if(!f)return 0;const p=Math.min(u,Math.max(i,l)),y=Math.log2(p/1024);return Ge(f[0]+y,f[1]+y,e)}const cu=1/4e4;function Qb(n,e){const i=be(e.lat,-ye,ye),l=new U(e.lng-180*cu,i),u=new U(e.lng+180*cu,i),f=n.project(l.lng,i),p=n.project(u.lng,i),y=He.fromLngLat(l),w=He.fromLngLat(u),E=p.x-f.x,A=p.y-f.y,P=w.x-y.x,M=w.y-y.y,O=Math.sqrt((P*P+M*M)/(E*E+A*A));return Math.log2(O)}function EE(n,e,i){const l=Math.cos(i),u=Math.sin(i);return{x:n*l-e*u,y:n*u+e*l}}function IE(n,e,i){ae(n),Xe(n,n,Re(e[2])),Ee(n,n,Re(e[0])),je(n,n,Re(e[1])),J(n,n,i),le(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function hy(n,e,i,l,u,f,p,y){const w=[i[0]-e[0],i[1]-e[1],0],E=[l[0]-e[0],l[1]-e[1],0];if(fr(w)<1e-12||fr(E)<1e-12)return Ts(n);const A=Vi([],w,E);Yr(A,A),jr(E,l,e),w[2]=(f-u)*y,E[2]=(p-u)*y;const P=w;return Vi(P,w,E),Yr(P,P),Tc(n,A,P)}function ew(n,e,i=!1){const l=ou(e.zoom),u=function(f,p,y){const w=p.worldSize,E=[f[12],f[13],f[14]],A=me(E[1]/w),P=_e(E[0]/w),M=ae([]),O=pe(1,A)*w,D=pe(1,0)*w*Pe(A,p.zoom),V=1/Ab(w);let G=D*V;if(y){const oe=dy(p.projection,p.zoom,p.width,p.height,1024);G=V*p.projection.pixelSpaceConversion(p.center.lat,w,oe)}const q=R(A,P);Ut(q,q,rr([],Yr([],q),O*G*E[2]));const te=function(oe){const xe=[oe[0],oe[1],oe[2]];let ve=[0,1,0];const Se=Vi([],ve,xe);return Vi(ve,xe,Se),us(ve)===0&&(ve=[0,1,0],Vi(Se,xe,ve)),Yr(Se,Se),Yr(ve,ve),Yr(xe,xe),[Se[0],Se[1],Se[2],0,ve[0],ve[1],ve[2],0,xe[0],xe[1],xe[2],0,oe[0],oe[1],oe[2],1]}(q);J(M,M,[G,G,G*O]),se(M,M,[-E[0],-E[1],-E[2]]);const re=le([],p.globeMatrix,te);return le(re,re,M),le(re,re,f),re}(n,e,i);if(l>0){const f=function(p,y){const w=y.worldSize,E=pe(1,0)*w*Pe(y.center.lat,y.zoom)/Ab(w),A=pe(1,y.center.lat)*w,P=ae([]);je(P,P,Re(y.center.lng)),Ee(P,P,Re(y.center.lat)),se(P,P,[0,0,d]),J(P,P,[E,E,E*A]);const M=y.point;return se(P,P,[-M.x,-M.y,0]),le(P,P,p),le(P,y.globeMatrix,P)}(n,e);return function(p,y,w){const E=(D,V,G)=>{const q=fr(D),te=fr(V),re=ac(D,V,G);return rr(re,re,1/fr(re)*Yt(q,te,G))},A=E([p[0],p[1],p[2]],[y[0],y[1],y[2]],w),P=E([p[4],p[5],p[6]],[y[4],y[5],y[6]],w),M=E([p[8],p[9],p[10]],[y[8],y[9],y[10]],w),O=ac([p[12],p[13],p[14]],[y[12],y[13],y[14]],w);return[A[0],A[1],A[2],0,P[0],P[1],P[2],0,M[0],M[1],M[2],0,O[0],O[1],O[2],1]}(u,f,l)}return u}function CE(n,e,i,l){const u=Qt.projectAabbCorners(l,i);let f=Number.MAX_VALUE,p=-1;for(let E=0;E<u.length;++E){const A=u[E];A[0]=(.5*A[0]+.5)*e.width,A[1]=(.5-.5*A[1])*e.height,A[2]<f&&(p=E,f=A[2])}const y=E=>new ft(u[E][0],u[E][1]);let w;switch(p){case 0:case 6:w=[y(1),y(5),y(4),y(7),y(3),y(2),y(1)];break;case 1:case 7:w=[y(0),y(4),y(5),y(6),y(2),y(3),y(0)];break;case 3:case 5:w=[y(1),y(0),y(4),y(7),y(6),y(2),y(1)];break;default:w=[y(1),y(5),y(6),y(7),y(3),y(0),y(1)]}if(eo(n,w))return f}const Od=64,Rf={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function AE(n,e,i,l,u,f,p,y,w,E=!1){const A=i.zoom,P=i.project(l),M=Pe(l.lat,A),O=1/M;ae(n),se(n,n,[P.x+p[0]*O,P.y+p[1]*O,p[2]]);let D=1,V=1;const G=i.worldSize;if(E){if(i.projection.name==="mercator"){let oe=0;i.elevation&&(oe=i.elevation.getAtPointOrZero(new He(P.x/G,P.y/G),0));const xe=on([],[P.x,P.y,oe,1],i.projMatrix)[3]/i.cameraToCenterDistance;D=xe,V=xe*Pe(i.center.lat,A)}else if(i.projection.name==="globe"){const oe=ew(n,i),xe=[0,0,0,1];on(xe,xe,le([],i.projMatrix,oe));const ve=xe[3]/i.cameraToCenterDistance,Se=ou(A),Ce=i.projection.pixelsPerMeter(l.lat,G)*Pe(l.lat,A),Ae=i.projection.pixelsPerMeter(i.center.lat,G)*Pe(i.center.lat,A);D=ve/Yt(Ce,Fe(i.center.lat),Se),V=ve*M/Ce,D*=Ae,V*=Ae}}else D=O;J(n,n,[D,D,V]);const q=[...n],te=e.orientation,re=[];if(IE(re,[te[0]+u[0],te[1]+u[1],te[2]+u[2]],f),le(n,q,re),y&&i.elevation){let oe=0;const xe=[];if(w&&i.elevation){oe=function(Se,Ce,Ae,Qe,Oe){const et=Ce.elevation;if(!et)return 0;const ct=Qt.projectAabbCorners(Ae,Qe),rt=pe(1,Oe.lat)*Ce.worldSize,st=function(xt,Bt){const sr=[0,0,1],St=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const jt of St){const Kt=xt[jt.corners[0]],ur=xt[jt.corners[1]],Ir=xt[jt.corners[2]],mr=[ur[0]-Kt[0],ur[1]-Kt[1],Bt*(ur[2]-Kt[2])],Mt=Vi(mr,mr,[Ir[0]-Kt[0],Ir[1]-Kt[1],Bt*(Ir[2]-Kt[2])]);Yr(Mt,Mt),jt.dotProductWithUp=vi(Mt,sr)}return St.sort((jt,Kt)=>jt.dotProductWithUp-Kt.dotProductWithUp),St[0].corners}(ct,rt),ht=ct[st[0]],Ke=ct[st[1]],at=ct[st[2]],$e=ct[st[3]],Be=et.getAtPointOrZero(new He(ht[0]/Ce.worldSize,ht[1]/Ce.worldSize),0),pt=et.getAtPointOrZero(new He(Ke[0]/Ce.worldSize,Ke[1]/Ce.worldSize),0),ut=et.getAtPointOrZero(new He(at[0]/Ce.worldSize,at[1]/Ce.worldSize),0),$t=et.getAtPointOrZero(new He($e[0]/Ce.worldSize,$e[1]/Ce.worldSize),0),It=(Be+$t)/2,Lt=(pt+ut)/2;return It>Lt?pt<ut?hy(Se,Ke,$e,ht,pt,$t,Be,rt):hy(Se,at,ht,$e,ut,Be,$t,rt):Be<$t?hy(Se,ht,Ke,at,Be,pt,ut,rt):hy(Se,$e,at,Ke,$t,ut,pt,rt),Math.max(It,Lt)}(xe,i,e.aabb,n,l);const ve=le([],We([],xe),re);le(n,q,ve)}else oe=i.elevation.getAtPointOrZero(new He(P.x/G,P.y/G),0);oe!==0&&(n[14]+=oe)}}function fg(n,e,i=!1){n.uploaded||(n.gfxTexture=new Jb(e,n.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:n.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function q3(n,e,i){n.indexBuffer=e.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=e.createVertexBuffer(n.vertexArray,z3.members,!1,!0),n.normalArray&&(n.normalBuffer=e.createVertexBuffer(n.normalArray,V3.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=e.createVertexBuffer(n.texcoordArray,U3.members,!1,!0)),n.colorArray&&(n.colorBuffer=e.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?F3:B3).members,!1,!0)),n.featureArray&&(n.pbrBuffer=e.createVertexBuffer(n.featureArray,G3.members,!0)),n.segments=Fi.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const l=n.material;l.pbrMetallicRoughness.baseColorTexture&&fg(l.pbrMetallicRoughness.baseColorTexture,e),l.pbrMetallicRoughness.metallicRoughnessTexture&&fg(l.pbrMetallicRoughness.metallicRoughnessTexture,e),l.normalTexture&&fg(l.normalTexture,e),l.occlusionTexture&&fg(l.occlusionTexture,e,i),l.emissionTexture&&fg(l.emissionTexture,e)}function tw(n,e,i){if(n.meshes)for(const l of n.meshes)q3(l,e,i);if(n.children)for(const l of n.children)tw(l,e,i)}function fy(n){if(n.meshes)for(const e of n.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(n.children)for(const e of n.children)fy(e)}function rw(n){if(n.meshes)for(const i of n.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(n.children)for(const i of n.children)rw(i)}function Dd(n,e){const i=n.json.bufferViews[e.bufferView],l=cy[e.componentType];return new l(n.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==dg[e.type]*l.BYTES_PER_ELEMENT?i.byteStride/l.BYTES_PER_ELEMENT:dg[e.type]))}function iw(n,e,i,l){const u=cy[e.componentType],f=function(A){switch(A){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(u),p=n.json.bufferViews[e.bufferView],y=p.byteStride?p.byteStride/u.BYTES_PER_ELEMENT:dg[e.type],w=i.float32,E=w.length/i.capacity;for(let A=0,P=0;A<e.count*y;A+=y,P+=E)for(let M=0;M<E;M++)w[P+M]=l[A+M]*f;i._trim()}function H3(n,e,i){const l=n.indices,u=n.attributes,f={};f.indexArray=new bn;const p=e.json.accessors[l],y=p.count/3;f.indexArray.reserve(y);const w=Dd(e,p);for(let M=0;M<y;M++)f.indexArray.emplaceBack(w[3*M],w[3*M+1],w[3*M+2]);f.indexArray._trim(),f.vertexArray=new As;const E=e.json.accessors[u.POSITION];f.vertexArray.reserve(E.count);const A=Dd(e,E);for(let M=0;M<E.count;M++)f.vertexArray.emplaceBack(A[3*M],A[3*M+1],A[3*M+2]);if(f.vertexArray._trim(),f.aabb=new Qt(E.min,E.max),f.centroid=function(M,O){const D=[0,0,0],V=M.length;if(V>0){for(let G=0;G<V;G++){const q=3*M[G];D[0]+=O[q],D[1]+=O[q+1],D[2]+=O[q+2]}D[0]/=V,D[1]/=V,D[2]/=V}return D}(w,A),u.COLOR_0!==void 0){const M=e.json.accessors[u.COLOR_0],O=dg[M.type],D=Dd(e,M);f.colorArray=O===3?new As:new jo,f.colorArray.resize(M.count),iw(e,M,f.colorArray,D)}if(u.NORMAL!==void 0){f.normalArray=new As;const M=e.json.accessors[u.NORMAL];f.normalArray.resize(M.count);const O=Dd(e,M);iw(e,M,f.normalArray,O)}if(u.TEXCOORD_0!==void 0&&i.length>0){f.texcoordArray=new ru;const M=e.json.accessors[u.TEXCOORD_0];f.texcoordArray.resize(M.count);const O=Dd(e,M);iw(e,M,f.texcoordArray,O)}if(u._FEATURE_ID_RGBA4444!==void 0){const M=e.json.accessors[u._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(f.featureData=Dd(e,M))}u._FEATURE_RGBA4444!==void 0&&(f.featureData=new Uint32Array(Dd(e,e.json.accessors[u._FEATURE_RGBA4444]).buffer));const P=n.material;return f.material=function(M,O){const{emissiveFactor:D=[0,0,0],alphaMode:V="OPAQUE",alphaCutoff:G=.5,normalTexture:q,occlusionTexture:te,emissiveTexture:re,doubleSided:oe}=M,{baseColorFactor:xe=[1,1,1,1],metallicFactor:ve=1,roughnessFactor:Se=1,baseColorTexture:Ce,metallicRoughnessTexture:Ae}=M.pbrMetallicRoughness||{},Qe=te?O[te.index]:void 0;if(te&&te.extensions&&te.extensions.KHR_texture_transform&&Qe){const Oe=te.extensions.KHR_texture_transform;Qe.offsetScale=[Oe.offset[0],Oe.offset[1],Oe.scale[0],Oe.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new ti(...xe),metallicFactor:ve,roughnessFactor:Se,baseColorTexture:Ce?O[Ce.index]:void 0,metallicRoughnessTexture:Ae?O[Ae.index]:void 0},doubleSided:oe,emissiveFactor:new ti(...D),alphaMode:V,alphaCutoff:G,normalTexture:q?O[q.index]:void 0,occlusionTexture:Qe,emissionTexture:re?O[re.index]:void 0,defined:M.defined===void 0}}(P!==void 0?e.json.materials[P]:{defined:!1},i),f}function PE(n,e,i){const{matrix:l,rotation:u,translation:f,scale:p,mesh:y,extras:w,children:E}=n,A={};if(A.matrix=l||function(P,M,O,D){var V=M[0],G=M[1],q=M[2],te=M[3],re=V+V,oe=G+G,xe=q+q,ve=V*re,Se=V*oe,Ce=V*xe,Ae=G*oe,Qe=G*xe,Oe=q*xe,et=te*re,ct=te*oe,rt=te*xe,st=D[0],ht=D[1],Ke=D[2];return P[0]=(1-(Ae+Oe))*st,P[1]=(Se+rt)*st,P[2]=(Ce-ct)*st,P[3]=0,P[4]=(Se-rt)*ht,P[5]=(1-(ve+Oe))*ht,P[6]=(Qe+et)*ht,P[7]=0,P[8]=(Ce+ct)*Ke,P[9]=(Qe-et)*Ke,P[10]=(1-(ve+Ae))*Ke,P[11]=0,P[12]=O[0],P[13]=O[1],P[14]=O[2],P[15]=1,P}([],u||[0,0,0,1],f||[0,0,0],p||[1,1,1]),y!==void 0){A.meshes=i[y];const P=A.anchor=[0,0];for(const M of A.meshes){const{min:O,max:D}=M.aabb;P[0]+=O[0]+D[0],P[1]+=O[1]+D[1]}P[0]=Math.floor(P[0]/A.meshes.length/2),P[1]=Math.floor(P[1]/A.meshes.length/2)}if(w&&(w.id&&(A.id=w.id),w.lights&&(A.lights=function(P){if(!P.length)return[];const M=function(q){const te=atob(q),re=new Uint8Array(te.length);for(let oe=0;oe<te.length;oe++)re[oe]=te.codePointAt(oe);return re}(P),O=[],D=M.length/24,V=new Uint16Array(M.buffer),G=new Float32Array(M.buffer);for(let q=0;q<D;q++){const te=V[2*q*6]/30,re=V[2*q*6+1]/30,oe=V[2*q*6+10]/100,xe=G[6*q+1],ve=G[6*q+2],Se=G[6*q+3],Ce=G[6*q+4],Ae=Se-xe,Qe=Ce-ve,Oe=Math.hypot(Ae,Qe);O.push({pos:[xe+.5*Ae,ve+.5*Qe,re],normal:[Qe/Oe,-Ae/Oe,0],width:Oe,height:te,depth:oe,points:[xe,ve,Se,Ce]})}return O}(w.lights))),E){const P=[];for(const M of E)P.push(PE(e.json.nodes[M],e,i));A.children=P}return A}function W3(n){if(n.vertices.length===0||n.indices.length===0)return null;const e=new ty(n.vertices,n.indices,8,256),[i,l]=[e.min.clone(),e.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:e,min:i,max:l}}function Z3(n){if(!n.extras||!n.extras.ground)return null;const e=n.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const l=[];for(const p of i){if(!Array.isArray(p)||p.length!==2)continue;const y=p[0],w=p[1];typeof y=="number"&&typeof w=="number"&&l.push(new ft(y,w))}if(l.length<3)return null;l.length>1&&l[l.length-1].equals(l[0])&&l.pop();let u=0;for(let p=0;p<l.length;p++){const y=l[p],w=l[(p+1)%l.length],E=l[(p+2)%l.length];u+=(y.x-w.x)*(E.y-w.y)-(E.x-w.x)*(y.y-w.y)}u>0&&l.reverse();const f=Cf(l.flatMap(p=>[p.x,p.y]),[]);return f.length===0?null:{vertices:l,indices:f}}function X3(n,e){const i=[],l=[];let u=0;const f=[];for(const p of n){u=i.length;const y=p.vertexArray.float32,w=p.indexArray.uint16;for(let E=0;E<p.vertexArray.length;E++)f[0]=y[3*E+0],f[1]=y[3*E+1],f[2]=y[3*E+2],or(f,f,e),i.push(new ft(f[0],f[1]));for(let E=0;E<3*p.indexArray.length;E++)l.push(w[E]+u)}if(l.length%3!=0)return null;for(let p=0;p<l.length;p+=3){const y=i[l[p+0]],w=i[l[p+1]],E=i[l[p+2]];(y.x-w.x)*(E.y-w.y)-(E.x-w.x)*(y.y-w.y)>0&&([l[p+1],l[p+2]]=[l[p+2],l[p+1]])}return{vertices:i,indices:l}}function kE(n){const e=function(w,E){const A=[],P=WebGL2RenderingContext;if(w.json.textures)for(const M of w.json.textures){const O={magFilter:P.LINEAR,minFilter:P.NEAREST,wrapS:P.REPEAT,wrapT:P.REPEAT};M.sampler!==void 0&&Object.assign(O,w.json.samplers[M.sampler]),A.push({image:E[M.source],sampler:O,uploaded:!1})}return A}(n,n.images),i=function(w,E){const A=[];for(const P of w.json.meshes){const M=[];for(const O of P.primitives)M.push(H3(O,w,E));A.push(M)}return A}(n,e),{scenes:l,scene:u,nodes:f}=n.json,p=l?l[u||0].nodes:[...f.keys()],y=[];for(const w of p)y.push(PE(f[w],n,i));return function(w,E,A){const P={},M=new Set;for(let O=0;O<w.length;O++){const D=A[E[O]];if(!D.extras)continue;const V=D.extras["mapbox:footprint:version"],G=D.extras["mapbox:footprint:id"];(V||G)&&M.add(O),V==="1.0.0"&&G&&(P[G]=O)}for(let O=0;O<w.length;O++){if(M.has(O))continue;const D=w[O],V=A[E[O]];if(!V.extras)continue;let G=null;D.id in P&&(G=X3(w[P[D.id]].meshes,D.matrix)),G||(G=Z3(V)),G&&(D.footprint=W3(G))}if(M.size>0){const O=Array.from(M.values()).sort((D,V)=>D-V);for(let D=O.length-1;D>=0;D--)w.splice(O[D],1)}}(y,p,n.json.nodes),y}function Y3(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const e=n.vertexArray.float32,i=n.aabb.min[0]-1,l=n.aabb.min[1]-1,u=Od/(n.aabb.max[0]-i+2),f=Od/(n.aabb.max[1]-l+2);for(let p=0;p<e.length;p+=3){const y=e[p+2],w=(e[p+0]-i)*u|0,E=(e[p+1]-l)*f|0;y>n.heightmap[E*Od+w]&&(n.heightmap[E*Od+w]=y)}}function ME(n,e,i,l,u){i.reserve(i.length+4*n.length),l.reserve(l.length+10*n.length),u.reserve(u.length+10*n.length);let f=l.length;for(const p of n){const y=Math.min(10,Math.max(4,1.3*p.height))*e,w=[-p.normal[1],p.normal[0],0],E=Math.min(.29,.1*p.width/p.depth),A=p.width-2*p.depth*e*(E+.01),P=Nr([],p.pos,w,A/2),M=Nr([],p.pos,w,-A/2),O=[P[0],P[1],P[2]+p.height],D=[M[0],M[1],M[2]+p.height],V=Nr([],p.normal,w,E);rr(V,V,y);const G=Nr([],p.normal,w,-E);rr(G,G,y),Ut(V,P,V),Ut(G,M,G),P[2]+=.1,M[2]+=.1,l.emplaceBack(V[0],V[1],V[2]),l.emplaceBack(G[0],G[1],G[2]),l.emplaceBack(P[0],P[1],P[2]),l.emplaceBack(M[0],M[1],M[2]),l.emplaceBack(O[0],O[1],O[2]),l.emplaceBack(D[0],D[1],D[2]),l.emplaceBack(P[0],P[1],P[2]),l.emplaceBack(M[0],M[1],M[2]),l.emplaceBack(V[0],V[1],V[2]),l.emplaceBack(G[0],G[1],G[2]);const q=A/y/2;u.emplaceBack(-q-E,-1,q,.8),u.emplaceBack(q+E,-1,q,.8),u.emplaceBack(-q,0,q,1.3),u.emplaceBack(q,0,q,1.3),u.emplaceBack(q+E,-.8,q,.7),u.emplaceBack(q+E,-.8,q,.7),u.emplaceBack(0,0,q,1.3),u.emplaceBack(0,0,q,1.3),u.emplaceBack(q+E,-1.2,q,.8),u.emplaceBack(q+E,-1.2,q,.8),i.emplaceBack(6+f,4+f,8+f),i.emplaceBack(7+f,9+f,5+f),i.emplaceBack(0+f,1+f,2+f),i.emplaceBack(1+f,3+f,2+f),f+=10}}function K3(n,e){const i={};i.indexArray=new bn,i.vertexArray=new As,i.colorArray=new jo,ME(n,e,i.indexArray,i.vertexArray,i.colorArray);const l={defined:!0};l.emissiveFactor=ti.black;const u={};return u.baseColorFactor=ti.white,l.pbrMetallicRoughness=u,i.material=l,i.aabb=new Qt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const NE=Dr([{name:"a_pos_3f",components:3,type:"Float32"}]),J3=Dr([{name:"a_normal_3",components:3,type:"Int16"}]),Q3=Dr([{name:"a_centroid_3",components:3,type:"Int16"}]),RE=Dr([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),eL=Dr([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),tL=Dr([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),rL=Dr([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),iL=Dr([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),LE=lt.types,nw=32767;function nL(n,e){const i=vt+e;for(const l of n)for(const u of l)if(u.x<-e||u.x>i||u.y<-e||u.y>i)return!1;return!0}class OE{constructor(){this.layoutVertexArray=new As,this.layoutAttenuationArray=new jo,this.layoutColorArray=new pn,this.indexArray=new bn,this.indexArrayForConflation=new bn,this.segmentsBucket=new Fi}}class sw{constructor(){this.layoutVertexArray=new As,this.layoutNormalArray=new rc,this.layoutCentroidArray=new rc,this.layoutColorArray=new pn,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutAOArray=[],this.indexArray=new bn,this.indexArrayForConflation=new bn,this.segmentsBucket=new Fi,this.entranceBloom=new OE}}class DE{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new sw,this.buildingWithFacade=new sw,this.indexArrayForConflationUploaded=!1,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.buildingWithFacade.layoutFacadePaintArray=new pn,this.buildingWithFacade.layoutFacadeDataArray=new Qc,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new pn,this.programConfigurations=new zo(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.groundEffect=new $b(e)}updateFootprints(e,i){for(const l of this.footprints)i.push({footprint:l,id:e})}prepare(){return function(){if(ly!=null||pE!=null)return null;if(Nf!=null)return Nf;const e=fetch(is.BUILDING_GEN_URL);return Nf=function(i){let l,u,f,p;function y(){l=new Uint8Array(p.buffer),u=new Int32Array(p.buffer),f=new Float32Array(p.buffer)}function w(){throw new Error("Unexpected BuildingGen error.")}const E=()=>{},A={a:{a:w,f:function(P){const M=l.length,O=Math.max(P>>>0,Math.ceil(1.2*M)),D=Math.ceil((O-M)/65536);try{return p.grow(D),y(),!0}catch{return!1}},g:w,b:E,c:E,d:E,e:E}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,A):i.then(P=>P.arrayBuffer()).then(P=>WebAssembly.instantiate(P,A))).then(P=>{const M=P.instance.exports;return(0,M.g)(),p=M.f,y(),new M3({setStyle:M.h,setAOOptions:M.i,setMetricOptions:M.j,setStructuralOptions:M.k,setFacadeOptions:M.l,setFauxFacadeOptions:M.m,setFacadeClassifierOptions:M.n,addFeature:M.o,addFacade:M.p,generateMesh:M.q,getLastError:M.r,getOuterRingLength:M.s,getMeshCount:M.t,getPositionsPtr:M.u,getPositionsLength:M.v,getNormalsPtr:M.w,getNormalsLength:M.x,getColorsPtr:M.y,getColorsLength:M.z,getAOPtr:M.A,getAOLength:M.B,getUVPtr:M.C,getUVLength:M.D,getFauxFacadePtr:M.E,getFauxFacadeLength:M.F,getIndicesPtr:M.G,getIndicesLength:M.H,getBuildingPart:M.I,getRingCount:M.J,getRingPtr:M.K,getRingLength:M.L,free:M.M,malloc:M.N,heapU8:l,heap32:u,heapF32:f})})}(e).then(i=>(Nf=null,ly=i,ly)).catch(i=>{Lr("Could not load building-gen"),Nf=null,pE=i}),Nf}()}populate(e,i,l,u){const f=N3();if(!f)return;const p=De(l);this.tileToMeter=p,this.brightness=i.brightness,f.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,p],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:p,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),f.setAOOptions(!1,.3),f.setMetricOptions(!1,16),f.setStructuralOptions(!0),f.setFacadeClassifierOptions(3);const y=new Map;for(const{feature:w}of e){if(LE[w.type]!=="LineString")continue;const E=this.layers[0]._featureFilter.needGeometry,A=dt(w,E);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom),A,l))continue;const P=E?A.geometry:Et(w,l,u),M=[];for(const G of P)for(const q of G)M.push({x:q.x,y:q.y});const O={coordinates:M,crossPerc:w.properties.cross_perc,distanceToRoad:w.properties.distance_to_road,entrances:w.properties.entrances,sourceId:0},D=w.properties.source_id;let V=y.get(D);V||(V=[],y.set(D,V)),V.push(O)}this.maxHeight=0;for(const{feature:w,index:E}of e){if(LE[w.type]==="LineString")continue;const A=this.layers[0]._featureFilter.needGeometry,P=dt(w,A);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom),P,l))continue;const M=A?P.geometry:Et(w,l,u),O=rg(M,500);if(!nL(M,163))continue;const D=this.layers[0],V=D.layout.get("building-base").evaluate(w,{},l),G=D.layout.get("building-height").evaluate(w,{},l),q=D.layout.get("building-roof-shape").evaluate(w,{},l),te=D.paint.get("building-ambient-occlusion-intensity"),re=D.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if(q==="flat")continue;const oe=D.layout.get("building-facade").evaluate(w,{},l);f.setFacadeOptions(4,!0),f.setFauxFacadeOptions(oe,!1,1);const xe=w.properties.source_id;let ve;ve=y.has(xe)?y.get(xe):[];let Se=0,Ce=0,Ae=0,Qe=0,Oe=0,et=0;if(oe){let Mt=Math.round(D.layout.get("building-facade-floors").evaluate(w,{},l));if(V===0){Mt=Math.max(1,Mt-(ve.length>0?1:0));let Fr=4;if(G>100){const ue=[10,13,15];Fr=ue[w.id?w.id%ue.length:0],f.setFacadeOptions(Fr,!0)}Oe=1.6803*Fr/p}else Oe=V/p;et=G/p,Oe=Math.min(Oe,et),Ae=D.layout.get("building-facade-unit-width").evaluate(w,{},l)/p,Qe=(et-Oe)/Mt,f.setFauxFacadeOptions(!0,!0,Ae);const hr=D.layout.get("building-facade-window").evaluate(w,{},l);Se=hr[0],Ce=hr[1]}const ct=[],rt=new ft(1/0,1/0),st=new ft(-1/0,-1/0),ht=new ft(0,0);let Ke=0;for(const Mt of O)if(Mt.length>0){const hr=[];for(const Fr of Mt){const ue=[];for(let de=Fr.length-1;de>=0;de--){const Ve=Fr[de];ue.push({x:Ve.x,y:Ve.y}),rt.x=Math.min(rt.x,Ve.x),rt.y=Math.min(rt.y,Ve.y),st.x=Math.max(st.x,Ve.x),st.y=Math.max(st.y,Ve.y),ht.x+=Ve.x,ht.y+=Ve.y,Ke++}hr.push(ue)}ct.push({id:w.id?w.id:0,height:G,minHeight:V,sourceId:0,roofType:q,coordinates:hr})}ht.x/=Ke||1,ht.y/=Ke||1;const at=f.generateMesh(ct,ve);if(typeof at=="string"){Lr(`Unable to generate building ${w.id}: ${at}`);continue}if(at.meshes.length===0||at.modifiedPolygonRings.length===0)continue;let $e=0;for(const Mt of at.meshes)$e+=Mt.positions.length/3;const Be=oe?this.buildingWithFacade:this.buildingWithoutFacade,pt=Be.segmentsBucket.prepareSegment($e,Be.layoutVertexArray,Be.indexArray),ut=[];let $t=null,It=0,Lt=-1;const xt=Be.indexArray.length;let Bt=0;for(const Mt of at.meshes){const hr=Be.layoutVertexArray.length;if(Mt.buildingPart==="entrance"){const Je=new Array;for(let qt=0;qt<Mt.indices.length;qt+=12){const Cr=Mt.positions[qt+0],Ar=Mt.positions[qt+1],Tr=Mt.positions[qt+3],si=Mt.positions[qt+4],Mi=Mt.positions[qt+2],Sr=Mt.positions[qt+8]-Mi,_i=1,li=Tr-Cr,Zr=si-Ar,bi=Math.hypot(li,Zr);Je.push({pos:[Cr+.5*li,Ar+.5*Zr,Mi],normal:[Zr/bi,-li/bi,0],width:bi,height:Sr,depth:_i,points:[Cr,Ar,Tr,si]})}const wt=Be.entranceBloom.segmentsBucket.prepareSegment(10*Je.length,Be.entranceBloom.layoutVertexArray,Be.entranceBloom.indexArray),bt=Be.entranceBloom.layoutVertexArray.length;It=Be.entranceBloom.indexArray.length,ME(Je,.5/this.tileToMeter,Be.entranceBloom.indexArray,Be.entranceBloom.layoutVertexArray,Be.entranceBloom.layoutAttenuationArray);const kt=Be.entranceBloom.layoutVertexArray.length-bt;Lt=Be.entranceBloom.indexArray.length-It;for(let qt=0;qt<kt;qt++)Be.entranceBloom.layoutColorArray.emplaceBack(65535,65535);wt.vertexLength+=kt,wt.primitiveLength+=Lt,$t={part:Mt.buildingPart,vertexOffset:bt,vertexLength:kt}}for(let Je=0;Je<Mt.positions.length;Je+=3)Bt=Math.max(Bt,Mt.positions[Je+2]),Be.layoutVertexArray.emplaceBack(Mt.positions[Je],Mt.positions[Je+1],Mt.positions[Je+2]);const Fr=Math.floor(ht.x),ue=Math.floor(ht.y),de=Math.floor(Bt);for(let Je=0;Je<Mt.positions.length;Je+=3)Be.layoutCentroidArray.emplaceBack(Fr,ue,de);for(let Je=0;Je<Mt.normals.length;Je+=3)Be.layoutNormalArray.emplaceBack(Mt.normals[Je+0]*nw,Mt.normals[Je+1]*nw,Mt.normals[Je+2]*nw);for(let Je=0;Je<Mt.ao.length;Je++)Be.layoutAOArray.push(Mt.ao[Je]);for(let Je=0;Je<Mt.colors.length;Je+=3){const wt=1+(Mt.ao[Je/3]-1)*te;Be.layoutColorArray.emplaceBack(Mt.colors[Je]*wt<<8|Mt.colors[Je+1]*wt,Mt.colors[Je+2]*wt<<8)}if(oe){for(let Je=0;Je<Mt.positions.length;Je+=3)Be.layoutFacadePaintArray.emplaceBack(65535,255);for(let Je=0;Je<Mt.isFauxFacade.length;Je++)if(Mt.isFauxFacade[Je]){const wt=1|Math.min(65535,Math.floor(Mt.uv[2*Je]*at.outerRingLength)),bt=Math.floor(255*Se)<<8|Math.floor(255*Ce),kt=Math.floor(65535*Math.min(1,Ae/vt)),qt=Math.floor(65535*Math.min(1,Qe/vt));Be.layoutFacadeDataArray.emplaceBack(wt,bt,kt,qt);const Cr=Math.floor(65535*Math.min(1,Oe/vt)),Ar=Math.floor(65535*Math.min(1,et/vt));Be.layoutFacadeVerticalRangeArray.emplaceBack(Cr,Ar)}else Be.layoutFacadeDataArray.emplaceBack(0,0,0,0),Be.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}const Ve=pt.vertexLength;for(let Je=0;Je<Mt.indices.length;Je+=3)Be.indexArray.emplaceBack(Ve+Mt.indices[Je],Ve+Mt.indices[Je+1],Ve+Mt.indices[Je+2]);pt.vertexLength+=Mt.positions.length/3,pt.primitiveLength+=Mt.indices.length/3,(Mt.buildingPart==="roof"||Mt.buildingPart==="wall"||Mt.buildingPart==="facade_glazing"||Mt.buildingPart==="entrance")&&ut.push({part:Mt.buildingPart,vertexOffset:hr,vertexLength:Mt.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Bt),this.buildingFeatures.push({feature:P,hasFauxFacade:oe,segment:pt,parts:ut,buildingBloom:$t});const sr=Be.indexArray.length-xt,St=[],jt=[],Kt=new ft(1/0,1/0),ur=new ft(-1/0,-1/0),Ir=this.groundEffect.vertexArray.length;for(const Mt of at.modifiedPolygonRings){const hr=[],Fr=new ft(1/0,1/0),ue=new ft(-1/0,-1/0);for(let de=0;de<Mt.length;de+=2){const Ve=Mt.length-de-2;Fr.x=Math.min(Fr.x,Mt[Ve]),Fr.y=Math.min(Fr.y,Mt[Ve+1]),ue.x=Math.max(ue.x,Mt[Ve]),ue.y=Math.max(ue.y,Mt[Ve+1]);const Je=new ft(Mt[Ve],Mt[Ve+1]);hr.push(Je),St.push(Je.x,Je.y),jt.push(Je.clone())}Kt.x=Math.min(Kt.x,Fr.x),Kt.y=Math.min(Kt.y,Fr.y),ur.x=Math.max(ur.x,ue.x),ur.y=Math.max(ur.y,ue.y),this.groundEffect.addData(hr,[Fr,ue],re)}const mr=this.groundEffect.vertexArray.length-Ir;(rt.x<0||st.x>vt||rt.y<0||st.y>vt)&&this.featuresOnBorder.push({featureId:w.id,footprintIndex:this.footprints.length});{const Mt=Cf(St,null,2),hr=new ty(jt,Mt,8,256);let Fr=w.id;w.properties&&w.properties.hasOwnProperty("building_id")&&(Fr=w.properties.building_id),this.footprints.push({vertices:jt,indices:Mt,grid:hr,min:Kt,max:ur,buildingId:Fr,hiddenFlags:0,indicesOffset:xt,indicesLength:sr,bloomIndicesOffset:It,bloomIndicesLength:Lt,groundEffectVertexOffset:Ir,groundEffectVertexLength:mr,hasFauxFacade:oe,segment:pt,height:Bt})}this.programConfigurations.populatePaintArrays(Be.layoutVertexArray.length,w,E,{},i.availableImages,l,i.brightness),this.groundEffect.addPaintPropertiesData(w,E,{},i.availableImages,l,i.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(e,i,l,u,f,p,y){this.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y),this.groundEffect.update(e,i,f,l,u,p,y),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const i=l=>{l.layoutVertexBuffer=e.createVertexBuffer(l.layoutVertexArray,NE.members),l.layoutNormalBuffer=e.createVertexBuffer(l.layoutNormalArray,J3.members),l.layoutCentroidBuffer=e.createVertexBuffer(l.layoutCentroidArray,Q3.members),l.layoutFacadeDataArray&&l.layoutFacadeDataArray.length&&(l.layoutFacadeDataBuffer=e.createVertexBuffer(l.layoutFacadeDataArray,tL.members)),l.layoutFacadeVerticalRangeArray&&l.layoutFacadeVerticalRangeArray.length&&(l.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(l.layoutFacadeVerticalRangeArray,rL.members)),l.entranceBloom.layoutVertexArray.length&&(l.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(l.entranceBloom.layoutVertexArray,NE.members),l.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(l.entranceBloom.layoutAttenuationArray,iL.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=i=>{i.layoutVertexBuffer&&(i.layoutVertexBuffer.destroy(),i.layoutNormalBuffer.destroy(),i.layoutColorBuffer.destroy(),i.segmentsBucket.destroy(),i.indexBuffer&&i.indexBuffer.destroy(),i.entranceBloom.layoutVertexBuffer&&(i.entranceBloom.layoutVertexBuffer.destroy(),i.entranceBloom.layoutColorBuffer.destroy(),i.entranceBloom.layoutAttenuationBuffer.destroy(),i.entranceBloom.indexBuffer.destroy(),i.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,i,l=!0){let u=!1;const f=l?i:0,p=0|(l?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const y of e){const w=this.footprints[y],E=w.hiddenFlags&p|f;w.hiddenFlags!==E&&(w.hiddenFlags=E,u=!0,this.groundEffect.updateHiddenByLandmarkRange(w.groundEffectVertexOffset,w.groundEffectVertexLength,w.hiddenFlags!==0))}return u&&(this.indexArrayForConflationUploaded=!1),u}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const i=u=>{u.indexArray.length!==0&&(u.indexArrayForConflation.resize(u.indexArray.length),u.indexArrayForConflation.uint16.set(u.indexArray.uint16),u.entranceBloom.indexArrayForConflation.resize(u.entranceBloom.indexArray.length),u.entranceBloom.indexArrayForConflation.uint16.set(u.entranceBloom.indexArray.uint16))};i(this.buildingWithoutFacade),i(this.buildingWithFacade);for(const u of this.footprints){const f=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,p=u.indicesOffset+u.indicesLength;if(u.hiddenFlags!==0){for(let w=u.indicesOffset;w<p;w++)f.indexArrayForConflation.uint16[3*w+0]=0,f.indexArrayForConflation.uint16[3*w+1]=0,f.indexArrayForConflation.uint16[3*w+2]=0;const y=u.bloomIndicesOffset+u.bloomIndicesLength;for(let w=u.bloomIndicesOffset;w<y;w++)f.entranceBloom.indexArrayForConflation.uint16[3*w+0]=0,f.entranceBloom.indexArrayForConflation.uint16[3*w+1]=0,f.entranceBloom.indexArrayForConflation.uint16[3*w+2]=0}}const l=u=>{u.indexArray.length!==0&&(u.indexBuffer?u.indexBuffer.updateData(u.indexArrayForConflation):u.indexBuffer=e.createIndexBuffer(u.indexArrayForConflation,!0),u.entranceBloom.indexBuffer?u.entranceBloom.indexBuffer.updateData(u.entranceBloom.indexArrayForConflation):u.entranceBloom.indexBuffer=e.createIndexBuffer(u.entranceBloom.indexArrayForConflation,!0))};l(this.buildingWithoutFacade),l(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const i=l=>{l.layoutColorBuffer?l.layoutColorBuffer.updateData(l.layoutColorArray):l.layoutColorBuffer=e.createVertexBuffer(l.layoutColorArray,RE.members,!0),l.layoutFacadePaintArray&&(l.layoutFacadePaintBuffer?l.layoutFacadePaintBuffer.updateData(l.layoutFacadePaintArray):l.layoutFacadePaintBuffer=e.createVertexBuffer(l.layoutFacadePaintArray,eL.members,!0)),l.entranceBloom.layoutColorBuffer?l.entranceBloom.layoutColorBuffer.updateData(l.entranceBloom.layoutColorArray):l.entranceBloom.layoutColorBuffer=e.createVertexBuffer(l.entranceBloom.layoutColorArray,RE.members,!0)};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,i){const l=e.paint.get("building-ambient-occlusion-intensity");for(const u of this.buildingFeatures){const f=i[u.feature.id],p=u.feature;p.properties["building-part"]="roof";const y=e.paint.get("building-color").evaluate(p,f,this.canonical).toPremultipliedRenderColor(this.lut),w=e.paint.get("building-emissive-strength").evaluate(p,f,this.canonical);p.properties["building-part"]="wall";const E=e.paint.get("building-color").evaluate(p,f,this.canonical).toPremultipliedRenderColor(this.lut),A=e.paint.get("building-emissive-strength").evaluate(p,f,this.canonical);p.properties["building-part"]="window";const P=e.paint.get("building-color").evaluate(p,f,this.canonical).toPremultipliedRenderColor(this.lut),M=e.paint.get("building-emissive-strength").evaluate(p,f,this.canonical);p.properties["building-part"]="door";const O=e.paint.get("building-color").evaluate(p,f,this.canonical).toPremultipliedRenderColor(this.lut),D=e.paint.get("building-emissive-strength").evaluate(p,f,this.canonical),V=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const q of u.parts){let te,re=y;q.part==="roof"?(re=y,te=w):q.part==="wall"?(re=E,te=A):q.part==="facade_glazing"?(re=P,te=M):q.part==="entrance"&&(re=O,te=D),te=be(te,0,1);for(let oe=0;oe<q.vertexLength;oe++){const xe=q.vertexOffset+oe,ve=1+(V.layoutAOArray[xe]-1)*l;V.layoutColorArray.emplace(xe,re.r*ve*255<<8|re.g*ve*255,re.b*ve*255<<8|255*te),u.hasFauxFacade&&V.layoutFacadePaintArray.emplace(xe,255*P.r<<8|255*P.g,255*P.b<<8|255*M)}}const G=u.buildingBloom;if(G)for(let q=0;q<G.vertexLength;q++)V.entranceBloom.layoutColorArray.emplace(G.vertexOffset+q,255*O.r<<8|255*O.g,255*O.b<<8|51*D)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,i,l){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped());if(iy(this.activeReplacements,u))return;this.activeReplacements=u;for(const p of this.footprints)p.hiddenFlags&=-2;const f=[];for(const p of this.activeReplacements){if(p.order<=BT)continue;const y=Math.max(1,Math.pow(2,p.footprintTileId.canonical.z-e.canonical.z));for(const w of this.footprints)w.min.x>p.max.x||w.max.x<p.min.x||w.min.y>p.max.y||w.max.y<p.min.y||(f.length=0,sL(w.vertices,0,w.vertices.length,p.footprintTileId.canonical,e.canonical,f),Fb(p.footprint,f,w.indices,0,w.indices.length,0,-y)&&(w.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const p of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(p.groundEffectVertexOffset,p.groundEffectVertexLength,p.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,i){let l=Number.NEGATIVE_INFINITY,u=!0;const f=4*(e+vt)*vt+(i+vt);if(this.footprintLookup.hasOwnProperty(f)){const y=this.footprintLookup[f];return y?{height:y.height,hidden:y.hiddenFlags!==0}:void 0}const p=new ft(e,i);for(const y of this.footprints)e>y.max.x||y.min.x>e||i>y.max.y||y.min.y>i||y.height<=l||Bb(p,y)&&(l=y.height,this.footprintLookup[f]=y,u=y.hiddenFlags!==0);if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:u};this.footprintLookup[f]=void 0}}function sL(n,e,i,l,u,f){const p=Math.pow(2,l.z-u.z);for(let y=0;y<i;y++){let w=n[y+e].x,E=n[y+e].y;w=(w+u.x*vt)*p-l.x*vt,E=(E+u.y*vt)*p-l.y*vt,f.push(new ft(w,E))}}let jE,zE;Pt(DE,"BuildingBucket",{omit:["layers"]}),Pt(sw,"BuildingGeometry"),Pt(OE,"BuildingBloomGeometry");const oL=Dr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),aL=Dr([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:lL}=oL,cL=Dr([{name:"a_packed",components:3,type:"Float32"}]),{members:uL}=cL,dL=Dr([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:hL}=dL;class FE{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new au({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const l=this.getKey(e,i);return this.positions[l]}trim(){const e=this.width,i=this.height=Gt(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,l){const u=[];let f=e.length%2==1?-e[e.length-1]*l:0,p=e[0]*l,y=!0;u.push({left:f,right:p,isDash:y,zeroLength:e[0]===0});let w=e[0];for(let E=1;E<e.length;E++){y=!y;const A=e[E];f=w*l,w+=A,p=w*l,u.push({left:f,right:p,isDash:y,zeroLength:A===0})}return u}addRoundDash(e,i,l){const u=i/2;for(let f=-l;f<=l;f++){const p=this.width*(this.nextRow+l+f);let y=0,w=e[y];for(let E=0;E<this.width;E++){E/w.right>1&&(w=e[++y]);const A=Math.abs(E-w.left),P=Math.abs(E-w.right),M=Math.min(A,P);let O;const D=f/l*(u+1);if(w.isDash){const V=u-Math.abs(D);O=Math.sqrt(M*M+V*V)}else O=u-Math.sqrt(M*M+D*D);this.image.data[p+E]=Math.max(0,Math.min(255,O+128))}}}addRegularDash(e,i){for(let w=e.length-1;w>=0;--w){const E=e[w],A=e[w+1];E.zeroLength?e.splice(w,1):A&&A.isDash===E.isDash&&(A.left=E.left,e.splice(w,1))}const l=e[0],u=e[e.length-1];l.isDash===u.isDash&&(l.left=u.left-this.width,u.right=l.right+this.width);const f=this.width*this.nextRow;let p=0,y=e[p];for(let w=0;w<this.width;w++){w/y.right>1&&(y=e[++p]);const E=Math.abs(w-y.left),A=Math.abs(w-y.right),P=Math.min(E,A);this.image.data[f+w]=Math.max(0,Math.min(255,(y.isDash?P:-P)+i+128))}}addDash(e,i){const l=this.getKey(e,i);if(this.positions[l])return this.positions[l];const u=i==="round",f=u?7:0,p=2*f+1;if(this.nextRow+p>this.height)return Lr("LineAtlas out of space"),null;e.length===0&&e.push(1);let y=0;for(let A=0;A<e.length;A++)e[A]<0&&(Lr("Negative value is found in line dasharray, replacing values with 0"),e[A]=0),y+=e[A];if(y!==0){const A=this.width/y,P=this.getDashRanges(e,this.width,A);u?this.addRoundDash(P,A,f):this.addRegularDash(P,i==="square"?.5*A:0)}const w=this.nextRow+f;this.nextRow+=p;const E={tl:[w,f],br:[y,0]};return this.positions[l]=E,E}}Pt(FE,"LineAtlas");const fL=lt.types,pL=Math.cos(Math.PI/180*37.5),mL=Math.cos(Math.PI/180*5);class ow{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new mf,this.layoutVertexArray2=new As,this.patternVertexArray=new As,this.indexArray=new bn,this.programConfigurations=new zo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Fi,this.maxLineLength=0,this.zOffsetVertexArray=new As,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:vt/64,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,l,u){this.hasPattern=Rb("line",this.layers,this.pixelRatio,i);const f=this.layers[0].layout.get("line-sort-key");this.tileToMeter=De(l);const p=this.layers[0].layout.get("line-elevation-reference");if(p==="hd-road-markup")this.elevationType="road";else{const M=this.layers[0].layout.get("line-z-offset"),O=M.isConstant()&&!M.constantOr(0);this.elevationType=p!=="sea"&&p!=="ground"&&O?"none":"offset",this.elevationType==="offset"&&p==="none"&&Lr(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const y=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&y!==void 0;const w=[];for(const{feature:M,id:O,index:D,sourceLayerIndex:V}of e){const G=this.layers[0]._featureFilter.needGeometry,q=dt(M,G);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom,{worldview:this.worldview}),q,l))continue;const te=f?f.evaluate(q,{},l):void 0,re={id:O,properties:M.properties,type:M.type,sourceLayerIndex:V,index:D,geometry:G?q.geometry:Et(M,l,u),patterns:{},sortKey:te};w.push(re)}f&&w.sort((M,O)=>M.sortKey-O.sortKey);const{lineAtlas:E,featureIndex:A}=i,P=this.addConstantDashes(E);for(const M of w){const{geometry:O,index:D,sourceLayerIndex:V}=M;if(P&&this.addFeatureDashes(M,E),this.hasPattern){const G=Lb("line",this.layers,M,this.zoom,this.pixelRatio,i);this.patternFeatures.push(G)}else this.addFeature(M,O,D,l,E.positions,i.availableImages,i.brightness,i.elevationFeatures);A.insert(e[D].feature,O,D,V,this.index)}}addConstantDashes(e){let i=!1;for(const l of this.layers){const u=l.paint.get("line-dasharray").value,f=l.layout.get("line-cap").value;if(u.kind!=="constant"||f.kind!=="constant")i=!0;else{const p=f.value,y=u.value;if(!y)continue;e.addDash(y,p)}}return i}addFeatureDashes(e,i){const l=this.zoom;for(const u of this.layers){const f=u.paint.get("line-dasharray").value,p=u.layout.get("line-cap").value;if(f.kind==="constant"&&p.kind==="constant")continue;let y,w;if(f.kind==="constant"){if(y=f.value,!y)continue}else y=f.evaluate({zoom:l},e);w=p.kind==="constant"?p.value:p.evaluate({zoom:l},e),i.addDash(y,w),e.patterns[u.id]=[i.getKey(y,w)]}}update(e,i,l,u,f,p,y,w){this.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y,w)}addFeatures(e,i,l,u,f,p){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,i,l,u,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,uL)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,hL)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,aL.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,lL),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,i){let l,u;if(i&&i>0?(l=`mapbox_clip_start_${i}`,u=`mapbox_clip_end_${i}`):(l="mapbox_clip_start",u="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(l)&&e.properties.hasOwnProperty(u))return{start:+e.properties[l],end:+e.properties[u]}}addFeature(e,i,l,u,f,p,y,w){const E=this.layers[0].layout,A=E.get("line-join").evaluate(e,{}),P=E.get("line-cap").evaluate(e,{}),M=E.get("line-miter-limit"),O=E.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const D=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=E.get("line-z-offset").value;const V=this.layers[0].paint.get("line-width").value;if(V.kind!=="constant"&&V.isLineProgressConstant===!1&&(this.variableWidthValue=V),this.elevationType==="road"){const G=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,u,w,A,P,M,O)){const[q,te]=this.clipRuntimeLinesToTile(i,1);for(let re=0;re<q.length;re++){const oe=q[re],xe=te[re],ve={progress:{min:xe.progress.min,max:xe.progress.max},nextDir:this.computeSegNextDir(xe,oe),prevDir:this.computeSegPrevDir(xe,oe)};this.addLine(oe,e,u,A,P,M,O,ve,D&&xe.parentIndex>0?xe.parentIndex:null)}this.fillNonElevatedRoadSegment(G)}}else for(let G=0;G<i.length;G++)this.addLine(i[G],e,u,A,P,M,O,void 0,D&&G>0?G:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,f,p,u,y,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return oy(e,-i,-i,vt+i,vt+i)}clipRuntimeLinesToTile(e,i){const l=[];return[oy(e,-i,-i,vt+i,vt+i,l),l]}addElevatedRoadFeature(e,i,l,u,f,p,y,w){const E=[],A=Ri.getElevationFeature(e,u);if(A){const P=this.clipLinesToTile(i,1),M=this.prepareElevatedLines(P,A,l);for(const O of M)E.push({geometry:O,elevation:A,elevationTileID:l,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(E.length===0)return!1;for(const P of E){const M=this.layoutVertexArray.length;this.addLine(P.geometry,e,l,f,p,y,w);const O=new sn(l,P.elevationTileID);if(P.elevation)for(let D=M;D<this.layoutVertexArray.length;D++){const V=new ft(this.layoutVertexArray.int16[6*D]>>1,this.layoutVertexArray.int16[6*D+1]>>1),G=O.pointElevation(V,P.elevation,.05);this.updateHeightRange(G),this.zOffsetVertexArray.emplaceBack(G,0,0)}else this.fillNonElevatedRoadSegment(M)}return!0}prepareElevatedLines(e,i,l){if(i.constantHeight!=null)return e;const u=[],f=1/De(l);for(const p of e)A3(p,new ni(i,f),0,u);return u}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,l,u,f,p,y,w,E){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=E?this.lineFeatureClips(i,E):this.lineClips;const A=u==="none";this.patternJoinNone=this.hasPattern&&A,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const P=w&&w.progress.min>0,M=w&&w.progress.max<1;if(this.lineClips){let Ae={min:this.lineClips.start,max:this.lineClips.end},Qe=1;if(w){const ct=this.lineClips.end-this.lineClips.start;Ae=function(rt,st,ht){return{min:ba(rt.min,st,ht),max:ba(rt.max,st,ht)}}(w.progress,{min:0,max:1},Ae),ct>0&&(Qe=(Ae.max-Ae.min)/ct)}const Oe=+i.properties.mapbox_clip_feature_len,et=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(Oe)||Number.isNaN(et)){for(let rt=0;rt<e.length-1;rt++)this.totalDistance+=e[rt].dist(e[rt+1]);const ct=this.totalDistance/(Ae.max-Ae.min);this.totalFeatureLength=Number.isFinite(ct)?ct:0,this.lineClips.start=Ae.min,this.lineClips.end=Ae.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Oe,this.distance=et*Qe,this.lineClips.start=Ae.min,this.lineClips.end=Ae.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const O=fL[i.type]==="Polygon";let D=e.length;for(;D>=2&&e[D-1].equals(e[D-2]);)D--;let V=0;for(;V<D-1&&e[V].equals(e[V+1]);)V++;if(D<(O?3:2))return;u==="bevel"&&(p=1.05);const G=this.segments.prepareSegment(10*D,this.layoutVertexArray,this.indexArray);let q,te,re,oe,xe,ve,Se,Ce;w&&w.prevDir&&(ve=w.prevDir.perp()),w&&w.nextDir&&(Se=w.nextDir.perp()),this.e1=this.e2=-1,O&&(q=e[D-2],xe=e[V].sub(q)._unit()._perp());for(let Ae=V;Ae<D;Ae++){if(re=Ae===D-1?O?e[V+1]:void 0:e[Ae+1],re&&e[Ae].equals(re))continue;xe&&(oe=xe),q&&(te=q),q=e[Ae],Ce=this.evaluateLineProgressFeatures(te?te.dist(q):0),xe=re?re.sub(q)._unit()._perp():oe,oe=oe||xe;const Qe=te&&re;let Oe=Qe?u:O||A?"butt":f;const et=oe.x*xe.x+oe.y*xe.y;if(A){const Be=function(pt){if(pt.patternJoinNone){const ut=pt.segmentPoints.length/2,$t=pt.lineSoFar-pt.segmentStart;for(let It=0;It<ut;++It){const Lt=pt.segmentPoints[2*It+1],xt=Math.round(pt.segmentPoints[2*It])+.5+.25*Lt;pt.patternVertexArray.emplaceBack(xt,$t,pt.segmentStart),pt.patternVertexArray.emplaceBack(xt,$t,pt.segmentStart)}pt.segmentPoints.length=0}pt.e1=pt.e2=-1};if(Qe&&et<mL){this.updateDistance(te,q),this.addCurrentVertex(q,oe,1,1,G,Ce),Be(this),this.addCurrentVertex(q,xe,-1,-1,G,Ce);continue}if(te){if(!re){this.updateDistance(te,q),this.addCurrentVertex(q,oe,1,1,G,Ce),Be(this);continue}Oe="miter"}}let ct=oe.add(xe);ct.x===0&&ct.y===0||ct._unit();const rt=ct.x*xe.x+ct.y*xe.y,st=rt!==0?1/rt:1/0,ht=2*Math.sqrt(2-2*rt),Ke=rt<pL&&te&&re,at=oe.x*xe.y-oe.y*xe.x>0,$e=this.overscaling<=16?15*vt/(512*this.overscaling):0;if(Qe&&Oe==="round"){if(st<y)Oe="miter";else if(st<=2){const Be=aw(q,-10,vt+10);Oe=this.elevationType==="offset"&&(Be||this.hasCrossSlope)?"miter":"fakeround"}}if(Oe==="miter"&&st>p&&(Oe="bevel"),Oe==="bevel"&&(st>2&&(Oe="flipbevel"),st<p&&(Oe="miter")),te&&!(Oe==="miter"&&Ke)&&this.updateDistance(te,q),Oe==="miter")if(Ke){const Be=q.dist(te);if(Be>2*$e){const ut=q.sub(q.sub(te)._mult($e/Be)._round());this.updateDistance(te,ut),this.addCurrentVertex(ut,oe,0,0,G,Ce),te=ut}this.updateDistance(te,q),ct._mult(st),this.addCurrentVertex(q,ct,0,0,G,Ce);const pt=q.dist(re);if(pt>2*$e){const ut=q.add(re.sub(q)._mult($e/pt)._round());this.updateDistance(q,ut),this.addCurrentVertex(ut,xe,0,0,G,Ce),q=ut}}else ct._mult(st),this.addCurrentVertex(q,ct,0,0,G,Ce);else if(Oe==="flipbevel"){if(st>100)ct=xe.mult(-1);else{const Be=st*oe.add(xe).mag()/oe.sub(xe).mag();ct._perp()._mult(Be*(at?-1:1))}this.addCurrentVertex(q,ct,0,0,G,Ce),this.addCurrentVertex(q,ct.mult(-1),0,0,G,Ce)}else if(Oe==="bevel"||Oe==="fakeround"){Ce!=null&&te&&this.addCurrentVertex(q,Se||oe,-1,-1,G,Ce);const Be=q.dist(te)<=2*$e&&Oe!=="bevel",pt=ct.mult(at?1:-1);pt._mult(st);const ut=xe.mult(at?-1:1),$t=oe.mult(at?-1:1),It=this.evaluateLineProgressFeatures(this.distance);if(Ce==null&&(this.addHalfVertex(q,pt.x,pt.y,!1,!at,0,G,It),Be||this.addHalfVertex(q,pt.x+2*$t.x,pt.y+2*$t.y,!1,at,0,G,It)),Oe==="fakeround"){const Lt=Math.round(180*ht/Math.PI/20);this.addHalfVertex(q,$t.x,$t.y,!1,at,0,G,It);for(let xt=0;xt<Lt;xt++){let Bt=xt/Lt;if(Bt!==.5){const St=Bt-.5;Bt+=Bt*St*(Bt-1)*((1.0904+et*(et*(3.55645-1.43519*et)-3.2452))*St*St+(.848013+et*(.215638*et-1.06021)))}const sr=ut.sub($t)._mult(Bt)._add($t)._unit();this.addHalfVertex(q,sr.x,sr.y,!1,at,0,G,It)}this.addHalfVertex(q,ut.x,ut.y,!1,at,0,G,It)}Be||Ce!=null||this.addHalfVertex(q,pt.x+2*ut.x,pt.y+2*ut.y,!1,at,0,G,It),Ce!=null&&re&&this.addCurrentVertex(q,ve||xe,1,1,G,Ce)}else if(Oe==="butt")this.addCurrentVertex(q,ct,0,0,G,Ce);else if(Oe==="square"){if(!te){const Be=P?0:-1;this.addCurrentVertex(q,ct,Be,Be,G,Ce)}if(this.addCurrentVertex(q,ct,0,0,G,Ce),te){const Be=M?0:1;this.addCurrentVertex(q,ct,Be,Be,G,Ce)}}else if(Oe==="round"){if(te){const Be=!Qe&&Se?Se:oe;this.addCurrentVertex(q,Be,0,0,G,Ce),!Qe&&M||this.addCurrentVertex(q,Be,1,1,G,Ce,!0)}if(re){const Be=!Qe&&ve?ve:xe;!Qe&&P||this.addCurrentVertex(q,Be,-1,-1,G,Ce,!0),this.addCurrentVertex(q,Be,0,0,G,Ce)}}}}addVerticesTo(e,i,l,u,f,p,y,w,E,A){const P=(i.w-e.w)/this.tessellationStep|0;let M=0;const O=this.scaledDistance;if(P>1){this.lineSoFar=e.w;const V=(i.x-e.x)/P,G=(i.y-e.y)/P,q=(i.z-e.z)/P,te=(i.w-e.w)/P;for(let re=1;re<P;++re){e.x+=V,e.y+=G,e.z+=q,this.lineSoFar+=te,M+=te;const oe=this.evaluateLineProgressFeatures(this.prevDistance+M);this.scaledDistance=(this.prevDistance+M)/this.totalDistance,this.addHalfVertex(e,l,u,A,!1,y,E,oe),this.addHalfVertex(e,f,p,A,!0,-w,E,oe)}}this.lineSoFar=i.w,this.scaledDistance=O;const D=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,l,u,A,!1,y,E,D),this.addHalfVertex(i,f,p,A,!0,-w,E,D)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Lr(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,l,u,f,p,y=!1){const w=i.x+i.y*l,E=i.y-i.x*l,A=i.y*u-i.x,P=-i.y-i.x*u;if(p!=null){const M=this.elevationType==="offset",O=-10,D=vt+10,V=p.zOffset,G=new aE(e.x,e.y,V,this.lineSoFar),q=!!M&&aw(e,O,D),te=this.lineSoFar,re=this.distance;if(this.currentVertex)if(q){const oe=this.currentVertexIsOutside,xe=this.currentVertex,ve=new aE(e.x,e.y,V,this.lineSoFar);if(cE(xe,ve,O,D),!aw(ve,O,D)){if(oe){this.e1=this.e2=-1,this.distance-=xe.dist(G),this.lineSoFar=xe.w;const Se=this.evaluateLineProgressFeatures(xe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(xe,w,E,y,!1,l,f,Se),this.addHalfVertex(xe,A,P,y,!0,-u,f,Se),this.prevDistance=this.distance}this.distance=this.prevDistance+xe.dist(ve),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(xe,ve,w,E,A,P,l,u,f,y),this.distance=re,this.scaledDistance=this.distance/this.totalDistance}}else{const oe=this.currentVertex;if(this.currentVertexIsOutside){cE(oe,G,O,D),this.e1=this.e2=-1,this.distance-=oe.dist(G),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=oe.w;const xe=this.evaluateLineProgressFeatures(oe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(oe,w,E,y,!1,l,f,xe),this.addHalfVertex(oe,A,P,y,!0,-u,f,xe),this.prevDistance=this.distance,this.distance=re,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(oe,G,w,E,A,P,l,u,f,y)}else q||(this.addHalfVertex(e,w,E,y,!1,l,f,p),this.addHalfVertex(e,A,P,y,!0,-u,f,p));this.currentVertex=G,this.currentVertexIsOutside=q,this.lineSoFar=te}else this.addHalfVertex(e,w,E,y,!1,l,f,p),this.addHalfVertex(e,A,P,y,!0,-u,f,p)}addHalfVertex({x:e,y:i},l,u,f,p,y,w,E){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),p||this.segmentPoints.push(this.lineSoFar-this.segmentStart,y)),this.layoutVertexArray.emplaceBack((e<<1)+(f?1:0),(i<<1)+(p?1:0),Math.round(63*l)+128,Math.round(63*u)+128,1+(y===0?0:y<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const P=Yt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,P)}const A=w.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,A),w.primitiveLength++),p?this.e2=A:this.e1=A,E!=null&&this.zOffsetVertexArray.emplaceBack(E.zOffset,E.variableWidth,E.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function aw(n,e,i){return n.x<e||n.x>i||n.y<e||n.y>i}let BE,UE;function VE(n,e,i){return e*(vt/(n.tileSize*Math.pow(2,i-n.tileID.overscaledZ)))}Pt(ow,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const $E=(n,e,i)=>(1-i)*n+i*e;function GE(n,e){return 1/VE(n,1,e.tileZoom)}function qE(n,e,i,l){return n.translatePosMatrix(l||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const HE=n=>{const e=[];WE(n)&&e.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=n.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const l=n.layout.get("line-join").constantOr("miter")==="none",u=!!n.paint.get("line-pattern").constantOr(1);return l&&u&&e.push("LINE_JOIN_NONE"),e};function WE(n){const e=n.paint.get("line-dasharray").value;return e.kind!=="constant"||e.value}let lw;const ZE=()=>lw||(lw={layout:BE||(BE=new $i({"line-cap":new Tt(Le.layout_line["line-cap"]),"line-join":new Tt(Le.layout_line["line-join"]),"line-miter-limit":new mt(Le.layout_line["line-miter-limit"]),"line-round-limit":new mt(Le.layout_line["line-round-limit"]),"line-sort-key":new Tt(Le.layout_line["line-sort-key"]),"line-z-offset":new Tt(Le.layout_line["line-z-offset"]),"line-elevation-reference":new mt(Le.layout_line["line-elevation-reference"]),"line-cross-slope":new mt(Le.layout_line["line-cross-slope"]),visibility:new mt(Le.layout_line.visibility),"line-width-unit":new mt(Le.layout_line["line-width-unit"])})),paint:UE||(UE=new $i({"line-opacity":new Tt(Le.paint_line["line-opacity"]),"line-color":new Tt(Le.paint_line["line-color"]),"line-translate":new mt(Le.paint_line["line-translate"]),"line-translate-anchor":new mt(Le.paint_line["line-translate-anchor"]),"line-width":new Tt(Le.paint_line["line-width"]),"line-gap-width":new Tt(Le.paint_line["line-gap-width"]),"line-offset":new Tt(Le.paint_line["line-offset"]),"line-blur":new Tt(Le.paint_line["line-blur"]),"line-dasharray":new Tt(Le.paint_line["line-dasharray"]),"line-pattern":new Tt(Le.paint_line["line-pattern"]),"line-pattern-cross-fade":new mt(Le.paint_line["line-pattern-cross-fade"]),"line-gradient":new Xc(Le.paint_line["line-gradient"]),"line-trim-offset":new mt(Le.paint_line["line-trim-offset"]),"line-trim-fade-range":new mt(Le.paint_line["line-trim-fade-range"]),"line-trim-color":new mt(Le.paint_line["line-trim-color"]),"line-emissive-strength":new mt(Le.paint_line["line-emissive-strength"]),"line-border-width":new Tt(Le.paint_line["line-border-width"]),"line-border-color":new Tt(Le.paint_line["line-border-color"]),"line-occlusion-opacity":new mt(Le.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},lw);class gL extends Tt{possiblyEvaluate(e,i){return i=new gi(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,l,u){return i=Object.assign({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,l,u)}}let pg;function XE(n,e){return e>0?e+2*n:n}const _L=Dr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),yL=Dr([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),xL=Dr([{name:"a_projected_pos",components:4,type:"Float32"}],4);Dr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const vL=Dr([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),bL=Dr([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),wL=Dr([{name:"a_texb",components:2,type:"Uint16"}]),SL=Dr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),TL=Dr([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Dr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const YE=Dr([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),EL=Dr([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Dr([{name:"triangle",components:3,type:"Uint16"}]),Dr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Dr([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Dr([{type:"Float32",name:"offsetX"}]),Dr([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Fn=24;function IL(n,e,i){return n.sections.forEach(l=>{l.text=function(u,f,p){const y=f.layout.get("text-transform").evaluate(p,{});return y==="uppercase"?u=u.toLocaleUpperCase():y==="lowercase"&&(u=u.toLocaleLowerCase()),ia.applyArabicShaping&&(u=ia.applyArabicShaping(u)),u}(l.text,e,i)}),n}const mg={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function CL(n){return n==="︶"||n==="﹈"||n==="︸"||n==="﹄"||n==="﹂"||n==="︾"||n==="︼"||n==="︺"||n==="︘"||n==="﹀"||n==="︐"||n==="︓"||n==="︔"||n==="｀"||n==="￣"||n==="︑"||n==="︒"}function AL(n){return n==="︵"||n==="﹇"||n==="︷"||n==="﹃"||n==="﹁"||n==="︽"||n==="︻"||n==="︹"||n==="︗"||n==="︿"}const cw=4294967296,KE=1/cw,JE=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let py=class{constructor(n=new Uint8Array(16)){this.buf=ArrayBuffer.isView(n)?n:new Uint8Array(n),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(n,e,i=this.length){for(;this.pos<i;){const l=this.readVarint(),u=l>>3,f=this.pos;this.type=7&l,n(u,e,this),this.pos===f&&this.skip(l)}return e}readMessage(n,e){return this.readFields(n,e,this.readVarint()+this.pos)}readFixed32(){const n=this.dataView.getUint32(this.pos,!0);return this.pos+=4,n}readSFixed32(){const n=this.dataView.getInt32(this.pos,!0);return this.pos+=4,n}readFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*cw;return this.pos+=8,n}readSFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*cw;return this.pos+=8,n}readFloat(){const n=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,n}readDouble(){const n=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,n}readVarint(n){const e=this.buf;let i,l;return l=e[this.pos++],i=127&l,l<128?i:(l=e[this.pos++],i|=(127&l)<<7,l<128?i:(l=e[this.pos++],i|=(127&l)<<14,l<128?i:(l=e[this.pos++],i|=(127&l)<<21,l<128?i:(l=e[this.pos],i|=(15&l)<<28,function(u,f,p){const y=p.buf;let w,E;if(E=y[p.pos++],w=(112&E)>>4,E<128||(E=y[p.pos++],w|=(127&E)<<3,E<128)||(E=y[p.pos++],w|=(127&E)<<10,E<128)||(E=y[p.pos++],w|=(127&E)<<17,E<128)||(E=y[p.pos++],w|=(127&E)<<24,E<128)||(E=y[p.pos++],w|=(1&E)<<31,E<128))return Lf(u,w,f);throw new Error("Expected varint not more than 10 bytes")}(i,n,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const n=this.readVarint();return n%2==1?(n+1)/-2:n/2}readBoolean(){return!!this.readVarint()}readString(){const n=this.readVarint()+this.pos,e=this.pos;return this.pos=n,n-e>=12&&JE?JE.decode(this.buf.subarray(e,n)):function(i,l,u){let f="",p=l;for(;p<u;){const y=i[p];let w,E,A,P=null,M=y>239?4:y>223?3:y>191?2:1;if(p+M>u)break;M===1?y<128&&(P=y):M===2?(w=i[p+1],(192&w)==128&&(P=(31&y)<<6|63&w,P<=127&&(P=null))):M===3?(w=i[p+1],E=i[p+2],(192&w)==128&&(192&E)==128&&(P=(15&y)<<12|(63&w)<<6|63&E,(P<=2047||P>=55296&&P<=57343)&&(P=null))):M===4&&(w=i[p+1],E=i[p+2],A=i[p+3],(192&w)==128&&(192&E)==128&&(192&A)==128&&(P=(15&y)<<18|(63&w)<<12|(63&E)<<6|63&A,(P<=65535||P>=1114112)&&(P=null))),P===null?(P=65533,M=1):P>65535&&(P-=65536,f+=String.fromCharCode(P>>>10&1023|55296),P=56320|1023&P),f+=String.fromCharCode(P),p+=M}return f}(this.buf,e,n)}readBytes(){const n=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,n);return this.pos=n,e}readPackedVarint(n=[],e){const i=this.readPackedEnd();for(;this.pos<i;)n.push(this.readVarint(e));return n}readPackedSVarint(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSVarint());return n}readPackedBoolean(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readBoolean());return n}readPackedFloat(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFloat());return n}readPackedDouble(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readDouble());return n}readPackedFixed32(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFixed32());return n}readPackedSFixed32(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSFixed32());return n}readPackedFixed64(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFixed64());return n}readPackedSFixed64(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSFixed64());return n}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(n){const e=7&n;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(n,e){this.writeVarint(n<<3|e)}realloc(n){let e=this.length||16;for(;e<this.pos+n;)e*=2;if(e!==this.length){const i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeSFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*KE),!0),this.pos+=8}writeSFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*KE),!0),this.pos+=8}writeVarint(n){(n=+n||0)>268435455||n<0?function(e,i){let l,u;if(e>=0?(l=e%4294967296|0,u=e/4294967296|0):(l=~(-e%4294967296),u=~(-e/4294967296),4294967295^l?l=l+1|0:(l=0,u=u+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),function(f,p,y){y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,y.buf[y.pos]=127&(f>>>=7)}(l,0,i),function(f,p){const y=(7&f)<<4;p.buf[p.pos++]|=y|((f>>>=3)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f|((f>>>=7)?128:0),f&&(p.buf[p.pos++]=127&f)))))}(u,i)}(n,this):(this.realloc(4),this.buf[this.pos++]=127&n|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=n>>>7&127))))}writeSVarint(n){this.writeVarint(n<0?2*-n-1:2*n)}writeBoolean(n){this.writeVarint(+n)}writeString(n){n=String(n),this.realloc(4*n.length),this.pos++;const e=this.pos;this.pos=function(l,u,f){for(let p,y,w=0;w<u.length;w++){if(p=u.charCodeAt(w),p>55295&&p<57344){if(!y){p>56319||w+1===u.length?(l[f++]=239,l[f++]=191,l[f++]=189):y=p;continue}if(p<56320){l[f++]=239,l[f++]=191,l[f++]=189,y=p;continue}p=y-55296<<10|p-56320|65536,y=null}else y&&(l[f++]=239,l[f++]=191,l[f++]=189,y=null);p<128?l[f++]=p:(p<2048?l[f++]=p>>6|192:(p<65536?l[f++]=p>>12|224:(l[f++]=p>>18|240,l[f++]=p>>12&63|128),l[f++]=p>>6&63|128),l[f++]=63&p|128)}return f}(this.buf,n,this.pos);const i=this.pos-e;i>=128&&QE(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(n){this.realloc(4),this.dataView.setFloat32(this.pos,n,!0),this.pos+=4}writeDouble(n){this.realloc(8),this.dataView.setFloat64(this.pos,n,!0),this.pos+=8}writeBytes(n){const e=n.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=n[i]}writeRawMessage(n,e){this.pos++;const i=this.pos;n(e,this);const l=this.pos-i;l>=128&&QE(i,l,this),this.pos=i-1,this.writeVarint(l),this.pos+=l}writeMessage(n,e,i){this.writeTag(n,2),this.writeRawMessage(e,i)}writePackedVarint(n,e){e.length&&this.writeMessage(n,PL,e)}writePackedSVarint(n,e){e.length&&this.writeMessage(n,kL,e)}writePackedBoolean(n,e){e.length&&this.writeMessage(n,RL,e)}writePackedFloat(n,e){e.length&&this.writeMessage(n,ML,e)}writePackedDouble(n,e){e.length&&this.writeMessage(n,NL,e)}writePackedFixed32(n,e){e.length&&this.writeMessage(n,LL,e)}writePackedSFixed32(n,e){e.length&&this.writeMessage(n,OL,e)}writePackedFixed64(n,e){e.length&&this.writeMessage(n,DL,e)}writePackedSFixed64(n,e){e.length&&this.writeMessage(n,jL,e)}writeBytesField(n,e){this.writeTag(n,2),this.writeBytes(e)}writeFixed32Field(n,e){this.writeTag(n,5),this.writeFixed32(e)}writeSFixed32Field(n,e){this.writeTag(n,5),this.writeSFixed32(e)}writeFixed64Field(n,e){this.writeTag(n,1),this.writeFixed64(e)}writeSFixed64Field(n,e){this.writeTag(n,1),this.writeSFixed64(e)}writeVarintField(n,e){this.writeTag(n,0),this.writeVarint(e)}writeSVarintField(n,e){this.writeTag(n,0),this.writeSVarint(e)}writeStringField(n,e){this.writeTag(n,2),this.writeString(e)}writeFloatField(n,e){this.writeTag(n,5),this.writeFloat(e)}writeDoubleField(n,e){this.writeTag(n,1),this.writeDouble(e)}writeBooleanField(n,e){this.writeVarintField(n,+e)}};function Lf(n,e,i){return i?4294967296*e+(n>>>0):4294967296*(e>>>0)+(n>>>0)}function QE(n,e,i){const l=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(l);for(let u=i.pos-1;u>=n;u--)i.buf[u+l]=i.buf[u]}function PL(n,e){for(let i=0;i<n.length;i++)e.writeVarint(n[i])}function kL(n,e){for(let i=0;i<n.length;i++)e.writeSVarint(n[i])}function ML(n,e){for(let i=0;i<n.length;i++)e.writeFloat(n[i])}function NL(n,e){for(let i=0;i<n.length;i++)e.writeDouble(n[i])}function RL(n,e){for(let i=0;i<n.length;i++)e.writeBoolean(n[i])}function LL(n,e){for(let i=0;i<n.length;i++)e.writeFixed32(n[i])}function OL(n,e){for(let i=0;i<n.length;i++)e.writeSFixed32(n[i])}function DL(n,e){for(let i=0;i<n.length;i++)e.writeFixed64(n[i])}function jL(n,e){for(let i=0;i<n.length;i++)e.writeSFixed64(n[i])}const uw=3;function zL(n,e,i){e.glyphs=[],n===1&&i.readMessage(FL,e)}function FL(n,e,i){if(n===3){const{id:l,bitmap:u,width:f,height:p,left:y,top:w,advance:E}=i.readMessage(BL,{});e.glyphs.push({id:l,bitmap:new au({width:f+2*uw,height:p+2*uw},u),metrics:{width:f,height:p,left:y,top:w,advance:E}})}else n===4?e.ascender=i.readSVarint():n===5&&(e.descender=i.readSVarint())}function BL(n,e,i){n===1?e.id=i.readVarint():n===2?e.bitmap=i.readBytes():n===3?e.width=i.readVarint():n===4?e.height=i.readVarint():n===5?e.left=i.readSVarint():n===6?e.top=i.readSVarint():n===7&&(e.advance=i.readVarint())}const eI=uw,io={horizontal:1,vertical:2,horizontalOnly:3};class gg{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const l=new gg;return l.scale=e||1,l.fontStack=i,l}static forImage(e){const i=new gg;return i.image=e,i}}class Of{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,l){const u=new Of;for(let f=0;f<e.sections.length;f++){const p=e.sections[f];p.image?u.addImageSection(p,l):u.addTextSection(p,i)}return u}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,l){let u="";for(let f=0;f<i.length;f++){const p=i.charCodeAt(f+1)||null,y=i.charCodeAt(f-1)||null;u+=!l&&(p&&lf(p)&&!mg[i[f+1]]||y&&lf(y)&&!mg[i[f-1]])||!mg[i[f]]?i[f]:mg[i[f]]}return u}(this.text,e)}trim(){let e=0;for(let l=0;l<this.text.length&&my[this.text.charCodeAt(l)];l++)e++;let i=this.text.length;for(let l=this.text.length-1;l>=0&&l>=e&&my[this.text.charCodeAt(l)];l--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const l=new Of;return l.text=this.text.substring(e,i),l.sectionIndex=this.sectionIndex.slice(e,i),l.sections=this.sections,l}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(gg.forText(e.scale,e.fontStack||i));const l=this.sections.length-1;for(let u=0;u<e.text.length;++u)this.sectionIndex.push(l)}addImageSection(e,i){const l=e.image?e.image.getPrimary():null;if(!l)return void Lr("Can't add FormattedSection with an empty image.");l.scaleSelf(i);const u=this.getNextImageSectionCharCode();u?(this.text+=String.fromCodePoint(u),this.sections.push(gg.forImage(l)),this.sectionIndex.push(this.sections.length-1)):Lr("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function dw(n,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V=1){const G=Of.fromFeature(n,u,V);P===io.vertical&&G.verticalizePunctuation(M);let q=[];const te=function(Se,Ce,Ae,Qe,Oe,et){if(!Se)return[];const ct=[],rt=function(at,$e,Be,pt,ut,$t){let It=0;for(let Lt=0;Lt<at.length();Lt++){const xt=at.getSection(Lt);It+=tI(at.getCodePoint(Lt),xt,pt,ut,$e,$t)}return It/Math.max(1,Math.ceil(It/Be))}(Se,Ce,Ae,Qe,Oe,et),st=Se.text.indexOf("​")>=0;let ht=0;for(let at=0;at<Se.length();at++){const $e=Se.getSection(at),Be=Se.getCodePoint(at);if(my[Be]||(ht+=tI(Be,$e,Qe,Oe,Ce,et)),at<Se.length()-1){const pt=!((Ke=Be)<11904||!(Xt["Bopomofo Extended"](Ke)||Xt.Bopomofo(Ke)||Xt["CJK Compatibility Forms"](Ke)||Xt["CJK Compatibility Ideographs"](Ke)||Xt["CJK Compatibility"](Ke)||Xt["CJK Radicals Supplement"](Ke)||Xt["CJK Strokes"](Ke)||Xt["CJK Symbols and Punctuation"](Ke)||Xt["CJK Unified Ideographs Extension A"](Ke)||Xt["CJK Unified Ideographs"](Ke)||Xt["Enclosed CJK Letters and Months"](Ke)||Xt["Halfwidth and Fullwidth Forms"](Ke)||Xt.Hiragana(Ke)||Xt["Ideographic Description Characters"](Ke)||Xt["Kangxi Radicals"](Ke)||Xt["Katakana Phonetic Extensions"](Ke)||Xt.Katakana(Ke)||Xt["Vertical Forms"](Ke)||Xt["Yi Radicals"](Ke)||Xt["Yi Syllables"](Ke)));(UL[Be]||pt||$e.image)&&ct.push(iI(at+1,ht,rt,ct,VL(Be,Se.getCodePoint(at+1),pt&&st),!1))}}var Ke;return nI(iI(Se.length(),ht,rt,ct,0,!0))}(G,E,f,e,l,O),{processBidirectionalText:re,processStyledBidirectionalText:oe}=ia;if(re&&G.sections.length===1){const Se=re(G.toString(),te);for(const Ce of Se){const Ae=new Of;Ae.text=Ce,Ae.sections=G.sections;for(let Qe=0;Qe<Ce.length;Qe++)Ae.sectionIndex.push(0);q.push(Ae)}}else if(oe){const Se=oe(G.text,G.sectionIndex,te);for(const Ce of Se){const Ae=new Of;Ae.text=Ce[0],Ae.sectionIndex=Ce[1],Ae.sections=G.sections,q.push(Ae)}}else q=function(Se,Ce){const Ae=[],Qe=Se.text;let Oe=0;for(const et of Ce)Ae.push(Se.substring(Oe,et)),Oe=et;return Oe<Qe.length&&Ae.push(Se.substring(Oe,Qe.length)),Ae}(G,te);const xe=[],ve={positionedLines:xe,text:G.toString(),top:A[1],bottom:A[1],left:A[0],right:A[0],writingMode:P,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(Se,Ce,Ae,Qe,Oe,et,ct,rt,st,ht,Ke,at){let $e=0,Be=0,pt=0;const ut=rt==="right"?1:rt==="left"?0:.5;let $t=!1;for(const St of Oe){const jt=St.getSections();for(const Kt of jt){if(Kt.image)continue;const ur=Ce[Kt.fontStack];if(ur&&($t=ur.ascender!==void 0&&ur.descender!==void 0,!$t))break}if(!$t)break}let It=0;for(const St of Oe){St.trim();const jt=St.getMaxScale(),Kt=(jt-1)*Fn,ur={positionedGlyphs:[],lineOffset:0};Se.positionedLines[It]=ur;const Ir=ur.positionedGlyphs;let mr=0;if(!St.length()){Be+=et,++It;continue}let Mt=0,hr=0;for(let ue=0;ue<St.length();ue++){const de=St.getSection(ue),Ve=St.getSectionIndex(ue),Je=St.getCodePoint(ue);let wt=de.scale,bt=null,kt=null,qt=null,Cr=Fn,Ar=0,Tr=st;Tr===io.vertical&&((Lt=Je)===12312||Lt===12313||Lt===12316||Lt===12540||Lt===12448)&&(Tr=io.horizontal);const si=!(Tr===io.horizontal||!Ke&&!af(Je)||Ke&&(my[Je]||hb(Je)));if(de.image){const Mi=Qe.get(de.image.toString());if(!Mi)continue;qt=de.image,Se.iconsInText=Se.iconsInText||!0,kt=Mi.paddedRect;const Sr=Mi.displaySize;wt=wt*Fn/at,bt={width:Sr[0],height:Sr[1],left:0,top:-eI,advance:si?Sr[1]:Sr[0],localGlyph:!1},Ar=$t?-bt.height*wt:jt*Fn-17-Sr[1]*wt,Cr=bt.advance;const _i=(si?Sr[0]:Sr[1])*wt-Fn*jt;_i>0&&_i>mr&&(mr=_i)}else{const Mi=Ae[de.fontStack];if(!Mi)continue;Mi[Je]&&(kt=Mi[Je]);const Sr=Ce[de.fontStack];if(!Sr)continue;const _i=Sr.glyphs[Je];if(!_i)continue;if(bt=_i.metrics,Cr=Je!==8203?Fn:0,$t){const li=Sr.ascender!==void 0?Math.abs(Sr.ascender):0,Zr=Sr.descender!==void 0?Math.abs(Sr.descender):0,bi=(li+Zr)*wt;Mt<bi&&(Mt=bi,hr=(li-Zr)/2*wt),Ar=-li*wt}else Ar=(jt-wt)*Fn-17}si?(Se.verticalizable=!0,Ir.push({glyph:Je,image:qt,x:$e,y:Be+Ar,vertical:si,scale:wt,localGlyph:bt.localGlyph,fontStack:de.fontStack,sectionIndex:Ve,metrics:bt,rect:kt}),$e+=Cr*wt+ht):(Ir.push({glyph:Je,image:qt,x:$e,y:Be+Ar,vertical:si,scale:wt,localGlyph:bt.localGlyph,fontStack:de.fontStack,sectionIndex:Ve,metrics:bt,rect:kt}),$e+=bt.advance*wt+ht)}Ir.length!==0&&(pt=Math.max($e-ht,pt),$t?sI(Ir,ut,mr,hr,et*jt/2):sI(Ir,ut,mr,0,et/2)),$e=0;const Fr=et*jt+mr;ur.lineOffset=Math.max(mr,Kt),Be+=Fr,++It}var Lt;const xt=Be,{horizontalAlign:Bt,verticalAlign:sr}=hw(ct);(function(St,jt,Kt,ur,Ir,mr){const Mt=(jt-Kt)*Ir,hr=-mr*ur;for(const Fr of St)for(const ue of Fr.positionedGlyphs)ue.x+=Mt,ue.y+=hr})(Se.positionedLines,ut,Bt,sr,pt,xt),Se.top+=-sr*xt,Se.bottom=Se.top+xt,Se.left+=-Bt*pt,Se.right=Se.left+pt,Se.hasBaseline=$t}(ve,e,i,l,q,p,y,w,P,E,M,D),!function(Se){for(const Ce of Se)if(Ce.positionedGlyphs.length!==0)return!1;return!0}(xe))return ve}const my={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},UL={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function tI(n,e,i,l,u,f){if(e.image){const p=l.get(e.image.toString());return p?p.displaySize[0]*e.scale*Fn/f+u:0}{const p=i[e.fontStack],y=p&&p.glyphs[n];return y?y.metrics.advance*e.scale+u:0}}function rI(n,e,i,l){const u=Math.pow(n-e,2);return l?n<e?u/2:2*u:u+Math.abs(i)*i}function VL(n,e,i){let l=0;return n===10&&(l-=1e4),i&&(l+=150),n!==40&&n!==65288||(l+=50),e!==41&&e!==65289||(l+=50),l}function iI(n,e,i,l,u,f){let p=null,y=rI(e,i,u,f);for(const w of l){const E=rI(e-w.x,i,u,f)+w.badness;E<=y&&(p=w,y=E)}return{index:n,x:e,priorBreak:p,badness:y}}function nI(n){return n?nI(n.priorBreak).concat(n.index):[]}function hw(n){let e=.5,i=.5;switch(n){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function sI(n,e,i,l,u){if(!(e||i||l||u))return;const f=n.length-1,p=n[f],y=(p.x+p.metrics.advance*p.scale)*e;for(let w=0;w<=f;w++)n[w].x-=y,n[w].y+=i+l+u}function oI(n){return n.imagePrimary!==void 0&&n.top!==void 0&&n.bottom!==void 0&&n.left!==void 0&&n.right!==void 0}function $L(n,e,i,l){const{horizontalAlign:u,verticalAlign:f}=hw(l),p=i[0]-n.displaySize[0]*u,y=i[1]-n.displaySize[1]*f;return{imagePrimary:n,imageSecondary:e,top:y,bottom:y+n.displaySize[1],left:p,right:p+n.displaySize[0]}}function aI(n,e,i,l,u,f){const p=n.imagePrimary;let y;if(p.content){const G=p.content,q=p.pixelRatio||1;y=[G[0]/q,G[1]/q,p.displaySize[0]-G[2]/q,p.displaySize[1]-G[3]/q]}const w=e.left*f,E=e.right*f;let A,P,M,O;i==="width"||i==="both"?(O=u[0]+w-l[3],P=u[0]+E+l[1]):(O=u[0]+(w+E-p.displaySize[0])/2,P=O+p.displaySize[0]);const D=e.top*f,V=e.bottom*f;return i==="height"||i==="both"?(A=u[1]+D-l[0],M=u[1]+V+l[2]):(A=u[1]+(D+V-p.displaySize[1])/2,M=A+p.displaySize[1]),{imagePrimary:p,imageSecondary:void 0,top:A,right:P,bottom:M,left:O,collisionPadding:y}}function lI(n){return!n.imagePrimary.stretchX}function cI(n){return!n.imagePrimary.stretchY}function uI(n){return{width:n.right-n.left,height:n.bottom-n.top}}const vl=128;function dI(n,e,i){const{expression:l}=e;if(l.kind==="constant")return{kind:"constant",layoutSize:l.evaluate(new gi(n+1,{worldview:i}))};if(l.kind==="source")return{kind:"source"};{const{zoomStops:u,interpolationType:f}=l;let p=0;for(;p<u.length&&u[p]<=n;)p++;p=Math.max(0,p-1);let y=p;for(;y<u.length&&u[y]<n+1;)y++;y=Math.min(u.length-1,y);const w=u[p],E=u[y];return l.kind==="composite"?{kind:"composite",minZoom:w,maxZoom:E,interpolationType:f}:{kind:"camera",minZoom:w,maxZoom:E,minSize:l.evaluate(new gi(w,{worldview:i})),maxSize:l.evaluate(new gi(E,{worldview:i})),interpolationType:f}}}function fw(n,{uSize:e,uSizeT:i},{lowerSize:l,upperSize:u}){return n.kind==="source"?l/vl:n.kind==="composite"?Yt(l/vl,u/vl,i):e}function _g(n,e,i=1){let l=0,u=0;if(n.kind==="constant")u=n.layoutSize*i;else if(n.kind!=="source"){const{interpolationType:f,minZoom:p,maxZoom:y}=n,w=f?be(Js.interpolationFactor(f,e,p,y),0,1):0;n.kind==="camera"?u=Yt(n.minSize,n.maxSize,w)*i:l=w*i}return{uSizeT:l,uSize:u}}class cc extends ft{constructor(e,i,l,u,f){super(e,i),this.angle=u,this.z=l,f!==void 0&&(this.segment=f)}clone(){return new cc(this.x,this.y,this.z,this.angle,this.segment)}}function hI(n,e,i,l,u){if(e.segment===void 0)return!0;let f=e,p=e.segment+1,y=0;for(;y>-i/2;){if(p--,p<0)return!1;y-=n[p].dist(f),f=n[p]}y+=n[p].dist(n[p+1]),p++;const w=[];let E=0;for(;y<i/2;){const A=n[p],P=n[p+1];if(!P)return!1;let M=n[p-1].angleTo(A)-A.angleTo(P);for(M=Math.abs((M+3*Math.PI)%(2*Math.PI)-Math.PI),w.push({distance:y,angleDelta:M}),E+=M;y-w[0].distance>l;)E-=w.shift().angleDelta;if(E>u)return!1;p++,y+=A.dist(P)}return!0}function fI(n){let e=0;for(let i=0;i<n.length-1;i++)e+=n[i].dist(n[i+1]);return e}function pI(n,e,i){return n?.6*e*i:0}function mI(n,e){return Math.max(n?n.right-n.left:0,e?e.right-e.left:0)}function GL(n,e,i,l,u,f){const p=pI(i,u,f),y=mI(i,l)*f;let w=0;const E=fI(n)/2;for(let A=0;A<n.length-1;A++){const P=n[A],M=n[A+1],O=P.dist(M);if(w+O>E){const D=(E-w)/O,V=Yt(P.x,M.x,D),G=Yt(P.y,M.y,D),q=new cc(V,G,0,M.angleTo(P),A);return!p||hI(n,q,y,p,e)?q:void 0}w+=O}}function qL(n,e,i,l,u,f,p,y,w){const E=pI(l,f,p),A=mI(l,u),P=A*p,M=n[0].x===0||n[0].x===w||n[0].y===0||n[0].y===w;return e-P<e/4&&(e=P+e/4),gI(n,M?e/2*y%e:(A/2+2*f)*p*y%e,e,E,i,P,M,!1,w)}function gI(n,e,i,l,u,f,p,y,w){const E=f/2,A=fI(n);let P=0,M=e-i,O=[];for(let D=0;D<n.length-1;D++){const V=n[D],G=n[D+1],q=V.dist(G),te=G.angleTo(V);for(;M+i<P+q;){M+=i;const re=(M-P)/q,oe=Yt(V.x,G.x,re),xe=Yt(V.y,G.y,re);if(oe>=0&&oe<w&&xe>=0&&xe<w&&M-E>=0&&M+E<=A){const ve=new cc(oe,xe,0,te,D);l&&!hI(n,ve,f,l,u)||O.push(ve)}}P+=q}return y||O.length||p||(O=gI(n,P/2,i,l,u,f,p,!0,w)),O}function _I(n){let e=0,i=0;for(const p of n)e+=p.w*p.h,i=Math.max(i,p.w);n.sort((p,y)=>y.h-p.h);const l=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let u=0,f=0;for(const p of n)for(let y=l.length-1;y>=0;y--){const w=l[y];if(!(p.w>w.w||p.h>w.h)){if(p.x=w.x,p.y=w.y,f=Math.max(f,p.y+p.h),u=Math.max(u,p.x+p.w),p.w===w.w&&p.h===w.h){const E=l.pop();E&&y<l.length&&(l[y]=E)}else p.h===w.h?(w.x+=p.w,w.w-=p.w):p.w===w.w?(w.y+=p.h,w.h-=p.h):(l.push({x:w.x+p.w,y:w.y,w:w.w-p.w,h:p.h}),w.y+=p.h,w.h-=p.h);break}}return{w:u,h:f,fill:e/(u*f)||0}}Pt(cc,"Anchor");const jd=1;class yg{static getImagePositionScale(e,i,l){if(i&&e&&e.options&&e.options.transform){const u=e.options.transform;return{x:u.a,y:u.d}}return{x:l,y:l}}constructor(e,i,l,u){this.paddedRect=e;const{pixelRatio:f,version:p,stretchX:y,stretchY:w,content:E,sdf:A,usvg:P}=i;this.pixelRatio=f,this.stretchX=y,this.stretchY=w,this.content=E,this.version=p,this.padding=l,this.sdf=A,this.usvg=P,this.scale=yg.getImagePositionScale(u,P,f)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function pw(n,e,i){const l=Lo.parse(n),u=function(f,p,y=[1,1]){return{x:0,y:0,w:(f.data?f.data.width:f.width*y[0])+2*p,h:(f.data?f.data.height:f.height*y[1])+2*p}}(e,i,[l.options.transform.a,l.options.transform.d]);return{bin:u,imagePosition:new yg(u,e,i,l),imageVariant:l}}class yI{constructor(e,i,l){const u=new Map,f=new Map;this.haveRenderCallbacks=[];const p=[];this.addImages(e,u,jd,p),this.addImages(i,f,2,p);const{w:y,h:w}=_I(p),E=new Yn({width:y||1,height:w||1});for(const[A,P]of e.entries()){const M=u.get(A).paddedRect;Yn.copy(P.data,E,{x:0,y:0},{x:M.x+jd,y:M.y+jd},P.data,null,P.sdf)}for(const[A,P]of i.entries()){const M=f.get(A),O=M.paddedRect;let D=M.padding;const V=O.x+D,G=O.y+D,q=P.data.width,te=P.data.height;D=D>1?D-1:D,Yn.copy(P.data,E,{x:0,y:0},{x:V,y:G},P.data,l),Yn.copy(P.data,E,{x:0,y:te-D},{x:V,y:G-D},{width:q,height:D},l),Yn.copy(P.data,E,{x:0,y:0},{x:V,y:G+te},{width:q,height:D},l),Yn.copy(P.data,E,{x:q-D,y:0},{x:V-D,y:G},{width:D,height:te},l),Yn.copy(P.data,E,{x:0,y:0},{x:V+q,y:G},{width:D,height:te},l),Yn.copy(P.data,E,{x:q-D,y:te-D},{x:V-D,y:G-D},{width:D,height:D},l),Yn.copy(P.data,E,{x:0,y:te-D},{x:V+q,y:G-D},{width:D,height:D},l),Yn.copy(P.data,E,{x:0,y:0},{x:V+q,y:G+te},{width:D,height:D},l),Yn.copy(P.data,E,{x:q-D,y:0},{x:V-D,y:G+te},{width:D,height:D},l)}this.lut=l,this.image=E,this.iconPositions=u,this.patternPositions=f}addImages(e,i,l,u){for(const[f,p]of e.entries()){const{bin:y,imagePosition:w,imageVariant:E}=pw(f,p,l);i.set(f,w),u.push(y),p.hasRenderCallback&&this.haveRenderCallbacks.push(E.id)}}patchUpdatedImages(e,i,l){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(u=>e.hasImage(u,l)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,l);for(const u of e.getUpdatedImages(l)){for(const f of this.iconPositions.keys()){const p=Lo.parse(f);if(Xs.isEqual(p.id,u)){const y=e.getImage(u,l);this.patchUpdatedImage(this.iconPositions.get(f),y,i,null)}}for(const f of this.patternPositions.keys()){const p=Lo.parse(f);if(Xs.isEqual(p.id,u)){const y=e.getImage(u,l);this.patchUpdatedImage(this.patternPositions.get(f),y,i,this.lut)}}}}patchUpdatedImage(e,i,l,u=null){if(!e||!i||e.version===i.version)return;e.version=i.version;const[f,p]=e.tl,y=e.sdf;if(this.lut||y){const w={width:i.data.width,height:i.data.height},E=new Yn(w);Yn.copy(i.data,E,{x:0,y:0},{x:0,y:0},w,u,y),l.update(E,{position:{x:f,y:p}})}else l.update(i.data,{position:{x:f,y:p}})}}Pt(yg,"ImagePosition"),Pt(yI,"ImageAtlas");const xg=1e20;function xI(n,e,i,l,u,f,p,y,w){for(let E=e;E<e+l;E++)vI(n,i*f+E,f,u,p,y,w);for(let E=i;E<i+u;E++)vI(n,E*f+e,1,l,p,y,w)}function vI(n,e,i,l,u,f,p){f[0]=0,p[0]=-xg,p[1]=xg,u[0]=n[e];for(let y=1,w=0,E=0;y<l;y++){u[y]=n[e+y*i];const A=y*y;do{const P=f[w];E=(u[y]-u[P]+A-P*P)/(y-P)/2}while(E<=p[w]&&--w>-1);w++,f[w]=y,p[w]=E,p[w+1]=xg}for(let y=0,w=0;y<l;y++){for(;p[w+1]<y;)w++;const E=f[w],A=y-E;n[e+y*i]=u[E]+A*A}}const Na=2,mw={none:0,ideographs:1,all:2};class Df{constructor(e,i,l){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=l,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){const l=[],u=this.url||is.GLYPHS_URL;for(const f in e)for(const p of e[f])l.push({stack:f,id:p});qe(l,({stack:f,id:p},y)=>{let w=this.entries[f];w||(w=this.entries[f]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let E=w.glyphs[p];if(E!==void 0)return void y(null,{stack:f,id:p,glyph:E});if(E=this._tinySDF(w,f,p),E)return w.glyphs[p]=E,void y(null,{stack:f,id:p,glyph:E});const A=Math.floor(p/256);if(256*A>65535)return Lr("glyphs > 65535 not supported"),void y(null,{stack:f,id:p,glyph:E});if(w.ranges[A])return void y(null,{stack:f,id:p,glyph:E});let P=w.requests[A];P||(P=w.requests[A]=[],Df.loadGlyphRange(f,A,u,this.requestManager,(M,O)=>{if(O){w.ascender=O.ascender,w.descender=O.descender;for(const D in O.glyphs)this._doesCharSupportLocalGlyph(+D)||(w.glyphs[+D]=O.glyphs[+D]);w.ranges[A]=!0}for(const D of P)D(M,O);delete w.requests[A]})),P.push((M,O)=>{M?y(M):O&&y(null,{stack:f,id:p,glyph:O.glyphs[p]||null})})},(f,p)=>{if(f)i(f);else if(p){const y={};for(const{stack:w,id:E,glyph:A}of p)y[w]===void 0&&(y[w]={}),y[w].glyphs===void 0&&(y[w].glyphs={}),y[w].glyphs[E]=A&&{id:A.id,bitmap:A.bitmap.clone(),metrics:A.metrics},y[w].ascender=this.entries[w].ascender,y[w].descender=this.entries[w].descender;i(null,y)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==mw.none&&(this.localGlyphMode===mw.all?!!this.localFontFamily:!!this.localFontFamily&&(Xt["CJK Unified Ideographs"](e)||Xt["Hangul Syllables"](e)||Xt.Hiragana(e)||Xt.Katakana(e)||Xt["CJK Symbols and Punctuation"](e)||Xt["CJK Unified Ideographs Extension A"](e)||Xt["CJK Unified Ideographs Extension B"](e)||Xt.Osage(e)))}_tinySDF(e,i,l){const u=this.localFontFamily;if(!u||!this._doesCharSupportLocalGlyph(l))return;let f=e.tinySDF;if(!f){let V="400";/bold/i.test(i)?V="900":/medium/i.test(i)?V="500":/light/i.test(i)&&(V="200"),f=e.tinySDF=new Df.TinySDF({fontFamily:u,fontWeight:V,fontSize:24*Na,buffer:3*Na,radius:8*Na}),f.fontWeight=V}if(this.localGlyphs[f.fontWeight][l])return this.localGlyphs[f.fontWeight][l];const p=String.fromCodePoint(l),{data:y,width:w,height:E,glyphWidth:A,glyphHeight:P,glyphLeft:M,glyphTop:O,glyphAdvance:D}=f.draw(p);return this.localGlyphs[f.fontWeight][l]={id:l,bitmap:new au({width:w,height:E},y),metrics:{width:A/Na,height:P/Na,left:M/Na,top:O/Na-27,advance:D/Na,localGlyph:!0}}}}Df.loadGlyphRange=function(n,e,i,l,u){const f=256*e,p=f+255,y=l.transformRequest(l.normalizeGlyphsURL(i).replace("{fontstack}",n).replace("{range}",`${f}-${p}`),gh.Glyphs);kc(y,(w,E)=>{if(w)u(w);else if(E){const A={},P=function(M){return new py(M).readFields(zL,{})}(E);for(const M of P.glyphs)A[M.id]=M;u(null,{glyphs:A,ascender:P.ascender,descender:P.descender})}})},Df.TinySDF=class{constructor({fontSize:n=24,buffer:e=3,radius:i=8,cutoff:l=.25,fontFamily:u="sans-serif",fontWeight:f="normal",fontStyle:p="normal",lang:y=null}={}){this.buffer=e,this.cutoff=l,this.radius=i,this.lang=y;const w=this.size=n+4*e,E=this._createCanvas(w),A=this.ctx=E.getContext("2d",{willReadFrequently:!0});A.font=`${p} ${f} ${n}px ${u}`,A.textBaseline="alphabetic",A.textAlign="left",A.fillStyle="black",this.gridOuter=new Float64Array(w*w),this.gridInner=new Float64Array(w*w),this.f=new Float64Array(w),this.z=new Float64Array(w+1),this.v=new Uint16Array(w)}_createCanvas(n){const e=document.createElement("canvas");return e.width=e.height=n,e}draw(n){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:l,actualBoundingBoxLeft:u,actualBoundingBoxRight:f}=this.ctx.measureText(n),p=Math.ceil(i),y=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-u))),w=Math.min(this.size-this.buffer,p+Math.ceil(l)),E=y+2*this.buffer,A=w+2*this.buffer,P=Math.max(E*A,0),M=new Uint8ClampedArray(P),O={data:M,width:E,height:A,glyphWidth:y,glyphHeight:w,glyphTop:p,glyphLeft:0,glyphAdvance:e};if(y===0||w===0)return O;const{ctx:D,buffer:V,gridInner:G,gridOuter:q}=this;this.lang&&(D.lang=this.lang),D.clearRect(V,V,y,w),D.fillText(n,V,V+p);const te=D.getImageData(V,V,y,w);q.fill(xg,0,P),G.fill(0,0,P);for(let re=0;re<w;re++)for(let oe=0;oe<y;oe++){const xe=te.data[4*(re*y+oe)+3]/255;if(xe===0)continue;const ve=(re+V)*E+oe+V;if(xe===1)q[ve]=0,G[ve]=xg;else{const Se=.5-xe;q[ve]=Se>0?Se*Se:0,G[ve]=Se<0?Se*Se:0}}xI(q,0,0,E,A,E,this.f,this.v,this.z),xI(G,V,V,y,w,E,this.f,this.v,this.z);for(let re=0;re<P;re++){const oe=Math.sqrt(q[re])-Math.sqrt(G[re]);M[re]=Math.round(255-255*(oe/this.radius+this.cutoff))}return O}};const uu=jd;function bI(n,e){return n+e[1]-e[0]}function wI(n,e,i,l,u=1){const f=[],p=n.imagePrimary,y=p.pixelRatio,w=p.paddedRect.w-2*uu,E=p.paddedRect.h-2*uu,A=(n.right-n.left)*u,P=(n.bottom-n.top)*u,M=p.stretchX||[[0,w]],O=p.stretchY||[[0,E]],D=M.reduce(bI,0),V=O.reduce(bI,0),G=w-D,q=E-V;let te=0,re=D,oe=0,xe=V,ve=0,Se=G,Ce=0,Ae=q;if(p.content&&l){const Oe=p.content;te=gy(M,0,Oe[0]),oe=gy(O,0,Oe[1]),re=gy(M,Oe[0],Oe[2]),xe=gy(O,Oe[1],Oe[3]),ve=Oe[0]-te,Ce=Oe[1]-oe,Se=Oe[2]-Oe[0]-re,Ae=Oe[3]-Oe[1]-xe}const Qe=(Oe,et,ct,rt)=>{const st=_y(Oe.stretch-te,re,A,n.left*u),ht=yy(Oe.fixed-ve,Se,Oe.stretch,D),Ke=_y(et.stretch-oe,xe,P,n.top*u),at=yy(et.fixed-Ce,Ae,et.stretch,V),$e=_y(ct.stretch-te,re,A,n.left*u),Be=yy(ct.fixed-ve,Se,ct.stretch,D),pt=_y(rt.stretch-oe,xe,P,n.top*u),ut=yy(rt.fixed-Ce,Ae,rt.stretch,V),$t=new ft(st,Ke),It=new ft($e,Ke),Lt=new ft($e,pt),xt=new ft(st,pt),Bt=new ft(ht/y,at/y),sr=new ft(Be/y,ut/y),St=e*Math.PI/180;if(St){const Mt=Math.sin(St),hr=Math.cos(St),Fr=[hr,-Mt,Mt,hr];$t._matMult(Fr),It._matMult(Fr),xt._matMult(Fr),Lt._matMult(Fr)}const jt=Oe.stretch+Oe.fixed,Kt=ct.stretch+ct.fixed,ur=et.stretch+et.fixed,Ir=rt.stretch+rt.fixed,mr=n.imageSecondary;return{tl:$t,tr:It,bl:xt,br:Lt,texPrimary:{x:p.paddedRect.x+uu+jt,y:p.paddedRect.y+uu+ur,w:Kt-jt,h:Ir-ur},texSecondary:mr?{x:mr.paddedRect.x+uu+jt,y:mr.paddedRect.y+uu+ur,w:Kt-jt,h:Ir-ur}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Bt,pixelOffsetBR:sr,minFontScaleX:Se/y/A,minFontScaleY:Ae/y/P,isSDF:i}};if(l&&(p.stretchX||p.stretchY)){const Oe=SI(M,G,D),et=SI(O,q,V);for(let ct=0;ct<Oe.length-1;ct++){const rt=Oe[ct],st=Oe[ct+1];for(let ht=0;ht<et.length-1;ht++)f.push(Qe(rt,et[ht],st,et[ht+1]))}}else f.push(Qe({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:w+1},{fixed:0,stretch:E+1}));return f}function gy(n,e,i){let l=0;for(const u of n)l+=Math.max(e,Math.min(i,u[1]))-Math.max(e,Math.min(i,u[0]));return l}function SI(n,e,i){const l=[{fixed:-uu,stretch:0}];for(const[u,f]of n){const p=l[l.length-1];l.push({fixed:u-p.stretch,stretch:p.stretch}),l.push({fixed:u-p.stretch,stretch:p.stretch+(f-u)})}return l.push({fixed:e+uu,stretch:i}),l}function _y(n,e,i,l){return n/e*i+l}function yy(n,e,i,l){return n-e*i/l}function HL(n,e,i,l){const u=e+n.positionedLines[l].lineOffset;return l===0?i+u/2:i+(u+(e+n.positionedLines[l-1].lineOffset))/2}function WL(n,e=1,i=!1){let l=1/0,u=1/0,f=-1/0,p=-1/0;const y=n[0];for(let O=0;O<y.length;O++){const D=y[O];(!O||D.x<l)&&(l=D.x),(!O||D.y<u)&&(u=D.y),(!O||D.x>f)&&(f=D.x),(!O||D.y>p)&&(p=D.y)}const w=Math.min(f-l,p-u);let E=w/2;const A=new Lh([],ZL);if(w===0)return new ft(l,u);for(let O=l;O<f;O+=w)for(let D=u;D<p;D+=w)A.push(new jf(O+E,D+E,E,n));let P=function(O){let D=0,V=0,G=0;const q=O[0];for(let te=0,re=q.length,oe=re-1;te<re;oe=te++){const xe=q[te],ve=q[oe],Se=xe.x*ve.y-ve.x*xe.y;V+=(xe.x+ve.x)*Se,G+=(xe.y+ve.y)*Se,D+=3*Se}return new jf(V/D,G/D,0,O)}(n),M=A.length;for(;A.length;){const O=A.pop();(O.d>P.d||!P.d)&&(P=O,i&&console.log("found best %d after %d probes",Math.round(1e4*O.d)/1e4,M)),O.max-P.d<=e||(E=O.h/2,A.push(new jf(O.p.x-E,O.p.y-E,E,n)),A.push(new jf(O.p.x+E,O.p.y-E,E,n)),A.push(new jf(O.p.x-E,O.p.y+E,E,n)),A.push(new jf(O.p.x+E,O.p.y+E,E,n)),M+=4)}return i&&(console.log(`num probes: ${M}`),console.log(`best distance: ${P.d}`)),P.p}function ZL(n,e){return e.max-n.max}class jf{constructor(e,i,l,u){this.p=new ft(e,i),this.h=l,this.d=function(f,p){let y=!1,w=1/0;for(let E=0;E<p.length;E++){const A=p[E];for(let P=0,M=A.length,O=M-1;P<M;O=P++){const D=A[P],V=A[O];D.y>f.y!=V.y>f.y&&f.x<(V.x-D.x)*(f.y-D.y)/(V.y-D.y)+D.x&&(y=!y),w=Math.min(w,Li(f,D,V))}}return(y?1:-1)*Math.sqrt(w)}(this.p,u),this.max=this.d+this.h*Math.SQRT2}}const XL=Object.keys,gw=Number.POSITIVE_INFINITY,YL=Math.sqrt(2);function TI(n,[e,i]){let l=0,u=0;if(i===gw){e<0&&(e=0);const f=e/YL;switch(n){case"top-right":case"top-left":u=f-7;break;case"bottom-right":case"bottom-left":u=7-f;break;case"bottom":u=7-e;break;case"top":u=e-7}switch(n){case"top-right":case"bottom-right":l=-f;break;case"top-left":case"bottom-left":l=f;break;case"left":l=e;break;case"right":l=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),n){case"top-right":case"top-left":case"top":u=i-7;break;case"bottom-right":case"bottom-left":case"bottom":u=7-i}switch(n){case"top-right":case"bottom-right":case"right":l=-e;break;case"top-left":case"bottom-left":case"left":l=e}}return[l,u]}function xy(n,e,i,l,u,f,p,y,w){if(!e||!e.usvg)return;const E=uI(l),A=uI(u),P=f!=="both"&&f!=="width"||!lI(l)?1:A.width/E.width,M=f!=="both"&&f!=="height"||!cI(l)?1:A.height/E.height;i.scaleSelf(P,M);const O=i.toString();p.set(O,i),y.set(O,e);const{imagePosition:D}=pw(O,e,jd);w.set(O,D)}function EI(n,e,i,l,u,f,p,y,w){if(!n)return;const E=function(A,P,M,O,D,V){if(A.kind==="camera")return A.maxSize;if(A.kind==="composite"){const G=P.possiblyEvaluate(new gi(A.maxZoom,{worldview:V}),M).evaluate(D,{},M),q=P.possiblyEvaluate(new gi(A.minZoom,{worldview:V}),M).evaluate(D,{},M);return Math.max(G,q)}return P.possiblyEvaluate(new gi(O,{worldview:V})).evaluate(D,{},M)}(e,i,l,u,f,w);return n.scaleSelf(E*y*p)}function II(n,e,i,l,u,f,p,y,w){return{iconPrimary:EI(n.getPrimary(),e,i,l,u,f,p,y,w),iconSecondary:EI(n.getSecondary(),e,i,l,u,f,p,y,w)}}function KL(n,e,i){if(!e)return;const l=i.get(n.toString()),u=i.get(e.toString());l&&u&&(l.paddedRect.w===u.paddedRect.w&&l.paddedRect.h===u.paddedRect.h||Lr(`Mismatch in icon variant sizes: ${n.toString()} and ${e.toString()}`),l.usvg!==u.usvg&&Lr(`Mismatch in icon variant image types: ${n.id} and ${e.id}`))}function CI(n,e,i,l){if(!n)return;const u=e.get(i.toString());if(n.imagePrimary=u,l){const f=e.get(l.toString());n.imageSecondary=f}}function JL(n,e){for(const i in n.horizontal)AI(n.horizontal[i],e);AI(n.vertical,e)}function AI(n,e){if(n){for(const i of n.positionedLines)for(const l of i.positionedGlyphs)if(l.image!==null){const u=l.image.toString();l.rect=e.get(u).paddedRect}}}function _w(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function QL(n,e,i,l,u,f,p,y,w){const E=yw(f.horizontal)||f.vertical,A=i.get("icon-text-fit-padding").evaluate(l,{},u);let P,M=e;return e&&w!=="none"&&(n.allowVerticalPlacement&&f.vertical&&(P=aI(e,f.vertical,w,A,y,p)),E&&(M=aI(e,E,w,A,y,p))),{defaultShapedIcon:M,verticallyShapedIcon:P}}function eO(n,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q,te,re){let oe=p.textMaxSize.evaluate(e,{},M);oe===void 0?oe=y*p.textScaleFactor:oe*=p.textScaleFactor;const xe=n.layers[0].layout,ve=yw(i.horizontal)||i.vertical,Se=O.name==="globe",Ce=Fn,Ae=n.tilePixelRatio*oe/Ce,Qe=(ht=n.overscaling,n.zoom>18&&ht>2&&(ht>>=1),Math.max(vt/(512*ht),1)*xe.get("symbol-spacing")),Oe=xe.get("text-padding")*n.tilePixelRatio,et=xe.get("icon-padding")*n.tilePixelRatio,ct=Re(xe.get("text-max-angle")),rt=xe.get("icon-rotation-alignment")==="map"&&re!=="point",st=Qe/2;var ht;n.hasAnyIconTextFit===!1&&G!=="none"&&(n.hasAnyIconTextFit=!0);const Ke=e.properties?+e.properties[br]:null,at=Ke&&n.elevationFeatureIdToIndex?n.elevationFeatureIdToIndex.get(Ke):65535,$e=(Be,pt,ut)=>{if(pt.x<0||pt.x>=vt||pt.y<0||pt.y>=vt)return;let $t=null;if(Se){const{x:It,y:Lt,z:xt}=O.projectTilePoint(pt.x,pt.y,ut);$t={anchor:new cc(It,Lt,xt,0,void 0),up:O.upVector(ut,pt.x,pt.y)}}(function(It,Lt,xt,Bt,sr,St,jt,Kt,ur,Ir,mr,Mt,hr,Fr,ue,de,Ve,Je,wt,bt,kt,qt,Cr,Ar,Tr,si,Mi,Sr,_i){const li=It.addToLineVertexArray(Lt,Bt);let Zr,bi,wi,mi,yi,ci,Pr,ui=0,Bi=0,er=0,Vr=0,Si=-1,qi=-1;const Ci={};let gn=vh("");const hi=xt?xt.anchor:Lt,an=Sr!=="none";let Ds=0,Kn=0;if(ur._unevaluatedLayout.getValue("text-radial-offset")===void 0){const _n=ur.layout.get("text-offset").evaluate(kt,{},Tr);Ds=_n[0]*Fn,Kn=_n[1]*Fn}else Ds=ur.layout.get("text-radial-offset").evaluate(kt,{},Tr)*Fn,Kn=gw;if(It.allowVerticalPlacement&&sr.vertical){const _n=sr.vertical;if(ue)ci=xw(_n),Kt&&(Pr=xw(Kt));else{const kn=ur.layout.get("text-rotate").evaluate(kt,{},Tr)+90;wi=vy(Ir,hi,Lt,mr,Mt,hr,_n,Fr,kn,de),Kt&&(mi=vy(Ir,hi,Lt,mr,Mt,hr,Kt,Je,kn))}}if(St){const _n=It.iconSizeData,kn=ur.layout.get("icon-rotate").evaluate(kt,{},Tr),Jn=wI(St,kn,Cr,an,qt.iconScaleFactor),ys=Kt?wI(Kt,kn,Cr,an,qt.iconScaleFactor):void 0;bi=vy(Ir,hi,Lt,mr,Mt,hr,St,Je,kn,null),ui=4*Jn.length;let os=null;_n.kind==="source"?(os=[vl*ur.layout.get("icon-size").evaluate(kt,{},Tr)*qt.iconScaleFactor],os[0]>du&&Lr(`${It.layerIds[0]}: Value for "icon-size" is >= ${vg}. Reduce your "icon-size".`)):_n.kind==="composite"&&(os=[vl*qt.compositeIconSizes[0].evaluate(kt,{},Tr)*qt.iconScaleFactor,vl*qt.compositeIconSizes[1].evaluate(kt,{},Tr)*qt.iconScaleFactor],(os[0]>du||os[1]>du)&&Lr(`${It.layerIds[0]}: Value for "icon-size" is >= ${vg}. Reduce your "icon-size".`)),It.addSymbols(It.icon,Jn,os,bt,wt,kt,void 0,xt,Lt,li.lineStartIndex,li.lineLength,-1,Ar,Tr,si,Mi),Si=It.icon.placedSymbolArray.length-1,ys&&(Bi=4*ys.length,It.addSymbols(It.icon,ys,os,bt,wt,kt,io.vertical,xt,Lt,li.lineStartIndex,li.lineLength,-1,Ar,Tr,si,Mi),qi=It.icon.placedSymbolArray.length-1)}for(const _n in sr.horizontal){const kn=_n,Jn=sr.horizontal[kn];Zr||(gn=vh(Jn.text),ue?yi=xw(Jn):Zr=vy(Ir,hi,Lt,mr,Mt,hr,Jn,Fr,ur.layout.get("text-rotate").evaluate(kt,{},Tr),de));const ys=Jn.positionedLines.length===1;if(er+=PI(It,xt,Lt,Jn,jt,ur,ue,kt,de,li,sr.vertical?io.horizontal:io.horizontalOnly,ys?XL(sr.horizontal):[kn],Ci,Si,qt,Ar,Tr,si),ys)break}sr.vertical&&(Vr+=PI(It,xt,Lt,sr.vertical,jt,ur,ue,kt,de,li,io.vertical,["vertical"],Ci,qi,qt,Ar,Tr,si));let Hn=-1;const js=(_n,kn)=>_n?Math.max(_n,kn):kn;Hn=js(yi,Hn),Hn=js(ci,Hn),Hn=js(Pr,Hn);const bl=Hn>-1?1:0;It.glyphOffsetArray.length>=65535&&Lr("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),kt.sortKey!==void 0&&It.addToSortKeyRanges(It.symbolInstances.length,kt.sortKey),It.symbolInstances.emplaceBack(Lt.x,Lt.y,hi.x,hi.y,hi.z,Ci.right>=0?Ci.right:-1,Ci.center>=0?Ci.center:-1,Ci.left>=0?Ci.left:-1,Ci.vertical>=0?Ci.vertical:-1,Si,qi,gn,Zr!==void 0?Zr:It.collisionBoxArray.length,Zr!==void 0?Zr+1:It.collisionBoxArray.length,wi!==void 0?wi:It.collisionBoxArray.length,wi!==void 0?wi+1:It.collisionBoxArray.length,bi!==void 0?bi:It.collisionBoxArray.length,bi!==void 0?bi+1:It.collisionBoxArray.length,mi||It.collisionBoxArray.length,mi?mi+1:It.collisionBoxArray.length,mr,er,Vr,ui,Bi,bl,0,Ds,Kn,Hn,0,an?1:0,_i)})(n,pt,$t,Be,i,l,f,u,n.layers[0],n.collisionBoxArray,e.index,e.sourceLayerIndex,n.index,Oe,te,E,0,et,rt,q,e,p,A,P,M,D,V,G,at)};if(re==="line")for(const Be of oy(e.geometry,0,0,vt,vt)){const pt=qL(Be,Qe,ct,i.vertical||ve,l,Ce,Ae,n.overscaling,vt);for(const ut of pt)ve&&tO(n,ve.text,st,ut)||$e(Be,ut,M)}else if(re==="line-center"){for(const Be of e.geometry)if(Be.length>1){const pt=GL(Be,ct,i.vertical||ve,l,Ce,Ae);pt&&$e(Be,pt,M)}}else if(e.type==="Polygon")for(const Be of rg(e.geometry,0)){const pt=WL(Be,16);$e(Be[0],new cc(pt.x,pt.y,0,0,void 0),M)}else if(e.type==="LineString")for(const Be of e.geometry)$e(Be,new cc(Be[0].x,Be[0].y,0,0,void 0),M);else if(e.type==="Point")for(const Be of e.geometry)for(const pt of Be)$e([pt],new cc(pt.x,pt.y,0,0,void 0),M)}const vg=255,du=vg*vl;function PI(n,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G,q){const te=function(xe,ve,Se,Ce,Ae,Qe,Oe,et){const ct=[];if(ve.positionedLines.length===0)return ct;const rt=Ce.layout.get("text-rotate").evaluate(Qe,{})*Math.PI/180,st=function(Be){const pt=Be[0],ut=Be[1],$t=pt*ut;return $t>0?[pt,-ut]:$t<0?[-pt,ut]:pt===0?[ut,pt]:[ut,-pt]}(Se);let ht=Math.abs(ve.top-ve.bottom);for(const Be of ve.positionedLines)ht-=Be.lineOffset;const Ke=ve.positionedLines.length,at=ht/Ke;let $e=ve.top-Se[1];for(let Be=0;Be<Ke;++Be){const pt=ve.positionedLines[Be];$e=HL(ve,at,$e,Be);for(const ut of pt.positionedGlyphs){if(!ut.rect)continue;const $t=ut.rect||{};let It=eI+1,Lt=!0,xt=1,Bt=0;if(ut.image){const kt=Oe.get(ut.image.toString());if(!kt)continue;if(kt.sdf){Lr("SDF images are not supported in formatted text and will be ignored.");continue}Lt=!1,xt=kt.pixelRatio,It=jd/xt}const sr=(Ae||et)&&ut.vertical,St=ut.metrics.advance*ut.scale/2,jt=ut.metrics,Kt=ut.rect;if(Kt===null)continue;et&&ve.verticalizable&&(Bt=ut.image?St-ut.metrics.width*ut.scale/2:0);const ur=Ae?[ut.x+St,ut.y]:[0,0];let Ir=[0,0],mr=[0,0],Mt=!1;Ae||(sr?(mr=[ut.x+St+st[0],ut.y+st[1]-Bt],Mt=!0):Ir=[ut.x+St+Se[0],ut.y+Se[1]-Bt]);const hr=Kt.w*ut.scale/(xt*(ut.localGlyph?Na:1)),Fr=Kt.h*ut.scale/(xt*(ut.localGlyph?Na:1));let ue,de,Ve,Je;if(sr){const kt=ut.y-$e,qt=new ft(-St,St-kt),Cr=-Math.PI/2,Ar=new ft(...mr);ue=new ft(-St+Ir[0],Ir[1]),ue._rotateAround(Cr,qt)._add(Ar),ue.x+=-kt+St,ue.y-=(jt.left-It)*ut.scale;const Tr=ut.image?jt.advance*ut.scale:Fn*ut.scale,si=String.fromCodePoint(ut.glyph);CL(si)?ue.x+=(1-It)*ut.scale:AL(si)?ue.x+=Tr-jt.height*ut.scale+(-It-1)*ut.scale:ue.x+=ut.image||jt.width+2*It===Kt.w&&jt.height+2*It===Kt.h?(Tr-Fr)/2:(Tr-(jt.height+2*It)*ut.scale)/2,de=new ft(ue.x,ue.y-hr),Ve=new ft(ue.x+Fr,ue.y),Je=new ft(ue.x+Fr,ue.y-hr)}else{const kt=(jt.left-It)*ut.scale-St+Ir[0],qt=(-jt.top-It)*ut.scale+Ir[1],Cr=kt+hr,Ar=qt+Fr;ue=new ft(kt,qt),de=new ft(Cr,qt),Ve=new ft(kt,Ar),Je=new ft(Cr,Ar)}if(rt){let kt;kt=Ae?new ft(0,0):Mt?new ft(st[0],st[1]):new ft(Se[0],Se[1]),ue._rotateAround(rt,kt),de._rotateAround(rt,kt),Ve._rotateAround(rt,kt),Je._rotateAround(rt,kt)}const wt=new ft(0,0),bt=new ft(0,0);ct.push({tl:ue,tr:de,bl:Ve,br:Je,texPrimary:$t,texSecondary:void 0,writingMode:ve.writingMode,glyphOffset:ur,sectionIndex:ut.sectionIndex,isSDF:Lt,pixelOffsetTL:wt,pixelOffsetBR:bt,minFontScaleX:0,minFontScaleY:0})}}return ct}(0,l,w,f,p,y,u,n.allowVerticalPlacement),re=n.textSizeData;let oe=null;re.kind==="source"?(oe=[vl*f.layout.get("text-size").evaluate(y,{},G)*D.textScaleFactor],oe[0]>du&&Lr(`${n.layerIds[0]}: Value for "text-size" is >= ${vg}. Reduce your "text-size".`)):re.kind==="composite"&&(oe=[vl*D.compositeTextSizes[0].evaluate(y,{},G)*D.textScaleFactor,vl*D.compositeTextSizes[1].evaluate(y,{},G)*D.textScaleFactor],(oe[0]>du||oe[1]>du)&&Lr(`${n.layerIds[0]}: Value for "text-size" is >= ${vg}. Reduce your "text-size".`)),n.addSymbols(n.text,te,oe,w,p,y,A,e,i,E.lineStartIndex,E.lineLength,O,V,G,q,!1);for(const xe of P)M[xe]=n.text.placedSymbolArray.length-1;return 4*te.length}function yw(n){for(const e in n)return n[e];return null}function vy(n,e,i,l,u,f,p,y,w,E){let A=p.top,P=p.bottom,M=p.left,O=p.right;if(oI(p)&&p.collisionPadding){const D=p.collisionPadding;M-=D[0],A-=D[1],O+=D[2],P+=D[3]}if(w){const D=new ft(M,A),V=new ft(O,A),G=new ft(M,P),q=new ft(O,P),te=Re(w);let re=new ft(0,0);E&&(re=new ft(E[0],E[1])),D._rotateAround(te,re),V._rotateAround(te,re),G._rotateAround(te,re),q._rotateAround(te,re),M=Math.min(D.x,V.x,G.x,q.x),O=Math.max(D.x,V.x,G.x,q.x),A=Math.min(D.y,V.y,G.y,q.y),P=Math.max(D.y,V.y,G.y,q.y)}return n.emplaceBack(e.x,e.y,e.z,i.x,i.y,M,A,O,P,y,l,u,f),n.length-1}function xw(n){oI(n)&&n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const e=n.bottom-n.top;return e>0?Math.max(10,e):null}function tO(n,e,i,l){const u=n.compareText;if(e in u){const f=u[e];for(let p=f.length-1;p>=0;p--)if(l.dist(f[p])<i)return!0}else u[e]=[];return u[e].push(l),!1}function kI(n,e){const i=n.fovAboveCenter,l=n.elevation?n.elevation.getMinElevationBelowMSL()*e:0,u=(n._camera.position[2]*n.worldSize-l)/Math.cos(n._pitch),f=Math.sin(i)*u/Math.sin(Math.max(Math.PI/2-n._pitch-i,.01));let p=Math.sin(n._pitch)*f+u;const y=u*(1/n._horizonShift);if(!n.elevation||n.elevation.exaggeration()===0){let w=Math.max(n.zoom-17,0);n.isOrthographic&&(w/=10),p*=1+w}return Math.min(1.01*p,y)}function bg(n,e){if(!e.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:e};const i=Math.pow(2,-n.z),l=n.x*i,u=(n.x+1)*i,f=n.y*i,p=(n.y+1)*i,y=_e(l),w=_e(u),E=me(f),A=me(p),P=e.project(y,E),M=e.project(w,E),O=e.project(w,A),D=e.project(y,A);let V=Math.min(P.x,M.x,O.x,D.x),G=Math.min(P.y,M.y,O.y,D.y),q=Math.max(P.x,M.x,O.x,D.x),te=Math.max(P.y,M.y,O.y,D.y);const re=i/16;function oe(ve,Se,Ce,Ae,Qe,Oe){const et=(Ce+Qe)/2,ct=(Ae+Oe)/2,rt=e.project(_e(et),me(ct)),st=Math.max(0,V-rt.x,G-rt.y,rt.x-q,rt.y-te);V=Math.min(V,rt.x),q=Math.max(q,rt.x),G=Math.min(G,rt.y),te=Math.max(te,rt.y),st>re&&(oe(ve,rt,Ce,Ae,et,ct),oe(rt,Se,et,ct,Qe,Oe))}oe(P,M,l,f,u,f),oe(M,O,u,f,u,p),oe(O,D,u,p,l,p),oe(D,P,l,p,l,f),V-=re,G-=re,q+=re,te+=re;const xe=1/Math.max(q-V,te-G);return{scale:xe,x:V*xe,y:G*xe,x2:q*xe,y2:te*xe,projection:e}}function MI(n,{x:e,y:i},l=0){return new ft(((e-l)*n.scale-n.x)*vt,(i*n.scale-n.y)*vt)}const rO=ae(new Float32Array(16));class hu{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new U(0,0)}projectTilePoint(e,i,l){return{x:e,y:i,z:0}}locationPoint(e,i,l,u=!0){return e._coordinatePoint(e.locationCoordinate(i,l),u)}pixelsPerMeter(e,i){return pe(1,e)*i}pixelSpaceConversion(e,i,l){return 1}farthestPixelDistance(e){return kI(e,e.pixelsPerMeter)}pointCoordinate(e,i,l,u){const f=e.horizonLineFromTop(!1),p=new ft(i,Math.max(f,l));return e.rayIntersectionCoordinate(e.pointRayIntersection(p,u))}pointCoordinate3D(e,i,l){const u=new ft(i,l);if(e.elevation)return e.elevation.pointCoordinate(u);{const f=this.pointCoordinate(e,u.x,u.y,0);return[f.x,f.y,f.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const l=e.horizonLineFromTop();return i.y<l}createInversionMatrix(e,i){return rO}createTileMatrix(e,i,l){let u,f,p;const y=l.canonical,w=ae(new Float64Array(16));if(this.isReprojectedInTileSpace){const E=bg(y,this);u=1,f=E.x+l.wrap*E.scale,p=E.y,J(w,w,[u/E.scale,u/E.scale,e.pixelsPerMeter/i])}else u=i/e.zoomScale(y.z),f=(y.x+Math.pow(2,y.z)*l.wrap)*u,p=y.y*u;return se(w,w,[f,p,0]),J(w,w,[u/vt,u/vt,1]),w}upVector(e,i,l){return[0,0,1]}upVectorScale(e,i,l){return{metersToTile:1}}}class iO extends hu{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,l]=this.parallels=e.parallels||[29.5,45.5],u=Math.sin(Re(i));this.n=(u+Math.sin(Re(l)))/2,this.c=1+u*(2*this.n-u),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:l,c:u,r0:f}=this,p=Re(e-this.center[0]),y=Re(i),w=Math.sqrt(u-2*l*Math.sin(y))/l;return{x:w*Math.sin(p*l),y:w*Math.cos(p*l)-f,z:0}}unproject(e,i){const{n:l,c:u,r0:f}=this,p=f+i;let y=Math.atan2(e,Math.abs(p))*Math.sign(p);p*l<0&&(y-=Math.PI*Math.sign(e)*Math.sign(p));const w=Re(this.center[0])*l;y=Me(y,-Math.PI-w,Math.PI-w);const E=be(X(y/l)+this.center[0],-180,180),A=Math.asin(be((u-(e*e+p*p)*l*l)/(2*l),-1,1)),P=be(X(A),-ye,ye);return new U(E,P)}}const wg=1.340264,Sg=-.081106,Tg=893e-6,Eg=.003796,by=Math.sqrt(3)/2;class nO extends hu{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const l=Math.asin(by*Math.sin(i)),u=l*l,f=u*u*u;return{x:.5*(e*Math.cos(l)/(by*(wg+3*Sg*u+f*(7*Tg+9*Eg*u)))/Math.PI+.5),y:1-.5*(l*(wg+Sg*u+f*(Tg+Eg*u))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let l=i=(2*(1-i)-1)*Math.PI,u=l*l,f=u*u*u;for(let A,P,M,O=0;O<12&&(P=l*(wg+Sg*u+f*(Tg+Eg*u))-i,M=wg+3*Sg*u+f*(7*Tg+9*Eg*u),A=P/M,l=be(l-A,-Math.PI/3,Math.PI/3),u=l*l,f=u*u*u,!(Math.abs(A)<1e-12));++O);const p=by*e*(wg+3*Sg*u+f*(7*Tg+9*Eg*u))/Math.cos(l),y=Math.asin(Math.sin(l)/by),w=be(180*p/Math.PI,-180,180),E=be(180*y/Math.PI,-ye,ye);return new U(w,E)}}class sO extends hu{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const l=360*(e-.5),u=be(360*(.5-i),-ye,ye);return new U(l,u)}}const zf=Math.PI/2;function wy(n){return Math.tan((zf+n)/2)}class oO extends hu{constructor(e){super(e),this.center=e.center||[0,30];const[i,l]=this.parallels=e.parallels||[30,30];let u=Re(i),f=Re(l);this.southernCenter=u+f<0,this.southernCenter&&(u=-u,f=-f);const p=Math.cos(u),y=wy(u);this.n=u===f?Math.sin(u):Math.log(p/Math.cos(f))/Math.log(wy(f)/y),this.f=p*Math.pow(wy(u),this.n)/this.n}project(e,i){i=Re(i),this.southernCenter&&(i=-i),e=Re(e-this.center[0]);const l=1e-6,{n:u,f}=this;f>0?i<-zf+l&&(i=-zf+l):i>zf-l&&(i=zf-l);const p=f/Math.pow(wy(i),u);let y=p*Math.sin(u*e),w=f-p*Math.cos(u*e);return y=.5*(y/Math.PI+.5),w=.5*(w/Math.PI+.5),{x:y,y:this.southernCenter?w:1-w,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:l,f:u}=this,f=u-i,p=Math.sign(f),y=Math.sign(l)*Math.sqrt(e*e+f*f);let w=Math.atan2(e,Math.abs(f))*p;f*l<0&&(w-=Math.PI*Math.sign(e)*p);const E=be(X(w/l)+this.center[0],-180,180),A=be(X(2*Math.atan(Math.pow(u/y,1/l))-zf),-ye,ye);return new U(E,this.southernCenter?-A:A)}}class NI extends hu{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:ce(e),y:ge(i),z:0}}unproject(e,i){const l=_e(e),u=me(i);return new U(l,u)}}const RI=Re(ye);class aO extends hu{project(e,i){const l=(i=Re(i))*i,u=l*l;return{x:.5*((e=Re(e))*(.8707-.131979*l+u*(u*(.003971*l-.001529*u)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+l*(.015085+u*(.028874*l-.044475-.005916*u)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let l=i=(2*(1-i)-1)*Math.PI,u=25,f=0,p=l*l;do{p=l*l;const E=p*p;f=(l*(1.007226+p*(.015085+E*(.028874*p-.044475-.005916*E)))-i)/(1.007226+p*(.045255+E*(.259866*p-.311325-.005916*11*E))),l=be(l-f,-RI,RI)}while(Math.abs(f)>1e-6&&--u>0);p=l*l;const y=be(X(e/(.8707+p*(p*(p*p*p*(.003971-.001529*p)-.013791)-.131979))),-180,180),w=X(l);return new U(y,w)}}const LI=Re(ye);class lO extends hu{project(e,i){i=Re(i),e=Re(e);const l=Math.cos(i),u=2/Math.PI,f=Math.acos(l*Math.cos(e/2)),p=Math.sin(f)/f,y=.5*(e*u+2*l*Math.sin(e/2)/p)||0,w=.5*(i+Math.sin(i)/p)||0;return{x:.5*(y/Math.PI+.5),y:1-.5*(w/Math.PI+1),z:0}}unproject(e,i){let l=e=(2*e-.5)*Math.PI,u=i=(2*(1-i)-1)*Math.PI,f=25;const p=1e-6;let y=0,w=0;do{const E=Math.cos(u),A=Math.sin(u),P=2*A*E,M=A*A,O=E*E,D=Math.cos(l/2),V=Math.sin(l/2),G=2*D*V,q=V*V,te=1-O*D*D,re=te?1/te:0,oe=te?Math.acos(E*D)*Math.sqrt(1/te):0,xe=.5*(2*oe*E*V+2*l/Math.PI)-e,ve=.5*(oe*A+u)-i,Se=.5*re*(O*q+oe*E*D*M)+1/Math.PI,Ce=re*(G*P/4-oe*A*V),Ae=.125*re*(P*V-oe*A*O*G),Qe=.5*re*(M*D+oe*q*E)+.5,Oe=Ce*Ae-Qe*Se;y=(ve*Ce-xe*Qe)/Oe,w=(xe*Ae-ve*Se)/Oe,l=be(l-y,-Math.PI,Math.PI),u=be(u-w,-LI,LI)}while((Math.abs(y)>p||Math.abs(w)>p)&&--f>0);return new U(X(l),X(u))}}class OI extends hu{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Re(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:l,cosPhi:u}=this;return{x:Re(e)*u*l+.5,y:-Math.sin(Re(i))/u*l+.5,z:0}}unproject(e,i){const{scale:l,cosPhi:u}=this,f=-(i-.5)/l,p=be(X((e-.5)/l)/u,-180,180),y=Math.asin(be(f*u,-1,1)),w=be(X(y),-ye,ye);return new U(p,w)}}class cO extends NI{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,l){const u=Ym(e,i,l);return or(u,u,K0(yl(l))),{x:u[0],y:u[1],z:u[2]}}locationPoint(e,i,l){const u=R(i.lat,i.lng),f=Yr([],u),p=l?e._centerAltitude+l:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;Nr(u,u,f,pe(1,0)*vt*p);const y=ae(new Float64Array(16));return le(y,e.pixelMatrix,e.globeMatrix),or(u,u,y),new ft(u[0],u[1])}pixelsPerMeter(e,i){return pe(1,0)*i}pixelSpaceConversion(e,i,l){const u=pe(1,e)*i,f=Yt(pe(1,45)*i,u,l);return this.pixelsPerMeter(e,i)/f}createTileMatrix(e,i,l){const u=Cb(yl(l.canonical));return le(new Float64Array(16),e.globeMatrix,u)}createInversionMatrix(e,i){const{center:l}=e,u=K0(yl(i));return je(u,u,Re(l.lng)),Ee(u,u,Re(l.lat)),J(u,u,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(u)}pointCoordinate(e,i,l,u){return sT(e,i,l,!0)||new He(0,0)}pointCoordinate3D(e,i,l){const u=this.pointCoordinate(e,i,l,0);return[u.x,u.y,u.z]}isPointAboveHorizon(e,i){return!sT(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(u,f){const p=u.cameraToCenterDistance,y=u._centerAltitude*f,w=u._camera,E=u._camera.forward(),A=Ut([],rr([],E,-p),[0,0,y]),P=u.worldSize/(2*Math.PI),M=[0,0,-P],O=u.width/u.height,D=Math.tan(u.fovAboveCenter),V=rr([],w.up(),D),G=rr([],w.right(),D*O),q=Yr([],Ut([],Ut([],E,V),G)),te=[];let re;if(new Wr(A,q).closestPointOnSphere(M,P,te)){const oe=Ut([],te,M),xe=Gr([],oe,A);re=Math.cos(u.fovAboveCenter)*fr(xe)}else{const oe=Gr([],A,M),xe=Gr([],M,A);Yr(xe,xe);const ve=fr(oe)-P;re=Math.sqrt(ve*(ve+2*P));const Se=Math.acos(re/(P+ve))-Math.acos(vi(E,xe));re*=Math.cos(Se)}return 1.01*re}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),l=ou(e.zoom);if(l>0){const u=kI(e,pe(1,e.center.lat)*e.worldSize),f=e.worldSize/(2*Math.PI),p=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Yt(i,u+f*(1-Math.cos(p)),Math.pow(l,10))}return i}upVector(e,i,l){return Ym(i,l,e,1)}upVectorScale(e){return{metersToTile:Z0(Y0(yl(e)))}}}function DI(n){const e=n.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(n.name){case"mercator":return new NI(n);case"equirectangular":return new sO(n);case"naturalEarth":return new aO(n);case"equalEarth":return new nO(n);case"winkelTripel":return new lO(n);case"albers":return i?new OI(n):new iO(n);case"lambertConformalConic":return i?new OI(n):new oO(n);case"globe":return new cO(n)}throw new Error(`Invalid projection name: ${n.name}`)}const uO=lt.types,dO=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Sy(n,e,i,l,u,f,p,y,w,E,A,P,M){const O=y?Math.min(du,Math.round(y[0])):0,D=y?Math.min(du,Math.round(y[1])):0;n.emplaceBack(e,i,Math.round(32*l),Math.round(32*u),f,p,(O<<1)+(w?1:0),D,16*E,16*A,256*P,256*M)}function Ty(n,e,i){n.emplaceBack(e,i)}function Ey(n,e,i,l,u,f,p){n.emplaceBack(e,i,l,u,f,p)}const Iy=(n,e,i,l)=>{for(let u=0;u<e;u++)n.emplaceBack(i[0],i[1],i[2],l[0],l[1],l[2])};function Cy(n,e,i,l,u){n.emplaceBack(e,i,l,u),n.emplaceBack(e,i,l,u),n.emplaceBack(e,i,l,u),n.emplaceBack(e,i,l,u)}function hO(n){for(const e of n.sections)if(pb(e.text))return!0;return!1}class vw{constructor(e){this.layoutVertexArray=new Fm,this.indexArray=new bn,this.programConfigurations=e,this.segments=new Fi,this.dynamicLayoutVertexArray=new jo,this.opacityVertexArray=new eu,this.placedSymbolArray=new wf,this.iconTransitioningVertexArray=new pn,this.globeExtVertexArray=new Bm,this.zOffsetVertexArray=new fl,this.orientationVertexArray=new wd}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,l,u,f){this.isEmpty()||(l&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_L.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,xL.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,dO,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,wL.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,yL.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||f)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,vL.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,bL.members,!0)),this.opacityVertexBuffer.itemSize=1),(l||u)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Pt(vw,"SymbolBuffers");class bw{constructor(e,i,l){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new l,this.segments=new Fi,this.collisionVertexArray=new Vm,this.collisionVertexArrayExt=new jo}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,SL.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,TL.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Pt(bw,"CollisionBuffers");class Ay{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(p=>p.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ae([]),this.placementViewportMatrix=ae([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=dI(this.zoom,i["text-size"],this.worldview),this.iconSizeData=dI(this.zoom,i["icon-size"],this.worldview);const l=this.layers[0].layout,u=l.get("symbol-sort-key"),f=l.get("symbol-z-order");this.lut=e.lut,this.canOverlap=l.get("text-allow-overlap")||l.get("icon-allow-overlap")||l.get("text-ignore-placement")||l.get("icon-ignore-placement"),this.sortFeaturesByKey=f!=="viewport-y"&&u.constantOr(1)!==void 0,this.sortFeaturesByY=(f==="viewport-y"||f==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=l.get("text-writing-mode").map(p=>io[p]),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new vw(new zo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new vw(new zo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new F0,this.lineVertexArray=new B0,this.symbolInstances=new z0}calculateGlyphDependencies(e,i,l,u,f){for(const p of e){const y=p.codePointAt(0);if(y===void 0)break;if(i[y]=!0,u&&f&&y<=65535){const w=mg[p];w&&(i[w.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!iy(this.activeReplacements,l)&&(this.activeReplacements=l,!0)}populate(e,i,l,u){const f=this.layers[0],p=f.layout,y=this.projection.name==="globe",w=p.get("text-font"),E=p.get("text-field"),A=p.get("icon-image"),[P,M]=p.get("icon-size-scale-range"),O=be(i.scaleFactor||1,P,M),D=(E.value.kind!=="constant"||E.value.value instanceof fs&&!E.value.value.isEmpty()||E.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),V=A.value.kind!=="constant"||!!A.value.value||Object.keys(A.parameters).length>0,G=p.get("symbol-sort-key");if(this.features=[],!D&&!V)return;const q=i.iconDependencies,te=i.glyphDependencies,re=i.availableImages,oe=new gi(this.zoom,{worldview:this.worldview});for(const{feature:xe,id:ve,index:Se,sourceLayerIndex:Ce}of e){const Ae=f._featureFilter.needGeometry,Qe=dt(xe,Ae);if(!f._featureFilter.filter(oe,Qe,l))continue;if(Ae||(Qe.geometry=Et(xe,l,u)),y&&xe.type!==1&&l.z<=5){const st=Qe.geometry,ht=.98078528056,Ke=(at,$e)=>vi(Ym(at.x,at.y,l,1),Ym($e.x,$e.y,l,1))<ht;for(let at=0;at<st.length;at++)st[at]=Ye(st[at],Ke)}let Oe,et;if(D){const st=f.getValueAndResolveTokens("text-field",Qe,l,re),ht=fs.factory(st);hO(ht)&&(this.hasRTLText=!0),(!this.hasRTLText||cf()==="unavailable"||this.hasRTLText&&ia.isParsed())&&(Oe=IL(ht,f,Qe))}if(V){const st=f.getValueAndResolveTokens("icon-image",Qe,l,re);et=typeof st=="string"?Is.build(st):st}if(!Oe&&!et)continue;const ct=this.sortFeaturesByKey?G.evaluate(Qe,{},l):void 0,rt={id:ve,text:Oe,icon:et,index:Se,sourceLayerIndex:Ce,geometry:Qe.geometry,properties:xe.properties,type:uO[xe.type],sortKey:ct};if(this.features.push(rt),et){const st=this.layers[0]._unevaluatedLayout._values,{iconPrimary:ht,iconSecondary:Ke}=II(et,this.iconSizeData,st["icon-size"],l,this.zoom,rt,this.pixelRatio,O,this.worldview),at=ht.id.toString();if(q.has(at)?q.get(at).push(ht):q.set(at,[ht]),Ke){this.hasAnySecondaryIcon=!0;const $e=Ke.id.toString();q.has($e)?q.get($e).push(Ke):q.set($e,[Ke])}}if(Oe){const st=w.evaluate(Qe,{},l).join(","),ht=p.get("text-rotation-alignment")==="map"&&p.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(io.vertical)>=0;for(const Ke of Oe.sections)if(Ke.image){const at=Ke.image.getPrimary().scaleSelf(this.pixelRatio),$e=at.id.toString(),Be=q.get($e)||[];Be.push(at),q.set($e,Be)}else{const at=Pm(Oe.toString()),$e=Ke.fontStack||st,Be=te[$e]=te[$e]||{};this.calculateGlyphDependencies(Ke.text,Be,ht,this.allowVerticalPlacement,at)}}}if(p.get("symbol-placement")==="line"&&(this.features=function(xe){const ve={},Se={},Ce=[];let Ae=0;function Qe(rt){Ce.push(xe[rt]),Ae++}function Oe(rt,st,ht){const Ke=Se[rt];return delete Se[rt],Se[st]=Ke,Ce[Ke].geometry[0].pop(),Ce[Ke].geometry[0]=Ce[Ke].geometry[0].concat(ht[0]),Ke}function et(rt,st,ht){const Ke=ve[st];return delete ve[st],ve[rt]=Ke,Ce[Ke].geometry[0].shift(),Ce[Ke].geometry[0]=ht[0].concat(Ce[Ke].geometry[0]),Ke}function ct(rt,st,ht){const Ke=ht?st[0][st[0].length-1]:st[0][0];return`${rt}:${Ke.x}:${Ke.y}`}for(let rt=0;rt<xe.length;rt++){const st=xe[rt],ht=st.geometry,Ke=st.text?st.text.toString():null;if(!Ke){Qe(rt);continue}const at=ct(Ke,ht),$e=ct(Ke,ht,!0);if(at in Se&&$e in ve&&Se[at]!==ve[$e]){const Be=et(at,$e,ht),pt=Oe(at,$e,Ce[Be].geometry);delete ve[at],delete Se[$e],Se[ct(Ke,Ce[pt].geometry,!0)]=pt,Ce[Be].geometry=null}else at in Se?Oe(at,$e,ht):$e in ve?et(at,$e,ht):(Qe(rt),ve[at]=Ae-1,Se[$e]=Ae-1)}return Ce.filter(rt=>rt.geometry)}(this.features)),p.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const xe of i.elevationFeatures)this.elevationFeatureIdToIndex.set(xe.id,this.elevationFeatures.length),this.elevationFeatures.push(xe)}}else p.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((xe,ve)=>xe.sortKey-ve.sortKey)}update(e,i,l,u,f,p,y){this.text.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,f,l,u,p,y,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const l=De(e),u=1/l;let f=!1,p=!1;for(let y=0;y<this.symbolInstances.length;y++){const w=this.symbolInstances.get(y),E=dr(1,0,0),A=dr(0,1,0),{numHorizontalGlyphVertices:P,numVerticalGlyphVertices:M,numIconVertices:O,numVerticalIconVertices:D}=w,V=P>0||M>0,G=O>0,q=this.elevationFeatures[w.elevationFeatureIndex];if(q){const te=new ft(w.tileAnchorX,w.tileAnchorY),re=.075+q.pointElevation(te);w.zOffset!==re&&(i=!0,w.zOffset=re);const oe=q.computeSlopeNormal(te,u),xe=Tc($s(),dr(0,0,1),oe);$r(E,E,xe),$r(A,A,xe),E[2]*=l,A[2]*=l,E[0]===1&&E[1]===0&&E[2]===0&&A[0]===0&&A[1]===1&&A[2]===0||(f=f||V,p=p||G)}if(V&&(Iy(this.text.orientationVertexArray,P,E,A),Iy(this.text.orientationVertexArray,M,E,A)),G){const{placedIconSymbolIndex:te,verticalPlacedIconSymbolIndex:re}=w;te>=0&&Iy(this.icon.orientationVertexArray,O,E,A),re>=0&&Iy(this.icon.orientationVertexArray,D,E,A)}}f||(this.text.orientationVertexArray=void 0),p||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(f,p,y)=>{l+=p,l>f.length&&f.resize(l);for(let w=-p;w<0;w++)f.emplace(w+l,y)},i=(f,p,y)=>{u+=p,u>f.length&&f.resize(u);for(let w=-p;w<0;w++)f.emplace(w+u,y)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let l=0,u=0;for(let f=0;f<this.symbolInstances.length;f++){const p=this.symbolInstances.get(f),{numHorizontalGlyphVertices:y,numVerticalGlyphVertices:w,numIconVertices:E}=p,A=p.zOffset,P=E>0;if((y>0||w>0)&&(e(this.text.zOffsetVertexArray,y,A),e(this.text.zOffsetVertexArray,w,A)),P){const{placedIconSymbolIndex:M,verticalPlacedIconSymbolIndex:O}=p;M>=0&&i(this.icon.zOffsetVertexArray,E,A),O>=0&&i(this.icon.zOffsetVertexArray,p.numVerticalIconVertices,A)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=DI(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const l=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:u,y:f}of i)this.lineVertexArray.emplaceBack(u,f);return{lineStartIndex:l,lineLength:this.lineVertexArray.length-l}}addSymbols(e,i,l,u,f,p,y,w,E,A,P,M,O,D,V,G){const q=e.indexArray,te=e.layoutVertexArray,re=e.globeExtVertexArray,oe=e.segments.prepareSegment(4*i.length,te,q,this.canOverlap?p.sortKey:void 0),xe=this.glyphOffsetArray.length,ve=oe.vertexLength,Se=this.allowVerticalPlacement&&y===io.vertical?Math.PI/2:0,Ce=p.text&&p.text.sections;for(let Qe=0;Qe<i.length;Qe++){const{tl:Oe,tr:et,bl:ct,br:rt,texPrimary:st,texSecondary:ht,pixelOffsetTL:Ke,pixelOffsetBR:at,minFontScaleX:$e,minFontScaleY:Be,glyphOffset:pt,isSDF:ut,sectionIndex:$t}=i[Qe],It=oe.vertexLength,Lt=pt[1];if(Sy(te,E.x,E.y,Oe.x,Lt+Oe.y,st.x,st.y,l,ut,Ke.x,Ke.y,$e,Be),Sy(te,E.x,E.y,et.x,Lt+et.y,st.x+st.w,st.y,l,ut,at.x,Ke.y,$e,Be),Sy(te,E.x,E.y,ct.x,Lt+ct.y,st.x,st.y+st.h,l,ut,Ke.x,at.y,$e,Be),Sy(te,E.x,E.y,rt.x,Lt+rt.y,st.x+st.w,st.y+st.h,l,ut,at.x,at.y,$e,Be),w){const{x:xt,y:Bt,z:sr}=w.anchor,[St,jt,Kt]=w.up;Ey(re,xt,Bt,sr,St,jt,Kt),Ey(re,xt,Bt,sr,St,jt,Kt),Ey(re,xt,Bt,sr,St,jt,Kt),Ey(re,xt,Bt,sr,St,jt,Kt),Cy(e.dynamicLayoutVertexArray,xt,Bt,sr,Se)}else Cy(e.dynamicLayoutVertexArray,E.x,E.y,E.z,Se);if(G){const xt=ht||st;Ty(e.iconTransitioningVertexArray,xt.x,xt.y),Ty(e.iconTransitioningVertexArray,xt.x+xt.w,xt.y),Ty(e.iconTransitioningVertexArray,xt.x,xt.y+xt.h),Ty(e.iconTransitioningVertexArray,xt.x+xt.w,xt.y+xt.h)}q.emplaceBack(It,It+1,It+2),q.emplaceBack(It+1,It+2,It+3),oe.vertexLength+=4,oe.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(pt[0]),Qe!==i.length-1&&$t===i[Qe+1].sectionIndex||e.programConfigurations.populatePaintArrays(te.length,p,p.index,{},O,D,V,Ce&&Ce[$t],this.worldview)}const Ae=w?w.anchor:E;e.placedSymbolArray.emplaceBack(Ae.x,Ae.y,Ae.z,E.x,E.y,xe,this.glyphOffsetArray.length-xe,ve,A,P,E.segment,l?l[0]:0,l?l[1]:0,u[0],u[1],y,0,0,0,M,0)}_commitLayoutVertex(e,i,l,u,f,p,y){e.emplaceBack(i,l,u,f,p,Math.round(y.x),Math.round(y.y))}_addCollisionDebugVertices(e,i,l,u,f,p,y){const w=l.segments.prepareSegment(4,l.layoutVertexArray,l.indexArray),E=w.vertexLength,A=y.tileAnchorX,P=y.tileAnchorY;for(let O=0;O<4;O++)l.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(l.collisionVertexArrayExt,i,e.padding,y.zOffset),this._commitLayoutVertex(l.layoutVertexArray,u,f,p,A,P,new ft(e.x1,e.y1)),this._commitLayoutVertex(l.layoutVertexArray,u,f,p,A,P,new ft(e.x2,e.y1)),this._commitLayoutVertex(l.layoutVertexArray,u,f,p,A,P,new ft(e.x2,e.y2)),this._commitLayoutVertex(l.layoutVertexArray,u,f,p,A,P,new ft(e.x1,e.y2)),w.vertexLength+=4;const M=l.indexArray;M.emplaceBack(E,E+1),M.emplaceBack(E+1,E+2),M.emplaceBack(E+2,E+3),M.emplaceBack(E+3,E),w.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,l,u,f,p){for(let y=u;y<f;y++){const w=l.get(y),E=this.getSymbolInstanceTextSize(e,p,i,y);this._addCollisionDebugVertices(w,E,this.textCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,p)}}_addIconDebugCollisionBoxes(e,i,l,u,f,p){for(let y=u;y<f;y++){const w=l.get(y),E=this.getSymbolInstanceIconSize(e,i,p.placedIconSymbolIndex);this._addCollisionDebugVertices(w,E,this.iconCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,p)}}generateCollisionDebugBuffers(e,i,l){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new bw(_f,YE.members,pn),this.iconCollisionBox=new bw(_f,YE.members,pn);const u=_g(this.iconSizeData,e),f=_g(this.textSizeData,e,l);for(let p=0;p<this.symbolInstances.length;p++){const y=this.symbolInstances.get(p);this._addTextDebugCollisionBoxes(f,e,i,y.textBoxStartIndex,y.textBoxEndIndex,y),this._addTextDebugCollisionBoxes(f,e,i,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._addIconDebugCollisionBoxes(u,e,i,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._addIconDebugCollisionBoxes(u,e,i,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}}getSymbolInstanceTextSize(e,i,l,u){const f=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:u),p=fw(this.textSizeData,e,f)/Fn;return this.tilePixelRatio*p}getSymbolInstanceIconSize(e,i,l){const u=this.icon.placedSymbolArray.get(l),f=fw(this.iconSizeData,e,u);return this.tilePixelRatio*f}_commitDebugCollisionVertexUpdate(e,i,l,u){e.emplaceBack(i,-l,-l,u),e.emplaceBack(i,l,-l,u),e.emplaceBack(i,l,l,u),e.emplaceBack(i,-l,l,u)}_updateTextDebugCollisionBoxes(e,i,l,u,f,p,y){for(let w=u;w<f;w++){const E=l.get(w),A=this.getSymbolInstanceTextSize(e,p,i,w);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,A,E.padding,p.zOffset)}}_updateIconDebugCollisionBoxes(e,i,l,u,f,p,y){for(let w=u;w<f;w++){const E=l.get(w),A=this.getSymbolInstanceIconSize(e,i,p.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,A,E.padding,p.zOffset)}}updateCollisionDebugBuffers(e,i,l,u){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const f=_g(this.iconSizeData,e,u),p=_g(this.textSizeData,e,l);for(let y=0;y<this.symbolInstances.length;y++){const w=this.symbolInstances.get(y);this._updateTextDebugCollisionBoxes(p,e,i,w.textBoxStartIndex,w.textBoxEndIndex,w,l),this._updateTextDebugCollisionBoxes(p,e,i,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w,l),this._updateIconDebugCollisionBoxes(f,e,i,w.iconBoxStartIndex,w.iconBoxEndIndex,w,u),this._updateIconDebugCollisionBoxes(f,e,i,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w,u)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,l,u,f,p,y,w,E){const A={};if(i<l){const{x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe,featureIndex:xe}=e.get(i);A.textBox={x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe},A.textFeatureIndex=xe}if(u<f){const{x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe,featureIndex:xe}=e.get(u);A.verticalTextBox={x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe},A.verticalTextFeatureIndex=xe}if(p<y){const{x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe,featureIndex:xe}=e.get(p);A.iconBox={x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe},A.iconFeatureIndex=xe}if(w<E){const{x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe,featureIndex:xe}=e.get(w);A.verticalIconBox={x1:P,y1:M,x2:O,y2:D,padding:V,projectedAnchorX:G,projectedAnchorY:q,projectedAnchorZ:te,tileAnchorX:re,tileAnchorY:oe},A.verticalIconFeatureIndex=xe}return A}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const l=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,l.textBoxStartIndex,l.textBoxEndIndex,l.verticalTextBoxStartIndex,l.verticalTextBoxEndIndex,l.iconBoxStartIndex,l.iconBoxEndIndex,l.verticalIconBoxStartIndex,l.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const l=e.placedSymbolArray.get(i),u=l.vertexStartIndex+4*l.numGlyphs;for(let f=l.vertexStartIndex;f<u;f+=4)e.indexArray.emplaceBack(f,f+1,f+2),e.indexArray.emplaceBack(f+1,f+2,f+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),l=Math.cos(e),u=[],f=[],p=[];for(let y=0;y<this.symbolInstances.length;++y){p.push(y);const w=this.symbolInstances.get(y);u.push(0|Math.round(i*w.tileAnchorX+l*w.tileAnchorY)),f.push(w.featureIndex)}return p.sort((y,w)=>u[y]-u[w]||f[w]-f[y]),p}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const l=this.sortKeyRanges[this.sortKeyRanges.length-1];l&&l.sortKey===i?l.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const l=this.symbolInstances.get(i);this.featureSortOrder.push(l.featureIndex);const{rightJustifiedTextSymbolIndex:u,centerJustifiedTextSymbolIndex:f,leftJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:y,placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:E}=l;u>=0&&this.addIndicesForPlacedSymbol(this.text,u),f>=0&&f!==u&&this.addIndicesForPlacedSymbol(this.text,f),p>=0&&p!==f&&p!==u&&this.addIndicesForPlacedSymbol(this.text,p),y>=0&&this.addIndicesForPlacedSymbol(this.text,y),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w),E>=0&&this.addIndicesForPlacedSymbol(this.icon,E)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let jI,zI,ww;Pt(Ay,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Ay.addDynamicAttributes=Cy;class FI{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:ea,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Pt(FI,"FormatSectionOverride",{omit:["defaultValue"]});const Sw=()=>ww||(ww={layout:jI||(jI=new $i({"symbol-placement":new mt(Le.layout_symbol["symbol-placement"]),"symbol-spacing":new mt(Le.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new mt(Le.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Tt(Le.layout_symbol["symbol-sort-key"]),"symbol-z-order":new mt(Le.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new mt(Le.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new mt(Le.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new mt(Le.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new mt(Le.layout_symbol["icon-ignore-placement"]),"icon-optional":new mt(Le.layout_symbol["icon-optional"]),"icon-rotation-alignment":new mt(Le.layout_symbol["icon-rotation-alignment"]),"icon-size":new Tt(Le.layout_symbol["icon-size"]),"icon-size-scale-range":new mt(Le.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Tt(Le.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Tt(Le.layout_symbol["icon-text-fit-padding"]),"icon-image":new Tt(Le.layout_symbol["icon-image"]),"icon-image-use-theme":new mt({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new Tt(Le.layout_symbol["icon-rotate"]),"icon-padding":new mt(Le.layout_symbol["icon-padding"]),"icon-keep-upright":new mt(Le.layout_symbol["icon-keep-upright"]),"icon-offset":new Tt(Le.layout_symbol["icon-offset"]),"icon-anchor":new Tt(Le.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new mt(Le.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new mt(Le.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new mt(Le.layout_symbol["text-rotation-alignment"]),"text-field":new Tt(Le.layout_symbol["text-field"]),"text-font":new Tt(Le.layout_symbol["text-font"]),"text-size":new Tt(Le.layout_symbol["text-size"]),"text-size-scale-range":new mt(Le.layout_symbol["text-size-scale-range"]),"text-max-width":new Tt(Le.layout_symbol["text-max-width"]),"text-line-height":new Tt(Le.layout_symbol["text-line-height"]),"text-letter-spacing":new Tt(Le.layout_symbol["text-letter-spacing"]),"text-justify":new Tt(Le.layout_symbol["text-justify"]),"text-radial-offset":new Tt(Le.layout_symbol["text-radial-offset"]),"text-variable-anchor":new mt(Le.layout_symbol["text-variable-anchor"]),"text-anchor":new Tt(Le.layout_symbol["text-anchor"]),"text-max-angle":new mt(Le.layout_symbol["text-max-angle"]),"text-writing-mode":new mt(Le.layout_symbol["text-writing-mode"]),"text-rotate":new Tt(Le.layout_symbol["text-rotate"]),"text-padding":new mt(Le.layout_symbol["text-padding"]),"text-keep-upright":new mt(Le.layout_symbol["text-keep-upright"]),"text-transform":new Tt(Le.layout_symbol["text-transform"]),"text-offset":new Tt(Le.layout_symbol["text-offset"]),"text-allow-overlap":new mt(Le.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new mt(Le.layout_symbol["text-ignore-placement"]),"text-optional":new mt(Le.layout_symbol["text-optional"]),visibility:new mt(Le.layout_symbol.visibility)})),paint:zI||(zI=new $i({"icon-opacity":new Tt(Le.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Tt(Le.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Tt(Le.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Tt(Le.paint_symbol["text-emissive-strength"]),"icon-color":new Tt(Le.paint_symbol["icon-color"]),"icon-halo-color":new Tt(Le.paint_symbol["icon-halo-color"]),"icon-halo-width":new Tt(Le.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Tt(Le.paint_symbol["icon-halo-blur"]),"icon-translate":new mt(Le.paint_symbol["icon-translate"]),"icon-translate-anchor":new mt(Le.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new mt(Le.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Tt(Le.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Tt(Le.paint_symbol["text-occlusion-opacity"]),"text-color":new Tt(Le.paint_symbol["text-color"],{runtimeType:Ns,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new Tt(Le.paint_symbol["text-halo-color"]),"text-halo-width":new Tt(Le.paint_symbol["text-halo-width"]),"text-halo-blur":new Tt(Le.paint_symbol["text-halo-blur"]),"text-translate":new mt(Le.paint_symbol["text-translate"]),"text-translate-anchor":new mt(Le.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new mt(Le.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new mt(Le.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new mt(Le.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new mt(Le.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Tt(Le.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},ww);class Py extends ss{constructor(e,i,l,u){super(e,Sw(),i,l,u,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=ae([]),this.hasOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){e!=="icon-occlusion-opacity"&&e!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const l=this.layout.get("text-writing-mode");if(l){const u=[];for(const f of l)u.indexOf(f)<0&&u.push(f);this.layout._values["text-writing-mode"]=u}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,l,u){return this._saturation===e&&this._contrast===i&&this._brightnessMin===l&&this._brightnessMax===u||(this._colorAdjustmentMatrix=function(f,p,y,w){f=qs(f),p=ds(p);const E=ie(),A=f/3,P=1-2*A,M=[P,A,A,0,A,P,A,0,A,A,P,0,0,0,0,1],O=.5-.5*p,D=w-y;return le(E,[D,0,0,0,0,D,0,0,0,0,D,0,y,y,y,1],[p,0,0,0,0,p,0,0,0,0,p,0,O,O,O,1]),le(E,E,M),E}(e,i,l,u),this._saturation=e,this._contrast=i,this._brightnessMin=l,this._brightnessMax=u),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,l,u){const f=this.layout.get(e).evaluate(i,{},l,u),p=this._unevaluatedLayout._values[e];return p.isDataDriven()||Im(p.value)||!f?f:function(y,w){return w.replace(/{([^{}]+)}/g,(E,A)=>A in y?String(y[A]):"")}(i.properties,f)}createBucket(e){return new Ay(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Sw().paint.overridableProperties){if(!Py.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),l=new FI(i),u=new tf(l,i.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let f=null;f=i.value.kind==="constant"||i.value.kind==="source"?new _d("source",u):new al("composite",u,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new Ql(i.property,f,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,l){return!(!this.layout||i.isDataDriven()||l.isDataDriven())&&Py.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const l=e.get("text-field"),u=Sw().paint.properties[i];let f=!1;const p=y=>{for(const w of y)if(u.overrides&&u.overrides.hasOverride(w))return void(f=!0)};if(l.value.kind==="constant"&&l.value.value instanceof fs)p(l.value.value.sections);else if(l.value.kind==="source"){const y=E=>{f||(E instanceof vr&&Cn(E.value)===Qa?p(E.value.sections):E instanceof Bl?p(E.sections):E.eachChild(y))},w=l.value;w._styleExpression&&y(w._styleExpression.expression)}return f}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,l){return{config:new oc(this,{zoom:i,lut:l}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let BI,UI,VI,$I;var Tw=Dr([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function ky(n,e,i,l,u,f,p,y){const w=[n,e,1,i,l,1,u,f,1],E=[p,y,1],A=W([],w),[P,M,O]=pr(E,E,A);return ee(w,w,[P,0,0,0,M,0,0,0,O])}function GI(n,e,i,l,u,f,p,y){const w=function(E,A,P,M,O,D,V,G){const q=ky(0,0,1,0,1,1,0,1),te=ky(E,A,P,M,O,D,V,G);return ee(te,te,W([],q))}(n,e,i,l,u,f,p,y);return[w[2]/w[8]/vt,w[5]/w[8]/vt]}function My(n){return[n[0],Math.min(Math.max(n[1],-ye),ye)]}class qI extends zl{constructor(e,i,l,u){super(),this.id=e,this.dispatcher=l,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(u),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new No("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Mc(this.map._requestManager.transformRequest(this.url,gh.Image),(l,u)=>{this._imageRequest=null,this._loaded=!0,l?this.fire(new td(l)):u&&(this.image=u instanceof HTMLImageElement?Qo.getImageData(u):u,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new hg(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new No("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof hg||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],l=e[0][1];for(const f of e)f[1]>l&&(l=f[1]),f[1]<i&&(i=f[1]);const u=(l+i)/2;if(u>ye?this.onNorthPole=!0:u<-ye&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const f=e.map(He.fromLngLat);this.tileID=function(p){let y=1/0,w=1/0,E=-1/0,A=-1/0;for(const V of p)y=Math.min(y,V.x),w=Math.min(w,V.y),E=Math.max(E,V.x),A=Math.max(A,V.y);const P=Math.max(E-y,A-w),M=Math.max(0,Math.floor(-Math.log2(P))),O=Math.pow(2,M);let D=Math.floor((y+E)/2*O);return D>1&&(D-=1),new ka(M,D,Math.floor((w+A)/2*O))}(f),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new No("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof hg||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const q in this.tiles){const te=this.tiles[q];te.state!=="loaded"&&(te.state="loaded",te.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=bg(new ka(0,0,0),this.map.transform.projection),l=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(q){const te=q[1].x-q[0].x,re=q[1].y-q[0].y,oe=q[2].x-q[1].x,xe=q[2].y-q[1].y,ve=q[3].x-q[2].x,Se=q[3].y-q[2].y,Ce=q[0].x-q[3].x,Ae=q[0].y-q[3].y,Qe=te*xe-oe*re,Oe=oe*Se-ve*xe,et=ve*Ae-Ce*Se,ct=Ce*re-te*Ae;return Qe>0&&Oe>0&&et>0&&ct>0||Qe<0&&Oe<0&&et<0&&ct<0}(l))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const u=bg(this.tileID,this.map.transform.projection),[f,p,y,w]=this.coordinates.map(q=>{const te=u.projection.project(q[0],q[1]);return MI(u,te)._round()});this.perspectiveTransform=GI(f.x,f.y,p.x,p.y,y.x,y.y,w.x,w.y);const E=this._boundsArray=new ic;E.emplaceBack(f.x,f.y,0,0),E.emplaceBack(p.x,p.y,vt,0),E.emplaceBack(w.x,w.y,0,vt),E.emplaceBack(y.x,y.y,vt,vt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(E,Tw.members),this.boundsSegments=Fi.simpleSegment(0,0,4,2);const A=[],P=[My((M=this.coordinates)[0]),My(M[1]),My(M[2]),My(M[3])];var M;const[O,D,V,G]=function(q){let te=q[0][0],re=te,oe=q[0][1],xe=oe;for(let ve=1;ve<q.length;ve++)q[ve][0]<te?te=q[ve][0]:q[ve][0]>re&&(re=q[ve][0]),q[ve][1]<oe?oe=q[ve][1]:q[ve][1]>xe&&(xe=q[ve][1]);return[te,oe,re-te,xe-oe]}(P);{const q=new ic,[te,re,oe,xe]=function(Ke){let at=Ke[0].x,$e=at,Be=Ke[0].y,pt=Be;for(let ut=1;ut<Ke.length;ut++)Ke[ut].x<at?at=Ke[ut].x:Ke[ut].x>$e&&($e=Ke[ut].x),Ke[ut].y<Be?Be=Ke[ut].y:Ke[ut].y>pt&&(pt=Ke[ut].y);return[at,Be,$e-at,pt-Be]}(l),ve=Ke=>[(Ke.x-te)/oe,(Ke.y-re)/xe],[Se,Ce,Ae,Qe]=l.map(ve),Oe=function(Ke,at,$e,Be,pt,ut,$t,It){const Lt=ky(0,0,1,0,1,1,0,1);return ee(Lt,Lt,W([],ky(Ke,at,$e,Be,pt,ut,$t,It)))}(Se[0],Se[1],Ce[0],Ce[1],Ae[0],Ae[1],Qe[0],Qe[1]);this.elevatedGlobePerspectiveTransform=GI(Se[0],Se[1],Ce[0],Ce[1],Ae[0],Ae[1],Qe[0],Qe[1]);const et=(Ke,at)=>{A.push(Ke.lng);const $e=Math.round((Ke.lng-O)/V*vt),Be=Math.round((Ke.lat-D)/G*vt),pt=ve(at),ut=pr([],[pt[0],pt[1],1],Oe),$t=Math.round(ut[0]/ut[2]*vt),It=Math.round(ut[1]/ut[2]*vt);q.emplaceBack($e,Be,$t,It)},ct=l[3].x-l[0].x,rt=l[3].y-l[0].y,st=l[2].x-l[1].x,ht=l[2].y-l[1].y;for(let Ke=0;Ke<65;Ke++){const at=Ke/64,$e=[l[0].x+at*ct,l[0].y+at*rt],Be=[l[1].x+at*st,l[1].y+at*ht],pt=Be[0]-$e[0],ut=Be[1]-$e[1];for(let $t=0;$t<65;$t++){const It=$t/64,Lt={x:$e[0]+pt*It,y:$e[1]+ut*It};et(i.projection.unproject(Lt.x,Lt.y),Lt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(q,Tw.members)}{this.maxLongitudeTriangleSize=0;let q=[],te=new bn;const re=(oe,xe,ve)=>{te.emplaceBack(oe,xe,ve);const Se=A[oe],Ce=A[xe],Ae=A[ve],Qe=Math.min(Math.min(Se,Ce),Ae),Oe=Math.max(Math.max(Se,Ce),Ae)-Qe;Oe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Oe),q.push(Qe+Oe/2)};for(let oe=0;oe<64;oe++)for(let xe=0;xe<64;xe++){const ve=65*oe+xe,Se=ve+1,Ce=ve+65,Ae=Ce+1;re(ve,Ce,Se),re(Se,Ce,Ae)}[q,te]=function(oe,xe){const ve=Array.from({length:oe.length},(Ae,Qe)=>Qe);ve.sort((Ae,Qe)=>oe[Ae]-oe[Qe]);const Se=[],Ce=new bn;for(let Ae=0;Ae<ve.length;Ae++){const Qe=ve[Ae];Se.push(oe[Qe]);const Oe=3*Qe,et=Oe+1;Ce.emplaceBack(xe.uint16[Oe],xe.uint16[et],xe.uint16[et+1])}return[Se,Ce]}(q,te),this.elevatedGlobeTrianglesCenterLongitudes=q,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(te)}this.elevatedGlobeSegments=Fi.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,V/vt,0,G/vt,0,0,D,O,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,l=i.gl;!this._dirty||this.texture instanceof hg||(this.texture?this.texture.update(this.image):(this.texture=new Jb(i,this.image,l.RGBA8),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const l=this.elevatedGlobeTrianglesCenterLongitudes;let u=(f=e+180)+360*Math.round((l[0]-f)/360);var f;const p=new Fi,y=(P,M)=>{p.segments.push({vertexOffset:0,primitiveOffset:P,vertexLength:i.segments[0].vertexLength,primitiveLength:M,sortKey:void 0,vaos:{}})},w=.51*this.maxLongitudeTriangleSize;if(Math.abs(l[0]-u)<=w){const P=Gn(l,0,l.length,u+w);return P===l.length||y(P,Ti(l,P+1,l.length,u+360-w)-P),p}u<l[0]&&(u+=360);const E=Ti(l,0,l.length,u-w);if(E===l.length)return y(0,l.length),p;y(0,E-0);const A=Gn(l,E+1,l.length,u+w);return A!==l.length&&y(A,l.length-A),p}}const fO=(Math.pow(256,2)-1)/16907520;class HI extends ss{constructor(e,i,l,u){super(e,{layout:VI||(VI=new $i({visibility:new mt(Le.layout_raster.visibility)})),paint:$I||($I=new $i({"raster-opacity":new mt(Le.paint_raster["raster-opacity"]),"raster-color":new Xc(Le.paint_raster["raster-color"]),"raster-color-mix":new mt(Le.paint_raster["raster-color-mix"]),"raster-color-range":new mt(Le.paint_raster["raster-color-range"]),"raster-hue-rotate":new mt(Le.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new mt(Le.paint_raster["raster-brightness-min"]),"raster-brightness-max":new mt(Le.paint_raster["raster-brightness-max"]),"raster-saturation":new mt(Le.paint_raster["raster-saturation"]),"raster-contrast":new mt(Le.paint_raster["raster-contrast"]),"raster-resampling":new mt(Le.paint_raster["raster-resampling"]),"raster-fade-duration":new mt(Le.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new mt(Le.paint_raster["raster-emissive-strength"]),"raster-array-band":new mt(Le.paint_raster["raster-array-band"]),"raster-elevation":new mt(Le.paint_raster["raster-elevation"]),"raster-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},i,l,u),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof qI&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[l,u]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(l)&&isNaN(u)||l===this._curRampRange[0]&&u===this._curRampRange[1]||(this.colorRamp=Km({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:l,end:u}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[l,u])}}let WI,ZI,XI,YI,KI;class JI extends ss{constructor(e,i,l,u){super(e,{layout:WI||(WI=new $i({visibility:new mt(Le["layout_raster-particle"].visibility)})),paint:ZI||(ZI=new $i({"raster-particle-array-band":new mt(Le["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new mt(Le["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Xc(Le["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new mt(Le["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new mt(Le["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new mt(Le["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new mt(Le["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new mt(Le["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},i,l,u),this._updateColorRamp(),this.lastInvalidatedAt=Qo.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Km({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Qo.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class pO extends ss{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function Ew(n,e,i){const l=[0,0,1],u=Ts([]);return Rl(u,u,i?-Re(n)+Math.PI:Re(n)),Co(u,u,-Re(e)),$r(l,l,u),Yr(l,l)}const QI={None:0,Model:1,Symbol:2,FillExtrusion:4};class Ny{constructor(e,i,l,u){this.message=(e?`${e}: `:"")+l,u&&(this.identifier=u),i!=null&&i.__line__&&(this.line=i.__line__)}}function Iw(n,e){const i=n.indexOf("://")===-1;try{return new URL(n,i&&e?"http://example.com":void 0),!0}catch{return!1}}class eC{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class tC{constructor(){this.instancedDataArray=new qm,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Cw{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,i){}populate(e,i,l,u){this.tileToMeter=De(l);const f=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:p,id:y,index:w,sourceLayerIndex:E}of e){const A=y??(p.properties&&p.properties.hasOwnProperty("id")?p.properties.id:void 0),P=dt(p,f);if(!this.layers[0]._featureFilter.filter(new gi(this.zoom,{worldview:this.worldview}),P,l))continue;const M={id:A,sourceLayerIndex:E,index:w,geometry:f?P.geometry:Et(p,l,u),properties:p.properties,type:p.type,patterns:{}},O=this.addFeature(M,M.geometry,P);O&&i.featureIndex.insert(p,M.geometry,w,E,this.index,this.instancesPerModel[O].instancedDataArray.length,vt/32)}this.lookup=null}update(e,i,l,u){for(const f in this.instancesPerModel){const p=this.instancesPerModel[f];for(const y in e)p.idToFeaturesIndex.hasOwnProperty(y)&&(this.evaluate(p.features[p.idToFeaturesIndex[y]],e[y],p,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const l=this.instancesPerModel[i];for(const u of l.features){const f=this.layers[0],p=u.feature,y=this.canonical,w=f.paint.get("model-rotation").evaluate(p,{},y),E=f.paint.get("model-scale").evaluate(p,{},y),A=f.paint.get("model-translation").evaluate(p,{},y);oi(u.rotation,w)&&oi(u.scale,E)&&oi(u.translation,A)||(this.evaluate(u,u.featureStates,l,!0),e=!0)}}return e}updateReplacement(e,i,l,u){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const f=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(iy(this.activeReplacements,f))return!1;this.activeReplacements=f;let p=!1;for(const y in this.instancesPerModel){const w=this.instancesPerModel[y],E=w.instancedDataArray;for(const A of w.features){const P=A.instancedDataOffset,M=A.instancedDataCount;for(let O=0;O<M;O++){const D=16*(O+P);let V=E.float32[D+0];const G=V>vt;V=G?V-vt:V;const q=Math.floor(V),te=E.float32[D+1];let re=!1;for(const oe of this.activeReplacements)if(!UT(oe,l,QI.Model,u)&&!(oe.min.x>q||q>oe.max.x||oe.min.y>te||te>oe.max.y)&&(re=Bb(qT(q,te,e.canonical,oe.footprintTileId.canonical),oe.footprint),re))break;E.float32[D]=re?V+vt:V,p=p||re!==G}}}return p}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const l=this.instancesPerModel[i];l.instancedDataArray.length<0||l.instancedDataArray.length===0||(l.instancedDataBuffer?l.instancedDataBuffer.updateData(l.instancedDataArray):l.instancedDataBuffer=e.createVertexBuffer(l.instancedDataArray,$3.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const l=this.instancesPerModel[i];l.instancedDataArray.length!==0&&l.instancedDataBuffer&&l.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,l){const u=this.layers[0],f=u.layout.get("model-id").evaluate(l,{},this.canonical);if(!f)return Lr(`modelId is not evaluated for layer ${u.id} and it is not going to get rendered.`),f;(Iw(f,!1)||this.styleDefinedModelURLs[f]!==void 0)&&(this.modelUris.includes(f)||this.modelUris.push(f)),this.instancesPerModel[f]||(this.instancesPerModel[f]=new tC);const p=this.instancesPerModel[f],y=p.instancedDataArray,w=new eC(l,y.length);for(const E of i)for(const A of E){if(A.x<0||A.x>=vt||A.y<0||A.y>=vt)continue;if(this.lookupDim!==0){const M=(this.lookupDim-1)/vt,O=this.lookupDim*(A.y*M|0)+A.x*M|0;if(this.lookup){if(this.lookup[O]!==0)continue;this.lookup[O]=1}}this.instanceCount++;const P=y.length;y.resize(P+1),p.instancesEvaluatedElevation.push(0),y.float32[16*P]=A.x,y.float32[16*P+1]=A.y}return w.instancedDataCount=p.instancedDataArray.length-w.instancedDataOffset,w.instancedDataCount>0&&(e.id&&(p.idToFeaturesIndex[e.id]=p.features.length),p.features.push(w),this.evaluate(w,{},p,!1)),f}getModelUris(){return this.modelUris}evaluate(e,i,l,u){const f=this.layers[0],p=e.feature,y=this.canonical,w=e.rotation=f.paint.get("model-rotation").evaluate(p,i,y),E=e.scale=f.paint.get("model-scale").evaluate(p,i,y),A=e.translation=f.paint.get("model-translation").evaluate(p,i,y),P=f.paint.get("model-color").evaluate(p,i,y);P.a=f.paint.get("model-color-mix-intensity").evaluate(p,i,y);const M=[];this.maxVerticalOffset<A[2]&&(this.maxVerticalOffset=A[2]),this.maxScale=Math.max(Math.max(this.maxScale,E[0]),Math.max(E[1],E[2])),IE(M,w,E);const O=Math.round(100*P.a)+P.b/1.05;for(let D=0;D<e.instancedDataCount;++D){const V=e.instancedDataOffset+D,G=16*V,q=l.instancedDataArray.float32;let te=0;u&&(te=q[G+6]-l.instancesEvaluatedElevation[V]);const re=0|q[G+1];q[G]=(0|q[G])+P.r/1.05,q[G+1]=re+P.g/1.05,q[G+2]=O,q[G+3]=1/(y.z>10?this.tileToMeter:De(y,re)),q[G+4]=A[0],q[G+5]=A[1],q[G+6]=A[2]+te,q[G+7]=M[0],q[G+8]=M[1],q[G+9]=M[2],q[G+10]=M[4],q[G+11]=M[5],q[G+12]=M[6],q[G+13]=M[8],q[G+14]=M[9],q[G+15]=M[10],l.instancesEvaluatedElevation[V]=A[2]}}}let rC,iC;Pt(Cw,"ModelBucket",{omit:["layers"]}),Pt(tC,"PerModelAttributes"),Pt(eC,"ModelFeature");class Ff{constructor(e,i,l){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=l}static create(e,i,l){const u=l||e.findDEMTileFor(i);if(!u||!u.dem)return;const f=u.dem,p=u.tileID,y=1<<i.canonical.z-p.canonical.z;return new Ff(u,f.dim/vt/y,[(i.canonical.x/y-p.canonical.x)*f.dim,(i.canonical.y/y-p.canonical.y)*f.dim])}tileCoordToPixel(e,i){const l=i*this._scale+this._offset[1];return new ft(Math.floor(e*this._scale+this._offset[0]),Math.floor(l))}getElevationAt(e,i,l,u){const f=e*this._scale+this._offset[0],p=i*this._scale+this._offset[1],y=Math.floor(f),w=Math.floor(p),E=this._dem;return u=!!u,l?Yt(Yt(E.get(y,w,u),E.get(y,w+1,u),p-w),Yt(E.get(y+1,w,u),E.get(y+1,w+1,u),p-w),f-y):E.get(y,w,u)}getElevationAtPixel(e,i,l){return this._dem.get(e,i,!!l)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*pe(1,e)*this._dem.stride}}const Aw=new Float32Array(262144),zd=new Uint8Array(262144);function nC(n){let e=0;if(n.meshes)for(const i of n.meshes)e=Math.max(e,i.aabb.max[2]);if(n.children)for(const i of n.children)e=Math.max(e,nC(i));return e}function sC(n,e,i){if(n.meshes)for(const l of n.meshes){if(l.aabb.min[0]===1/0)continue;const u=Qt.applyTransform(l.aabb,n.matrix);i.insert(e,u.min[0],u.min[1],u.max[0],u.max[1])}if(n.children)for(const l of n.children)sC(l,e,i)}const oC=["","wall","door","roof","window","lamp","logo"];class aC{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:nC(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Qt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Qt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const l of this.node.meshes)this.node.lightMeshIndex!==e&&(l.transformedAabb=Qt.applyTransformFast(l.aabb,this.node.matrix),i.encapsulate(l.transformedAabb)),e++;this.aabb=i}return this.aabb}}class Ry{constructor(e,i,l,u,f,p,y,w){this.id=l,this.layers=e,this.layerIds=this.layers.map(E=>E.fqid),this.stateDependentLayerIds=this.layers.filter(E=>E.isStateDependent()).map(E=>E.id),this.modelTraits|=Rf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,u&&(this.modelTraits|=Rf.HasMapboxMeshFeatures),f&&(this.modelTraits|=Rf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=p,this.worldview=w,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const E of i)this.nodesInfo.push(new aC(E)),sC(E,y.featureIndexArray.length,y.grid),y.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,y.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const l of this.getNodesInfo()){const u=l.node;u.footprint&&i.push({footprint:u.footprint,id:e})}}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const l=i?this.stateDependentLayers:this.layers;if(!va(e,this.states))for(const u of l)this.evaluate(u,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const l of i){const u=l.node;this.uploaded?this.updatePbrBuffer(u):tw(u,e,!0)}for(const l of i)fy(l.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const l of e.meshes)l.pbrBuffer&&(l.pbrBuffer.updateData(l.featureArray),i=!0);return i}needsReEvaluation(e,i,l){const u=e.transform.projectionOptions,f=e.style.getBrightness(),p=this.brightness!==f;if(!this.uploaded||this.dirty||u.name!==this.projection.name||Ig(l.paint.get("model-color").value,p)||Ig(l.paint.get("model-color-mix-intensity").value,p)||Ig(l.paint.get("model-roughness").value,p)||Ig(l.paint.get("model-emissive-strength").value,p)||Ig(l.paint.get("model-height-based-emissive-strength-multiplier").value,p)){this.projection=u,this.brightness=f;const y=this.getNodesInfo();for(const w of y)w.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const l=this.getNodesInfo(),u=this.id.canonical;for(const f of l){const p=f.feature;f.evaluatedTranslation=i.paint.get("model-translation").evaluate(p,{},u),f.evaluatedScale=i.paint.get("model-scale").evaluate(p,{},u)}}evaluate(e,i){const l=this.getNodesInfo();for(const u of l){if(!u.node.meshes)continue;const f=u.feature,p=i&&i[f.id];if(va(p,u.state))continue;u.state=structuredClone(p);const y=u.node.meshes&&u.node.meshes[0].featureData,w=u.evaluatedColor[2],E=u.evaluatedRMEA[2],A=this.id.canonical;if(u.hasTranslucentParts=!1,y){for(let P=0;P<oC.length;P++){const M=oC[P];M.length&&(f.properties.part=M);const O=e.paint.get("model-color").evaluate(f,p,A).toPremultipliedRenderColor(null),D=e.paint.get("model-color-mix-intensity").evaluate(f,p,A);u.evaluatedColor[P]=[O.r,O.g,O.b,D],u.evaluatedRMEA[P][0]=e.paint.get("model-roughness").evaluate(f,p,A),u.evaluatedRMEA[P][2]=e.paint.get("model-emissive-strength").evaluate(f,p,A),u.evaluatedRMEA[P][3]=O.a,u.emissionHeightBasedParams[P]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(f,p,A),!u.hasTranslucentParts&&O.a<1&&(u.hasTranslucentParts=!0)}delete f.properties.part,gO(u,w!==u.evaluatedColor[2]||E!==u.evaluatedRMEA[2],this.modelTraits)}else u.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(f,p,A);u.evaluatedTranslation=e.paint.get("model-translation").evaluate(f,p,A),u.evaluatedScale=e.paint.get("model-scale").evaluate(f,p,A),this.updatePbrBuffer(u.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,l,u){const f=e.findDEMTileFor(l);if(f&&(f.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(f.dem&&f.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=f.tileID.overscaledZ;const p=Ff.create(e,l,f);if(!p)return;this.modelTraits&Rf.HasMapboxMeshFeatures&&this.updateDEM(e,p,l,u);for(const y of this.getNodesInfo()){const w=y.node;if(!w.footprint||!w.footprint.vertices||!w.footprint.vertices.length)continue;const E=w.footprint.vertices;let A=p.getElevationAt(E[0].x,E[0].y,!0,!0);for(let P=1;P<E.length;P++)A=Math.min(A,p.getElevationAt(E[P].x,E[P].y,!0,!0));w.elevation=A}}this.terrainTile=f.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,l,u){let f=i._dem._modifiedForSources[u];if(f===void 0&&(i._dem._modifiedForSources[u]=[],f=i._dem._modifiedForSources[u]),f.includes(l.canonical))return;const p=i._dem.dim;f.push(l.canonical);let y=!1;for(const w of this.getNodesInfo()){const E=w.node;if(!E.footprint||!E.footprint.grid)continue;const A=E.footprint.grid,P=i.tileCoordToPixel(A.min.x,A.min.y),M=i.tileCoordToPixel(A.max.x,A.max.y),O=Math.min(Math.min(p-M.y,P.x),Math.min(P.y,p-M.x));if(O<0)continue;const D=be(O,2,5);let V=Math.max(0,P.x-D),G=Math.max(0,P.y-D),q=Math.min(M.x+D,p-1),te=Math.min(M.y+D,p-1);for(let ve=G;ve<=te;++ve)for(let Se=V;Se<=q;++Se)zd[ve*p+Se]=255;let re=0,oe=0;for(let ve=0;ve<A.cellsY;++ve)for(let Se=0;Se<A.cellsX;++Se){if(!A.cells[ve*A.cellsX+Se])continue;const Ce=i.tileCoordToPixel(A.min.x+Se/A.xScale,A.min.y+ve/A.yScale),Ae=i.tileCoordToPixel(A.min.x+(Se+1)/A.xScale,A.min.y+(ve+1)/A.yScale);for(let Qe=Ce.y;Qe<=Math.min(Ae.y+1,p-1);++Qe)for(let Oe=Ce.x;Oe<=Math.min(Ae.x+1,p-1);++Oe)zd[Qe*p+Oe]===255&&(zd[Qe*p+Oe]=0,re+=i.getElevationAtPixel(Oe,Qe),oe++)}const xe=re/oe;V=Math.max(1,P.x-D),G=Math.max(1,P.y-D),q=Math.min(M.x+D,p-2),te=Math.min(M.y+D,p-2),y=!0;for(let ve=G;ve<=te;++ve)for(let Se=V;Se<=q;++Se)zd[ve*p+Se]===0&&(Aw[ve*p+Se]=i._dem.set(Se,ve,xe));for(let ve=1;ve<D;++ve){V=Math.max(1,P.x-ve),G=Math.max(1,P.y-ve),q=Math.min(M.x+ve,p-2),te=Math.min(M.y+ve,p-2);for(let Se=G;Se<=te;++Se)for(let Ce=V;Ce<=q;++Ce){const Ae=Se*p+Ce;if(zd[Ae]===255){let Qe=0,Oe=0,et=-1,ct=-1;for(let rt=-1;rt<=1;++rt)for(let st=-1;st<=1;++st){const ht=(Se+rt)*p+Ce+st;if(zd[ht]>=ve)continue;const Ke=Aw[ht],at=Math.abs(Ke);at>Oe&&(Qe=Ke,Oe=at,et=st,ct=rt)}if(Oe>.1){const rt=1-(ve+.5*Math.abs(et*ct))/D;let st=i._dem.get(Ce,Se)+Qe*rt;const ht=i._dem.get(Ce+et,Se+ct),Ke=i._dem.get(Ce-et,Se-ct,!0);(st-ht)*(st-Ke)>0&&(st=(ht+Ke)/2),Aw[Ae]=i._dem.set(Ce,Se,st),zd[Ae]=ve}}}}}y&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=Qo.now())}setFilter(e){this.filter=e?xd(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new gi(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)fy(i.node),rw(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped());for(const u of this.getNodesInfo()){const f=u.node.footprint;u.hiddenByReplacement=!!f&&!l.find(p=>p.footprint===f)}}getHeightAtTileCoord(e,i){const l=[],u=[0,0,0],f=ae([]);for(const p of this.getNodesInfo()){const y=p.node.meshes[0],w=y.transformedAabb;if(e<w.min[0]||i<w.min[1]||e>w.max[0]||i>w.max[1])continue;if(p.node.hidden===!0)return{height:1/0,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};ke(f,p.node.matrix),u[0]=e,u[1]=i,or(u,u,f);const E=(u[0]-y.aabb.min[0])/(y.aabb.max[0]-y.aabb.min[0])*Od|0,A=Math.min(63,(u[1]-y.aabb.min[1])/(y.aabb.max[1]-y.aabb.min[1])*Od|0)*Od+Math.min(63,E),P=y.heightmap[A];if(!(P<0&&p.node.footprint))return p.hiddenByReplacement?void 0:{height:P,maxHeight:p.feature.properties.height,hidden:!1,verticalScale:p.evaluatedScale[2]};if(p.node.footprint.grid.query(new ft(e,i),new ft(e,i),l),l.length>0)return{height:void 0,maxHeight:p.feature.properties.height,hidden:p.hiddenByReplacement,verticalScale:p.evaluatedScale[2]}}}}function Ig(n,e){return n instanceof _d&&!n.isLightConstant&&e}function mO(n,e,i,l,u,f,p,y){let w=(61440&e|(61440&e)>>4)>>8,E=(3840&e|(3840&e)>>4)>>4,A=240&e|(240&e)>>4;i[3]>0&&(w=Yt(w,255*i[0],i[3]),E=Yt(E,255*i[1],i[3]),A=Yt(A,255*i[2],i[3]));const P=w<<8|E,M=A<<8|Math.floor(255*l[3]),O=function(ve){const Se=be(ve,0,2);return Math.min(Math.round(.5*Se*255),255)}(l[2])<<8|15*l[0]<<4|15*l[1],D=be(u[0],0,1),V=be(u[1],0,1),G=be(u[2],0,1),q=be(u[3],0,1);let te,re,oe,xe;if(D!==V&&p!==f&&V!==D){const ve=p-f;re=1/(ve*(V-D)),oe=-(f+ve*D)/(ve*(V-D));const Se=be(u[4],-1,1);xe=Math.pow(10,Se),te=255*G<<8|255*q}else te=65535,re=0,oe=1,xe=1;if(n.emplaceBack(P,M,O,te,re,oe,xe),y){const ve=y.length;y.clear();for(let Se=0;Se<ve;Se++)y.emplaceBack(P,M,O,te,re,oe,xe)}}function gO(n,e,i){const l=n.node;let u=0;const f=i&Rf.HasMeshoptCompression;for(const p of l.meshes){if(l.lights&&l.lightMeshIndex===u||!p.featureData)continue;p.featureArray=new iu,p.featureArray.reserve(p.featureData.length);let y=e;for(const w of p.featureData){const E=f?65535&w:w>>16&65535,A=f?w>>16&65535:65535&w,P=(15&A)<8?15&A:0,M=n.evaluatedRMEA[P],O=n.evaluatedColor[P],D=n.emissionHeightBasedParams[P];let V;if(y&&P===2&&l.lights&&(V=new iu,V.resize(10*l.lights.length)),mO(p.featureArray,E,O,M,D,p.aabb.min[2],p.aabb.max[2],V),V&&y){y=!1;const G=l.meshes[l.lightMeshIndex];G.featureArray=V,G.featureArray._trim()}}p.featureArray._trim(),u++}}function lC(n,e,i,l){const u=1<<n.z;e.lat=me((l/vt+n.y)/u),e.lng=_e((i/vt+n.x)/u)}function _O(n,e,i,l){const u=n.getNodesInfo()[e];if(!u||u.hiddenByReplacement||!u.node.meshes)return;let f=Number.MAX_VALUE;const p=u.node,y=i.tile,w=l.calculatePosMatrix(y.tileID.toUnwrapped(),l.worldSize),E=u.evaluatedScale;let A=0;l.elevation&&p.elevation&&(A=p.elevation*l.elevation.exaggeration()),se(w,w,[(p.anchor?p.anchor[0]:0)*(E[0]-1),(p.anchor?p.anchor[1]:0)*(E[1]-1),A]),J(w,w,E);const P=i.queryGeometry,M=P.isPointQuery()?P.screenBounds:P.screenGeometry,O=function(V){const G=le([],w,V.matrix);le(G,l.expandedFarZProjMatrix,G);for(let q=0;q<V.meshes.length;++q){const te=V.meshes[q];if(q===V.lightMeshIndex)continue;const re=CE(M,l,G,te.aabb);re!=null&&(f=Math.min(re,f))}if(V.children)for(const q of V.children)O(q)};if(O(p),f===Number.MAX_VALUE)return;const D=new U(0,0);return lC(y.tileID.canonical,D,u.node.anchor[0],u.node.anchor[1]),{intersectionZ:f,position:D,feature:u.feature}}Pt(Ry,"Tiled3dModelBucket",{omit:["layers"]}),Pt(aC,"Tiled3dModelFeature");const yO={circle:class extends ss{constructor(n,e,i,l){super(n,{layout:su||(su=new $i({"circle-sort-key":new Tt(Le.layout_circle["circle-sort-key"]),"circle-elevation-reference":new mt(Le.layout_circle["circle-elevation-reference"]),visibility:new mt(Le.layout_circle.visibility)})),paint:Pa||(Pa=new $i({"circle-radius":new Tt(Le.paint_circle["circle-radius"]),"circle-color":new Tt(Le.paint_circle["circle-color"]),"circle-blur":new Tt(Le.paint_circle["circle-blur"]),"circle-opacity":new Tt(Le.paint_circle["circle-opacity"]),"circle-translate":new mt(Le.paint_circle["circle-translate"]),"circle-translate-anchor":new mt(Le.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new mt(Le.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new mt(Le.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Tt(Le.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Tt(Le.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Tt(Le.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new mt(Le.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}createBucket(n){return new zn(n)}queryRadius(n){const e=n;return Bo("circle-radius",this,e)+Bo("circle-stroke-width",this,e)+gl(this.paint.get("circle-translate"))}queryIntersectsFeature(n,e,i,l,u,f,p,y){const w=aa(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),f.angle,n.pixelToTileUnitsFactor),E=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return pT(n,l,f,p,y,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",w,E)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,e,i){const l=fT(this);return{config:new oc(this,{zoom:e,lut:i}),defines:l,overrideFog:!1}}is3D(n){return!n&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends ss{createBucket(n){return new gT(n)}constructor(n,e,i,l){super(n,{layout:_T||(_T=new $i({visibility:new mt(Le.layout_heatmap.visibility)})),paint:yT||(yT=new $i({"heatmap-radius":new Tt(Le.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Tt(Le.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new mt(Le.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Xc(Le.paint_heatmap["heatmap-color"]),"heatmap-opacity":new mt(Le.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Km({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(n){return Bo("heatmap-radius",this,n)}queryIntersectsFeature(n,e,i,l,u,f,p,y){const w=this.paint.get("heatmap-radius").evaluate(e,i);return pT(n,l,f,p,y,!0,!0,new ft(0,0),w)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,e,i){return n==="heatmap"?{config:new oc(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends ss{constructor(n,e,i,l){super(n,{layout:xT||(xT=new $i({visibility:new mt(Le.layout_hillshade.visibility)})),paint:vT||(vT=new $i({"hillshade-illumination-direction":new mt(Le.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new mt(Le.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new mt(Le.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new mt(Le.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new mt(Le.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new mt(Le.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new mt(Le.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}},fill:class extends ss{constructor(n,e,i,l){super(n,{layout:OT||(OT=new $i({"fill-sort-key":new Tt(Le.layout_fill["fill-sort-key"]),visibility:new mt(Le.layout_fill.visibility),"fill-elevation-reference":new mt(Le.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Tt(Le.layout_fill["fill-construct-bridge-guard-rail"])})),paint:DT||(DT=new $i({"fill-antialias":new mt(Le.paint_fill["fill-antialias"]),"fill-opacity":new Tt(Le.paint_fill["fill-opacity"]),"fill-color":new Tt(Le.paint_fill["fill-color"]),"fill-outline-color":new Tt(Le.paint_fill["fill-outline-color"]),"fill-translate":new mt(Le.paint_fill["fill-translate"]),"fill-translate-anchor":new mt(Le.paint_fill["fill-translate-anchor"]),"fill-pattern":new Tt(Le.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new mt(Le.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new mt(Le.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Tt(Le.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Tt(Le.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Tt(Le.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}getProgramIds(){const n=this.paint.get("fill-pattern"),e=n&&n.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(n,e,i){return{config:new oc(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(n,e){super.recalculate(n,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new jb(n)}queryRadius(){return gl(this.paint.get("fill-translate"))}queryIntersectsFeature(n,e,i,l,u,f){return!n.queryGeometry.isAboveHorizon&&Ls(_l(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),f.angle,n.pixelToTileUnitsFactor),l)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(n){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return n!=null?e&&!n:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends ss{constructor(n,e,i,l){super(n,{layout:sE||(sE=new $i({visibility:new mt(Le["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new mt(Le["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:oE||(oE=new $i({"fill-extrusion-opacity":new mt(Le["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new mt(Le["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new mt(Le["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new mt(Le["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new mt(Le["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new mt(Le["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new mt(Le["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new mt(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new mt(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new mt(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new mt(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new mt(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new mt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new mt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new mt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new mt(Le["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new mt(Le["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new mt(Le["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Tt(Le["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new mt(Le["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new sy(n)}queryRadius(){return gl(this.paint.get("fill-extrusion-translate"))}is3D(n){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,e,i,l,u,f,p,y,w){const E=aa(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),f.angle,n.pixelToTileUnitsFactor),A=this.paint.get("fill-extrusion-height").evaluate(e,i),P=this.paint.get("fill-extrusion-base").evaluate(e,i),M=[0,0],O=y&&f.elevation,D=f.elevation?f.elevation.exaggeration():1,V=n.tile.getBucket(this);if(O&&V instanceof sy){const oe=V.centroidVertexArray,xe=w+1;xe<oe.length&&(M[0]=oe.geta_centroid_pos0(xe),M[1]=oe.geta_centroid_pos1(xe))}if(M[0]===0&&M[1]===1)return!1;f.projection.name==="globe"&&(l=nE([l],[new ft(0,0),new ft(vt,vt)],n.tileID.canonical).map(oe=>oe.polygon).flat());const G=O?y:null,[q,te]=function(oe,xe,ve,Se,Ce,Ae,Qe,Oe,et,ct,rt){return oe.projection.name==="globe"?function(st,ht,Ke,at,$e,Be,pt,ut,$t,It,Lt){const xt=[],Bt=[],sr=st.projection.upVectorScale(Lt,st.center.lat,st.worldSize).metersToTile,St=[0,0,0,1],jt=[0,0,0,1],Kt=(Ir,mr,Mt,hr)=>{Ir[0]=mr,Ir[1]=Mt,Ir[2]=hr,Ir[3]=1},ur=iE();Ke>0&&(Ke+=ur),at+=ur;for(const Ir of ht){const mr=[],Mt=[];for(const hr of Ir){const Fr=hr.x+$e.x,ue=hr.y+$e.y,de=st.projection.projectTilePoint(Fr,ue,Lt),Ve=st.projection.upVector(Lt,hr.x,hr.y);let Je=Ke,wt=at;if(pt){const bt=hE(Fr,ue,Ke,at,pt,ut,$t,It);Je+=bt.base,wt+=bt.top}Ke!==0?Kt(St,de.x+Ve[0]*sr*Je,de.y+Ve[1]*sr*Je,de.z+Ve[2]*sr*Je):Kt(St,de.x,de.y,de.z),Kt(jt,de.x+Ve[0]*sr*wt,de.y+Ve[1]*sr*wt,de.z+Ve[2]*sr*wt),or(St,St,Be),or(jt,jt,Be),mr.push(new Rd(St[0],St[1],St[2])),Mt.push(new Rd(jt[0],jt[1],jt[2]))}xt.push(mr),Bt.push(Mt)}return[xt,Bt]}(oe,xe,ve,Se,Ce,Ae,Qe,Oe,et,ct,rt):Qe?function(st,ht,Ke,at,$e,Be,pt,ut,$t){const It=[],Lt=[],xt=[0,0,0,1];for(const Bt of st){const sr=[],St=[];for(const jt of Bt){const Kt=jt.x+at.x,ur=jt.y+at.y,Ir=hE(Kt,ur,ht,Ke,Be,pt,ut,$t);xt[0]=Kt,xt[1]=ur,xt[2]=Ir.base,xt[3]=1,on(xt,xt,$e),xt[3]=Math.max(xt[3],1e-5);const mr=new Rd(xt[0]/xt[3],xt[1]/xt[3],xt[2]/xt[3]);xt[0]=Kt,xt[1]=ur,xt[2]=Ir.top,xt[3]=1,on(xt,xt,$e),xt[3]=Math.max(xt[3],1e-5);const Mt=new Rd(xt[0]/xt[3],xt[1]/xt[3],xt[2]/xt[3]);sr.push(mr),St.push(Mt)}It.push(sr),Lt.push(St)}return[It,Lt]}(xe,ve,Se,Ce,Ae,Qe,Oe,et,ct):function(st,ht,Ke,at,$e){const Be=[],pt=[],ut=$e[8]*ht,$t=$e[9]*ht,It=$e[10]*ht,Lt=$e[11]*ht,xt=$e[8]*Ke,Bt=$e[9]*Ke,sr=$e[10]*Ke,St=$e[11]*Ke;for(const jt of st){const Kt=[],ur=[];for(const Ir of jt){const mr=Ir.x+at.x,Mt=Ir.y+at.y,hr=$e[0]*mr+$e[4]*Mt+$e[12],Fr=$e[1]*mr+$e[5]*Mt+$e[13],ue=$e[2]*mr+$e[6]*Mt+$e[14],de=$e[3]*mr+$e[7]*Mt+$e[15],Ve=hr+ut,Je=Fr+$t,wt=ue+It,bt=Math.max(de+Lt,1e-5),kt=hr+xt,qt=Fr+Bt,Cr=ue+sr,Ar=Math.max(de+St,1e-5);Kt.push(new Rd(Ve/bt,Je/bt,wt/bt)),ur.push(new Rd(kt/Ar,qt/Ar,Cr/Ar))}Be.push(Kt),pt.push(ur)}return[Be,pt]}(xe,ve,Se,Ce,Ae)}(f,l,P,A,E,p,G,M,D,f.center.lat,n.tileID.canonical),re=n.queryGeometry;return function(oe,xe,ve){let Se=1/0;Ls(ve,xe)&&(Se=dE(ve,xe[0]));for(let Ce=0;Ce<xe.length;Ce++){const Ae=xe[Ce],Qe=oe[Ce];for(let Oe=0;Oe<Ae.length-1;Oe++){const et=Ae[Oe],ct=[et,Ae[Oe+1],Qe[Oe+1],Qe[Oe],et];eo(ve,ct)&&(Se=Math.min(Se,dE(ve,ct)))}}return Se!==1/0&&Se}(q,te,re.isPointQuery()?re.screenBounds:re.screenGeometry)}},building:class extends ss{constructor(n,e,i,l){super(n,{layout:jE||(jE=new $i({visibility:new mt(Le.layout_building.visibility),"building-facade":new Tt(Le.layout_building["building-facade"]),"building-facade-floors":new Tt(Le.layout_building["building-facade-floors"]),"building-facade-unit-width":new Tt(Le.layout_building["building-facade-unit-width"]),"building-facade-window":new Tt(Le.layout_building["building-facade-window"]),"building-roof-shape":new Tt(Le.layout_building["building-roof-shape"]),"building-height":new Tt(Le.layout_building["building-height"]),"building-base":new Tt(Le.layout_building["building-base"]),"building-flood-light-wall-radius":new Tt(Le.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new Tt(Le.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new Tt(Le.layout_building["building-flip-roof-orientation"])})),paint:zE||(zE=new $i({"building-opacity":new mt(Le.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new mt(Le.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new mt(Le.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new mt(Le.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new mt(Le.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new mt(Le.paint_building["building-vertical-scale"]),"building-cast-shadows":new mt(Le.paint_building["building-cast-shadows"]),"building-color":new Tt(Le.paint_building["building-color"]),"building-emissive-strength":new Tt(Le.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new mt(Le.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new mt(Le.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new mt(Le.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new mt(Le.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new mt(Le.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new DE(n)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(n){return!0}},line:class extends ss{constructor(n,e,i,l){const u=ZE();super(n,u,e,i,l),u.layout&&(this.layout=new ec(u.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof fd,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,e){super.recalculate(n,e),this.paint._values["line-floorwidth"]=(()=>{if(pg)return pg;const i=ZE();return pg=new gL(i.paint.properties["line-width"].specification),pg.useIntegerZoom=!0,pg})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new ow(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,e,i){const l=HE(this);return{config:new oc(this,{zoom:e,lut:i}),defines:l,overrideFog:!1}}queryRadius(n){const e=n,i=XE(Bo("line-width",this,e),Bo("line-gap-width",this,e)),l=Bo("line-offset",this,e);return i/2+Math.abs(l)+gl(this.paint.get("line-translate"))}queryIntersectsFeature(n,e,i,l,u,f){if(n.queryGeometry.isAboveHorizon)return!1;const p=_l(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),f.angle,n.pixelToTileUnitsFactor),y=n.pixelToTileUnitsFactor/2*XE(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),w=this.paint.get("line-offset").evaluate(e,i);return w&&(l=function(E,A){const P=[],M=new ft(0,0);for(let O=0;O<E.length;O++){const D=E[O],V=[];for(let G=0;G<D.length;G++){const q=D[G],te=D[G+1],re=G===0?M:q.sub(D[G-1])._unit()._perp(),oe=G===D.length-1?M:te.sub(q)._unit()._perp(),xe=re._add(oe)._unit();xe._mult(1/(xe.x*oe.x+xe.y*oe.y)),V.push(xe._mult(A)._add(q))}P.push(V)}return P}(l,w*n.pixelToTileUnitsFactor)),function(E,A,P){for(let M=0;M<A.length;M++){const O=A[M];if(E.length>=3){for(let D=0;D<O.length;D++)if(Pn(E,O[D]))return!0}if(Os(E,O,P))return!0}return!1}(p,l,y)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(n){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:Py,background:class extends ss{constructor(n,e,i,l){super(n,{layout:BI||(BI=new $i({visibility:new mt(Le.layout_background.visibility)})),paint:UI||(UI=new $i({"background-pitch-alignment":new mt(Le.paint_background["background-pitch-alignment"]),"background-color":new mt(Le.paint_background["background-color"]),"background-pattern":new mt(Le.paint_background["background-pattern"]),"background-opacity":new mt(Le.paint_background["background-opacity"]),"background-emissive-strength":new mt(Le.paint_background["background-emissive-strength"]),"background-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}is3D(n){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:HI,"raster-particle":JI,sky:class extends ss{constructor(n,e,i,l){super(n,{layout:XI||(XI=new $i({visibility:new mt(Le.layout_sky.visibility)})),paint:YI||(YI=new $i({"sky-type":new mt(Le.paint_sky["sky-type"]),"sky-atmosphere-sun":new mt(Le.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new mt(Le.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new mt(Le.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new mt(Le.paint_sky["sky-gradient-radius"]),"sky-gradient":new Xc(Le.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new mt(Le.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new mt(Le.paint_sky["sky-atmosphere-color"]),"sky-opacity":new mt(Le.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Km({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(n,e){if(this.paint.get("sky-type")==="atmosphere"){const l=this.paint.get("sky-atmosphere-sun"),u=!l,f=n.style.light,p=f.properties.get("position");return u&&f.properties.get("anchor")==="viewport"&&Lr("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),u?Ew(p.azimuthal,90-p.polar,e):Ew(l[0],90-l[1],e)}const i=this.paint.get("sky-gradient-center");return Ew(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends ss{constructor(n,e,i,l){super(n,{paint:KI||(KI=new $i({}))},e,null)}},model:class extends ss{constructor(n,e,i,l){super(n,{layout:rC||(rC=new $i({visibility:new mt(Le.layout_model.visibility),"model-id":new Tt(Le.layout_model["model-id"])})),paint:iC||(iC=new $i({"model-opacity":new Tt(Le.paint_model["model-opacity"]),"model-rotation":new Tt(Le.paint_model["model-rotation"]),"model-scale":new Tt(Le.paint_model["model-scale"]),"model-translation":new Tt(Le.paint_model["model-translation"]),"model-color":new Tt(Le.paint_model["model-color"]),"model-color-mix-intensity":new Tt(Le.paint_model["model-color-mix-intensity"]),"model-type":new mt(Le.paint_model["model-type"]),"model-cast-shadows":new mt(Le.paint_model["model-cast-shadows"]),"model-receive-shadows":new mt(Le.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new mt(Le.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Tt(Le.paint_model["model-emissive-strength"]),"model-roughness":new Tt(Le.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Tt(Le.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new mt(Le.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new mt(Le.paint_model["model-front-cutoff"]),"model-elevation-reference":new mt(Le.paint_model["model-elevation-reference"]),"model-color-use-theme":new Tt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new Cw(n)}getProgramIds(){return["model"]}is3D(n){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof Ry?vt-1:0}queryIntersectsFeature(n,e,i,l,u,f){if(!this.modelManager)return!1;const p=this.modelManager,y=n.tile.getBucket(this);if(!(y&&y instanceof Cw))return!1;for(const w in y.instancesPerModel){const E=y.instancesPerModel[w],A=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(E.idToFeaturesIndex.hasOwnProperty(A)){const P=E.features[E.idToFeaturesIndex[A]],M=p.getModel(w,this.scope);if(!M)return!1;let O=ie();const D=new U(0,0),V=y.canonical;let G=Number.MAX_VALUE;for(let q=0;q<P.instancedDataCount;++q){const te=16*(P.instancedDataOffset+q),re=E.instancedDataArray.float32,oe=[re[te+4],re[te+5],re[te+6]];lC(V,D,re[te],0|re[te+1]),AE(O,M,f,D,P.rotation,P.scale,oe,!1,!1,!1),f.projection.name==="globe"&&(O=ew(O,f));const xe=le([],f.projMatrix,O),ve=n.queryGeometry,Se=CE(ve.isPointQuery()?ve.screenBounds:ve.screenGeometry,f,xe,M.aabb);Se!=null&&(G=Math.min(Se,G))}return G!==Number.MAX_VALUE&&G}}return!1}_handleOverridablePaintPropertyUpdate(n,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const e=this._transitionablePaint._values[n];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof al}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ss{constructor(n,e,i,l){super(n,{layout:jT||(jT=new $i({"clip-layer-types":new mt(Le.layout_clip["clip-layer-types"]),"clip-layer-scope":new mt(Le.layout_clip["clip-layer-scope"])})),paint:zT||(zT=new $i({}))},e,i,l)}recalculate(n,e){super.recalculate(n,e)}createBucket(n){return new FT(n)}is3D(n){return!0}}},Pw=new ti(0,0,0),kw={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Mw={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Ly={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},xO={PAINT_ORDER_FILL_AND_STROKE:1},Cg={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},cC={MASK_TYPE_LUMINANCE:1};function vO(n,e,i){n===1&&e.icons.push(function(l,u){return function(f){if(f.usvg_tree.height||(f.usvg_tree.height=f.usvg_tree.width),!f.metadata)return f;const{metadata:p}=f;if(p.content_area){const{content_area:y}=p;y.left==null&&(y.left=0),y.top==null&&(y.top=y.left),y.width==null&&(y.width=f.usvg_tree.width),y.height==null&&(y.height=y.width)}if(p.text_placeholder){const{text_placeholder:y}=p;y.top==null&&(y.top=y.left),y.height==null&&(y.height=y.width)}return p.stretch_x&&p.stretch_x.length&&uC(p,"x"),p.stretch_y&&p.stretch_y.length&&uC(p,"y"),f}(l.readFields(bO,{name:void 0},u))}(i,i.readVarint()+i.pos))}function uC(n,e){const i=[],l=n[`stretch_${e}`];let u=null;for(let f=0;f<l.length;f++)u===null?u=i.length===0?l[0]:i[i.length-1][1]+l[f]:(i.push([u,u+l[f]]),u=null);n[`stretch_${e}_areas`]=i}function bO(n,e,i){n===1?e.name=i.readString():n===2?e.metadata=function(l,u){return l.readFields(wO,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},u)}(i,i.readVarint()+i.pos):n===3&&(e.usvg_tree=function(l,u){return l.readFields(EO,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},u)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function wO(n,e,i){n===1?e.stretch_x=i.readPackedVarint():n===2?e.stretch_y=i.readPackedVarint():n===3?e.content_area=dC(i,i.readVarint()+i.pos):n===4?e.variables.push(function(l,u){return l.readFields(TO,{name:void 0},u)}(i,i.readVarint()+i.pos)):n===5&&(e.text_placeholder=dC(i,i.readVarint()+i.pos))}function dC(n,e){return n.readFields(SO,{},e)}function SO(n,e,i){n===1?e.left=i.readVarint():n===2?e.width=i.readVarint():n===3?e.top=i.readVarint():n===4&&(e.height=i.readVarint())}function TO(n,e,i){n===1?e.name=i.readString():n===2&&(e.rgb_color=jy(i.readVarint()),e.value="rgb_color")}function EO(n,e,i){n===1?e.width=e.height=i.readVarint():n===2?e.height=i.readVarint():n===3?e.children.push(Oy(i,i.readVarint()+i.pos)):n===4?e.linear_gradients.push(function(l,u){return l.readFields(NO,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},u)}(i,i.readVarint()+i.pos)):n===5?e.radial_gradients.push(function(l,u){return l.readFields(LO,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},u)}(i,i.readVarint()+i.pos)):n===7?e.clip_paths.push(function(l,u){return l.readFields(OO,{children:[]},u)}(i,i.readVarint()+i.pos)):n===8&&e.masks.push(function(l,u){const f=l.readFields(DO,{left:0,width:20,mask_type:cC.MASK_TYPE_LUMINANCE,children:[]},u);return f.height==null&&(f.height=f.width),f.top==null&&(f.top=f.left),f}(i,i.readVarint()+i.pos))}function Oy(n,e){return n.readFields(IO,{},e)}function IO(n,e,i){n===1?(e.group=function(l,u){return l.readFields(CO,{opacity:255,children:[]},u)}(i,i.readVarint()+i.pos),e.node="group"):n===2&&(e.path=function(l,u){return l.readFields(PO,{paint_order:1,commands:[],step:1,diffs:[],rule:kw.PATH_RULE_NON_ZERO},u)}(i,i.readVarint()+i.pos),e.node="path")}function CO(n,e,i){n===1?e.transform=Dy(i,i.readVarint()+i.pos):n===2?e.opacity=i.readVarint():n===5?e.clip_path_idx=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Oy(i,i.readVarint()+i.pos))}function Dy(n,e){return n.readFields(AO,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function AO(n,e,i){n===1?e.sx=i.readFloat():n===2?e.ky=i.readFloat():n===3?e.kx=i.readFloat():n===4?e.sy=i.readFloat():n===5?e.tx=i.readFloat():n===6&&(e.ty=i.readFloat())}function PO(n,e,i){n===1?e.fill=function(l,u){return l.readFields(kO,{rgb_color:Pw,paint:"rgb_color",opacity:255},u)}(i,i.readVarint()+i.pos):n===2?e.stroke=function(l,u){return l.readFields(MO,{rgb_color:Pw,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},u)}(i,i.readVarint()+i.pos):n===3?e.paint_order=i.readVarint():n===5?i.readPackedVarint(e.commands):n===6?e.step=i.readFloat():n===7?i.readPackedSVarint(e.diffs):n===8&&(e.rule=i.readVarint())}function kO(n,e,i){n===1?(e.rgb_color=jy(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5&&(e.opacity=i.readVarint())}function jy(n){return new ti((n>>16&255)/255,(n>>8&255)/255,(255&n)/255,1)}function MO(n,e,i){n===1?(e.rgb_color=jy(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5?i.readPackedFloat(e.dasharray):n===6?e.dashoffset=i.readFloat():n===7?e.miterlimit=i.readFloat():n===8?e.opacity=i.readVarint():n===9?e.width=i.readFloat():n===10?e.linecap=i.readVarint():n===11&&(e.linejoin=i.readVarint())}function NO(n,e,i){n===1?e.transform=Dy(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(hC(i,i.readVarint()+i.pos)):n===4?e.x1=i.readFloat():n===5?e.y1=i.readFloat():n===6?e.x2=i.readFloat():n===7&&(e.y2=i.readFloat())}function hC(n,e){return n.readFields(RO,{offset:0,opacity:255,rgb_color:Pw},e)}function RO(n,e,i){n===1?e.offset=i.readFloat():n===2?e.opacity=i.readVarint():n===3&&(e.rgb_color=jy(i.readVarint()))}function LO(n,e,i){n===1?e.transform=Dy(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(hC(i,i.readVarint()+i.pos)):n===4?e.cx=i.readFloat():n===5?e.cy=i.readFloat():n===6?e.r=i.readFloat():n===7?e.fx=i.readFloat():n===8?e.fy=i.readFloat():n===9&&(e.fr=i.readFloat())}function OO(n,e,i){n===1?e.transform=Dy(i,i.readVarint()+i.pos):n===2?e.clip_path_idx=i.readVarint():n===3&&e.children.push(Oy(i,i.readVarint()+i.pos))}function DO(n,e,i){n===1?e.left=e.top=i.readFloat():n===2?e.width=e.height=i.readFloat():n===3?e.top=i.readFloat():n===4?e.height=i.readFloat():n===5?e.mask_type=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Oy(i,i.readVarint()+i.pos))}class jO{static calculate(e={},i=[]){const l=new Map,u=new Map;if(Object.keys(e).length===0)return l;i.forEach(f=>{u.set(f.name,f.rgb_color||new ti(0,0,0))});for(const[f,p]of Object.entries(e))u.has(f)?l.set(u.get(f).toString(),p):console.warn(`Ignoring unknown image variable "${f}"`);return l}}function Bf(n,e=255,i){const l=e/255,u=n.toString(),f=i.has(u)?i.get(u).clone():n.clone();return f.a*=l,f.toString()}function Ag(n,e){if(!Bp()){const i=document.createElement("canvas");return i.width=n,i.height=e,i}return new OffscreenCanvas(n,e)}function zO(n,e){const i=jO.calculate(e.params,n.metadata?n.metadata.variables:[]),l=n.usvg_tree,u=l.width,f=l.height,p=e.transform?e.transform:new DOMMatrix,y=Math.max(1,Math.round(u*p.a)),w=Math.max(1,Math.round(f*p.d)),E=new DOMMatrix([y/u,0,0,w/f,0,0]),A=Ag(y,w).getContext("2d");return Nw(A,E,l,l,i),A.getImageData(0,0,y,w)}function Nw(n,e,i,l,u){for(const f of l.children)fC(n,e,i,f,u)}function fC(n,e,i,l,u){l.group?(n.save(),function(f,p,y,w,E){const A=w.mask_idx!=null?y.masks[w.mask_idx]:null,P=w.clip_path_idx!=null?y.clip_paths[w.clip_path_idx]:null;if(w.transform&&(p=Uf(w.transform).preMultiplySelf(p)),!function(D,V,G){return D.opacity!==255||V||G}(w,P!=null,A!=null))return void Nw(f,p,y,w,E);const M=Ag(f.canvas.width,f.canvas.height),O=M.getContext("2d");Nw(O,p,y,w,E),P&&vC(O,p,y,P),A&&bC(O,p,y,A,E),f.globalAlpha=w.opacity/255,f.drawImage(M,0,0)}(n,e,i,l.group,u),n.restore()):l.path&&(n.save(),function(f,p,y,w,E){f.setTransform(p),w.paint_order===xO.PAINT_ORDER_FILL_AND_STROKE?(pC(f,y,w,E),gC(f,y,w,E)):(gC(f,y,w,E),pC(f,y,w,E))}(n,e,i,l.path,u),n.restore())}function pC(n,e,i,l){const u=i.fill;if(!u)return;const f=u.opacity/255;switch(n.save(),n.beginPath(),wC(i,n),u.paint){case"rgb_color":n.fillStyle=Bf(u.rgb_color,u.opacity,l);break;case"linear_gradient_idx":{const p=e.linear_gradients[u.linear_gradient_idx];p.transform&&n.setTransform(Uf(p.transform).preMultiplySelf(n.getTransform())),n.fillStyle=_C(n,p,f,l);break}case"radial_gradient_idx":{const p=e.radial_gradients[u.radial_gradient_idx];p.transform&&n.setTransform(Uf(p.transform).preMultiplySelf(n.getTransform())),n.fillStyle=yC(n,p,f,l)}}n.fill(mC(i)),n.restore()}function mC(n){return n.rule===kw.PATH_RULE_NON_ZERO?"nonzero":n.rule===kw.PATH_RULE_EVEN_ODD?"evenodd":void 0}function gC(n,e,i,l){const u=i.stroke;if(!u)return;const f=SC(i);n.lineWidth=u.width,n.miterLimit=u.miterlimit,n.setLineDash(u.dasharray),n.lineDashOffset=u.dashoffset;const p=u.opacity/255;switch(u.paint){case"rgb_color":n.strokeStyle=Bf(u.rgb_color,u.opacity,l);break;case"linear_gradient_idx":n.strokeStyle=_C(n,e.linear_gradients[u.linear_gradient_idx],p,l,!0);break;case"radial_gradient_idx":n.strokeStyle=yC(n,e.radial_gradients[u.radial_gradient_idx],p,l,!0)}switch(u.linejoin){case Ly.LINE_JOIN_MITER_CLIP:case Ly.LINE_JOIN_MITER:n.lineJoin="miter";break;case Ly.LINE_JOIN_ROUND:n.lineJoin="round";break;case Ly.LINE_JOIN_BEVEL:n.lineJoin="bevel"}switch(u.linecap){case Mw.LINE_CAP_BUTT:n.lineCap="butt";break;case Mw.LINE_CAP_ROUND:n.lineCap="round";break;case Mw.LINE_CAP_SQUARE:n.lineCap="square"}n.stroke(f)}function _C(n,e,i,l,u=!1){if(e.stops.length===1){const M=e.stops[0];return Bf(M.rgb_color,M.opacity*i,l)}const{x1:f,y1:p,x2:y,y2:w}=e;let E=new DOMPoint(f,p),A=new DOMPoint(y,w);if(u){const M=Uf(e.transform);E=M.transformPoint(E),A=M.transformPoint(A)}const P=n.createLinearGradient(E.x,E.y,A.x,A.y);for(const M of e.stops)P.addColorStop(M.offset,Bf(M.rgb_color,M.opacity*i,l));return P}function yC(n,e,i,l,u=!1){if(e.stops.length===1){const q=e.stops[0];return Bf(q.rgb_color,q.opacity*i,l)}const f=Uf(e.transform),{fx:p,fy:y,fr:w,cx:E,cy:A,r:P}=e;let M=new DOMPoint(p,y),O=new DOMPoint(E,A),D=w,V=P;if(u){M=f.transformPoint(M),O=f.transformPoint(O);const q=(f.a+f.d)/2;D=w*q,V=e.r*q}const G=n.createRadialGradient(M.x,M.y,D,O.x,O.y,V);for(const q of e.stops)G.addColorStop(q.offset,Bf(q.rgb_color,q.opacity*i,l));return G}function xC(n,e,i,l){const u=l.transform?Uf(l.transform).preMultiplySelf(e):e,f=Ag(n.canvas.width,n.canvas.height),p=f.getContext("2d");for(const w of l.children)if(w.group)xC(p,u,i,w.group);else if(w.path){const E=w.path,A=new Path2D;A.addPath(SC(E),u),p.fill(A,mC(E))}const y=l.clip_path_idx!=null?i.clip_paths[l.clip_path_idx]:null;y&&vC(p,u,i,y),n.globalCompositeOperation="source-over",n.drawImage(f,0,0)}function vC(n,e,i,l){const u=Ag(n.canvas.width,n.canvas.height);xC(u.getContext("2d"),e,i,l),n.globalCompositeOperation="destination-in",n.drawImage(u,0,0)}function bC(n,e,i,l,u){if(l.children.length===0)return;const f=l.mask_idx!=null?i.masks[l.mask_idx]:null;f&&bC(n,e,i,f,u);const p=n.canvas.width,y=n.canvas.height,w=Ag(p,y),E=w.getContext("2d"),A=l.width,P=l.height,M=l.left,O=l.top,D=new Path2D,V=new Path2D;V.rect(M,O,A,P),D.addPath(V,e),E.clip(D);for(const te of l.children)fC(E,e,i,te,u);const G=E.getImageData(0,0,p,y),q=G.data;if(l.mask_type===cC.MASK_TYPE_LUMINANCE)for(let te=0;te<q.length;te+=4)q[te+3]=q[te+3]/255*(.2126*q[te]+.7152*q[te+1]+.0722*q[te+2]);E.putImageData(G,0,0),n.globalCompositeOperation="destination-in",n.drawImage(w,0,0)}function Uf(n){return n?new DOMMatrix([n.sx,n.ky,n.kx,n.sy,n.tx,n.ty]):new DOMMatrix}function wC(n,e){const i=n.step;let l=n.diffs[0]*i,u=n.diffs[1]*i;e.moveTo(l,u);for(let f=0,p=2;f<n.commands.length;f++)switch(n.commands[f]){case Cg.PATH_COMMAND_MOVE:l+=n.diffs[p++]*i,u+=n.diffs[p++]*i,e.moveTo(l,u);break;case Cg.PATH_COMMAND_LINE:l+=n.diffs[p++]*i,u+=n.diffs[p++]*i,e.lineTo(l,u);break;case Cg.PATH_COMMAND_QUAD:{const y=l+n.diffs[p++]*i,w=u+n.diffs[p++]*i;l=y+n.diffs[p++]*i,u=w+n.diffs[p++]*i,e.quadraticCurveTo(y,w,l,u);break}case Cg.PATH_COMMAND_CUBIC:{const y=l+n.diffs[p++]*i,w=u+n.diffs[p++]*i,E=y+n.diffs[p++]*i,A=w+n.diffs[p++]*i;l=E+n.diffs[p++]*i,u=A+n.diffs[p++]*i,e.bezierCurveTo(y,w,E,A,l,u);break}case Cg.PATH_COMMAND_CLOSE:e.closePath()}return e}function SC(n){return wC(n,new Path2D)}class zy{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}Pt(zy,"LRUCache");class Rw{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Yn(e,e.data)}getFromCache(e,i,l){return this.cacheMap.has(l)||this.cacheMap.set(l,new zy(150)),this.cacheMap.get(l).get(Kc(e.toString(),i))}setInCache(e,i,l,u){this.cacheDependenciesMap.has(u)||this.cacheDependenciesMap.set(u,new Map),this.cacheMap.has(u)||this.cacheMap.set(u,new zy(150));const f=this.cacheDependenciesMap.get(u),p=Kc(e.id.toString(),l);f.get(p)||f.set(p,new Set);const y=this.cacheMap.get(u),w=e.toString();f.get(p).add(w),y.put(Kc(e.toString(),l),i)}removeImagesFromCacheByIds(e,i,l=0){if(!this.cacheMap.has(l)||!this.cacheDependenciesMap.has(l))return;const u=this.cacheMap.get(l),f=this.cacheDependenciesMap.get(l);for(const p of e){const y=Kc(p.toString(),i);if(f.has(y)){for(const w of f.get(y))u.delete(w);f.delete(y)}}}rasterize(e,i,l,u,f=zO){const p=this.getFromCache(e,l,u);if(p)return p.clone();const y=f(i.icon,e.options),w=Rw._getImage(y);return this.setInCache(e,w,l,u),w.clone()}}class TC{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const l=this.toIdx(e,i);return{min:this.minimums[l],max:this.maximums[l]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function EC(n,e,i,l){let u=0,f=Number.MAX_VALUE;for(let p=0;p<3;p++)if(Math.abs(l[p])<1e-15){if(i[p]<n[p]||i[p]>e[p])return null}else{const y=1/l[p];let w=(n[p]-i[p])*y,E=(e[p]-i[p])*y;if(w>E){const A=w;w=E,E=A}if(w>u&&(u=w),E<f&&(f=E),u>f)return null}return u}function IC(n,e,i,l,u,f,p,y,w,E,A){const P=l-n,M=u-e,O=f-i,D=p-n,V=y-e,G=w-i,q=A[1]*G-A[2]*V,te=A[2]*D-A[0]*G,re=A[0]*V-A[1]*D,oe=P*q+M*te+O*re;if(Math.abs(oe)<1e-15)return null;const xe=1/oe,ve=E[0]-n,Se=E[1]-e,Ce=E[2]-i,Ae=(ve*q+Se*te+Ce*re)*xe;if(Ae<0||Ae>1)return null;const Qe=Se*O-Ce*M,Oe=Ce*P-ve*O,et=ve*M-Se*P,ct=(A[0]*Qe+A[1]*Oe+A[2]*et)*xe;return ct<0||Ae+ct>1?null:(D*Qe+V*Oe+G*et)*xe}function CC(n,e,i){return(n-e)/(i-e)}function AC(n,e,i,l,u,f,p,y,w){const E=1<<i,A=f-l,P=p-u,M=(n+1)/E*A+l,O=(e+0)/E*P+u,D=(e+1)/E*P+u;y[0]=(n+0)/E*A+l,y[1]=O,w[0]=M,w[1]=D}class PC{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(f){const p=Math.ceil(Math.log2(f.dim/8)),y=[];let w=Math.ceil(Math.pow(2,p));const E=1/w,A=(O,D,V,G,q)=>{const te=G?1:0,re=(O+1)*V-te,oe=D*V,xe=(D+1)*V-te;q[0]=O*V,q[1]=oe,q[2]=re,q[3]=xe};let P=new TC(w);const M=[];for(let O=0;O<w*w;O++){A(O%w,Math.floor(O/w),E,!1,M);const D=fu(M[0],M[1],f),V=fu(M[2],M[1],f),G=fu(M[2],M[3],f),q=fu(M[0],M[3],f);P.minimums.push(Math.min(D,V,G,q)),P.maximums.push(Math.max(D,V,G,q)),P.leaves.push(1)}for(y.push(P),w/=2;w>=1;w/=2){const O=y[y.length-1];P=new TC(w);for(let D=0;D<w*w;D++){A(D%w,Math.floor(D/w),2,!0,M);const V=O.getElevation(M[0],M[1]),G=O.getElevation(M[2],M[1]),q=O.getElevation(M[2],M[3]),te=O.getElevation(M[0],M[3]),re=O.isLeaf(M[0],M[1]),oe=O.isLeaf(M[2],M[1]),xe=O.isLeaf(M[2],M[3]),ve=O.isLeaf(M[0],M[3]),Se=Math.min(V.min,G.min,q.min,te.min),Ce=Math.max(V.max,G.max,q.max,te.max),Ae=re&&oe&&xe&&ve;P.maximums.push(Ce),P.minimums.push(Se),P.leaves.push(Ce-Se<=5&&Ae?1:0)}y.push(P)}return y}(this.dem),l=i.length-1,u=i[l];this._addNode(u.minimums[0],u.maximums[0],u.leaves[0]),this._construct(i,0,0,l,0)}raycastRoot(e,i,l,u,f,p,y=1){return EC([e,i,-100],[l,u,this.maximums[0]*y],f,p)}raycast(e,i,l,u,f,p,y=1){if(!this.nodeCount)return null;const w=this.raycastRoot(e,i,l,u,f,p,y);if(w==null)return null;const E=[],A=[],P=[],M=[],O=[{idx:0,t:w,nodex:0,nodey:0,depth:0}];for(;O.length>0;){const{idx:D,t:V,nodex:G,nodey:q,depth:te}=O.pop();if(this.leaves[D]){AC(G,q,te,e,i,l,u,P,M);const oe=1<<te,xe=(G+0)/oe,ve=(G+1)/oe,Se=(q+0)/oe,Ce=(q+1)/oe,Ae=fu(xe,Se,this.dem)*y,Qe=fu(ve,Se,this.dem)*y,Oe=fu(ve,Ce,this.dem)*y,et=fu(xe,Ce,this.dem)*y,ct=IC(P[0],P[1],Ae,M[0],P[1],Qe,M[0],M[1],Oe,f,p),rt=IC(M[0],M[1],Oe,P[0],M[1],et,P[0],P[1],Ae,f,p),st=Math.min(ct!==null?ct:Number.MAX_VALUE,rt!==null?rt:Number.MAX_VALUE);if(st!==Number.MAX_VALUE)return st;{const ht=Nr([],f,p,V);if(kC(Ae,Qe,et,Oe,CC(ht[0],P[0],M[0]),CC(ht[1],P[1],M[1]))>=ht[2])return V}continue}let re=0;for(let oe=0;oe<this._siblingOffset.length;oe++){AC((G<<1)+this._siblingOffset[oe][0],(q<<1)+this._siblingOffset[oe][1],te+1,e,i,l,u,P,M),P[2]=-100,M[2]=this.maximums[this.childOffsets[D]+oe]*y;const xe=EC(P,M,f,p);if(xe!=null){const ve=xe;E[oe]=ve;let Se=!1;for(let Ce=0;Ce<re&&!Se;Ce++)ve>=E[A[Ce]]&&(A.splice(Ce,0,oe),Se=!0);Se||(A[re]=oe),re++}}for(let oe=0;oe<re;oe++){const xe=A[oe];O.push({idx:this.childOffsets[D]+xe,t:E[xe],nodex:(G<<1)+this._siblingOffset[xe][0],nodey:(q<<1)+this._siblingOffset[xe][1],depth:te+1})}}return null}_addNode(e,i,l){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(l),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,l,u,f){if(e[u].isLeaf(i,l)===1)return;this.childOffsets[f]||(this.childOffsets[f]=this.nodeCount);const p=u-1,y=e[p];let w=0,E=0;for(let A=0;A<this._siblingOffset.length;A++){const P=2*i+this._siblingOffset[A][0],M=2*l+this._siblingOffset[A][1],O=y.getElevation(P,M),D=y.isLeaf(P,M),V=this._addNode(O.min,O.max,D);D&&(w|=1<<A),E||(E=V)}for(let A=0;A<this._siblingOffset.length;A++)w&1<<A||this._construct(e,2*i+this._siblingOffset[A][0],2*l+this._siblingOffset[A][1],p,E+A)}}function kC(n,e,i,l,u,f){return Yt(Yt(n,i,f),Yt(e,l,f),u)}function fu(n,e,i){const l=i.dim,u=be(n*l-.5,0,l-1),f=be(e*l-.5,0,l-1),p=Math.floor(u),y=Math.floor(f),w=Math.min(p+1,l-1),E=Math.min(y+1,l-1);return kC(i.get(p,y),i.get(w,y),i.get(p,E),i.get(w,E),u-p,f-y)}const FO={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function BO(n,e,i){return(256*n*256+256*e+i)/10-1e4}function UO(n,e,i){return 256*n+e+i/256-32768}class Fy{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,l,u=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(l&&l!=="mapbox"&&l!=="terrarium")return void Lr(`"${l}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const f=this.dim=i.height-2,p=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=u,this._modifiedForSources={},!u){for(let w=0;w<f;w++)p[this._idx(-1,w)]=p[this._idx(0,w)],p[this._idx(f,w)]=p[this._idx(f-1,w)],p[this._idx(w,-1)]=p[this._idx(w,0)],p[this._idx(w,f)]=p[this._idx(w,f-1)];p[this._idx(-1,-1)]=p[this._idx(0,0)],p[this._idx(f,-1)]=p[this._idx(f-1,0)],p[this._idx(-1,f)]=p[this._idx(0,f-1)],p[this._idx(f,f)]=p[this._idx(f-1,f-1)]}const y=l==="terrarium"?UO:BO;for(let w=0;w<p.length;++w){const E=4*w;this.floatView[w]=y(this.pixels[E],this.pixels[E+1],this.pixels[E+2])}this._timestamp=Qo.now()}_buildQuadTree(){this._tree=new PC(this)}get(e,i,l=!1){l&&(e=be(e,-1,this.dim),i=be(i,-1,this.dim));const u=this._idx(e,i);return this.floatView[u]}set(e,i,l){const u=this._idx(e,i),f=this.floatView[u];return this.floatView[u]=l,l-f}static getUnpackVector(e){return FO[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const l=[0,0,0,0],u=Fy.getUnpackVector(i);let f=Math.floor((e+u[3])/u[2]);return l[2]=f%256,f=Math.floor(f/256),l[1]=f%256,f=Math.floor(f/256),l[0]=f,l}getPixels(){return new ST({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,l){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let u=i*this.dim,f=i*this.dim+this.dim,p=l*this.dim,y=l*this.dim+this.dim;switch(i){case-1:u=f-1;break;case 1:f=u+1}switch(l){case-1:p=y-1;break;case 1:y=p+1}const w=-i*this.dim,E=-l*this.dim;for(let A=p;A<y;A++)for(let P=u;P<f;P++){const M=4*this._idx(P,A),O=4*this._idx(P+w,A+E);this.pixels[M+0]=e.pixels[O+0],this.pixels[M+1]=e.pixels[O+1],this.pixels[M+2]=e.pixels[O+2],this.pixels[M+3]=e.pixels[O+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function VO(n,e,i){n===1?e.headerLength=i.readFixed32():n===2?e.x=i.readVarint():n===3?e.y=i.readVarint():n===4?e.z=i.readVarint():n===5&&e.layers.push(function(l,u){return l.readFields(WO,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},u)}(i,i.readVarint()+i.pos))}function $O(n,e,i){n===1?(e.delta_filter=function(l,u){return l.readFields(GO,{blockSize:0},u)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):n===2?(i.readVarint(),e.filter="zigzag_filter"):n===3?(i.readVarint(),e.filter="bitshuffle_filter"):n===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function GO(n,e,i){n===1&&(e.blockSize=i.readVarint())}function qO(n,e,i){n===1?(i.readVarint(),e.codec="gzip_data"):n===2?(i.readVarint(),e.codec="jpeg_image"):n===3?(i.readVarint(),e.codec="webp_image"):n===4&&(i.readVarint(),e.codec="png_image")}function HO(n,e,i){let l=0,u=0;n===1?e.firstByte=i.readFixed64():n===2?e.lastByte=i.readFixed64():n===3?e.filters.push(function(f,p){return f.readFields($O,{},p)}(i,i.readVarint()+i.pos)):n===4?e.codec=function(f,p){return f.readFields(qO,{},p)}(i,i.readVarint()+i.pos):n===5?u=i.readFloat():n===6?l=i.readFloat():n===7?e.bands.push(i.readString()):n===8?e.offset=i.readDouble():n===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=u),e.scale===0&&(e.scale=l)}function WO(n,e,i){n===1?e.version=i.readVarint():n===2?e.name=i.readString():n===3?e.units=i.readString():n===4?e.tileSize=i.readVarint():n===5?e.buffer=i.readVarint():n===6?e.pixelFormat=i.readVarint():n===7&&e.dataIndex.push(function(l,u){return l.readFields(HO,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},u)}(i,i.readVarint()+i.pos))}function ZO(n,e,i){if(n===2)(function(l,u,f){l.readFields(XO,f,u)})(i,i.readVarint()+i.pos,e);else if(n===3)throw new Error("Not implemented")}function XO(n,e,i){if(n===1){let l=0;const u=i.readVarint()+i.pos;for(;i.pos<u;)e[l++]=i.readVarint()}}function YO(n,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let l=2;l>=1;l--){const u=l===1?1:0,f=l===2?1:0;for(let p=0;p<e[0];p++){const y=e[1]*p;for(let w=u;w<e[1];w++){const E=e[2]*(w+y);for(let A=f;A<e[2];A++){const P=e[3]*(A+E);for(let M=0;M<e[3];M++){const O=P+M;n[O]+=n[O-i]}}}}i*=e[l]}return n}function KO(n){for(let e=0,i=n.length;e<i;e++)n[e]=n[e]>>>1^-(1&n[e]);return n}function JO(n,e){switch(e){case"uint32":return n;case"uint16":for(let i=0;i<n.length;i+=2){const l=n[i],u=n[i+1];n[i]=(240&l)>>4|(61440&l)>>8|(240&u)<<4|61440&u,n[i+1]=15&l|(3840&l)>>4|(15&u)<<8|(3840&u)<<4}return n;case"uint8":for(let i=0;i<n.length;i+=4){const l=n[i],u=n[i+1],f=n[i+2],p=n[i+3];n[i+0]=(192&l)>>6|(192&u)>>4|(192&f)>>2|192&p,n[i+1]=(48&l)>>4|(48&u)>>2|48&f|(48&p)<<2,n[i+2]=(12&l)>>2|12&u|(12&f)<<2|(12&p)<<4,n[i+3]=3&l|(3&u)<<2|(3&f)<<4|(3&p)<<6}return n;default:throw new Error(`Invalid pixel format, "${e}"`)}}Pt(Fy,"DEMData"),Pt(PC,"DemMinMaxQuadTree",{omit:["dem"]});var Uo=Uint8Array,Pg=Uint16Array,QO=Int32Array,MC=new Uo([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),NC=new Uo([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),eD=new Uo([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),RC=function(n,e){for(var i=new Pg(31),l=0;l<31;++l)i[l]=e+=1<<n[l-1];var u=new QO(i[30]);for(l=1;l<30;++l)for(var f=i[l];f<i[l+1];++f)u[f]=f-i[l]<<5|l;return{b:i,r:u}},LC=RC(MC,2),OC=LC.b,tD=LC.r;OC[28]=258,tD[258]=28;for(var rD=RC(NC,0).b,DC=new Pg(32768),wn=0;wn<32768;++wn){var Vf=(43690&wn)>>1|(21845&wn)<<1;DC[wn]=((65280&(Vf=(61680&(Vf=(52428&Vf)>>2|(13107&Vf)<<2))>>4|(3855&Vf)<<4))>>8|(255&Vf)<<8)>>1}var kg=function(n,e,i){for(var l=n.length,u=0,f=new Pg(e);u<l;++u)n[u]&&++f[n[u]-1];var p,y=new Pg(e);for(u=1;u<e;++u)y[u]=y[u-1]+f[u-1]<<1;p=new Pg(1<<e);var w=15-e;for(u=0;u<l;++u)if(n[u])for(var E=u<<4|n[u],A=e-n[u],P=y[n[u]-1]++<<A,M=P|(1<<A)-1;P<=M;++P)p[DC[P]>>w]=E;return p},Mg=new Uo(288);for(wn=0;wn<144;++wn)Mg[wn]=8;for(wn=144;wn<256;++wn)Mg[wn]=9;for(wn=256;wn<280;++wn)Mg[wn]=7;for(wn=280;wn<288;++wn)Mg[wn]=8;var jC=new Uo(32);for(wn=0;wn<32;++wn)jC[wn]=5;var iD=kg(Mg,9),nD=kg(jC,5),Lw=function(n){for(var e=n[0],i=1;i<n.length;++i)n[i]>e&&(e=n[i]);return e},Ra=function(n,e,i){var l=e/8|0;return(n[l]|n[l+1]<<8)>>(7&e)&i},Ow=function(n,e){var i=e/8|0;return(n[i]|n[i+1]<<8|n[i+2]<<16)>>(7&e)},sD=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],La=function(n,e,i){var l=new Error(e||sD[n]);if(l.code=n,Error.captureStackTrace&&Error.captureStackTrace(l,La),!i)throw l;return l},oD=new Uo(0),aD=typeof TextDecoder<"u"&&new TextDecoder;try{aD.decode(oD,{stream:!0})}catch{}const lD={gzip_data:"gzip"};class ca extends Error{constructor(e){super(e),this.name="MRTError"}}const cD={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},zC={uint32:1,uint16:2,uint8:4},uD={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Dw;class By{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new ca(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),l=new DataView(e);if(i[0]!==13)throw new ca("File is not a valid MRT.");return l.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),l=this.getHeaderLength(e);if(i.length<l)throw new ca(`Expected header with length >= ${l} but got buffer of length ${i.length}`);const u=new Dw(i.subarray(0,l)).readFields(VO,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==u.x||this.y!==u.y||this.z!==u.z))throw new ca(`Invalid attempt to parse header ${u.z}/${u.x}/${u.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=u.x,this.y=u.y,this.z=u.z;for(const f of u.layers)this.layers[f.name]=new FC(f,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],l=this.getLayer(e.layerName);for(let u of e.blockIndices){const f=l.dataIndex[u],p=f.firstByte-e.firstByte,y=f.lastByte-e.firstByte;if(l._blocksInProgress.has(u))continue;const w={layerName:l.name,firstByte:p,lastByte:y,pixelFormat:l.pixelFormat,blockIndex:u,blockShape:[f.bands.length].concat(l.bandShape),buffer:l.buffer,codec:f.codec.codec,filters:f.filters.map(E=>E.filter)};l._blocksInProgress.add(u),i.push(w)}return new BC(i,()=>{i.forEach(u=>l._blocksInProgress.delete(u.blockIndex))},(u,f)=>{if(i.forEach(p=>l._blocksInProgress.delete(p.blockIndex)),u)throw u;f.forEach(p=>{this.getLayer(p.layerName).processDecodedData(p)})})}}class FC{constructor({version:e,name:i,units:l,tileSize:u,pixelFormat:f,buffer:p,dataIndex:y},w){if(this.version=e,this.version!==1)throw new ca(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=l,this.tileSize=u,this.buffer=p,this.pixelFormat=cD[f],this.dataIndex=y,this.bandShape=[u+2*p,u+2*p,zC[this.pixelFormat]],this._decodedBlocks=new zy(w?w.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return zC[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[l,u]of this.dataIndex.entries()){for(const[f,p]of u.bands.entries())if(p===e)return{bandIndex:i+f,blockIndex:l,blockBandIndex:f};i+=u.bands.length}break;case"number":for(const[l,u]of this.dataIndex.entries()){if(e>=i&&e<i+u.bands.length)return{bandIndex:e,blockIndex:l,blockBandIndex:e-i};i+=u.bands.length}break;default:throw new ca(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,l=-1/0;const u=[],f=new Set;for(const p of e){const{blockIndex:y}=this.getBlockForBand(p);if(y<0)throw new ca(`Invalid band: ${JSON.stringify(p)}`);const w=this.dataIndex[y];u.includes(y)||u.push(y),f.add(y),i=Math.min(i,w.firstByte),l=Math.max(l,w.lastByte)}if(f.size>this.cacheSize)throw new ca(`Number of blocks to decode (${f.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:l,blockIndices:u}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:l}=this.getBlockForBand(e);if(i<0)throw new ca(`Band not found: ${JSON.stringify(e)}`);const u=this._decodedBlocks.get(i.toString());if(!u)throw new ca(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const f=this.dataIndex[i],p=this.bandShape.reduce((E,A)=>E*A,1),y=l*p,w=u.subarray(y,y+p);return{data:w,bytes:new Uint8Array(w.buffer).subarray(w.byteOffset,w.byteOffset+w.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:f.offset,scale:f.scale}}}By.setPbf=function(n){Dw=n};class BC{constructor(e,i,l){this.tasks=e,this._onCancel=i,this._onComplete=l,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}By.performDecoding=function(n,e){const i=new Uint8Array(n);return Promise.all(e.tasks.map(l=>{const{layerName:u,firstByte:f,lastByte:p,pixelFormat:y,blockShape:w,blockIndex:E,filters:A,codec:P}=l,M=i.subarray(f,p+1),O=new Uint32Array(w[0]*w[1]*w[2]);let D;if(P!=="gzip_data")throw new ca(`Unhandled codec: ${P}`);return D=function(V,G){if(!globalThis.DecompressionStream&&G==="gzip_data")return Promise.resolve(((oe=function(Se){Se[0]==31&&Se[1]==139&&Se[2]==8||La(6,"invalid gzip data");var Ce=Se[3],Ae=10;4&Ce&&(Ae+=2+(Se[10]|Se[11]<<8));for(var Qe=(Ce>>3&1)+(Ce>>4&1);Qe>0;Qe-=!Se[Ae++]);return Ae+(2&Ce)}(re=V))+8>re.length&&La(6,"invalid gzip data"),function(Se,Ce,Ae,Qe){var Oe=Se.length;if(!Oe||Ce.f&&!Ce.l)return Ae||new Uo(0);var et=!Ae,ct=et||Ce.i!=2,rt=Ce.i;et&&(Ae=new Uo(3*Oe));var st,ht,Ke=function(bi){var wi=Ae.length;if(bi>wi){var mi=new Uo(Math.max(2*wi,bi));mi.set(Ae),Ae=mi}},at=Ce.f||0,$e=Ce.p||0,Be=Ce.b||0,pt=Ce.l,ut=Ce.d,$t=Ce.m,It=Ce.n,Lt=8*Oe;do{if(!pt){at=Ra(Se,$e,1);var xt=Ra(Se,$e+1,3);if($e+=3,!xt){var Bt=Se[(ue=4+(($e+7)/8|0))-4]|Se[ue-3]<<8,sr=ue+Bt;if(sr>Oe){rt&&La(0);break}ct&&Ke(Be+Bt),Ae.set(Se.subarray(ue,sr),Be),Ce.b=Be+=Bt,Ce.p=$e=8*sr,Ce.f=at;continue}if(xt==1)pt=iD,ut=nD,$t=9,It=5;else if(xt==2){var St=Ra(Se,$e,31)+257,jt=Ra(Se,$e+10,15)+4,Kt=St+Ra(Se,$e+5,31)+1;$e+=14;for(var ur=new Uo(Kt),Ir=new Uo(19),mr=0;mr<jt;++mr)Ir[eD[mr]]=Ra(Se,$e+3*mr,7);$e+=3*jt;var Mt=Lw(Ir),hr=(1<<Mt)-1,Fr=kg(Ir,Mt);for(mr=0;mr<Kt;){var ue,de=Fr[Ra(Se,$e,hr)];if($e+=15&de,(ue=de>>4)<16)ur[mr++]=ue;else{var Ve=0,Je=0;for(ue==16?(Je=3+Ra(Se,$e,3),$e+=2,Ve=ur[mr-1]):ue==17?(Je=3+Ra(Se,$e,7),$e+=3):ue==18&&(Je=11+Ra(Se,$e,127),$e+=7);Je--;)ur[mr++]=Ve}}var wt=ur.subarray(0,St),bt=ur.subarray(St);$t=Lw(wt),It=Lw(bt),pt=kg(wt,$t),ut=kg(bt,It)}else La(1);if($e>Lt){rt&&La(0);break}}ct&&Ke(Be+131072);for(var kt=(1<<$t)-1,qt=(1<<It)-1,Cr=$e;;Cr=$e){var Ar=(Ve=pt[Ow(Se,$e)&kt])>>4;if(($e+=15&Ve)>Lt){rt&&La(0);break}if(Ve||La(2),Ar<256)Ae[Be++]=Ar;else{if(Ar==256){Cr=$e,pt=null;break}var Tr=Ar-254;Ar>264&&(Tr=Ra(Se,$e,(1<<(Sr=MC[mr=Ar-257]))-1)+OC[mr],$e+=Sr);var si=ut[Ow(Se,$e)&qt],Mi=si>>4;if(si||La(3),$e+=15&si,bt=rD[Mi],Mi>3){var Sr=NC[Mi];bt+=Ow(Se,$e)&(1<<Sr)-1,$e+=Sr}if($e>Lt){rt&&La(0);break}ct&&Ke(Be+131072);var _i=Be+Tr;if(Be<bt){var li=0-bt,Zr=Math.min(bt,_i);for(li+Be<0&&La(3);Be<Zr;++Be)Ae[Be]=(void 0)[li+Be]}for(;Be<_i;++Be)Ae[Be]=Ae[Be-bt]}}Ce.l=pt,Ce.p=Cr,Ce.b=Be,Ce.f=at,pt&&(at=1,Ce.m=$t,Ce.d=ut,Ce.n=It)}while(!at);return Be!=Ae.length&&et?(st=Ae,((ht=Be)==null||ht>st.length)&&(ht=st.length),new Uo(st.subarray(0,ht))):Ae.subarray(0,Be)}(re.subarray(oe,-8),{i:2},new Uo(((q=re)[(te=q.length)-4]|q[te-3]<<8|q[te-2]<<16|q[te-1]<<24)>>>0))));var q,te,re,oe;const xe=lD[G];if(!xe)throw new Error(`Unhandled codec: ${G}`);const ve=new globalThis.DecompressionStream(xe);return new Response(new Blob([V]).stream().pipeThrough(ve)).arrayBuffer().then(Se=>new Uint8Array(Se))}(M,P).then(V=>(function(G,q){G.readFields(ZO,q)}(new Dw(V),O),new uD[y](O.buffer))),D.then(V=>{for(let G=A.length-1;G>=0;G--)switch(A[G]){case"delta_filter":YO(V,w);break;case"zigzag_filter":KO(V);break;case"bitshuffle_filter":JO(V,y);break;default:throw new ca(`Unhandled filter "${A[G]}"`)}return{layerName:u,blockIndex:E,data:V}}).catch(V=>{throw V})}))},Pt(BC,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Pt(By,"MapboxRasterTile"),Pt(FC,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class UC{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const l=e[i];this._stringToNumber[l]=i,this._numberToString[i]=l}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const dD=["id","tile","layer","source","sourceLayer","state"];class $f{constructor(e,i,l,u,f){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=l,this._y=u,this.properties=e.properties,this.id=f}clone(){const e=new $f(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of dD)this[i]!==void 0&&(e[i]=this[i]);return e}}class VC{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Xl(vt,16,0),this.featureIndexArray=new U0,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,l,u,f,p=0,y=0){const w=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(l,u,f,p);const E=this.grid;for(let A=0;A<i.length;A++){const P=i[A],M=[1/0,1/0,-1/0,-1/0];for(let O=0;O<P.length;O++){const D=P[O];M[0]=Math.min(M[0],D.x),M[1]=Math.min(M[1],D.y),M[2]=Math.max(M[2],D.x),M[3]=Math.max(M[3],D.y)}y!==0&&(M[0]-=y,M[1]-=y,M[2]+=y,M[3]+=y),M[0]<vt&&M[1]<vt&&M[2]>=0&&M[3]>=0&&E.insert(w,M[0],M[1],M[2],M[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new nr(new py(this.rawTileData)).layers,this.sourceLayerCoder=new UC(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:l,transform:u,tileTransform:f,pixelPosMatrix:p,availableImages:y,worldview:w}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const E=l.bufferedTilespaceBounds,A=this.grid.query(E.min.x,E.min.y,E.max.x,E.max.y,(D,V,G,q)=>en(l.bufferedTilespaceGeometry,D,V,G,q));A.sort(hD);let P=null;u.elevation&&A.length>0&&(P=Ff.create(u.elevation,this.tileID));const M={};let O;for(let D=0;D<A.length;D++){const V=A[D];if(V===O)continue;O=V;const G=this.featureIndexArray.get(V);let q=null;this.is3DTile?this.loadMatchingModelFeature(M,G,e,l,u,w):this.loadMatchingFeature(M,G,e,y,w,(te,re,oe,xe=0)=>(q||(q=Et(te,this.tileID.canonical,f)),re.queryIntersectsFeature(l,te,oe,q,this.z,u,p,P,xe)))}return M}loadMatchingFeature(e,i,l,u,f,p){const{featureIndex:y,bucketIndex:w,sourceLayerIndex:E,layoutVertexArrayOffset:A}=i,P=this.bucketLayerIDs[w],M=l.layers,O=Object.keys(M);if(O.length&&!zr(O,P))return;const D=l.sourceCache,V=this.sourceLayerCoder.decode(E),G=this.vtLayers[V].feature(y),q=this.getId(G,V);for(let te=0;te<P.length;te++){const re=P[te];if(!M[re])continue;const{styleLayer:oe,targets:xe}=M[re];let ve={};q!==void 0&&(ve=D.getFeatureState(oe.sourceLayer,q));const Se=!p||p(G,oe,ve,A);if(!Se)continue;const Ce=new $f(G,this.z,this.x,this.y,q);Ce.tile=this.tileID.canonical,Ce.state=ve;let Ae=this.serializedLayersCache.get(re);Ae||(Ae=oe.serialize(),Ae.id=re,this.serializedLayersCache.set(re,Ae)),Ce.source=Ae.source,Ce.sourceLayer=Ae["source-layer"],Ce.layer=Object.assign({},Ae),Ce.layer.paint=$C(Ae.paint,oe.paint,G,ve,u),Ce.layer.layout=$C(Ae.layout,oe.layout,G,ve,u);let Qe=!1;for(const Oe of xe){this.updateFeatureProperties(Ce,Oe);const{filter:et}=Oe;if(et){if(G.properties=Ce.properties,et.needGeometry){const ct=dt(G,!0);if(!et.filter(new gi(this.tileID.overscaledZ,{worldview:f}),ct,this.tileID.canonical))continue}else if(!et.filter(new gi(this.tileID.overscaledZ,{worldview:f}),G))continue}Qe=!0,Oe.targetId&&this.addFeatureVariant(Ce,Oe)}Qe&&this.appendToResult(e,re,y,Ce,Se)}}loadMatchingModelFeature(e,i,l,u,f,p){const{featureIndex:y,bucketIndex:w}=i,E=this.bucketLayerIDs[w],A=l.layers,P=Object.keys(A);if(!P.length||zr(P,E))for(let M=0;M<E.length;M++){const O=E[M],{styleLayer:D,targets:V}=A[O];if(D.type!=="model")continue;const G=u.tile,q=G.getBucket(D);if(!(q&&q instanceof Ry))continue;const te=_O(q,y,u,f);if(!te)continue;const{z:re,x:oe,y:xe}=G.tileID.canonical,{feature:ve,intersectionZ:Se,position:Ce}=te;let Ae={};ve.id!==void 0&&(Ae=l.sourceCache.getFeatureState(D.sourceLayer,ve.id));const Qe=new $f({},re,oe,xe,ve.id);Qe.tile=this.tileID.canonical,Qe.state=Ae,Qe.properties=ve.properties,Qe.geometry={type:"Point",coordinates:[Ce.lng,Ce.lat]};let Oe=this.serializedLayersCache.get(O);Oe||(Oe=D.serialize(),Oe.id=O,this.serializedLayersCache.set(O,Oe)),Qe.source=Oe.source,Qe.sourceLayer=Oe["source-layer"],Qe.layer=Object.assign({},Oe);let et=!1;for(const ct of V){this.updateFeatureProperties(Qe,ct);const{filter:rt}=ct;if(rt){if(ve.properties=Qe.properties,rt.needGeometry){if(!rt.filter(new gi(this.tileID.overscaledZ,{worldview:p}),ve,this.tileID.canonical))continue}else if(!rt.filter(new gi(this.tileID.overscaledZ,{worldview:p}),ve))continue}et=!0,ct.targetId&&this.addFeatureVariant(Qe,ct)}et&&this.appendToResult(e,O,y,Qe,Se)}}updateFeatureProperties(e,i,l){if(i.properties){const u={};for(const f in i.properties){const p=i.properties[f].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,l);p!=null&&(u[f]=p)}e.properties=u}}addFeatureVariant(e,i,l){const u={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(u.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(u)}appendToResult(e,i,l,u,f){let p=e[i];p===void 0&&(p=e[i]=[]),p.push({featureIndex:l,feature:u,intersectionZ:f})}lookupSymbolFeatures(e,i,l,u,f,p){const y={};this.loadVTLayers();for(const w of e)this.loadMatchingFeature(y,{bucketIndex:i,sourceLayerIndex:l,featureIndex:w,layoutVertexArrayOffset:0},u,f,p);return y}loadFeature(e){const{featureIndex:i,sourceLayerIndex:l}=e;this.loadVTLayers();const u=this.sourceLayerCoder.decode(l),f=this.vtFeatures[u];if(f[i])return f[i];const p=this.vtLayers[u].feature(i);return f[i]=p,p}hasLayer(e){for(const i of this.bucketLayerIDs)for(const l of i)if(e===l)return!0;return!1}getId(e,i){let l=e.id;if(this.promoteId){const u=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(u!=null)if(Array.isArray(u)){if(!this.promoteIdExpression){const f=ra(u);if(f.result!=="success"){const p=f.value.map(y=>`${y.key}: ${y.message}`).join(", ");return void Lr(`Failed to create expression for promoteId: ${p}`)}this.promoteIdExpression=f.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Sa),l=this.promoteIdExpression.evaluate({zoom:0},e)}else l=e.properties[u];typeof l=="boolean"&&(l=Number(l))}return l}}function $C(n,e,i,l,u){return ar(n,(f,p)=>{const y=e instanceof ec?e.get(p):null;return y&&y.evaluate?y.evaluate(i,l,void 0,u):y})}function hD(n,e){return e-n}Pt(VC,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const GC=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class jw{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,l]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const u=l>>4;if(u!==1)throw new Error(`Got v${u} data when expected v1.`);const f=GC[15&l];if(!f)throw new Error("Unrecognized array type.");const[p]=new Uint16Array(e,2,1),[y]=new Uint32Array(e,4,1);return new jw(y,p,f,e)}constructor(e,i=64,l=Float64Array,u){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=l,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const f=GC.indexOf(this.ArrayType),p=2*e*this.ArrayType.BYTES_PER_ELEMENT,y=e*this.IndexArrayType.BYTES_PER_ELEMENT,w=(8-y%8)%8;if(f<0)throw new Error(`Unexpected typed array class: ${l}.`);u&&u instanceof ArrayBuffer?(this.data=u,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+w,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+p+y+w),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+w,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+f]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const l=this._pos>>1;return this.ids[l]=l,this.coords[this._pos++]=e,this.coords[this._pos++]=i,l}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return zw(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,l,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:p,nodeSize:y}=this,w=[0,f.length-1,0],E=[];for(;w.length;){const A=w.pop()||0,P=w.pop()||0,M=w.pop()||0;if(P-M<=y){for(let G=M;G<=P;G++){const q=p[2*G],te=p[2*G+1];q>=e&&q<=l&&te>=i&&te<=u&&E.push(f[G])}continue}const O=M+P>>1,D=p[2*O],V=p[2*O+1];D>=e&&D<=l&&V>=i&&V<=u&&E.push(f[O]),(A===0?e<=D:i<=V)&&(w.push(M),w.push(O-1),w.push(1-A)),(A===0?l>=D:u>=V)&&(w.push(O+1),w.push(P),w.push(1-A))}return E}within(e,i,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:f,nodeSize:p}=this,y=[0,u.length-1,0],w=[],E=l*l;for(;y.length;){const A=y.pop()||0,P=y.pop()||0,M=y.pop()||0;if(P-M<=p){for(let G=M;G<=P;G++)HC(f[2*G],f[2*G+1],e,i)<=E&&w.push(u[G]);continue}const O=M+P>>1,D=f[2*O],V=f[2*O+1];HC(D,V,e,i)<=E&&w.push(u[O]),(A===0?e-l<=D:i-l<=V)&&(y.push(M),y.push(O-1),y.push(1-A)),(A===0?e+l>=D:i+l>=V)&&(y.push(O+1),y.push(P),y.push(1-A))}return w}}function zw(n,e,i,l,u,f){if(u-l<=i)return;const p=l+u>>1;qC(n,e,p,l,u,f),zw(n,e,i,l,p-1,1-f),zw(n,e,i,p+1,u,1-f)}function qC(n,e,i,l,u,f){for(;u>l;){if(u-l>600){const E=u-l+1,A=i-l+1,P=Math.log(E),M=.5*Math.exp(2*P/3),O=.5*Math.sqrt(P*M*(E-M)/E)*(A-E/2<0?-1:1);qC(n,e,i,Math.max(l,Math.floor(i-A*M/E+O)),Math.min(u,Math.floor(i+(E-A)*M/E+O)),f)}const p=e[2*i+f];let y=l,w=u;for(Ng(n,e,l,i),e[2*u+f]>p&&Ng(n,e,l,u);y<w;){for(Ng(n,e,y,w),y++,w--;e[2*y+f]<p;)y++;for(;e[2*w+f]>p;)w--}e[2*l+f]===p?Ng(n,e,l,w):(w++,Ng(n,e,w,u)),w<=i&&(l=w+1),i<=w&&(u=w-1)}}function Ng(n,e,i,l){Fw(n,i,l),Fw(e,2*i,2*l),Fw(e,2*i+1,2*l+1)}function Fw(n,e,i){const l=n[e];n[e]=n[i],n[i]=l}function HC(n,e,i,l){const u=n-i,f=e-l;return u*u+f*f}o.$=Jp,o.A=Lo,o.B=Kc,o.C=2,o.D=Pf,o.E=zl,o.F=yg,o.G=_I,o.H=Kp,o.I=Xs,o.J=uf,o.K=ir,o.L=ld,o.M=Jh,o.N=Kh,o.O=Tm,o.P=ft,o.Q=Im,o.R=gh,o.S=tc,o.T=Jb,o.U=ra,o.V=Ny,o.W=Cm,o.X=$c,o.Y=Vc,o.Z=Fh,o._=ps,o.a=function(n){return is.API_CDN_URL_REGEX.test(n)},o.a$=me,o.a0=ad,o.a1=Wp,o.a2=df,o.a3=class extends Ny{},o.a4=Qh,o.a5=Sm,o.a6=Le,o.a7=function(n){const e=n.value;return e?ad(e)?Iw(e,!0)?[]:[new Ny(n.key,e,`invalid url "${e}"`)]:[new Ny(n.key,e,`string expected, "${ir(e)}" found`)]:[]},o.a8=E0,o.a9=$i,o.aA=be,o.aB=le,o.aC=on,o.aD=d,o.aE=Pn,o.aF=ce,o.aG=ze,o.aH=function(n,e){const i={};for(let l=0;l<e.length;l++){const u=e[l];u in n&&(i[u]=n[u])}return i},o.aI=Y,o.aJ=ge,o.aK=class{constructor(n){this.entries={},this.scheduler=n}request(n,e,i,l){const u=this.entries[n]=this.entries[n]||{callbacks:[]};if(u.result){const[f,p]=u.result;return this.scheduler?this.scheduler.add(()=>{l(f,p)},e):l(f,p),()=>{}}return u.callbacks.push(l),u.cancel||(u.cancel=i((f,p)=>{u.result=[f,p];for(const y of u.callbacks)this.scheduler?this.scheduler.add(()=>{y(f,p)},e):y(f,p);setTimeout(()=>delete this.entries[n],3e3)})),()=>{u.result||(u.callbacks=u.callbacks.filter(f=>f!==l),u.callbacks.length||(u.cancel(),delete this.entries[n]))}}},o.aL=function(n,e,i){const l=JSON.stringify(n.request);return n.data&&(this.deduped.entries[l]={result:[null,n.data]}),this.deduped.request(l,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},u=>{const f=kc(n.request,(p,y,w,E)=>{p?u(p):y&&u(null,{vectorTile:i?void 0:new nr(new py(y)),rawData:y,cacheControl:w,expires:E})});return()=>{f.cancel(),u()}},e)},o.aM=function(n){Ka++,Ka>wa&&(n.getActor().send("enforceCacheSizeLimit",ko),Ka=0)},o.aN=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log2(n)))},o.aO=_s,o.aP=HI,o.aQ=JI,o.aR=U,o.aS=qI,o.aT=function(n,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let l=0;l<n.length;l++){const u=document.createElement("source");X_(n[l])||(i.crossOrigin="Anonymous"),u.src=n[l],i.appendChild(u)}return{cancel:()=>{}}},o.aU=hg,o.aV=function(n){return fetch(n).then(e=>e.arrayBuffer()).then(e=>wE(e,0,n))},o.aW=kE,o.aX=class{constructor(n,e,i,l){this.id=n,this.position=e!=null?new U(e[0],e[1]):new U(0,0),this.orientation=i??[0,0,0],this.nodes=l,this.uploaded=!1,this.aabb=new Qt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(n,e){if(le(n.matrix,e,n.matrix),n.meshes)for(const i of n.meshes){const l=Qt.applyTransformFast(i.aabb,n.matrix);this.aabb.encapsulate(l)}if(n.children)for(const i of n.children)this._applyTransformations(i,n.matrix)}computeBoundsAndApplyParent(){const n=ae([]);for(const e of this.nodes)this._applyTransformations(e,n)}computeModelMatrix(n,e,i,l,u,f,p=!1){AE(this.matrix,this,n.transform,this.position,e,i,l,u,f,p)}upload(n){if(!this.uploaded){for(const e of this.nodes)tw(e,n);for(const e of this.nodes)fy(e);this.uploaded=!0}}destroy(){for(const n of this.nodes)rw(n)}},o.aY=tr,o.aZ=bg,o.a_=_e,o.aa=mt,o.ab=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return hn(n.expression.evaluate(e))}interpolate(n,e,i){return{x:Yt(n.x,e.x,i),y:Yt(n.y,e.y,i),z:Yt(n.z,e.z,i),azimuthal:Yt(n.azimuthal,e.azimuthal,i),polar:Yt(n.polar,e.polar,i)}}},o.ac=gi,o.ad=al,o.ae=He,o.af=or,o.ag=fr,o.ah=Ge,o.ai=ec,o.aj=ou,o.ak=Yt,o.al=vt,o.am=Xp,o.an=Re,o.ao=ti,o.ap=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return function([i,l]){const u=hn([1,i,l]);return{x:u.x,y:u.y,z:u.z}}(n.expression.evaluate(e))}interpolate(n,e,i){return{x:Yt(n.x,e.x,i),y:Yt(n.y,e.y,i),z:Yt(n.z,e.z,i)}}},o.aq=function(n,e,i=0,l=!0){const u=new ft(i,i),f=n.sub(u),p=e.add(u),y=[f,new ft(p.x,f.y),p,new ft(f.x,p.y)];return l&&y.push(f.clone()),y},o.ar=function(n,e){const i=[];for(let l=0;l<n.length;l++){const u=Me(l-1,-1,n.length-1),f=Me(l+1,-1,n.length-1),p=n[l],y=n[f],w=n[u].sub(p).unit(),E=y.sub(p).unit(),A=E.angleWithSep(w.x,w.y),P=w.add(E).unit().mult(-1*e/Math.sin(A/2));i.push(p.add(P))}return i},o.as=MI,o.at=en,o.au=function(n,e,i=0){return dr(((e.x-i)*n.scale-n.x)*vt,(e.y*n.scale-n.y)*vt,fe(e.z,e.y))},o.av=Gr,o.aw=Yr,o.ax=Wr,o.ay=VE,o.az=function(n){let e=1/0,i=1/0,l=-1/0,u=-1/0;for(const f of n)e=Math.min(e,f.x),i=Math.min(i,f.y),l=Math.max(l,f.x),u=Math.max(u,f.y);return{min:new ft(e,i),max:new ft(l,u)}},o.b=function(n){return is.API_FONTS_REGEX.test(n)},o.b$=Bb,o.b0=ic,o.b1=bn,o.b2=ot,o.b3=Hm,o.b4=Ay,o.b5=function(){ia.isLoading()||ia.isLoaded()||cf()!=="deferred"||Yl()},o.b6=xd,o.b7=dt,o.b8=$f,o.b9=Qr,o.bA=ae,o.bB=Xe,o.bC=ie,o.bD=function(n,e){const{x:i,y:l}=n.point,u=uT(i,l,n.worldSize/n._pixelsPerMercatorPixel,0,0);return le(u,u,Cb(yl(e)))},o.bE=Z,o.bF=Di,o.bG=function(n,e){var i=e[0]-n[0],l=e[1]-n[1],u=e[2]-n[2];return Math.sqrt(i*i+l*l+u*u)},o.bH=Nr,o.bI=Vi,o.bJ=vi,o.bK=_g,o.bL=io,o.bM=fw,o.bN=function(n,e,i,l,u){const f=5*e+2;n.float32[f+0]=i,n.float32[f+1]=l,n.float32[f+2]=u},o.bO=Cy,o.bP=Ao,o.bQ=xa,o.bR=Za,o.bS=Po,o.bT=Me,o.bU=function(n,e,i,l){var u=new F(4);return u[0]=n,u[1]=e,u[2]=i,u[3]=l,u},o.bV=oy,o.bW=eo,o.bX=Fn,o.bY=UT,o.bZ=QI,o.b_=qT,o.ba=ow,o.bb=jb,o.bc=Et,o.bd=hl,o.be=vf,o.bf=nT,o.bg=Fi,o.bh=Cf,o.bi=Tw,o.bj=function(n,e){const i=ou(e.zoom);if(i===0)return yl(n);const l=X0(n),u=Ib(l),f=ce(l.getWest())*e.worldSize,p=ce(l.getEast())*e.worldSize,y=ge(l.getNorth())*e.worldSize,w=ge(l.getSouth())*e.worldSize,E=[f,y,0],A=[p,y,0],P=[f,w,0],M=[p,w,0],O=ke([],e.globeMatrix);return or(E,E,O),or(A,A,O),or(P,P,O),or(M,M,O),u[0]=ac(u[0],P,i),u[1]=ac(u[1],M,i),u[2]=ac(u[2],A,i),u[3]=ac(u[3],E,i),Qt.fromPoints(u)},o.bk=K0,o.bl=ke,o.bm=Ym,o.bn=ac,o.bo=rc,o.bp=BR,o.bq=tt,o.br=se,o.bs=By,o.bt=py,o.bu=kc,o.bv=function(n,e){const i=[];for(const l in n)l in e||i.push(l);return i},o.bw=qe,o.bx=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.by=va,o.bz=function(n){var e=new F(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e},o.c=Z_,o.c$=function(n){return n*n*n*n*n},o.c0=hw,o.c1=TI,o.c2=_w,o.c3=jw,o.c4=rr,o.c5=Zn,o.c6=Ts,o.c7=function(n,e,i){i*=.5;var l=e[0],u=e[1],f=e[2],p=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=l*w+u*y,n[1]=u*w-l*y,n[2]=f*w+p*y,n[3]=p*w-f*y,n},o.c8=Co,o.c9=Zi,o.cA=wr,o.cB=TE,o.cC=ka,o.cD=aT,o.cE=function(n,e,i,l,u,f,p,y,w){if(w.name==="globe")return aT(n,e,new ka(i,l,u),!1);const E=bg({z:i,x:l,y:u},w);return new Qt([(f+E.x/E.scale)*e,e*(E.y/E.scale),p],[(f+E.x2/E.scale)*e,e*(E.y2/E.scale),y])},o.cF=function(n,e,i){return n[0]=Math.min(e[0],i[0]),n[1]=Math.min(e[1],i[1]),n[2]=Math.min(e[2],i[2]),n[3]=Math.min(e[3],i[3]),n},o.cG=function(n,e,i){return n[0]=Math.max(e[0],i[0]),n[1]=Math.max(e[1],i[1]),n[2]=Math.max(e[2],i[2]),n[3]=Math.max(e[3],i[3]),n},o.cH=function(n){const e=Math.round((n+45+360)%360/90)%4;return Q[e]},o.cI=ye,o.cJ=In,o.cK=_,o.cL=function(n){const e=ae(new Float64Array(16));le(e,n.pixelMatrix,n.globeMatrix);const i=[0,k,0],l=[0,N,0];return or(i,i,e),or(l,l,e),[i[0]>0&&i[0]<=n.width&&i[1]>0&&i[1]<=n.height&&!Pb(n,new U(n.center.lat,90)),l[0]>0&&l[0]<=n.width&&l[1]>0&&l[1]<=n.height&&!Pb(n,new U(n.center.lat,-90))]},o.cM=function(n,e){const{scale:i}=n.tileTransform,l=i*vt/(n.tileSize*Math.pow(2,e.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return function(u,f,p){var y=f[1],w=f[2],E=f[3],A=p[0],P=p[1];return u[0]=f[0]*A,u[1]=y*A,u[2]=w*P,u[3]=E*P,u}(new Float32Array(4),e.inverseAdjustmentMatrix,[l,l])},o.cN=dy,o.cO=Ct,o.cP=SE,o.cQ=function(n){const e=SE(n,!0);return Z([],[e[0],e[1],e[4],e[5]])},o.cR=J,o.cS=Jr,o.cT=Ee,o.cU=function(n){const{x:e,y:i}=n.point,{lng:l,lat:u}=n._center;return uT(e,i,n.worldSize,l,u)},o.cV=Ht,o.cW=X,o.cX=If,o.cY=Xn,o.cZ=g,o.c_=function(n,e,i){let l=0;for(let u=0;u<2;++u)n[u]>0&&(l+=(n[u]-0)*(n[u]-0)),e[u]<0&&(l+=(0-e[u])*(0-e[u]));return l},o.ca=function(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n},o.cb=We,o.cc=function(n,e,i,l,u){var f=1/Math.tan(e/2);if(n[0]=f/i,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=f,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,u!=null&&u!==1/0){var p=1/(l-u);n[10]=(u+l)*p,n[14]=2*u*l*p}else n[10]=-1,n[14]=-2*l;return n},o.cd=function(n,e,i,l,u,f,p){var y=1/(e-i),w=1/(l-u),E=1/(f-p);return n[0]=-2*y,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*w,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*E,n[11]=0,n[12]=(e+i)*y,n[13]=(u+l)*w,n[14]=(p+f)*E,n[15]=1,n},o.ce=pe,o.cf=function(n,e,i){n[4*e+0]=i[0],n[4*e+1]=i[1],n[4*e+2]=i[2],n[4*e+3]=i[3]},o.cg=Cd,o.ch=Ad,o.ci=Qi,o.cj=sa,o.ck=kd,o.cl=DI,o.cm=function(){var n=new F(4);return F!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n},o.cn=function(n,e,i){var l=e[0],u=e[1],f=e[2],p=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=l*w+f*y,n[1]=u*w+p*y,n[2]=l*-y+f*w,n[3]=u*-y+p*w,n},o.co=function(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]},o.cp=oi,o.cq=function(n){var e=n[0],i=n[1],l=n[2],u=n[3];return Math.sqrt(e*e+i*i+l*l+u*u)},o.cr=ya,o.cs=$r,o.ct=Ef,o.cu=3,o.cv=2,o.cw=7,o.cx=6,o.cy=Vn,o.cz=Nt,o.d=function(n){return is.API_TILEJSON_REGEX.test(n)},o.d$=HE,o.d0=ne,o.d1=45,o.d2=Pd,o.d3=function(n,e,i){const l=Math.sqrt(n*n+e*e+i*i),u=l>0?Math.acos(i/l)*Ec:0;let f=n!==0||e!==0?Math.atan2(-e,-n)*Ec+90:0;return f<0&&(f+=360),[l,f,u]},o.d4=dr,o.d5=hn,o.d6=De,o.d7=Ut,o.d8=Qt,o.d9=jr,o.dA=function(n,e,i){const l=ou(i.zoom),u=n.style.map._antialias,f=n.terrain&&n.terrain.exaggeration()>0;return l===0&&!u&&!f},o.dB=function(n){const e=n.pixelsPerMeter,i=e/pe(1,n.center.lat),l=ae(new Float64Array(16));return se(l,l,[n.point.x,n.point.y,0]),J(l,l,[i,i,e]),Float32Array.from(l)},o.dC=X0,o.dD=function(n){const e=ye-5;n=be(n,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(Re(n))),3);return Math.round(i*(I.length-1))},o.dE=function(n,e,i,l){const u=e.getNorth(),f=e.getSouth(),p=e.getWest(),y=e.getEast(),w=1<<n.z,E=y-p,A=u-f,P=E/T,M=-A/I[i],O=[0,P,0,M,0,0,u,p,0];if(n.z>0){const D=180/l;ee(O,O,[D/E+1,0,0,0,D/A+1,0,-.5*D/P,.5*D/M,1])}return O[2]=w,O[5]=n.x,O[8]=n.y,O},o.dF=yl,o.dG=function(n,e,i){const l=ae(new Float64Array(16)),u=(e/(1<<n)-.5)*Math.PI*2;return je(l,i.globeMatrix,u),Float32Array.from(l)},o.dH=class{isDataAvailableAtPoint(n){const e=this._source();if(this.isUsingMockSource()||!e||n.y<0||n.y>1)return!1;const i=e.getSource().maxzoom,l=1<<i,u=Math.floor(n.x),f=Math.floor((n.x-u)*l),p=Math.floor(n.y*l),y=this.findDEMTileFor(new _s(i,u,i,f,p));return!(!y||!y.dem)}getAtPointOrZero(n,e=0){return this.getAtPoint(n,e)||0}getAtPoint(n,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const l=this._source();if(!l||n.y<0||n.y>1)return e;const u=l.getSource().maxzoom,f=1<<u,p=Math.floor(n.x),y=n.x-p,w=new _s(u,p,u,Math.floor(y*f),Math.floor(n.y*f)),E=this.findDEMTileFor(w);if(!E||!E.dem)return e;const A=E.dem,P=1<<E.tileID.canonical.z,M=(y*P-E.tileID.canonical.x)*A.dim,O=(n.y*P-E.tileID.canonical.y)*A.dim,D=Math.floor(M),V=Math.floor(O);return(i?this.exaggeration():1)*Yt(Yt(A.get(D,V),A.get(D,V+1),O-V),Yt(A.get(D+1,V),A.get(D+1,V+1),O-V),M-D)}getAtTileOffset(n,e,i){const l=1<<n.canonical.z;return this.getAtPointOrZero(new He(n.wrap+(n.canonical.x+e/vt)/l,(n.canonical.y+i/vt)/l))}getAtTileOffsetFunc(n,e,i,l){return u=>{const f=this.getAtTileOffset(n,u.x,u.y),p=l.upVector(n.canonical,u.x,u.y);return rr(p,p,f*l.upVectorScale(n.canonical,e,i).metersToTile),p}}getForTilePoints(n,e,i,l){if(this.isUsingMockSource())return!1;const u=Ff.create(this,n,l);return!!u&&(e.forEach(f=>{f[2]=this.exaggeration()*u.getElevationAt(f[0],f[1],i)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(n);if(!e||!e.dem)return null;const i=e.dem.tree,l=e.tileID,u=1<<n.canonical.z-l.canonical.z;let f=n.canonical.x/u-l.canonical.x,p=n.canonical.y/u-l.canonical.y,y=0;for(let w=0;w<n.canonical.z-l.canonical.z&&!i.leaves[y];w++){f*=2,p*=2;const E=2*Math.floor(p)+Math.floor(f);y=i.childOffsets[y]+E,f%=1,p%=1}return{min:this.exaggeration()*i.minimums[y],max:this.exaggeration()*i.maximums[y]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let e=!1,i=Number.MAX_VALUE,l=Number.MIN_VALUE;for(const u of n){const f=this.getMinMaxForTile(u.tileID);f&&(i=Math.min(i,f.min),l=Math.max(l,f.max),e=!0)}return e?{min:i,max:l}:null}},o.dI=ST,o.dJ=Z0,o.dK=function(n,e){return[Math.pow(n[0],2.2)*e,Math.pow(n[1],2.2)*e,Math.pow(n[2],2.2)*e]},o.dL=$,o.dM=function(n,e){var i=Math.sin(e),l=Math.cos(e);return n[0]=l,n[1]=i,n[2]=0,n[3]=-i,n[4]=l,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},o.dN=pr,o.dO=cT,o.dP=ds,o.dQ=qs,o.dR=256,o.dS=function(n,e){const i=[0,0,0];return or(i,i,K0(yl(e.canonical))),or(i,i,n),i},o.dT=n=>({u_matrix:new kd(n),u_texsize:new sa(n),u_pixels_to_tile_units:new Tf(n),u_device_pixel_ratio:new Qi(n),u_width_scale:new Qi(n),u_floor_width_scale:new Qi(n),u_image:new Cd(n),u_units_to_pixels:new sa(n),u_tile_units_to_pixels:new Qi(n),u_alpha_discard_threshold:new Qi(n),u_trim_offset:new sa(n),u_trim_fade_range:new sa(n),u_trim_color:new Pd(n),u_emissive_strength:new Qi(n),u_zbias_factor:new Qi(n),u_tile_to_meter:new Qi(n),u_ground_shadow_factor:new Ad(n),u_pattern_transition:new Qi(n)}),o.dU=n=>({u_matrix:new kd(n),u_pixels_to_tile_units:new Tf(n),u_device_pixel_ratio:new Qi(n),u_width_scale:new Qi(n),u_floor_width_scale:new Qi(n),u_units_to_pixels:new sa(n),u_dash_image:new Cd(n),u_gradient_image:new Cd(n),u_image_height:new Qi(n),u_texsize:new sa(n),u_tile_units_to_pixels:new Qi(n),u_alpha_discard_threshold:new Qi(n),u_trim_offset:new sa(n),u_trim_fade_range:new sa(n),u_trim_color:new Pd(n),u_emissive_strength:new Qi(n),u_zbias_factor:new Qi(n),u_tile_to_meter:new Qi(n),u_ground_shadow_factor:new Ad(n)}),o.dV=n=>({u_camera_to_center_distance:new Qi(n),u_extrude_scale:new Tf(n),u_device_pixel_ratio:new Qi(n),u_matrix:new kd(n),u_inv_rot_matrix:new kd(n),u_merc_center:new sa(n),u_tile_id:new Ad(n),u_zoom_transition:new Qi(n),u_up_dir:new Ad(n),u_emissive_strength:new Qi(n)}),o.dW=Um,o.dX=EL,o.dY=class{constructor(n,e,i,l){this.context=n,this.format=l,this.size=i,this.texture=n.gl.createTexture();const[u,f,p]=this.size,{gl:y}=n;y.bindTexture(y.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in e&&e.data&&y.texImage3D(y.TEXTURE_3D,0,this.format,u,f,p,0,Yb(this.format),Kb(this.format),e.data)}bind(n,e){const{context:i}=this,{gl:l}=i;l.bindTexture(l.TEXTURE_3D,this.texture),n!==this.minFilter&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MAG_FILTER,n),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MIN_FILTER,n),this.minFilter=n),e!==this.wrapS&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_S,e),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},o.dZ=fT,o.d_=(n,e,i,l,u,f)=>{const p=n.transform,y=p.projection.name==="globe";let w;if(f.paint.get("circle-pitch-alignment")==="map")if(y){const A=cT(p.zoom,e.canonical)*p._pixelsPerMercatorPixel;w=Float32Array.from([A,0,0,A])}else w=p.calculatePixelsToTileUnitsMatrix(i);else w=new Float32Array([p.pixelsToGLUnits[0],0,0,p.pixelsToGLUnits[1]]);const E={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(p.projection),u_matrix:n.translatePosMatrix(e.projMatrix,i,f.paint.get("circle-translate"),f.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Qo.devicePixelRatio,u_extrude_scale:w,u_inv_rot_matrix:qR,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:f.paint.get("circle-emissive-strength")};if(y){E.u_inv_rot_matrix=l,E.u_merc_center=u,E.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],E.u_zoom_transition=ou(p.zoom);const A=u[0]*vt,P=u[1]*vt;E.u_up_dir=p.projection.upVector(new ka(0,0,0),A,P)}return E},o.da=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},o.db=Iw,o.dc=function(n,e){return n.readFields(vO,{icons:[]},e)},o.dd=ay,o.de=Df,o.df=mw,o.dg=_h,o.dh=T0,o.di=ph,o.dj=vh,o.dk=Mr,o.dl=function(n){const e=n.indexOf(vd);return e>=0?n.slice(0,e):n},o.dm=function(n){return n.indexOf(vd)>=0},o.dn=function(n){const e=n.lastIndexOf(vd);return e>=0?n.slice(e+1):""},o.dp=function(n){const e=[],i=n.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),n.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},o.dq=function(n,e,i,l){return n.type==="custom"?new pO(n,e):new yO[n.type](n,e,i,l)},o.dr=Rr,o.ds=function(n){const e=n.indexOf(vd);return e>=0?n.slice(e+1):""},o.dt=class extends $f{constructor(n,e){super(n._vectorTileFeature,n._z,n._x,n._y,n.id),n.state&&(this.state=Object.assign({},n.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=n.source,this.sourceLayer=n.sourceLayer,this.layer=n.layer)}toJSON(){const n=super.toJSON();return n.target=this.target,n.namespace=this.namespace,n}},o.du=Nm,o.dv=Ur,o.dw=function(n){return n({pluginStatus:ms,pluginURL:ul}),Nm.on("pluginStateChange",n),n},o.dx=q0,o.dy=class extends na{constructor(n){super(n),this.current=Sb}set(n,e,i){if(this.fetchUniformLocation(n,e)){for(let l=0;l<9;l++)if(i[l]!==this.current[l]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},o.dz=he,o.e=is,o.e$=function(){const n=cg;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(qb),cg=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},o.e0=Is,o.e1=(n,e,i,l,u,f,p,y,w,E)=>{const A=n.transform,P=A.pitch<15?$E(.07,.7,be((14-A.zoom)/5,0,1)):.07,M=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:qE(n,e,i,l),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:A.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:u,u_width_scale:f,u_floor_width_scale:p,u_image:0,u_tile_units_to_pixels:GE(e,A),u_units_to_pixels:[1/A.pixelsToGLUnits[0],1/A.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(M?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:P,u_tile_to_meter:De(e.tileID.canonical,0),u_ground_shadow_factor:w,u_pattern_transition:E}},o.e2=(n,e,i,l,u,f,p,y,w,E)=>{const A=n.transform,P=A.calculatePixelsToTileUnitsMatrix(e),M=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",O=A.pitch<15?$E(.07,.7,be((14-A.zoom)/5,0,1)):.07;return{u_matrix:qE(n,e,i,l),u_pixels_to_tile_units:P,u_device_pixel_ratio:f,u_width_scale:p,u_floor_width_scale:y,u_units_to_pixels:[1/A.pixelsToGLUnits[0],1/A.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:u,u_texsize:WE(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:GE(e,n.transform),u_alpha_discard_threshold:0,u_trim_offset:w,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(M?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:O,u_tile_to_meter:De(e.tileID.canonical,0),u_ground_shadow_factor:E}},o.e3=Gt,o.e4=Km,o.e5=fe,o.e6=zR,o.e7=sy,o.e8=iE,o.e9=lu,o.eA=pn,o.eB=ru,o.eC=function(n,e,i,l,u,f,p,y,w,E,A,P,M,O,D,V){var G=new F(16);return G[0]=n,G[1]=e,G[2]=i,G[3]=l,G[4]=u,G[5]=f,G[6]=p,G[7]=y,G[8]=w,G[9]=E,G[10]=A,G[11]=P,G[12]=M,G[13]=O,G[14]=D,G[15]=V,G},o.eD=z,o.eE=Sd,o.eF=yf,o.eG=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ft(1/0,1/0),max:new ft(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,e=!1){const i=$T(new ft(0,0),new ft(vt,vt),n),l=[];if(e&&!zb(i,this._globalClipBounds))return l;for(const u of this._activeRegions){if(u.hiddenByOverlap||!zb(i,u))continue;const f=x3(u.min,u.max,n);l.push({min:f.min,max:f.max,sourceId:this._sourceIds[u.priority],footprint:u.footprint,footprintTileId:u.tileId,order:u.order,clipMask:u.clipMask,clipScope:u.clipScope})}return l}setSources(n){this._setSources(n.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const l of e.cache.getVisibleCoordinates()){const u=e.cache.getTile(l).buckets[e.layer];u&&u.updateFootprints(l.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(n){const e=n.getFootprints();if(e.length===0)return;const i=n.getOrder(),l=n.getClipMask(),u=n.getClipScope();for(const f of e){if(!f.footprint)continue;const p=$T(f.footprint.min,f.footprint.max,f.id);this._activeRegions.push({min:p.min,max:p.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:f.id,footprint:f.footprint,order:i,clipMask:l,clipScope:u})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||ry(e.min,i.min)||ry(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(l,u){const f=(p,y)=>p+y;return l.length-u.length||l.reduce(f,"").localeCompare(u.reduce(f,""))}(e.clipScope,i.clipScope));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let e=0;for(;!n&&e!==this._activeRegions.length;){const i=this._activeRegions[e],l=this._prevRegions[e];n=i.priority!==l.priority||!VT(i,l)||i.order!==l.order||i.clipMask!==l.clipMask||!va(i.clipScope,l.clipScope),++e}}if(n){++this._updateTime;for(const i of this._activeRegions)i.order!==ig&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const l=this._activeRegions;if(i>=l.length)return i;const u=l[i].priority;for(;i<l.length&&l[i].priority===u;)++i;return i};if(this._sourceIds.length>1){let i=0,l=e(i);for(;i!==l;){let u=i;const f=i;for(;u!==l;){const p=this._activeRegions[u];p.hiddenByOverlap=!1;for(let y=0;y<f;y++){const w=this._activeRegions[y];if(!w.hiddenByOverlap&&p.order===ig&&zb(p,w)&&(p.hiddenByOverlap=GT(p.footprint,p.tileId,w.footprint,w.tileId),p.hiddenByOverlap))break}++u}i=l,l=e(i)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=n.length-1;e>=0;e--)this._addSource(n[e]);this._computeReplacement()}},o.eH=ig,o.eI=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,e){const i=new hl,l=new bn,u=[],f=n+1+2,p=e[0]+1,y=e[0]+1+(1+e.length),w=(E,A,P)=>{let M=E===f-1?E-2:E===0?E:E-1;return M+=P?24575:0,[M,A]};for(let E=0;E<f;++E)i.emplaceBack(...w(E,0,!0));for(let E=0;E<p;++E)for(let A=0;A<f;++A)i.emplaceBack(...w(A,E,(A===0||A===f-1)&&!0));for(let E=0;E<e.length;++E){const A=e[E];for(let P=0;P<f;++P)i.emplaceBack(...w(P,A,!0))}for(let E=0;E<e.length;++E){const A=l.length,P=e[E]+1+2,M=new bn;for(let V=0;V<P-1;V++){const G=V===P-2,q=G?f*(y-e.length+E-V):f;for(let te=0;te<f-1;te++){const re=V*f+te;V===0||G||te===0||te===f-2?(M.emplaceBack(re+1,re,re+q),M.emplaceBack(re+q,re+q+1,re+1)):(l.emplaceBack(re+1,re,re+q),l.emplaceBack(re+q,re+q+1,re+1))}}const O=Fi.simpleSegment(0,A,i.length,l.length-A);for(let V=0;V<M.uint16.length;V+=3)l.emplaceBack(M.uint16[V],M.uint16[V+1],M.uint16[V+2]);const D=Fi.simpleSegment(0,A,i.length,l.length-A);u.push({withoutSkirts:O,withSkirts:D})}return{vertices:i,indices:l,segments:u}}_createGrid(n){const e=this._fillGridMeshWithLods(T,I);this._gridSegments=e.segments,this._gridBuffer=n.createVertexBuffer(e.vertices,nT.members),this._gridIndexBuffer=n.createIndexBuffer(e.indices,!0)}_createPoles(n){const e=new bn;for(let p=0;p<=T;p++)e.emplaceBack(0,p+1,p+2);this._poleIndexBuffer=n.createIndexBuffer(e,!0);const i=new nc,l=new nc,u=new nc,f=new nc;this._poleSegments=[];for(let p=0,y=0;p<g;p++){const w=360/(1<<p);i.emplaceBack(0,-d,0,.5,0),l.emplaceBack(0,-d,0,.5,1),u.emplaceBack(0,-d,0,.5,.5),f.emplaceBack(0,-d,0,.5,.5);for(let E=0;E<=T;E++){let A=E/T,P=0;const M=Yt(0,w,A),[O,D,V]=j($R,GR,M,d);i.emplaceBack(O,D,V,A,P),l.emplaceBack(O,D,V,A,1-P);const G=Re(M);A=.5+.5*Math.sin(G),P=.5+.5*Math.cos(G),u.emplaceBack(O,D,V,A,P),f.emplaceBack(O,D,V,A,1-P)}this._poleSegments.push(Fi.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(i,W0,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(l,W0,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(u,W0,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(f,W0,!1)}getGridBuffers(n,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},o.eJ=BT,o.eK=Te,o.eL=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},o.eM=we,o.eN=Ze,o.eO=function(n,e,i){return n[0]=e[0]/i[0],n[1]=e[1]/i[1],n[2]=e[2]/i[2],n},o.eP=un,o.eQ=R,o.eR=us,o.eS=cr,o.eT=function([n,e,i]){const l=Math.hypot(n,e,i),u=Math.atan2(n,i),f=.5*Math.PI-Math.acos(-e/l);return new U(X(u),X(f))},o.eU=ji,o.eV=Qb,o.eW=function(n){const e=n.navigator?n.navigator.userAgent:null;return!!function(i){if(Wi==null){const l=i.navigator?i.navigator.userAgent:null;Wi=!!i.safari||!(!l||!(/\b(iPad|iPhone|iPod)\b/.test(l)||l.match("Safari")&&!l.match("Chrome")))}return Wi}(n)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},o.eX=function(n,e){ko=n,wa=e},o.eY=Pb,o.eZ=dT,o.e_=function(n){const e=[0,0,0],i=ae(new Float64Array(16));return le(i,n.pixelMatrix,n.globeMatrix),or(e,e,i),new ft(e[0],e[1])},o.ea=450,o.eb=7,o.ec=Pe,o.ed=function(n,e){if(n===e){var i=e[1],l=e[2],u=e[3],f=e[6],p=e[7],y=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=i,n[6]=e[9],n[7]=e[13],n[8]=l,n[9]=f,n[11]=e[14],n[12]=u,n[13]=p,n[14]=y}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n},o.ee=fO,o.ef=Dr,o.eg=nu,o.eh=256,o.ei=Cb,o.ej=As,o.ek=je,o.el=function(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n},o.em=nc,o.en=Gm,o.eo=xm,o.ep=function(n,e,i,l,u){return be((n-e)/(i-e)*(u-l)+l,l,u)},o.eq=Rl,o.er=function(n,e){var i=e[0],l=e[1],u=e[2],f=e[3],p=e[4],y=e[5],w=e[6],E=e[7],A=e[8],P=A*p-y*E,M=-A*f+y*w,O=E*f-p*w,D=i*P+l*M+u*O;return D?(n[0]=P*(D=1/D),n[1]=(-A*l+u*E)*D,n[2]=(y*l-u*p)*D,n[3]=M*D,n[4]=(A*i-u*w)*D,n[5]=(-y*i+u*f)*D,n[6]=O*D,n[7]=(-E*i+l*w)*D,n[8]=(p*i-l*f)*D,n):null},o.es=2,o.et=rs,o.eu=ew,o.ev=[1,1,1],o.ew=Ff,o.ex=po,o.ey=function(n,e,i,l){var u=e[0],f=e[1],p=e[2],y=e[3];return n[0]=u+l*(i[0]-u),n[1]=f+l*(i[1]-f),n[2]=p+l*(i[2]-p),n[3]=y+l*(i[3]-y),n},o.ez=Rf,o.f=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},o.f0=function(){ay().acquire(qb)},o.f1=cf,o.f2=function(n,e,i=!1){if(ms===Rs.deferred||ms===Rs.loading||ms===Rs.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");ul=Qo.resolveURL(n),ms=Rs.deferred,km=e,Mm(),i||Yl()},o.f3=function(n){kf=Qo.resolveURL(n),Mf||(Mf=new Pf(ay(),new zl)),Mf.broadcast("setMeshoptUrl",kf)},o.f4=gE,o.f5=function(n){Wb=Qo.resolveURL(n),Mf||(Mf=new Pf(ay(),new zl)),Mf.broadcast("setDracoUrl",Wb)},o.f6=mE,o.f7=lg,o.f8=function(n){const e=Vp();if(!e)return;const i=e.delete(Hs);n&&i.then(()=>n()).catch(n)},o.f9=Ld,o.fA=function(n){Ku(),hs!=null&&hs.then(e=>{e.keys().then(i=>{for(let l=0;l<i.length-n;l++)e.delete(i[l]).catch(u=>Lr(u.message))}).catch(i=>Lr(i.message))}).catch(e=>Lr(e.message))},o.fa=Pt,o.fb=au,o.fc=Na,o.fd=UC,o.fe=VC,o.ff=FE,o.fg=br,o.fh="hd_road_elevation",o.fi=Ri,o.fj=ar,o.fk=lc,o.fl=pw,o.fm=jd,o.fn=function(n,e,i,l,u,f,p,y=1,w,E,A){n.createArrays(),n.tilePixelRatio=vt/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const P=n.layers[0].layout,M=n.layers[0]._unevaluatedLayout._values,O={};O.scaleFactor=y,O.textSizeScaleRange=P.get("text-size-scale-range"),O.iconSizeScaleRange=P.get("icon-size-scale-range");const[D,V]=O.textSizeScaleRange,[G,q]=O.iconSizeScaleRange;O.textScaleFactor=be(O.scaleFactor,D,V),O.iconScaleFactor=be(O.scaleFactor,G,q);const te=M["text-size"],re=M["icon-size"];if(n.textSizeData.kind==="composite"){const{minZoom:Ae,maxZoom:Qe}=n.textSizeData;O.compositeTextSizes=[te.possiblyEvaluate(new gi(Ae,{worldview:A}),f),te.possiblyEvaluate(new gi(Qe,{worldview:A}),f)]}if(n.iconSizeData.kind==="composite"){const{minZoom:Ae,maxZoom:Qe}=n.iconSizeData;O.compositeIconSizes=[re.possiblyEvaluate(new gi(Ae,{worldview:A}),f),re.possiblyEvaluate(new gi(Qe,{worldview:A}),f)]}O.layoutTextSize=te.possiblyEvaluate(new gi(p+1,{worldview:A}),f),O.layoutIconSize=re.possiblyEvaluate(new gi(p+1,{worldview:A}),f),O.textMaxSize=te.possiblyEvaluate(new gi(18,{worldview:A}),f);const oe=P.get("symbol-placement"),xe=P.get("text-rotation-alignment")==="map"&&oe!=="point",ve=P.get("text-size");let Se=!1;const Ce=[];for(const Ae of n.features){const Qe=P.get("text-font").evaluate(Ae,{},f).join(","),Oe=ve.evaluate(Ae,{},f)*O.textScaleFactor,et=O.layoutTextSize.evaluate(Ae,{},f)*O.textScaleFactor,ct=O.layoutIconSize.evaluate(Ae,{},f)*O.iconScaleFactor,rt={horizontal:{},vertical:void 0},st=Ae.text;let ht,Ke=[0,0];if(st){const jt=st.toString(),Kt=P.get("text-letter-spacing").evaluate(Ae,{},f)*Fn,ur=P.get("text-line-height").evaluate(Ae,{},f)*Fn,Ir=w0(jt)?Kt:0,mr=P.get("text-anchor").evaluate(Ae,{},f),Mt=P.get("text-variable-anchor");if(!Mt){const Ve=P.get("text-radial-offset").evaluate(Ae,{},f);if(Ve)Ke=TI(mr,[Ve*Fn,gw]);else{const Je=P.get("text-offset").evaluate(Ae,{},f);Ke=[Je[0]*Fn,Je[1]*Fn]}}let hr=xe?"center":P.get("text-justify").evaluate(Ae,{},f);const Fr=oe==="point",ue=Fr?P.get("text-max-width").evaluate(Ae,{},f)*Fn:1/0,de=Ve=>{n.allowVerticalPlacement&&Pm(jt)&&(rt.vertical=dw(st,e,i,u,Qe,ue,ur,mr,Ve,Ir,Ke,io.vertical,!0,et,Oe,w))};if(!xe&&Mt){const Ve=hr==="auto"?Mt.map(wt=>_w(wt)):[hr];let Je=!1;for(let wt=0;wt<Ve.length;wt++){const bt=Ve[wt];if(!rt.horizontal[bt])if(Je)rt.horizontal[bt]=rt.horizontal[0];else{const kt=dw(st,e,i,u,Qe,ue,ur,"center",bt,Ir,Ke,io.horizontal,!1,et,Oe,w);kt&&(rt.horizontal[bt]=kt,Je=kt.positionedLines.length===1)}}de("left")}else{if(hr==="auto"&&(hr=_w(mr)),Fr||P.get("text-writing-mode").indexOf("horizontal")>=0||!Pm(jt)){const Ve=dw(st,e,i,u,Qe,ue,ur,mr,hr,Ir,Ke,io.horizontal,!1,et,Oe,w);Ve&&(rt.horizontal[hr]=Ve)}de(Fr?"left":hr)}}let at,$e,Be,pt,ut,$t,It=!1;const Lt=P.get("icon-text-fit").evaluate(Ae,{},f);if(Ae.icon&&Ae.icon.hasPrimary()){const jt=II(Ae.icon,n.iconSizeData,M["icon-size"],f,n.zoom,Ae,w,O.iconScaleFactor,A);at=jt.iconPrimary,Be=jt.iconSecondary;const Kt=at.toString();if($e=l.get(Kt),$e&&(ut=P.get("icon-offset").evaluate(Ae,{},f),$t=P.get("icon-anchor").evaluate(Ae,{},f),ht=$L(u.get(Kt),Be?u.get(Be.toString()):void 0,ut,$t),It=$e.sdf,n.sdfIcons===void 0?n.sdfIcons=$e.sdf:n.sdfIcons!==$e.sdf&&Lr("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),($e.pixelRatio!==n.pixelRatio||P.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0)),Be){const ur=Be.toString();pt=l.get(ur)}}Se=Se||!(!Ae.icon||!Ae.icon.hasSecondary());const xt=yw(rt.horizontal)||rt.vertical;n.iconsInText||(n.iconsInText=!!xt&&xt.iconsInText);const Bt=et*O.textScaleFactor/Fn,{defaultShapedIcon:sr,verticallyShapedIcon:St}=QL(n,ht,P,Ae,f,rt,Bt,ut,Lt);Lt!=="none"&&ht&&(lI(ht)||cI(ht))&&(xy(0,$e,at,ht,sr,Lt,E,l,u),xy(0,pt,Be,ht,sr,Lt,E,l,u),St&&(xy(0,$e,at,ht,St,Lt,E,l,u),xy(0,pt,Be,ht,St,Lt,E,l,u))),ht=sr,Ce.push({feature:Ae,shapedTextOrientations:rt,shapedText:xt,shapedIcon:ht,iconPrimary:at,iconSecondary:Be,iconOffset:ut,iconAnchor:$t,verticallyShapedIcon:St,layoutTextSize:et,layoutIconSize:ct,textOffset:Ke,isSDFIcon:It,iconTextFit:Lt})}return{featureData:Ce,sizes:O,hasAnySecondaryIcon:Se,textAlongLine:xe,symbolPlacement:oe}},o.fo=yI,o.fp=function(n,e,i,l,u,f,p,y,w,E){const{featureData:A,hasAnySecondaryIcon:P,sizes:M,textAlongLine:O,symbolPlacement:D}=e;for(const V of A){const{shapedIcon:G,verticallyShapedIcon:q,feature:te,shapedTextOrientations:re,shapedText:oe,layoutTextSize:xe,textOffset:ve,isSDFIcon:Se,iconPrimary:Ce,iconSecondary:Ae,iconTextFit:Qe,iconOffset:Oe}=V;CI(G,E.iconPositions,Ce,Ae),CI(q,E.iconPositions,Ce,Ae),JL(re,E.iconPositions),KL(Ce,Ae,E.iconPositions),(oe||G)&&eO(n,te,re,G,q,w,M,xe,0,ve,Se,l,u,p,y,P,Qe,Oe,O,D)}i&&n.generateCollisionDebugBuffers(f,n.collisionBoxArray,M.textScaleFactor)},o.fq=nr,o.fr=Fy,o.fs=lt,o.ft=function(n){let e=0;if(new Uint32Array(n,0,1)[0]!==yE){const i=new Uint32Array(n,0,7),[,,l,u,f,p]=i;e=i.byteLength+u+f+p+f,(l!==n.byteLength||e>=n.byteLength)&&Lr("Invalid b3dm header information.")}return wE(n,e)},o.fu=function(n,e){const i=kE(n);for(const l of i){for(const u of l.meshes)Y3(u);l.lights&&(l.lightMeshIndex=l.meshes.length,l.meshes.push(K3(l.lights,e)))}return i},o.fv=Ry,o.fw=fi,o.fx=fE,o.fy=ia,o.fz=Rs,o.g=function(n,e){return Ur(Object.assign(n,{method:"GET"}),e)},o.h=function(n){return n.indexOf("mapbox:")===0},o.i=function(n){return is.API_STYLE_REGEX.test(n)&&!Z_(n)},o.j=Ic,o.k=Ju,o.l=function(n){return decodeURIComponent(atob(n).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},o.m=function(n,e){return Ur(Object.assign(n,{type:"json"}),e)},o.n=Mc,o.o=Qo,o.p=function(n,e){return Ur(Object.assign(n,{method:"POST"}),e)},o.q=Yn,o.r=Bp,o.s=function(n){try{const e=self[n];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},o.t=function(){return Hb||(Hb=new Ld),Hb},o.u=function(){return function n(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()},o.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},o.w=Lr,o.x=Rw,o.y=td,o.z=No}),S(["./shared"],function(o){function L(Re){const X=Re?Re.url.toString():void 0;return X?performance.getEntriesByName(X):[]}function F(Re){if(typeof Re=="number"||typeof Re=="boolean"||typeof Re=="string"||Re==null)return JSON.stringify(Re);if(Array.isArray(Re)){let Q="[";for(const he of Re)Q+=`${F(he)},`;return`${Q}]`}let X="{";for(const Q of Object.keys(Re).sort())X+=`${Q}:${F(Re[Q])},`;return`${X}}`}function Z(Re){let X="";for(const Q of o.bx)X+=`/${F(Re[Q])}`;return X}class ${constructor(X){this.keyCache={},this._layers={},this._layerConfigs={},X&&this.replace(X)}replace(X,Q){this._layerConfigs={},this._layers={},this.update(X,[],Q)}update(X,Q,he){this._options=he;for(const we of X)this._layerConfigs[we.id]=we,(this._layers[we.id]=o.dq(we,this.scope,null,this._options)).compileFilter(he),this.keyCache[we.id]&&delete this.keyCache[we.id];for(const we of Q)delete this.keyCache[we],delete this._layerConfigs[we],delete this._layers[we];this.familiesBySource={};const Te=function(we,be){const Ge={};for(let qe=0;qe<we.length;qe++){const yt=we[qe];let ot=be&&be[yt.id];ot||(yt.type==="symbol"?ot=yt.id:(ot=Z(yt),yt.type==="line"&&yt.paint&&function tr(ar){return typeof ar=="string"&&ar==="line-progress"||(Array.isArray(ar)?ar.some(tr):!(!ar||typeof ar!="object")&&Object.values(ar).some(tr))}(yt.paint["line-width"])&&(ot+=`/${F(yt.paint["line-width"])}`))),be&&(be[yt.id]=ot);let Gt=Ge[ot];Gt||(Gt=Ge[ot]=[]),Gt.push(yt)}const Me=[];for(const qe in Ge)Me.push(Ge[qe]);return Me}(Object.values(this._layerConfigs),this.keyCache);for(const we of Te){const be=we.map(Gt=>this._layers[Gt.id]),Ge=be[0];if(Ge.visibility==="none")continue;const Me=Ge.source||"";let qe=this.familiesBySource[Me];qe||(qe=this.familiesBySource[Me]={});const yt=Ge.sourceLayer||"_geojsonTileLayer";let ot=qe[yt];ot||(ot=qe[yt]=[]),ot.push(be)}}}const W=1*o.fc;class ee{constructor(X){const Q={},he=[];for(const Ge in X){const Me=X[Ge],qe=Q[Ge]={};for(const yt in Me.glyphs){const ot=Me.glyphs[+yt];if(!ot||ot.bitmap.width===0||ot.bitmap.height===0)continue;const Gt=ot.metrics.localGlyph?W:1,tr={x:0,y:0,w:ot.bitmap.width+2*Gt,h:ot.bitmap.height+2*Gt};he.push(tr),qe[yt]=tr}}const{w:Te,h:we}=o.G(he),be=new o.fb({width:Te||1,height:we||1});for(const Ge in X){const Me=X[Ge];for(const qe in Me.glyphs){const yt=Me.glyphs[+qe];if(!yt||yt.bitmap.width===0||yt.bitmap.height===0)continue;const ot=Q[Ge][qe],Gt=yt.metrics.localGlyph?W:1;o.fb.copy(yt.bitmap,be,{x:0,y:0},{x:ot.x+Gt,y:ot.y+Gt},yt.bitmap)}}this.image=be,this.positions=Q}}o.fa(ee,"GlyphAtlas");class ie{constructor(X){this.tileID=new o.aO(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),this.tileZoom=X.tileZoom,this.uid=X.uid,this.zoom=X.zoom,this.lut=X.lut,this.canonical=X.tileID.canonical,this.pixelRatio=X.pixelRatio,this.tileSize=X.tileSize,this.source=X.source,this.scope=X.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=X.showCollisionBoxes,this.collectResourceTiming=!!X.request&&X.request.collectResourceTiming,this.promoteId=X.promoteId,this.isSymbolTile=X.isSymbolTile,this.tileTransform=o.aZ(X.tileID.canonical,X.projection),this.projection=X.projection,this.worldview=X.worldview,this.localizableLayerIds=X.localizableLayerIds,this.brightness=X.brightness,this.extraShadowCaster=!!X.extraShadowCaster,this.tessellationStep=X.tessellationStep,this.scaleFactor=X.scaleFactor,this.worldview=X.worldview}parse(X,Q,he,Te,we,be){this.status="parsing",this.data=X,this.collisionBoxArray=new o.b3;const Ge=new o.fd(Object.keys(X.layers).sort()),Me=new o.fe(this.tileID,this.promoteId);Me.bucketLayerIDs=[];const qe={},yt=new o.ff(256,256),ot={featureIndex:Me,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:yt,availableImages:he,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Gt=[],tr=Q.familiesBySource[this.source];for(const Rr in tr){const Mr=X.layers[Rr];if(!Mr)continue;let zr=!1,pi=!1,Lr=!1;for(const fi of tr[Rr])fi[0].type==="symbol"?zr=!0:pi=!0,fi[0].is3D()&&fi[0].type!=="model"&&(Lr=!0);if(this.extraShadowCaster&&!Lr||this.isSymbolTile===!0&&!zr||this.isSymbolTile===!1&&!pi)continue;Mr.version===1&&o.w(`Vector tile source "${this.source}" layer "${Rr}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Yi=Ge.encode(Rr),dn=[];let hn=!1;for(let fi=0,Qr=0;fi<Mr.length;fi++){const Wi=Mr.feature(fi),Zi=Me.getId(Wi,Rr);if(this.localizableLayerIds&&this.localizableLayerIds.has(Rr)){const Ti=Wi.properties?Wi.properties.worldview:null;if(this.worldview&&typeof Ti=="string")if(Ti==="all")Wi.properties.$localized=!0;else{if(!Ti.split(",").includes(this.worldview))continue;Wi.properties.$localized=!0,Wi.properties.worldview=this.worldview}}!hn&&Wi.properties&&Wi.properties.hasOwnProperty(o.fg)&&(hn=!0),dn.push({feature:Wi,id:Zi,index:Qr,sourceLayerIndex:Yi}),Qr++}hn&&!ot.elevationFeatures&&X.layers.hasOwnProperty(o.fh)&&(ot.elevationFeatures=o.fi.parseFrom(X.layers[o.fh],this.canonical));for(const fi of tr[Rr]){const Qr=fi[0];if(this.extraShadowCaster&&(!Qr.is3D()||Qr.type==="model")||this.isSymbolTile!==void 0&&Qr.type==="symbol"!==this.isSymbolTile||Qr.minzoom&&this.zoom<Math.floor(Qr.minzoom)||Qr.maxzoom&&this.zoom>=Qr.maxzoom||Qr.visibility==="none")continue;ae(fi,this.zoom,ot.brightness,he,this.worldview);const Wi=qe[Qr.id]=Qr.createBucket({index:Me.bucketLayerIDs.length,layers:fi,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Yi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:Te,worldview:this.worldview});Me.bucketLayerIDs.push(fi.map(Ti=>o.B(Ti.id,Ti.scope)));let Zi=Wi.prepare?Wi.prepare():null;Zi!=null?(Zi=Zi.then(()=>Wi.populate(dn,ot,this.tileID.canonical,this.tileTransform)),Gt.push(Zi)):Wi.populate(dn,ot,this.tileID.canonical,this.tileTransform)}}const ar=()=>{let Rr,Mr,zr,pi,Lr,Yi;yt.trim();const dn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},hn=()=>{if(Rr)return this.status="done",be(Rr);if(this.extraShadowCaster)this.status="done",be(null,{buckets:Object.values(qe).filter(Qr=>!Qr.isEmpty()),featureIndex:Me,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:ot.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Mr&&zr&&pi){const Qr=new ee(Mr),Wi=new Map;for(const[Gn,ds]of zr.entries()){const{imagePosition:qs}=o.fl(Gn,ds,o.fm);Wi.set(Gn,qs)}const Zi={};for(const Gn in qe){const ds=qe[Gn];ds instanceof o.b4&&(ae(ds.layers,this.zoom,ot.brightness,he,this.worldview),Zi[Gn]=o.fn(ds,Mr,Qr.positions,zr,Wi,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Lr,this.worldview))}const Ti={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(we,zr,Lr,()=>{Ti.iconsPending=!1,fi(Zi,Qr,Ti)}),this.rasterizeIfNeeded(we,pi,Yi,()=>{Ti.patternsPending=!1,fi(Zi,Qr,Ti)})}},fi=(Qr,Wi,Zi,Ti)=>{if(Zi.iconsPending||Zi.patternsPending)return;const Gn=new o.fo(zr,pi,this.lut);for(const ds in qe){const qs=qe[ds];if(ds in Qr)o.fp(qs,Qr[ds],this.showCollisionBoxes,he,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,zr,Gn);else if(qs.hasPattern&&(qs instanceof o.ba||qs instanceof o.bb||qs instanceof o.e7)){ae(qs.layers,this.zoom,ot.brightness,he,this.worldview);const ba=Object.fromEntries(Gn.patternPositions);qs.addFeatures(ot,this.tileID.canonical,ba,he,this.tileTransform,this.brightness)}}this.status="done",be(null,{buckets:Object.values(qe).filter(ds=>!ds.isEmpty()),featureIndex:Me,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Wi.image,lineAtlas:yt,imageAtlas:Gn,brightness:ot.brightness})};if(!this.extraShadowCaster){const Qr=o.fj(ot.glyphDependencies,Ti=>Object.keys(Ti).map(Number));Object.keys(Qr).length?we.send("getGlyphs",{uid:this.uid,stacks:Qr},(Ti,Gn)=>{Rr||(Rr=Ti,Mr=Gn,hn())},void 0,!1,dn):Mr={};const Wi=Array.from(ot.iconDependencies.keys()).map(Ti=>o.I.parse(Ti));Wi.length?we.send("getImages",{images:Wi,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Ti,Gn)=>{Rr||(Rr=Ti,zr=new Map,Lr=this.updateImageMapAndGetImageTaskQueue(zr,Gn,ot.iconDependencies),hn())},void 0,!1,dn):(zr=new Map,Lr=new Map);const Zi=Array.from(ot.patternDependencies.keys()).map(Ti=>o.I.parse(Ti));Zi.length?we.send("getImages",{images:Zi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Ti,Gn)=>{Rr||(Rr=Ti,pi=new Map,Yi=this.updateImageMapAndGetImageTaskQueue(pi,Gn,ot.patternDependencies),hn())},void 0,!1,dn):(pi=new Map,Yi=new Map)}if(ot.elevationFeatures&&ot.elevationFeatures.length>0){const Qr=[];for(const Zi of Object.values(qe))if(Zi instanceof o.bb){const Ti=Zi.getUnevaluatedPortalGraph();Ti&&Qr.push(Ti)}const Wi=o.fk.evaluate(Qr);for(const Zi of Object.values(qe))if(Zi instanceof o.bb){const Ti=X.layers[Ge.decode(Zi.sourceLayerIndex)];Zi.setEvaluatedPortalGraph(Wi,Ti,this.tileID.canonical,ot.availableImages,ot.brightness)}}hn()};Gt.length>0?Promise.allSettled(Gt).then(ar).catch(be):ar()}rasterizeIfNeeded(X,Q,he,Te){Array.from(Q.values()).some(we=>we.usvg)?this.rasterize(X,Q,he,Te):Te()}updateImageMapAndGetImageTaskQueue(X,Q,he){const Te=new Map;for(const we of Q.keys()){const be=he.get(we)||[];for(const Ge of be){const Me=Ge.toString(),qe=Q.get(Ge.id.toString());qe.usvg?Te.has(Me)||(Te.set(Me,Ge),X.set(Me,Object.assign({},qe))):X.set(Me,qe)}}return Te}rasterize(X,Q,he,Te){this.rasterizeTask=X.send("rasterizeImages",{scope:this.scope,tasks:he},(we,be)=>{if(!we)for(const[Ge,Me]of be.entries()){const qe=Object.assign(Q.get(Ge),{data:Me});Q.set(Ge,qe)}Te()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function ae(Re,X,Q,he,Te){const we=new o.ac(X,{brightness:Q,worldview:Te});for(const be of Re)be.recalculate(we,he)}class ke extends o.E{constructor(X,Q,he,Te,we,be,Ge){super(),this.actor=X,this.layerIndex=Q,this.availableImages=he,this.availableModels=Te,this.loadVectorData=be||o.aL,this.loading={},this.loaded={},this.deduped=new o.aK(X.scheduler),this.isSpriteLoaded=we,this.scheduler=X.scheduler,this.brightness=Ge}loadTile(X,Q){const he=X.uid,Te=X&&X.request,we=Te&&Te.collectResourceTiming,be=this.loading[he]=new ie(X);be.abort=this.loadVectorData(X,(Ge,Me)=>{const qe=!this.loading[he];if(delete this.loading[he],be.cancelRasterize(),qe||Ge||!Me)return be.status="done",qe||(this.loaded[he]=be),Q(Ge);const yt=Me.rawData,ot={};Me.expires&&(ot.expires=Me.expires),Me.cacheControl&&(ot.cacheControl=Me.cacheControl),be.vectorTile=Me.vectorTile||new o.fq(new o.bt(yt));const Gt=()=>{be.parse(be.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(tr,ar)=>{if(tr||!ar)return Q(tr);const Rr={};if(we){const Mr=L(Te);Mr.length>0&&(Rr.resourceTiming=JSON.parse(JSON.stringify(Mr)))}Q(null,Object.assign({rawTileData:yt.slice(0)},ar,ot,Rr))})};this.isSpriteLoaded?Gt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Gt,{type:"parseTile",isSymbolTile:X.isSymbolTile,zoom:X.tileZoom}):Gt()}),this.loaded=this.loaded||{},this.loaded[he]=be})}reloadTile(X,Q){const he=this.loaded,Te=X.uid;if(he&&he[Te]){const we=he[Te];we.scaleFactor=X.scaleFactor,we.showCollisionBoxes=X.showCollisionBoxes,we.projection=X.projection,we.brightness=X.brightness,we.tileTransform=o.aZ(X.tileID.canonical,X.projection),we.extraShadowCaster=X.extraShadowCaster,we.lut=X.lut,we.worldview=X.worldview;const be=(Ge,Me)=>{const qe=we.reloadCallback;qe&&(delete we.reloadCallback,we.parse(we.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,qe)),Q(Ge,Me)};we.status==="parsing"?we.reloadCallback=be:we.status==="done"&&(we.vectorTile?we.parse(we.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,be):be())}else Q(null,void 0)}abortTile(X,Q){const he=X.uid,Te=this.loading[he];Te&&(Te.abort&&Te.abort(),delete this.loading[he]),Q()}removeTile(X,Q){const he=this.loaded,Te=X.uid;he&&he[Te]&&delete he[Te],Q()}}class le{loadTile(X,Q){const{uid:he,encoding:Te,rawImageData:we,padding:be}=X,Ge=ImageBitmap&&we instanceof ImageBitmap?this.getImageData(we,be):we;Q(null,new o.fr(he,Ge,Te,be<1))}reloadTile(X,Q){Q(null,null)}abortTile(X,Q){Q()}removeTile(X,Q){Q()}getImageData(X,Q){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(X.width,X.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=X.width,this.offscreenCanvas.height=X.height,this.offscreenCanvasContext.drawImage(X,0,0,X.width,X.height);const he=this.offscreenCanvasContext.getImageData(-Q,-Q,X.width+2*Q,X.height+2*Q);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),he}}o.bs.setPbf(o.bt);class se{constructor(X){this._mrt=new o.bs(X.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=X.uid,this.tileID=X.tileID,this.source=X.source}parse(X,Q){const he=this._mrt;this.status="parsing",this._entireBuffer=X;try{he.parseHeader(X),this._isHeaderLoaded=!0;const Te=[];for(const we in he.layers){const be=he.getLayer(we),Ge=be.getDataRange(be.getBandList()),Me=he.createDecodingTask(Ge),qe=X.slice(Ge.firstByte,Ge.lastByte+1),yt=o.bs.performDecoding(qe,Me).then(ot=>Me.complete(null,ot)).catch(ot=>Me.complete(ot,null));Te.push(yt)}Promise.allSettled(Te).then(()=>Q(null,he)).catch(we=>Q(we))}catch(Te){Q(Te)}}}class J{constructor(X){this.actor=X,this.loading={},this.loaded={}}loadTile(X,Q){const he=X.uid,Te=X.request,we=this.loading[he]=new se(X),{cancel:be}=o.bu(Te,(Ge,Me,qe,yt)=>{const ot=!this.loading[he];if(delete this.loading[he],ot||Ge||!Me)return we.status="done",ot||(this.loaded[he]=we),Q(Ge);we.parse(Me,(Gt,tr)=>{if(Gt||!tr)return Q(Gt);Q(null,tr,qe,yt)}),this.loaded[he]=we});we.abort=be}reloadTile(X,Q){Q(null,void 0)}abortTile(X,Q){const he=X.uid,Te=this.loading[he];Te&&(Te.abort&&Te.abort(),delete this.loading[he]),Q()}removeTile(X,Q){const he=X.uid;this.loaded[he]&&delete this.loaded[he],Q()}decodeRasterArray(X,Q){o.bs.performDecoding(X.buffer,X.task).then(he=>Q(null,he)).catch(he=>Q(he))}}const Ee=o.fs.prototype.toGeoJSON;class je{constructor(X){this._feature=X,this.extent=o.al,this.type=X.type,this.properties=X.tags,"id"in X&&!isNaN(X.id)&&(this.id=parseInt(X.id,10))}loadGeometry(){if(this._feature.type===1){const X=[];for(const Q of this._feature.geometry)X.push([new o.P(Q[0],Q[1])]);return X}{const X=[];for(const Q of this._feature.geometry){const he=[];for(const Te of Q)he.push(new o.P(Te[0],Te[1]));X.push(he)}return X}}toGeoJSON(X,Q,he){return Ee.call(this,X,Q,he)}}class Xe{constructor(X,Q){this.name=X,this.extent=o.al,this.length=Q.length,this._jsonFeatures=Q}feature(X){return new je(this._jsonFeatures[X])}}class tt{constructor(X){this.layers={},this.extent=o.al;for(const Q of Object.keys(X))this.layers[Q]=new Xe(Q,X[Q])}}const it=64/4096,We=128;class Ct{constructor(){this.features=new Map}clear(){this.features.clear()}load(X=[],Q){for(const he of X){const Te=he.id;if(Te==null)continue;let we=this.features.get(Te);we&&this.updateCache(we,Q),he.geometry?(we=Wt(he),this.updateCache(we,Q),this.features.set(Te,we)):this.features.delete(Te),this.updateCache(we,Q)}}updateCache(X,Q){for(const{canonical:he,uid:Te}of Object.values(Q)){const{z:we,x:be,y:Ge}=he;Nt(X,Math.pow(2,we),be,Ge)&&delete Q[Te]}}getTile(X,Q,he){const Te=Math.pow(2,X),we=[];for(const be of this.features.values())Nt(be,Te,Q,he)&&we.push(Ut(be,Te,Q,he));return{features:we}}getFeatures(){return[...this.features.values()]}}function Nt({minX:Re,minY:X,maxX:Q,maxY:he},Te,we,be){return Re<(we+1+it)/Te&&X<(be+1+it)/Te&&Q>(we-it)/Te&&he>(be-it)/Te}function Wt(Re){const{id:X,geometry:Q,properties:he}=Re;if(!Q)return;if(Q.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Te,coordinates:we}=Q,be={id:X,type:1,geometry:[],tags:he,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Ge=be.geometry;if(Te==="Point")fr(we,Ge,be);else if(Te==="MultiPoint")for(const Me of we)fr(Me,Ge,be);else if(Te==="LineString")be.type=2,dr(we,Ge,be);else if(Te==="MultiLineString")be.type=2,cr(we,Ge,be);else if(Te==="Polygon")be.type=3,cr(we,Ge,be,!0);else{if(Te!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");be.type=3;for(const Me of we)cr(Me,Ge,be,!0)}return be}function fr([Re,X],Q,he){const Te=o.aF(Re);let we=o.aJ(X);we=we<0?0:we>1?1:we,Q.push(Te,we),he.minX=Math.min(he.minX,Te),he.minY=Math.min(he.minY,we),he.maxX=Math.max(he.maxX,Te),he.maxY=Math.max(he.maxY,we)}function dr(Re,X,Q,he=!1,Te=!1){const we=[];for(const be of Re)fr(be,we,Q);X.push(we),he&&function(be,Ge){let Me=0;for(let qe=0,yt=be.length,ot=yt-2;qe<yt;ot=qe,qe+=2)Me+=(be[qe]-be[ot])*(be[qe+1]+be[ot+1]);if(Me>0===Ge)for(let qe=0,yt=be.length;qe<yt/2;qe+=2){const ot=be[qe],Gt=be[qe+1];be[qe]=be[yt-2-qe],be[qe+1]=be[yt-1-qe],be[yt-2-qe]=ot,be[yt-1-qe]=Gt}}(we,Te)}function cr(Re,X,Q,he=!1){for(let Te=0;Te<Re.length;Te++)dr(Re[Te],X,Q,he,Te===0)}function Ut(Re,X,Q,he){const{id:Te,type:we,geometry:be,tags:Ge}=Re,Me=[];if(we===1)(function(qe,yt,ot,Gt,tr){for(let ar=0;ar<qe.length;ar+=2){const Rr=Math.round(o.al*(qe[ar+0]*yt-ot)),Mr=Math.round(o.al*(qe[ar+1]*yt-Gt));tr.push([Rr,Mr])}})(be,X,Q,he,Me);else for(const qe of be)jr(qe,X,Q,he,Me);return{id:Te,type:we,geometry:Me,tags:Ge}}function jr(Re,X,Q,he,Te){const we=-We,be=o.al+We;let Ge;for(let Me=0;Me<Re.length-2;Me+=2){let qe=Math.round(o.al*(Re[Me+0]*X-Q)),yt=Math.round(o.al*(Re[Me+1]*X-he)),ot=Math.round(o.al*(Re[Me+2]*X-Q)),Gt=Math.round(o.al*(Re[Me+3]*X-he));const tr=ot-qe,ar=Gt-yt;qe<we&&ot<we||(qe<we?(yt+=Math.round(ar*((we-qe)/tr)),qe=we):ot<we&&(Gt=yt+Math.round(ar*((we-qe)/tr)),ot=we),yt<we&&Gt<we||(yt<we?(qe+=Math.round(tr*((we-yt)/ar)),yt=we):Gt<we&&(ot=qe+Math.round(tr*((we-yt)/ar)),Gt=we),qe>=be&&ot>=be||(qe>=be?(yt+=Math.round(ar*((be-qe)/tr)),qe=be):ot>=be&&(Gt=yt+Math.round(ar*((be-qe)/tr)),ot=be),yt>=be&&Gt>=be||(yt>=be?(qe+=Math.round(tr*((be-yt)/ar)),yt=be):Gt>=be&&(ot=qe+Math.round(tr*((be-yt)/ar)),Gt=be),Ge&&qe===Ge[Ge.length-1][0]&&yt===Ge[Ge.length-1][1]||(Ge=[[qe,yt]],Te.push(Ge)),Ge.push([ot,Gt])))))}}function Ht({name:Re,features:X},Q){Q.writeStringField(1,Re),Q.writeVarintField(5,o.al);const he=new Map,Te=new Map,we={keys:he,values:Te,feature:null};for(const be of X)we.feature=be,Q.writeMessage(2,xr,we);for(const be of he.keys())Q.writeStringField(3,be);for(const be of Te.keys())Q.writeMessage(4,us,be)}function xr(Re,X){const Q=Re.feature;Q.id!==void 0&&Number.isSafeInteger(+Q.id)&&X.writeVarintField(1,+Q.id),Q.tags&&X.writeMessage(2,Rt,Re),X.writeVarintField(3,Q.type),X.writeMessage(4,Un,Q)}function Rt({keys:Re,values:X,feature:Q},he){for(const Te of Object.keys(Q.tags)){let we=Q.tags[Te];if(we===null)continue;let be=Re.get(Te);be===void 0&&(be=Re.size,Re.set(Te,be)),he.writeVarint(be);const Ge=typeof we;Ge!=="string"&&Ge!=="boolean"&&Ge!=="number"&&(we=JSON.stringify(we));let Me=X.get(we);Me===void 0&&(Me=X.size,X.set(we,Me)),he.writeVarint(Me)}}function rr(Re,X){return(X<<3)+(7&Re)}function Nr(Re){return Re<<1^Re>>31}function Un(Re,X){const{geometry:Q,type:he}=Re;let Te=0,we=0;if(he===1){X.writeVarint(rr(1,Q.length));for(const be of Q){const Ge=be[0]-Te,Me=be[1]-we;X.writeVarint(Nr(Ge)),X.writeVarint(Nr(Me)),Te+=Ge,we+=Me}}else for(const be of Q){X.writeVarint(rr(1,1));const Ge=be.length-(he===3?1:0);for(let Me=0;Me<Ge;Me++){Me===1&&X.writeVarint(rr(2,Ge-1));const qe=be[Me][0]-Te,yt=be[Me][1]-we;X.writeVarint(Nr(qe)),X.writeVarint(Nr(yt)),Te+=qe,we+=yt}he===3&&X.writeVarint(rr(7,1))}}function us(Re,X){const Q=typeof Re;Q==="string"?X.writeStringField(1,Re):Q==="boolean"?X.writeBooleanField(7,Re):Q==="number"&&(Re%1!=0?X.writeDoubleField(3,Re):Re<0?X.writeSVarintField(6,Re):X.writeVarintField(5,Re))}const rs={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Re=>Re},Yr=Math.fround||(vi=new Float32Array(1),Re=>(vi[0]=+Re,vi[0]));var vi;const Vi=3,Vn=5,or=6;class pr{constructor(X){this.options=Object.assign(Object.create(rs),X),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(X){const{log:Q,minZoom:he,maxZoom:Te}=this.options;Q&&console.time("total time");const we=`prepare ${X.length} points`;Q&&console.time(we),this.points=X;const be=[];for(let Me=0;Me<X.length;Me++){const qe=X[Me];if(!qe.geometry)continue;const[yt,ot]=qe.geometry.coordinates,Gt=Yr(oi(yt)),tr=Yr(Gr(ot));be.push(Gt,tr,1/0,Me,-1,1),this.options.reduce&&be.push(0)}let Ge=this.trees[Te+1]=this._createTree(be);Q&&console.timeEnd(we);for(let Me=Te;Me>=he;Me--){const qe=+Date.now();Ge=this.trees[Me]=this._createTree(this._cluster(Ge,Me)),Q&&console.log("z%d: %d clusters in %dms",Me,Ge.numItems,+Date.now()-qe)}return Q&&console.timeEnd("total time"),this}getClusters(X,Q){let he=((X[0]+180)%360+360)%360-180;const Te=Math.max(-90,Math.min(90,X[1]));let we=X[2]===180?180:((X[2]+180)%360+360)%360-180;const be=Math.max(-90,Math.min(90,X[3]));if(X[2]-X[0]>=360)he=-180,we=180;else if(he>we){const ot=this.getClusters([he,Te,180,be],Q),Gt=this.getClusters([-180,Te,we,be],Q);return ot.concat(Gt)}const Ge=this.trees[this._limitZoom(Q)],Me=Ge.range(oi(he),Gr(be),oi(we),Gr(Te)),qe=Ge.data,yt=[];for(const ot of Me){const Gt=this.stride*ot;yt.push(qe[Gt+Vn]>1?$r(qe,Gt,this.clusterProps):this.points[qe[Gt+Vi]])}return yt}getChildren(X){const Q=this._getOriginId(X),he=this._getOriginZoom(X),Te="No cluster with the specified id.",we=this.trees[he];if(!we)throw new Error(Te);const be=we.data;if(Q*this.stride>=be.length)throw new Error(Te);const Ge=this.options.radius/(this.options.extent*Math.pow(2,he-1)),Me=we.within(be[Q*this.stride],be[Q*this.stride+1],Ge),qe=[];for(const yt of Me){const ot=yt*this.stride;be[ot+4]===X&&qe.push(be[ot+Vn]>1?$r(be,ot,this.clusterProps):this.points[be[ot+Vi]])}if(qe.length===0)throw new Error(Te);return qe}getLeaves(X,Q,he){const Te=[];return this._appendLeaves(Te,X,Q=Q||10,he=he||0,0),Te}getTile(X,Q,he){const Te=this.trees[this._limitZoom(X)],we=Math.pow(2,X),{extent:be,radius:Ge}=this.options,Me=Ge/be,qe=(he-Me)/we,yt=(he+1+Me)/we,ot={features:[]};return this._addTileFeatures(Te.range((Q-Me)/we,qe,(Q+1+Me)/we,yt),Te.data,Q,he,we,ot),Q===0&&this._addTileFeatures(Te.range(1-Me/we,qe,1,yt),Te.data,we,he,we,ot),Q===we-1&&this._addTileFeatures(Te.range(0,qe,Me/we,yt),Te.data,-1,he,we,ot),ot.features.length?ot:null}getClusterExpansionZoom(X){let Q=this._getOriginZoom(X)-1;for(;Q<=this.options.maxZoom;){const he=this.getChildren(X);if(Q++,he.length!==1)break;X=he[0].properties.cluster_id}return Q}_appendLeaves(X,Q,he,Te,we){const be=this.getChildren(Q);for(const Ge of be){const Me=Ge.properties;if(Me&&Me.cluster?we+Me.point_count<=Te?we+=Me.point_count:we=this._appendLeaves(X,Me.cluster_id,he,Te,we):we<Te?we++:X.push(Ge),X.length===he)break}return we}_createTree(X){const Q=new o.c3(X.length/this.stride|0,this.options.nodeSize,Float32Array);for(let he=0;he<X.length;he+=this.stride)Q.add(X[he],X[he+1]);return Q.finish(),Q.data=X,Q}_addTileFeatures(X,Q,he,Te,we,be){for(const Ge of X){const Me=Ge*this.stride,qe=Q[Me+Vn]>1;let yt,ot,Gt;if(qe)yt=Di(Q,Me,this.clusterProps),ot=Q[Me],Gt=Q[Me+1];else{const Rr=this.points[Q[Me+Vi]];yt=Rr.properties;const[Mr,zr]=Rr.geometry.coordinates;ot=oi(Mr),Gt=Gr(zr)}const tr={type:1,geometry:[[Math.round(this.options.extent*(ot*we-he)),Math.round(this.options.extent*(Gt*we-Te))]],tags:yt};let ar;ar=qe||this.options.generateId?Q[Me+Vi]:this.points[Q[Me+Vi]].id,ar!==void 0&&(tr.id=ar),be.features.push(tr)}}_limitZoom(X){return Math.max(this.options.minZoom,Math.min(Math.floor(+X),this.options.maxZoom+1))}_cluster(X,Q){const{radius:he,extent:Te,reduce:we,minPoints:be}=this.options,Ge=he/(Te*Math.pow(2,Q)),Me=X.data,qe=[],yt=this.stride;for(let ot=0;ot<Me.length;ot+=yt){if(Me[ot+2]<=Q)continue;Me[ot+2]=Q;const Gt=Me[ot],tr=Me[ot+1],ar=X.within(Me[ot],Me[ot+1],Ge),Rr=Me[ot+Vn];let Mr=Rr;for(const zr of ar){const pi=zr*yt;Me[pi+2]>Q&&(Mr+=Me[pi+Vn])}if(Mr>Rr&&Mr>=be){let zr,pi=Gt*Rr,Lr=tr*Rr,Yi=-1;const dn=(ot/yt<<5)+(Q+1)+this.points.length;for(const hn of ar){const fi=hn*yt;if(Me[fi+2]<=Q)continue;Me[fi+2]=Q;const Qr=Me[fi+Vn];pi+=Me[fi]*Qr,Lr+=Me[fi+1]*Qr,Me[fi+4]=dn,we&&(zr||(zr=this._map(Me,ot,!0),Yi=this.clusterProps.length,this.clusterProps.push(zr)),we(zr,this._map(Me,fi)))}Me[ot+4]=dn,qe.push(pi/Mr,Lr/Mr,1/0,dn,-1,Mr),we&&qe.push(Yi)}else{for(let zr=0;zr<yt;zr++)qe.push(Me[ot+zr]);if(Mr>1)for(const zr of ar){const pi=zr*yt;if(!(Me[pi+2]<=Q)){Me[pi+2]=Q;for(let Lr=0;Lr<yt;Lr++)qe.push(Me[pi+Lr])}}}}return qe}_getOriginId(X){return X-this.points.length>>5}_getOriginZoom(X){return(X-this.points.length)%32}_map(X,Q,he){if(X[Q+Vn]>1){const be=this.clusterProps[X[Q+or]];return he?Object.assign({},be):be}const Te=this.points[X[Q+Vi]].properties,we=this.options.map(Te);return he&&we===Te?Object.assign({},we):we}}function $r(Re,X,Q){return{type:"Feature",id:Re[X+Vi],properties:Di(Re,X,Q),geometry:{type:"Point",coordinates:[(he=Re[X],360*(he-.5)),un(Re[X+1])]}};var he}function Di(Re,X,Q){const he=Re[X+Vn],Te=he>=1e4?`${Math.round(he/1e3)}k`:he>=1e3?Math.round(he/100)/10+"k":he,we=Re[X+or],be=we===-1?{}:Object.assign({},Q[we]);return Object.assign(be,{cluster:!0,cluster_id:Re[X+Vi],point_count:he,point_count_abbreviated:Te})}function oi(Re){return Re/360+.5}function Gr(Re){const X=Math.sin(Re*Math.PI/180),Q=.5-.25*Math.log((1+X)/(1-X))/Math.PI;return Q<0?0:Q>1?1:Q}function un(Re){const X=(180-360*Re)*Math.PI/180;return 360*Math.atan(Math.exp(X))/Math.PI-90}function Zn(Re,X,Q,he){let Te=he;const we=X+(Q-X>>1);let be,Ge=Q-X;const Me=Re[X],qe=Re[X+1],yt=Re[Q],ot=Re[Q+1];for(let Gt=X+3;Gt<Q;Gt+=3){const tr=po(Re[Gt],Re[Gt+1],Me,qe,yt,ot);if(tr>Te)be=Gt,Te=tr;else if(tr===Te){const ar=Math.abs(Gt-we);ar<Ge&&(be=Gt,Ge=ar)}}Te>he&&(be-X>3&&Zn(Re,X,be,he),Re[be+2]=Te,Q-be>3&&Zn(Re,be,Q,he))}function po(Re,X,Q,he,Te,we){let be=Te-Q,Ge=we-he;if(be!==0||Ge!==0){const Me=((Re-Q)*be+(X-he)*Ge)/(be*be+Ge*Ge);Me>1?(Q=Te,he=we):Me>0&&(Q+=be*Me,he+=Ge*Me)}return be=Re-Q,Ge=X-he,be*be+Ge*Ge}function In(Re,X,Q,he){const Te={id:Re??null,type:X,geometry:Q,tags:he,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(X==="Point"||X==="MultiPoint"||X==="LineString")ji(Te,Q);else if(X==="Polygon")ji(Te,Q[0]);else if(X==="MultiLineString")for(const we of Q)ji(Te,we);else if(X==="MultiPolygon")for(const we of Q)ji(Te,we[0]);return Te}function ji(Re,X){for(let Q=0;Q<X.length;Q+=3)Re.minX=Math.min(Re.minX,X[Q]),Re.minY=Math.min(Re.minY,X[Q+1]),Re.maxX=Math.max(Re.maxX,X[Q]),Re.maxY=Math.max(Re.maxY,X[Q+1])}function on(Re,X,Q,he){if(!X.geometry)return;const Te=X.geometry.coordinates;if(Te&&Te.length===0)return;const we=X.geometry.type,be=Math.pow(Q.tolerance/((1<<Q.maxZoom)*Q.extent),2);let Ge=[],Me=X.id;if(Q.promoteId?Me=X.properties[Q.promoteId]:Q.generateId&&(Me=he||0),we==="Point")$s(Te,Ge);else if(we==="MultiPoint")for(const qe of Te)$s(qe,Ge);else if(we==="LineString")Ts(Te,Ge,be,!1);else if(we==="MultiLineString"){if(Q.lineMetrics){for(const qe of Te)Ge=[],Ts(qe,Ge,be,!1),Re.push(In(Me,"LineString",Ge,X.properties));return}Co(Te,Ge,be,!1)}else if(we==="Polygon")Co(Te,Ge,be,!0);else{if(we!=="MultiPolygon"){if(we==="GeometryCollection"){for(const qe of X.geometry.geometries)on(Re,{id:Me,geometry:qe,properties:X.properties},Q,he);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const qe of Te){const yt=[];Co(qe,yt,be,!0),Ge.push(yt)}}Re.push(In(Me,we,Ge,X.properties))}function $s(Re,X){X.push(Rl(Re[0]),Es(Re[1]),0)}function Ts(Re,X,Q,he){let Te,we,be=0;for(let Me=0;Me<Re.length;Me++){const qe=Rl(Re[Me][0]),yt=Es(Re[Me][1]);X.push(qe,yt,0),Me>0&&(be+=he?(Te*yt-qe*we)/2:Math.sqrt(Math.pow(qe-Te,2)+Math.pow(yt-we,2))),Te=qe,we=yt}const Ge=X.length-3;X[2]=1,Zn(X,0,Ge,Q),X[Ge+2]=1,X.size=Math.abs(be),X.start=0,X.end=X.size}function Co(Re,X,Q,he){for(let Te=0;Te<Re.length;Te++){const we=[];Ts(Re[Te],we,Q,he),X.push(we)}}function Rl(Re){return Re/360+.5}function Es(Re){const X=Math.sin(Re*Math.PI/180),Q=.5-.25*Math.log((1+X)/(1-X))/Math.PI;return Q<0?0:Q>1?1:Q}function Gs(Re,X,Q,he,Te,we,be,Ge){if(he/=X,we>=(Q/=X)&&be<he)return Re;if(be<Q||we>=he)return null;const Me=[];for(const qe of Re){const yt=qe.geometry;let ot=qe.type;const Gt=Te===0?qe.minX:qe.minY,tr=Te===0?qe.maxX:qe.maxY;if(Gt>=Q&&tr<he){Me.push(qe);continue}if(tr<Q||Gt>=he)continue;let ar=[];if(ot==="Point"||ot==="MultiPoint")$u(yt,ar,Q,he,Te);else if(ot==="LineString")ya(yt,ar,Q,he,Te,!1,Ge.lineMetrics);else if(ot==="MultiLineString")$n(yt,ar,Q,he,Te,!1);else if(ot==="Polygon")$n(yt,ar,Q,he,Te,!0);else if(ot==="MultiPolygon")for(const Rr of yt){const Mr=[];$n(Rr,Mr,Q,he,Te,!0),Mr.length&&ar.push(Mr)}if(ar.length){if(Ge.lineMetrics&&ot==="LineString"){for(const Rr of ar)Me.push(In(qe.id,ot,Rr,qe.tags));continue}ot!=="LineString"&&ot!=="MultiLineString"||(ar.length===1?(ot="LineString",ar=ar[0]):ot="MultiLineString"),ot!=="Point"&&ot!=="MultiPoint"||(ot=ar.length===3?"Point":"MultiPoint"),Me.push(In(qe.id,ot,ar,qe.tags))}}return Me.length?Me:null}function $u(Re,X,Q,he,Te){for(let we=0;we<Re.length;we+=3){const be=Re[we+Te];be>=Q&&be<=he&&Ao(X,Re[we],Re[we+1],Re[we+2])}}function ya(Re,X,Q,he,Te,we,be){let Ge=Tc(Re);const Me=Te===0?Gu:Za;let qe,yt,ot=Re.start;for(let Mr=0;Mr<Re.length-3;Mr+=3){const zr=Re[Mr],pi=Re[Mr+1],Lr=Re[Mr+2],Yi=Re[Mr+3],dn=Re[Mr+4],hn=Te===0?zr:pi,fi=Te===0?Yi:dn;let Qr=!1;be&&(qe=Math.sqrt(Math.pow(zr-Yi,2)+Math.pow(pi-dn,2))),hn<Q?fi>Q&&(yt=Me(Ge,zr,pi,Yi,dn,Q),be&&(Ge.start=ot+qe*yt)):hn>he?fi<he&&(yt=Me(Ge,zr,pi,Yi,dn,he),be&&(Ge.start=ot+qe*yt)):Ao(Ge,zr,pi,Lr),fi<Q&&hn>=Q&&(yt=Me(Ge,zr,pi,Yi,dn,Q),Qr=!0),fi>he&&hn<=he&&(yt=Me(Ge,zr,pi,Yi,dn,he),Qr=!0),!we&&Qr&&(be&&(Ge.end=ot+qe*yt),X.push(Ge),Ge=Tc(Re)),be&&(ot+=qe)}let Gt=Re.length-3;const tr=Re[Gt],ar=Re[Gt+1],Rr=Te===0?tr:ar;Rr>=Q&&Rr<=he&&Ao(Ge,tr,ar,Re[Gt+2]),Gt=Ge.length-3,we&&Gt>=3&&(Ge[Gt]!==Ge[0]||Ge[Gt+1]!==Ge[1])&&Ao(Ge,Ge[0],Ge[1],Ge[2]),Ge.length&&X.push(Ge)}function Tc(Re){const X=[];return X.size=Re.size,X.start=Re.start,X.end=Re.end,X}function $n(Re,X,Q,he,Te,we){for(const be of Re)ya(be,X,Q,he,Te,we,!1)}function Ao(Re,X,Q,he){Re.push(X,Q,he)}function Gu(Re,X,Q,he,Te,we){const be=(we-X)/(he-X);return Ao(Re,we,Q+(Te-Q)*be,1),be}function Za(Re,X,Q,he,Te,we){const be=(we-Q)/(Te-Q);return Ao(Re,X+(he-X)*be,we,1),be}function Jo(Re,X){const Q=[];for(let he=0;he<Re.length;he++){const Te=Re[he],we=Te.type;let be;if(we==="Point"||we==="MultiPoint"||we==="LineString")be=xa(Te.geometry,X);else if(we==="MultiLineString"||we==="Polygon"){be=[];for(const Ge of Te.geometry)be.push(xa(Ge,X))}else if(we==="MultiPolygon"){be=[];for(const Ge of Te.geometry){const Me=[];for(const qe of Ge)Me.push(xa(qe,X));be.push(Me)}}Q.push(In(Te.id,we,be,Te.tags))}return Q}function xa(Re,X){const Q=[];Q.size=Re.size,Re.start!==void 0&&(Q.start=Re.start,Q.end=Re.end);for(let he=0;he<Re.length;he+=3)Q.push(Re[he]+X,Re[he+1],Re[he+2]);return Q}function Ll(Re,X){if(Re.transformed)return Re;const Q=1<<Re.z,he=Re.x,Te=Re.y;for(const we of Re.features){const be=we.geometry,Ge=we.type;if(we.geometry=[],Ge===1)for(let Me=0;Me<be.length;Me+=2)we.geometry.push(Ui(be[Me],be[Me+1],X,Q,he,Te));else for(let Me=0;Me<be.length;Me++){const qe=[];for(let yt=0;yt<be[Me].length;yt+=2)qe.push(Ui(be[Me][yt],be[Me][yt+1],X,Q,he,Te));we.geometry.push(qe)}}return Re.transformed=!0,Re}function Ui(Re,X,Q,he,Te,we){return[Math.round(Q*(Re*he-Te)),Math.round(Q*(X*he-we))]}function jn(Re,X,Q,he,Te){const we=X===Te.maxZoom?0:Te.tolerance/((1<<X)*Te.extent),be={features:[],numPoints:0,numSimplified:0,numFeatures:Re.length,source:null,x:Q,y:he,z:X,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Ge of Re)qu(be,Ge,we,Te);return be}function qu(Re,X,Q,he){const Te=X.geometry,we=X.type,be=[];if(Re.minX=Math.min(Re.minX,X.minX),Re.minY=Math.min(Re.minY,X.minY),Re.maxX=Math.max(Re.maxX,X.maxX),Re.maxY=Math.max(Re.maxY,X.maxY),we==="Point"||we==="MultiPoint")for(let Ge=0;Ge<Te.length;Ge+=3)be.push(Te[Ge],Te[Ge+1]),Re.numPoints++,Re.numSimplified++;else if(we==="LineString")Ol(be,Te,Re,Q,!1,!1);else if(we==="MultiLineString"||we==="Polygon")for(let Ge=0;Ge<Te.length;Ge++)Ol(be,Te[Ge],Re,Q,we==="Polygon",Ge===0);else if(we==="MultiPolygon")for(let Ge=0;Ge<Te.length;Ge++){const Me=Te[Ge];for(let qe=0;qe<Me.length;qe++)Ol(be,Me[qe],Re,Q,!0,qe===0)}if(be.length){let Ge=X.tags||null;if(we==="LineString"&&he.lineMetrics){Ge={};for(const qe in X.tags)Ge[qe]=X.tags[qe];Ge.mapbox_clip_start=Te.start/Te.size,Ge.mapbox_clip_end=Te.end/Te.size}const Me={geometry:be,type:we==="Polygon"||we==="MultiPolygon"?3:we==="LineString"||we==="MultiLineString"?2:1,tags:Ge};X.id!==null&&(Me.id=X.id),Re.features.push(Me)}}function Ol(Re,X,Q,he,Te,we){const be=he*he;if(he>0&&X.size<(Te?be:he))return void(Q.numPoints+=X.length/3);const Ge=[];for(let Me=0;Me<X.length;Me+=3)(he===0||X[Me+2]>be)&&(Q.numSimplified++,Ge.push(X[Me],X[Me+1])),Q.numPoints++;Te&&function(Me,qe){let yt=0;for(let ot=0,Gt=Me.length,tr=Gt-2;ot<Gt;tr=ot,ot+=2)yt+=(Me[ot]-Me[tr])*(Me[ot+1]+Me[tr+1]);if(yt>0===qe)for(let ot=0,Gt=Me.length;ot<Gt/2;ot+=2){const tr=Me[ot],ar=Me[ot+1];Me[ot]=Me[Gt-2-ot],Me[ot+1]=Me[Gt-1-ot],Me[Gt-2-ot]=tr,Me[Gt-1-ot]=ar}}(Ge,we),Re.push(Ge)}const Po={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Hu{constructor(X,Q){const he=(Q=this.options=function(we,be){for(const Ge in be)we[Ge]=be[Ge];return we}(Object.create(Po),Q)).debug;if(he&&console.time("preprocess data"),Q.maxZoom<0||Q.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Q.promoteId&&Q.generateId)throw new Error("promoteId and generateId cannot be used together.");let Te=function(we,be){const Ge=[];if(we.type==="FeatureCollection")for(let Me=0;Me<we.features.length;Me++)on(Ge,we.features[Me],be,Me);else on(Ge,we.type==="Feature"?we:{geometry:we},be);return Ge}(X,Q);this.tiles={},this.tileCoords=[],he&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Q.indexMaxZoom,Q.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Te=function(we,be){const Ge=be.buffer/be.extent;let Me=we;const qe=Gs(we,1,-1-Ge,Ge,0,-1,2,be),yt=Gs(we,1,1-Ge,2+Ge,0,-1,2,be);return(qe||yt)&&(Me=Gs(we,1,-Ge,1+Ge,0,-1,2,be)||[],qe&&(Me=Jo(qe,1).concat(Me)),yt&&(Me=Me.concat(Jo(yt,-1)))),Me}(Te,Q),Te.length&&this.splitTile(Te,0,0,0),he&&(Te.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(X,Q,he,Te,we,be,Ge){const Me=[X,Q,he,Te],qe=this.options,yt=qe.debug;for(;Me.length;){Te=Me.pop(),he=Me.pop(),Q=Me.pop(),X=Me.pop();const ot=1<<Q,Gt=Wu(Q,he,Te);let tr=this.tiles[Gt];if(!tr&&(yt>1&&console.time("creation"),tr=this.tiles[Gt]=jn(X,Q,he,Te,qe),this.tileCoords.push({z:Q,x:he,y:Te}),yt)){yt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Q,he,Te,tr.numFeatures,tr.numPoints,tr.numSimplified),console.timeEnd("creation"));const Qr=`z${Q}`;this.stats[Qr]=(this.stats[Qr]||0)+1,this.total++}if(tr.source=X,we==null){if(Q===qe.indexMaxZoom||tr.numPoints<=qe.indexMaxPoints)continue}else{if(Q===qe.maxZoom||Q===we)continue;if(we!=null){const Qr=we-Q;if(he!==be>>Qr||Te!==Ge>>Qr)continue}}if(tr.source=null,X.length===0)continue;yt>1&&console.time("clipping");const ar=.5*qe.buffer/qe.extent,Rr=.5-ar,Mr=.5+ar,zr=1+ar;let pi=null,Lr=null,Yi=null,dn=null,hn=Gs(X,ot,he-ar,he+Mr,0,tr.minX,tr.maxX,qe),fi=Gs(X,ot,he+Rr,he+zr,0,tr.minX,tr.maxX,qe);X=null,hn&&(pi=Gs(hn,ot,Te-ar,Te+Mr,1,tr.minY,tr.maxY,qe),Lr=Gs(hn,ot,Te+Rr,Te+zr,1,tr.minY,tr.maxY,qe),hn=null),fi&&(Yi=Gs(fi,ot,Te-ar,Te+Mr,1,tr.minY,tr.maxY,qe),dn=Gs(fi,ot,Te+Rr,Te+zr,1,tr.minY,tr.maxY,qe),fi=null),yt>1&&console.timeEnd("clipping"),Me.push(pi||[],Q+1,2*he,2*Te),Me.push(Lr||[],Q+1,2*he,2*Te+1),Me.push(Yi||[],Q+1,2*he+1,2*Te),Me.push(dn||[],Q+1,2*he+1,2*Te+1)}}getTile(X,Q,he){X=+X,Q=+Q,he=+he;const Te=this.options,{extent:we,debug:be}=Te;if(X<0||X>24)return null;const Ge=1<<X,Me=Wu(X,Q=Q+Ge&Ge-1,he);if(this.tiles[Me])return Ll(this.tiles[Me],we);be>1&&console.log("drilling down to z%d-%d-%d",X,Q,he);let qe,yt=X,ot=Q,Gt=he;for(;!qe&&yt>0;)yt--,ot>>=1,Gt>>=1,qe=this.tiles[Wu(yt,ot,Gt)];return qe&&qe.source?(be>1&&(console.log("found parent tile z%d-%d-%d",yt,ot,Gt),console.time("drilling down")),this.splitTile(qe.source,yt,ot,Gt,X,Q,he),be>1&&console.timeEnd("drilling down"),this.tiles[Me]?Ll(this.tiles[Me],we):null):null}}function Wu(Re,X,Q){return 32*((1<<Re)*Q+X)+Re}function fh(Re,X){const Q=Re.tileID.canonical;if(!this._geoJSONIndex)return void X(null,null);const he=this._geoJSONIndex.getTile(Q.z,Q.x,Q.y);if(!he)return void X(null,null);const Te=qe=>qe.tags&&"3d_elevation_id"in qe.tags&&"source"in qe.tags&&qe.tags.source==="elevation",we=he.features.filter(qe=>Te(qe));let be={_geojsonTileLayer:he.features};we.length>0&&(be={_geojsonTileLayer:he.features.filter(qe=>!Te(qe)),hd_road_elevation:we});const Ge=new tt(be),Me=function(qe){const yt=new o.bt;for(const ot of Object.keys(qe))yt.writeMessage(3,Ht,{name:ot,features:qe[ot]});return yt.finish()}(be).buffer;X(null,{vectorTile:Ge,rawData:Me})}class ft extends ke{constructor(X,Q,he,Te,we,be,Ge){super(X,Q,he,Te,we,fh,Ge),be&&(this.loadGeoJSON=be),this._dynamicIndex=new Ct}loadData(X,Q){const he=X&&X.request,Te=he&&he.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(X,(we,be)=>{if(we||!be)return Q(we);if(typeof be!="object")return Q(new Error(`Input data given to '${X.source}' is not a valid GeoJSON object.`));{try{if(X.filter){const Me=o.U(X.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Me.result==="error")throw new Error(Me.value.map(qe=>`${qe.key}: ${qe.message}`).join(", "));be.features=be.features.filter(qe=>Me.value.evaluate({zoom:0},qe))}X.dynamic?(be.type==="Feature"&&(be={type:"FeatureCollection",features:[be]}),X.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(be.features,this.loaded),X.cluster&&(be.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=X.cluster?new pr(function({superclusterOptions:Me,clusterProperties:qe}){if(!qe||!Me)return Me;const yt={},ot={},Gt={accumulated:null,zoom:0},tr={properties:null},ar=Object.keys(qe);for(const Rr of ar){const[Mr,zr]=qe[Rr],pi=o.U(zr),Lr=o.U(typeof Mr=="string"?[Mr,["accumulated"],["get",Rr]]:Mr);yt[Rr]=pi.value,ot[Rr]=Lr.value}return Me.map=Rr=>{tr.properties=Rr;const Mr={};for(const zr of ar)Mr[zr]=yt[zr].evaluate(Gt,tr);return Mr},Me.reduce=(Rr,Mr)=>{tr.properties=Mr;for(const zr of ar)Gt.accumulated=Rr[zr],Rr[zr]=ot[zr].evaluate(Gt,tr)},Me}(X)).load(be.features):X.dynamic?this._dynamicIndex:function(Me,qe){return new Hu(Me,qe)}(be,X.geojsonVtOptions)}catch(Me){return Q(Me)}const Ge={};if(Te){const Me=L(he);Me&&(Ge.resourceTiming={},Ge.resourceTiming[X.source]=JSON.parse(JSON.stringify(Me)))}Q(null,Ge)}})}reloadTile(X,Q){const he=this.loaded;return he&&he[X.uid]?X.partial?Q(null,void 0):super.reloadTile(X,Q):this.loadTile(X,Q)}loadGeoJSON(X,Q){if(X.request)o.m(X.request,Q);else{if(typeof X.data!="string")return Q(new Error(`Input data given to '${X.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return Q(null,JSON.parse(X.data))}catch{return Q(new Error(`Input data given to '${X.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(X,Q){try{Q(null,this._geoJSONIndex.getClusterExpansionZoom(X.clusterId))}catch(he){Q(he)}}getClusterChildren(X,Q){try{Q(null,this._geoJSONIndex.getChildren(X.clusterId))}catch(he){Q(he)}}getClusterLeaves(X,Q){try{Q(null,this._geoJSONIndex.getLeaves(X.clusterId,X.limit,X.offset))}catch(he){Q(he)}}}class va{constructor(X,Q,he){this.tileID=new o.aO(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),this.tileZoom=X.tileZoom,this.uid=X.uid,this.zoom=X.zoom,this.canonical=X.tileID.canonical,this.pixelRatio=X.pixelRatio,this.tileSize=X.tileSize,this.source=X.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=X.projection,this.brightness=Q,this.worldview=he}parse(X,Q,he,Te){this.status="parsing";const we=new o.aO(he.tileID.overscaledZ,he.tileID.wrap,he.tileID.canonical.z,he.tileID.canonical.x,he.tileID.canonical.y),be=[],Ge=Q.familiesBySource[he.source],Me=new o.fe(we,he.promoteId);Me.bucketLayerIDs=[],Me.is3DTile=!0,o.ft(X).then(qe=>{if(!qe)return Te(new Error("Could not parse tile"));const yt=qe.json.extensionsUsed&&qe.json.extensionsUsed.includes("MAPBOX_mesh_features")||qe.json.asset.extras&&qe.json.asset.extras.MAPBOX_mesh_features,ot=qe.json.extensionsUsed&&qe.json.extensionsUsed.includes("EXT_meshopt_compression"),Gt=new o.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const tr in Ge)for(const ar of Ge[tr]){const Rr=ar[0];Me.bucketLayerIDs.push(ar.map(pi=>o.B(pi.id,pi.scope))),Rr.recalculate(Gt,[]);const Mr=o.fu(qe,1/o.d6(he.tileID.canonical)),zr=new o.fv(ar,Mr,we,yt,ot,this.brightness,Me,this.worldview);yt||(zr.needsUpload=!0),be.push(zr),zr.evaluate(Rr)}this.status="done",Te(null,{buckets:be,featureIndex:Me,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(qe=>Te(new Error(qe.message)))}}class Fp{constructor(X,Q,he,Te,we,be,Ge,Me){this.actor=X,this.layerIndex=Q,this.availableImages=he,this.availableModels=Te,this.brightness=Ge,this.loading={},this.loaded={},this.worldview=Me}loadTile(X,Q){const he=X.uid,Te=this.loading[he]=new va(X,this.brightness,this.worldview);o.bu(X.request,(we,be)=>{const Ge=!this.loading[he];return delete this.loading[he],Ge||we?(Te.status="done",Ge||(this.loaded[he]=Te),Q(we)):be&&be.byteLength!==0?void Te.parse(be,this.layerIndex,X,(Me,qe)=>{Te.status="done",this.loaded=this.loaded||{},this.loaded[he]=Te,Me||!qe?Q(Me):Q(null,qe)}):(Te.status="done",this.loaded[he]=Te,Q())})}reloadTile(X,Q){const he=this.loaded,Te=X.uid;if(he&&he[Te]){const we=he[Te];we.projection=X.projection,we.brightness=X.brightness;const be=(Ge,Me)=>{we.reloadCallback&&(delete we.reloadCallback,this.loadTile(X,Q)),Q(Ge,Me)};we.status==="parsing"?we.reloadCallback=be:we.status==="done"&&this.loadTile(X,Q)}}abortTile(X,Q){const he=X.uid;this.loading[he]&&delete this.loading[he],Q()}removeTile(X,Q){const he=this.loaded,Te=X.uid;he&&he[Te]&&delete he[Te],Q()}}class Ec{constructor(X){this.self=X,this.actor=new o.fx(X,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new o.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=o.cl({name:"mercator"}),this.workerSourceTypes={vector:ke,geojson:ft,"raster-dem":le,"raster-array":J,"batched-model":Fp},this.workerSources={},this.self.registerWorkerSource=(Q,he)=>{if(this.workerSourceTypes[Q])throw new Error(`Worker source with name "${Q}" already registered.`);this.workerSourceTypes[Q]=he},this.self.registerRTLTextPlugin=Q=>{if(o.fy.isParsed())throw new Error("RTL text plugin already registered.");o.fy.setState({pluginStatus:o.fz.parsed,pluginURL:o.fy.getPluginURL()}),o.fy.applyArabicShaping=Q.applyArabicShaping,o.fy.processBidirectionalText=Q.processBidirectionalText,o.fy.processStyledBidirectionalText=Q.processStyledBidirectionalText;for(const he of this.rtlPluginParsingListeners)he(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(X,Q,he){delete this.layerIndexes[X],delete this.availableImages[X],delete this.availableModels[X],delete this.workerSources[X],he()}checkIfReady(X,Q,he){he()}setReferrer(X,Q){this.referrer=Q}spriteLoaded(X,Q){this.isSpriteLoaded[X]||(this.isSpriteLoaded[X]={});const{scope:he,isLoaded:Te}=Q;if(this.isSpriteLoaded[X][he]=Te,this.workerSources[X]&&this.workerSources[X][he])for(const we in this.workerSources[X][he]){const be=this.workerSources[X][he][we];for(const Ge in be){const Me=be[Ge];Me instanceof ke&&(Me.isSpriteLoaded=Te,Me.fire(new o.z("isSpriteLoaded")))}}}setImages(X,Q,he){this.availableImages[X]||(this.availableImages[X]={});const{scope:Te,images:we}=Q;if(this.availableImages[X][Te]=we,this.workerSources[X]&&this.workerSources[X][Te]){for(const be in this.workerSources[X][Te]){const Ge=this.workerSources[X][Te][be];for(const Me in Ge)Ge[Me].availableImages=we}he()}else he()}setModels(X,{scope:Q,models:he},Te){if(this.availableModels[X]||(this.availableModels[X]={}),this.availableModels[X][Q]=he,this.workerSources[X]&&this.workerSources[X][Q]){for(const we in this.workerSources[X][Q]){const be=this.workerSources[X][Q][we];for(const Ge in be)be[Ge].availableModels=he}Te()}else Te()}setProjection(X,Q){this.projections[X]=o.cl(Q)}setBrightness(X,Q,he){this.brightness=Q,he()}setWorldview(X,Q,he){this.worldview=Q,he()}setLayers(X,Q,he){this.getLayerIndex(X,Q.scope).replace(Q.layers,Q.options),he()}updateLayers(X,Q,he){this.getLayerIndex(X,Q.scope).update(Q.layers,Q.removedIds,Q.options),he()}loadTile(X,Q,he){Q.projection=this.projections[X]||this.defaultProjection,this.getWorkerSource(X,Q.type,Q.source,Q.scope).loadTile(Q,he)}decodeRasterArray(X,Q,he){this.getWorkerSource(X,Q.type,Q.source,Q.scope).decodeRasterArray(Q,he)}reloadTile(X,Q,he){Q.projection=this.projections[X]||this.defaultProjection,this.getWorkerSource(X,Q.type,Q.source,Q.scope).reloadTile(Q,he)}abortTile(X,Q,he){this.getWorkerSource(X,Q.type,Q.source,Q.scope).abortTile(Q,he)}removeTile(X,Q,he){this.getWorkerSource(X,Q.type,Q.source,Q.scope).removeTile(Q,he)}removeSource(X,Q,he){if(!(this.workerSources[X]&&this.workerSources[X][Q.scope]&&this.workerSources[X][Q.scope][Q.type]&&this.workerSources[X][Q.scope][Q.type][Q.source]))return;const Te=this.workerSources[X][Q.scope][Q.type][Q.source];delete this.workerSources[X][Q.scope][Q.type][Q.source],Te.removeSource!==void 0?Te.removeSource(Q,he):he()}loadWorkerSource(X,Q,he){try{this.self.importScripts(Q.url),he()}catch(Te){he(Te.toString())}}syncRTLPluginState(X,Q,he){if(o.fy.isParsed())he(null,!0);else if(o.fy.isParsing())this.rtlPluginParsingListeners.push(he);else try{o.fy.setState(Q);const Te=o.fy.getPluginURL();!o.fy.isLoaded()||o.fy.isParsed()||o.fy.isParsing()||Te==null||(o.fy.setState({pluginStatus:o.fz.parsing,pluginURL:o.fy.getPluginURL()}),this.self.importScripts(Te),o.fy.isParsed()?he(null,!0):this.rtlPluginParsingListeners.push(he))}catch(Te){he(Te.toString())}}setDracoUrl(X,Q){this.dracoUrl=Q}getAvailableImages(X,Q){this.availableImages[X]||(this.availableImages[X]={});let he=this.availableImages[X][Q];return he||(he=[]),he}getAvailableModels(X,Q){this.availableModels[X]||(this.availableModels[X]={});let he=this.availableModels[X][Q];return he||(he={}),he}getLayerIndex(X,Q){this.layerIndexes[X]||(this.layerIndexes[X]={});let he=this.layerIndexes[X][Q];return he||(he=this.layerIndexes[X][Q]=new $,he.scope=Q),he}getWorkerSource(X,Q,he,Te){const we=this.workerSources;return we[X]||(we[X]={}),we[X][Te]||(we[X][Te]={}),we[X][Te][Q]||(we[X][Te][Q]={}),this.isSpriteLoaded[X]||(this.isSpriteLoaded[X]={}),we[X][Te][Q][he]||(we[X][Te][Q][he]=new this.workerSourceTypes[Q]({send:(be,Ge,Me,qe,yt,ot)=>this.actor.send(be,Ge,Me,X,yt,ot),scheduler:this.actor.scheduler},this.getLayerIndex(X,Te),this.getAvailableImages(X,Te),this.getAvailableModels(X,Te),this.isSpriteLoaded[X][Te],void 0,this.brightness,this.worldview)),we[X][Te][Q][he]}rasterizeImagesWorker(X,Q,he){const Te=new Map;for(const[we,{image:be,imageVariant:Ge}]of Q.tasks.entries()){const Me=this.imageRasterizer.rasterize(Ge,be,Q.scope,X);Te.set(we,Me)}he(void 0,Te)}removeRasterizedImages(X,Q,he){this.imageRasterizer.removeImagesFromCacheByIds(Q.imageIds,Q.scope,X),he()}enforceCacheSizeLimit(X,Q){o.fA(Q)}getWorkerPerformanceMetrics(X,Q,he){he(void 0,void 0)}}return o.fw(self)&&(self.worker=new Ec(self)),Ec}),S(["./shared"],function(o){var L="3.15.0";const F={create:"create",load:"load",fullLoad:"fullLoad"},Z={mark(h){performance.mark(h)},measure(h,t,a){performance.measure(h,t,a)}};function $(h){const t=h.name.split("?")[0];return o.a(t)&&t.includes("mapbox-gl.js")?"javascript":o.a(t)&&t.includes("mapbox-gl.css")?"css":o.b(t)?"fontRange":o.c(t)?"sprite":o.i(t)?"style":o.d(t)?"tilejson":"other"}var W,ee={},ie=function(){if(W)return ee;function h(d){return!t(d)}function t(d){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var _,b,T=new Blob([""],{type:"text/javascript"}),I=URL.createObjectURL(T);try{b=new Worker(I),_=!0}catch{_=!1}return b&&b.terminate(),URL.revokeObjectURL(I),_}()?function(){var _=document.createElement("canvas");_.width=_.height=1;var b=_.getContext("2d");if(!b)return!1;var T=b.getImageData(0,0,1,1);return T&&T.width===_.width}()?(a[g=d&&d.failIfMajorPerformanceCaveat]===void 0&&(a[g]=function(_){var b,T=function(I){var k=document.createElement("canvas"),N=Object.create(h.webGLContextAttributes);return N.failIfMajorPerformanceCaveat=I,k.getContext("webgl2",N)}(_);if(!T)return!1;try{b=T.createShader(T.VERTEX_SHADER)}catch{return!1}return!(!b||T.isContextLost())&&(T.shaderSource(b,"void main() {}"),T.compileShader(b),T.getShaderParameter(b,T.COMPILE_STATUS)===!0)}(g)),a[g]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var g}W=1,ee.supported=h,ee.notSupportedReason=t;var a={};return h.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},ee}();function ae(h,t,a){const d=document.createElement(h);return t!=null&&(d.className=t),a&&a.appendChild(d),d}function ke(h,t,a){const d=document.createElementNS("http://www.w3.org/2000/svg",h);for(const g of Object.keys(t))d.setAttributeNS(null,g,String(t[g]));return a&&a.appendChild(d),d}const le=typeof document<"u"?document.documentElement&&document.documentElement.style:null,se=le&&le.userSelect!==void 0?"userSelect":"WebkitUserSelect";let J;function Ee(){le&&se&&(J=le[se],le[se]="none")}function je(){le&&se&&(le[se]=J)}function Xe(h){h.preventDefault(),h.stopPropagation(),window.removeEventListener("click",Xe,!0)}function tt(){window.addEventListener("click",Xe,!0),window.setTimeout(()=>{window.removeEventListener("click",Xe,!0)},0)}function it(h,t){const a=h.getBoundingClientRect();return Nt(h,a,t)}function We(h,t){const a=h.getBoundingClientRect(),d=[];for(let g=0;g<t.length;g++)d.push(Nt(h,a,t[g]));return d}function Ct(h){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&h.button===2&&h.ctrlKey?0:h.button}function Nt(h,t,a){const d=h.offsetWidth===t.width?1:h.offsetWidth/t.width;return new o.P((a.clientX-t.left)*d,(a.clientY-t.top)*d)}const Wt="01",fr="NO_ACCESS_TOKEN";class dr{constructor(t,a,d){this._transformRequestFn=t,this._customAccessToken=a,this._silenceAuthErrors=!!d,this._createSkuToken()}_createSkuToken(){const t=function(){let a="";for(let d=0;d<10;d++)a+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Wt,a].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,a){return this._transformRequestFn&&this._transformRequestFn(t,a)||{url:t}}normalizeStyleURL(t,a){if(!o.h(t))return t;const d=Ut(t);return d.params.push(`sdk=js-${L}`),d.path=`/styles/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||a)}normalizeGlyphsURL(t,a){if(!o.h(t))return t;const d=Ut(t);return d.path=`/fonts/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||a)}normalizeModelURL(t,a){if(!o.h(t))return t;const d=Ut(t);return d.path=`/models/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||a)}normalizeSourceURL(t,a,d,g){if(!o.h(t))return t;const _=Ut(t);return _.path=`/v4/${_.authority}.json`,_.params.push("secure"),d&&_.params.push(`language=${d}`),g&&_.params.push(`worldview=${g}`),this._makeAPIURL(_,this._customAccessToken||a)}normalizeIconsetURL(t,a){const d=Ut(t);return o.h(t)?(d.path=`/styles/v1${d.path}/iconset.pbf`,this._makeAPIURL(d,this._customAccessToken||a)):jr(d)}normalizeSpriteURL(t,a,d,g){const _=Ut(t);return o.h(t)?(_.path=`/styles/v1${_.path}/sprite${a}${d}`,this._makeAPIURL(_,this._customAccessToken||g)):(_.path+=`${a}${d}`,jr(_))}normalizeTileURL(t,a,d){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!o.h(t))return t;const g=Ut(t);g.path=g.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${a||d&&g.authority!=="raster"&&d===512?"@2x":""}${o.k.supported?".webp":"$1"}`),g.authority==="raster"?g.path=`/${o.e.RASTER_URL_PREFIX}${g.path}`:g.authority==="rasterarrays"?g.path=`/${o.e.RASTERARRAYS_URL_PREFIX}${g.path}`:g.authority==="3dtiles"?g.path=`/${o.e.TILES3D_URL_PREFIX}${g.path}`:(g.path=g.path.replace(/^.+\/v4\//,"/"),g.path=`/${o.e.TILE_URL_VERSION}${g.path}`);const _=this._customAccessToken||function(b){for(const T of b){const I=T.match(/^access_token=(.*)$/);if(I)return I[1]}return null}(g.params)||o.e.ACCESS_TOKEN;return o.e.REQUIRE_ACCESS_TOKEN&&_&&this._skuToken&&g.params.push(`sku=${this._skuToken}`),this._makeAPIURL(g,_)}canonicalizeTileURL(t,a){const d=Ut(t);if(!d.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!d.path.match(/\.[\w]+$/))return t;let g="mapbox://";d.path.match(/^\/raster\/v1\//)?g+=`raster/${d.path.replace(`/${o.e.RASTER_URL_PREFIX}/`,"")}`:d.path.match(/^\/rasterarrays\/v1\//)?g+=`rasterarrays/${d.path.replace(`/${o.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:g+=`tiles/${d.path.replace(`/${o.e.TILE_URL_VERSION}/`,"")}`;let _=d.params;return a&&(_=_.filter(b=>!b.match(/^access_token=/))),_.length&&(g+=`?${_.join("&")}`),g}canonicalizeTileset(t,a){const d=!!a&&o.h(a),g=[];for(const _ of t.tiles||[])o.j(_)?g.push(this.canonicalizeTileURL(_,d)):g.push(_);return g}_makeAPIURL(t,a){const d="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",g=Ut(o.e.API_URL);if(t.protocol=g.protocol,t.authority=g.authority,t.protocol==="http"){const _=t.params.indexOf("secure");_>=0&&t.params.splice(_,1)}if(g.path!=="/"&&(t.path=`${g.path}${t.path}`),!o.e.REQUIRE_ACCESS_TOKEN)return jr(t);if(a=a||o.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!a)throw new Error(`An API access token is required to use Mapbox GL. ${d}`);if(a[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${d}`)}return t.params=t.params.filter(_=>_.indexOf("access_token")===-1),t.params.push(`access_token=${a||""}`),jr(t)}}const cr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Ut(h){const t=h.match(cr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function jr(h){const t=h.params.length?`?${h.params.join("&")}`:"";return`${h.protocol}://${h.authority}${h.path}${t}`}const Ht="mapbox.eventData";function xr(h){if(!h)return null;const t=h.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(o.l(t[1]))}catch{return null}}class Rt{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const a=xr(o.e.ACCESS_TOKEN);let d="";return d=a&&a.u?o.f(a.u):o.e.ACCESS_TOKEN||"",t?`${Ht}.${t}:${d}`:`${Ht}:${d}`}fetchEventData(){const t=o.s("localStorage"),a=this.getStorageKey(),d=this.getStorageKey("uuid");if(t)try{const g=localStorage.getItem(a);g&&(this.eventData=JSON.parse(g));const _=localStorage.getItem(d);_&&(this.anonId=_)}catch{o.w("Unable to read from LocalStorage")}}saveEventData(){const t=o.s("localStorage"),a=this.getStorageKey(),d=this.getStorageKey("uuid"),g=this.anonId;if(t&&g)try{localStorage.setItem(d,g),Object.keys(this.eventData).length>=1&&localStorage.setItem(a,JSON.stringify(this.eventData))}catch{o.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,a,d,g){if(!o.e.EVENTS_URL)return;const _=Ut(o.e.EVENTS_URL);_.params.push(`access_token=${g||o.e.ACCESS_TOKEN||""}`);const b={event:this.type,created:new Date(t).toISOString()},T=a?Object.assign(b,a):b,I={url:jr(_),headers:{"Content-Type":"text/plain"},body:JSON.stringify([T])};this.pendingRequest=o.p(I,k=>{this.pendingRequest=null,d(k),this.saveEventData(),this.processRequests(g)})}queueRequest(t,a){this.queue.push(t),this.processRequests(a)}}const rr=new class extends Rt{constructor(h){super("appUserTurnstile"),this._customAccessToken=h}postTurnstileEvent(h,t){o.e.EVENTS_URL&&o.e.ACCESS_TOKEN&&Array.isArray(h)&&h.some(a=>o.h(a)||o.j(a))&&this.queueRequest(Date.now(),t)}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=xr(o.e.ACCESS_TOKEN),a=t?t.u:o.e.ACCESS_TOKEN;let d=a!==this.eventData.tokenU;o.v(this.anonId)||(this.anonId=o.u(),d=!0);const g=this.queue.shift();if(this.eventData.lastSuccess){const _=new Date(this.eventData.lastSuccess),b=new Date(g),T=(g-this.eventData.lastSuccess)/864e5;d=d||T>=1||T<-1||_.getDate()!==b.getDate()}else d=!0;d?this.postEvent(g,{sdkIdentifier:"mapbox-gl-js",sdkVersion:L,skuId:Wt,"enabled.telemetry":!1,userId:this.anonId},_=>{_||(this.eventData.lastSuccess=g,this.eventData.tokenU=a)},h):this.processRequests()}},Nr=rr.postTurnstileEvent.bind(rr),Un=new class extends Rt{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(h,t,a,d){this.skuToken=t,this.errorCb=d,o.e.EVENTS_URL&&(a||o.e.ACCESS_TOKEN?this.queueRequest({id:h,timestamp:Date.now()},a):this.errorCb(new Error(fr)))}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:a}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),o.v(this.anonId)||(this.anonId=o.u()),this.postEvent(a,{sdkIdentifier:"mapbox-gl-js",sdkVersion:L,skuId:Wt,skuToken:this.skuToken,userId:this.anonId},d=>{d?this.errorCb(d):t&&(this.success[t]=!0)},h))}remove(){this.errorCb=null}},us=Un.postMapLoadEvent.bind(Un),rs=new class extends Rt{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(h){let t=this.mapInstanceIdMap.get(h);return t||(t=o.u(),this.mapInstanceIdMap.set(h,t)),t}getEventId(h){const t=this.eventIdPerMapInstanceMap.get(h)||0;return this.eventIdPerMapInstanceMap.set(h,t+1),t}postStyleLoadEvent(h,t){const{map:a,style:d,importedStyles:g}=t;if(!o.e.EVENTS_URL||!h&&!o.e.ACCESS_TOKEN)return;const _=this.getMapInstanceId(a),b={mapInstanceId:_,eventId:this.getEventId(_),style:d};g.length&&(b.importedStyles=g),this.queueRequest({timestamp:Date.now(),payload:b},h)}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:a}=this.queue.shift();this.postEvent(t,a,()=>{},h)}},Yr=rs.postStyleLoadEvent.bind(rs),vi=new class extends Rt{constructor(){super("gljs.performance")}postPerformanceEvent(h,t){o.e.EVENTS_URL&&(h||o.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},h)}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:a}=this.queue.shift(),d=function(g){const _=performance.getEntriesByType("resource"),b=performance.getEntriesByType("mark"),T=function(z){const B={};if(z){for(const U in z)if(U!=="other")for(const Y of z[U]){const H=`${U}ResolveRangeMin`,K=`${U}ResolveRangeMax`,ne=`${U}RequestCount`,ce=`${U}RequestCachedCount`;B[H]=Math.min(B[H]||1/0,Y.startTime),B[K]=Math.max(B[K]||-1/0,Y.responseEnd);const ge=pe=>{B[pe]===void 0&&(B[pe]=0),++B[pe]};Y.transferSize!==void 0&&Y.transferSize===0&&ge(ce),ge(ne)}}return B}(function(z,B){const U={};if(z)for(const Y of z){const H=B(Y);U[H]===void 0&&(U[H]=[]),U[H].push(Y)}return U}(_,$)),I=window.devicePixelRatio,k=navigator.connection||navigator.mozConnection||navigator.webkitConnection,N=k?k.effectiveType:void 0,j={counters:[],metadata:[],attributes:[]},R=(z,B,U)=>{U!=null&&z.push({name:B,value:U.toString()})};for(const z in T)R(j.counters,z,T[z]);if(g.interactionRange[0]!==1/0&&g.interactionRange[1]!==-1/0&&(R(j.counters,"interactionRangeMin",g.interactionRange[0]),R(j.counters,"interactionRangeMax",g.interactionRange[1])),b)for(const z of Object.keys(F)){const B=F[z],U=b.find(Y=>Y.name===B);U&&R(j.counters,B,U.startTime)}return R(j.counters,"visibilityHidden",g.visibilityHidden),R(j.attributes,"style",function(z){if(z)for(const B of z){const U=B.name.split("?")[0];if(o.i(U)){const Y=U.split("/").slice(-2);if(Y.length===2)return`mapbox://styles/${Y[0]}/${Y[1]}`}}}(_)),R(j.attributes,"terrainEnabled",g.terrainEnabled?"true":"false"),R(j.attributes,"fogEnabled",g.fogEnabled?"true":"false"),R(j.attributes,"projection",g.projection),R(j.attributes,"zoom",g.zoom),R(j.metadata,"devicePixelRatio",I),R(j.metadata,"connectionEffectiveType",N),R(j.metadata,"navigatorUserAgent",navigator.userAgent),R(j.metadata,"screenWidth",window.screen.width),R(j.metadata,"screenHeight",window.screen.height),R(j.metadata,"windowWidth",window.innerWidth),R(j.metadata,"windowHeight",window.innerHeight),R(j.metadata,"mapWidth",g.width/I),R(j.metadata,"mapHeight",g.height/I),R(j.metadata,"webglRenderer",g.renderer),R(j.metadata,"webglVendor",g.vendor),R(j.metadata,"sdkVersion",L),R(j.metadata,"sdkIdentifier","mapbox-gl-js"),j}(a);for(const g of d.metadata);for(const g of d.counters);for(const g of d.attributes);this.postEvent(t,d,()=>{},h)}},Vi=vi.postPerformanceEvent.bind(vi),Vn=new class extends Rt{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(h,t,a,d){if(!o.e.API_URL||!o.e.SESSION_PATH)return;const g=Ut(o.e.API_URL+o.e.SESSION_PATH);g.params.push(`sku=${t||""}`),g.params.push(`access_token=${d||o.e.ACCESS_TOKEN||""}`);const _={url:jr(g),headers:{"Content-Type":"text/plain"}};this.pendingRequest=o.g(_,b=>{this.pendingRequest=null,a(b),this.saveEventData(),this.processRequests(d)})}getSessionAPI(h,t,a,d){this.skuToken=t,this.errorCb=d,o.e.SESSION_PATH&&o.e.API_URL&&(a||o.e.ACCESS_TOKEN?this.queueRequest({id:h,timestamp:Date.now()},a):this.errorCb(new Error(fr)))}processRequests(h){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:a}=this.queue.shift();t&&this.success[t]||this.getSession(a,this.skuToken,d=>{d?this.errorCb(d):t&&(this.success[t]=!0)},h)}remove(){this.errorCb=null}},or=Vn.getSessionAPI.bind(Vn),pr=new Set;function $r(h,t){t?pr.add(h):pr.delete(h)}class Di{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,a){this._updatedSourceCaches[t]=a,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const a=t.scope;this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._updatedLayers[a].add(t.id),this.setDirty()}removeLayer(t){const a=t.scope;this._removedLayers[a]=this._removedLayers[a]||{},this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._removedLayers[a][t.id]=t,this._updatedLayers[a].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const a in this._updatedLayers)t[a]=t[a]||{},t[a].updatedIds=Array.from(this._updatedLayers[a].values());for(const a in this._removedLayers)t[a]=t[a]||{},t[a].removedIds=Object.keys(this._removedLayers[a]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,a){this._updatedImages[a]=this._updatedImages[a]||new Set,this._updatedImages[a].add(o.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function oi(h){const{userImage:t}=h;return!!(t&&t.render&&t.render())&&(h.data.replace(new Uint8Array(t.data.buffer)),!0)}class Gr extends o.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&o.r()&&(this.imageRasterizerDispatcher=new o.D(o.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new o.q({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const a=this.atlasTexture.get(t);a&&(a.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,a){this.imageProviders.has(a)||this.imageProviders.set(a,new Map),this.imageProviders.get(a).set(t.id,t)}removeImageProvider(t,a){this.imageProviders.has(a)&&this.imageProviders.get(a).delete(t)}getPendingImageProviders(){const t=[];for(const a of this.imageProviders.values())for(const d of a.values())d.hasPendingRequests()&&t.push(d);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new o.x),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,a){if(this.loaded.get(a)!==t&&(this.loaded.set(a,t),t)){for(const{ids:d,callback:g}of this.requestors)this._notify(d,a,g);this.requestors=[]}}hasImage(t,a){return!!this.getImage(t,a)}getImage(t,a){return this.images.get(a).get(t.toString())}addImage(t,a,d){this._validate(t,d)&&this.images.get(a).set(t.toString(),d)}_validate(t,a){let d=!0;return this._validateStretch(a.stretchX,a.data&&a.data.width)||(this.fire(new o.y(new Error(`Image "${t.name}" has invalid "stretchX" value`))),d=!1),this._validateStretch(a.stretchY,a.data&&a.data.height)||(this.fire(new o.y(new Error(`Image "${t.name}" has invalid "stretchY" value`))),d=!1),this._validateContent(a.content,a)||(this.fire(new o.y(new Error(`Image "${t.name}" has invalid "content" value`))),d=!1),d}_validateStretch(t,a){if(!t)return!0;let d=0;for(const g of t){if(g[0]<d||g[1]<g[0]||a<g[1])return!1;d=g[1]}return!0}_validateContent(t,a){return t?t.length!==4||!a.usvg&&(t[0]<0||a.data.width<t[0]||t[1]<0||a.data.height<t[1]||t[2]<0||a.data.width<t[2]||t[3]<0||a.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,a,d){const g=this.images.get(a).get(t.toString());d.version=g.version+1,this.images.get(a).set(t.toString(),d),this.updatedImages.get(a).add(t),this.removeFromImageRasterizerCache(t,a)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,a){this.spriteFormat!=="raster"&&(o.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:a}):this.imageRasterizer.removeImagesFromCacheByIds([t],a))}removeImage(t,a){const d=this.images.get(a),g=d.get(t.toString());d.delete(t.toString()),this.patterns.get(a).delete(t.toString()),this.removeFromImageRasterizerCache(t,a),g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(a=>o.I.from(a))}getImages(t,a,d){const g=[],_=[],b=this.imageProviders.get(a);for(const N of t){if(!N.iconsetId){g.push(N);continue}const j=b.get(N.iconsetId);j&&(this.getImage(N,a)?_.push(N):j.addPendingRequest(N))}if(g.length===0)return void this._notify(_,a,d);let T=!0;const I=!!this.loaded.get(a),k=this.images.get(a);if(!I)for(const N of g)k.has(N.toString())||(T=!1);I||T?this._notify(g,a,d):this.requestors.push({ids:g,scope:a,callback:d})}rasterizeImages(t,a){const d=new Map,{tasks:g,scope:_}=t;for(const[b,T]of g.entries()){const I=this.getImage(T.id,_);I&&d.set(b,{image:I,imageVariant:T})}this._rasterizeImages(_,d,a)}_rasterizeImages(t,a,d){if(o.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:a,scope:t},d);else{const g=new Map;for(const[_,{image:b,imageVariant:T}]of a.entries())g.set(_,this.imageRasterizer.rasterize(T,b,t,0));d(void 0,g)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,a,d){const g=this.images.get(a),_=new Map;for(const b of t){if(!g.get(b.toString())){if(b.iconsetId)continue;this.fire(new o.z("styleimagemissing",{id:b.name}))}const T=g.get(b.toString());if(!T){o.w(`Image "${b.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const I={data:T.usvg?null:T.data.clone(),pixelRatio:T.pixelRatio,sdf:T.sdf,usvg:T.usvg,version:T.version,stretchX:T.stretchX,stretchY:T.stretchY,content:T.content,hasRenderCallback:!!(T.userImage&&T.userImage.render)};T.usvg&&Object.assign(I,{width:T.icon.usvg_tree.width,height:T.icon.usvg_tree.height}),_.set(o.I.toString(b),I)}d(null,_)}getPixelSize(t){const{width:a,height:d}=this.atlasImage.get(t);return{width:a,height:d}}getPattern(t,a,d){const g=t.toString(),_=this.patterns.get(a),b=_.get(g),T=this.getImage(t,a);if(!T)return null;if(b){if(b.position.version===T.version)return b.position;b.position.version=T.version}else{if(T.usvg&&!T.data){const I=this.getPatternInFlightId(g,a);if(this.patternsInFlight.has(I))return null;this.patternsInFlight.add(I);const k=new o.A(t).scaleSelf(o.o.devicePixelRatio),N=new Map([[k.toString(),{image:T,imageVariant:k}]]);return this._rasterizeImages(a,N,(j,R)=>this.storePatternImage(k,a,T,d,R)),null}this.storePattern(t,a,T)}return this._updatePatternAtlas(a,d),_.get(g).position}getPatternInFlightId(t,a){return o.B(t,a)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,a,d,g,_){const b=t.toString(),T=_?_.get(b):void 0;T&&(d.data=T,this.storePattern(t.id,a,d),this._updatePatternAtlas(a,g),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),a)))}storePattern(t,a,d){const g={w:d.data.width+2*o.C,h:d.data.height+2*o.C,x:0,y:0},_=new o.F(g,d,o.C);this.patterns.get(a).set(t.toString(),{bin:g,position:_})}destroyAtlasTextures(){for(const t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,a){const d=t.gl;let g=this.atlasTexture.get(a);g?this.dirty&&(g.update(this.atlasImage.get(a)),this.dirty=!1):(g=new o.T(t,this.atlasImage.get(a),d.RGBA8),this.atlasTexture.set(a,g)),g.bind(d.LINEAR,d.CLAMP_TO_EDGE)}_updatePatternAtlas(t,a){const d=this.patterns.get(t),g=Array.from(d.values()).map(({bin:k})=>k),{w:_,h:b}=o.G(g),T=this.atlasImage.get(t);T.resize({width:_||1,height:b||1});const I=this.images.get(t);for(const[k,{bin:N,position:j}]of d.entries()){let R=j.padding;const z=N.x+R,B=N.y+R,U=I.get(k).data,Y=U.width,H=U.height;R=R>1?R-1:R,o.q.copy(U,T,{x:0,y:0},{x:z,y:B},{width:Y,height:H},a),o.q.copy(U,T,{x:0,y:H-R},{x:z,y:B-R},{width:Y,height:R},a),o.q.copy(U,T,{x:0,y:0},{x:z,y:B+H},{width:Y,height:R},a),o.q.copy(U,T,{x:Y-R,y:0},{x:z-R,y:B},{width:R,height:H},a),o.q.copy(U,T,{x:0,y:0},{x:z+Y,y:B},{width:R,height:H},a),o.q.copy(U,T,{x:Y-R,y:H-R},{x:z-R,y:B-R},{width:R,height:R},a),o.q.copy(U,T,{x:0,y:H-R},{x:z+Y,y:B-R},{width:R,height:R},a),o.q.copy(U,T,{x:0,y:0},{x:z+Y,y:B+H},{width:R,height:R},a),o.q.copy(U,T,{x:Y-R,y:0},{x:z-R,y:B+H},{width:R,height:R},a)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,a){const d=this.images.get(a);for(const g of t){if(this.callbackDispatchedThisFrame.get(a).has(g.toString()))continue;this.callbackDispatchedThisFrame.get(a).add(g.toString());const _=d.get(g.toString());oi(_)&&this.updateImage(g,a,_)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function un(h){const t=h.value,a=h.valueSpec,d=h.style,g=h.styleSpec,_=h.key,b=h.arrayElementValidator||Ui;if(!Array.isArray(t))return[new o.V(_,t,`array expected, ${o.K(t)} found`)];if(a.length&&t.length!==a.length)return[new o.V(_,t,`array length ${a.length} expected, length ${t.length} found`)];if(a["min-length"]&&t.length<a["min-length"])return[new o.V(_,t,`array length at least ${a["min-length"]} expected, length ${t.length} found`)];let T={type:a.value,values:a.values,minimum:a.minimum,maximum:a.maximum,function:void 0};g.$version<7&&(T.function=a.function),o.H(a.value)&&(T=a.value);let I=[];for(let k=0;k<t.length;k++)I=I.concat(b({array:t,arrayIndex:k,value:t[k],valueSpec:T,style:d,styleSpec:g,key:`${_}[${k}]`},!0));return I}function Zn(h){const t=h.key,a=h.value,d=h.valueSpec;if(!o.L(a))return[new o.V(t,a,`number expected, ${o.K(a)} found`)];if(a!=a)return[new o.V(t,a,"number expected, NaN found")];if("minimum"in d){let g=d.minimum;if(Array.isArray(d.minimum)&&(g=d.minimum[h.arrayIndex]),a<g)return[new o.V(t,a,`${a} is less than the minimum value ${g}`)]}if("maximum"in d){let g=d.maximum;if(Array.isArray(d.maximum)&&(g=d.maximum[h.arrayIndex]),a>g)return[new o.V(t,a,`${a} is greater than the maximum value ${g}`)]}return[]}function po(h){const t=h.key,a=h.value;if(!o.H(a))return[new o.V(t,a,`object expected, ${o.K(a)} found`)];const d=h.valueSpec,g=o.J(a.type);let _,b,T,I={};const k=g!=="categorical"&&a.property===void 0,N=!k,j=function(U){const Y=U.stops;return Array.isArray(Y)&&Array.isArray(Y[0])&&o.H(Y[0][0])}(a),R=jn({key:h.key,value:h.value,valueSpec:h.styleSpec.function,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{stops:function(U){if(g==="identity")return[new o.V(U.key,U.value,'identity function may not have a "stops" property')];let Y=[];const H=U.value;return Y=Y.concat(un({key:U.key,value:H,valueSpec:U.valueSpec,style:U.style,styleSpec:U.styleSpec,arrayElementValidator:z})),Array.isArray(H)&&H.length===0&&Y.push(new o.V(U.key,H,"array must have at least one stop")),Y},default:function(U){return Ui({key:U.key,value:U.value,valueSpec:d,style:U.style,styleSpec:U.styleSpec})}}});return g==="identity"&&k&&R.push(new o.V(h.key,h.value,'missing required property "property"')),g==="identity"||a.stops||R.push(new o.V(h.key,h.value,'missing required property "stops"')),g==="exponential"&&d.expression&&!o.M(d)&&R.push(new o.V(h.key,h.value,"exponential functions not supported")),h.styleSpec.$version>=8&&(N&&!o.N(d)?R.push(new o.V(h.key,h.value,"property functions not supported")):k&&!o.O(d)&&R.push(new o.V(h.key,h.value,"zoom functions not supported"))),g!=="categorical"&&!j||a.property!==void 0||R.push(new o.V(h.key,h.value,'"property" property is required')),R;function z(U){let Y=[];const H=U.value,K=U.key;if(!Array.isArray(H))return[new o.V(K,H,`array expected, ${o.K(H)} found`)];if(H.length!==2)return[new o.V(K,H,`array length 2 expected, length ${H.length} found`)];if(j){if(!o.H(H[0]))return[new o.V(K,H,`object expected, ${o.K(H[0])} found`)];const ne=H[0];if(ne.zoom===void 0)return[new o.V(K,H,"object stop key must have zoom")];if(ne.value===void 0)return[new o.V(K,H,"object stop key must have value")];const ce=o.J(ne.zoom);if(typeof ce!="number")return[new o.V(K,ne.zoom,"stop zoom values must be numbers")];if(T&&T>ce)return[new o.V(K,ne.zoom,"stop zoom values must appear in ascending order")];ce!==T&&(T=ce,b=void 0,I={}),Y=Y.concat(jn({key:`${K}[0]`,value:H[0],valueSpec:{zoom:{}},style:U.style,styleSpec:U.styleSpec,objectElementValidators:{zoom:Zn,value:B}}))}else Y=Y.concat(B({key:`${K}[0]`,value:H[0],style:U.style,styleSpec:U.styleSpec},H));return o.Q(o.S(H[1]))?Y.concat([new o.V(`${K}[1]`,H[1],"expressions are not allowed in function stops.")]):Y.concat(Ui({key:`${K}[1]`,value:H[1],valueSpec:d,style:U.style,styleSpec:U.styleSpec}))}function B(U,Y){const H=o.K(U.value),K=o.J(U.value),ne=U.value!==null?U.value:Y;if(_){if(H!==_)return[new o.V(U.key,ne,`${H} stop domain type must match previous stop domain type ${_}`)]}else _=H;if(H!=="number"&&H!=="string"&&H!=="boolean"&&typeof K!="number"&&typeof K!="string"&&typeof K!="boolean")return[new o.V(U.key,ne,"stop domain value must be a number, string, or boolean")];if(H!=="number"&&g!=="categorical"){let ce=`number expected, ${H} found`;return o.N(d)&&g===void 0&&(ce+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new o.V(U.key,ne,ce)]}return g!=="categorical"||H!=="number"||typeof K=="number"&&isFinite(K)&&Math.floor(K)===K?g!=="categorical"&&H==="number"&&typeof K=="number"&&typeof b=="number"&&b!==void 0&&K<b?[new o.V(U.key,ne,"stop domain values must appear in ascending order")]:(b=K,g==="categorical"&&K in I?[new o.V(U.key,ne,"stop domain values must be unique")]:(I[K]=!0,[])):[new o.V(U.key,ne,`integer expected, found ${String(K)}`)]}}function In(h){const t=(h.expressionContext==="property"?o.W:o.U)(o.S(h.value),h.valueSpec);if(t.result==="error")return t.value.map(d=>new o.V(`${h.key}${d.key}`,h.value,d.message));const a=t.value.expression||t.value._styleExpression.expression;if(h.expressionContext==="property"&&h.propertyKey==="text-font"&&!a.outputDefined())return[new o.V(h.key,h.value,`Invalid data expression for "${h.propertyKey}". Output values must be contained as literals within the expression.`)];if(h.expressionContext==="property"&&h.propertyType==="layout"&&!o.Z(a))return[new o.V(h.key,h.value,'"feature-state" data expressions are not supported with layout properties.')];if(h.expressionContext==="filter")return ji(a,h);if(h.expressionContext==="appearance")return on(a,h);if(h.expressionContext&&h.expressionContext.indexOf("cluster")===0){if(!o.X(a,["zoom","feature-state"]))return[new o.V(h.key,h.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(h.expressionContext==="cluster-initial"&&!o.Y(a))return[new o.V(h.key,h.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ji(h,t){const a=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const g of t.valueSpec.expression.parameters)a.delete(g);if(a.size===0)return[];const d=[];return h instanceof o._&&a.has(h.name)?[new o.V(t.key,t.value,`["${h.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(h.eachChild(g=>{d.push(...ji(g,t))}),d)}function on(h,t){const a=new Set;if(t.valueSpec&&t.valueSpec.expression)for(const g of t.valueSpec.expression.parameters)a.add(g);if(a.size===0)return[];const d=[];return h instanceof o._&&!a.has(h.name)?[new o.V(t.key,t.value,`["${h.name}"] is not an allowed parameter`)]:(h.eachChild(g=>{d.push(...on(g,t))}),d)}function $s(h){const t=h.key,a=h.value,d=h.valueSpec,g=[];return Array.isArray(d.values)?d.values.indexOf(o.J(a))===-1&&g.push(new o.V(t,a,`expected one of [${d.values.join(", ")}], ${JSON.stringify(a)} found`)):Object.keys(d.values).indexOf(o.J(a))===-1&&g.push(new o.V(t,a,`expected one of [${Object.keys(d.values).join(", ")}], ${JSON.stringify(a)} found`)),g}function Ts(h){return o.a2(o.S(h.value))?In(Object.assign({},h,{expressionContext:"filter",valueSpec:h.styleSpec[`filter_${h.layerType||"fill"}`]})):Co(h)}function Co(h){const t=h.value,a=h.key;if(!Array.isArray(t))return[new o.V(a,t,`array expected, ${o.K(t)} found`)];if(t.length<1)return[new o.V(a,t,"filter array must have at least 1 element")];const d=h.styleSpec;let g=$s({key:`${a}[0]`,value:t[0],valueSpec:d.filter_operator});switch(o.J(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&o.J(t[1])==="$type"&&g.push(new o.V(a,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&g.push(new o.V(a,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(o.a0(t[1])||g.push(new o.V(`${a}[1]`,t[1],`string expected, ${o.K(t[1])} found`)));for(let _=2;_<t.length;_++)o.J(t[1])==="$type"?g=g.concat($s({key:`${a}[${_}]`,value:t[_],valueSpec:d.geometry_type})):o.a0(t[_])||o.L(t[_])||o.$(t[_])||g.push(new o.V(`${a}[${_}]`,t[_],`string, number, or boolean expected, ${o.K(t[_])} found.`));break;case"any":case"all":case"none":for(let _=1;_<t.length;_++)g=g.concat(Co({key:`${a}[${_}]`,value:t[_],style:h.style,styleSpec:h.styleSpec}));break;case"has":case"!has":t.length!==2?g.push(new o.V(a,t,`filter array for "${t[0]}" operator must have 2 elements`)):o.a0(t[1])||g.push(new o.V(`${a}[1]`,t[1],`string expected, ${o.K(t[1])} found`))}return g}function Rl(h,t){const a=h.key,d=h.style,g=h.layer,_=h.styleSpec,b=h.value,T=h.objectKey,I=_[`${t}_${h.layerType}`];if(!I)return[];const k=T.match(/^(.*)-use-theme$/);if(k&&I[k[1]])return o.Q(b)?[].concat(Ui({key:h.key,value:b,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:d,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:T})):Ui({key:a,value:b,valueSpec:{type:"string"},style:d,styleSpec:_});const N=T.match(/^(.*)-transition$/);if(t==="paint"&&N&&I[N[1]]&&I[N[1]].transition)return Ui({key:a,value:b,valueSpec:_.transition,style:d,styleSpec:_});const j=h.valueSpec||I[T];if(!j)return[new o.a3(a,b,`unknown property "${T}"`)];let R;if(o.a0(b)&&o.N(j)&&!j.tokens&&(R=/^{([^}]+)}$/.exec(b))){const B=`\`{ "type": "identity", "property": ${R?JSON.stringify(R[1]):'"_"'} }\``;return[new o.V(a,b,`"${T}" does not support interpolation syntax
Use an identity property function instead: ${B}.`)]}const z=[];if(h.layerType==="symbol")T!=="text-field"||!d||d.glyphs||d.imports||z.push(new o.V(a,b,'use of "text-field" requires a style "glyphs" property')),T==="text-font"&&o.a4(o.S(b))&&o.J(b.type)==="identity"&&z.push(new o.V(a,b,'"text-font" does not support identity functions'));else if(h.layerType==="model"&&t==="paint"&&g&&g.layout&&g.layout.hasOwnProperty("model-id")&&o.N(j)&&(o.a5(j)||o.O(j))){const B=o.W(o.S(b),j),U=B.value.expression||B.value._styleExpression.expression;U&&!o.X(U,["measure-light"])&&(T==="model-emissive-strength"&&o.Y(U)&&o.Z(U)||z.push(new o.V(a,b,`${T} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return z.concat(Ui({key:h.key,value:b,valueSpec:j,style:d,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:T}))}function Es(h){return Rl(h,"paint")}function Gs(h){return Rl(h,"layout")}function $u(h){let t=[];const a=h.value,d=h.key,g=h.style,_=h.styleSpec;if(!o.H(a))return[new o.V(d,a,"object expected")];a.type||a.ref||t.push(new o.V(d,a,'either "type" or "ref" is required'));let b=o.J(a.type);const T=o.J(a.ref);if(a.id){const I=o.J(a.id);for(let k=0;k<h.arrayIndex;k++){const N=g.layers[k];o.J(N.id)===I&&t.push(new o.V(d,a.id,`duplicate layer id "${I}", previously used at line ${N.id.__line__}`))}}if("ref"in a){let I;["type","source","source-layer","filter","layout"].forEach(k=>{k in a&&t.push(new o.V(d,a[k],`"${k}" is prohibited for ref layers`))}),g.layers.forEach(k=>{o.J(k.id)===T&&(I=k)}),I?I.ref?t.push(new o.V(d,a.ref,"ref cannot reference another ref layer")):b=o.J(I.type):typeof T=="string"&&t.push(new o.V(d,a.ref,`ref layer "${T}" not found`))}else if(b!=="background"&&b!=="sky"&&b!=="slot")if(a.source)if(o.a0(a.source)){const I=g.sources&&g.sources[a.source],k=I&&o.J(I.type);I?k==="vector"&&b==="raster"?t.push(new o.V(d,a.source,`layer "${a.id}" requires a raster source`)):k==="raster"&&b!=="raster"?t.push(new o.V(d,a.source,`layer "${a.id}" requires a vector source`)):k!=="vector"||a["source-layer"]?k==="raster-dem"&&b!=="hillshade"?t.push(new o.V(d,a.source,"raster-dem source can only be used with layer type 'hillshade'.")):k!=="raster-array"||["raster","raster-particle"].includes(b)?b==="line"&&a.paint&&(a.paint["line-gradient"]||a.paint["line-trim-offset"])&&k==="geojson"&&!I.lineMetrics?t.push(new o.V(d,a,`layer "${a.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):b==="raster-particle"&&k!=="raster-array"&&t.push(new o.V(d,a.source,`layer "${a.id}" requires a 'raster-array' source.`)):t.push(new o.V(d,a.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new o.V(d,a,`layer "${a.id}" must specify a "source-layer"`)):t.push(new o.V(d,a.source,`source "${a.source}" not found`))}else t.push(new o.V(`${d}.source`,a.source,'"source" must be a string'));else t.push(new o.V(d,a,'missing required property "source"'));return t=t.concat(jn({key:d,value:a,valueSpec:_.layer,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ui({key:`${d}.type`,value:a.type,valueSpec:_.layer.type,style:h.style,styleSpec:h.styleSpec,object:a,objectKey:"type"}),filter:I=>Ts(Object.assign({layerType:b},I)),layout:I=>jn({layer:a,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":k=>Gs(Object.assign({layerType:b},k))}}),paint:I=>jn({layer:a,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":k=>Es(Object.assign({layerType:b,layer:a},k))}}),appearances(I){const k=un({key:I.key,value:I.value,valueSpec:I.valueSpec,style:I.style,styleSpec:I.styleSpec,arrayElementValidator:R=>function(z){const{key:B,layer:U,layerType:Y}=z,H=o.J(z.value),K=o.J(H.name),ne=o.J(H.condition),ce=jn({key:B,value:H,valueSpec:z.styleSpec.appearance,style:z.style,styleSpec:z.styleSpec,objectElementValidators:{condition:ge=>function(pe){const _e=[];return _e.push(...In({key:pe.key,value:pe.object.condition,valueSpec:o.a6.appearance.condition,expressionContext:"appearance"})),_e}(Object.assign({layer:U,layerType:Y},ge)),properties:ge=>function(pe){const _e=[],{styleSpec:me,layer:fe,layerType:ye}=pe,Fe=me[`paint_${ye}`],Pe=me[`layout_${ye}`],Ze=pe.object[pe.objectKey];for(const De in Ze){const He=De in Fe?"paint":De in Pe?"layout":void 0;if(!He){_e.push(new o.V(pe.key,De,`unknown property "${De}" for layer type "${ye}"`));continue}const _t=Object.assign({},pe,{key:`${pe.key}.${De}`,object:Ze,objectKey:De,layer:fe,layerType:ye,value:Ze[De],valueSpec:He==="paint"?Fe[De]:Pe[De]});_e.push(...Rl(_t,He))}return _e}(Object.assign({layer:U,layerType:Y},ge))}});return K==="hidden"||ne||ce.push(new o.V(z.key,"name",'Appearance with name different than "hidden" must have a condition')),ce}(Object.assign({layerType:b,layer:a},R))}),N=Array.isArray(I.value)?I.value:[],j=new Set;return N.forEach((R,z)=>{const B=o.J(R.name);if(B)if(j.has(B)){const U=o.J(a.id);k.push(new o.V(I.key,B,`Duplicated appearance name "${B}" for layer "${U}"`))}else j.add(B)}),k}}})),t}function ya({key:h,value:t}){return o.a0(t)?[]:[new o.V(h,t,`string expected, ${o.K(t)} found`)]}const Tc={promoteId:function h({key:t,value:a}){if(o.a0(a))return ya({key:t,value:a});if(Array.isArray(a)){const g=[],_=o.S(a),b=o.U(_);return b.result==="error"&&b.value.forEach(T=>{g.push(new o.V(`${t}${T.key}`,null,`${T.message}`))}),o.X(b.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||g.push(new o.V(`${t}`,null,"promoteId expression should be only feature dependent")),g}if(!o.H(a))return[new o.V(t,a,`string, expression or object expected, "${o.K(a)}" found`)];const d=[];for(const g in a)d.push(...h({key:`${t}.${g}`,value:a[g]}));return d}};function $n(h){const t=h.value,a=h.key,d=h.styleSpec,g=h.style;if(!o.H(t))return[new o.V(a,t,`object expected, ${o.K(t)} found`)];if(!("type"in t))return[new o.V(a,t,'"type" is required')];const _=o.J(t.type);let b=[];switch(["vector","raster","raster-dem","raster-array"].includes(_)&&("url"in t||"tiles"in t||b.push(new o.a3(a,t,'Either "url" or "tiles" is required.'))),_){case"vector":case"raster":case"raster-dem":case"raster-array":return b=b.concat(jn({key:a,value:t,valueSpec:d[`source_${_.replace("-","_")}`],style:h.style,styleSpec:d,objectElementValidators:Tc})),b;case"geojson":if(b=jn({key:a,value:t,valueSpec:d.source_geojson,style:g,styleSpec:d,objectElementValidators:Tc}),"cluster"in t&&"clusterProperties"in t){if(!o.H(t.clusterProperties))return[new o.V(`${a}.clusterProperties`,t,`object expected, ${o.K(t)} found`)];for(const T in t.clusterProperties){const I=t.clusterProperties[T];if(!Array.isArray(I))return[new o.V(`${a}.clusterProperties.${T}`,I,"array expected")];const[k,N]=I,j=typeof k=="string"?[k,["accumulated"],["get",T]]:k;b.push(...In({key:`${a}.${T}.map`,value:N,expressionContext:"cluster-map"})),b.push(...In({key:`${a}.${T}.reduce`,value:j,expressionContext:"cluster-reduce"}))}}return b;case"video":return jn({key:a,value:t,valueSpec:d.source_video,style:g,styleSpec:d});case"image":return jn({key:a,value:t,valueSpec:d.source_image,style:g,styleSpec:d});case"canvas":return[new o.V(a,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return $s({key:`${a}.type`,value:t.type,valueSpec:{values:Ao(d)}})}}function Ao(h){return h.source.reduce((t,a)=>{const d=h[a];return d.type.type==="enum"&&(t=t.concat(Object.keys(d.type.values))),t},[])}function Gu(h){const t=h.value,a=h.styleSpec,d=a.light,g=h.style;if(t===void 0)return[];if(!o.H(t))return[new o.V("light",t,`object expected, ${o.K(t)} found`)];let _=[];for(const b in t){const T=b.match(/^(.*)-transition$/),I=b.match(/^(.*)-use-theme$/);_=_.concat(I&&d[I[1]]?Ui({key:b,value:t[b],valueSpec:{type:"string"},style:g,styleSpec:a}):T&&d[T[1]]&&d[T[1]].transition?Ui({key:b,value:t[b],valueSpec:a.transition,style:g,styleSpec:a}):d[b]?Ui({key:b,value:t[b],valueSpec:d[b],style:g,styleSpec:a}):[new o.V(b,t[b],`unknown property "${b}"`)])}return _}function Za(h){const t=h.value;if(!t)return[];const a=h.key;if(!o.H(t))return[new o.V(a,t,`object expected, ${o.K(t)} found`)];let d=[];const g=h.styleSpec,_=g["light-3d"],b=h.style,T=h.style.lights;for(const N of["type","id"])if(!(N in t))return d=d.concat([new o.V(a,t,`missing property "${N}"`)]),d;if(!o.a0(t.type))return d=d.concat([new o.V(`${a}.type`,t.type,"string expected")]),d;if(T)for(let N=0;N<h.arrayIndex;N++){const j=o.J(t.type),R=T[N];o.J(R.type)===j&&d.push(new o.V(a,t.id,`duplicate light type "${t.type}", previously defined at line ${R.id.__line__}`))}const I=`properties_light_${t.type}`;if(!(I in g))return d=d.concat([new o.V(`${a}.type`,t,`Invalid light type ${t.type}`)]),d;const k=g[I];for(const N in t)if(N==="properties"){const j=t[N];if(!o.H(j))return d=d.concat([new o.V("properties",j,`object expected, ${o.K(j)} found`)]),d;for(const R in j){const z=R.match(/^(.*)-transition$/),B=R.match(/^(.*)-use-theme$/);d=d.concat(B&&k[B[1]]?Ui({key:N,value:j[R],valueSpec:{type:"string"},style:b,styleSpec:g}):z&&k[z[1]]&&k[z[1]].transition?Ui({key:N,value:t[N],valueSpec:g.transition,style:b,styleSpec:g}):k[R]?Ui({key:R,value:j[R],valueSpec:k[R],style:b,styleSpec:g}):[new o.a3(h.key,j[R],`unknown property "${R}"`)])}}else d=d.concat(_[N]?Ui({key:N,value:t[N],valueSpec:_[N],style:b,styleSpec:g}):[new o.a3(N,t[N],`unknown property "${N}"`)]);return d}function Jo(h){const t=h.value,a=h.key,d=h.style,g=h.styleSpec,_=g.terrain;if(t==null)return[];if(!o.H(t))return[new o.V("terrain",t,`object expected, ${o.K(t)} found`)];let b=[];for(const T in t){const I=T.match(/^(.*)-transition$/),k=T.match(/^(.*)-use-theme$/);b=b.concat(k&&_[k[1]]?Ui({key:T,value:t[T],valueSpec:{type:"string"},style:d,styleSpec:g}):I&&_[I[1]]&&_[I[1]].transition?Ui({key:T,value:t[T],valueSpec:g.transition,style:d,styleSpec:g}):_[T]?Ui({key:T,value:t[T],valueSpec:_[T],style:d,styleSpec:g}):[new o.a3(T,t[T],`unknown property "${T}"`)])}if(t.source)if(o.a0(t.source)){const T=d.sources&&d.sources[t.source],I=T&&o.J(T.type);T?I!=="raster-dem"&&b.push(new o.V(`${a}.source`,t.source,`terrain cannot be used with a source of type ${I}, it only be used with a "raster-dem" source type`)):b.push(new o.V(`${a}.source`,t.source,`source "${t.source}" not found`))}else b.push(new o.V(`${a}.source`,t.source,"source must be a string"));else b.push(new o.V(a,t,'terrain is missing required property "source"'));return b}function xa(h){const t=h.value,a=h.style,d=h.styleSpec,g=d.fog;if(t===void 0)return[];if(!o.H(t))return[new o.V("fog",t,`object expected, ${o.K(t)} found`)];let _=[];for(const b in t){const T=b.match(/^(.*)-transition$/),I=b.match(/^(.*)-use-theme$/);_=_.concat(I&&g[I[1]]?Ui({key:b,value:t[b],valueSpec:{type:"string"},style:a,styleSpec:d}):T&&g[T[1]]&&g[T[1]].transition?Ui({key:b,value:t[b],valueSpec:d.transition,style:a,styleSpec:d}):g[b]?Ui({key:b,value:t[b],valueSpec:g[b],style:a,styleSpec:d}):[new o.a3(b,t[b],`unknown property "${b}"`)])}return _}const Ll={"*":()=>[],array:un,boolean:function(h){const t=h.value,a=h.key;return o.$(t)?[]:[new o.V(a,t,`boolean expected, ${o.K(t)} found`)]},number:Zn,color:function({key:h,value:t}){return o.a0(t)?o.a1.parseCSSColor(t)===null?[new o.V(h,t,`color expected, "${t}" found`)]:[]:[new o.V(h,t,`color expected, ${o.K(t)} found`)]},enum:$s,filter:Ts,function:po,layer:$u,object:jn,source:$n,model:o.a7,light:Gu,"light-3d":Za,terrain:Jo,fog:xa,string:ya,formatted:function(h){return ya(h).length===0?[]:In(h)},resolvedImage:function(h){return ya(h).length===0?[]:In(h)},projection:function(h){const t=h.value,a=h.styleSpec,d=a.projection,g=h.style;if(o.H(t)){let _=[];for(const b in t)_=_.concat(Ui({key:b,value:t[b],valueSpec:d[b],style:g,styleSpec:a}));return _}return o.a0(t)?[]:[new o.V("projection",t,`object or string expected, ${o.K(t)} found`)]},import:function(h){const t=h.key,{value:a,styleSpec:d}=h;if(!o.H(a))return[new o.V(t,a,"import must be an object")];const{data:g,..._}=a;Object.defineProperty(_,"__line__",{value:a.__line__,enumerable:!1});let b=jn(Object.assign({},h,{value:_,valueSpec:d.import}));return o.J(_.id)===""&&b.push(new o.V(`${h.key}.id`,_,"import id can't be an empty string")),g&&(b=b.concat(Ol(g,d,{key:`${h.key}.data`}))),b},iconset:function(h){const t=h.value,a=h.key,d=h.styleSpec,g=h.style;if(!o.H(t))return[new o.V(a,t,"object expected")];if(!t.type)return[new o.V(a,t,'"type" is required')];const _=o.J(t.type);let b=[];if(b=b.concat(jn({key:a,value:t,valueSpec:d[`iconset_${_}`],style:g,styleSpec:d})),function(T,I){return!(T!=="source"||!I.source)}(_,t)){const T=g.sources&&g.sources[t.source],I=T&&o.J(T.type);T?I!=="raster-array"&&b.push(new o.V(a,t.source,`iconset cannot be used with a source of type ${String(I)}, it only be used with a "raster-array" source type`)):b.push(new o.V(a,t.source,`source "${t.source}" not found`))}return b}};function Ui(h,t=!1){const a=h.value,d=h.valueSpec,g=h.styleSpec;if(d.expression){if(o.a4(o.J(a)))return po(h);if(o.Q(o.S(a)))return In(h)}if(d.type&&Ll[d.type]){const _=Ll[d.type](h);return t===!0&&_.length>0&&Array.isArray(h.value)?In(h):_}return jn(Object.assign({},h,{valueSpec:d.type?g[d.type]:d}))}function jn(h){const t=h.key,a=h.value,d=h.valueSpec||{},g=h.objectElementValidators||{},_=h.style,b=h.styleSpec;if(!o.H(a))return[new o.V(t,a,`object expected, ${o.K(a)} found`)];let T=[];for(const I in a){const k=I.split(".")[0];let N;g[k]?N=g[k]:d[k]?N=Ui:g["*"]?N=g["*"]:d["*"]&&(N=Ui),N?T=T.concat(N({key:(t&&`${t}.`)+I,value:a[I],valueSpec:d[k]||d["*"],style:_,styleSpec:b,object:a,objectKey:I},a)):T.push(new o.a3(t,a[I],`unknown property "${I}"`))}for(const I in d)g[I]||d[I].required&&d[I].default===void 0&&a[I]===void 0&&T.push(new o.V(t,a,`missing required property "${I}"`));return T}function qu({key:h,value:t}){const a=ya({key:h,value:t});if(a.length)return a;const d=t;return d.indexOf("{fontstack}")===-1&&a.push(new o.V(h,t,'"glyphs" url must include a "{fontstack}" token')),d.indexOf("{range}")===-1&&a.push(new o.V(h,t,'"glyphs" url must include a "{range}" token')),a}function Ol(h,t=o.a6,a={}){return jn({key:a.key||"",value:h,valueSpec:Object.assign(t.$root,{"*":{type:"*"}}),styleSpec:t,style:h,objectElementValidators:{glyphs:qu}})}function Po(h,t=o.a6){return we(Ol(h,t))}const Hu=h=>we($n(h)),Wu=h=>we(Gu(h)),fh=h=>we(Za(h)),ft=h=>we(Jo(h)),va=h=>we(xa(h)),Fp=h=>we(function(t){const a=t.value,d=t.style,g=t.styleSpec,_=g.snow;if(a===void 0)return[];if(!o.H(a))return[new o.V("snow",a,`object expected, ${o.K(a)} found`)];let b=[];for(const T in a){const I=T.match(/^(.*)-transition$/);b=b.concat(I&&_[I[1]]&&_[I[1]].transition?Ui({key:T,value:a[T],valueSpec:g.transition,style:d,styleSpec:g}):_[T]?Ui({key:T,value:a[T],valueSpec:_[T],style:d,styleSpec:g}):[new o.a3(T,a[T],`unknown property "${T}"`)])}return b}(h)),Ec=h=>we(function(t){const a=t.value,d=t.style,g=t.styleSpec,_=g.rain;if(a===void 0)return[];if(!o.H(a))return[new o.V("rain",a,`object expected, ${o.K(a)} found`)];let b=[];for(const T in a){const I=T.match(/^(.*)-transition$/);b=b.concat(I&&_[I[1]]&&_[I[1]].transition?Ui({key:T,value:a[T],valueSpec:g.transition,style:d,styleSpec:g}):_[T]?Ui({key:T,value:a[T],valueSpec:_[T],style:d,styleSpec:g}):[new o.a3(T,a[T],`unknown property "${T}"`)])}return b}(h)),Re=h=>we($u(h)),X=h=>we(Ts(h)),Q=h=>we(Es(h)),he=h=>we(Gs(h)),Te=h=>we(o.a7(h));function we(h){return h.slice().sort((t,a)=>t.line&&a.line?t.line-a.line:0)}function be(h,t){let a=!1;if(t&&t.length)for(const d of t)d instanceof o.a3?o.w(d.message):(h.fire(new o.y(new Error(d.message))),a=!0);return a}let Ge;class Me extends o.E{constructor(t,a="flat"){super(),this._transitionable=new o.a8(Ge||(Ge=new o.a9({anchor:new o.aa(o.a6.light.anchor),position:new o.ab(o.a6.light.position),color:new o.aa(o.a6.light.color),intensity:new o.aa(o.a6.light.intensity)}))),this.setLight(t,a),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,a,d={}){this._validate(Wu,t,d)||(this._transitionable.setTransitionOrValue(t),this.id=a)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,a,d){return(!d||d.validate!==!1)&&be(this,t.call(Po,Object.assign({value:a,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}let qe=class extends o.E{constructor(h,t,a,d,g){super(),this.scope=a,this._transitionable=new o.a8(new o.a9({source:new o.aa(o.a6.terrain.source),exaggeration:new o.aa(o.a6.terrain.exaggeration)}),a,d),this._transitionable.setTransitionOrValue(h,d),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=g}get(){return this._transitionable.serialize()}set(h,t){this._transitionable.setTransitionOrValue(h,t)}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}getExaggeration(h){return this._transitioning.possiblyEvaluate(new o.ac(h,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const h=this._transitionable._values.exaggeration;if(!h)return null;const t=h.value.expression;if(!t)return null;let a=-1,d=-1,g=1;for(const _ of t.zoomStops)g=t.evaluate(new o.ac(_,{worldview:this.worldview})),g>.01?(a=_,d=-1):d=_;return g<.01&&a>0&&d>a?[a,d]:null}isZoomDependent(){const h=this._transitionable._values.exaggeration;return h!=null&&h.value!=null&&h.value.expression!=null&&h.value.expression instanceof o.ad}};const yt=45,ot=65,Gt=.05;function tr(h,t,a,d){const g=o.ah(yt,ot,a),[_,b]=ar(h,d);let T=1-Math.min(1,Math.exp((t-_)/(b-_)*-6));return T*=T*T,T=Math.min(1,1.00747*T),T*g*h.alpha}function ar(h,t){const a=.5/Math.tan(.5*t);return[h.range[0]+a,h.range[1]+a]}function Rr(h,t,a,d,g){const _=o.af([],[t,a,d],g.mercatorFogMatrix);return tr(h,o.ag(_),g.pitch,g._fov)}function Mr(h,t,a,d,g,_,b){const T=[[a,d,0],[g,d,0],[g,_,0],[a,_,0]];let I=Number.MAX_VALUE,k=-Number.MAX_VALUE;for(const N of T){const j=o.af([],N,t),R=o.ag(j);I=Math.min(I,R),k=Math.max(k,R)}return[tr(h,I,b.pitch,b._fov),tr(h,k,b.pitch,b._fov)]}class zr extends o.E{constructor(t,a,d,g){super();const _=new o.a9({range:new o.aa(o.a6.fog.range),color:new o.aa(o.a6.fog.color),"color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new o.aa(o.a6.fog["high-color"]),"high-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new o.aa(o.a6.fog["space-color"]),"space-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new o.aa(o.a6.fog["horizon-blend"]),"star-intensity":new o.aa(o.a6.fog["star-intensity"]),"vertical-range":new o.aa(o.a6.fog["vertical-range"])});this._transitionable=new o.a8(_,d,new Map(g)),this.set(t,g),this._transitioning=this._transitionable.untransitioned(),this._transform=a,this.properties=new o.ai(_),this.scope=d}get state(){const t=this._transform,a=t.projection.name==="globe",d=o.aj(t.zoom),g=this.properties.get("range"),_=[.5,3];return{range:a?[o.ak(_[0],g[0],d),o.ak(_[1],g[1],d)]:g,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,a,d={}){if(this._validate(va,t,d))return;const g=Object.assign({},t);for(const _ of Object.keys(o.a6.fog))g[_]===void 0&&(g[_]=o.a6.fog[_].default);this._options=g,this._transitionable.setTransitionOrValue(this._options,a)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const a=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:o.ah(yt,ot,t))*a.a}getOpacityAtLatLng(t,a){return this._transform.projection.supportsFog?function(d,g,_){const b=o.ae.fromLngLat(g),T=_.elevation?_.elevation.getAtPointOrZero(b):0;return Rr(d,b.x,b.y,T,_)}(this.state,t,a):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const a=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Mr(this.state,a,0,0,o.al,o.al,this._transform)}getOpacityForBounds(t,a,d,g,_){return this._transform.projection.supportsFog?Mr(this.state,t,a,d,g,_,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?ar(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const a=[4,5,6,7];for(const d of a){const g=t.points[d];let _;if(g[2]>=0)_=g;else{const b=t.points[d-4];_=o.am(b,g,b[2]/(b[2]-g[2]))}if(Rr(this.state,_[0],_[1],0,this._transform)>=Gt)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,a,d){return(!d||d.validate!==!1)&&be(this,t.call(Po,Object.assign({value:a,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}let pi,Lr,Yi,dn,hn=class extends o.E{constructor(h,t,a,d){super();const g=pi||(pi=new o.a9({density:new o.aa(o.a6.snow.density),intensity:new o.aa(o.a6.snow.intensity),color:new o.aa(o.a6.snow.color),opacity:new o.aa(o.a6.snow.opacity),vignette:new o.aa(o.a6.snow.vignette),"vignette-color":new o.aa(o.a6.snow["vignette-color"]),"center-thinning":new o.aa(o.a6.snow["center-thinning"]),direction:new o.aa(o.a6.snow.direction),"flake-size":new o.aa(o.a6.snow["flake-size"])}));this._transitionable=new o.a8(g,a,new Map(d)),this.set(h,d),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(g),this.scope=a}get state(){const h=this.properties.get("opacity"),t=this.properties.get("color"),a=this.properties.get("direction"),d=o.an(a[0]),g=-Math.max(o.an(a[1]),.01),_=[Math.cos(d)*Math.cos(g),Math.sin(d)*Math.cos(g),Math.sin(g)],b=this.properties.get("vignette"),T=this.properties.get("vignette-color");return T.a=b,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(t.r,t.g,t.b,t.a*h),direction:_,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:T}}get(){return this._transitionable.serialize()}set(h,t,a={}){if(this._validate(Fp,h,a))return;const d=Object.assign({},h);for(const g of Object.keys(o.a6.snow))d[g]===void 0&&(d[g]=o.a6.snow[g].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(h){this._transitionable.setTransitionOrValue(this._options,new Map(h))}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}_validate(h,t,a){return(!a||a.validate!==!1)&&be(this,h.call(Po,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}},fi=class extends o.E{constructor(h,t,a,d){super();const g=Lr||(Lr=new o.a9({density:new o.aa(o.a6.rain.density),intensity:new o.aa(o.a6.rain.intensity),color:new o.aa(o.a6.rain.color),opacity:new o.aa(o.a6.rain.opacity),vignette:new o.aa(o.a6.rain.vignette),"vignette-color":new o.aa(o.a6.rain["vignette-color"]),"center-thinning":new o.aa(o.a6.rain["center-thinning"]),direction:new o.aa(o.a6.rain.direction),"droplet-size":new o.aa(o.a6.rain["droplet-size"]),"distortion-strength":new o.aa(o.a6.rain["distortion-strength"])}));this._transitionable=new o.a8(g,a,new Map(d)),this.set(h,d),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(g),this.scope=a}get state(){const h=this.properties.get("opacity"),t=this.properties.get("color"),a=this.properties.get("direction"),d=o.an(a[0]),g=-Math.max(o.an(a[1]),.01),_=[Math.cos(d)*Math.cos(g),Math.sin(d)*Math.cos(g),Math.sin(g)],b=this.properties.get("vignette-color");return b.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(t.r,t.g,t.b,t.a*h),direction:_,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(h,t,a={}){if(this._validate(Ec,h,a))return;const d=Object.assign({},h);for(const g of Object.keys(o.a6.rain))d[g]===void 0&&(d[g]=o.a6.rain[g].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(h){this._transitionable.setTransitionOrValue(this._options,new Map(h))}updateTransitions(h){this._transitioning=this._transitionable.transitioned(h,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(h){this.properties=this._transitioning.possiblyEvaluate(h)}_validate(h,t,a){return(!a||a.validate!==!1)&&be(this,h.call(Po,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}};class Qr extends o.E{constructor(t,a,d,g){super(),this.scope=d,this._options=t,this.properties=new o.ai(a),this._transitionable=new o.a8(a,d,new Map(g)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,a){this._options=t,this._transitionable.setTransitionOrValue(t.properties,a)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Wi{constructor(t,a,d){this.screenBounds=t,this.cameraPoint=d.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=a,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,d)}static createFromScreenPoints(t,a){let d,g;if(t instanceof o.P||typeof t[0]=="number"){const _=o.P.convert(t);d=[_],g=a.isPointAboveHorizon(_)}else{const _=o.P.convert(t[0]),b=o.P.convert(t[1]),T=_.add(b)._div(2);d=[_,b],g=o.aq(_,b).every(I=>a.isPointAboveHorizon(I))&&a.isPointAboveHorizon(T)}return new Wi(d,g,a)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return o.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const a=this.screenBounds[0],d=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],g=o.aq(a,d,0,!1);return this.cameraPoint.y>d.y&&(this.cameraPoint.x>a.x&&this.cameraPoint.x<d.x?g.splice(3,0,this.cameraPoint):this.cameraPoint.x>=d.x?g[2]=this.cameraPoint:this.cameraPoint.x<=a.x&&(g[3]=this.cameraPoint)),o.ar(g,t)}bufferedCameraGeometryGlobe(t){const a=this.screenBounds[0],d=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],g=o.aq(a,d,t),_=this.cameraPoint.clone();switch(3*((_.y>a.y)+(_.y>d.y))+((_.x>a.x)+(_.x>d.x))){case 0:g[0]=_,g[4]=_.clone();break;case 1:g.splice(1,0,_);break;case 2:g[1]=_;break;case 3:g.splice(4,0,_);break;case 5:g.splice(2,0,_);break;case 6:g[3]=_;break;case 7:g.splice(3,0,_);break;case 8:g[2]=_}return g}containsTile(t,a,d,g=0){const _=t.queryPadding/a._pixelsPerMercatorPixel+1,b=d?this._bufferedCameraMercator(_,a):this._bufferedScreenMercator(_,a);let T=t.tileID.wrap+(b.unwrapped?g:0);const I=b.polygon.map(Y=>o.as(t.tileTransform,Y,T));if(!o.at(I,0,0,o.al,o.al))return;T=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?g:0);const k=this.screenGeometryMercator.polygon.map(Y=>o.au(t.tileTransform,Y,T)),N=k.map(Y=>new o.P(Y[0],Y[1])),j=a.getFreeCameraOptions().position||new o.ae(0,0,0),R=o.au(t.tileTransform,j,T),z=k.map(Y=>{const H=o.av(Y,Y,R);return o.aw(H,H),new o.ax(R,H)}),B=o.ay(t,1,a.zoom)*a._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:N,tilespaceRays:z,bufferedTilespaceGeometry:I,bufferedTilespaceBounds:(U=o.az(I),U.min.x=o.aA(U.min.x,0,o.al),U.min.y=o.aA(U.min.y,0,o.al),U.max.x=o.aA(U.max.x,0,o.al),U.max.y=o.aA(U.max.y,0,o.al),U),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:B};var U}_bufferedScreenMercator(t,a){const d=Gn(t);if(this._screenRaycastCache[d])return this._screenRaycastCache[d];{let g;return g=a.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),a):{polygon:this.bufferedScreenGeometry(t).map(_=>a.pointCoordinate3D(_)),unwrapped:!0},this._screenRaycastCache[d]=g,g}}_bufferedCameraMercator(t,a){const d=Gn(t);if(this._cameraRaycastCache[d])return this._cameraRaycastCache[d];{let g;return g=a.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),a):{polygon:this.bufferedCameraGeometry(t).map(_=>a.pointCoordinate3D(_)),unwrapped:!0},this._cameraRaycastCache[d]=g,g}}_projectAndResample(t,a){const d=function(_,b){const T=o.aB([],b.pixelMatrix,b.globeMatrix),I=[0,-o.aD,0,1],k=[0,o.aD,0,1],N=[0,0,0,1];o.aC(I,I,T),o.aC(k,k,T),o.aC(N,N,T);const j=new o.P(I[0]/I[3],I[1]/I[3]),R=new o.P(k[0]/k[3],k[1]/k[3]),z=o.aE(_,j)&&I[3]<N[3],B=o.aE(_,R)&&k[3]<N[3];if(!z&&!B)return null;const U=function(_e,me,fe){for(let ye=1;ye<_e.length;ye++){const Fe=Ti(me.pointCoordinate3D(_e[ye-1]).x),Pe=Ti(me.pointCoordinate3D(_e[ye]).x);if(fe<0){if(Fe<Pe)return{idx:ye,t:-Fe/(Pe-1-Fe)}}else if(Pe<Fe)return{idx:ye,t:(1-Fe)/(Pe+1-Fe)}}return null}(_,b,z?-1:1);if(!U)return null;const{idx:Y,t:H}=U;let K=Y>1?Zi(_.slice(0,Y),b):[],ne=Y<_.length?Zi(_.slice(Y),b):[];K=K.map(_e=>new o.P(Ti(_e.x),_e.y)),ne=ne.map(_e=>new o.P(Ti(_e.x),_e.y));const ce=[...K];ce.length===0&&ce.push(ne[ne.length-1]);const ge=o.ak(ce[ce.length-1].y,(ne.length===0?K[0]:ne[0]).y,H);let pe;return pe=z?[new o.P(0,ge),new o.P(0,0),new o.P(1,0),new o.P(1,ge)]:[new o.P(1,ge),new o.P(1,1),new o.P(0,1),new o.P(0,ge)],ce.push(...pe),ne.length===0?ce.push(K[0]):ce.push(...ne),{polygon:ce.map(_e=>new o.ae(_e.x,_e.y)),unwrapped:!1}}(t,a);if(d)return d;const g=function(_,b){let T=!1,I=-1/0,k=0;for(let j=0;j<_.length-1;j++)_[j].x>I&&(I=_[j].x,k=j);for(let j=0;j<_.length-1;j++){const R=(k+j)%(_.length-1),z=_[R],B=_[R+1];Math.abs(z.x-B.x)>.5&&(z.x<B.x?(z.x+=1,R===0&&(_[_.length-1].x+=1)):(B.x+=1,R+1===_.length-1&&(_[0].x+=1)),T=!0)}const N=o.aF(b.center.lng);return T&&N<Math.abs(N-1)&&_.forEach(j=>{j.x-=1}),{polygon:_,unwrapped:T}}(Zi(t,a).map(_=>new o.P(Ti(_.x),_.y)),a);return{polygon:g.polygon.map(_=>new o.ae(_.x,_.y)),unwrapped:g.unwrapped}}}function Zi(h,t){return o.aG(h,a=>{const d=t.pointCoordinate3D(a);a.x=d.x,a.y=d.y},1/256)}function Ti(h){return h<0?1+h%1:h%1}function Gn(h){return 100*h|0}function ds(h,t,a,d,g){const _=function(T,I){if(T)return g(T);if(I){if(h.url&&I.tiles&&h.tiles&&delete h.tiles,I.variants){if(!Array.isArray(I.variants))return g(new Error("variants must be an array"));for(const N of I.variants){if(N==null||typeof N!="object"||N.constructor!==Object)return g(new Error("variant must be an object"));if(!Array.isArray(N.capabilities))return g(new Error("capabilities must be an array"));if(N.capabilities.length===1&&N.capabilities[0]==="meshopt"){I=Object.assign(I,N);break}}}const k=o.aH(Object.assign({},I,h),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);k.tiles=t.canonicalizeTileset(k,h.url),g(null,k)}},b=function(T,I,k){if(!T)return null;if(!I&&!k)return T;k=k||T.worldview_default;const N=Object.values(T.language||{});if(N.length===0)return null;const j=Object.values(T.worldview||{});if(j.length===0)return null;const R=N.every(B=>B===I),z=j.every(B=>B===k);return R&&z?T:I in(T.language_options||{})||k in(T.worldview_options||{})?null:T.language_options&&T.worldview_options?T:null}(h.data,a,d);return b?o.o.frame(()=>_(null,b)):h.url?o.m(t.transformRequest(t.normalizeSourceURL(h.url,null,a,d),o.R.Source),_):o.o.frame(()=>{const{data:T,...I}=h;_(null,I)})}function qs(h,t){const a=Math.pow(2,t.z),d=Math.floor(o.aF(h.getWest())*a),g=Math.floor(o.aJ(h.getNorth())*a),_=Math.ceil(o.aF(h.getEast())*a),b=Math.ceil(o.aJ(h.getSouth())*a);return t.x>=d&&t.x<_&&t.y>=g&&t.y<b}class ba{constructor(t,a,d){this.bounds=t?o.aI.convert(this.validateBounds(t)):null,this.minzoom=a||0,this.maxzoom=d||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const a of t)this.extraBounds.push(o.aI.convert(this.validateBounds(a)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!qs(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const a of this.extraBounds)if(qs(a,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const a=new ba(t.bounds,t.minzoom,t.maxzoom);return a.addExtraBounds(t.extra_bounds),a}}class is extends o.E{constructor(t,a,d,g){if(super(),this.id=t,this.dispatcher=d,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,o.aH(a,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},a),this._collectResourceTiming=!!a.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g),this._tileWorkers={},this._deduped=new o.aK}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,d=this.map.getWorldview();this._tileJSONRequest=ds(this._options,this.map._requestManager,a,d,(g,_)=>{if(this._tileJSONRequest=null,this._loaded=!0,g)a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),d&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${d}`),this.fire(new o.y(g));else if(_){if(Object.assign(this,_),this.hasWorldviews=!!_.worldview_options,_.worldview_default&&(this.worldviewDefault=_.worldview_default),_.vector_layers){this.vectorLayers=_.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const b of _.vector_layers)this.vectorLayerIds.push(b.id),_.worldview&&_.worldview[b.source]&&this.localizableLayerIds.add(b.id)}this.tileBounds=ba.fromTileJSON(_),Nr(_.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(g)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,a){const d=t.tileID.canonical.url(this.tiles,this.scheme),g=this.map._requestManager.normalizeTileURL(d),_=this.map._requestManager.transformRequest(g,o.R.Tile),b=this.map.style?this.map.style.getLut(this.scope):null,T=b?{image:b.image.clone()}:null,I={request:_,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:T,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&o.h(d)&&(I.localizableLayerIds=this.localizableLayerIds),I.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=a:t.request=t.actor.send("reloadTile",I,k.bind(this));else if(t.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",I,k.bind(this),void 0,!0);else{const N=o.aL.call({deduped:this._deduped},I,(j,R)=>{j||!R?k.call(this,j):(I.data={cacheControl:R.cacheControl,expires:R.expires,rawData:R.rawData.slice(0)},t.actor&&t.actor.send("loadTile",I,k.bind(this),void 0,!0))},!0);t.request={cancel:N}}function k(N,j){return delete t.request,t.aborted?a(null):N&&N.status!==404?a(N):(j&&j.resourceTiming&&(t.resourceTiming=j.resourceTiming),this.map._refreshExpiredTiles&&j&&t.setExpiryData(j),t.loadVectorData(j,this.map.painter),o.aM(this.dispatcher),a(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,a){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Ic extends o.E{constructor(t,a,d,g){super(),this.id=t,this.dispatcher=d,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},a),Object.assign(this,o.aH(a,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const a=this.map.getWorldview();this._tileJSONRequest=ds(this._options,this.map._requestManager,null,a,(d,g)=>{this._tileJSONRequest=null,this._loaded=!0,d?this.fire(new o.y(d)):g&&(Object.assign(this,g),g.raster_layers&&(this.rasterLayers=g.raster_layers,this.rasterLayerIds=this.rasterLayers.map(_=>_.id)),this.tileBounds=ba.fromTileJSON(g),Nr(g.tiles),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(d)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,a){const d=o.o.devicePixelRatio>=2,g=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),d,this.tileSize);t.request=o.n(this.map._requestManager.transformRequest(g,o.R.Tile),(_,b,T,I)=>(delete t.request,t.aborted?(t.state="unloaded",a(null)):_?(t.state="errored",a(_)):b?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:T,expires:I}),t.setTexture(b,this.map.painter),t.state="loaded",o.aM(this.dispatcher),void a(null)):a(null)))}abortTile(t,a){t.request&&(t.request.cancel(),delete t.request),a&&a()}unloadTile(t,a){t.texture&&t.texture instanceof o.T?(t.destroy(!0),t.texture&&t.texture instanceof o.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),a&&a()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Z_([h,t],a,d,{scaled:g=!0}={}){const{tileSize:_,buffer:b}=d,{x:T,y:I,z:k}=a;if(!isFinite(T)||!isFinite(I)||!isFinite(k))throw new Error("Invalid MRT header");const N=2**k,j=N*o.aF(h),R=N*o.aJ(t);return function([z,B],U,{scaled:Y=!0}={}){if(!U)throw new Error("bandView is undefined");const{data:H,tileSize:K,buffer:ne,offset:ce,scale:ge,dimension:pe}=U;if(z<-ne||z>K+ne||B<-ne||B>K+ne)throw new Error(`Point (${z}, ${B}) out of bounds for tileSize=${K}, buffer=${ne}`);const _e=(B+ne)*(K+2*ne)+(z+ne);if(new Uint32Array(H.buffer)[_e]===4294967295)return null;let me=[];me=Y?[]:new U.data.constructor(pe);for(let fe=0;fe<pe;fe++)me[fe]=Math.round(1e12*(H[pe*_e+fe]*ge+ce))/1e12;return me}([Math.min(Math.max(-b,Math.floor((j-T)*_)),_-1+b),Math.min(Math.max(-b,Math.floor((R-I)*_)),_-1+b)],d,{scaled:g})}class Xa extends Ic{constructor(t,a,d,g){super(t,a,d,g),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},a)}triggerRepaint(t){const a=this.map.painter._terrain,d=this.map.style.getSourceCache(this.id);a&&a.enabled&&d&&a._clearRenderCacheForTile(d.id,t.tileID),this.map.triggerRepaint()}loadTile(t,a){const d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(d,o.R.Tile),_={request:g,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=g,t.actor||(t.actor=this.dispatcher.getActor());const b=(T,I,k,N)=>{if(delete t.request,t.aborted)return t.state="unloaded",a(null);if(T)return T.name==="AbortError"?void 0:(t.state="errored",a(T));if(this.map._refreshExpiredTiles&&I&&t.setExpiryData({cacheControl:k,expires:N}),this.partial&&t.state!=="expired")t.state="empty";else if(!this.partial){if(!I)return a(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=I}a(null)};t.request=this.partial?t.fetchHeader(void 0,b.bind(this)):t.actor.send("loadTile",_,b.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,a){const d=t.texturePerLayer;if(t.flushAllQueues(),d.size){t.destroy(!0);for(const g of d.values())this.map.painter.saveTileTexture(g)}else t.destroy()}prepareTile(t,a,d,g){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBandForRender(a,d,g,(_,b)=>{if(_)return t.state="errored",this.fire(new o.y(_)),void this.triggerRepaint(t);b&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(d,b,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const a=this.rasterLayers.find(({id:_})=>_===t),d=a&&a.fields,g=d&&d.bands&&d.bands;return g?g[0]:0}getTextureDescriptor(t,a,d){if(!t)return;const g=a.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!g)return;let _=null;a instanceof o.aP?_=a.paint.get("raster-array-band"):a instanceof o.aQ&&(_=a.paint.get("raster-particle-array-band"));const b=_||this.getInitialBand(g);if(b==null)return;if(!t.textureDescriptorPerLayer.get(a.id))return void this.prepareTile(t,g,a.id,b);if(t.updateNeeded(a.id,b)&&!d)return;const T=t.textureDescriptorPerLayer.get(a.id);return Object.assign({},T,{texture:t.texturePerLayer.get(a.id)})}getImages(t,a){const d=new Map;for(const g of t)for(const _ of a){const[b,T]=_.split("/"),I=g.getLayer(b);if(!I||!I.hasBand(T)||!I.hasDataForBand(T))continue;const{bytes:k,tileSize:N,buffer:j}=I.getBandView(T),R=N+2*j,z={data:new o.q({width:R,height:R},k),pixelRatio:2,sdf:!1,usvg:!1,version:0};d.set(_,z)}return d}queryRasterArrayValueByBandId(t,a,d){const g=a._mrt;return new Promise(_=>{const b={},T=new Set;for(const[I,k]of Object.entries(g.layers)){if(d.layerName&&I!==d.layerName)continue;const N={};b[I]=N;for(const{bands:j}of k.dataIndex)for(const R of j)d.bands&&!d.bands.includes(R)||(T.add(o.B(I,R)),a.fetchBand(I,null,R,z=>{o.o.frame(()=>{N[R]=z?null:Z_([t.lng,t.lat],g,k.getBandView(R)),T.delete(o.B(I,R)),T.size===0&&_(b)})},!1))}T.size===0&&_(b)})}_loadTileForQuery(t,a){if(this._loadTileLoaded[t.uid])return void a(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(a);this._loadTilePending[t.uid]=[a];const d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(d,o.R.Tile);t.actor.send("loadTile",{request:g,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},(_,b,T,I)=>_?(this._loadTilePending[t.uid].forEach(k=>k(_,null)),void delete this._loadTilePending[t.uid]):b?(this.map._refreshExpiredTiles&&b&&t.setExpiryData({cacheControl:T,expires:I}),t._mrt=b,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach(k=>k(null,b)),this._loadTileLoaded[t.uid]=!0,void delete this._loadTilePending[t.uid]):(this._loadTilePending[t.uid].forEach(k=>k(null,null)),void delete this._loadTilePending[t.uid]),void 0,!0)}queryRasterArrayValueByAllBands(t,a,d){return new Promise((g,_)=>{this._loadTileForQuery(a,(b,T)=>{b?_(b):g(T?this.queryRasterArrayValueByBandId(t,a,d):null)})})}queryRasterArrayValue(t,a){const d=o.aR.convert(t),g=this.findLoadedParent(d);return g&&g._mrt?a.bands||!this.partial?this.queryRasterArrayValueByBandId(d,g,a):this.queryRasterArrayValueByAllBands(d,g,a):Promise.resolve(null)}findLoadedParent(t){const a=o.ae.fromLngLat(t,this.map.transform.tileSize),d=this.maxzoom+1,g=1<<d,_=Math.floor(a.x),b=Math.floor((a.x-_)*g),T=Math.floor(a.y*g),I=this.map.style.getSourceCache(this.id),k=new o.aO(d,_,d,b,T);return I.findLoadedParent(k,this.minzoom)}}const Cc={vector:is,raster:Ic,"raster-dem":class extends Ic{constructor(h,t,a,d){super(h,t,a,d),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(h,t){const a=this.map._requestManager.normalizeTileURL(h.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function d(g,_){g&&(h.state="errored",t(g)),_&&(h.dem=_,h.dem.onDeserialize(),h.needsHillshadePrepare=!0,h.needsDEMTextureUpload=!0,h.state="loaded",t(null))}h.request=o.n(this.map._requestManager.transformRequest(a,o.R.Tile),(function(g,_,b,T){if(delete h.request,h.aborted)h.state="unloaded",t(null);else if(g)h.state="errored",t(g);else if(_){this.map._refreshExpiredTiles&&h.setExpiryData({cacheControl:b,expires:T});const I=ImageBitmap&&_ instanceof ImageBitmap&&o.r(),k=1-(_.width-o.aN(_.width))/2;k<1||h.neighboringTiles||(h.neighboringTiles=this._getNeighboringTiles(h.tileID));const N=I?_:o.o.getImageData(_,k),j={uid:h.uid,tileID:h.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:N,encoding:this.encoding,padding:k};h.actor&&h.state!=="expired"||(h.actor=this.dispatcher.getActor(),h.actor.send("loadTile",j,d.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(h){const t=h.canonical,a=Math.pow(2,t.z),d=(t.x-1+a)%a,g=t.x===0?h.wrap-1:h.wrap,_=(t.x+1+a)%a,b=t.x+1===a?h.wrap+1:h.wrap,T={};return T[new o.aO(h.overscaledZ,g,t.z,d,t.y).key]={backfilled:!1},T[new o.aO(h.overscaledZ,b,t.z,_,t.y).key]={backfilled:!1},t.y>0&&(T[new o.aO(h.overscaledZ,g,t.z,d,t.y-1).key]={backfilled:!1},T[new o.aO(h.overscaledZ,h.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},T[new o.aO(h.overscaledZ,b,t.z,_,t.y-1).key]={backfilled:!1}),t.y+1<a&&(T[new o.aO(h.overscaledZ,g,t.z,d,t.y+1).key]={backfilled:!1},T[new o.aO(h.overscaledZ,h.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},T[new o.aO(h.overscaledZ,b,t.z,_,t.y+1).key]={backfilled:!1}),T}},"raster-array":Xa,geojson:class extends o.E{constructor(h,t,a,d){super(),this.id=h,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=a.getActor(),this.setEventedParent(d),this._data=t.data,this._options=Object.assign({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const g=o.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*g,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*g,extent:o.al,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:o.al,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*g,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(h){this.map=h,this.setData(this._data)}setData(h){return this._data=h,this._updateWorkerData(),this}updateData(h){if(!this._options.dynamic)return this.fire(new o.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof h!="string"&&(h.type==="Feature"&&(h={type:"FeatureCollection",features:[h]}),h.type!=="FeatureCollection"))return this.fire(new o.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof h!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const a of this._data.features)t.set(a.id,a);for(const a of h.features)t.set(a.id,a);this._data.features=[...t.values()]}else this._data=h;return this._updateWorkerData(!0),this}getClusterExpansionZoom(h,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:h,source:this.id,scope:this.scope},t),this}getClusterChildren(h,t){return this.actor.send("geojson.getClusterChildren",{clusterId:h,source:this.id,scope:this.scope},t),this}getClusterLeaves(h,t,a,d){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:h,limit:t,offset:a},d),this}_updateWorkerData(h=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=Object.assign({append:h},this.workerOptions);t.scope=this.scope;const a=this._data;typeof a=="string"?(t.request=this.map._requestManager.transformRequest(o.o.resolveURL(a),o.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(d,g)=>{if(this._loaded=!0,this._pendingLoad=null,d)this.fire(new o.y(d));else{const _={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(_.resourceTiming=g.resourceTiming[this.id]),h&&(this._partialReload=!0),this.fire(new o.z("data",_)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(h),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const h=o.B(this.id,this.scope);this.map.style.clearSource(h),this._updateWorkerData()}loadTile(h,t){const a=h.actor?"reloadTile":"loadTile";h.actor=this.actor;const d=this.map.style?this.map.style.getLut(this.scope):null,g=d?{image:d.image.clone()}:null,_=this._partialReload,b={type:this.type,uid:h.uid,tileID:h.tileID,tileZoom:h.tileZoom,zoom:h.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:g,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:h.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:_,worldview:this.map.getWorldview()};h.request=this.actor.send(a,b,(T,I)=>_&&!I?(h.state="loaded",t(null)):(delete h.request,h.destroy(),h.aborted?t(null):T?t(T):(h.loadVectorData(I,this.map.painter,a==="reloadTile"),t(null))),void 0,a==="loadTile")}abortTile(h){h.request&&(h.request.cancel(),delete h.request),h.aborted=!0}unloadTile(h,t){this.actor.send("removeTile",{uid:h.uid,type:this.type,source:this.id,scope:this.scope}),h.destroy()}onRemove(h){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends o.aS{constructor(h,t,a,d){super(h,t,a,d),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const h=this.options;this.urls=[];for(const t of h.urls)this.urls.push(this.map._requestManager.transformRequest(t,o.R.Source).url);o.aT(this.urls,(t,a)=>{this._loaded=!0,t?this.fire(new o.y(t)):a&&(this.video=a,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(h){if(this.video){const t=this.video.seekable;h<t.start(0)||h>t.end(0)?this.fire(new o.y(new o.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=h}}getVideo(){return this.video}onAdd(h){this.map||(this.map=h,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const h=this.map.painter.context,t=h.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(h,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(h)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:o.aS,model:class extends o.E{constructor(h,t,a,d){super(),this.id=h,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const h=[];for(const t in this._options.models){const a=this._options.models[t],d=o.aV(this.map._requestManager.transformRequest(a.uri,o.R.Model).url).then(g=>{if(!g)return;const _=o.aW(g),b=new o.aX(t,a.position,a.orientation,_);b.computeBoundsAndApplyParent(),this.models.push(b)}).catch(g=>{this.fire(new o.y(new Error(`Could not load model ${t} from ${a.uri}: ${g.message}`)))});h.push(d)}Promise.allSettled(h).then(()=>{this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new o.y(new Error(`Could not load models: ${t.message}`)))})}onAdd(h){this.map=h,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(h,t){}serialize(){return this._options}},"batched-model":class extends o.E{constructor(h,t,a,d){super(),this.type="batched-model",this.id=h,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=a,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(d)}onAdd(h){this.map=h,this.load()}reload(){this.cancelTileJSONRequest();const h=o.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(h))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(h){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,a=this.map.getWorldview();this._tileJSONRequest=ds(this._options,this.map._requestManager,t,a,(d,g)=>{this._tileJSONRequest=null,this._loaded=!0,d?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),a&&a.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${a}`),this.fire(new o.y(d))):g&&(Object.assign(this,g),g.bounds&&(this.tileBounds=new ba(g.bounds,this.minzoom,this.maxzoom)),Nr(g.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),h&&h(d)})}hasTransition(){return!1}hasTile(h){return!this.tileBounds||this.tileBounds.contains(h.canonical)}loaded(){return this._loaded}loadTile(h,t){const a=this.map._requestManager.normalizeTileURL(h.tileID.canonical.url(this.tiles,this.scheme)),d={request:this.map._requestManager.transformRequest(a,o.R.Tile),data:void 0,uid:h.uid,tileID:h.tileID,tileZoom:h.tileZoom,zoom:h.tileID.overscaledZ,tileSize:this.tileSize*h.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:h.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:o.o.devicePixelRatio,promoteId:this.promoteId};if(h.actor&&h.state!=="expired")if(h.state==="loading")h.reloadCallback=t;else{if(h.buckets){const _=Object.values(h.buckets);for(const b of _)b.dirty=!0;return void(h.state="loaded")}h.request=h.actor.send("reloadTile",d,g.bind(this))}else h.actor=this.dispatcher.getActor(),h.request=h.actor.send("loadTile",d,g.bind(this),void 0,!0);function g(_,b){return h.aborted?t(null):_&&_.status!==404?t(_):(this.map._refreshExpiredTiles&&b&&h.setExpiryData(b),h.loadModelData(b,this.map.painter),h.state="loaded",void t(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends o.aS{constructor(h,t,a,d){super(h,t,a,d),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(g=>!Array.isArray(g)||g.length!==2||g.some(_=>typeof _!="number"))||this.fire(new o.y(new o.V(`sources.${h}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.y(new o.V(`sources.${h}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new o.y(new o.V(`sources.${h}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new o.y(new o.V(`sources.${h}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.y(new o.V(`sources.${h}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(h){this.map=h,this.load(),this.canvas&&this.animate&&this.play()}onRemove(h){this.pause()}prepare(){let h=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,h=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,h=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!h&&!this._playing||this.texture instanceof o.aU||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const h of[this.canvas.width,this.canvas.height])if(isNaN(h)||h<=0)return!0;return!1}},custom:class extends o.E{constructor(h,t,a,d){super(),this.id=h,this.type="custom",this._dataType="raster",this._dispatcher=a,this._implementation=t,this.setEventedParent(d),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new o.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new ba(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,o.aH(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(h){this.map=h,this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(h),this.load()}onRemove(h){this._implementation.onRemove&&this._implementation.onRemove(h)}hasTile(h){if(this._implementation.hasTile){const{x:t,y:a,z:d}=h.canonical;return this._implementation.hasTile({x:t,y:a,z:d})}return!this.tileBounds||this.tileBounds.contains(h.canonical)}loadTile(h,t){const{x:a,y:d,z:g}=h.tileID.canonical,_=new AbortController;h.request=Promise.resolve(this._implementation.loadTile({x:a,y:d,z:g},{signal:_.signal})).then((function(b){return delete h.request,h.aborted?(h.state="unloaded",t(null)):b===void 0?(h.state="errored",t(null)):b===null?(this.loadTileData(h,{width:this.tileSize,height:this.tileSize,data:null}),h.state="loaded",t(null)):function(T){return T instanceof ImageData||T instanceof HTMLCanvasElement||T instanceof ImageBitmap||T instanceof HTMLImageElement}(b)?(this.loadTileData(h,b),h.state="loaded",void t(null)):(h.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(b=>{b.name!=="AbortError"&&(h.state="errored",t(b))}),h.request.cancel=()=>_.abort()}loadTileData(h,t){h.setTexture(t,this.map.painter)}unloadTile(h,t){if(h.texture&&h.texture instanceof o.T?(h.destroy(!0),h.texture&&h.texture instanceof o.T&&this.map.painter.saveTileTexture(h.texture)):h.destroy(),this._implementation.unloadTile){const{x:a,y:d,z:g}=h.tileID.canonical;this._implementation.unloadTile({x:a,y:d,z:g})}t&&t()}abortTile(h,t){h.request&&h.request.cancel&&(h.request.cancel(),delete h.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(h=>({x:h.canonical.x,y:h.canonical.y,z:h.canonical.z}))}_clearTiles(){const h=o.B(this.id,this.scope);this.map.style.clearSource(h)}_update(){this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}}},Zu=function(h,t,a,d){const g=new Cc[t.type](h,t,a,d);if(g.id!==h)throw new Error(`Expected Source id to be ${h} instead of ${g.id}`);return o.aY(["load","abort","unload","serialize","prepare"],g),g};function Xu(h,t,a=""){return`${a}:${t.id||""}:${t.layer.id}:${function(d){if("layerId"in d)return`layer:${d.layerId}`;{const{featuresetId:g,importId:_}=d;return`featureset:${g}${_?`:import:${_}`:""}`}}(h.target)}`}function Ya(h,t,a,d=""){if(h.uniqueFeatureID){const g=Xu(h,t,d);if(a.has(g))return!0;a.add(g)}return!1}function Yu(h,t,a,d,g=!1){const _=t.sourceCache.transform,b=t.sourceCache.tilesIn(h,t.has3DLayers,g);b.sort(Up);const T=[];for(const I of b){const k=I.tile.queryRenderedFeatures(t,I,a,d,_,g);Object.keys(k).length&&T.push({wrappedTileID:I.tile.tileID.wrapped().key,queryResults:k})}return T.length===0?{}:function(I){const k={},N={};for(const j of I){const R=j.queryResults,z=j.wrappedTileID,B=N[z]=N[z]||{};for(const U in R){const Y=R[U],H=B[U]=B[U]||{},K=k[U]=k[U]||[];for(const ne of Y)H[ne.featureIndex]||(H[ne.featureIndex]=!0,K.push(ne))}}return k}(T)}function Bp(h,t,a,d,g,_){const b={},T=d.queryRenderedSymbols(h),I=[];for(const k of Object.keys(T).map(Number))I.push(g[k]);I.sort(Up);for(const k of I){const N=k.featureIndex.lookupSymbolFeatures(T[k.bucketInstanceId],k.bucketIndex,k.sourceLayerIndex,t,a,_);for(const j in N){const R=b[j]=b[j]||[],z=N[j];z.sort((B,U)=>{const Y=k.featureSortOrder;if(Y){const H=Y.indexOf(B.featureIndex);return Y.indexOf(U.featureIndex)-H}return U.featureIndex-B.featureIndex});for(const B of z)R.push(B)}}return b}function Qo(h,t){const a=h.getRenderableIds().map(_=>h.getTileByID(_)),d=[],g={};for(let _=0;_<a.length;_++){const b=a[_],T=b.tileID.canonical.key;g[T]||(g[T]=!0,b.querySourceFeatures(d,t))}return d}function Up(h,t){const a=h.tileID,d=t.tileID;return a.overscaledZ-d.overscaledZ||a.canonical.y-d.canonical.y||a.wrap-d.wrap||a.canonical.x-d.canonical.x}function ph(h,t){const a={};if(!t)return a;for(const d of h){const g=d.layerIds.map(_=>t.getLayer(_)).filter(Boolean);if(g.length!==0){d.layers=g,d.stateDependentLayerIds&&(d.stateDependentLayers=d.stateDependentLayerIds.map(_=>g.filter(b=>b.id===_)[0]));for(const _ of g)a[_.fqid]=d}}return a}const Hs=32,ko=33,wa=new Uint16Array(8184);for(let h=0;h<2046;h++){let t=h+2,a=0,d=0,g=0,_=0,b=0,T=0;for(1&t?g=_=b=Hs:a=d=T=Hs;(t>>=1)>1;){const k=a+g>>1,N=d+_>>1;1&t?(g=a,_=d,a=b,d=T):(a=g,d=_,g=b,_=T),b=k,T=N}const I=4*h;wa[I+0]=a,wa[I+1]=d,wa[I+2]=g,wa[I+3]=_}const Mo=new Uint16Array(2178),hs=new Uint8Array(1089),Dl=new Uint16Array(1089);function Vp(h){return h===0?-.03125:h===32?.03125:0}const Ku={type:2,extent:o.al,loadGeometry:()=>[[new o.P(0,0),new o.P(o.al+1,0),new o.P(o.al+1,o.al+1),new o.P(0,o.al+1),new o.P(0,0)]]};class Ka{constructor(t,a,d,g,_,b){this.tileID=t,this.uid=o.b2(),this.uses=0,this.tileSize=a,this.tileZoom=d,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=_,g&&g.style&&(this._lastUpdatedBrightness=g.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",g&&g.transform&&(this.projection=g.transform.projection),this.worldview=b}registerFadeDuration(t){const a=t+this.timeAdded;a<o.o.now()||this.fadeEndTime&&a<this.fadeEndTime||(this.fadeEndTime=a)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=o.aZ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,a,d){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=ph(t.buckets,a.style),this.hasSymbolBuckets=!1;for(const g in this.buckets){const _=this.buckets[g];if(_ instanceof o.b4){if(this.hasSymbolBuckets=!0,!d)break;_.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const g in this.buckets){const _=this.buckets[g];if(_ instanceof o.b4&&_.hasRTLText){this.hasRTLText=!0,o.b5();break}}this.queryPadding=0;for(const g in this.buckets){const _=this.buckets[g],b=a.style.getOwnLayer(g);if(!b)continue;const T=b.queryRadius(_);this.queryPadding=Math.max(this.queryPadding,T)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new o.b3}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,a,d){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,ph(t.buckets,a.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const g in this.buckets){const _=this.buckets[g];_.uploadPending()&&_.upload(t)}const a=t.gl,d=this.imageAtlas;d&&!d.uploaded&&(this.imageAtlasTexture=new o.T(t,d.image,a.RGBA8,{useMipmap:!!d.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(t,this.glyphAtlasImage,a.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new o.T(t,this.lineAtlas.image,a.R8),this.lineAtlas.uploaded=!0)}prepare(t,a,d){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,d),!a||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const g=a.style.getBrightness();(this._lastUpdatedBrightness||g)&&(this._lastUpdatedBrightness&&g&&Math.abs(this._lastUpdatedBrightness-g)<.001||(this.updateBuckets(a,this._lastUpdatedBrightness!==g),this._lastUpdatedBrightness=g))}queryRenderedFeatures(t,a,d,g,_,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const T=function(I,k){const N=o.bq([],[.5*I.width,.5*-I.height,1]);return o.br(N,N,[1,-1,0]),o.aB(N,N,I.calculateProjMatrix(k.toUnwrapped())),Float32Array.from(N)}(_,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:a,pixelPosMatrix:T,transform:g,availableImages:d,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,a){const d=this.latestFeatureIndex;if(!d||!d.rawTileData)return;const g=d.loadVTLayers(),_=a?a.sourceLayer:"",b=g._geojsonTileLayer||g[_];if(!b)return;const T=o.b6(a&&a.filter),{z:I,x:k,y:N}=this.tileID.canonical,j={z:I,x:k,y:N};for(let R=0;R<b.length;R++){const z=b.feature(R);if(T.needGeometry){const Y=o.b7(z,!0);if(!T.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),Y,this.tileID.canonical))continue}else if(!T.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),z))continue;const B=d.getId(z,_),U=new o.b8(z,I,k,N,B);U.tile=j,t.push(U)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const a=this.expirationTime;if(t.cacheControl){const d=o.b9(t.cacheControl);d["max-age"]&&(this.expirationTime=Date.now()+1e3*d["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const d=Date.now();let g=!1;if(this.expirationTime>d)g=!1;else if(a)if(this.expirationTime<a)g=!0;else{const _=this.expirationTime-a;_?this.expirationTime=d+Math.max(_,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,a){if(!this.latestFeatureIndex||!t.style)return;const d=this.latestFeatureIndex.loadVTLayers(),g=t.style.listImages(),_=t.style.getBrightness();for(const b in this.buckets){if(!t.style.hasLayer(b))continue;const T=this.buckets[b],I=T.layers[0],k=I.sourceLayer||"_geojsonTileLayer",N=d[k],j=t.style.getLayerSourceCache(I);let R={};j&&(R=j._state.getState(k,void 0));const z=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},B=Object.keys(R).length>0&&!a;(B&&T.stateDependentLayers.length!==0||a)&&T.update(R,N,g,z,B?T.stateDependentLayers:T.layers,a,_),(T instanceof o.ba||T instanceof o.bb)&&t._terrain&&t._terrain.enabled&&j&&T.uploadPending()&&t._terrain._clearRenderCacheForTile(j.id,this.tileID);const U=t&&t.style&&t.style.getOwnLayer(b);U&&(this.queryPadding=Math.max(this.queryPadding,U.queryRadius(T)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=o.o.now()+t}setTexture(t,a){const d=a.context,g=d.gl;this.texture=this.texture||a.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t):(this.texture=new o.T(d,t,g.RGBA8,{useMipmap:!0}),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE))}setDependencies(t,a){const d={};for(const g of a)d[g]=!0;this.dependencies[t]=d}hasDependency(t,a){for(const d of t){const g=this.dependencies[d];if(g){for(const _ of a)if(g[_])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,a){if(!a||a.name==="mercator"||this._tileDebugBuffer)return;const d=o.bc(Ku,this.tileID.canonical,this.tileTransform)[0],g=new o.bd,_=new o.be;for(let b=0;b<d.length;b++){const{x:T,y:I}=d[b];g.emplaceBack(T,I),_.emplaceBack(b)}_.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(_),this._tileDebugBuffer=t.createVertexBuffer(g,o.bf.members),this._tileDebugSegments=o.bg.simpleSegment(0,0,g.length,_.length)}_makeTileBoundsBuffers(t,a){if(this._tileBoundsBuffer||!a||a.name==="mercator")return;const d=o.bc(Ku,this.tileID.canonical,this.tileTransform)[0];let g,_;if(this.isRaster){const b=function(T,I){const k=o.aZ(T,I),N=Math.pow(2,T.z);for(let Y=0;Y<ko;Y++)for(let H=0;H<ko;H++){const K=o.a_((T.x+(H+Vp(H))/Hs)/N),ne=o.a$((T.y+(Y+Vp(Y))/Hs)/N),ce=I.project(K,ne),ge=Y*ko+H;Mo[2*ge+0]=Math.round((ce.x*k.scale-k.x)*o.al),Mo[2*ge+1]=Math.round((ce.y*k.scale-k.y)*o.al)}hs.fill(0),Dl.fill(0);for(let Y=2045;Y>=0;Y--){const H=4*Y,K=wa[H+0],ne=wa[H+1],ce=wa[H+2],ge=wa[H+3],pe=K+ce>>1,_e=ne+ge>>1,me=pe+_e-ne,fe=_e+K-pe,ye=ne*ko+K,Fe=ge*ko+ce,Pe=_e*ko+pe,Ze=Math.hypot((Mo[2*ye+0]+Mo[2*Fe+0])/2-Mo[2*Pe+0],(Mo[2*ye+1]+Mo[2*Fe+1])/2-Mo[2*Pe+1])>=16;hs[Pe]=hs[Pe]||(Ze?1:0),Y<1022&&(hs[Pe]=hs[Pe]||hs[(ne+fe>>1)*ko+(K+me>>1)]||hs[(ge+fe>>1)*ko+(ce+me>>1)])}const j=new o.b0,R=new o.b1;let z=0;function B(Y,H){const K=H*ko+Y;return Dl[K]===0&&(j.emplaceBack(Mo[2*K+0],Mo[2*K+1],Y*o.al/Hs,H*o.al/Hs),Dl[K]=++z),Dl[K]-1}function U(Y,H,K,ne,ce,ge){const pe=Y+K>>1,_e=H+ne>>1;if(Math.abs(Y-ce)+Math.abs(H-ge)>1&&hs[_e*ko+pe])U(ce,ge,Y,H,pe,_e),U(K,ne,ce,ge,pe,_e);else{const me=B(Y,H),fe=B(K,ne),ye=B(ce,ge);R.emplaceBack(me,fe,ye)}}return U(0,0,Hs,Hs,Hs,0),U(Hs,Hs,0,0,0,Hs),{vertices:j,indices:R}}(this.tileID.canonical,a);g=b.vertices,_=b.indices}else{g=new o.b0,_=new o.b1;for(const{x:T,y:I}of d)g.emplaceBack(T,I,0,0);const b=o.bh(g.int16.subarray(0,4*g.length),void 0,4);for(let T=0;T<b.length;T+=3)_.emplaceBack(b[T],b[T+1],b[T+2])}this._tileBoundsBuffer=t.createVertexBuffer(g,o.bi.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(_),this._tileBoundsSegments=o.bg.simpleSegment(0,0,g.length,_.length)}_makeGlobeTileDebugBuffers(t,a){const d=a.projection;if(!d||d.name!=="globe"||a.freezeTileCoverage)return;const g=this.tileID.canonical,_=o.bj(g,a),b=o.bk(_),T=o.aj(a.zoom);let I;T>0&&(I=o.bl(new Float64Array(16),a.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,g,a,b,I,T),this._makeGlobeTileDebugTextBuffer(t,g,a,b,I,T)}_globePoint(t,a,d,g,_,b,T){let I=o.bm(t,a,d);if(b){const k=1<<d.z,N=o.aF(g.center.lng),j=o.aJ(g.center.lat),R=(d.x+.5)/k-N;let z=0;R>.5?z=-1:R<-.5&&(z=1);let B=(t/o.al+d.x)/k+z,U=(a/o.al+d.y)/k;B=(B-N)*g._pixelsPerMercatorPixel+N,U=(U-j)*g._pixelsPerMercatorPixel+j;const Y=[B*g.worldSize,U*g.worldSize,0];o.af(Y,Y,b),I=o.bn(I,Y,T)}return o.af(I,I,_)}_makeGlobeTileDebugBorderBuffer(t,a,d,g,_,b){const T=new o.bd,I=new o.be,k=new o.bo,N=(R,z,B,U,Y)=>{const H=(B-R)/(Y-1),K=(U-z)/(Y-1),ne=T.length;for(let ce=0;ce<Y;ce++){const ge=R+ce*H,pe=z+ce*K;T.emplaceBack(ge,pe);const _e=this._globePoint(ge,pe,a,d,g,_,b);k.emplaceBack(_e[0],_e[1],_e[2]),I.emplaceBack(ne+ce)}},j=o.al;N(0,0,j,0,16),N(j,0,j,j,16),N(j,j,0,j,16),N(0,j,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(I),this._tileDebugBuffer=t.createVertexBuffer(T,o.bf.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(k,o.bp.members),this._tileDebugSegments=o.bg.simpleSegment(0,0,T.length,I.length)}_makeGlobeTileDebugTextBuffer(t,a,d,g,_,b){const T=o.al/4,I=new o.bd,k=new o.b1,N=new o.bo,j=25;k.reserve(32),I.reserve(j),N.reserve(j);const R=(z,B)=>j*z+B;for(let z=0;z<j;z++){const B=z*T;for(let U=0;U<j;U++){const Y=U*T;I.emplaceBack(Y,B);const H=this._globePoint(Y,B,a,d,g,_,b);N.emplaceBack(H[0],H[1],H[2])}}for(let z=0;z<4;z++)for(let B=0;B<4;B++){const U=R(z,B),Y=R(z,B+1),H=R(z+1,B),K=R(z+1,B+1);k.emplaceBack(U,Y,H),k.emplaceBack(H,Y,K)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(k),this._tileDebugTextBuffer=t.createVertexBuffer(I,o.bf.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(N,o.bp.members),this._tileDebugTextSegments=o.bg.simpleSegment(0,0,j,32)}destroy(t=!1){for(const a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof o.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}o.bs.setPbf(o.bt);class Ju extends Ka{constructor(t,a,d,g,_){super(t,a,d,g,_),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,a,d){const g=d.context,_=g.gl;let b=this.texturePerLayer.get(t)||d.getTileTexture(a.width);b&&b instanceof o.T?b.update(a,{premultiply:!1}):b=new o.T(g,a,_.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,b)}flushQueues(t){const a=this._workQueuePerLayer.get(t)||[],d=this._fetchQueuePerLayer.get(t)||[];for(;a.length;)a.pop()();for(;d.length;)d.pop()()}flushAllQueues(){for(const t of this._workQueuePerLayer.keys()){const a=this._workQueuePerLayer.get(t)||[];for(;a.length;)a.pop()()}for(const t of this._fetchQueuePerLayer.keys()){const a=this._fetchQueuePerLayer.get(t)||[];for(;a.length;)a.pop()()}}fetchHeader(t=16384,a){const d=this._mrt=new o.bs(30),g=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=o.bu(g,(_,b,T,I)=>{if(_)a(_);else try{const k=d.getHeaderLength(b);if(k>t)return void(this.request=this.fetchHeader(k,a));d.parseHeader(b),this._isHeaderLoaded=!0;let N=0;for(const j of Object.values(d.layers))N=Math.max(N,j.dataIndex[j.dataIndex.length-1].lastByte);b.byteLength>=N&&(this.entireBuffer=b),a(null,this.entireBuffer||b,T,I)}catch(k){a(k)}}),this.request}fetchBandForRender(t,a,d,g){this.fetchBand(t,a,d,_=>{if(_)return void g(_);this.updateTextureDescriptor(t,a,d);const b=this.textureDescriptorPerLayer.get(a);g(null,b?b.img:null)})}fetchBand(t,a,d,g,_=!0){const b=this._mrt;if(!this._isHeaderLoaded||!b)return void g(new Error("Tile header is not ready"));const T=this.actor;if(!T)return void g(new Error("Can't fetch tile band without an actor"));let I;const k=o.B(String(d),o.B(this.tileID.key,t));let N=this._taskQueue.get(k);N?N.add(g):(N=new Set,N.add(g),this._taskQueue.set(k,N));const j=(U,Y)=>{I.complete(U,Y),U?g(U):(N.values().forEach(H=>H(null,Y)),this._taskQueue.delete(k))},R=(U,Y)=>{if(U)return g(U);const H=T.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:Y,task:I},j,void 0,!0);if(a!==null){const K=this._workQueuePerLayer.get(a)||[];K.push(()=>{H&&H.cancel(),I.cancel()}),this._workQueuePerLayer.has(a)||this._workQueuePerLayer.set(a,K)}};let z;try{z=b.getLayer(t)}catch(U){if(this.state==="reloading")return;throw U}if(!z)return void g(new Error(`Unknown sourceLayer "${t}"`));if(z.hasDataForBand(d))return N.values().forEach(U=>U(null,null)),void this._taskQueue.delete(k);const B=z.getDataRange([d]);if(I=b.createDecodingTask(B),!I||I.tasks.length)if(a!==null&&this.flushQueues(a),this.entireBuffer)R(null,this.entireBuffer.slice(B.firstByte,B.lastByte+1));else{const U=Object.assign({},this.requestParams,{headers:{Range:`bytes=${B.firstByte}-${B.lastByte}`}}),Y=o.bu(U,R);if(a!==null){const H=this._fetchQueuePerLayer.get(a)||[];H.push(()=>{Y.cancel(),I.cancel()}),this._fetchQueuePerLayer.has(a)||this._fetchQueuePerLayer.set(a,H)}}}updateNeeded(t,a){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==a||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(t,a,d){if(!this._mrt)return;const g=this._mrt.getLayer(t);if(!g||!g.hasBand(d)||!g.hasDataForBand(d))return;const{bytes:_,tileSize:b,buffer:T,offset:I,scale:k}=g.getBandView(d),N=b+2*T,j=new o.q({width:N,height:N},_),R=this.texturePerLayer.get(a);R&&R instanceof o.T&&R.update(j,{premultiply:!1}),this.textureDescriptorPerLayer.set(a,{layer:t,band:d,img:j,buffer:T,offset:I,tileSize:b,format:g.pixelFormat,mix:[k,256*k,65536*k,16777216*k]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const a of this.texturePerLayer.values())a&&a instanceof o.T&&a.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class Qu{constructor(t,a){this.max=t,this.onRemove=a,this.reset()}reset(){for(const t in this.data)for(const a of this.data[t])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(t,a,d){const g=t.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);const _={value:a,timeout:void 0};if(d!==void 0&&(_.timeout=setTimeout(()=>{this.remove(t,_)},d)),this.data[g].push(_),this.order.push(g),this.order.length>this.max){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const a=this.data[t].shift();return a.timeout&&clearTimeout(a.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),a.value}getByKey(t){const a=this.data[t];return a?a[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,a){if(!this.has(t))return this;const d=t.wrapped().key,g=a===void 0?0:this.data[d].indexOf(a),_=this.data[d][g];return this.data[d].splice(g,1),_.timeout&&clearTimeout(_.timeout),this.data[d].length===0&&delete this.data[d],this.onRemove(_.value),this.order.splice(this.order.indexOf(d),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(t){const a=[];for(const d in this.data)for(const g of this.data[d])t(g.value)||a.push(g);for(const d of a)this.remove(d.value.tileID,d)}}class Ac{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,a,d){const g=String(a);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][g]=this.stateChanges[t][g]||{},Object.assign(this.stateChanges[t][g],d),this.deletedStates[t]===null){this.deletedStates[t]={};for(const _ in this.state[t])_!==g&&(this.deletedStates[t][_]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][g]===null){this.deletedStates[t][g]={};for(const _ in this.state[t][g])d[_]||(this.deletedStates[t][g][_]=null)}else for(const _ in d)this.deletedStates[t]&&this.deletedStates[t][g]&&this.deletedStates[t][g][_]===null&&delete this.deletedStates[t][g][_]}removeFeatureState(t,a,d){if(this.deletedStates[t]===null)return;const g=String(a);if(this.deletedStates[t]=this.deletedStates[t]||{},d&&a!==void 0)this.deletedStates[t][g]!==null&&(this.deletedStates[t][g]=this.deletedStates[t][g]||{},this.deletedStates[t][g][d]=null);else if(a!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][g])for(d in this.deletedStates[t][g]={},this.stateChanges[t][g])this.deletedStates[t][g][d]=null;else this.deletedStates[t][g]=null;else this.deletedStates[t]=null}getState(t,a){const d=this.state[t]||{},g=this.stateChanges[t]||{},_=this.deletedStates[t];if(_===null)return{};if(a!==void 0){const T=String(a),I=Object.assign({},d[T],g[T]);if(_){const k=_[a];if(k===null)return{};for(const N in k)delete I[N]}return I}const b=Object.assign({},d,g);if(_)for(const T in _)delete b[T];return b}initializeTileState(t,a){t.refreshFeatureState(a)}coalesceChanges(t,a){const d={};for(const g in this.stateChanges){this.state[g]=this.state[g]||{};const _={};for(const b in this.stateChanges[g])this.state[g][b]||(this.state[g][b]={}),Object.assign(this.state[g][b],this.stateChanges[g][b]),_[b]=this.state[g][b];d[g]=_}for(const g in this.deletedStates){this.state[g]=this.state[g]||{};const _={};if(this.deletedStates[g]===null)for(const b in this.state[g])_[b]={},this.state[g][b]={};else for(const b in this.deletedStates[g]){if(this.deletedStates[g][b]===null)this.state[g][b]={};else if(this.state[g][b])for(const T of Object.keys(this.deletedStates[g][b]))delete this.state[g][b][T];_[b]=this.state[g][b]}d[g]=d[g]||{},Object.assign(d[g],_)}if(this.stateChanges={},this.deletedStates={},Object.keys(d).length!==0)for(const g in t)t[g].refreshFeatureState(a)}}class Ws extends o.E{constructor(t,a,d){super(),this.id=t,this._onlySymbols=d,a.on("data",g=>{g.dataType==="source"&&g.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&g.dataType==="source"&&g.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),a.on("error",()=>{this._sourceErrored=!0}),this._source=a,this._tiles={},this._cache=new Qu(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=a.minTileCacheSize,this._maxTileCacheSize=a.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ac,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,a){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,a)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const a in this._tiles){const d=this._tiles[a];d.upload(t),d.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort($p).map(t=>t.key)}getRenderableIds(t,a){const d=[];for(const g in this._tiles)this._isIdRenderable(+g,t,a)&&d.push(this._tiles[g]);return t?d.sort((g,_)=>{const b=g.tileID,T=_.tileID,I=new o.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),k=new o.P(T.canonical.x,T.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-T.overscaledZ||k.y-I.y||k.x-I.x}).map(g=>g.tileID.key):d.map(g=>g.tileID).sort($p).map(g=>g.key)}hasRenderableParent(t){const a=this.findLoadedParent(t,0);return!!a&&this._isIdRenderable(a.tileID.key)}_isIdRenderable(t,a,d){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(a||!this._tiles[t].holdingForFade())&&(d||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,a){const d=this._tiles[t];d&&(d.state!=="loading"&&(d.state=a),this._loadTile(d,this._tileLoaded.bind(this,d,t,a)))}_tileLoaded(t,a,d,g){if(g)if(t.state="errored",g.status!==404)this._source.fire(new o.y(g,{tile:t}));else{if(this._source.fire(new o.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const _=this.map.painter.terrain;this.update(this.transform,_.getScaledDemTileSize(),!0),_.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=o.o.now(),d==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(a,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new o.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const a=this.getRenderableIds();for(let g=0;g<a.length;g++){const _=a[g];if(t.neighboringTiles&&t.neighboringTiles[_]){const b=this.getTileByID(_);d(t,b),d(b,t)}}function d(g,_){if(!g.dem||g.dem.borderReady)return;g.needsHillshadePrepare=!0,g.needsDEMTextureUpload=!0;let b=_.tileID.canonical.x-g.tileID.canonical.x;const T=_.tileID.canonical.y-g.tileID.canonical.y,I=Math.pow(2,g.tileID.canonical.z),k=_.tileID.key;b===0&&T===0||Math.abs(T)>1||(Math.abs(b)>1&&(Math.abs(b+I)===1?b+=I:Math.abs(b-I)===1&&(b-=I)),_.dem&&g.dem&&(g.dem.backfillBorder(_.dem,b,T),g.neighboringTiles&&g.neighboringTiles[k]&&(g.neighboringTiles[k].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,a,d,g){for(const _ in this._tiles){let b=this._tiles[_];if(g[_]||!b.hasData()||b.tileID.overscaledZ<=a||b.tileID.overscaledZ>d)continue;let T=b.tileID;for(;b&&b.tileID.overscaledZ>a+1;){const k=b.tileID.scaledTo(b.tileID.overscaledZ-1);b=this._tiles[k.key],b&&b.hasData()&&(T=k)}let I=T;for(;I.overscaledZ>a;)if(I=I.scaledTo(I.overscaledZ-1),t[I.key]){g[T.key]=T;break}}}findLoadedParent(t,a){if(t.key in this._loadedParentTiles){const d=this._loadedParentTiles[t.key];return d&&d.tileID.overscaledZ>=a?d:null}for(let d=t.overscaledZ-1;d>=a;d--){const g=t.scaledTo(d),_=this._getLoadedTile(g);if(_)return _}}_getLoadedTile(t){const a=this._tiles[t.key];return a&&a.hasData()?a:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,a){a=a||this._source.tileSize;const d=Math.ceil(t.width/a)+1,g=Math.ceil(t.height/a)+1,_=Math.floor(d*g*5),b=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,_):_,T=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,b):b;this._cache.setMaxSize(T)}handleWrapJump(t){const a=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,a){const d={};for(const g in this._tiles){const _=this._tiles[g];_.tileID=_.tileID.unwrapTo(_.tileID.wrap+a),d[_.tileID.key]=_}this._tiles=d;for(const g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(const g in this._tiles)this._setTileReloadTimer(+g,this._tiles[g])}}update(t,a,d,g,_){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!d)return;this.updateCacheSize(t,a),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const b=this._source.type==="batched-model";let T,I=this._source.maxzoom;const k=this.map&&this.map.painter?this.map.painter._terrain:null;if(k&&k.sourceCache===this&&k.attenuationRange()){const R=k.attenuationRange()[0],z=Math.floor(R)-Math.log2(k.getDemUpscale());I>z&&(I=z)}if(this.used||this.usedForTerrain){if(this._source.tileID)T=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new o.aO(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y));else if(this.tileCoverLift!==0){const R=t.clone();R.tileCoverLift=this.tileCoverLift,T=R.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:I,roundZoom:this._source.roundZoom&&!d,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.minzoom<=1&&t.projection.name==="globe"&&(T.push(new o.aO(1,0,1,0,0)),T.push(new o.aO(1,0,1,1,0)),T.push(new o.aO(1,0,1,0,1)),T.push(new o.aO(1,0,1,1,1)))}else if(T=t.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:I,roundZoom:this._source.roundZoom&&!d,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:b}),this._source.hasTile){const R=this._source.hasTile.bind(this._source);T=T.filter(z=>R(z))}}else T=[];if(T.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!mh(this._source.type)){const R=t.coveringZoomLevel({tileSize:a||this._source.tileSize,roundZoom:this._source.roundZoom&&!d}),z=Math.min(R,this._source.maxzoom);if(b){const B=t.extendTileCover(T,z);for(const U of B)T.push(U)}else if(_){const B=t.extendTileCoverToNearPlane(T,this.transform.getFrustum(z),z);for(const U of B)T.push(U)}else if(this.castsShadows&&g){const B=t.extendTileCover(T,z,g);for(const U of B)this._shadowCasterTiles[U.key]=!0,T.push(U)}}const N=this._updateRetainedTiles(T);if(mh(this._source.type)&&T.length!==0){const R={},z={},B=Object.keys(N);for(const Y of B){const H=N[Y],K=this._tiles[Y];if(!K||K.fadeEndTime&&K.fadeEndTime<=o.o.now())continue;const ne=this.findLoadedParent(H,Math.max(H.overscaledZ-Ws.maxOverzooming,this._source.minzoom));ne&&(this._addTile(ne.tileID),R[ne.tileID.key]=ne.tileID),z[Y]=H}const U=T[T.length-1].overscaledZ;for(const Y in this._tiles){const H=this._tiles[Y];if(N[Y]||!H.hasData())continue;let K=H.tileID;for(;K.overscaledZ>U;){K=K.scaledTo(K.overscaledZ-1);const ne=this._tiles[K.key];if(ne&&ne.hasData()&&z[K.key]){N[Y]=H.tileID;break}}}for(const Y in R)N[Y]||(this._coveredTiles[Y]=!0,N[Y]=R[Y])}for(const R in N)this._tiles[R].clearFadeHold();const j=o.bv(this._tiles,N);for(const R of j){const z=this._tiles[R];z.hasSymbolBuckets&&!z.holdingForFade()?z.setHoldDuration(this.map._fadeDuration):z.hasSymbolBuckets&&!z.symbolFadeFinished()||this._removeTile(+R)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const a={};if(t.length===0)return a;const d={},g=t.reduce((k,N)=>Math.min(k,N.overscaledZ),1/0),_=t[0].overscaledZ,b=Math.max(_-Ws.maxOverzooming,this._source.minzoom),T=Math.max(_+Ws.maxUnderzooming,this._source.minzoom),I={};for(const k of t){const N=this._addTile(k);a[k.key]=k,N.hasData()||g<this._source.maxzoom&&(I[k.key]=k)}this._retainLoadedChildren(I,g,T,a);for(const k of t){let N=this._tiles[k.key];if(N.hasData())continue;if(k.canonical.z>=this._source.maxzoom){const R=k.children(this._source.maxzoom)[0],z=this.getTile(R);if(z&&z.hasData()){a[R.key]=R;continue}}else{const R=k.children(this._source.maxzoom);if(a[R[0].key]&&a[R[1].key]&&a[R[2].key]&&a[R[3].key])continue}let j=N.wasRequested();for(let R=k.overscaledZ-1;R>=b;--R){const z=k.scaledTo(R);if(d[z.key]||(d[z.key]=!0,N=this.getTile(z),!N&&j&&(N=this._addTile(z)),N&&(a[z.key]=z,j=N.wasRequested(),N.hasData())))break}}return a}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const a=[];let d,g=this._tiles[t].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){d=this._loadedParentTiles[g.key];break}a.push(g.key);const _=g.scaledTo(g.overscaledZ-1);if(d=this._getLoadedTile(_),d)break;g=_}for(const _ of a)this._loadedParentTiles[_]=d}}_addTile(t){let a=this._tiles[t.key];if(a)return a.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),a;a=this._cache.getAndRemove(t),a&&(this._setTileReloadTimer(t.key,a),a.tileID=t,this._state.initializeTileState(a,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,a)));const d=!!a;if(!d){const g=this.map?this.map.painter:null,_=this._source.tileSize*t.overscaleFactor();a=this._source.type==="raster-array"?new Ju(t,_,this.transform.tileZoom,g,this._isRaster):new Ka(t,_,this.transform.tileZoom,g,this._isRaster,this._source.worldview),this._loadTile(a,this._tileLoaded.bind(this,a,t.key,a.state))}return a.uses++,this._tiles[t.key]=a,d||this._source.fire(new o.z("dataloading",{tile:a,coord:a.tileID,dataType:"source"})),a}_setTileReloadTimer(t,a){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const d=a.getExpiryTimeout();d&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},d))}_removeTile(t){const a=this._tiles[t];a&&(a.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),a.uses>0||(a.hasData()&&a.state!=="reloading"||a.state==="empty"?this._cache.add(a.tileID,a,a.getExpiryTimeout()):(a.aborted=!0,this._abortTile(a),this._unloadTile(a))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,a,d){const g=[],_=this.transform;if(!_)return g;const b=_.projection.name==="globe",T=o.aF(_.center.lng);for(const I in this._tiles){const k=this._tiles[I];if(d&&k.clearQueryDebugViz(),k.holdingForFade())continue;let N;if(b){const j=k.tileID.canonical;if(j.z===0){const R=[Math.abs(o.aA(T,...Pc(j,-1))-T),Math.abs(o.aA(T,...Pc(j,1))-T)];N=[0,2*R.indexOf(Math.min(...R))-1]}else{const R=[Math.abs(o.aA(T,...Pc(j,-1))-T),Math.abs(o.aA(T,...Pc(j,0))-T),Math.abs(o.aA(T,...Pc(j,1))-T)];N=[R.indexOf(Math.min(...R))-1]}}else N=[0];for(const j of N){const R=t.containsTile(k,_,a,j);R&&g.push(R)}}return g}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,a){const d=this.getRenderableIds(t,a).map(_=>this._tiles[_].tileID),g=this.transform.projection.name==="globe";for(const _ of d)_.projMatrix=this.transform.calculateProjMatrix(_.toUnwrapped()),_.expandedProjMatrix=g?this.transform.calculateProjMatrix(_.toUnwrapped(),!1,!0):_.projMatrix;return d}sortCoordinatesByDistance(t){const a=t.slice(),d=this.transform._camera.position,g=this.transform._camera.forward(),_={};for(const b of a){const T=1/(1<<b.canonical.z);_[b.key]=((b.canonical.x+.5)*T+b.wrap-d[0])*g[0]+((b.canonical.y+.5)*T-d[1])*g[1]-d[2]*g[2]}return a.sort((b,T)=>_[b.key]-_[T.key]),a}hasTransition(){if(this._source.hasTransition())return!0;if(mh(this._source.type))for(const t in this._tiles){const a=this._tiles[t];if(a.fadeEndTime!==void 0&&a.fadeEndTime>=o.o.now())return!0}return!1}setFeatureState(t,a,d){this._state.updateState(t=t||"_geojsonTileLayer",a,d)}removeFeatureState(t,a,d){this._state.removeFeatureState(t=t||"_geojsonTileLayer",a,d)}getFeatureState(t,a){return this._state.getState(t=t||"_geojsonTileLayer",a)}setDependencies(t,a,d){const g=this._tiles[t];g&&g.setDependencies(a,d)}reloadTilesForDependencies(t,a){for(const d in this._tiles)this._tiles[d].hasDependency(t,a)&&this._reloadTile(+d,"reloading");this._cache.filter(d=>!d.hasDependency(t,a))}_preloadTiles(t,a){if(!this._sourceLoaded){const I=()=>{this._sourceLoaded&&(this._source.off("data",I),this._preloadTiles(t,a))};return void this._source.on("data",I)}const d=new Map,g=Array.isArray(t)?t:[t],_=this.map.painter.terrain,b=this.usedForTerrain&&_?_.getScaledDemTileSize():this._source.tileSize;for(const I of g){const k=I.coveringTiles({tileSize:b,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const N of k)d.set(N.key,N);this.usedForTerrain&&I.updateElevation(!1)}const T=Array.from(d.values());o.bw(T,(I,k)=>{const N=new Ka(I,this._source.tileSize*I.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(N,j=>{this._source.type==="raster-dem"&&N.dem&&this._backfillDEM(N),k(j,N)})},a)}}function $p(h,t){const a=Math.abs(2*h.wrap)-+(h.wrap<0),d=Math.abs(2*t.wrap)-+(t.wrap<0);return h.overscaledZ-t.overscaledZ||d-a||t.canonical.y-h.canonical.y||t.canonical.x-h.canonical.x}function mh(h){return h==="raster"||h==="image"||h==="video"||h==="custom"}function Pc(h,t){const a=1<<h.z;return[h.x/a+t,(h.x+1)/a+t]}Ws.maxOverzooming=10,Ws.maxUnderzooming=3;class gh{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,a=!1;for(const d in this.style._mergedLayers){const g=this.style._mergedLayers[d];if(g.type==="fill-extrusion"||g.type==="building")this.layers.push({layer:g,visible:t,visibilityChanged:a});else if(g.type==="model"){const _=this.style.getLayerSource(g);_&&_.type==="batched-model"&&this.layers.push({layer:g,visible:t,visibilityChanged:a})}}}onNewFrame(t){this.layersGotHidden=!1;for(const a of this.layers){const d=a.layer;let g=!1;d.type==="fill-extrusion"?g=!d.isHidden(t)&&d.paint.get("fill-extrusion-opacity")>0:d.type==="building"?g=!d.isHidden(t)&&d.paint.get("building-opacity")>0:d.type==="model"&&(g=!d.isHidden(t)&&d.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!g&&a.visible,a.visible=g}}updateZOffset(t,a){this.currentBuildingBuckets=[];for(const g of this.layers){const _=g.layer,b=this.style.getLayerSourceCache(_);let T=1;_.type==="fill-extrusion"?T=g.visible?_.paint.get("fill-extrusion-vertical-scale"):0:_.type==="building"&&(T=g.visible?_.paint.get("building-vertical-scale"):0);let I=b?b.getTile(a):null;if(!I&&b)for(const k in b._tiles){const N=b._tiles[k];if(a.canonical.isChildOf(N.tileID.canonical)){I=N;break}}this.currentBuildingBuckets.push({bucket:I?I.getBucket(_):null,tileID:I?I.tileID:a,verticalScale:T})}t.hasAnyZOffset=!1;let d=!1;for(let g=0;g<t.symbolInstances.length;g++){const _=t.symbolInstances.get(g),b=_.zOffset,T=this._getHeightAtTileOffset(a,_.tileAnchorX,_.tileAnchorY);_.zOffset=T!==Number.NEGATIVE_INFINITY?T:b,d||b===_.zOffset||(d=!0),t.hasAnyZOffset||_.zOffset===0||(t.hasAnyZOffset=!0)}d&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,a,d,g){let _=a,b=d;if(t.canonical.z!==g.canonical.z){const T=g.canonical,I=1/(1<<t.canonical.z-T.z);_=(a+t.canonical.x*o.al)*I-T.x*o.al|0,b=(d+t.canonical.y*o.al)*I-T.y*o.al|0}return{tileX:_,tileY:b}}_getHeightAtTileOffset(t,a,d){let g,_;for(let b=0;b<this.layers.length;++b){const T=this.layers[b].layer;if(T.type!=="fill-extrusion"&&T.type!=="building")continue;const{bucket:I,tileID:k,verticalScale:N}=this.currentBuildingBuckets[b];if(!I)continue;const{tileX:j,tileY:R}=this._mapCoordToOverlappingTile(t,a,d,k),z=I.getHeightAtTileCoord(j,R);z&&z.height!==void 0&&(z.hidden?g=z.height:_=Math.max(z.height*N,_||0))}if(_!==void 0)return _;for(let b=0;b<this.layers.length;++b){const T=this.layers[b];if(T.layer.type!=="model"||!T.visible)continue;const{bucket:I,tileID:k}=this.currentBuildingBuckets[b];if(!I)continue;const{tileX:N,tileY:j}=this._mapCoordToOverlappingTile(t,a,d,k),R=I.getHeightAtTileCoord(N,j);if(R&&!R.hidden)return R.height===void 0&&g!==void 0?Math.min(R.maxHeight,g)*R.verticalScale:R.height?R.height*R.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Gp(h,t){const a={};for(const d in h)d!=="ref"&&(a[d]=h[d]);return o.bx.forEach(d=>{d in t&&(a[d]=t[d])}),a}function _h(h){h=h.slice();const t=Object.create(null);for(let a=0;a<h.length;a++)t[h[a].id]=h[a];for(let a=0;a<h.length;a++)"ref"in h[a]&&(h[a]=Gp(h[a],t[h[a].ref]));return h}const Ur={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function kc(h,t,a){a.push({command:Ur.addSource,args:[h,t[h]]})}function X_(h,t,a){t.push({command:Ur.removeSource,args:[h]}),a[h]=!0}function Y_(h,t,a,d){X_(h,a,d),kc(h,t,a)}function yh(h,t,a){let d;for(d in h[a])if(h[a].hasOwnProperty(d)&&d!=="data"&&!o.by(h[a][d],t[a][d]))return!1;for(d in t[a])if(t[a].hasOwnProperty(d)&&d!=="data"&&!o.by(h[a][d],t[a][d]))return!1;return!0}function Ja(h,t,a,d,g,_){let b;for(b in t=t||{},h=h||{})h.hasOwnProperty(b)&&(o.by(h[b],t[b])||a.push({command:_,args:[d,b,t[b],g]}));for(b in t)t.hasOwnProperty(b)&&!h.hasOwnProperty(b)&&(o.by(h[b],t[b])||a.push({command:_,args:[d,b,t[b],g]}))}function Mc(h){return h.id}function ed(h,t){return h[t.id]=t,h}function xh(h,t,a){const d=t.createTileMatrix(h,h.worldSize,a.toUnwrapped());return o.aB(new Float32Array(16),h.projMatrix,d)}function K_(h,t,a){if(t.projection.name===a.projection.name)return h.projMatrix;const d=a.clone();return d.setProjection(t.projection),xh(d,t.getProjection(),h)}function jl(h,t,a){return t.name===a.projection.name?h.projMatrix:xh(a,t,h)}class J_{constructor(t,a){this.reset(t,a)}reset(t,a){this.points=t||[],this._distances=[0];for(let d=1;d<this.points.length;d++)this._distances[d]=this._distances[d-1]+this.points[d].dist(this.points[d-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(a||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=o.aA(t,0,1);let a=1,d=this._distances[a];const g=t*this.paddedLength+this.padding;for(;d<g&&a<this._distances.length;)d=this._distances[++a];const _=a-1,b=this._distances[_],T=d-b,I=T>0?(g-b)/T:0;return this.points[_].mult(1-I).add(this.points[a].mult(I))}}class qp{constructor(t,a,d){const g=this.boxCells=[],_=this.circleCells=[];this.xCellCount=Math.ceil(t/d),this.yCellCount=Math.ceil(a/d);for(let b=0;b<this.xCellCount*this.yCellCount;b++)g.push([]),_.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=a,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/a,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,a,d,g,_){this._forEachCell(a,d,g,_,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(a),this.bboxes.push(d),this.bboxes.push(g),this.bboxes.push(_)}insertCircle(t,a,d,g){this._forEachCell(a-g,d-g,a+g,d+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(a),this.circles.push(d),this.circles.push(g)}_insertBoxCell(t,a,d,g,_,b){this.boxCells[_].push(b)}_insertCircleCell(t,a,d,g,_,b){this.circleCells[_].push(b)}_query(t,a,d,g,_,b){if(d<0||t>this.width||g<0||a>this.height)return!_&&[];const T=[];if(t<=0&&a<=0&&this.width<=d&&this.height<=g){if(_)return!0;for(let I=0;I<this.boxKeys.length;I++)T.push({key:this.boxKeys[I],x1:this.bboxes[4*I],y1:this.bboxes[4*I+1],x2:this.bboxes[4*I+2],y2:this.bboxes[4*I+3]});for(let I=0;I<this.circleKeys.length;I++){const k=this.circles[3*I],N=this.circles[3*I+1],j=this.circles[3*I+2];T.push({key:this.circleKeys[I],x1:k-j,y1:N-j,x2:k+j,y2:N+j})}return b?T.filter(b):T}return this._forEachCell(t,a,d,g,this._queryCell,T,{hitTest:_,seenUids:{box:{},circle:{}}},b),_?T.length>0:T}_queryCircle(t,a,d,g,_){const b=t-d,T=t+d,I=a-d,k=a+d;if(T<0||b>this.width||k<0||I>this.height)return!g&&[];const N=[];return this._forEachCell(b,I,T,k,this._queryCellCircle,N,{hitTest:g,circle:{x:t,y:a,radius:d},seenUids:{box:{},circle:{}}},_),g?N.length>0:N}query(t,a,d,g,_){return this._query(t,a,d,g,!1,_)}hitTest(t,a,d,g,_){return this._query(t,a,d,g,!0,_)}hitTestCircle(t,a,d,g){return this._queryCircle(t,a,d,!0,g)}_queryCell(t,a,d,g,_,b,T,I){const k=T.seenUids,N=this.boxCells[_];if(N!==null){const R=this.bboxes;for(const z of N)if(!k.box[z]){k.box[z]=!0;const B=4*z;if(t<=R[B+2]&&a<=R[B+3]&&d>=R[B+0]&&g>=R[B+1]&&(!I||I(this.boxKeys[z]))){if(T.hitTest)return b.push(!0),!0;b.push({key:this.boxKeys[z],x1:R[B],y1:R[B+1],x2:R[B+2],y2:R[B+3]})}}}const j=this.circleCells[_];if(j!==null){const R=this.circles;for(const z of j)if(!k.circle[z]){k.circle[z]=!0;const B=3*z;if(this._circleAndRectCollide(R[B],R[B+1],R[B+2],t,a,d,g)&&(!I||I(this.circleKeys[z]))){if(T.hitTest)return b.push(!0),!0;{const U=R[B],Y=R[B+1],H=R[B+2];b.push({key:this.circleKeys[z],x1:U-H,y1:Y-H,x2:U+H,y2:Y+H})}}}}}_queryCellCircle(t,a,d,g,_,b,T,I){const k=T.circle,N=T.seenUids,j=this.boxCells[_];if(j!==null){const z=this.bboxes;for(const B of j)if(!N.box[B]){N.box[B]=!0;const U=4*B;if(this._circleAndRectCollide(k.x,k.y,k.radius,z[U+0],z[U+1],z[U+2],z[U+3])&&(!I||I(this.boxKeys[B])))return b.push(!0),!0}}const R=this.circleCells[_];if(R!==null){const z=this.circles;for(const B of R)if(!N.circle[B]){N.circle[B]=!0;const U=3*B;if(this._circlesCollide(z[U],z[U+1],z[U+2],k.x,k.y,k.radius)&&(!I||I(this.circleKeys[B])))return b.push(!0),!0}}}_forEachCell(t,a,d,g,_,b,T,I){const k=this._convertToXCellCoord(t),N=this._convertToYCellCoord(a),j=this._convertToXCellCoord(d),R=this._convertToYCellCoord(g);for(let z=k;z<=j;z++)for(let B=N;B<=R;B++)if(_.call(this,t,a,d,g,this.xCellCount*B+z,b,T,I))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,a,d,g,_,b){const T=g-t,I=_-a,k=d+b;return k*k>T*T+I*I}_circleAndRectCollide(t,a,d,g,_,b,T){const I=(b-g)/2,k=Math.abs(t-(g+I));if(k>I+d)return!1;const N=(T-_)/2,j=Math.abs(a-(_+N));if(j>N+d)return!1;if(k<=I||j<=N)return!0;const R=k-I,z=j-N;return R*R+z*z<=d*d}}const Nc={unknown:0,flipRequired:1,flipNotRequired:2},vh=Math.tan(85*Math.PI/180);function No(h,t,a,d,g,_,b){const T=o.bC();if(a)if(_.name==="globe"){const I=o.bD(g,t);o.aB(T,T,I)}else{const I=o.bE([],b);T[0]=I[0],T[1]=I[1],T[4]=I[2],T[5]=I[3],d||o.bB(T,T,g.angle)}else o.aB(T,g.labelPlaneMatrix,h);return T}function td(h,t,a,d,g,_,b){const T=No(h,t,a,d,g,_,b);return _.name==="globe"&&a||(T[2]=T[6]=T[10]=T[14]=0),T}function bh(h,t,a,d,g,_,b){if(a){if(_.name==="globe"){const T=No(h,t,a,d,g,_,b);return o.bl(T,T),o.aB(T,h,T),T}{const T=o.bz(h),I=o.bA([]);return I[0]=b[0],I[1]=b[1],I[4]=b[2],I[5]=b[3],o.aB(T,T,I),d||o.bB(T,T,-g.angle),T}}return g.glCoordMatrix}function Zs(h,t,a,d){const g=[h,t,a,1];a?o.aC(g,g,d):Xp(g,g,d);const _=g[3];return g[0]/=_,g[1]/=_,g[2]/=_,g}function zl(h,t){return Math.min(.5+h/t*.5,1.5)}function Xs(h,t){const a=h[0]/h[3],d=h[1]/h[3];return a>=-t[0]&&a<=t[0]&&d>=-t[1]&&d<=t[1]}function Hp(h,t,a,d,g,_,b,T,I,k){const N=a.transform,j=d?h.textSizeData:h.iconSizeData,R=o.bK(j,a.transform.zoom),z=N.projection.name==="globe",B=[256/a.width*2+1,256/a.height*2+1],U=d?h.text.dynamicLayoutVertexArray:h.icon.dynamicLayoutVertexArray;U.clear();let Y=null;z&&(Y=d?h.text.globeExtVertexArray:h.icon.globeExtVertexArray);const H=h.lineVertexArray,K=d?h.text.placedSymbolArray:h.icon.placedSymbolArray,ne=a.transform.width/a.transform.height;let ce,ge=!1;for(let pe=0;pe<K.length;pe++){const _e=K.get(pe),{numGlyphs:me,writingMode:fe}=_e;if(fe!==o.bL.vertical||ge||ce===o.bL.horizontal||(ge=!0),ce=fe,(_e.hidden||fe===o.bL.vertical)&&!ge){Yt(me,U);continue}ge=!1;const ye=new o.P(_e.tileAnchorX,_e.tileAnchorY);let{x:Fe,y:Pe,z:Ze}=N.projection.projectTilePoint(ye.x,ye.y,k.canonical);if(I){const[lt,Ft,Dt]=I(ye);Fe+=lt,Pe+=Ft,Ze+=Dt}const De=[Fe,Pe,Ze,1];if(o.aC(De,De,t),!Xs(De,B)){Yt(me,U);continue}const He=De[3],_t=zl(a.transform.getCameraToCenterDistance(N.projection),He),ze=o.bM(j,R,_e),Ie=b?ze/_t:ze*_t,Ye=Zs(Fe,Pe,Ze,g);if(Ye[3]<=0){Yt(me,U);continue}let Ue={};const nt=o.an(h.layers[0].layout.get("text-max-angle")),gt=Math.cos(nt),Et=b?null:I,dt=ti(_e,Ie,!1,T,t,g,_,h.glyphOffsetArray,H,U,Y,Ye,ye,Ue,ne,Et,N.projection,k,b,gt);ge=dt.useVertical,Et&&dt.needsFlipping&&(Ue={}),(dt.notEnoughRoom||ge||dt.needsFlipping&&ti(_e,Ie,!0,T,t,g,_,h.glyphOffsetArray,H,U,Y,Ye,ye,Ue,ne,Et,N.projection,k,b,gt).notEnoughRoom)&&Yt(me,U)}d?(h.text.dynamicLayoutVertexBuffer.updateData(U),Y&&h.text.globeExtVertexBuffer&&h.text.globeExtVertexBuffer.updateData(Y)):(h.icon.dynamicLayoutVertexBuffer.updateData(U),Y&&h.icon.globeExtVertexBuffer&&h.icon.globeExtVertexBuffer.updateData(Y))}function wh(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y){const{lineStartIndex:H,glyphStartIndex:K,segment:ne}=T,ce=K+T.numGlyphs,ge=H+T.lineLength,pe=t.getoffsetX(K),_e=t.getoffsetX(ce-1),me=Sh(h*pe,a,d,g,_,b,ne,H,ge,I,k,N,j,R,!0,z,B,U,Y);if(!me)return null;const fe=Sh(h*_e,a,d,g,_,b,ne,H,ge,I,k,N,j,R,!0,z,B,U,Y);return fe?{first:me,last:fe}:null}function Wp(h,t,a,d){return h===o.bL.horizontal&&Math.abs(d)>Math.abs(a)?{useVertical:!0}:h===o.bL.vertical?d>0?{needsFlipping:!0}:null:t!==Nc.unknown&&function(g,_){return g===0||Math.abs(_/g)>vh}(a,d)?t===Nc.flipRequired?{needsFlipping:!0}:null:a<0?{needsFlipping:!0}:null}function ti(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H,K,ne){const ce=t/24,ge=h.lineOffsetX*ce,pe=h.lineOffsetY*ce,{lineStartIndex:_e,glyphStartIndex:me,numGlyphs:fe,segment:ye,writingMode:Fe,flipState:Pe}=h,Ze=_e+h.lineLength,De=He=>{if(N){const[Ye,Ue,nt]=He.up,gt=k.length;o.bN(N,gt+0,Ye,Ue,nt),o.bN(N,gt+1,Ye,Ue,nt),o.bN(N,gt+2,Ye,Ue,nt),o.bN(N,gt+3,Ye,Ue,nt)}const[_t,ze,Ie]=He.point;o.bO(k,_t,ze,Ie,He.angle)};if(fe>1){const He=wh(ce,T,ge,pe,a,j,R,h,I,_,z,U,!1,Y,H,K,ne);if(!He)return{notEnoughRoom:!0};if(d&&!a){let[_t,ze,Ie]=He.first.point,[Ye,Ue,nt]=He.last.point;[_t,ze]=Zs(_t,ze,Ie,b),[Ye,Ue]=Zs(Ye,Ue,nt,b);const gt=Wp(Fe,Pe,(Ye-_t)*B,Ue-ze);if(h.flipState=gt&&gt.needsFlipping?Nc.flipRequired:Nc.flipNotRequired,gt)return gt}De(He.first);for(let _t=me+1;_t<me+fe-1;_t++){const ze=Sh(ce*T.getoffsetX(_t),ge,pe,a,j,R,ye,_e,Ze,I,_,z,U,!1,!1,Y,H,K,ne);if(!ze)return k.length-=4*(_t-me),{notEnoughRoom:!0};De(ze)}De(He.last)}else{if(d&&!a){const _t=Zs(R.x,R.y,0,g),ze=_e+ye+1,Ie=new o.P(I.getx(ze),I.gety(ze)),Ye=Zs(Ie.x,Ie.y,0,g),Ue=Ye[3]>0?Ye:Q_(R,Ie,_t,1,g,void 0,Y,H.canonical),nt=Wp(Fe,Pe,(Ue[0]-_t[0])*B,Ue[1]-_t[1]);if(h.flipState=nt&&nt.needsFlipping?Nc.flipRequired:Nc.flipNotRequired,nt)return nt}const He=Sh(ce*T.getoffsetX(me),ge,pe,a,j,R,ye,_e,Ze,I,_,z,U,!1,!1,Y,H,K,ne);if(!He)return{notEnoughRoom:!0};De(He)}return{}}function Zp(h,t,a,d,g){const{x:_,y:b,z:T}=d.projectTilePoint(h.x,h.y,t);if(!g)return Zs(_,b,T,a);const[I,k,N]=g(h);return Zs(_+I,b+k,T+N,a)}function Q_(h,t,a,d,g,_,b,T){const I=Zp(h.sub(t)._unit()._add(h),T,g,b,_);return o.av(I,a,I),o.aw(I,I),o.bH(I,a,I,d)}function Sh(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H,K){const ne=d?h-t:h+t;let ce=ne>0?1:-1,ge=0;d&&(ce*=-1,ge=Math.PI),ce<0&&(ge+=Math.PI);let pe=T+b+(ce>0?0:1)|0,_e=g,me=g,fe=0,ye=0;const Fe=Math.abs(ne),Pe=[],Ze=[];let De=_,He=De,_t=o.bF([]);const ze=()=>Q_(He,De,me,Fe-fe+1,N,R,U,Y.canonical);for(;fe+ye<=Fe;){if(pe+=ce,pe<T||pe>=I)return null;if(me=_e,He=De,Pe.push(me),z&&Ze.push(He),De=new o.P(k.getx(pe),k.gety(pe)),_e=j[pe],!_e){const Dt=Zp(De,Y.canonical,N,U,R);_e=Dt[3]>0?j[pe]=Dt:ze()}fe+=ye;const lt=o.av([],_e,me),Ft=o.bG(me,_e);if(a&&Ft>0&&ye>0&&o.bJ(_t,lt)/(ye*Ft)<K)return null;ye=Ft,_t=lt}B&&R&&(j[pe]&&(_e=ze(),ye=o.bG(me,_e),_t=o.av([],_e,me)),j[pe]=_e);const Ie=(Fe-fe)/ye,Ye=De.sub(He)._mult(Ie)._add(He),Ue=o.bH([],me,_t,Ie);let nt=[0,0,1],gt=_t[0],Et=_t[1];if(H&&(nt=U.upVector(Y.canonical,Ye.x,Ye.y),nt[0]!==0||nt[1]!==0||nt[2]!==1)){const lt=[nt[2],0,-nt[0]],Ft=o.bI([],nt,lt);o.aw(lt,lt),o.aw(Ft,Ft),gt=o.bJ(_t,lt),Et=o.bJ(_t,Ft)}if(a){const lt=o.bI([],nt,_t);o.aw(lt,lt),o.bH(Ue,Ue,lt,a*ce)}const dt=ge+Math.atan2(Et,gt);return Pe.push(Ue),z&&Ze.push(Ye),{point:Ue,angle:dt,path:Pe,tilePath:Ze,up:nt}}function Yt(h,t){const a=t.length,d=a+4*h;t.resize(d),t.float32.fill(-1/0,4*a,4*d)}function Xp(h,t,a){const d=t[0],g=t[1];return h[0]=a[0]*d+a[4]*g+a[12],h[1]=a[1]*d+a[5]*g+a[13],h[3]=a[3]*d+a[7]*g+a[15],h}const Ys=100;class Ro{constructor(t,a,d=new qp(t.width+200,t.height+200,25),g=new qp(t.width+200,t.height+200,25)){this.transform=t,this.grid=d,this.ignoredGrid=g,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Ys,this.screenBottomBoundary=t.height+Ys,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=a}placeCollisionBox(t,a,d,g,_,b,T,I,k,N,j){let R=d.projectedAnchorX,z=d.projectedAnchorY,B=d.projectedAnchorZ;const U=d.tileAnchorX,Y=d.tileAnchorY,H=d.elevation,K=d.tileID,ne=t.getProjection();if(H&&K){const[Ze,De,He]=ne.upVector(K.canonical,d.tileAnchorX,d.tileAnchorY),_t=ne.upVectorScale(K.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;R+=Ze*H*_t,z+=De*H*_t,B+=He*H*_t}const ce=t.projection.name==="globe",ge=t.projection.name==="globe"?o.aj(this.transform.zoom):0;if(K&&ce&&ge<1&&!b){const Ze=1<<K.canonical.z,De=o.bP(U,Y);o.bQ(De,De,1/o.al),o.bR(De,De,o.bP(K.canonical.x,K.canonical.y)),o.bQ(De,De,1/Ze),o.bS(De,De,o.bP(g[0],g[1])),De[0]=o.bT(De[0],-.5,.5),o.bQ(De,De,o.al);const He=o.bU(De[0],De[1],o.al/(2*Math.PI),1);o.aC(He,He,_),R=o.ak(R,He[0],ge),z=o.ak(z,He[1],ge),B=o.ak(B,He[2],ge)}const pe=this.projectAndGetPerspectiveRatio(N,R,z,B,d.tileID,ne.name==="globe"||!!H||this.transform.pitch>0,ne),_e=k*pe.perspectiveRatio,me=(d.x1*a+T.x-d.padding)*_e+pe.point.x,fe=(d.y1*a+T.y-d.padding)*_e+pe.point.y,ye=(d.x2*a+T.x+d.padding)*_e+pe.point.x,Fe=(d.y2*a+T.y+d.padding)*_e+pe.point.y,Pe=pe.perspectiveRatio<=.55||pe.occluded;return!this.isInsideGrid(me,fe,ye,Fe)||!I&&this.grid.hitTest(me,fe,ye,Fe,j)||Pe?{box:[],offscreen:!1,occluded:pe.occluded}:{box:[me,fe,ye,Fe],offscreen:this.isOffscreen(me,fe,ye,Fe),occluded:!1}}placeCollisionCircles(t,a,d,g,_,b,T,I,k,N,j,R,z,B,U){const Y=[],H=this.transform.elevation,K=t.getProjection(),ne=H?H.getAtTileOffsetFunc(U,this.transform.center.lat,this.transform.worldSize,K):null,ce=new o.P(d.tileAnchorX,d.tileAnchorY);let{x:ge,y:pe,z:_e}=K.projectTilePoint(ce.x,ce.y,U.canonical);if(ne){const[nt,gt,Et]=ne(ce);ge+=nt,pe+=gt,_e+=Et}const me=K.name==="globe",fe=this.projectAndGetPerspectiveRatio(T,ge,pe,_e,U,me||!!H||this.transform.pitch>0,K),{perspectiveRatio:ye}=fe,Fe=(j?b/ye:b*ye)/o.bX,Pe=Zs(ge,pe,_e,I),Ze=d.lineOffsetX*Fe,De=d.lineOffsetY*Fe,He=o.an(t.layers[0].layout.get("text-max-angle")),_t=Math.cos(He),ze=fe.signedDistanceFromCamera>0?wh(Fe,_,Ze,De,!1,Pe,ce,d,g,I,{},H&&!j?ne:null,j&&!!H,K,U,j,_t):null;let Ie=!1,Ye=!1,Ue=!0;if(ze&&!fe.occluded){const nt=.5*z*ye+B,gt=new o.P(-100,-100),Et=new o.P(this.screenRightBoundary,this.screenBottomBoundary),dt=new J_,{first:lt,last:Ft}=ze,Dt=lt.path.length;let zt=[];for(let gr=Dt-1;gr>=1;gr--)zt.push(lt.path[gr]);for(let gr=1;gr<Ft.path.length;gr++)zt.push(Ft.path[gr]);const Ot=2.5*nt;k&&(zt=zt.map(([gr,br,ii],lr)=>(ne&&!me&&(ii=ne(lr<Dt-1?lt.tilePath[Dt-1-lr]:Ft.tilePath[lr-Dt+2])[2]),Zs(gr,br,ii,k))),zt.some(gr=>gr[3]<=0)&&(zt=[]));let nr=[];if(zt.length>0){let gr=1/0,br=-1/0,ii=1/0,lr=-1/0;for(const qr of zt)gr=Math.min(gr,qr[0]),ii=Math.min(ii,qr[1]),br=Math.max(br,qr[0]),lr=Math.max(lr,qr[1]);br>=gt.x&&gr<=Et.x&&lr>=gt.y&&ii<=Et.y&&(nr=[zt.map(qr=>new o.P(qr[0],qr[1]))],(gr<gt.x||br>Et.x||ii<gt.y||lr>Et.y)&&(nr=o.bV(nr,gt.x,gt.y,Et.x,Et.y)))}for(const gr of nr){dt.reset(gr,.25*nt);let br=0;br=dt.length<=.5*nt?1:Math.ceil(dt.paddedLength/Ot)+1;for(let ii=0;ii<br;ii++){const lr=ii/Math.max(br-1,1),qr=dt.lerp(lr),ei=qr.x+Ys,Ii=qr.y+Ys;Y.push(ei,Ii,nt,0);const _r=ei-nt,Xr=Ii-nt,Wr=ei+nt,Jr=Ii+nt;if(Ue=Ue&&this.isOffscreen(_r,Xr,Wr,Jr),Ye=Ye||this.isInsideGrid(_r,Xr,Wr,Jr),!a&&this.grid.hitTestCircle(ei,Ii,nt,R)&&(Ie=!0,!N))return{circles:[],offscreen:!1,collisionDetected:Ie,occluded:!1}}}}return{circles:!N&&Ie||!Ye?[]:Y,offscreen:Ue,collisionDetected:Ie,occluded:fe.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const a=[];let d=1/0,g=1/0,_=-1/0,b=-1/0;for(const N of t){const j=new o.P(N.x+Ys,N.y+Ys);d=Math.min(d,j.x),g=Math.min(g,j.y),_=Math.max(_,j.x),b=Math.max(b,j.y),a.push(j)}const T=this.grid.query(d,g,_,b).concat(this.ignoredGrid.query(d,g,_,b)),I={},k={};for(const N of T){const j=N.key;if(I[j.bucketInstanceId]===void 0&&(I[j.bucketInstanceId]={}),I[j.bucketInstanceId][j.featureIndex])continue;const R=[new o.P(N.x1,N.y1),new o.P(N.x2,N.y1),new o.P(N.x2,N.y2),new o.P(N.x1,N.y2)];o.bW(a,R)&&(I[j.bucketInstanceId][j.featureIndex]=!0,k[j.bucketInstanceId]===void 0&&(k[j.bucketInstanceId]=[]),k[j.bucketInstanceId].push(j.featureIndex))}return k}insertCollisionBox(t,a,d,g,_){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:d,featureIndex:g,collisionGroupID:_},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,a,d,g,_){const b=a?this.ignoredGrid:this.grid,T={bucketInstanceId:d,featureIndex:g,collisionGroupID:_};for(let I=0;I<t.length;I+=4)b.insertCircle(T,t[I],t[I+1],t[I+2])}projectAndGetPerspectiveRatio(t,a,d,g,_,b,T){const I=[a,d,g,1];let k=!1;g||this.transform.pitch>0?(o.aC(I,I,t),this.fogState&&_&&T.name!=="globe"&&(k=function(R,z,B,U,Y,H){const K=H.calculateFogTileMatrix(Y),ne=[z,B,U];return o.af(ne,ne,K),tr(R,o.ag(ne),H.pitch,H._fov)}(this.fogState,a,d,g,_.toUnwrapped(),this.transform)>.9)):Xp(I,I,t);const N=I[3];return{point:new o.P((I[0]/N+1)/2*this.transform.width+Ys,(-I[1]/N+1)/2*this.transform.height+Ys),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(T)/N*.5,1.5),signedDistanceFromCamera:N,occluded:b&&I[2]>N||k}}isOffscreen(t,a,d,g){return d<Ys||t>=this.screenRightBoundary||g<Ys||a>this.screenBottomBoundary}isInsideGrid(t,a,d,g){return d>=0&&t<this.gridRightBoundary&&g>=0&&a<this.gridBottomBoundary}getViewportMatrix(){const t=o.bA([]);return o.br(t,t,[-100,-100,0]),t}}class Th{constructor(t,a,d,g){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?a:-a))):g&&d?1:0,this.placed=d}isHidden(){return this.opacity===0&&!this.placed}}class ea{constructor(t,a,d,g,_,b=!1){this.text=new Th(t?t.text:null,a,d,_),this.icon=new Th(t?t.icon:null,a,g,_),this.clipped=b}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Vt{constructor(t,a,d,g=!1){this.text=t,this.icon=a,this.skipFade=d,this.clipped=g}}class ri{constructor(){this.invProjMatrix=o.bC(),this.viewportMatrix=o.bC(),this.circles=[]}}class ai{constructor(t,a,d,g,_){this.bucketInstanceId=t,this.featureIndex=a,this.sourceLayerIndex=d,this.bucketIndex=g,this.tileID=_}}class Ns{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const a=++this.maxGroupID;this.collisionGroups[t]={ID:a,predicate:d=>d.collisionGroupID===a}}return this.collisionGroups[t]}}function Fl(h,t,a,d,g){const{horizontalAlign:_,verticalAlign:b}=o.c0(h),T=-(_-.5)*t,I=-(b-.5)*a,k=o.c1(h,d);return new o.P(T+k[0]*g,I+k[1]*g)}function Kr(h,t,a,d,g){const _=new o.P(h,t);return a&&_._rotate(d?g:-g),_}class Eh{constructor(t,a,d,g,_,b){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Ro(this.transform,_),this.buildingIndex=b,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=a,this.retainedQueryData={},this.collisionGroups=new Ns(d),this.collisionCircleArrays={},this.prevPlacement=g,g&&(g.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,a,d,g,_=1){const b=d.getBucket(a),T=d.latestFeatureIndex;if(!b||!T||a.fqid!==b.layerIds[0])return;const I=b.layers[0].layout,k=b.layers[0].paint,N=d.collisionBoxArray,j=Math.pow(2,this.transform.zoom-d.tileID.overscaledZ),R=d.tileSize/o.al,z=d.tileID.toUnwrapped();this.transform.setProjection(b.projection);const B=(U=d.tileID,Y=b.getProjection(),H=this.transform,Y.name===this.projection?H.calculateProjMatrix(U.toUnwrapped()):xh(H,Y,U));var U,Y,H;const K=I.get("text-pitch-alignment")==="map",ne=I.get("text-rotation-alignment")==="map";a.compileFilter(a.options);const ce=a.dynamicFilter(),ge=a.dynamicFilterNeedsFeature(),pe=this.transform.calculatePixelsToTileUnitsMatrix(d),_e=td(B,d.tileID.canonical,K,ne,this.transform,b.getProjection(),pe);let me=null;const fe=b.getProjection().createInversionMatrix(this.transform,d.tileID.canonical);if(K){const Ie=bh(B,d.tileID.canonical,K,ne,this.transform,b.getProjection(),pe);me=o.aB([],this.transform.labelPlaneMatrix,Ie)}let ye=null;ce&&d.latestFeatureIndex&&(ye={unwrappedTileID:z,dynamicFilter:ce,dynamicFilterNeedsFeature:ge}),this.retainedQueryData[b.bucketInstanceId]=new ai(b.bucketInstanceId,T,b.sourceLayerIndex,b.index,d.tileID);const[Fe,Pe]=b.layers[0].layout.get("text-size-scale-range"),Ze=o.aA(_,Fe,Pe),[De,He]=I.get("icon-size-scale-range"),_t=o.aA(_,De,He),ze={bucket:b,layout:I,paint:k,posMatrix:B,invMatrix:fe,mercatorCenter:[o.aF(this.transform.center.lng),o.aJ(this.transform.center.lat)],textLabelPlaneMatrix:_e,labelToScreenMatrix:me,clippingData:ye,scale:j,textPixelRatio:R,holdingForFade:d.holdingForFade(),collisionBoxArray:N,partiallyEvaluatedTextSize:o.bK(b.textSizeData,this.transform.zoom,Ze),partiallyEvaluatedIconSize:o.bK(b.iconSizeData,this.transform.zoom,_t),collisionGroup:this.collisionGroups.get(b.sourceID),latestFeatureIndex:d.latestFeatureIndex};if(g)for(const Ie of b.sortKeyRanges){const{sortKey:Ye,symbolInstanceStart:Ue,symbolInstanceEnd:nt}=Ie;t.push({sortKey:Ye,symbolInstanceStart:Ue,symbolInstanceEnd:nt,parameters:ze})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:ze})}attemptAnchorPlacement(t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H,K,ne,ce,ge){const{textOffset0:pe,textOffset1:_e,crossTileID:me}=U,fe=[pe,_e],ye=Fl(t,b,T,fe,I),Fe=this.collisionIndex.placeCollisionBox(H,I,a,d,g,_,Kr(ye.x,ye.y,k,N,this.transform.angle),B,j,R,z.predicate);if(ne){const Pe=H.getSymbolInstanceIconSize(ge,this.transform.zoom,U.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(H,Pe,ne,d,g,_,Kr(ye.x,ye.y,k,N,this.transform.angle),B,j,R,z.predicate).box.length===0)return}if(Fe.box.length>0){let Pe;return this.prevPlacement&&this.prevPlacement.variableOffsets[me]&&this.prevPlacement.placements[me]&&this.prevPlacement.placements[me].text&&(Pe=this.prevPlacement.variableOffsets[me].anchor),this.variableOffsets[me]={textOffset:fe,width:b,height:T,anchor:t,textScale:I,prevAnchor:Pe},this.markUsedJustification(H,t,U,K),H.allowVerticalPlacement&&(this.markUsedOrientation(H,K,U),this.placedOrientations[me]=K),{shift:ye,placedGlyphBoxes:Fe}}}placeLayerBucketPart(t,a,d,g,_=1){const{bucket:b,layout:T,paint:I,posMatrix:k,textLabelPlaneMatrix:N,labelToScreenMatrix:j,clippingData:R,textPixelRatio:z,mercatorCenter:B,invMatrix:U,holdingForFade:Y,collisionBoxArray:H,partiallyEvaluatedTextSize:K,partiallyEvaluatedIconSize:ne,collisionGroup:ce,latestFeatureIndex:ge}=t.parameters,pe=T.get("text-optional"),_e=T.get("icon-optional"),me=T.get("text-allow-overlap"),fe=T.get("icon-allow-overlap"),ye=T.get("text-rotation-alignment")==="map",Fe=T.get("icon-rotation-alignment")==="map",Pe=T.get("text-pitch-alignment")==="map",Ze=I.get("symbol-z-offset"),De=T.get("symbol-elevation-reference")==="sea",He=T.get("symbol-placement"),[_t,ze]=T.get("text-size-scale-range"),[Ie,Ye]=T.get("icon-size-scale-range"),Ue=o.aA(_,_t,ze),nt=o.aA(_,Ie,Ye),gt=T.get("text-variable-anchor"),Et=ye&&He!=="point",dt=Fe&&He!=="point",lt=gt&&b.hasTextData(),Ft=b.hasIconTextFit()&&lt&&b.hasIconData();this.transform.setProjection(b.projection);const Dt=lt||Et,zt=dt||Ft;let Ot=me&&(fe||!b.hasIconData()||_e),nr=fe&&(me||!b.hasTextData()||pe);const gr=!Ze.isConstant();!b.collisionArrays&&H&&b.deserializeCollisionBoxes(H),d&&g&&b.updateCollisionDebugBuffers(this.transform.zoom,H,Ue,nt);const br=(lr,qr,ei)=>{const{crossTileID:Ii,numVerticalGlyphVertices:_r}=lr;let Xr=null;if(R&&R.dynamicFilterNeedsFeature||gr){const Xi=this.retainedQueryData[b.bucketInstanceId];Xr=ge.loadFeature({featureIndex:lr.featureIndex,bucketIndex:Xi.bucketIndex,sourceLayerIndex:Xi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(R&&!(0,R.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Xr,this.retainedQueryData[b.bucketInstanceId].tileID.canonical,new o.P(lr.tileAnchorX,lr.tileAnchorY),this.transform.calculateDistanceTileData(R.unwrappedTileID)))return this.placements[Ii]=new Vt(!1,!1,!1,!0),void a.add(Ii);const Wr=Ze.evaluate(Xr,{});if(a.has(Ii))return;if(Y)return void(this.placements[Ii]=new Vt(!1,!1,!1));let Jr=!1,Pi=!1,Ki=!0,An=!1,ki=!1,wr=null,Qt={box:null,offscreen:null,occluded:null},ni={box:null},Gi=null,Ri=null,sn=null,zn=0,eo=0,to=0;ei.textFeatureIndex?zn=ei.textFeatureIndex:lr.useRuntimeCollisionCircles&&(zn=lr.featureIndex),ei.verticalTextFeatureIndex&&(eo=ei.verticalTextFeatureIndex);const Ls=Xi=>{Xi.tileID=this.retainedQueryData[b.bucketInstanceId].tileID;const Ji=this.transform.elevation;Xi.elevation=De?Wr:Wr+(Ji?Ji.getAtTileOffset(Xi.tileID,Xi.tileAnchorX,Xi.tileAnchorY):0),Xi.elevation+=lr.zOffset},Os=ei.textBox;if(Os){Ls(Os);const Xi=Li=>{let mn=o.bL.horizontal;if(b.allowVerticalPlacement&&!Li&&this.prevPlacement){const Pn=this.prevPlacement.placedOrientations[Ii];Pn&&(this.placedOrientations[Ii]=Pn,mn=Pn,this.markUsedOrientation(b,mn,lr))}return mn},Ji=(Li,mn)=>{if(b.allowVerticalPlacement&&_r>0&&ei.verticalTextBox){for(const Pn of b.writingModes)if(Pn===o.bL.vertical?(Qt=mn(),ni=Qt):Qt=Li(),Qt&&Qt.box&&Qt.box.length)break}else Qt=Li()};if(gt){let Li=gt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Ii]){const en=this.prevPlacement.variableOffsets[Ii];Li.indexOf(en.anchor)>0&&(Li=Li.filter(Xn=>Xn!==en.anchor),Li.unshift(en.anchor))}const mn=(en,Xn,oa)=>{const Aa=b.getSymbolInstanceTextSize(K,lr,this.transform.zoom,qr),Bo=(en.x2-en.x1)*Aa+2*en.padding,gl=(en.y2-en.y1)*Aa+2*en.padding,_l=lr.hasIconTextFit&&!fe?Xn:null;_l&&Ls(_l);let aa={box:[],offscreen:!1,occluded:!1};const su=me?2*Li.length:Li.length;for(let Pa=0;Pa<su;++Pa){const la=this.attemptAnchorPlacement(Li[Pa%Li.length],en,B,U,Dt,Bo,gl,Aa,ye,Pe,z,k,ce,Pa>=Li.length,lr,qr,b,oa,_l,K,ne);if(la&&(aa=la.placedGlyphBoxes,aa&&aa.box&&aa.box.length)){Jr=!0,wr=la.shift;break}}return aa};Ji(()=>mn(Os,ei.iconBox,o.bL.horizontal),()=>{const en=ei.verticalTextBox;return en&&Ls(en),b.allowVerticalPlacement&&!(Qt&&Qt.box&&Qt.box.length)&&_r>0&&en?mn(en,ei.verticalIconBox,o.bL.vertical):{box:null,offscreen:null,occluded:null}}),Qt&&(Jr=Qt.box,Ki=Qt.offscreen,An=Qt.occluded);const Pn=Xi(!(!Qt||!Qt.box));if(!Jr&&this.prevPlacement){const en=this.prevPlacement.variableOffsets[Ii];en&&(this.variableOffsets[Ii]=en,this.markUsedJustification(b,en.anchor,lr,Pn))}}else{const Li=(mn,Pn)=>{const en=b.getSymbolInstanceTextSize(K,lr,this.transform.zoom,qr),Xn=this.collisionIndex.placeCollisionBox(b,en,mn,B,U,Dt,new o.P(0,0),me,z,k,ce.predicate);return Xn&&Xn.box&&Xn.box.length&&(this.markUsedOrientation(b,Pn,lr),this.placedOrientations[Ii]=Pn),Xn};Ji(()=>Li(Os,o.bL.horizontal),()=>{const mn=ei.verticalTextBox;return b.allowVerticalPlacement&&_r>0&&mn?(Ls(mn),Li(mn,o.bL.vertical)):{box:null,offscreen:null,occluded:null}}),Xi(!!(Qt&&Qt.box&&Qt.box.length))}}if(Gi=Qt,Jr=Gi&&Gi.box&&Gi.box.length>0,Ki=Gi&&Gi.offscreen,An=Gi&&Gi.occluded,lr.useRuntimeCollisionCircles){const Xi=b.text.placedSymbolArray.get(lr.centerJustifiedTextSymbolIndex>=0?lr.centerJustifiedTextSymbolIndex:lr.verticalPlacedTextSymbolIndex),Ji=o.bM(b.textSizeData,K,Xi),Li=T.get("text-padding");Ri=this.collisionIndex.placeCollisionCircles(b,me,Xi,b.lineVertexArray,b.glyphOffsetArray,Ji,k,N,j,d,Pe,ce.predicate,lr.collisionCircleDiameter*Ji/o.bX,Li,this.retainedQueryData[b.bucketInstanceId].tileID),Jr=me||Ri.circles.length>0&&!Ri.collisionDetected,Ki=Ki&&Ri.offscreen,An=Ri.occluded}if(ei.iconFeatureIndex&&(to=ei.iconFeatureIndex),ei.iconBox){const Xi=Ji=>{Ls(Ji);const Li=lr.hasIconTextFit&&wr?Kr(wr.x,wr.y,ye,Pe,this.transform.angle):new o.P(0,0),mn=b.getSymbolInstanceIconSize(ne,this.transform.zoom,lr.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(b,mn,Ji,B,U,zt,Li,fe,z,k,ce.predicate)};ni&&ni.box&&ni.box.length&&ei.verticalIconBox?(sn=Xi(ei.verticalIconBox),Pi=sn.box.length>0):(sn=Xi(ei.iconBox),Pi=sn.box.length>0),Ki=Ki&&sn.offscreen,ki=sn.occluded}const gs=pe||lr.numHorizontalGlyphVertices===0&&_r===0,_o=_e||lr.numIconVertices===0;if(gs||_o?_o?gs||(Pi=Pi&&Jr):Jr=Pi&&Jr:Pi=Jr=Pi&&Jr,Jr&&Gi&&Gi.box&&this.collisionIndex.insertCollisionBox(Gi.box,T.get("text-ignore-placement"),b.bucketInstanceId,ni&&ni.box&&eo?eo:zn,ce.ID),Pi&&sn&&this.collisionIndex.insertCollisionBox(sn.box,T.get("icon-ignore-placement"),b.bucketInstanceId,to,ce.ID),Ri&&(Jr&&this.collisionIndex.insertCollisionCircles(Ri.circles,T.get("text-ignore-placement"),b.bucketInstanceId,zn,ce.ID),d)){const Xi=b.bucketInstanceId;let Ji=this.collisionCircleArrays[Xi];Ji===void 0&&(Ji=this.collisionCircleArrays[Xi]=new ri);for(let Li=0;Li<Ri.circles.length;Li+=4)Ji.circles.push(Ri.circles[Li+0]),Ji.circles.push(Ri.circles[Li+1]),Ji.circles.push(Ri.circles[Li+2]),Ji.circles.push(Ri.collisionDetected?1:0)}const Fo=b.projection.name!=="globe";Ot=Ot&&(Fo||!An),nr=nr&&(Fo||!ki),this.placements[Ii]=new Vt(Jr||Ot,Pi||nr,Ki||b.justReloaded),a.add(Ii)},ii=this.retainedQueryData[b.bucketInstanceId].tileID;if(b.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(b,ii),b.elevationType==="road"&&b.updateRoadElevation(ii.canonical),b.updateZOffset(),b.sortFeaturesByY){const lr=b.getSortedSymbolIndexes(this.transform.angle);for(let qr=lr.length-1;qr>=0;--qr){const ei=lr[qr];br(b.symbolInstances.get(ei),ei,b.collisionArrays[ei])}b.hasAnyZOffset&&o.w(`${b.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(b.hasAnyZOffset){const lr=b.getSortedIndexesByZOffset();for(let qr=0;qr<lr.length;++qr){const ei=lr[qr];br(b.symbolInstances.get(ei),ei,b.collisionArrays[ei])}}else for(let lr=t.symbolInstanceStart;lr<t.symbolInstanceEnd;lr++)br(b.symbolInstances.get(lr),lr,b.collisionArrays[lr]);if(d&&b.bucketInstanceId in this.collisionCircleArrays){const lr=this.collisionCircleArrays[b.bucketInstanceId];o.bl(lr.invProjMatrix,k),lr.viewportMatrix=this.collisionIndex.getViewportMatrix()}b.justReloaded=!1}markUsedJustification(t,a,d,g){const{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:I,crossTileID:k}=d,N=o.c2(a),j=g===o.bL.vertical?I:N==="left"?_:N==="center"?b:N==="right"?T:-1;_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=j>=0&&_!==j?0:k),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=j>=0&&b!==j?0:k),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=j>=0&&T!==j?0:k),I>=0&&(t.text.placedSymbolArray.get(I).crossTileID=j>=0&&I!==j?0:k)}markUsedOrientation(t,a,d){const g=a===o.bL.horizontal||a===o.bL.horizontalOnly?a:0,_=a===o.bL.vertical?a:0,{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:T,rightJustifiedTextSymbolIndex:I,verticalPlacedTextSymbolIndex:k}=d,N=t.text.placedSymbolArray;b>=0&&(N.get(b).placedOrientation=g),T>=0&&(N.get(T).placedOrientation=g),I>=0&&(N.get(I).placedOrientation=g),k>=0&&(N.get(k).placedOrientation=_)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const a=this.prevPlacement;let d=!1;this.prevZoomAdjustment=a?a.zoomAdjustment(this.transform.zoom):0;const g=a?a.symbolFadeChange(t):1,_=a?a.opacities:{},b=a?a.variableOffsets:{},T=a?a.placedOrientations:{};for(const I in this.placements){const k=this.placements[I],N=_[I];N?(this.opacities[I]=new ea(N,g,k.text,k.icon,null,k.clipped),d=d||k.text!==N.text.placed||k.icon!==N.icon.placed):(this.opacities[I]=new ea(null,g,k.text,k.icon,k.skipFade,k.clipped),d=d||k.text||k.icon)}for(const I in _){const k=_[I];if(!this.opacities[I]){const N=new ea(k,g,!1,!1);N.isHidden()||(this.opacities[I]=N,d=d||k.text.placed||k.icon.placed)}}for(const I in b)this.variableOffsets[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.variableOffsets[I]=b[I]);for(const I in T)this.placedOrientations[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.placedOrientations[I]=T[I]);d?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=a?a.lastPlacementChangeTime:t)}updateLayerOpacities(t,a,d,g){const _=new Set;for(const b of a){const T=b.getBucket(t);T&&b.latestFeatureIndex&&t.fqid===T.layerIds[0]&&(this.updateBucketOpacities(T,_,b,b.collisionBoxArray,d,g,b.tileID,t.scope),T.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(T,b.tileID),T.elevationType==="road"&&T.updateRoadElevation(b.tileID.canonical),T.updateZOffset())}}updateBucketOpacities(t,a,d,g,_,b,T,I){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const k=t.layers[0].layout,N=t.layers[0].paint,j=!!t.layers[0].dynamicFilter(),R=new ea(null,0,!1,!1,!0),z=k.get("text-allow-overlap"),B=k.get("icon-allow-overlap"),U=k.get("text-variable-anchor"),Y=k.get("text-rotation-alignment")==="map",H=k.get("text-pitch-alignment")==="map",K=N.get("symbol-z-offset"),ne=k.get("symbol-elevation-reference")==="sea",ce=!K.isConstant(),ge=new ea(null,0,z&&(B||!t.hasIconData()||k.get("icon-optional")),B&&(z||!t.hasTextData()||k.get("text-optional")),!0);!t.collisionArrays&&g&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(g);const pe=(me,fe,ye)=>{for(let Fe=0;Fe<fe/4;Fe++)me.opacityVertexArray.emplaceBack(ye)};let _e=0;b&&t.updateReplacement(T,b);for(let me=0;me<t.symbolInstances.length;me++){const fe=t.symbolInstances.get(me),{numHorizontalGlyphVertices:ye,numVerticalGlyphVertices:Fe,crossTileID:Pe,numIconVertices:Ze,tileAnchorX:De,tileAnchorY:He}=fe;let _t=null;const ze=this.retainedQueryData[t.bucketInstanceId];ce&&fe&&ze&&(_t=d.latestFeatureIndex.loadFeature({featureIndex:fe.featureIndex,bucketIndex:ze.bucketIndex,sourceLayerIndex:ze.sourceLayerIndex,layoutVertexArrayOffset:0}));const Ie=K.evaluate(_t,{}),Ye=a.has(Pe);let Ue=this.opacities[Pe];Ye?Ue=R:Ue||(Ue=ge,this.opacities[Pe]=Ue),a.add(Pe);const nt=ye>0||Fe>0,gt=Ze>0,Et=this.placedOrientations[Pe],dt=Et===o.bL.vertical,lt=Et===o.bL.horizontal||Et===o.bL.horizontalOnly;!nt&&!gt||Ue.isHidden()||_e++;let Ft=!1;if((nt||gt)&&b)for(const Dt of t.activeReplacements){if(o.bY(Dt,_,o.bZ.Symbol,I)||Dt.min.x>De||De>Dt.max.x||Dt.min.y>He||He>Dt.max.y)continue;const zt=o.b_(De,He,T.canonical,Dt.footprintTileId.canonical);if(Ft=o.b$(zt,Dt.footprint),Ft)break}if(nt){const Dt=Ft?el:sd(Ue.text);pe(t.text,ye,dt?el:Dt),pe(t.text,Fe,lt?el:Dt);const zt=Ue.text.isHidden(),{leftJustifiedTextSymbolIndex:Ot,centerJustifiedTextSymbolIndex:nr,rightJustifiedTextSymbolIndex:gr,verticalPlacedTextSymbolIndex:br}=fe,ii=t.text.placedSymbolArray,lr=zt||dt?1:0;Ot>=0&&(ii.get(Ot).hidden=lr),nr>=0&&(ii.get(nr).hidden=lr),gr>=0&&(ii.get(gr).hidden=lr),br>=0&&(ii.get(br).hidden=zt||lt?1:0);const qr=this.variableOffsets[Pe];qr&&this.markUsedJustification(t,qr.anchor,fe,Et);const ei=this.placedOrientations[Pe];ei&&(this.markUsedJustification(t,"left",fe,ei),this.markUsedOrientation(t,ei,fe))}if(gt){const Dt=Ft?el:sd(Ue.icon),{placedIconSymbolIndex:zt,verticalPlacedIconSymbolIndex:Ot}=fe,nr=t.icon.placedSymbolArray,gr=Ue.icon.isHidden()?1:0;zt>=0&&(pe(t.icon,Ze,dt?el:Dt),nr.get(zt).hidden=gr),Ot>=0&&(pe(t.icon,fe.numVerticalIconVertices,lt?el:Dt),nr.get(Ot).hidden=gr)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Dt=t.collisionArrays[me];if(Dt){let zt=new o.P(0,0),Ot=!0;if(Dt.textBox||Dt.verticalTextBox){if(U){const gr=this.variableOffsets[Pe];gr?(zt=Fl(gr.anchor,gr.width,gr.height,gr.textOffset,gr.textScale),Y&&zt._rotate(H?this.transform.angle:-this.transform.angle)):Ot=!1}j&&(Ot=!Ue.clipped),Dt.textBox&&Qa(t.textCollisionBox.collisionVertexArray,Ue.text.placed,!Ot||dt,Ie,ne,zt.x,zt.y),Dt.verticalTextBox&&Qa(t.textCollisionBox.collisionVertexArray,Ue.text.placed,!Ot||lt,Ie,ne,zt.x,zt.y)}const nr=Ot&&!!(!lt&&Dt.verticalIconBox);Dt.iconBox&&Qa(t.iconCollisionBox.collisionVertexArray,Ue.icon.placed,nr,Ie,ne,fe.hasIconTextFit?zt.x:0,fe.hasIconTextFit?zt.y:0),Dt.verticalIconBox&&Qa(t.iconCollisionBox.collisionVertexArray,Ue.icon.placed,!nr,Ie,ne,fe.hasIconTextFit?zt.x:0,fe.hasIconTextFit?zt.y:0)}}}if(t.fullyClipped=_e===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const me=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=me.invProjMatrix,t.placementViewportMatrix=me.viewportMatrix,t.collisionCircleArray=me.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,a){const d=this.zoomAtLastRecencyCheck===a?1-this.zoomAdjustment(a):1;return this.zoomAtLastRecencyCheck=a,this.commitTime+this.fadeDuration*d>t}setStale(){this.stale=!0}}function Qa(h,t,a,d,g,_,b){h.emplaceBack(t?1:0,a?1:0,_||0,b||0,d,g?1:0),h.emplaceBack(t?1:0,a?1:0,_||0,b||0,d,g?1:0),h.emplaceBack(t?1:0,a?1:0,_||0,b||0,d,g?1:0),h.emplaceBack(t?1:0,a?1:0,_||0,b||0,d,g?1:0)}const rd=Math.pow(2,25),ns=Math.pow(2,24),fn=Math.pow(2,17),Vv=Math.pow(2,16),id=Math.pow(2,9),Yp=Math.pow(2,8),nd=Math.pow(2,1);function sd(h){if(h.opacity===0&&!h.placed)return 0;if(h.opacity===1&&h.placed)return 4294967295;const t=h.placed?1:0,a=Math.floor(127*h.opacity);return a*rd+t*ns+a*fn+t*Vv+a*id+t*Yp+a*nd+t}const el=0;class Ih{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,a,d,g,_,b){const T=this._bucketParts;for(;this._currentTileIndex<t.length;)if(a.getBucketParts(T,g,t[this._currentTileIndex],this._sortAcrossTiles,b),this._currentTileIndex++,_())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,T.sort((I,k)=>I.sortKey-k.sortKey));this._currentPartIndex<T.length;){const I=T[this._currentPartIndex];if(a.placeLayerBucketPart(I,this._seenCrossTileIDs,d,I.symbolInstanceStart===0,b),this._currentPartIndex++,_())return!0}return!1}}class fs{constructor(t,a,d,g,_,b,T,I,k){this.placement=new Eh(t,_,b,T,I,k),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=d,this._showCollisionBoxes=g,this._done=!1}isDone(){return this._done}continuePlacement(t,a,d,g,_){const b=o.o.now(),T=()=>{const I=o.o.now()-b;return!this._forceFullPlacement&&I>2};for(;this._currentPlacementIndex>=0;){const I=a[t[this._currentPlacementIndex]],k=this.placement.collisionIndex.transform.zoom;if(I.type==="symbol"&&(!I.minzoom||I.minzoom<=k)&&(!I.maxzoom||I.maxzoom>k)){const N=I,j=N.layout.get("symbol-z-elevate"),R=N.layout.get("symbol-sort-key").constantOr(1)!==void 0,z=N.layout.get("symbol-z-order"),B=z==="viewport-y"||z==="auto"&&!(z!=="viewport-y"&&R),U=N.layout.get("text-allow-overlap")||N.layout.get("icon-allow-overlap")||N.layout.get("text-ignore-placement")||N.layout.get("icon-ignore-placement"),Y=B&&U,H=this._inProgressLayer=this._inProgressLayer||new Ih(N),K=o.B(I.source,I.scope);if(H.continuePlacement(j||Y?g[K]:d[K],this.placement,this._showCollisionBoxes,I,T,_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Lo=512/o.al/2;class Is{constructor(t,a,d){this.tileID=t,this.bucketInstanceId=d,this.index=new o.c3(a.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const g=t.canonical.x*o.al,_=t.canonical.y*o.al;for(let b=0;b<a.length;b++){const{key:T,crossTileID:I,tileAnchorX:k,tileAnchorY:N}=a.get(b),j=Math.floor((g+k)*Lo),R=Math.floor((_+N)*Lo);this.index.add(j,R),this.keys.push(T),this.crossTileIDs.push(I)}this.index.finish()}findMatches(t,a,d){const g=this.tileID.canonical.z<a.canonical.z?1:Math.pow(2,this.tileID.canonical.z-a.canonical.z),_=Lo/Math.pow(2,a.canonical.z-this.tileID.canonical.z),b=a.canonical.x*o.al,T=a.canonical.y*o.al;for(let I=0;I<t.length;I++){const k=t.get(I);if(k.crossTileID)continue;const{key:N,tileAnchorX:j,tileAnchorY:R}=k,z=Math.floor((b+j)*_),B=Math.floor((T+R)*_),U=this.index.range(z-g,B-g,z+g,B+g).sort((Y,H)=>Y-H);for(const Y of U){const H=this.crossTileIDs[Y];if(this.keys[Y]===N&&!d.has(H)){d.add(H),k.crossTileID=H;break}}}}}class e0{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Rc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const a=Math.round((t-this.lng)/360);if(a!==0)for(const d in this.indexes){const g=this.indexes[d],_={};for(const b in g){const T=g[b];T.tileID=T.tileID.unwrapTo(T.tileID.wrap+a),_[T.tileID.key]=T}this.indexes[d]=_}this.lng=t}addBucket(t,a,d){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===a.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let _=0;_<a.symbolInstances.length;_++)a.symbolInstances.get(_).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const g=this.usedCrossTileIDs[t.overscaledZ];for(const _ in this.indexes){const b=this.indexes[_];if(Number(_)>t.overscaledZ)for(const T in b){const I=b[T];I.tileID.isChildOf(t)&&I.findMatches(a.symbolInstances,t,g)}else{const T=b[t.scaledTo(Number(_)).key];T&&T.findMatches(a.symbolInstances,t,g)}}for(let _=0;_<a.symbolInstances.length;_++){const b=a.symbolInstances.get(_);b.crossTileID||(b.crossTileID=d.generate(),g.add(b.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Is(t,a.symbolInstances,a.bucketInstanceId),!0}removeBucketCrossTileIDs(t,a){for(const d of a.crossTileIDs)this.usedCrossTileIDs[t].delete(d)}removeStaleBuckets(t){let a=!1;for(const d in this.indexes){const g=this.indexes[d];for(const _ in g)t[g[_].bucketInstanceId]||(this.removeBucketCrossTileIDs(d,g[_]),delete g[_],a=!0)}return a}}class Cn{constructor(){this.layerIndexes={},this.crossTileIDs=new e0,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,a,d,g){let _=this.layerIndexes[t.fqid];_===void 0&&(_=this.layerIndexes[t.fqid]=new Rc);let b=!1;const T={};g.name!=="globe"&&_.handleWrapJump(d);for(const I of a){const k=I.getBucket(t);k&&t.fqid===k.layerIds[0]&&(k.bucketInstanceId||(k.bucketInstanceId=++this.maxBucketInstanceId),_.addBucket(I.tileID,k,this.crossTileIDs)&&(b=!0),T[k.bucketInstanceId]=!0)}return _.removeStaleBuckets(T)&&(b=!0),b}pruneUnusedLayers(t){const a={};t.forEach(d=>{a[d]=!0});for(const d in this.layerIndexes)a[d]||delete this.layerIndexes[d]}}const Cs=771;class vr{constructor(t,a,d,g){this.blendFunction=t,this.blendColor=a.toNonPremultipliedRenderColor(null),this.mask=d,this.blendEquation=g}}vr.Replace=[1,0,1,0],vr.disabled=new vr(vr.Replace,o.ao.transparent,[!1,!1,!1,!1]),vr.unblended=new vr(vr.Replace,o.ao.transparent,[!0,!0,!0,!0]),vr.alphaBlended=new vr([1,Cs,1,Cs],o.ao.transparent,[!0,!0,!0,!0]),vr.alphaBlendedNonPremultiplied=new vr([770,Cs,770,Cs],o.ao.transparent,[!0,!0,!0,!0]),vr.multiply=new vr([774,0,774,0],o.ao.transparent,[!0,!0,!0,!0]);class At{constructor(t,a,d){this.func=t,this.mask=a,this.range=d}}At.ReadOnly=!1,At.ReadWrite=!0,At.disabled=new At(519,At.ReadOnly,[0,1]);const od=7680;class Jt{constructor(t,a,d,g,_,b){this.test=t,this.ref=a,this.mask=d,this.fail=g,this.depthFail=_,this.pass=b}}Jt.disabled=new Jt({func:519,mask:0},0,0,od,od,od);const Bl=1029,Lc=2305;class ir{constructor(t,a,d){this.enable=t,this.mode=a,this.frontFace=d}}function Kp(h,t){const a=o.c9(h,3);o.cb(h,t),o.cf(h,3,a)}function ad(h,t){const a=o.c6([]);return o.c7(a,a,-t),o.c8(a,a,-h),a}function ld(h,t){const a=[h[0],h[1],0],d=[t[0],t[1],0];if(o.ag(a)>=1e-15){const b=o.aw([],a);o.c4(d,b,o.bJ(d,b)),t[0]=d[0],t[1]=d[1]}const g=o.bI([],t,h);if(o.c5(g)<1e-15)return null;const _=Math.atan2(-g[1],g[0]);return ad(Math.atan2(Math.sqrt(h[0]*h[0]+h[1]*h[1]),-h[2]),_)}ir.disabled=new ir(!1,Bl,Lc),ir.backCCW=new ir(!0,Bl,Lc),ir.backCW=new ir(!0,Bl,2304),ir.frontCW=new ir(!0,1028,2304),ir.frontCCW=new ir(!0,1028,Lc);class Jp{constructor(t,a){this.position=t,this.orientation=a}get position(){return this._position}set position(t){if(t){const a=t instanceof o.ae?t:new o.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(a.x=o.bT(a.x,0,1)),this._position=a}else this._position=null}lookAtPoint(t,a){if(this.orientation=null,!this.position)return;const d=this.position,g=this._elevation?this._elevation.getAtPointOrZero(o.ae.fromLngLat(t)):0,_=o.ae.fromLngLat(t,g),b=[_.x-d.x,_.y-d.y,_.z-d.z];a||(a=[0,0,1]),a[2]=Math.abs(a[2]),this.orientation=ld(b,a)}setPitchBearing(t,a){this.orientation=ad(o.an(t),o.an(-a))}}class Ch{constructor(t,a){this._transform=o.bA([]),this.orientation=a,this.position=t}get mercatorPosition(){const t=this.position;return new o.ae(t[0],t[1],t[2])}get position(){const t=o.c9(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var a;t&&o.cf(this._transform,3,[(a=t)[0],a[1],a[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||o.c6([]),t&&Kp(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),a=this.right();return{bearing:Math.atan2(-a[1],a[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,a){this._orientation=ad(t,a),Kp(this._transform,this._orientation)}forward(){const t=o.c9(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=o.c9(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=o.c9(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,a){const d=new Float64Array(16);return o.bl(d,this.getWorldToCamera(t,a)),d}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,a,d){const g=this.position;o.c4(g,g,-t);const _=new Float64Array(16);return o.bq(_,[d,d,d]),o.br(_,_,g),_[10]*=a,_}getWorldToCamera(t,a){const d=new Float64Array(16),g=new Float64Array(4),_=this.position;return o.ca(g,this._orientation),o.c4(_,_,-t),o.cb(d,g),o.br(d,d,_),d[1]*=-1,d[5]*=-1,d[9]*=-1,d[13]*=-1,d[8]*=a,d[9]*=a,d[10]*=a,d[11]*=a,d}getCameraToClipPerspective(t,a,d,g){const _=new Float64Array(16);return o.cc(_,t,a,d,g),_}getCameraToClipOrthographic(t,a,d,g,_,b){const T=new Float64Array(16);return o.cd(T,t,a,d,g,_,b),T}getDistanceToElevation(t,a=!1){const d=t===0?0:o.ce(t,a?o.a$(this.position[1]):this.position[1]),g=this.forward();return(d-this.position[2])/g[2]}clone(){return new Ch([...this.position],[...this.orientation])}}const nn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Qp{constructor(t=0,a=0,d=0,g=0){if(isNaN(t)||t<0||isNaN(a)||a<0||isNaN(d)||d<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=a,this.left=d,this.right=g}interpolate(t,a,d){return a.top!=null&&t.top!=null&&(this.top=o.ak(t.top,a.top,d)),a.bottom!=null&&t.bottom!=null&&(this.bottom=o.ak(t.bottom,a.bottom,d)),a.left!=null&&t.left!=null&&(this.left=o.ak(t.left,a.left,d)),a.right!=null&&t.right!=null&&(this.right=o.ak(t.right,a.right,d)),this}getCenter(t,a){const d=o.aA((this.left+t-this.right)/2,0,t),g=o.aA((this.top+a-this.bottom)/2,0,a);return new o.P(d,g)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Qp(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Sa=15;class ps{constructor(t,a,d,g,_,b,T){this.tileSize=512,this._renderWorldCopies=_===void 0||_,this._minZoom=t||0,this._maxZoom=a||22,this._minPitch=d??0,this._maxPitch=g??60,this.setProjection(b),this.setMaxBounds(T),this.width=0,this.height=0,this._center=new o.aR(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Qp,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ch,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new ps(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Sa}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,a=!1){const d=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||d)&&this._updateCameraOnTerrain(),(t||d)&&this._constrainCamera(a),this._calcMatrices()}getProjection(){return o.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const a=this.projection?this.getProjection():void 0;this.projection=o.cl(this.projectionOptions);const d=this.getProjection(),g=!o.by(a,d);return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.cl({name:"mercator"});const a=t!==this.projection.name;return a&&this._calcMatrices(),a}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this.width,this.height)}get bearing(){return o.bT(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const a=-t*Math.PI/180;this.angle!==a&&(this._unmodified=!1,this.angle=a,this._calcMatrices(),this.rotationMatrix=o.cm(),o.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const a=o.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==a&&(this._unmodified=!1,this._pitch=a,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=o.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const a=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==a&&(this._unmodified=!1,this._setZoom(a),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,a=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!a||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const d=this._elevation;a||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&d.exaggeration()&&this._centerAltitudeValidForExaggeration!==d.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*d.exaggeration(),this._centerAltitudeValidForExaggeration=d.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=d.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,a=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],d=this.horizonLineFromTop();let g=0,_=0;for(let b=0;b<a.length;b++){const T=new o.P(a[b][0]*this.width,d+a[b][1]*(this.height-d)),I=t.pointCoordinate(T);if(!I)continue;const k=1/Math.hypot(I[0]-this._camera.position[0],I[1]-this._camera.position[1]);g+=I[3]*k,_+=k}return _===0?NaN:g/_}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,a=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),d=this.pixelsPerMeter/this.worldSize*a,g=this._mercatorZfromZoom(t),_=this._mercatorZfromZoom(this._maxZoom),b=Math.max(g-d,_);this._setZoom(this._zoomFromMercatorZ(b))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const a=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let d;d=t.z<this._camera.position[2]?[a.x,a.y,a.z]:[t.x,t.y,t.z];const g=o.ag(o.av([],this._camera.position,d));return o.aA(this._zoomFromMercatorZ(g),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let a=!1;if(t.orientation&&!o.co(t.orientation,this._camera.orientation)&&(a=this._setCameraOrientation(t.orientation)),t.position){const d=[t.position.x,t.position.y,t.position.z];o.cp(d,this._camera.position)||(this._setCameraPosition(d),a=!0)}a&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,a=new Jp;return a.position=new o.ae(t[0],t[1],t[2]),a.orientation=this._camera.orientation,a._elevation=this.elevation,a._renderWorldCopies=this.renderWorldCopies,a}_setCameraOrientation(t){if(!o.cq(t))return!1;o.cr(t,t);const a=o.cs([],[0,0,-1],t),d=o.cs([],[0,-1,0],t);if(d[2]<0)return!1;const g=ld(a,d);return!!g&&(this._camera.orientation=g,!0)}_setCameraPosition(t){const a=this.zoomScale(this.minZoom)*this.tileSize,d=this.zoomScale(this.maxZoom)*this.tileSize,g=this.cameraToCenterDistance;t[2]=o.aA(t[2],g/d,g/a),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,a,d){this._unmodified=!1,this._edgeInsets.interpolate(t,a,d),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const a=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,a)}getVisibleUnwrappedCoordinates(t){const a=[new o.ct(0,t)];if(this.renderWorldCopies){const d=this.pointCoordinate(new o.P(0,0)),g=this.pointCoordinate(new o.P(this.width,0)),_=this.pointCoordinate(new o.P(this.width,this.height)),b=this.pointCoordinate(new o.P(0,this.height)),T=Math.floor(Math.min(d.x,g.x,_.x,b.x)),I=Math.floor(Math.max(d.x,g.x,_.x,b.x)),k=1;for(let N=T-k;N<=I+k;N++)N!==0&&a.push(new o.ct(N,t))}return a}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,a,d){let g=[];const _=d!=null,b=!_;if(b&&this.zoom<a||_&&d[0]===0&&d[1]===0)return g;const T=new Set,I=(N,j,R,z,B)=>{const U=o.cX(j,N,R,z,B);T.has(U)||(g.push(new o.aO(N,j,R,z,B)),T.add(U))};for(let N=0;N<t.length;N++){const j=t[N];if(b&&j.canonical.z!==a)continue;const R=j.canonical,z=j.overscaledZ,B=j.wrap,U=1<<R.z,Y=R.x+1<U,H=R.x>0,K=R.y+1<U,ne=R.y>0,ce=j.wrap-(H?0:1),ge=j.wrap+(Y?0:1),pe=H?R.x-1:U-1,_e=Y?R.x+1:0;if(_)d[0]<0?(I(z,ge,R.z,_e,R.y),d[1]<0&&K&&(I(z,B,R.z,R.x,R.y+1),I(z,ge,R.z,_e,R.y+1)),d[1]>0&&ne&&(I(z,B,R.z,R.x,R.y-1),I(z,ge,R.z,_e,R.y-1))):d[0]>0?(I(z,ce,R.z,pe,R.y),d[1]<0&&K&&(I(z,B,R.z,R.x,R.y+1),I(z,ce,R.z,pe,R.y+1)),d[1]>0&&ne&&(I(z,B,R.z,R.x,R.y-1),I(z,ce,R.z,pe,R.y-1))):d[1]<0&&K?I(z,B,R.z,R.x,R.y+1):ne&&I(z,B,R.z,R.x,R.y-1);else{const me=j.visibleQuadrants;1&me&&(I(z,ce,R.z,pe,R.y),ne&&(I(z,B,R.z,R.x,R.y-1),I(z,ce,R.z,pe,R.y-1))),2&me&&(I(z,ge,R.z,_e,R.y),ne&&(I(z,B,R.z,R.x,R.y-1),I(z,ge,R.z,_e,R.y-1))),4&me&&(I(z,ce,R.z,pe,R.y),K&&(I(z,B,R.z,R.x,R.y+1),I(z,ce,R.z,pe,R.y+1))),8&me&&(I(z,ge,R.z,_e,R.y),K&&(I(z,B,R.z,R.x,R.y+1),I(z,ge,R.z,_e,R.y+1)))}}const k=[];for(const N of g)g.some(j=>N.isChildOf(j))||k.push(N);if(g=k.filter(N=>!t.some(j=>!!(N.overscaledZ<a&&j.isChildOf(N))||N.equals(j)||N.isChildOf(j))),b){const N=1<<a,j=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),R=[N*j.x,N*j.y],z=4,B=z*z;g=g.filter(U=>{const Y=U.canonical.x+.5-R[0],H=U.canonical.y+.5-R[1];return Y*Y+H*H<B})}return g}extendTileCoverToNearPlane(t,a,d){const g=[],_=new Set;for(const K of t)_.add(K.key);const b=(K,ne,ce,ge,pe)=>{const _e=o.cX(ne,K,ce,ge,pe);_.has(_e)||(g.push(new o.aO(K,ne,ce,ge,pe)),_.add(_e))},T=t.reduce((K,ne)=>Math.max(K,ne.overscaledZ),d),I=1<<d,k=[new o.P(0,0),new o.P(o.al,0),new o.P(o.al,o.al),new o.P(0,o.al)],N=new o.P(0,0),j=new o.P(0,0),R=(K,ne)=>{const ce=Math.floor(K[0]),ge=Math.floor(K[1]),pe=(K[0]-ce)*o.al,_e=(K[1]-ge)*o.al,me=Math.floor(ne[0]),fe=Math.floor(ne[1]),ye=(ne[0]-me)*o.al,Fe=(ne[1]-fe)*o.al;for(let Pe=-1;Pe<=1;Pe++){const Ze=ce+Pe;if(!(Ze<0||Ze>=I)){N.x=pe-Pe*o.al,j.x=ye-(Ze-me)*o.al;for(let De=-1;De<=1;De++){const He=ge+De;N.y=_e-De*o.al,j.y=Fe-(He-fe)*o.al,o.cY(N,j,k)&&b(T,0,d,Ze,He)}}}},z=a.points,B=z[o.cu],U=z[o.cv],Y=this._projectToGround(B,z[o.cw]),H=this._projectToGround(U,z[o.cx]);return R(B,Y),R(U,H),g}_projectToGround(t,a){return o.cy(o.cz(),t,a,t[2]/(t[2]-a[2]))}coveringTiles(t){let a=this.coveringZoomLevel(t);const d=a,g=this.elevation&&this.elevation.exaggeration(),_=g&&!t.isTerrainDEM,b=this.projection.name==="mercator";if(t.minzoom!==void 0&&a<t.minzoom)return[];t.maxzoom!==void 0&&a>t.maxzoom&&(a=t.maxzoom);const T=this.locationCoordinate(this.center),I=this.center.lat,k=1<<a,N=[k*T.x,k*T.y,0],j=this.projection.name==="globe",R=!j,z=o.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,R),B=j?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),U=k*o.ce(1,this.center.lat),Y=this._camera.position[2]/o.ce(1,this.center.lat),H=[k*B.x,k*B.y,Y*(R?1:U)],K=j||g,ne=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),ce=this.isLODDisabled(!0)?a:0;let ge;if(this._elevation&&t.isTerrainDEM)ge=1e4*this._elevation.exaggeration();else if(this._elevation){const Ie=this._elevation.getMinMaxForVisibleTiles();ge=Ie?Ie.max:this._centerAltitude}else ge=this._centerAltitude;const pe=t.isTerrainDEM?-ge:this._elevation?this._elevation.getMinElevationBelowMSL():0,_e=this.projection.isReprojectedInTileSpace?o.cB(this):1,me=Ie=>{const Ue=new o.ae(Ie.x+25e-6,Ie.y,Ie.z),nt=new o.ae(Ie.x,Ie.y+25e-6,Ie.z),gt=Ie.toLngLat(),Et=Ue.toLngLat(),dt=nt.toLngLat(),lt=this.locationCoordinate(gt),Ft=this.locationCoordinate(Et),Dt=this.locationCoordinate(dt),zt=Math.hypot(Ft.x-lt.x,Ft.y-lt.y),Ot=Math.hypot(Dt.x-lt.x,Dt.y-lt.y);return Math.sqrt(zt*Ot)*_e/25e-6},fe=Ie=>{const Ye=ge,Ue=pe;return{aabb:o.cE(this,k,0,0,0,Ie,Ue,Ye,this.projection),zoom:0,x:0,y:0,minZ:Ue,maxZ:Ye,wrap:Ie,fullyVisible:!1}},ye=[];let Fe=[];const Pe=a,Ze=t.reparseOverscaled?d:a,De=(Y-this._centerAltitude)*U,He=Ie=>{if(!this._elevation||!Ie.tileID||!b)return;const Ye=this._elevation.getMinMaxForTile(Ie.tileID),Ue=Ie.aabb;Ye?(Ue.min[2]=Ye.min,Ue.max[2]=Ye.max,Ue.center[2]=(Ue.min[2]+Ue.max[2])/2):(Ie.shouldSplit=ze(Ie),Ie.shouldSplit||(Ue.min[2]=Ue.max[2]=Ue.center[2]=this._centerAltitude))},_t=(Ie,Ye)=>{if(.707*Ye<Ie)return 1;const Ue=Ye/Ie;return Ue/(1.4144271570014144+(Math.pow(1.1,Ue-1.4144271570014144+1)-1)/(1.1-1)-1)},ze=Ie=>{if(Ie.zoom<ce)return!0;if(Ie.zoom===Pe)return!1;if(Ie.shouldSplit!=null)return Ie.shouldSplit;const Ye=Ie.aabb.distanceX(H),Ue=Ie.aabb.distanceY(H);let nt=De,gt=1;if(j){nt=Ie.aabb.distanceZ(H);const Ot=Math.pow(2,Ie.zoom),nr=o.a$((Ie.y+1)/Ot),gr=o.a$(Ie.y/Ot),br=Math.min(Math.max(I,nr),gr),ii=o.d0(br)/o.d0(I);if(gt=br===I?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,ii/this._mercatorScaleRatio),this.zoom<=o.cZ&&Ie.zoom===Pe-1&&ii>=.9)return!0}else if(_&&(nt=Ie.aabb.distanceZ(H)*U),this.projection.isReprojectedInTileSpace&&d<=5){const Ot=Math.pow(2,Ie.zoom),nr=me(new o.ae((Ie.x+.5)/Ot,(Ie.y+.5)/Ot));gt=nr>.85?1:nr}if(!b){const Ot=Math.sqrt(Ye*Ye+Ue*Ue+nt*nt);let nr=(1<<Pe-Ie.zoom)*ne*gt;return nr*=_t(Math.max(nt,De),Ot),Ot<nr}let Et=Number.MAX_VALUE,dt=0;const lt=Ie.aabb.getCorners(),Ft=[];for(const Ot of lt){o.av(Ft,Ot,H),j||(_?Ft[2]*=U:Ft[2]=De);const nr=o.bJ(Ft,this._camera.forward());nr<Et&&(Et=nr,dt=Math.abs(Ft[2]))}let Dt=(1<<Pe-Ie.zoom)*ne*gt;if(Dt*=_t(Math.max(dt,De),Et),Et<Dt)return!0;const zt=Ie.aabb.closestPoint(N);return zt[0]===N[0]&&zt[1]===N[1]};if(this.renderWorldCopies)for(let Ie=1;Ie<=3;Ie++)ye.push(fe(-Ie)),ye.push(fe(Ie));for(ye.push(fe(0));ye.length>0;){const Ie=ye.pop(),Ye=Ie.x,Ue=Ie.y;let nt=Ie.fullyVisible;const gt=()=>this.projection.name==="globe"&&(Ie.y===0||Ie.y===(1<<Ie.zoom)-1);if(!nt){let Et=K?Ie.aabb.intersects(z):Ie.aabb.intersectsFlat(z);if(Et===0&&gt()){const dt=new o.cC(Ie.zoom,Ye,Ue);Et=o.cD(this,k,dt,!0).intersects(z)}if(Et===0)continue;nt=Et===2}if(Ie.zoom!==Pe&&ze(Ie))for(let Et=0;Et<4;Et++){const dt=(Ye<<1)+Et%2,lt=(Ue<<1)+(Et>>1),Ft={aabb:b?Ie.aabb.quadrant(Et):o.cE(this,k,Ie.zoom+1,dt,lt,Ie.wrap,Ie.minZ,Ie.maxZ,this.projection),zoom:Ie.zoom+1,x:dt,y:lt,wrap:Ie.wrap,fullyVisible:nt,tileID:void 0,shouldSplit:void 0,minZ:Ie.minZ,maxZ:Ie.maxZ};_&&!j&&(Ft.tileID=new o.aO(Ie.zoom+1===Pe?Ze:Ie.zoom+1,Ie.wrap,Ie.zoom+1,dt,lt),He(Ft)),ye.push(Ft)}else{const Et=Ie.zoom===Pe?Ze:Ie.zoom;if(t.minzoom&&t.minzoom>Et)continue;let dt=0;if(!nt){let zt=K?Ie.aabb.intersectsPrecise(z):Ie.aabb.intersectsPreciseFlat(z);if(zt===0&&gt()){const Ot=new o.cC(Ie.zoom,Ye,Ue);zt=o.cD(this,k,Ot,!0).intersectsPrecise(z)}if(zt===0)continue;if(t.calculateQuadrantVisibility)if(z.containsPoint(Ie.aabb.center))dt=15;else for(let Ot=0;Ot<4;Ot++)Ie.aabb.quadrant(Ot).intersects(z)!==0&&(dt|=1<<Ot)}const lt=N[0]-(.5+Ye+(Ie.wrap<<Ie.zoom))*(1<<a-Ie.zoom),Ft=N[1]-.5-Ue,Dt=Ie.tileID?Ie.tileID:new o.aO(Et,Ie.wrap,Ie.zoom,Ye,Ue);t.calculateQuadrantVisibility&&(Dt.visibleQuadrants=dt),Fe.push({tileID:Dt,distanceSq:lt*lt+Ft*Ft})}}if(this.fogCullDistSq){const Ie=this.fogCullDistSq,Ye=this.horizonLineFromTop();Fe=Fe.filter(Ue=>{const nt=[0,0,0,1],gt=[o.al,o.al,0,1],Et=this.calculateFogTileMatrix(Ue.tileID.toUnwrapped());o.aC(nt,nt,Et),o.aC(gt,gt,Et);const dt=o.cF([],nt,gt),lt=o.cG([],nt,gt),Ft=o.c_(dt,lt);if(Ft===0)return!0;let Dt=!1;const zt=this._elevation;if(zt&&Ft>Ie&&Ye!==0){const Ot=this.calculateProjMatrix(Ue.tileID.toUnwrapped());let nr;t.isTerrainDEM||(nr=zt.getMinMaxForTile(Ue.tileID)),nr||(nr={min:pe,max:ge});const gr=o.cH(this.rotation),br=[gr[0]*o.al,gr[1]*o.al,nr.max];o.af(br,br,Ot),Dt=(1-br[1])*this.height*.5<Ye}return Ft<Ie||Dt})}return Fe.sort((Ie,Ye)=>Ie.distanceSq-Ye.distanceSq).map(Ie=>Ie.tileID)}resize(t,a){this.width=t,this.height=a,this.pixelsToGLUnits=[2/t,-2/a],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log2(t)}project(t){const a=o.aA(t.lat,-o.cI,o.cI),d=this.projection.project(t.lng,a);return new o.P(d.x*this.worldSize,d.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/o.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,a){let d,g;const _=this.centerPoint;if(this.projection.name==="globe"){const T=this.worldSize;d=(a.x-_.x)/T,g=(a.y-_.y)/T}else{const T=this.pointCoordinate(a),I=this.pointCoordinate(_);d=T.x-I.x,g=T.y-I.y}const b=this.locationCoordinate(t);this.setLocation(new o.ae(b.x-d,b.y-g))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,a){return this.projection.locationPoint(this,t,a)}locationPoint3D(t,a){return this.projection.locationPoint(this,t,a,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,a){return this.coordinateLocation(this.pointCoordinate3D(t,a))}locationCoordinate(t,a){const d=a?o.ce(a,t.lat):void 0,g=this.projection.project(t.lng,t.lat);return new o.ae(g.x,g.y,d)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,a){const d=a??this._centerAltitude,g=[t.x,t.y,0,1],_=[t.x,t.y,1,1];o.aC(g,g,this.pixelMatrixInverse),o.aC(_,_,this.pixelMatrixInverse);const b=_[3];o.cJ(g,g,1/g[3]),o.cJ(_,_,1/b);const T=g[2],I=_[2];return{p0:g,p1:_,t:T===I?0:(d-T)/(I-T)}}screenPointToMercatorRay(t){const a=[t.x,t.y,0,1],d=[t.x,t.y,1,1];return o.aC(a,a,this.pixelMatrixInverse),o.aC(d,d,this.pixelMatrixInverse),o.cJ(a,a,1/a[3]),o.cJ(d,d,1/d[3]),a[2]=o.ce(a[2],this._center.lat)*this.worldSize,d[2]=o.ce(d[2],this._center.lat)*this.worldSize,o.cJ(a,a,1/this.worldSize),o.cJ(d,d,1/this.worldSize),new o.ax([a[0],a[1],a[2]],o.aw([],o.av([],d,a)))}rayIntersectionCoordinate(t){const{p0:a,p1:d,t:g}=t,_=o.ce(a[2],this._center.lat),b=o.ce(d[2],this._center.lat);return new o.ae(o.ak(a[0],d[0],g)/this.worldSize,o.ak(a[1],d[1],g)/this.worldSize,o.ak(_,b,g))}pointCoordinate(t,a=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,a)}pointCoordinate3D(t,a){if(!this.elevation)return this.pointCoordinate(t,a);let d=this.projection.pointCoordinate3D(this,t.x,t.y);if(d)return new o.ae(d[0],d[1],d[2]);let g=0,_=this.horizonLineFromTop();if(t.y>_)return this.pointCoordinate(t,a);const b=.02*_,T=t.clone();for(let I=0;I<10&&_-g>b;I++){T.y=o.ak(g,_,.66);const k=this.projection.pointCoordinate3D(this,T.x,T.y);k?(_=T.y,d=k):g=T.y}return d?new o.ae(d[0],d[1],d[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=o.cK)return!this.isPointAboveHorizon(t);const a=this.pointCoordinate(t);return a.y>=0&&a.y<=1}_coordinatePoint(t,a){const d=a&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,g=[t.x*this.worldSize,t.y*this.worldSize,d+t.toAltitude(),1];return o.aC(g,g,this.pixelMatrix),g[3]>0?new o.P(g[0]/g[3],g[1]/g[3]):new o.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:a}=this._edgeInsets,d=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,_=this.pointLocation3D(new o.P(a,t)),b=this.pointLocation3D(new o.P(g,t)),T=this.pointLocation3D(new o.P(g,d)),I=this.pointLocation3D(new o.P(a,d));let k=Math.min(_.lng,b.lng,T.lng,I.lng),N=Math.max(_.lng,b.lng,T.lng,I.lng),j=Math.min(_.lat,b.lat,T.lat,I.lat),R=Math.max(_.lat,b.lat,T.lat,I.lat);const z=Math.pow(2,-this.zoom)/16*270,B=this.projection.name==="globe"?1:4,U=(Y,H,K,ne,ce)=>{const ge=(Y+K)/2,pe=(H+ne)/2,_e=new o.P(ge,pe),{lng:me,lat:fe}=this.pointLocation3D(_e),ye=Math.max(0,k-me,j-fe,me-N,fe-R);k=Math.min(k,me),N=Math.max(N,me),j=Math.min(j,fe),R=Math.max(R,fe),(ce<B||ye>z)&&(U(Y,H,ge,pe,ce+1),U(ge,pe,K,ne,ce+1))};if(U(a,t,g,t,1),U(g,t,g,d,1),U(g,d,a,d,1),U(a,d,a,t,1),this.projection.name==="globe"){const[Y,H]=o.cL(this);Y?(R=90,N=180,k=-180):H&&(j=-90,N=180,k=-180)}return new o.aI(new o.aR(k,j),new o.aR(N,R))}_getBoundsRectangular(t,a){const{top:d,left:g}=this._edgeInsets,_=this.height-this._edgeInsets.bottom,b=this.width-this._edgeInsets.right,T=new o.P(g,d),I=new o.P(b,d),k=new o.P(b,_),N=new o.P(g,_);let j=this.pointCoordinate(T,t),R=this.pointCoordinate(I,t);const z=this.pointCoordinate(k,a),B=this.pointCoordinate(N,a),U=(Y,H)=>(H.y-Y.y)/(H.x-Y.x);return j.y>1&&R.y>=0?j=new o.ae((1-B.y)/U(B,j)+B.x,1):j.y<0&&R.y<=1&&(j=new o.ae(-B.y/U(B,j)+B.x,0)),R.y>1&&j.y>=0?R=new o.ae((1-z.y)/U(z,R)+z.x,1):R.y<0&&j.y<=1&&(R=new o.ae(-z.y/U(z,R)+z.x,0)),new o.aI().extend(this.coordinateLocation(j)).extend(this.coordinateLocation(R)).extend(this.coordinateLocation(B)).extend(this.coordinateLocation(z))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const a=t.visibleDemTiles.reduce((d,g)=>{if(g.dem){const _=g.dem.tree;d.min=Math.min(d.min,_.minimums[0]),d.max=Math.max(d.max,_.maximums[0])}return d},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(a.min*t.exaggeration(),a.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const a=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,d=this.height/2-a*(1-this._horizonShift);return t?Math.max(0,d):d}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-o.cI,this.maxLat=o.cI,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.aF(this.minLng)*this.tileSize,this.worldMaxX=o.aF(this.maxLng)*this.tileSize,this.worldMinY=o.aJ(this.maxLat)*this.tileSize,this.worldMaxY=o.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,a){return this.projection.createTileMatrix(this,a,t)}calculateDistanceTileData(t){const a=t.key,d=this._distanceTileDataCache;if(d[a])return d[a];const g=t.canonical,_=1/this.height,b=this.cameraWorldSize,T=b/this.zoomScale(g.z),I=(g.x+Math.pow(2,g.z)*t.wrap)*T,k=g.y*T,N=this.point;N.x*=b/this.worldSize,N.y*=b/this.worldSize;const j=this.angle,R=Math.sin(-j),z=-Math.cos(-j);return d[a]={bearing:[R,z],center:[(N.x-I)*_,(N.y-k)*_],scale:T/o.al*_},d[a]}calculateFogTileMatrix(t){const a=t.key,d=this._fogTileMatrixCache;if(d[a])return d[a];const g=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return o.aB(g,this.worldToFogMatrix,g),d[a]=new Float32Array(g),d[a]}calculateProjMatrix(t,a=!1,d=!1){const g=t.key;let _;if(_=d?this._expandedProjMatrixCache:a?this._alignedProjMatrixCache:this._projMatrixCache,_[g])return _[g];const b=this.calculatePosMatrix(t,this.worldSize);let T;return T=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:d?this.expandedFarZProjMatrix:a?this.alignedProjMatrix:this.projMatrix,o.aB(b,T,b),_[g]=new Float32Array(b),_[g]}calculatePixelsToTileUnitsMatrix(t){const a=t.tileID.key,d=this._pixelsToTileUnitsCache;if(d[a])return d[a];const g=o.cM(t,this);return d[a]=g,d[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,a=o.bq([],[t,t,t]);return o.aB(a,a,this.globeMatrix),a}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const a=o.ce(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(a),g=this._camera.forward(),_=o.ce(1,this._center.lat);d[2]/=_,g[2]/=_,o.aw(g,g);const b=t.raycast(d,g,t.exaggeration());if(b){const T=o.bH([],d,g,b),I=new o.ae(T[0],T[1],o.ce(T[2],o.a$(T[1]))),k=(I.z+o.ag([I.x-d[0],I.y-d[1],I.z-d[2]*_]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(k),this._centerAltitude=I.toAltitude(),this._center=this.coordinateLocation(I),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const a=this._elevation,d=o.ce(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(d),_=a.getAtPointOrZero(new o.ae(...g)),b=this.pixelsPerMeter/this.worldSize*_,T=this._minimumHeightOverTerrain(),I=g[2]-b;if(I<=T)if(I<0||t){const k=this.locationCoordinate(this._center,this._centerAltitude),N=[g[0],g[1],k.z-g[2]],j=o.ag(N);N[2]-=(T-I)/this._pixelsPerMercatorPixel;const R=o.ag(N);if(R===0)return;o.c4(N,N,j/R*this._pixelsPerMercatorPixel),this._camera.position=[g[0],g[1],k.z*this._pixelsPerMercatorPixel-N[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const R=this.center;return R.lat=o.aA(R.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(R.lng=o.aA(R.lng,this.minLng,this.maxLng)),this.center=R,void(this._constraining=!1)}const a=this._unmodified,{x:d,y:g}=this.point;let _=0,b=d,T=g;const I=this.width/2,k=this.height/2,N=this.worldMinY*this.scale,j=this.worldMaxY*this.scale;if(g-k<N&&(T=N+k),g+k>j&&(T=j-k),j-N<this.height&&(_=Math.max(_,this.height/(j-N)),T=(j+N)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const R=this.worldMinX*this.scale,z=this.worldMaxX*this.scale,B=this.worldSize/2-(R+z)/2;b=(d+B+this.worldSize)%this.worldSize-B,b-I<R&&(b=R+I),b+I>z&&(b=z-I),z-R<this.width&&(_=Math.max(_,this.width/(z-R)),b=(z+R)/2)}b===d&&T===g||this._allowWorldUnderZoom||(this.center=this.unproject(new o.P(b,T))),_&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(_)),this._constrainCamera(),this._unmodified=a,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,a=this.projection.name==="globe",d=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=o.ce(1,this.center.lat)/o.ce(1,o.d1));const g=o.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,g),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const _=this.projection.zAxisUnit==="meters"?d:1,b=this._camera.getWorldToCamera(this.worldSize,_);let T;const I=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(I[8]=2*-t.x/this.width,I[9]=2*t.y/this.height,this.isOrthographic){let fe=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ye=fe*this.aspect,Fe=-ye,Pe=-fe;ye-=t.x,Fe-=t.x,fe+=t.y,Pe+=t.y,T=this._camera.getCameraToClipOrthographic(Fe,ye,Pe,fe,this._nearZ,this._farZ),((Ze,De,He,_t)=>{for(let ze=0;ze<16;ze++)Ze[ze]=o.ak(De[ze],He[ze],_t)})(T,T,I,o.c$(this.pitch>=Sa?1:this.pitch/Sa))}else T=I;const k=o.cO([],I,b);let N=o.cO([],T,b);if(this.projection.isReprojectedInTileSpace){const fe=this.locationCoordinate(this.center),ye=o.bA([]);o.br(ye,ye,[fe.x*this.worldSize,fe.y*this.worldSize,0]),o.aB(ye,ye,o.cP(this)),o.br(ye,ye,[-fe.x*this.worldSize,-fe.y*this.worldSize,0]),o.aB(N,N,ye),o.aB(k,k,ye),this.inverseAdjustmentMatrix=o.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=o.cR([],N,[this.worldSize,this.worldSize,this.worldSize/_,1]),this.projMatrix=N,this.invProjMatrix=o.bl(new Float64Array(16),this.projMatrix),a){const fe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);fe[8]=2*-t.x/this.width,fe[9]=2*t.y/this.height,this.expandedFarZProjMatrix=o.cO([],fe,b)}else this.expandedFarZProjMatrix=this.projMatrix;const j=o.bl([],T);this.frustumCorners=o.cS.fromInvProjectionMatrix(j,this.horizonLineFromTop(),this.height),this.cameraFrustum=o.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!a);const R=new Float32Array(16);o.bA(R),o.cR(R,R,[1,-1,1]),o.cT(R,R,this._pitch),o.bB(R,R,this.angle);const z=o.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=o.bz(z);const B=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;z[8]=2*-t.x/this.width,z[9]=2*(t.y+B)/this.height,this.skyboxMatrix=o.aB(R,z,R);const U=this.point,Y=U.x,H=U.y,K=this.width%2/2,ne=this.height%2/2,ce=Math.cos(this.angle),ge=Math.sin(this.angle),pe=Y-Math.round(Y)+ce*K+ge*ne,_e=H-Math.round(H)+ce*ne+ge*K,me=new Float64Array(N);if(o.br(me,me,[pe>.5?pe-1:pe,_e>.5?_e-1:_e,0]),this.alignedProjMatrix=me,N=o.bC(),o.cR(N,N,[this.width/2,-this.height/2,1]),o.br(N,N,[1,-1,0]),this.labelPlaneMatrix=N,N=o.bC(),o.cR(N,N,[1,-1,1]),o.br(N,N,[-1,-1,0]),o.cR(N,N,[2/this.width,2/this.height,1]),this.glCoordMatrix=N,this.pixelMatrix=o.aB(new Float64Array(16),this.labelPlaneMatrix,k),this._calcFogMatrices(),this._distanceTileDataCache={},N=o.bl(new Float64Array(16),this.pixelMatrix),!N)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=N,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=o.cU(this);const fe=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.af(fe,fe,b),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=N;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,a=this.cameraPixelsPerMeter,d=this._camera.position,g=1/this.height/this._pixelsPerMercatorPixel,_=[t,t,a];o.c4(_,_,g),o.c4(d,d,-1),o.cV(d,d,_);const b=o.bC();o.br(b,b,d),o.cR(b,b,_),this.mercatorFogMatrix=b,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,a,g)}_computeCameraPosition(t){const a=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,d=this._camera.forward(),g=this.point,_=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*a-t/this.worldSize*this._centerAltitude;return[g.x/this.worldSize-d[0]*_,g.y/this.worldSize-d[1]*_,t/this.worldSize*this._centerAltitude-d[2]*_]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const a=this._maxCameraBoundsDistance()*Math.cos(this._pitch),d=this._camera.position[2],g=t[2];let _=1;this.projection.wrap&&(this.center=this.center.wrap()),g>0&&(_=Math.min((a-d)/g,1)),this._camera.position=o.bH([],this._camera.position,t,_),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,a=this._camera.forward(),{pitch:d,bearing:g}=this._camera.getPitchBearing(),_=o.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,b=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.an(this._maxPitch)),T=Math.max((t[2]-_)/Math.cos(d),b),I=this._zoomFromMercatorZ(T);o.bH(t,t,a,T),this._pitch=o.aA(d,o.an(this.minPitch),o.an(this.maxPitch)),this.angle=o.bT(g,-Math.PI,Math.PI),this._setZoom(o.aA(I,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let a=0,d=o.cK,g=0,_=1/0;for(;d-a>1e-6&&d>a;){const b=a+.5*(d-a),T=this.tileSize*Math.pow(2,b),I=this.getCameraToCenterDistance(this.projection,b,T),k=this.scaleZoom(I/(Math.max(0,t)*this.tileSize)),N=Math.abs(b-k);N<_&&(_=N,g=b),b<k?a=b:d=b}return g}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,a){const d=Math.min(t.x,a.x),g=Math.max(t.x,a.x),_=Math.min(t.y,a.y),b=Math.max(t.y,a.y);if(_<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const T=[new o.P(d,_),new o.P(g,b),new o.P(d,b),new o.P(g,_)],I=this.renderWorldCopies?-3:0,k=this.renderWorldCopies?4:1;for(const N of T){const j=this.pointRayIntersection(N);if(j.t<0)return!0;const R=this.rayIntersectionCoordinate(j);if(R.x<I||R.y<0||R.x>k||R.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.P(0,0),new o.P(this.width,this.height))}zoomDeltaToMovement(t,a){const d=o.ag(o.av([],this._camera.position,t)),g=this._zoomFromMercatorZ(d)+a;return d-this._mercatorZfromZoom(g)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([a,d,g],_){const b=[a,d,g,1];o.aC(b,b,_);const T=b[3]=Math.max(b[3],1e-6);return b[0]/=T,b[1]/=T,b[2]/=T,b}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(0,t))}}getCameraToCenterDistance(t,a=this.zoom,d=this.worldSize){const g=o.cN(t,a,this.width,this.height,1024),_=t.pixelSpaceConversion(this.center.lat,d,g);let b=.5/Math.tan(.5*this._fov)*this.height*_;return this.isOrthographic&&(b=o.ak(1,b,o.c$(this.pitch>=Sa?1:this.pitch/Sa))),b}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&o.aB(t,t,this.globeMatrix),t}getFrustum(t){return o.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const tl=(h,t)=>{if(t>0&&h.terrain&&o.w("Cutoff is currently disabled on terrain"),t<=0||h.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const a=h.transform,d=Math.max(Math.abs(a._zoom-(h.minCutoffZoom-1)),1),g=a.isLODDisabled(!1)?o.ah(60,45,a.pitch):o.ah(30,15,a.pitch),_=a._farZ-a._nearZ,b=t*a.height,T=((1-(I=g))*a.cameraToCenterDistance+I*(a._farZ+b))*d;var I;return{shouldRenderCutoff:g<1,uniformValues:{u_cutoff_params:[a._nearZ,a._farZ,(T-a._nearZ)/_,(T-b-a._nearZ)/_]}}},qn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class t0{constructor(t,a){this.aabb=t,this.lastCascade=a}}class cd{add(t,a){const d=this.receivers[t.key];d!==void 0?(d.aabb.min[0]=Math.min(d.aabb.min[0],a.min[0]),d.aabb.min[1]=Math.min(d.aabb.min[1],a.min[1]),d.aabb.min[2]=Math.min(d.aabb.min[2],a.min[2]),d.aabb.max[0]=Math.max(d.aabb.max[0],a.max[0]),d.aabb.max[1]=Math.max(d.aabb.max[1],a.max[1]),d.aabb.max[2]=Math.max(d.aabb.max[2],a.max[2])):this.receivers[t.key]=new t0(a,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,a,d){const g=o.d8.fromPoints(t.points);let _=0;for(const b in this.receivers){const T=this.receivers[b];if(!T||!g.intersectsAabb(T.aabb))continue;T.aabb.min=g.closestPoint(T.aabb.min),T.aabb.max=g.closestPoint(T.aabb.max);const I=T.aabb.getCorners();for(let k=0;k<d.length;k++){let N=!0;for(const j of I){const R=[j[0]*a,j[1]*a,j[2]];if(o.af(R,R,d[k].matrix),R[0]<-1||R[0]>1||R[1]<-1||R[1]>1){N=!1;break}}if(T.lastCascade=k,_=Math.max(_,k),N)break}}return _+1}}class $v{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new cd,this._depthMode=new At(t.context.gl.LEQUAL,At.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(qn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(qn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(qn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,a){const d=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!a||!a.properties)return;const g=a.properties.get("shadow-intensity");if(!a.shadowsEnabled()||g<=0||(this._shadowLayerCount=d.style.order.reduce((B,U)=>{const Y=d.style._mergedLayers[U];return B+(Y.hasShadowPass()&&!Y.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const _=d.context,b=qn.shadowMapResolution,T=qn.shadowMapResolution;if(this._cascades.length===0||qn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let B=0;B<qn.cascadeCount;++B){const U=d._shadowMapDebug,Y=_.gl,H=_.createFramebuffer(b,T,U,"texture"),K=new o.T(_,{width:b,height:T,data:null},Y.DEPTH_COMPONENT16);if(H.depthAttachment.set(K.texture),U){const ne=new o.T(_,{width:b,height:T,data:null},Y.RGBA8);H.colorAttachment.set(ne.texture)}this._cascades.push({framebuffer:H,texture:K,matrix:[],far:0,boundingSphereRadius:0,frustum:new o.cA,scale:0})}}this.shadowDirection=Oc(a);let I=0;if(t.elevation){const B=t.elevation,U=[1e4,-1e4];B.visibleDemTiles.filter(Y=>Y.dem).forEach(Y=>{const H=Y.dem.tree;U[0]=Math.min(U[0],H.minimums[0]),U[1]=Math.max(U[1],H.maximums[0])}),U[0]!==1e4&&(I=(U[1]-U[0])*B.exaggeration())}const k=1.5*t.cameraToCenterDistance,N=3*k,j=new Float64Array(16);for(let B=0;B<this._cascades.length;++B){const U=this._cascades[B];let Y=t.height/50,H=1;qn.cascadeCount===1?H=N:B===0?H=k:(Y=k,H=N);const[K,ne]=Gv(t,this.shadowDirection,Y,H,qn.shadowMapResolution,I);U.scale=t.scale,U.matrix=K,U.boundingSphereRadius=ne,o.bl(j,U.matrix),U.frustum=o.cA.fromInvProjectionMatrix(j,1,0,!0),U.far=H}const R=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[R].far,this._cascades[R].far],this._uniformValues.u_shadow_intensity=g,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/qn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=qn.shadowMapResolution,this._uniformValues.u_shadowmap_0=nn.ShadowMap0,this._uniformValues.u_shadowmap_1=nn.ShadowMap0+1,this._groundShadowTiles=d.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const z=d.transform.elevation;for(const B of this._groundShadowTiles){let U={min:0,max:0};if(z){const Y=z.getMinMaxForTile(B);Y&&(U=Y)}this.addShadowReceiver(B.toUnwrapped(),U.min,U.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,a){if(!this.enabled)return;const d=this.painter,g=d.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(d.transform.getFrustum(0),d.transform.worldSize,this._cascades),g.viewport.set([0,0,qn.shadowMapResolution,qn.shadowMapResolution]);for(let _=0;_<this._numCascadesToRender;++_){d.currentShadowCascade=_,g.bindFramebuffer.set(this._cascades[_].framebuffer.framebuffer),g.clear({color:o.ao.white,depth:1});for(const b of t.order){const T=t._mergedLayers[b];if(!T.hasShadowPass()||T.isHidden(d.transform.zoom))continue;const I=t.getLayerSourceCache(T),k=I?a[I.id]:void 0;(T.type==="model"||k&&k.length)&&d.renderLayer(d,I,T,k)}}d.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,a=t.style,d=t.context,g=d.gl,_=a.directionalLight,b=a.ambientLight;if(!_||!b)return;const T=[],I=tl(t,t.longestCutoffRange);I.shouldRenderCutoff&&T.push("RENDER_CUTOFF"),T.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&T.push("NORMAL_OFFSET");const k=Oo(a,_,b),N=new At(g.LEQUAL,At.ReadOnly,t.depthRangeFor3D),j=new Jt({func:g.EQUAL,mask:255},0,255,g.KEEP,g.KEEP,g.KEEP);for(const R of this._groundShadowTiles){const z=R.toUnwrapped(),B=t.isTileAffectedByFog(R),U=t.getOrCreateProgram("groundShadow",{defines:T,overrideFog:B});this.setupShadows(z,U),t.uploadCommonUniforms(d,U,z,null,I);const Y={u_matrix:t.transform.calculateProjMatrix(z),u_ground_shadow_factor:k};U.draw(t,g.TRIANGLES,N,j,vr.multiply,ir.disabled,Y,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?vr.unblended:vr.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const a=this.painter.transform,d=a.calculatePosMatrix(t,a.worldSize);return o.aB(d,this._cascades[this.painter.currentShadowCascade].matrix,d),Float32Array.from(d)}calculateShadowPassMatrixFromMatrix(t){return o.aB(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,a,d){if(!this.enabled)return;const g=this.painter.transform,_=this.painter.context,b=_.gl,T=this._uniformValues,I=new Float64Array(16),k=g.calculatePosMatrix(t,g.worldSize);for(let N=0;N<this._cascades.length;N++)o.aB(I,this._cascades[N].matrix,k),T[N===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(I),_.activeTexture.set(b.TEXTURE0+nn.ShadowMap0+N),this._cascades[N].texture.bindExtraParam(b.LINEAR,b.LINEAR,b.CLAMP_TO_EDGE,b.CLAMP_TO_EDGE,b.GREATER);if(this.useNormalOffset=!!d,this.useNormalOffset){const N=o.d6(t.canonical),j=2/g.tileSize*o.al/qn.shadowMapResolution,R=j*this._cascades[0].boundingSphereRadius,z=j*this._cascades[this._cascades.length-1].boundingSphereRadius,B=(d==="vector-tile"?1:3)*function(U,Y,H,K,ne){const ce=o.aA((U-22)/-22,0,1);return .125*(1-ce)+4*ce}(g.zoom);T.u_shadow_normal_offset=[N,R*B,z*B],T.u_shadow_bias=[1e-4,.0012,.012]}else T.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(_,T)}setupShadowsFromMatrix(t,a,d=!1){if(!this.enabled)return;const g=this.painter.context,_=g.gl,b=this._uniformValues,T=new Float64Array(16);for(let I=0;I<qn.cascadeCount;I++)o.aB(T,this._cascades[I].matrix,t),b[I===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),g.activeTexture.set(_.TEXTURE0+nn.ShadowMap0+I),this._cascades[I].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=d,d){const I=qn.normalOffset;b.u_shadow_normal_offset=[1,I,I],b.u_shadow_bias=[6e-5,.0012,.012]}else b.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(g,b)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,a,d,g){if(g[2]>=0)return{};const _=function(I,k,N){const j=N/(1<<I.canonical.z);return new o.d8([I.canonical.x*j+I.wrap*N,I.canonical.y*j+I.wrap*N,0],[(I.canonical.x+1)*j+I.wrap*N,(I.canonical.y+1)*j+I.wrap*N,k])}(t,a,d).getCorners(),b=a/-g[2];g[0]<0?(o.d7(_[0],_[0],[g[0]*b,0,0]),o.d7(_[3],_[3],[g[0]*b,0,0])):g[0]>0&&(o.d7(_[1],_[1],[g[0]*b,0,0]),o.d7(_[2],_[2],[g[0]*b,0,0])),g[1]<0?(o.d7(_[0],_[0],[0,g[1]*b,0]),o.d7(_[1],_[1],[0,g[1]*b,0])):g[1]>0&&(o.d7(_[2],_[2],[0,g[1]*b,0]),o.d7(_[3],_[3],[0,g[1]*b,0]));const T={};return T.vertices=_,T.planes=[Ah(_[1],_[0],_[4]),Ah(_[2],_[1],_[5]),Ah(_[3],_[2],_[6]),Ah(_[0],_[3],_[7])],T}addShadowReceiver(t,a,d){this._receivers.add(t,o.d8.fromTileIdAndHeight(t,a,d))}getMaxCascadeForTile(t){const a=this._receivers.get(t);return a&&a.lastCascade?a.lastCascade:0}}function Ah(h,t,a){const d=o.av([],a,t),g=o.av([],h,t),_=o.bI([],d,g),b=o.ag(_);return b===0?[0,0,1,0]:(o.c4(_,_,1/b),[_[0],_[1],_[2],-o.bJ(_,t)])}function Oc(h){const t=h.properties.get("direction"),a=o.d3(t.x,t.y,t.z);a[2]=o.aA(a[2],0,75);const d=o.d5([a[0],a[1],a[2]]);return o.d4(d.x,d.y,d.z)}function Oo(h,t,a){const d=t.properties.get("color-use-theme")==="none",g=t.properties.get("color"),_=t.properties.get("intensity"),b=t.properties.get("direction"),T=[b.x,b.y,b.z],I=a.properties.get("color-use-theme")==="none",k=a.properties.get("color"),N=a.properties.get("intensity"),j=Math.max(o.bJ([0,0,1],T),0),R=[0,0,0];o.c4(R,k.toPremultipliedRenderColor(I?null:h.getLut(t.scope)).toArray01Linear().slice(0,3),N);const z=[0,0,0];return o.c4(z,g.toPremultipliedRenderColor(d?null:h.getLut(a.scope)).toArray01Linear().slice(0,3),j*_),o.da([R[0]>0?R[0]/(R[0]+z[0]):0,R[1]>0?R[1]/(R[1]+z[1]):0,R[2]>0?R[2]/(R[2]+z[2]):0])}function Gv(h,t,a,d,g,_){const b=h.zoom,T=h.scale,I=h.worldSize,k=1/I,N=h.aspect,j=Math.sqrt(1+N*N)*Math.tan(.5*h.fovX),R=j*j,z=d-a,B=d+a;let U,Y;R>z/B?(U=d,Y=d*j):(U=.5*B*(1+R),Y=.5*Math.sqrt(z*z+2*(d*d+a*a)*R+B*B*R*R));const H=h.projection.pixelsPerMeter(h.center.lat,I),K=h._camera.getCameraToWorldMercator(),ne=[0,0,-U*k];o.af(ne,ne,K);let ce=Y*k;const ge=h._edgeInsets;if(!(ge.left===0&&ge.top===0&&ge.right===0&&ge.bottom===0||ge.left===ge.right&&ge.top===ge.bottom)){const nt=h._camera.getWorldToCamera(h.worldSize,h.projection.zAxisUnit==="meters"?H:1),gt=h._camera.getCameraToClipPerspective(h._fov,h.width/h.height,a,d);gt[8]=2*-h.centerOffset.x/h.width,gt[9]=2*h.centerOffset.y/h.height;const Et=new Float64Array(16);o.cO(Et,gt,nt);const dt=new Float64Array(16);o.bl(dt,Et);const lt=o.cA.fromInvProjectionMatrix(dt,I,b,!0);for(const Ft of lt.points){const Dt=((pe=Ft)[0]/=T,pe[1]/=T,pe[2]=o.ce(pe[2],h._center.lat),pe);ce=Math.max(ce,o.c5(o.d9([],ne,Dt)))}}var pe;ce*=g/(g-1);const _e=Math.acos(t[2]),me=Math.atan2(-t[0],-t[1]),fe=new Ch;fe.position=ne,fe.setPitchBearing(_e,me);const ye=fe.getWorldToCamera(I,H),Fe=ce*I,Pe=Math.min(h._mercatorZfromZoom(17)*I*-2,-2*Fe),Ze=fe.getCameraToClipOrthographic(-Fe,Fe,-Fe,Fe,Pe,(Fe+_*H)/t[2]),De=new Float64Array(16);o.aB(De,Ze,ye);const He=o.d4(Math.floor(1e6*ne[0])/1e6*I,Math.floor(1e6*ne[1])/1e6*I,0),_t=.5*g,ze=[0,0,0];o.af(ze,He,De),o.c4(ze,ze,_t);const Ie=[Math.floor(ze[0]),Math.floor(ze[1]),Math.floor(ze[2])],Ye=[0,0,0];o.av(Ye,ze,Ie),o.c4(Ye,Ye,-1/_t);const Ue=new Float64Array(16);return o.bA(Ue),o.br(Ue,Ue,Ye),o.aB(De,Ue,De),[De,Fe]}class Dc extends o.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,a){return o.aV(this.requestManager.transformRequest(a,o.R.Model).url).then(d=>{if(!d)return;const g=o.aW(d),_=new o.aX(t,void 0,void 0,g);return _.computeBoundsAndApplyParent(),_}).catch(d=>{if(d&&d.status===404)return null;this.fire(new o.y(new Error(`Could not load model ${t} from ${a}: ${d.message}`)))})}load(t,a,d={forceReload:!1}){this.models[a]||(this.models[a]={});const g=Object.keys(t),_=[],b=[];for(const T of g){const I=t[T];this.hasURLBeenRequested(I)&&!d.forceReload||(this.modelByURL[I]={modelId:T,scope:a},_.push(this.loadModel(T,I)),b.push(T)),this.models[a][T]||(this.models[a][T]={model:null,numReferences:1})}this.numModelsLoading[a]=(this.numModelsLoading[a]||0)+b.length,Promise.allSettled(_).then(T=>{for(let I=0;I<T.length;I++){const{status:k}=T[I];if(k==="rejected")continue;const{value:N}=T[I];this.models[a][b[I]]||(this.models[a][b[I]]={model:null,numReferences:1}),this.models[a][b[I]].model=N}this.numModelsLoading[a]-=b.length,this.fire(new o.z("data",{dataType:"style"}))}).catch(T=>{this.fire(new o.y(new Error(`Could not load models: ${T.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,a,d={exactIdMatch:!1}){return!!(d.exactIdMatch?this.getModel(t,a):this.getModelByURL(this.modelUris[a][t]))}getModel(t,a){return this.models[a]||(this.models[a]={}),this.models[a][t]?this.models[a][t].model:void 0}getModelByURL(t){if(!t)return null;const a=this.modelByURL[t];return a?this.models[a.scope][a.modelId].model:null}hasModelBeenAdded(t,a){return this.models[a]&&this.models[a][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,a,d){this.models[d]||(this.models[d]={}),this.modelUris[d]||(this.modelUris[d]={});const g=this.requestManager.normalizeModelURL(a);if((this.hasModel(t,d,{exactIdMatch:!0})||this.hasModelBeenAdded(t,d))&&this.modelUris[d][t]===g)this.models[d][t].numReferences++;else if(this.hasURLBeenRequested(g)){const{scope:_,modelId:b}=this.modelByURL[g];this.models[_][b].numReferences++}else this.modelUris[d][t]=g,this.load({[t]:this.modelUris[d][t]},d)}addModelURLs(t,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});const d=this.modelUris[a];for(const g in t)d[g]=this.requestManager.normalizeModelURL(t[g])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});const d={};for(const g of t)this.hasModel(g,a,{exactIdMatch:!0})||this.hasURLBeenRequested(g)?this.models[a][g].numReferences++:this.modelUris[a][g]&&!this.hasURLBeenRequested(g)?d[g]=this.modelUris[a][g]:!this.hasURLBeenRequested(g)&&o.db(g,!1)&&(this.modelUris[a][g]=this.requestManager.normalizeModelURL(g),d[g]=this.modelUris[a][g]);this.load(d,a)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,a,d=!1,g=!1){if(this.models[a]&&this.models[a][t]&&(this.models[a][t].numReferences--,this.models[a][t].numReferences===0||g)){const _=this.modelUris[a][t];d||delete this.modelUris[a][t],delete this.modelByURL[_];const b=this.models[a][t].model;if(!b)return;delete this.models[a][t],b.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const a of Object.keys(this.models[t])){const d=this.models[t][a].model;delete this.models[t][a],d&&d.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,a){this.models[a]||(this.models[a]={});for(const d in this.models[a])this.models[a][d].model&&this.models[a][d].model.upload(t.context)}}const r0=new o.a9({data:new o.aa(o.a6.colorTheme.data)});function Ph(h){if(!h.metadata||!h.metadata.content_area)return;const t=o.o.devicePixelRatio,{left:a,top:d,width:g,height:_}=h.metadata.content_area,b=a*t,T=d*t;return[b,T,b+g*t,T+_*t]}function kh(h){if(h)return h.map(([t,a])=>[t*o.o.devicePixelRatio,a*o.o.devicePixelRatio])}class rl{constructor(t,a,d){this.id=t,this.scope=a,this.sourceCache=d,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const a=this.sourceCache.getVisibleCoordinates();if(a.length===0)return t;const d=this.sourceCache.getSource();if(!(d instanceof Xa))return t;const g=a.map(b=>this.sourceCache.getTile(b)),_=d.getImages(g,Array.from(this.pendingRequests));for(const[b,T]of _)t.set(o.I.from({name:b,iconsetId:this.id}),T),this.pendingRequests.delete(b);for(const b of this.pendingRequests)this.missingRequests.add(b);return this.pendingRequests.clear(),t}}const Ul=(h,t)=>be(h,t&&t.filter(a=>a.identifier!=="source.canvas")),qv=o.aH(Ur,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Hv=o.aH(Ur,["setCenter","setZoom","setBearing","setPitch"]),Mh=new Set(["background","sky","slot","custom"]),i0={version:8,layers:[],sources:{}},Nh={duration:300,delay:0};class mo extends o.E{constructor(t,a={}){super(),this.map=t,this.scope=a.scope||"",this.globalId=null,this.fragments=[],this.importDepth=a.importDepth||0,this.importsCache=a.importsCache||new Map,this.resolvedImports=a.resolvedImports||new Set,this.transition=Object.assign({},Nh),this._buildingIndex=new gh(this),this.crossTileSymbolIndex=new Cn,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=a.styleChanges||new Di,this.dispatcher=a.dispatcher?a.dispatcher:new o.D(o.dd(),this),a.imageManager?this.imageManager=a.imageManager:(this.imageManager=new Gr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=a.glyphManager?a.glyphManager:new o.de(t._requestManager,a.localFontFamily?o.df.all:a.localIdeographFontFamily?o.df.ideographs:o.df.none,a.localFontFamily||a.localIdeographFontFamily),a.modelManager?this.modelManager=a.modelManager:(this.modelManager=new Dc(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=a.configOptions?a.configOptions:new Map,this._configDependentLayers=a.configDependentLayers?a.configDependentLayers:new Set,this._config=a.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:a.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=a.initialConfig,this.dispatcher.broadcast("setReferrer",o.dg());const d=this;this._rtlTextPluginCallback=mo.registerForPluginStateChange(g=>{d.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:g.pluginStatus,pluginURL:g.pluginURL},(_,b)=>{if(o.dh(_),b&&b.every(T=>T))for(const T in d._sourceCaches){const I=d._sourceCaches[T],k=I.getSource().type;k!=="vector"&&k!=="geojson"||I.reload()}})}),this.on("data",g=>{if(g.dataType!=="source"||g.sourceDataType!=="metadata")return;const _=this.getOwnSource(g.sourceId);if(_&&_.vectorLayerIds)for(const b in this._layers){const T=this._layers[b];T.source===_.id&&this._validateLayer(T)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(o.h(t))return t;const a=o.di(t);if(!a.startsWith("http"))try{return new URL(a,location.href).toString()}catch{return a}return a}return`json://${o.dj(JSON.stringify(t))}`}_diffStyle(t,a,d){this.globalId=this._getGlobalId(t);const g=(_,b)=>{try{b(null,this.setState(_,d))}catch(T){b(T,!1)}};if(typeof t=="string"){const _=this.map._requestManager.normalizeStyleURL(t),b=this.map._requestManager.transformRequest(_,o.R.Style);o.m(b,(T,I)=>{T?this.fire(new o.y(T)):I&&g(I,a)})}else typeof t=="object"&&g(t,a)}loadURL(t,a={}){this.fire(new o.z("dataloading",{dataType:"style"}));const d=typeof a.validate=="boolean"?a.validate:!o.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,a.accessToken),this.resolvedImports.add(t);const g=this.importsCache.get(t);if(g)return this._load(g,d);const _=this.map._requestManager.transformRequest(t,o.R.Style);this._request=o.m(_,(b,T)=>{if(this._request=null,b)this.fire(new o.y(b));else if(T)return this.importsCache.set(t,T),this._load(T,d)})}loadJSON(t,a={}){this.fire(new o.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=o.o.frame(()=>{this._request=null,this._load(t,a.validate!==!1)})}loadEmpty(){this.fire(new o.z("dataloading",{dataType:"style"})),this._load(i0,!1)}_loadImports(t,a,d){if(this.importDepth>=4)return o.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const g=[];for(const _ of t){const b=this._createFragmentStyle(_),T=new Promise(N=>{b.once("style.import.load",N),b.once("error",N)}).then(()=>this.mergeAll());if(g.push(T),this.resolvedImports.has(_.url)){b.loadEmpty();continue}const I=_.data||this.importsCache.get(_.url);I?(b.loadJSON(I,{validate:a}),this._isInternalStyle(I)&&(b.globalId=null)):_.url?b.loadURL(_.url,{validate:a}):b.loadEmpty();const k={style:b,id:_.id,config:_.config};if(d){const N=this.fragments.findIndex(({id:j})=>j===d);this.fragments=this.fragments.slice(0,N).concat(k).concat(this.fragments.slice(N))}else this.fragments.push(k)}return Promise.allSettled(g)}getImportGlobalIds(t=this,a=new Set){for(const d of t.fragments)d.style.globalId&&a.add(d.style.globalId),this.getImportGlobalIds(d.style,a);return[...a.values()]}_createFragmentStyle(t){const a=this.scope?o.B(t.id,this.scope):t.id;let d;const g=this._initialConfig&&this._initialConfig[a];(t.config||g)&&(d=Object.assign({},t.config,g));const _=new mo(this.map,{scope:a,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:d,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return _.setEventedParent(this.map,{style:_}),_}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,a){if(this._isInternalStyle(t)){const _=Object.assign({},i0,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(_,a)}if(this.updateConfig(this._config,t.schema),a&&Ul(this,Po(t)))return;this._loaded=!0,this.stylesheet=o.dk(t);const d=()=>{for(const I in t.sources)this.addSource(I,t.sources[I],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const I in t.iconsets)this.addIconset(I,t.iconsets[I]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const _=_h(this.stylesheet.layers);if(this._order=_.map(I=>I.id),this.stylesheet.light&&o.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const I=this.stylesheet.lights[0];this.light=new Me(I.properties,I.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Me(this.stylesheet.light)),this._layers={};for(const I of _){const k=o.dq(I,this.scope,this._styleColorTheme.lut,this.options);k.configDependencies.size!==0&&this._configDependentLayers.add(k.fqid),k.setEventedParent(this,{layer:{id:k.id}}),this._layers[k.id]=k;const N=this.getOwnLayerSourceCache(k),j=!!this.directionalLight&&this.directionalLight.shadowsEnabled();N&&k.canCastShadows()&&j&&(N.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const b=this.stylesheet.terrain;b&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(b,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new o.z("data",{dataType:"style"}));const T=this.isRootStyle();t.imports?this._loadImports(t.imports,a).then(()=>{this._reloadImports(),this.fire(new o.z(T?"style.load":"style.import.load"))}).catch(I=>{this.fire(new o.y(new Error("Failed to load imports",I))),this.fire(new o.z(T?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new o.z(T?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const g=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(g){const _=this._evaluateColorThemeData(g);this._loadColorTheme(_).then(()=>{d()}).catch(b=>{o.w(`Couldn't load color theme from the stylesheet: ${b}`),d()})}else this._styleColorTheme.lut=null,d()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,a,d,g,_,b,T,I,k,N;const j={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(R=>{if(R.stylesheet){if(R.light!=null&&(t=R.light),R.stylesheet.lights)for(const z of R.stylesheet.lights)z.type==="ambient"&&R.ambientLight!=null&&(a=R.ambientLight),z.type==="directional"&&R.directionalLight!=null&&(d=R.directionalLight);g=this._prioritizeTerrain(g,R.terrain,R.stylesheet.terrain),R.stylesheet.fog&&R.fog!=null&&(_=R.fog),R.stylesheet.snow&&R.snow!=null&&(b=R.snow),R.stylesheet.rain&&R.rain!=null&&(T=R.rain),R.stylesheet.camera!=null&&(N=R.stylesheet.camera),R.stylesheet.projection!=null&&(I=R.stylesheet.projection),R.stylesheet.transition!=null&&(k=R.stylesheet.transition),j[R.scope]=R._styleColorTheme}}),this.light=t,this.ambientLight=a,this.directionalLight=d,this.fog=_,this.snow=b,this.rain=T,this._styleColorThemeForScope=j,g===null?delete this.terrain:this.terrain=g,this.camera=N||{"camera-projection":"perspective"},this.projection=I||{name:"mercator"},this.transition=Object.assign({},Nh,k),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const a=d=>{for(const g of d.fragments)a(g.style);t(d)};a(this)}_prioritizeTerrain(t,a,d){const g=t&&t.drapeRenderMode===0;return d===null?a&&a.drapeRenderMode===0?a:g?t:null:a!=null&&(!t||g||a&&a.drapeRenderMode===1)?a:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(a=>{t=this._prioritizeTerrain(t,a.terrain,a.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(a=>{a.stylesheet.projection!=null&&(t=a.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},a={},d={};this.forEachFragmentStyle(g=>{for(const _ in g._sourceCaches){const b=o.B(_,g.scope);t[b]=g._sourceCaches[_]}for(const _ in g._otherSourceCaches){const b=o.B(_,g.scope);a[b]=g._otherSourceCaches[_]}for(const _ in g._symbolSourceCaches){const b=o.B(_,g.scope);d[b]=g._symbolSourceCaches[_]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=a,this._mergedSymbolSourceCaches=d}mergeLayers(){const t={},a=[],d={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(b=>{for(const T of b._order){const I=b._layers[T];if(I.type==="slot"){const k=o.dl(T);if(t[k])continue;t[k]=[]}I.slot&&t[I.slot]?t[I.slot].push(I):a.push(I)}}),this._mergedOrder=[];let g=-1;const _=(b=[])=>{for(const T of b)if(T.type==="slot"){const I=o.dl(T.id);t[I]&&_(t[I]),this._mergedSlots.push(I)}else{const I=o.B(T.id,T.scope);this._mergedOrder.push(I),d[I]=T,T.is3D(!!this.terrain)&&(this._has3DLayers=!0,g=this._mergedOrder.length-1),T.type==="circle"&&(this._hasCircleLayers=!0),T.type==="symbol"&&(this._hasSymbolLayers=!0),T.type==="clip"&&(this._clipLayerPresent=!0)}};if(_(a),this._has3DLayers){const b={};for(let T=0;T<this._mergedOrder.length;++T){const I=this._mergedOrder[T];b[I]=T===g?1:T<g?d[I].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort((T,I)=>b[T]-b[I])}this._mergedLayers=d,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(a,d,g,_){const b=Object.assign({},d);for(const I of Object.keys(o.a6.colorTheme))b[I]===void 0&&(b[I]=o.a6.colorTheme[I].default);const T=new o.a8(r0,a,new Map(g));return T.setTransitionOrValue(b,g),T.untransitioned().possiblyEvaluate(new o.ac(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const a=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((d,g)=>{const _="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void d();let b=t;b.startsWith(_)||(b=_+b);const T=o.I.from("mapbox-reserved-lut"),I=new Image;I.src=b,I.onerror=()=>{this._styleColorTheme.lutLoading=!1,g(new Error("Failed to load image data"))},I.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==a)return void d();this._styleColorTheme.lutLoading=!1;const{width:k,height:N,data:j}=o.o.getImageData(I);if(N>32)return void g(new Error("The height of the image must be less than or equal to 32 pixels."));if(k!==N*N)return void g(new Error("The width of the image must be equal to the height squared."));this.getImage(T)&&this.removeImage(T),this.addImage(T,{data:new o.q({width:k,height:N},j),pixelRatio:1,sdf:!1,usvg:!1,version:0});const R=this.imageManager.getImage(T,this.scope);R?(this._styleColorTheme.lut={image:R.data,data:t},d()):g(new Error("Missing LUT image."))}})}getLut(t){const a=this._styleColorThemeForScope[t];return a?a.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(a,d,g){let _,b,T;const I=o.o.devicePixelRatio>1?"@2x":"";let k=o.m(d.transformRequest(d.normalizeSpriteURL(a,I,".json"),o.R.SpriteJSON),(R,z)=>{k=null,T||(T=R,_=z,j())}),N=o.n(d.transformRequest(d.normalizeSpriteURL(a,I,".png"),o.R.SpriteImage),(R,z)=>{N=null,T||(T=R,b=z,j())});function j(){if(T)g(T);else if(_&&b){const R=o.o.getImageData(b),z={};for(const B in _){const{width:U,height:Y,x:H,y:K,sdf:ne,pixelRatio:ce,stretchX:ge,stretchY:pe,content:_e}=_[B],me=new o.q({width:U,height:Y});o.q.copy(R,me,{x:H,y:K},{x:0,y:0},{width:U,height:Y},null),z[B]={data:me,pixelRatio:ce!==void 0?ce:1,sdf:ne!==void 0&&ne,stretchX:ge,stretchY:pe,content:_e,usvg:!1,version:0}}g(null,z)}}return{cancel(){k&&(k.cancel(),k=null),N&&(N.cancel(),N=null)}}}(t,this.map._requestManager,(a,d)=>{if(this._spriteRequest=null,a)this.fire(new o.y(a));else if(d){const g=new Map;for(const _ in d)g.set(o.I.from(_),d[_]);this.addImages(g)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))})}addIconset(t,a){if(a.type==="sprite")return void this._loadSprite(a.url);const d=this.getOwnSourceCache(a.source);if(!d)return void this.fire(new o.y(new Error(`Source "${a.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const g=d.getSource();if(g.type!=="raster-array")return void this.fire(new o.y(new Error(`Source "${a.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));g.partial=!1;const _=new rl(t,this.scope,d);this.imageManager.addImageProvider(_,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!o.h(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const a=this.map._spriteFormat==="auto";var d,g;this._spriteRequest=(g=(_,b)=>{if(this._spriteRequest=null,_)a?this._loadSprite(t):this.fire(new o.y(_));else if(b){const T=new Map;for(const I in b)T.set(o.I.from(I),b[I]);this.addImages(T)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))},o.bu((d=this.map._requestManager).transformRequest(d.normalizeIconsetURL(t),o.R.Iconset),(_,b)=>{if(_)return void g(_);const T={},I=o.dc(new o.bt(b));for(const k of I.icons){const N={version:1,pixelRatio:o.o.devicePixelRatio,content:Ph(k),stretchX:k.metadata?kh(k.metadata.stretch_x_areas):void 0,stretchY:k.metadata?kh(k.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:k};T[k.name]=N}g(null,T)}))}_validateLayer(t){const a=this.getOwnSource(t.source);if(!a)return;const d=t.sourceLayer;d&&(a.type==="geojson"||a.vectorLayerIds&&a.vectorLayerIds.indexOf(d)===-1)&&this.fire(new o.y(new Error(`Source layer "${d}" does not exist on source "${a.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,a)=>{const d=this.fragments[a];return d&&d.style&&(t.data=d.style.serialize()),t})}_serializeSources(){const t={};for(const a in this._sourceCaches){const d=this._sourceCaches[a].getSource();t[d.id]||(t[d.id]=d.serialize())}return t}_serializeLayers(t){const a=[];for(const d of t){const g=this._layers[d];g&&g.type!=="custom"&&a.push(g.serialize())}return a}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const a=this.getOwnLayer(t);if(a)return a;this.fire(new o.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const a=this.getOwnSource(t);if(a)return a;this.fire(new o.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,a){const d=this.map.painter;if(d)for(let g=t.minzoom||0;g<(t.maxzoom||25.5);g++){const _=t.getProgramIds();if(_)for(const b of _){const T=t.getDefaultProgramParams(b,a.zoom,this._styleColorTheme.lut);T&&(d.style=this,this.fog&&(d._fogVisible=!0,T.overrideFog=!0,d.getOrCreateProgram(b,T)),d._fogVisible=!1,T.overrideFog=!1,d.getOrCreateProgram(b,T),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(T.overrideRtt=!0,d.getOrCreateProgram(b,T)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const a=this.calculateLightsBrightness();t.brightness=a||0,a!==this._brightness&&(this._brightness=a,this.dispatcher.broadcast("setBrightness",a)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const d=this._changes.isDirty();let g=!1;if(this._changes.isDirty()){const T=this._changes.getLayerUpdatesByScope();for(const I in T){const{updatedIds:k,removedIds:N}=T[I];(k||N)&&(this._updateWorkerLayers(I,k,N),g=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const _={};for(const T in this._mergedSourceCaches){const I=this._mergedSourceCaches[T];_[T]=I.used,I.used=!1,I.tileCoverLift=0}for(const T of this._mergedOrder){const I=this._mergedLayers[T];if(I.recalculate(t,this._availableImages),!I.isHidden(t.zoom)){const k=this.getLayerSourceCache(I);k&&(k.used=!0,k.tileCoverLift=Math.max(k.tileCoverLift,I.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(I,t)}):this.precompilePrograms(I,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&g&&this.mergeLayers();const b=this.imageManager.getPendingImageProviders();for(const T of b)T.sourceCache.used=!0;for(const T in _){const I=this._mergedSourceCaches[T];_[T]!==I.used&&I.getSource().fire(new o.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:I.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),d&&this.fire(new o.z("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const a of t){const d=a.resolvePendingRequests(),g=this.getFragmentStyle(a.scope);g&&g.addImages(d)}}_updateTilesForChangedImages(){const t={};for(const a in this._mergedSourceCaches){const d=this._mergedSourceCaches[a].getSource().scope;t[d]=t[d]||this._changes.getUpdatedImages(d),t[d].length!==0&&this._mergedSourceCaches[a].reloadTilesForDependencies(["icons","patterns"],t[d])}for(const a in t)this._changes.resetUpdatedImages(a)}_updateWorkerLayers(t,a,d){const g=this.getFragmentStyle(t);g&&this.dispatcher.broadcast("updateLayers",{layers:a?g._serializeLayers(a):[],scope:t,removedIds:d||[],options:g.options})}setState(t,a){if(this._checkLoaded(),Ul(this,Po(t)))return!1;(t=o.dk(t)).layers=_h(t.layers);const d=function(b,T){if(!b)return[{command:Ur.setStyle,args:[T]}];let I=[];try{if(!o.by(b.version,T.version))return[{command:Ur.setStyle,args:[T]}];if(o.by(b.center,T.center)||I.push({command:Ur.setCenter,args:[T.center]}),o.by(b.zoom,T.zoom)||I.push({command:Ur.setZoom,args:[T.zoom]}),o.by(b.bearing,T.bearing)||I.push({command:Ur.setBearing,args:[T.bearing]}),o.by(b.pitch,T.pitch)||I.push({command:Ur.setPitch,args:[T.pitch]}),o.by(b.sprite,T.sprite)||I.push({command:Ur.setSprite,args:[T.sprite]}),o.by(b.glyphs,T.glyphs)||I.push({command:Ur.setGlyphs,args:[T.glyphs]}),o.by(b.imports,T.imports)||function(z=[],B=[],U){B=B||[];const Y=(z=z||[]).map(Mc),H=B.map(Mc),K=z.reduce(ed,{}),ne=B.reduce(ed,{}),ce=Y.slice();let ge,pe,_e,me;for(ge=0,pe=0;ge<Y.length;ge++)_e=Y[ge],ne.hasOwnProperty(_e)?pe++:(U.push({command:Ur.removeImport,args:[_e]}),ce.splice(ce.indexOf(_e,pe),1));for(ge=0,pe=0;ge<H.length;ge++)_e=H[H.length-1-ge],ce[ce.length-1-ge]!==_e&&(K.hasOwnProperty(_e)?(U.push({command:Ur.removeImport,args:[_e]}),ce.splice(ce.lastIndexOf(_e,ce.length-pe),1)):pe++,me=ce[ce.length-ge],U.push({command:Ur.addImport,args:[ne[_e],me]}),ce.splice(ce.length-ge,0,_e));for(const fe of B){const ye=K[fe.id];ye&&(delete ye.data,o.by(ye,fe)||U.push({command:Ur.updateImport,args:[fe.id,fe]}))}}(b.imports,T.imports,I),o.by(b.transition,T.transition)||I.push({command:Ur.setTransition,args:[T.transition]}),o.by(b.light,T.light)||I.push({command:Ur.setLight,args:[T.light]}),o.by(b.fog,T.fog)||I.push({command:Ur.setFog,args:[T.fog]}),o.by(b.snow,T.snow)||I.push({command:Ur.setSnow,args:[T.snow]}),o.by(b.rain,T.rain)||I.push({command:Ur.setRain,args:[T.rain]}),o.by(b.projection,T.projection)||I.push({command:Ur.setProjection,args:[T.projection]}),o.by(b.lights,T.lights)||I.push({command:Ur.setLights,args:[T.lights]}),o.by(b.camera,T.camera)||I.push({command:Ur.setCamera,args:[T.camera]}),o.by(b.iconsets,T.iconsets)||function(z,B,U){let Y;for(Y in B=B||{},z=z||{})z.hasOwnProperty(Y)&&(B.hasOwnProperty(Y)||U.push({command:Ur.removeIconset,args:[Y]}));for(Y in B){if(!B.hasOwnProperty(Y))continue;const H=B[Y];z.hasOwnProperty(Y)?o.by(z[Y],H)||(U.push({command:Ur.removeIconset,args:[Y]}),U.push({command:Ur.addIconset,args:[Y,H]})):U.push({command:Ur.addIconset,args:[Y,H]})}}(b.iconsets,T.iconsets,I),!o.by(b["color-theme"],T["color-theme"]))return[{command:Ur.setStyle,args:[T]}];const k={},N=[];(function(z,B,U,Y){let H;for(H in B=B||{},z=z||{})z.hasOwnProperty(H)&&(B.hasOwnProperty(H)||X_(H,U,Y));for(H in B){if(!B.hasOwnProperty(H))continue;const K=B[H];z.hasOwnProperty(H)?o.by(z[H],K)||(z[H].type==="geojson"&&K.type==="geojson"&&yh(z,B,H)?U.push({command:Ur.setGeoJSONSourceData,args:[H,K.data]}):Y_(H,B,U,Y)):kc(H,B,U)}})(b.sources,T.sources,N,k);const j=[];b.layers&&b.layers.forEach(z=>{z.source&&k[z.source]?I.push({command:Ur.removeLayer,args:[z.id]}):j.push(z)});let R=b.terrain;R&&k[R.source]&&(I.push({command:Ur.setTerrain,args:[void 0]}),R=void 0),I=I.concat(N),o.by(R,T.terrain)||I.push({command:Ur.setTerrain,args:[T.terrain]}),function(z,B,U){B=B||[];const Y=(z=z||[]).map(Mc),H=B.map(Mc),K=z.reduce(ed,{}),ne=B.reduce(ed,{}),ce=Y.slice(),ge=Object.create(null);let pe,_e,me,fe,ye,Fe,Pe;for(pe=0,_e=0;pe<Y.length;pe++)me=Y[pe],ne.hasOwnProperty(me)?_e++:(U.push({command:Ur.removeLayer,args:[me]}),ce.splice(ce.indexOf(me,_e),1));for(pe=0,_e=0;pe<H.length;pe++)me=H[H.length-1-pe],ce[ce.length-1-pe]!==me&&(K.hasOwnProperty(me)?(U.push({command:Ur.removeLayer,args:[me]}),ce.splice(ce.lastIndexOf(me,ce.length-_e),1)):_e++,Fe=ce[ce.length-pe],U.push({command:Ur.addLayer,args:[ne[me],Fe]}),ce.splice(ce.length-pe,0,me),ge[me]=!0);for(pe=0;pe<H.length;pe++)if(me=H[pe],fe=K[me],ye=ne[me],!ge[me]&&!o.by(fe,ye))if(o.by(fe.source,ye.source)&&o.by(fe["source-layer"],ye["source-layer"])&&o.by(fe.type,ye.type)){for(Pe in Ja(fe.layout,ye.layout,U,me,null,Ur.setLayoutProperty),Ja(fe.paint,ye.paint,U,me,null,Ur.setPaintProperty),o.by(fe.slot,ye.slot)||U.push({command:Ur.setSlot,args:[me,ye.slot]}),o.by(fe.filter,ye.filter)||U.push({command:Ur.setFilter,args:[me,ye.filter]}),o.by(fe.minzoom,ye.minzoom)&&o.by(fe.maxzoom,ye.maxzoom)||U.push({command:Ur.setLayerZoomRange,args:[me,ye.minzoom,ye.maxzoom]}),fe)fe.hasOwnProperty(Pe)&&Pe!=="layout"&&Pe!=="paint"&&Pe!=="filter"&&Pe!=="metadata"&&Pe!=="minzoom"&&Pe!=="maxzoom"&&Pe!=="slot"&&(Pe.indexOf("paint.")===0?Ja(fe[Pe],ye[Pe],U,me,Pe.slice(6),Ur.setPaintProperty):o.by(fe[Pe],ye[Pe])||U.push({command:Ur.setLayerProperty,args:[me,Pe,ye[Pe]]}));for(Pe in ye)ye.hasOwnProperty(Pe)&&!fe.hasOwnProperty(Pe)&&Pe!=="layout"&&Pe!=="paint"&&Pe!=="filter"&&Pe!=="metadata"&&Pe!=="minzoom"&&Pe!=="maxzoom"&&Pe!=="slot"&&(Pe.indexOf("paint.")===0?Ja(fe[Pe],ye[Pe],U,me,Pe.slice(6),Ur.setPaintProperty):o.by(fe[Pe],ye[Pe])||U.push({command:Ur.setLayerProperty,args:[me,Pe,ye[Pe]]}))}else U.push({command:Ur.removeLayer,args:[me]}),Fe=ce[ce.lastIndexOf(me)+1],U.push({command:Ur.addLayer,args:[ye,Fe]})}(j,T.layers,I)}catch(k){console.warn("Unable to compute style diff:",k),I=[{command:Ur.setStyle,args:[T]}]}return I}(this.serialize(),t).filter(b=>!(b.command in Hv));if(d.length===0)return!1;const g=d.filter(b=>!(b.command in qv));if(g.length>0)throw new Error(`Unimplemented: ${g.map(b=>b.command).join(", ")}.`);const _=[];return d.forEach(b=>{_.push(this[b.command](...b.args))}),a&&Promise.all(_).then(a).catch(a),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(const[a,d]of t.entries()){if(this.getImage(a))return this.fire(new o.y(new Error(`An image with the name "${a.name}" already exists.`)));this.imageManager.addImage(a,this.scope,d),this._changes.updateImage(a,this.scope)}return this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this}addImage(t,a){return this.getImage(t)?this.fire(new o.y(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,a),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this)}updateImage(t,a,d=!1){this.imageManager.updateImage(t,this.scope,a),d&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new o.z("data",{dataType:"style"})),this}addModel(t,a,d={}){return this._checkLoaded(),this._validate(Te,`models.${t}`,a,null,d)||(this.modelManager.addModel(t,a,this.scope),this.fire(new o.z("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,a,d={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!a.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(a).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(a.type)>=0&&this._validate(Hu,`sources.${t}`,a,null,d))return;this.map&&this.map._collectResourceTiming&&(a.collectResourceTiming=!0);const g=Zu(t,a,this.dispatcher,this);g.scope=this.scope,g.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(g.id),source:g.serialize(),sourceId:g.id}));const _=b=>{const T=(b?"symbol:":"other:")+g.id,I=o.B(T,this.scope),k=this._sourceCaches[T]=new Ws(I,g,b);(b?this._symbolSourceCaches:this._otherSourceCaches)[g.id]=k,k.onAdd(this.map)};_(!1),a.type!=="vector"&&a.type!=="geojson"||_(!0),g.onAdd&&g.onAdd(this.map),d.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const a=this.getOwnSource(t);if(!a)throw new Error("There is no source with this ID");for(const g in this._layers)if(this._layers[g].source===t)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while layer "${g}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const g=Object.entries(this.stylesheet.iconsets).find(([_,b])=>b.type==="source"&&b.source===t);if(g)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while iconset "${g[0]}" is using it.`)))}const d=this.getOwnSourceCaches(t);for(const g of d){const _=o.dl(g.id);delete this._sourceCaches[_],this._changes.discardSourceCacheUpdate(g.id),g.fire(new o.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:g.getSource().id})),g.setEventedParent(null),g.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),a.setEventedParent(null),a.onRemove&&a.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,a){this._checkLoaded(),this.getOwnSource(t).setData(a),this._changes.setDirty()}getOwnSource(t){const a=this.getOwnSourceCache(t);return a&&a.getSource()}getOwnSources(){const t=[];for(const a in this._otherSourceCaches){const d=this.getOwnSourceCache(a);d&&t.push(d.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const a in t){const d=t[a]._tiles;for(const g in d){const _=d[g];if(_.state!=="loaded"&&_.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const a=this._getTransitionParameters();for(const _ of t){if(this._validate(fh,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){const b=this.ambientLight;b.set(_),b.updateTransitions(a)}else this.ambientLight=new Qr(_,Yi||(Yi=new o.a9({color:new o.aa(o.a6.properties_light_ambient.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const b=this.directionalLight;b.set(_),b.updateTransitions(a)}else this.directionalLight=new Qr(_,dn||(dn=new o.a9({direction:new o.ap(o.a6.properties_light_directional.direction),color:new o.aa(o.a6.properties_light_directional.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_directional.intensity),"cast-shadows":new o.aa(o.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new o.aa(o.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new o.aa(o.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const d=Object.assign(a,{worldview:this.map.getWorldview()}),g=new o.ac(this.z||0,d);this.ambientLight&&this.ambientLight.recalculate(g),this.directionalLight&&this.directionalLight.recalculate(g),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,a=this.ambientLight;if(!t||!a)return;const d=R=>.2126*(R[0]<=.03928?R[0]/12.92:Math.pow((R[0]+.055)/1.055,2.4))+.7152*(R[1]<=.03928?R[1]/12.92:Math.pow((R[1]+.055)/1.055,2.4))+.0722*(R[2]<=.03928?R[2]/12.92:Math.pow((R[2]+.055)/1.055,2.4)),g=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),_=t.properties.get("intensity"),b=t.properties.get("direction"),T=1-o.d3(b.x,b.y,b.z)[2]/90,I=d(g)*_*T,k=a.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),N=a.properties.get("intensity"),j=d(k)*N;return Number(((I+j)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(o.dm(t)){const a=o.dn(t),d=this.fragments.find(({id:_})=>_===a);if(!d)return;const g=o.dl(t);return d.style.getFragmentStyle(g)}{const a=this.fragments.find(({id:d})=>d===t);return a?a.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const a={},d=(g,_="")=>`${g}::${_}`;this._featuresetSelectors={};for(const g in t){const _=this._featuresetSelectors[g]=[];for(const b of t[g].selectors){if(b.featureNamespace){const I=this.getOwnLayer(b.layer);if(!I){o.w(`Layer is undefined for selector: ${b.layer}`);continue}const k=d(I.source,I.sourceLayer);if(k in a&&a[k]!==b.featureNamespace){o.w(`"featureNamespace ${b.featureNamespace} of featureset ${g}'s selector is not associated to the same source, skip this selector`);continue}a[k]=b.featureNamespace}let T;if(b.properties)for(const I in b.properties){const k=o.U(b.properties[I]);k.result==="success"&&(T=T||{},T[I]=k.value)}_.push({layerId:b.layer,namespace:b.featureNamespace,properties:T,uniqueFeatureID:b._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const a=this.getFragmentStyle(t);if(!a||!a.stylesheet.featuresets)return[];const d=[];for(const g in a.stylesheet.featuresets)d.push({featuresetId:g,importId:a.scope?a.scope:void 0});return d}getFeaturesetLayers(t,a){const d=this.getFragmentStyle(a),g=d.stylesheet.featuresets;if(!g||!g[t])return this.fire(new o.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const _=[];for(const b of g[t].selectors){const T=d.getOwnLayer(b.layer);T&&_.push(T)}return _}getConfigProperty(t,a){const d=this.getFragmentStyle(t);if(!d)return null;const g=o.B(a,d.scope),_=d.options.get(g),b=_?_.value||_.default:null;return b?b.serialize():null}setConfigProperty(t,a,d){const g=this.getFragmentStyle(t);if(!g)return;const _=g.stylesheet.schema;if(!_||!_[a])return;const b=o.U(d);if(b.result!=="success")return void Ul(this,b.value);const T=b.value.expression,I=o.B(a,g.scope),k=g.options.get(I);if(!k)return;let N;const{minValue:j,maxValue:R,stepValue:z,type:B,values:U}=_[a],Y=o.U(_[a].default);Y.result==="success"&&(N=Y.value.expression),N?(this.options.set(I,Object.assign({},k,{value:T,default:N,minValue:j,maxValue:R,stepValue:z,type:B,values:U})),this.updateConfigDependencies(a)):this.fire(new o.y(new Error(`No schema defined for the config option "${a}" in the "${t}" fragment.`)))}getConfig(t){const a=this.getFragmentStyle(t);if(!a)return null;const d=a.stylesheet.schema;if(!d)return null;const g={};for(const _ in d){const b=o.B(_,a.scope),T=a.options.get(b),I=T?T.value||T.default:null;g[_]=I?I.serialize():null}return g}setConfig(t,a){const d=this.getFragmentStyle(t);d&&(d.updateConfig(a,d.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const a=this.getFragmentStyle(t);return a?a.stylesheet.schema:null}setSchema(t,a){const d=this.getFragmentStyle(t);d&&(d.stylesheet.schema=a,d.updateConfig(d._config,a),this.updateConfigDependencies())}updateConfig(t,a){if(this._config=t,t||a)if(a)for(const d in a){let g,_;const b=o.U(a[d].default);if(b.result==="success"&&(g=b.value.expression),t&&t[d]!==void 0){const R=o.U(t[d]);R.result==="success"&&(_=R.value.expression)}const{minValue:T,maxValue:I,stepValue:k,type:N,values:j}=a[d];if(g){const R=o.B(d,this.scope);this.options.set(R,{default:g,value:_,minValue:T,maxValue:I,stepValue:k,type:N,values:j})}else this.fire(new o.y(new Error(`No schema defined for config option "${d}".`)))}else this.fire(new o.y(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const a of this._configDependentLayers){const d=this.getLayer(a);if(d){if(t&&!d.configDependencies.has(t))continue;d.possiblyEvaluateVisibility(),this._updateLayer(d)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(a=>{const d=a._styleColorTheme.colorThemeOverride?a._styleColorTheme.colorThemeOverride:a._styleColorTheme.colorTheme;if(d){const g=a._evaluateColorThemeData(d);(!a._styleColorTheme.lut&&g!==""||a._styleColorTheme.lut&&g!==a._styleColorTheme.lut.data)&&a.setColorTheme(d)}}),this._changes.setDirty()}addLayer(t,a,d={}){this._checkLoaded();const g=t.id;if(this._layers[g])return void this.fire(new o.y(new Error(`Layer with id "${g}" already exists on this map`)));let _;if(t.type==="custom"){if(Ul(this,o.dp(t)))return;_=o.dq(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(g,t.source),t=o.dk(t),t=Object.assign(t,{source:g})),this._validate(Re,`layers.${g}`,t,{arrayIndex:-1},d))return;_=o.dq(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(_),_.setEventedParent(this,{layer:{id:g}})}_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid);let b=this._order.length;if(a){const N=this._order.indexOf(a);if(N===-1)return void this.fire(new o.y(new Error(`Layer with id "${a}" does not exist on this map.`)));_.slot===this._layers[a].slot?b=N:o.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(b,0,g),this._layerOrderChanged=!0,this._layers[g]=_;const T=this.getOwnLayerSourceCache(_),I=!!this.directionalLight&&this.directionalLight.shadowsEnabled();T&&_.canCastShadows()&&I&&(T.castsShadows=!0);const k=this._changes.getRemovedLayer(_);if(k&&_.source&&T&&_.type!=="custom"){this._changes.discardLayerRemoval(_);const N=o.B(_.source,_.scope);k.type!==_.type?this._changes.updateSourceCache(N,"clear"):(this._changes.updateSourceCache(N,"reload"),T.pause())}this._updateLayer(_),_.onAdd&&_.onAdd(this.map),_.scope=this.scope,this.mergeLayers()}moveLayer(t,a){this._checkLoaded();const d=this._checkLayer(t);if(!d||t===a)return;const g=this._order.indexOf(t);this._order.splice(g,1);let _=this._order.length;if(a){const b=this._order.indexOf(a);if(b===-1)return void this.fire(new o.y(new Error(`Layer with id "${a}" does not exist on this map.`)));d.slot===this._layers[a].slot?_=b:o.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const a=this._checkLayer(t);if(!a)return;a.setEventedParent(null);const d=this._order.indexOf(t);this._order.splice(d,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(a.fqid),this._changes.removeLayer(a);const g=this.getOwnLayerSourceCache(a);if(g&&g.castsShadows){let _=!1;for(const b in this._layers)if(this._layers[b].source===a.source&&this._layers[b].canCastShadows()){_=!0;break}g.castsShadows=_}a.onRemove&&a.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const a in this._layers)if(this._layers[a].type===t)return!0;return!1}setLayerZoomRange(t,a,d){this._checkLoaded();const g=this._checkLayer(t);g&&(g.minzoom===a&&g.maxzoom===d||(a!=null&&(g.minzoom=a),d!=null&&(g.maxzoom=d),this._updateLayer(g)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,a){this._checkLoaded();const d=this._checkLayer(t);d&&d.slot!==a&&(d.slot=a,this._updateLayer(d))}setFilter(t,a,d={}){this._checkLoaded();const g=this._checkLayer(t);if(g&&!o.by(g.filter,a))return a==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(X,`layers.${g.id}.filter`,a,{layerType:g.type},d)||(g.filter=o.dk(a),this._updateLayer(g)))}getFilter(t){const a=this._checkLayer(t);if(a)return o.dk(a.filter)}setLayoutProperty(t,a,d,g={}){this._checkLoaded();const _=this._checkLayer(t);if(_&&!o.by(_.getLayoutProperty(a),d)){if(d!=null&&(!g||g.validate!==!1)&&Ul(_,he.call(Po,{key:`layers.${t}.layout.${a}`,layerType:_.type,objectKey:a,value:d,styleSpec:o.a6,style:{glyphs:!0,sprite:!0}})))return;_.setLayoutProperty(a,d),_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),this._updateLayer(_)}}getLayoutProperty(t,a){const d=this._checkLayer(t);if(d)return d.getLayoutProperty(a)}setPaintProperty(t,a,d,g={}){this._checkLoaded();const _=this._checkLayer(t);if(!_||o.by(_.getPaintProperty(a),d)||d!=null&&(!g||g.validate!==!1)&&Ul(_,Q.call(Po,{key:`layers.${t}.paint.${a}`,layerType:_.type,objectKey:a,value:d,styleSpec:o.a6})))return;const b=_.setPaintProperty(a,d);_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),b&&this._updateLayer(_),this._changes.updatePaintProperties(_)}getPaintProperty(t,a){const d=this._checkLayer(t);if(d)return d.getPaintProperty(a)}setFeatureState(t,a){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:I,importId:k}=t.target,N=this.getFragmentStyle(k),j=N.getFeaturesetLayers(I);for(const{source:R,sourceLayer:z}of j)N.setFeatureState({id:t.id,source:R,sourceLayer:z},a)}else if("layerId"in t.target){const{layerId:I}=t.target,k=this.getLayer(I);this.setFeatureState({id:t.id,source:k.source,sourceLayer:k.sourceLayer},a)}return}const d=t.source,g=t.sourceLayer,_=this._checkSource(d);if(!_)return;const b=_.type;if(b==="geojson"&&g)return void this.fire(new o.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(b==="vector"&&!g)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided.")));const T=this.getOwnSourceCaches(d);for(const I of T)I.setFeatureState(g,t.id,a)}removeFeatureState(t,a){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:I,importId:k}=t.target,N=this.getFragmentStyle(k),j=N.getFeaturesetLayers(I);for(const{source:R,sourceLayer:z}of j)N.removeFeatureState({id:t.id,source:R,sourceLayer:z},a)}else if("layerId"in t.target){const{layerId:I}=t.target,k=this.getLayer(I);this.removeFeatureState({id:t.id,source:k.source,sourceLayer:k.sourceLayer},a)}return}const d=t.source,g=this._checkSource(d);if(!g)return;const _=g.type,b=_==="vector"?t.sourceLayer:void 0;if(_==="vector"&&!b)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(a&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new o.y(new Error("A feature id is required to remove its specific state property.")));const T=this.getOwnSourceCaches(d);for(const I of T)I.removeFeatureState(b,t.id,a)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let _;if("featuresetId"in t.target){const{featuresetId:b,importId:T}=t.target,I=this.getFragmentStyle(T),k=I.getFeaturesetLayers(b);for(const{source:N,sourceLayer:j}of k){const R=I.getFeatureState({id:t.id,source:N,sourceLayer:j});if(R&&!_)_=R;else if(!o.by(_,R))return void this.fire(new o.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:b}=t.target,T=this.getLayer(b);_=this.getFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer})}return _}const a=t.source,d=t.sourceLayer,g=this._checkSource(a);if(g){if(g.type!=="vector"||d)return t.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(a)[0].getFeatureState(d,t.id);this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),a=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return o.dr({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:a,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},d=>d!==void 0)}_updateFilteredLayers(t){for(const a of Object.values(this._mergedLayers))t(a)&&this._updateLayer(a)}_updateLayer(t){this._changes.updateLayer(t);const a=this.getLayerSourceCache(t),d=o.B(t.source,t.scope),g=this._changes.getUpdatedSourceCaches();t.source&&!g[d]&&a&&a.getSource().type!=="raster"&&(this._changes.updateSourceCache(d,"reload"),a.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const a=T=>this._mergedLayers[T].is3D(!!this.terrain),d=this.order,g={},_=[];for(let T=d.length-1;T>=0;T--){const I=d[T];if(a(I)){g[I]=T;for(const k of t){const N=k[I];if(N)for(const j of N)_.push(j)}}}_.sort((T,I)=>I.intersectionZ-T.intersectionZ);const b=[];for(let T=d.length-1;T>=0;T--){const I=d[T];if(a(I))for(let k=_.length-1;k>=0;k--){const N=_[k].feature;if(N.layer&&g[N.layer.id]<T)break;b.push(N),_.pop()}else for(const k of t){const N=k[I];if(N)for(const j of N)b.push(j.feature)}}return b}queryRasterValue(t,a,d){const g=this.getOwnSource(t);return g?g.type!=="raster-array"?(this.fire(new o.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):g.queryRasterArrayValue(a,d):(this.fire(new o.y(new Error(`Source with id "${t}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(t,a,d){let g;a&&!Array.isArray(a)&&a.filter&&(this._validate(X,"queryRenderedFeatures.filter",a.filter,null,a),g=o.b6(a.filter));const _={},b=N=>{if(Mh.has(N.type))return;const j=this.getOwnLayerSourceCache(N),R=_[j.id]=_[j.id]||{sourceCache:j,layers:{},has3DLayers:!1};N.is3D(!!this.terrain)&&(R.has3DLayers=!0),R.layers[N.fqid]=R.layers[N.fqid]||{styleLayer:N,targets:[]},R.layers[N.fqid].targets.push({filter:g})};if(a&&a.layers){if(!Array.isArray(a.layers))return this.fire(new o.y(new Error("parameters.layers must be an Array."))),[];for(const N of a.layers){const j=this._layers[N];if(!j)return this.fire(new o.y(new Error(`The layer '${N}' does not exist in the map's style and cannot be queried for features.`))),[];b(j)}}else for(const N in this._layers)b(this._layers[N]);const T=this._queryRenderedFeatures(t,_,d),I=this._flattenAndSortRenderedFeatures(T),k=[];for(const N of I)o.ds(N.layer.id)===this.scope&&k.push(N);return k}queryRenderedFeatureset(t,a,d){let g;a&&!Array.isArray(a)&&a.filter&&(this._validate(X,"queryRenderedFeatures.filter",a.filter,null,a),g=o.b6(a.filter));const _="mock",b=[];if(a&&a.target)b.push(Object.assign({},a,{targetId:_,filter:g}));else{const N=this.getFeaturesetDescriptors();for(const j of N)b.push({targetId:_,filter:g,target:j});for(const{style:j}of this.fragments){const R=j.getFeaturesetDescriptors();for(const z of R)b.push({targetId:_,filter:g,target:z})}}const T=this.queryRenderedTargets(t,b,d),I=[],k=new Set;for(const N of T)for(const j of N.variants[_])Ya(j,N,k)||I.push(new o.dt(N,j));return I}queryRenderedTargets(t,a,d){const g={},_=(T,I,k,N)=>{const j=g[I.id]=g[I.id]||{sourceCache:I,layers:{},has3DLayers:!1};if(j.layers[T.fqid]=j.layers[T.fqid]||{styleLayer:T,targets:[]},T.is3D(!!this.terrain)&&(j.has3DLayers=!0),!N)return k.uniqueFeatureID=!1,void j.layers[T.fqid].targets.push(k);j.layers[T.fqid].targets.push(Object.assign({},k,{namespace:N.namespace,properties:N.properties,uniqueFeatureID:N.uniqueFeatureID}))};for(const T of a)if("featuresetId"in T.target){const{featuresetId:I,importId:k}=T.target,N=this.getFragmentStyle(k);if(!N||!N._featuresetSelectors)continue;const j=N._featuresetSelectors[I];if(!j){this.fire(new o.y(new Error(`The featureset '${I}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const R of j){const z=N.getOwnLayer(R.layerId);z&&!Mh.has(z.type)&&_(z,N.getOwnLayerSourceCache(z),T,R)}}else if("layerId"in T.target){const{layerId:I}=T.target,k=this.getLayer(I);if(!k||Mh.has(k.type))continue;_(k,this.getLayerSourceCache(k),T)}const b=this._queryRenderedFeatures(t,g,d);return this._flattenAndSortRenderedFeatures(b)}_queryRenderedFeatures(t,a,d){const g=[],_=!!this.map._showQueryGeometry,b=Wi.createFromScreenPoints(t,d);for(const T in a){const I=Yu(b,a[T],this._availableImages,d,_);Object.keys(I).length&&g.push(I)}if(this.placement)for(const T in a){if(!a[T].sourceCache._onlySymbols)continue;const I=Bp(b.screenGeometry,a[T],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(I).length&&g.push(I)}return g}querySourceFeatures(t,a){const d=a&&a.filter;d&&this._validate(X,"querySourceFeatures.filter",d,null,a);let g=[];const _=this.getOwnSourceCaches(t);for(const b of _)g=g.concat(Qo(b,a));return g}addSourceType(t,a,d){return mo.getSourceType(t)?d(new Error(`A source type called "${t}" already exists.`)):(mo.setSourceType(t,a),a.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:a.workerSourceURL},d):d(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,a,d={}){this._checkLoaded();const g=this.light.getLight();let _=!1;for(const T in t)if(!o.by(t[T],g[T])){_=!0;break}if(!_)return;const b=this._getTransitionParameters();this.light.setLight(t,a,d),this.light.updateTransitions(b)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=o.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&o.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,a=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),a===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let d=t;const g=t.source==null;if(a===1){if(this.disableElevatedTerrain)return;if(typeof d.source=="object"){const T="terrain-dem-src";this.addSource(T,d.source),d=o.dk(d),d=Object.assign(d,{source:T})}const _=Object.assign({},d),b={};if(this.terrain&&g){_.source=this.terrain.get().source;const T=this.terrain?this.getFragmentStyle(this.terrain.scope):null;T&&(b.style=T.serialize())}if(this._validate(ft,"terrain",_,b))return}if(!this.terrain||this.terrain.scope!==this.scope&&!g||this.terrain&&a!==this.terrain.drapeRenderMode){if(!d)return;this._createTerrain(d,a),this.fire(new o.z("data",{dataType:"style"}))}else{const _=this.terrain,b=_.get();for(const T of Object.keys(o.a6.terrain))!d.hasOwnProperty(T)&&o.a6.terrain[T].default&&(d[T]=o.a6.terrain[T].default);for(const T in t)if(!o.by(t[T],b[T])){_.set(t,this.options),this.stylesheet.terrain=t;const I=this._getTransitionParameters({duration:0});_.updateTransitions(I),this.fire(new o.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const a=this.fog=new zr(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=a.get();const d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}_createSnow(t){const a=this.snow=new hn(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=a.get();const d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}_createRain(t){const a=this.rain=new fi(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=a.get();const d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const a=this.fog;if(!o.by(a.get(),t)){a.set(t,this.options),this.stylesheet.fog=a.get();const d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const a=this.snow;if(!o.by(a.get(),t)){a.set(t,this.options),this.stylesheet.snow=a.get();const d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const a=this.rain;if(!o.by(a.get(),t)){a.set(t,this.options),this.stylesheet.rain=a.get();const d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const g in this._layers)this._layers[g].lut=this._styleColorTheme.lut;for(const g in this._sourceCaches)this._sourceCaches[g].clearTiles()},a=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!a)return this._styleColorTheme.lut=null,void t();const d=this._evaluateColorThemeData(a);this._loadColorTheme(d).then(()=>{this.fire(new o.z("colorthemeset")),t()}).catch(g=>{o.w(`Couldn't set color theme: ${g}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&o.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,a){const d=this.getFragmentStyle(t);d&&(d._styleColorTheme.colorThemeOverride=a,d._reloadColorTheme())}_getTransitionParameters(t){return{now:o.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],a=[];for(const d of this._mergedOrder)this.isLayerDraped(this._mergedLayers[d])?t.push(d):a.push(d);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...a)}_createTerrain(t,a){const d=this.terrain=new qe(t,a,this.scope,this.options,this.map.getWorldview());a===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const g=this._getTransitionParameters({duration:0});d.updateTransitions(g)}_force3DLayerUpdate(){for(const t in this._layers){const a=this._layers[t];a.type==="fill-extrusion"&&this._updateLayer(a)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const a=this._layers[t];a.type==="symbol"&&this._updateLayer(a)}}_validate(t,a,d,g,_={}){if(_&&_.validate===!1)return!1;const b=Object.assign({},this.serialize());return Ul(this,t.call(Po,Object.assign({key:a,style:b,value:d,styleSpec:o.a6},g)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.du.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const a=this.getSourceCaches(t);for(const d of a)d.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(const t in this._mergedLayers){const a=this._mergedLayers[t];a._clear&&a._clear()}}reloadSource(t){const a=this.getSourceCaches(t);for(const d of a)d.resume(),d.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let a;this.directionalLight&&(a=Oc(this.directionalLight));const d=new Set;for(const g in this._mergedLayers){const _=this._mergedLayers[g];_.hasElevation()&&!d.has(_.source)&&d.add(_.source)}for(const g in this._mergedSourceCaches){const _=this._mergedSourceCaches[g],b=d.has(_._source.id);_.update(t,void 0,void 0,a,b)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const a=this._sourceCaches[t];a.resume(),a.reload()}}_updatePlacement(t,a,d,g,_,b,T=!1){let I=!1,k=!1;const N={},j={};for(const R of this._mergedOrder){const z=this._mergedLayers[R];if(z.type!=="symbol")continue;const B=o.B(z.source,z.scope);let U=N[B];if(!U){const H=this.getLayerSourceCache(z);if(!H)continue;const K=H.getRenderableIds(!0).map(ne=>H.getTileByID(ne));j[B]=K.slice(),U=N[B]=K.sort((ne,ce)=>ce.tileID.overscaledZ-ne.tileID.overscaledZ||(ne.tileID.isLessThan(ce.tileID)?-1:1))}const Y=this.crossTileSymbolIndex.addLayer(z,U,a.center.lng,a.projection);I=I||Y}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),T=T||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new o.z("neworder")),(T||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.o.now(),a.zoom))&&(this.pauseablePlacement=new fs(a,this._mergedOrder,T,d,g,_,this.placement,this.fog&&a.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,N,j,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.o.now()),k=!0),I&&this.pauseablePlacement.placement.setStale()),k||I){this._buildingIndex.onNewFrame(a.zoom);for(let R=0;R<this._mergedOrder.length;R++){const z=this._mergedLayers[this._mergedOrder[R]];if(z.type!=="symbol")continue;const B=this.isLayerClipped(z);this.placement.updateLayerOpacities(z,N[o.B(z.source,z.scope)],R,B?b:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.o.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,a){this._checkLoaded();const d=this.stylesheet.imports=this.stylesheet.imports||[];if(d.findIndex(({id:_})=>_===t.id)!==-1)return void this.fire(new o.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!a)return d.push(t),this._loadImports([t],!0);const g=d.findIndex(({id:_})=>_===a);return g===-1&&this.fire(new o.y(new Error(`Import with id "${a}" does not exist on this map.`))),this.stylesheet.imports=d.slice(0,g).concat(t).concat(d.slice(g)),this._loadImports([t],!0,a)}updateImport(t,a){this._checkLoaded();const d=this.stylesheet.imports||[],g=this.getImportIndex(t);return g===-1?this:typeof a=="string"?(this.setImportUrl(t,a),this):(a.url&&a.url!==d[g].url&&this.setImportUrl(t,a.url),o.by(a.config,d[g].config)||this.setImportConfig(t,a.config,a.data.schema),o.by(a.data,d[g].data)||this.setImportData(t,a.data),this)}moveImport(t,a){this._checkLoaded();let d=this.stylesheet.imports||[];const g=this.getImportIndex(t);if(g===-1)return this;const _=this.getImportIndex(a);if(_===-1)return this;const b=d[g],T=this.fragments[g];return d=d.filter(({id:I})=>I!==t),this.fragments=this.fragments.filter(({id:I})=>I!==t),this.stylesheet.imports=d.slice(0,_).concat(b).concat(d.slice(_)),this.fragments=this.fragments.slice(0,_).concat(T).concat(this.fragments.slice(_)),this.mergeLayers(),this}setImportUrl(t,a){this._checkLoaded();const d=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;d[g].url=a;const _=this.fragments[g];return _.style=this._createFragmentStyle(d[g]),_.style.on("style.import.load",()=>this.mergeAll()),_.style.loadURL(a),this}setImportData(t,a){this._checkLoaded();const d=this.getImportIndex(t),g=this.stylesheet.imports||[];return d===-1?this:a?(this.fragments[d].style.setState(a),this._reloadImports(),this):(delete g[d].data,this.setImportUrl(t,g[d].url))}setImportConfig(t,a,d){this._checkLoaded();const g=this.getImportIndex(t),_=this.stylesheet.imports||[];if(g===-1)return this;a?_[g].config=a:delete _[g].config;const b=this.fragments[g];d&&b.style.stylesheet&&(b.style.stylesheet.schema=d);const T=b.style.stylesheet&&b.style.stylesheet.schema;return b.config=a,b.style.updateConfig(a,T),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const a=this.stylesheet.imports||[],d=this.getImportIndex(t);d!==-1&&(a.splice(d,1),this.fragments[d].style._remove(),this.fragments.splice(d,1),this._reloadImports())}getImportIndex(t){const a=(this.stylesheet.imports||[]).findIndex(d=>d.id===t);return a===-1&&this.fire(new o.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),a}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const a in this._mergedOtherSourceCaches){const d=this._mergedOtherSourceCaches[a];d&&t.push(d.getSource())}return t}getSource(t,a){const d=this.getSourceCache(t,a);return d&&d.getSource()}getLayerSource(t){const a=this.getLayerSourceCache(t);return a&&a.getSource()}getSourceCache(t,a){const d=o.B(t,a);return this._mergedOtherSourceCaches[d]}getLayerSourceCache(t){const a=o.B(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[a]:this._mergedOtherSourceCaches[a]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const a=[];return this._mergedOtherSourceCaches[t]&&a.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&a.push(this._mergedSymbolSourceCaches[t]),a}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const a in t){const d=t[a];d==="reload"?this.reloadSource(a):d==="clear"&&this.clearSource(a)}}updateLayers(t){const a=this._changes.getUpdatedPaintProperties();for(const d of a){const g=this.getLayer(d);g&&g.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,a,d){this.imageManager.getImages(a.images,a.scope,d),this._updateTilesForChangedImages();const g=b=>{if(b){const T=a.images.map(I=>o.I.toString(I));b.setDependencies(a.tileID.key,a.type,T)}},_=o.B(a.source,a.scope);g(this._mergedOtherSourceCaches[_]),g(this._mergedSymbolSourceCaches[_]),a.images.some(b=>b.iconsetId)&&this.fire(new o.z("data",{dataType:"style"}))}rasterizeImages(t,a,d){this.imageManager.rasterizeImages(a,d)}getGlyphs(t,a,d){this.glyphManager.getGlyphs(a.stacks,d)}getResource(t,a,d){return o.dv(a,d)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const a=[];return this._otherSourceCaches[t]&&a.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&a.push(this._symbolSourceCaches[t]),a}_isSourceCacheLoaded(t){const a=this.getOwnSourceCaches(t);return a.length===0?(this.fire(new o.y(new Error(`There is no source with ID '${t}'`))),!1):a.every(d=>d.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,a){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const d=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),g=t.type==="building";if(t.is3D(!!this.terrain)){if(d||g||a&&a.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}mo.getSourceType=function(h){return Cc[h]},mo.setSourceType=function(h,t){Cc[h]=t},mo.registerForPluginStateChange=o.dw;class n0{execute(t){const a=this._makeBuildingsQueryArea(t),d=this._makeFloorsQueryArea(t),g=t.queryRenderedFeatures(a).reduce((k,N)=>{const j=N.properties.id;return N.properties.type!=="building"||k.some(R=>R.properties.id===j)||k.push(N),k},[]),_=t.queryRenderedFeatures(d).reduce((k,N)=>{const j=N.properties.id;return N.properties.type!=="floor"||k.some(R=>R.properties.id===j)||k.push(N),k},[]),b=[t.getCenter().lng,t.getCenter().lat],T=this._findBuildingAtCenter(b,g),I=g.length>0?g[0]:null;return{floors:_.map(k=>({id:k.properties.id,name:k.properties.name,isDefault:k.properties.is_default,zIndex:k.properties.z_index,connectedFloorIds:k.properties.connected_floor_ids,conflictedFloorIds:k.properties.conflicted_floor_ids,buildingIds:k.properties.building_ids})),building:T?{id:T.properties.id,name:T.properties.name}:{id:I.properties.id,name:I.properties.name}}}_makeBuildingsQueryArea(t){const a=t.transform.width,d=t.transform.height,g=Math.min(a,d)*(1/8),_=.5*(a-g),b=.5*(d-g);return[new o.P(_,b),new o.P(_+g,b+g)]}_makeFloorsQueryArea(t){const a=t.transform.width,d=t.transform.height;return[new o.P(0,0),new o.P(a,d)]}_findBuildingAtCenter(t,a){for(const d of a)if(d.geometry.type==="Polygon"&&this._pointInPolygon(t,d.geometry.coordinates[0]))return d;return null}_pointInPolygon(t,a){let d=!1;for(let g=0,_=a.length-1;g<a.length;_=g++){const b=a[g][0],T=a[g][1],I=a[_][1];T>t[1]!=I>t[1]&&t[0]<(a[_][0]-b)*(t[1]-T)/(I-T)+b&&(d=!d)}return d}}class s0{constructor(){this._floors=new Map,this._buildings=new Map}append(t){const a=t.building;let d=!1;if(a){const g=a.id;g&&(this._buildings.set(g,a),d||this._buildings.has(g)||(d=!0))}return t.floors.forEach(g=>{const _=g.id;d||this._floors.has(_)||(d=!0),this._floors.set(_,g)}),d}clear(){this._floors.clear(),this._buildings.clear()}getFloors(t=null){const a=Array.from(this._floors.values());return t?a.filter(d=>{const g=d.buildingIds;return!!g&&g.split(";").includes(t)}):a}}class o0{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._lastActiveFloors=[],this._featuresStorage=new s0}setIndoorData(t){const a=this._featuresStorage.append(t);return this._selectedBuildingId=t.building?t.building.id:null,a}setFloorId(t){const a=this._selectedFloorId!==t;return a&&(this._selectedFloorId=t),a}getCurrentBuildingSelection(){if(!this._selectedBuildingId)return{selectedFloorId:null,floors:[]};const t=this._featuresStorage.getFloors(this._selectedBuildingId),a=this.getActiveFloors().find(d=>{const g=d.buildingIds;if(!g)return!1;const _=g.split(";");return!!this._selectedBuildingId&&_.includes(this._selectedBuildingId)});return{selectedFloorId:a?a.id:null,floors:t}}getActiveFloors(t=!1){const a=this._featuresStorage.getFloors(),d=a.find(I=>I.id===this._selectedFloorId),g=a.filter(I=>I.isDefault===!0);let _=[];if(d)return _=this._calculateCurrentActiveFloors(a,d,g,t),_;if(g.length===0){const I=this._featuresStorage.getFloors(this._selectedBuildingId);_=I.length>0?[I[0]]:[]}else _=g;const b=this._getNonConflictingLastActiveFloors(_),T=[..._,...b];return this._lastActiveFloors=T,T}hasBuildingChanged(t){return this._selectedBuildingId!==(t.building?t.building.id:null)}hasActiveBuilding(){return this._selectedBuildingId!==null}isEmpty(){return this._selectedFloorId===null&&this._selectedBuildingId===null&&this._lastActiveFloors.length===0}_calculateCurrentActiveFloors(t,a,d,g){if(!a)return this._getNonConflictingDefaultFloors(this._lastActiveFloors,d);const _=this._getConnectedFloors(a,t);return g?this._buildExplicitSelectionFloors(a,_,d):this._buildImplicitSelectionFloors(_,d)}_getConnectedFloors(t,a){const d=t.connectedFloorIds;if(!d)return[];const g=new Set(d.split(";"));return a.filter(_=>g.has(_.id))}_buildExplicitSelectionFloors(t,a,d){const g=[t,...a],_=this._getNonConflictingLastActiveFloors(g),b=[...g,..._],T=this._deduplicateFloors(b),I=this._getConflictingFloorIdsFrom(T),k=d.filter(j=>!I.has(j.id)),N=[...T,...k];return this._lastActiveFloors=N,N}_buildImplicitSelectionFloors(t,a){const d=this._getConflictingFloorIdsFrom(this._lastActiveFloors),g=a.filter(b=>!d.has(b.id)),_=this._deduplicateFloors([...this._lastActiveFloors,...g]);return this._lastActiveFloors=_,_}_getNonConflictingDefaultFloors(t,a){const d=this._getConflictingFloorIdsFrom(t),g=a.filter(b=>!d.has(b.id)),_=this._deduplicateFloors([...t,...g]);return this._lastActiveFloors=_,_}_deduplicateFloors(t){const a=new Set;return t.filter(d=>{const g=d.id;return!a.has(g)&&(a.add(g),!0)})}_getConflictingFloorIdsFrom(t){const a=new Set;return t.forEach(d=>{const g=d.conflictedFloorIds;g&&g.split(";").forEach(_=>a.add(_))}),a}_getNonConflictingLastActiveFloors(t){if(!this._lastActiveFloors||this._lastActiveFloors.length===0)return[];const a=new Set(t.map(g=>g.id)),d=this._getConflictingFloorIdsFrom(t);return this._lastActiveFloors.filter(g=>{const _=g.id;return!a.has(_)&&!d.has(_)})}_isFloorConflicted(t,a){const d=t.id;return a.some(g=>{const _=g.conflictedFloorIds;return!!_&&_.split(";").includes(d)})}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._lastActiveFloors=[],this._featuresStorage.clear()}}class Vl extends o.E{constructor(t){super(),o.aY(["_onLoad","_onMove"],this),this._map=t,this._floorSelectionState=new o0,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.off("load",this._onLoad),this._map.off("move",this._onMove),this._map=null,this._floorSelectionState=null}selectFloor(t){this._floorSelectionState.setFloorId(t)&&this._updateIndoorConfig(!0)}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new o.y(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=t.scope,this._indoorDataQuery=new n0))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<15)return void this._clearIndoorData();const t=this._indoorDataQuery.execute(this._map);if(!t||t.floors.length===0||this._map.transform.zoom<16)this._clearIndoorData();else if(this._floorSelectionState.hasBuildingChanged(t)){if(!t.building&&this._floorSelectionState.getActiveFloors().length<=0)return void this._clearIndoorData();this._setIndoorData(t),t.building&&this._updateIndoorSelector()}else this._setIndoorData(t)}_setIndoorData(t){this._floorSelectionState.setIndoorData(t)&&this._updateIndoorConfig()}_clearIndoorData(){this._floorSelectionState.isEmpty()||(this._floorSelectionState.reset(),this._updateIndoorSelector(),this._map.setConfigProperty(this._scope,"activeFloors",["literal",[]]))}_updateIndoorSelector(){const t=this._floorSelectionState.getCurrentBuildingSelection(),a=t.floors.map(d=>({id:d.id,name:d.name,shortName:d.zIndex.toString(),levelOrder:d.zIndex}));this.fire(new o.z("indoorupdate",{selectedFloorId:t.selectedFloorId,floors:a}))}_updateIndoorConfig(t=!1){const a=this._floorSelectionState.getActiveFloors(t).map(d=>d.id)||[];this._map.setConfigProperty(this._scope,"activeFloors",["literal",a])}}var ud=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,em=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,tm=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,jc="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",zc=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,rm=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Rh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Ks=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Lh=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,vt=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,im=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Fc=[];go(ud,Fc),go(tm,Fc),go(em,Fc);const Bc={"_prelude_fog.vertex.glsl":rm,"_prelude_terrain.vertex.glsl":zc,"_prelude_shadow.vertex.glsl":vt,"_prelude_fog.fragment.glsl":Rh,"_prelude_shadow.fragment.glsl":im,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":Ks,"_prelude_raster_particle.glsl":Lh},dd={};Or("",zc),Or(Rh,rm),Or(im,vt),Or(Ks,""),Or(Lh,"");const hd=Or(em,tm),ta=ud;var Oh={background:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:Or(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:Or(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Or("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Or(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Or(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Or("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Or("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Or("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:Or(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Or(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:Or(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Or(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Or(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Or(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:Or("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:Or("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Or(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Or(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:Or("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Or(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,jc),skyboxGradient:Or(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,jc),skyboxCapture:Or(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Or(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Or(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Or(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Or(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:Or("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:Or("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:Or("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Or("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function go(h,t){const a=h.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let d of a)if(d=d.trim(),d[0]==="#"&&d.includes("if")&&!d.includes("endif")){d=d.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const g=d.split(" ");for(const _ of g)t.includes(_)||t.push(_)}}function Or(h,t){const a=/#include\s+"([^"]+)"/g,d=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,g={},_=[],b=[];if(h=h.replace(a,(I,k)=>(b.push(k),"")),(t=t.replace(a,(I,k)=>(_.push(k),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let T=[...Fc];go(h,T),go(t,T);for(const I of[..._,...b])Bc[I]||console.error(`Undefined include: ${I}`),dd[I]||(dd[I]=[],go(Bc[I],dd[I])),T=[...T,...dd[I]];return{fragmentSource:h=h.replace(d,(I,k,N,j,R)=>(g[R]=!0,k==="define"?`
#ifndef HAS_UNIFORM_u_${R}
in ${N} ${j} ${R};
#else
uniform ${N} ${j} u_${R};
#endif
`:k==="initialize"?`
#ifdef HAS_UNIFORM_u_${R}
    ${N} ${j} ${R} = u_${R};
#endif
`:k==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    in ${N} ${j} ${R};
#endif
`:k==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(d,(I,k,N,j,R)=>{const z=j==="float"?"vec2":j,B=R.match(/color/)?"color":z;return k==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${R}
in ${N} ${j} a_${R};
#endif
`:g[R]?k==="define"?`
#ifndef HAS_UNIFORM_u_${R}
uniform lowp float u_${R}_t;
in ${N} ${z} a_${R};
out ${N} ${j} ${R};
#else
uniform ${N} ${j} u_${R};
#endif
`:k==="initialize"?B==="vec4"?`
#ifndef HAS_UNIFORM_u_${R}
    ${R} = a_${R};
#else
    ${N} ${j} ${R} = u_${R};
#endif
`:`
#ifndef HAS_UNIFORM_u_${R}
    ${R} = unpack_mix_${B}(a_${R}, u_${R}_t);
#else
    ${N} ${j} ${R} = u_${R};
#endif
`:k==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    in ${N} ${j} a_${R};
    out ${N} ${j} ${R};
#endif
`:k==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    ${R} = a_${R};
#endif
`:void 0:k==="define"?`
#ifndef HAS_UNIFORM_u_${R}
uniform lowp float u_${R}_t;
in ${N} ${z} a_${R};
#else
uniform ${N} ${j} u_${R};
#endif
`:k==="define-instanced"?B==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${R}0;
in vec4 a_${R}1;
in vec4 a_${R}2;
in vec4 a_${R}3;
#else
uniform ${N} ${j} u_${R};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${N} ${z} a_${R};
#else
uniform ${N} ${j} u_${R};
#endif
`:k==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    ${N} ${j} ${R} = a_${R};
#endif
`:B==="vec4"?`
#ifndef HAS_UNIFORM_u_${R}
    ${N} ${j} ${R} = a_${R};
#else
    ${N} ${j} ${R} = u_${R};
#endif
`:`
#ifndef HAS_UNIFORM_u_${R}
    ${N} ${j} ${R} = unpack_mix_${B}(a_${R}, u_${R}_t);
#else
    ${N} ${j} ${R} = u_${R};
#endif
`}),usedDefines:T,vertexIncludes:_,fragmentIncludes:b}}class Uc{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,a,d,g,_,b,T,I){this.context=t;let k=this.boundPaintVertexBuffers.length!==g.length;for(let j=0;!k&&j<g.length;j++)this.boundPaintVertexBuffers[j]!==g[j]&&(k=!0);let N=this.boundDynamicVertexBuffers.length!==T.length;for(let j=0;!N&&j<T.length;j++)this.boundDynamicVertexBuffers[j]!==T[j]&&(N=!0);if(!this.vao||this.boundProgram!==a||this.boundLayoutVertexBuffer!==d||k||N||this.boundIndexBuffer!==_||this.boundVertexOffset!==b)this.freshBind(a,d,g,_,b,T,I);else{t.bindVertexArrayOES.set(this.vao);for(const j of T)j&&(j.bind(),I&&j.instanceCount&&j.setVertexAttribDivisor(t.gl,a,I));_&&_.dynamicDraw&&_.bind()}}freshBind(t,a,d,g,_,b,T){const I=this.context,k=I.gl;this.vao&&this.destroy(),this.vao=I.gl.createVertexArray(),I.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=a,this.boundPaintVertexBuffers=d,this.boundIndexBuffer=g,this.boundVertexOffset=_,this.boundDynamicVertexBuffers=b,a.enableAttributes(k,t),a.bind(),a.setVertexAttribPointers(k,t,_);for(const N of d)N.enableAttributes(k,t),N.bind(),N.setVertexAttribPointers(k,t,_);for(const N of b)N&&(N.enableAttributes(k,t),N.bind(),N.setVertexAttribPointers(k,t,_),T&&N.instanceCount&&N.setVertexAttribDivisor(k,t,T));g&&g.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Wv(h,t){const a=Math.pow(2,t.canonical.z),d=t.canonical.y;return[new o.ae(0,d/a).toLngLat().lat,new o.ae(0,(d+1)/a).toLngLat().lat]}function Zv(h,t,a,d,g,_,b){const T=h.context,I=T.gl,k=a.hillshadeFBO;if(!k)return;h.prepareDrawTile();const N=h.isTileAffectedByFog(t),j=h.getOrCreateProgram("hillshade",{overrideFog:N});T.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,k.colorAttachment.get());const R=((Y,H,K,ne)=>{const ce=K.paint.get("hillshade-shadow-color"),ge=K.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",pe=K.paint.get("hillshade-highlight-color"),_e=K.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",me=K.paint.get("hillshade-accent-color"),fe=K.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",ye=K.paint.get("hillshade-emissive-strength");let Fe=o.an(K.paint.get("hillshade-illumination-direction"));if(K.paint.get("hillshade-illumination-anchor")==="viewport")Fe-=Y.transform.angle;else if(Y.style&&Y.style.enable3dLights()&&Y.style.directionalLight){const Ze=Y.style.directionalLight.properties.get("direction"),De=o.d3(Ze.x,Ze.y,Ze.z);Fe=o.an(De[1])}const Pe=!Y.options.moving;return{u_matrix:ne||Y.transform.calculateProjMatrix(H.tileID.toUnwrapped(),Pe),u_image:0,u_latrange:Wv(0,H.tileID),u_light:[K.paint.get("hillshade-exaggeration"),Fe],u_shadow:ce.toPremultipliedRenderColor(ge?null:K.lut),u_highlight:pe.toPremultipliedRenderColor(_e?null:K.lut),u_emissive_strength:ye,u_accent:me.toPremultipliedRenderColor(fe?null:K.lut)}})(h,a,d,h.terrain?t.projMatrix:null);h.uploadCommonUniforms(T,j,t.toUnwrapped());const{tileBoundsBuffer:z,tileBoundsIndexBuffer:B,tileBoundsSegments:U}=h.getTileBoundsBuffers(a);j.draw(h,I.TRIANGLES,g,_,b,ir.disabled,R,d.id,z,B,U)}function Dh(h,t,a){if(!t.needsDEMTextureUpload)return;const d=h.context,g=d.gl;d.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||h.getTileTexture(a.stride);const _=a.getPixels();t.demTexture?t.demTexture.update(_,{premultiply:!1}):t.demTexture=new o.T(d,_,g.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function Xv(h,t,a){const d=h.context,g=d.gl;if(!t.dem)return;const _=t.dem;if(d.activeTexture.set(g.TEXTURE1),Dh(h,t,_),!t.demTexture)return;t.demTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE);const b=_.dim;d.activeTexture.set(g.TEXTURE0);let T=t.hillshadeFBO;if(!T){const R=new o.T(d,{width:b,height:b,data:null},g.RGBA8);R.bind(g.LINEAR,g.CLAMP_TO_EDGE),T=t.hillshadeFBO=d.createFramebuffer(b,b,!0,"renderbuffer"),T.colorAttachment.set(R.texture)}d.bindFramebuffer.set(T.framebuffer),d.viewport.set([0,0,b,b]);const{tileBoundsBuffer:I,tileBoundsIndexBuffer:k,tileBoundsSegments:N}=h.getMercatorTileBoundsBuffers(),j=[];h.linearFloatFilteringSupported()&&j.push("TERRAIN_DEM_FLOAT_FORMAT"),h.getOrCreateProgram("hillshadePrepare",{defines:j}).draw(h,g.TRIANGLES,At.disabled,Jt.disabled,vr.unblended,ir.disabled,((R,z)=>{const B=z.stride,U=o.bC();return o.cd(U,0,o.al,-o.al,0,0,1),o.br(U,U,[0,-o.al,0]),{u_matrix:U,u_image:1,u_dimension:[B,B],u_zoom:R.overscaledZ}})(t.tileID,_),a.id,I,k,N),t.needsHillshadePrepare=!1}class zi{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class a0 extends zi{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const a=this.current;(t.r!==a.r||t.g!==a.g||t.b!==a.b||t.a!==a.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class nm extends zi{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Yv extends zi{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Kv extends zi{getDefault(){return[!0,!0,!0,!0]}set(t){const a=this.current;(t[0]!==a[0]||t[1]!==a[1]||t[2]!==a[2]||t[3]!==a[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Jv extends zi{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Qv extends zi{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class l0 extends zi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const a=this.current;(t.func!==a.func||t.ref!==a.ref||t.mask!==a.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class eb extends zi{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const a=this.current;(t[0]!==a[0]||t[1]!==a[1]||t[2]!==a[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class jh extends zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;t?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),this.current=t,this.dirty=!1}}class tb extends zi{getDefault(){return[0,1]}set(t){const a=this.current;(t[0]!==a[0]||t[1]!==a[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class c0 extends zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;t?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.current=t,this.dirty=!1}}class sm extends zi{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class zh extends zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;t?a.enable(a.BLEND):a.disable(a.BLEND),this.current=t,this.dirty=!1}}class om extends zi{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const a=this.current;(t[0]!==a[0]||t[1]!==a[1]||t[2]!==a[2]||t[3]!==a[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class $l extends zi{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const a=this.current;(t.r!==a.r||t.g!==a.g||t.b!==a.b||t.a!==a.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Vc extends zi{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Fh extends zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;t?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),this.current=t,this.dirty=!1}}class Bh extends zi{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class $c extends zi{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let u0=class extends zi{getDefault(){return null}set(h){(h!==this.current||this.dirty)&&(this.gl.useProgram(h),this.current=h,this.dirty=!1)}};class am extends zi{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class d0 extends zi{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const a=this.current;(t[0]!==a[0]||t[1]!==a[1]||t[2]!==a[2]||t[3]!==a[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Gc extends zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Uh extends zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.bindRenderbuffer(a.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Vh extends zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.bindTexture(a.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class lm extends zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class $h extends zi{getDefault(){return null}set(t){const a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class fd extends zi{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class h0 extends zi{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class f0 extends zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class p0 extends zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class il extends zi{constructor(t,a){super(t),this.context=t,this.parent=a}getDefault(){return null}}class m0 extends il{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class g0 extends il{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferRenderbuffer(a.FRAMEBUFFER,this.attachment(),a.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class rb extends il{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment(),a.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class ib extends g0{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const cm=(h,t,a)=>({u_matrix:h,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:a}),Gh=(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U)=>({u_proj_matrix:Float32Array.from(h),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(d),u_merc_matrix:a,u_zoom_transition:g,u_merc_center:_,u_image0:0,u_frustum_tl:b,u_frustum_tr:T,u_frustum_br:I,u_frustum_bl:k,u_globe_pos:N,u_globe_radius:j,u_viewport:R,u_grid_matrix:U?Float32Array.from(U):new Float32Array(9),u_skirt_height:z,u_far_z_cutoff:B});function qh(h,t){return h!=null&&t!=null&&!(!h.hasData()||!t.hasData())&&h.demTexture!=null&&t.demTexture!=null&&h.tileID.key!==t.tileID.key}const nl=new class{constructor(){this.operations={}}newMorphing(h,t,a,d,g){if(h in this.operations){const _=this.operations[h];_.to.tileID.key!==a.tileID.key&&(_.queued=a)}else this.operations[h]={startTime:d,phase:0,duration:g,from:t,to:a,queued:null}}getMorphValuesForProxy(h){if(!(h in this.operations))return null;const t=this.operations[h];return{from:t.from,to:t.to,phase:t.phase}}update(h){for(const t in this.operations){const a=this.operations[t];for(a.phase=(h-a.startTime)/a.duration;a.phase>=1||!this._validOp(a);)if(!this._nextOp(a,h)){delete this.operations[t];break}}}_nextOp(h,t){return!!h.queued&&(h.from=h.to,h.to=h.queued,h.queued=null,h.phase=0,h.startTime=t,!0)}_validOp(h){return h.from.hasData()&&h.to.hasData()}},um={0:null,1:"TERRAIN_VERTEX_MORPHING"};function dm(h,t,a){if(t===0)return 0;const d=t<1&&a===514?.25/t:1;return 6*Math.pow(1.5,22-h)*Math.max(t,1)*d}function nb(h,t){const a=1<<h.z;return!t&&(h.x===0||h.x===a-1)||h.y===0||h.y===a-1}const Gl=h=>({u_matrix:h});function ql(h,t,a,d,g){if(g>0){const _=o.o.now(),b=(_-h.timeAdded)/g,T=t?(_-t.timeAdded)/g:-1,I=a.getSource(),k=d.coveringZoomLevel({tileSize:I.tileSize,roundZoom:I.roundZoom}),N=!t||Math.abs(t.tileID.overscaledZ-k)>Math.abs(h.tileID.overscaledZ-k),j=N&&h.refreshedUponExpiration?1:o.aA(N?b:1-T,0,1);return t?{opacity:1,mix:1-j,isFading:b<1}:{opacity:j,mix:0,isFading:b<1}}return{opacity:1,mix:0,isFading:!1}}class _0 extends Ws{constructor(t){const a=Zu("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",a,!1),a.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,a){t.state="loaded",a(null)}}class Js extends Ws{constructor(t){const a=Zu("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",a,!1),a.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,a,d){if(t.freezeTileCoverage)return;this.transform=t;const g=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((_,b)=>{if(_[b.key]="",!this._tiles[b.key]){const T=new Ka(b,this._source.tileSize*b.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);T.state="loaded",this._tiles[b.key]=T}return _},{});for(const _ in this._tiles)_ in g||(this.freeFBO(_),this._tiles[_].unloadVectorData(),delete this._tiles[_])}freeFBO(t){const a=this.proxyCachedFBO[t];if(a!==void 0){const d=Object.values(a);this.renderCachePool.push(...d),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Hh extends o.aO{constructor(t,a,d){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=a,this.projMatrix=d}}class pd extends o.dH{constructor(t,a){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[d,g,_]=function(I){const k=new o.bd,N=new o.b1,j=131;k.reserve(17161),N.reserve(33800);const R=o.al/128,z=o.al+R/2,B=z+R;for(let Y=-R;Y<B;Y+=R)for(let H=-R;H<B;H+=R){const K=H<0||H>z||Y<0||Y>z?24575:0,ne=o.aA(Math.round(H),0,o.al),ce=o.aA(Math.round(Y),0,o.al);k.emplaceBack(ne+K,ce)}const U=(Y,H)=>{const K=H*j+Y;N.emplaceBack(K+1,K,K+j),N.emplaceBack(K+j,K+j+1,K+1)};for(let Y=1;Y<129;Y++)for(let H=1;H<129;H++)U(H,Y);return[0,129].forEach(Y=>{for(let H=0;H<130;H++)U(H,Y),U(Y,H)}),[k,N,32768]}(),b=t.context;this.gridBuffer=b.createVertexBuffer(d,o.bf.members),this.gridIndexBuffer=b.createIndexBuffer(g),this.gridSegments=o.bg.simpleSegment(0,0,d.length,g.length),this.gridNoSkirtSegments=o.bg.simpleSegment(0,0,d.length,_),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Js(a.map),this.orthoMatrix=o.bC(),o.cd(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,o.al,0,o.al,0,1);const T=b.gl;this._overlapStencilMode=new Jt({func:T.GEQUAL,mask:255},0,255,T.KEEP,T.KEEP,T.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=a,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new _0(a.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,a,d){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const g=t.terrain.properties,_=t.terrain.drapeRenderMode===0,b=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=o.o.now();const T=t.terrain&&t.terrain.scope,I=g.get("source"),k=_?this._mockSourceCache:t.getSourceCache(I,T);if(!k)return void o.w(`Couldn't find terrain source "${I}".`);if(this.sourceCache=k,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=b?this.calculateExaggeration(a):g.get("exaggeration"),!a.projection.requiresDraping&&b&&this._exaggeration===0)return void this._disable();this.enabled=!0;const N=()=>{this.sourceCache.used&&o.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const j=this.getScaledDemTileSize();this.sourceCache.update(a,j,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,N(),this._initializing=!0),N(),a.updateElevation(!0,d),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(a),this._emptyDEMTextureDirty=!0,this._previousZoom=a.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const a=this._previousCameraAltitude,d=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=d;const g=a!=null?d-a:Number.MAX_VALUE;if(Math.abs(g)<2)return this._exaggeration;const _=t.zoom,b=this._style.terrain;if(!this._previousUpdateTimestamp)return b.getExaggeration(_);let T=_-this._previousZoom;const I=this._previousUpdateTimestamp;let k=_;this._evaluationZoom!=null&&(k=this._evaluationZoom,Math.abs(_-k)>.5&&(T=.5*(_-k+T)),T*g<0&&(k+=T)),this._evaluationZoom=k;const N=b.getExaggeration(k),j=N===b.getExaggeration(Math.max(0,k-.1));if(j&&Math.abs(N-this._exaggeration)<.01)return N;let R=Math.min(.1,.00375*(this._updateTimestamp-I));return(j||N<.1||Math.abs(T)<1e-4)&&(R=Math.min(.2,4*R)),o.ak(this._exaggeration,N,R)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.dataType==="source"&&t.coord?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const a=this.proxySourceCache,d=this.painter.transform;this._initializing&&(this._initializing=d._centerAltitude===0&&this.getAtPointOrZero(o.ae.fromLngLat(d.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const g=this.proxyCoords=a.getIds().map(I=>{const k=a.getTileByID(I).tileID;return k.projMatrix=d.calculateProjMatrix(k.toUnwrapped()),k});(function(I,k){const N=k.transform.pointCoordinate(k.transform.getCameraPoint()),j=new o.P(N.x,N.y);I.sort((R,z)=>{if(z.overscaledZ-R.overscaledZ)return z.overscaledZ-R.overscaledZ;const B=new o.P(R.canonical.x+(1<<R.canonical.z)*R.wrap,R.canonical.y),U=new o.P(z.canonical.x+(1<<z.canonical.z)*z.wrap,z.canonical.y),Y=j.mult(1<<R.canonical.z);return Y.x-=.5,Y.y-=.5,Y.distSqr(B)-Y.distSqr(U)})})(g,this.painter);const _=this.proxyToSource||{};this.proxyToSource={},g.forEach(I=>{this.proxyToSource[I.key]={}}),this.terrainTileForTile={};const b=this._style._mergedSourceCaches;for(const I in b){const k=b[I];if(!k.used||(k!==this.sourceCache&&this.resetTileLookupCache(k.id),this._setupProxiedCoordsForOrtho(k,t[I],_),k.usedForTerrain))continue;const N=t[I];k.getSource().reparseOverscaled&&this._assignTerrainTiles(N)}this.proxiedCoords[a.id]=g.map(I=>new Hh(I,I.key,this.orthoMatrix)),this._assignTerrainTiles(g),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(_),this.renderingToTexture=!1;const T={};this._visibleDemTiles=[];for(const I of this.proxyCoords){const k=this.terrainTileForTile[I.key];if(!k)continue;const N=k.tileID.key;N in T||(this._visibleDemTiles.push(k),T[N]=N)}}_assignTerrainTiles(t){this._initializing||t.forEach(a=>{if(this.terrainTileForTile[a.key])return;const d=this._findTileCoveringTileID(a,this.sourceCache);d&&(this.terrainTileForTile[a.key]=d)})}_prepareDEMTextures(){const t=this.painter.context,a=t.gl;for(const d in this.terrainTileForTile){const g=this.terrainTileForTile[d],_=g.dem;!_||g.demTexture&&!g.needsDEMTextureUpload||(t.activeTexture.set(a.TEXTURE1),Dh(this.painter,g,_))}}_prepareDemTileUniforms(t,a,d,g){if(!a||a.demTexture==null)return!1;const _=t.tileID.canonical,b=Math.pow(2,a.tileID.canonical.z-_.z),T=g||"";return d[`u_dem_tl${T}`]=[_.x*b%1,_.y*b%1],d[`u_dem_scale${T}`]=b,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const a=this._visibleDemTiles.reduce((d,g)=>{if(!g.dem)return d;const _=g.dem.tree.minimums[0];return _>0&&t++,d+_},0);return t?a/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,a=t.gl;t.activeTexture.set(a.TEXTURE2);const d=this._getLoadedAreaMinimum(),g=new o.dI({width:1,height:1},new Float32Array([d]));this._emptyDEMTextureDirty=!1;let _=this._emptyDEMTexture;return _?_.update(g,{premultiply:!1}):_=this._emptyDEMTexture=new o.T(t,g,a.R32F,{premultiply:!1}),_}setupElevationDraw(t,a,d){const g=this.painter.context,_=g.gl,b={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};b.u_exaggeration=this.exaggeration();let T=null,I=null,k=1;if(d&&d.morphing&&this._useVertexMorphing){const z=d.morphing.srcDemTile,B=d.morphing.dstDemTile;k=d.morphing.phase,z&&B&&(this._prepareDemTileUniforms(t,z,b,"_prev")&&(I=z),this._prepareDemTileUniforms(t,B,b)&&(T=B))}const N=z=>z&&z.demTexture&&this.painter.linearFloatFilteringSupported()?_.LINEAR:_.NEAREST;let j=null;var R;if(this.enabled?I&&T?(j=T.demTexture,g.activeTexture.set(_.TEXTURE4),I.demTexture.bind(N(I),_.CLAMP_TO_EDGE),b.u_dem_lerp=k):(T=this.terrainTileForTile[t.tileID.key],j=this._prepareDemTileUniforms(t,T,b)?T.demTexture:this.emptyDEMTexture):j=this.emptyDEMTexture,g.activeTexture.set(_.TEXTURE2),j&&(b.u_dem_size=(R=j).size[0]===1?1:R.size[0]-2,j.bind(N(T),_.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(d&&d.useDepthForOcclusion,a,b),d&&d.useMeterToDem&&T){const z=(1<<T.tileID.canonical.z)*o.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;b.u_meter_to_dem=z}if(d&&d.labelPlaneMatrixInv&&(b.u_label_plane_matrix_inv=d.labelPlaneMatrixInv),a.setTerrainUniformValues(g,b),this.painter.transform.projection.name==="globe"){const z=this.globeUniformValues(this.painter.transform,t.tileID.canonical,d&&d.useDenormalizedUpVectorScale);a.setGlobeUniformValues(g,z)}}globeUniformValues(t,a,d){const g=t.projection;return{u_tile_tl_up:g.upVector(a,0,0),u_tile_tr_up:g.upVector(a,o.al,0),u_tile_br_up:g.upVector(a,o.al,o.al),u_tile_bl_up:g.upVector(a,0,o.al),u_tile_up_scale:d?o.dJ(1):g.upVectorScale(a,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const a=this.painter,d=this.painter.context;t.length!==0&&(d.bindFramebuffer.set(null),d.viewport.set([0,0,a.width,a.height]),a.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(g,_,b,T,I){if(g.transform.projection.name==="globe")(function(k,N,j,R,z){const B=k.context,U=B.gl;let Y,H;const K=k.transform,ne=o.dA(k,B,K),ce=(Ze,De)=>{if(H===De)return;const He=[um[De],"PROJECTION_GLOBE_VIEW"];ne&&He.push("CUSTOM_ANTIALIASING");const _t=k.isTileAffectedByFog(Ze);Y=k.getOrCreateProgram("globeRaster",{defines:He,overrideFog:_t}),H=De},ge=k.colorModeForRenderPass(),pe=new At(U.LEQUAL,At.ReadWrite,k.depthRangeFor3D);nl.update(z);const _e=o.dB(K),me=[o.aF(K.center.lng),o.aJ(K.center.lat)],fe=k.globeSharedBuffers,ye=[K.width*o.o.devicePixelRatio,K.height*o.o.devicePixelRatio],Fe=Float32Array.from(K.globeMatrix),Pe={useDenormalizedUpVectorScale:!0};{const Ze=k.transform,De=dm(Ze.zoom,N.exaggeration(),N.sourceCache._source.tileSize);H=-1;const He=U.TRIANGLES;for(const _t of R){const ze=j.getTile(_t),Ie=Jt.disabled,Ye=N.prevTerrainTileForTile[_t.key],Ue=N.terrainTileForTile[_t.key];qh(Ye,Ue)&&nl.newMorphing(_t.key,Ye,Ue,z,250),B.activeTexture.set(U.TEXTURE0),ze.texture&&ze.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);const nt=nl.getMorphValuesForProxy(_t.key),gt=nt?1:0;nt&&Object.assign(Pe,{morphing:{srcDemTile:nt.from,dstDemTile:nt.to,phase:o.dz(nt.phase)}});const Et=o.dC(_t.canonical),dt=o.dD(Et.getCenter().lat),lt=o.dE(_t.canonical,Et,dt,Ze.worldSize/Ze._pixelsPerMercatorPixel),Ft=o.bk(o.dF(_t.canonical)),Dt=Gh(Ze.expandedFarZProjMatrix,Fe,_e,Ft,o.aj(Ze.zoom),me,Ze.frustumCorners.TL,Ze.frustumCorners.TR,Ze.frustumCorners.BR,Ze.frustumCorners.BL,Ze.globeCenterInViewSpace,Ze.globeRadius,ye,De,Ze._farZ,lt);if(ce(_t,gt),Y&&(N.setupElevationDraw(ze,Y,Pe),k.uploadCommonUniforms(B,Y,_t.toUnwrapped()),fe)){const[zt,Ot,nr]=fe.getGridBuffers(dt,De!==0);Y.draw(k,He,pe,Ie,ge,ir.backCCW,Dt,"globe_raster",zt,Ot,nr)}}}if(fe&&(k.renderDefaultNorthPole||k.renderDefaultSouthPole)){const Ze=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];ne&&Ze.push("CUSTOM_ANTIALIASING"),Y=k.getOrCreateProgram("globeRaster",{defines:Ze});for(const De of R){const{x:He,y:_t,z:ze}=De.canonical,Ie=_t===0,Ye=_t===(1<<ze)-1,[Ue,nt,gt,Et]=fe.getPoleBuffers(ze,!1);if(Et&&(Ie||Ye)){const dt=j.getTile(De);B.activeTexture.set(U.TEXTURE0),dt.texture&&dt.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);let lt=o.dG(ze,He,K);const Ft=o.bk(o.dF(De.canonical)),Dt=(zt,Ot)=>zt.draw(k,U.TRIANGLES,pe,Jt.disabled,ge,ir.disabled,Gh(K.expandedFarZProjMatrix,lt,lt,Ft,0,me,K.frustumCorners.TL,K.frustumCorners.TR,K.frustumCorners.BR,K.frustumCorners.BL,K.globeCenterInViewSpace,K.globeRadius,ye,0,K._farZ),"globe_pole_raster",Ot,gt,Et);N.setupElevationDraw(dt,Y,Pe),k.uploadCommonUniforms(B,Y,De.toUnwrapped()),Ie&&k.renderDefaultNorthPole&&Dt(Y,Ue),Ye&&k.renderDefaultSouthPole&&(lt=o.cR(o.bC(),lt,[1,-1,1]),Dt(Y,nt))}}}})(g,_,b,T,I);else{const k=g.context,N=k.gl;let j,R;const z=g.shadowRenderer,B=tl(g,g.longestCutoffRange),U=ge=>{if(R===ge)return;const pe=[];pe.push(um[ge]),B.shouldRenderCutoff&&pe.push("RENDER_CUTOFF"),z&&(pe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),z.useNormalOffset&&pe.push("NORMAL_OFFSET")),j=g.getOrCreateProgram("terrainRaster",{defines:pe}),R=ge},Y=g.colorModeForRenderPass(),H=new At(N.LEQUAL,At.ReadWrite,g.depthRangeFor3D);nl.update(I);const K=g.transform,ne=dm(K.zoom,_.exaggeration(),_.sourceCache._source.tileSize);let ce=[0,0,0];if(z){const ge=g.style.directionalLight,pe=g.style.ambientLight;ge&&pe&&(ce=Oo(g.style,ge,pe))}{R=-1;const ge=N.TRIANGLES,[pe,_e]=[_.gridIndexBuffer,_.gridSegments];for(const me of T){const fe=b.getTile(me),ye=Jt.disabled,Fe=_.prevTerrainTileForTile[me.key],Pe=_.terrainTileForTile[me.key];qh(Fe,Pe)&&nl.newMorphing(me.key,Fe,Pe,I,250),k.activeTexture.set(N.TEXTURE0),fe.texture&&fe.texture.bind(N.LINEAR,N.CLAMP_TO_EDGE);const Ze=nl.getMorphValuesForProxy(me.key),De=Ze?1:0;let He;Ze&&(He={morphing:{srcDemTile:Ze.from,dstDemTile:Ze.to,phase:o.dz(Ze.phase)}});const _t=cm(me.projMatrix,nb(me.canonical,K.renderWorldCopies)?ne/10:ne,ce);if(U(De),!j)continue;_.setupElevationDraw(fe,j,He);const ze=me.toUnwrapped();z&&z.setupShadows(ze,j),g.uploadCommonUniforms(k,j,ze,null,B),j.draw(g,ge,H,ye,Y,ir.backCCW,_t,"terrain_raster",_.gridBuffer,pe,_e)}}}}(a,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,a.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const a=this.painter,d=this.painter.context,g=this.proxySourceCache,_=this.proxiedCoords[g.id],b=this._drapedRenderBatches.shift(),T=a.style.order,I=[];let k=0;for(const N of _){const j=g.getTileByID(N.proxyTileKey),R=g.proxyCachedFBO[N.key]?g.proxyCachedFBO[N.key][t]:void 0,z=R!==void 0?g.renderCache[R]:this.pool[k++],B=R!==void 0;if(j.texture=z.tex,B&&!z.dirty){I.push(j.tileID);continue}let U;d.bindFramebuffer.set(z.fb.framebuffer),this.renderedToTile=!1,z.dirty&&(d.clear({color:o.ao.transparent,stencil:0}),z.dirty=!1);for(let Y=b.start;Y<=b.end;++Y){const H=a.style._mergedLayers[T[Y]];if(H.isHidden(a.transform.zoom))continue;const K=a.style.getLayerSourceCache(H),ne=K?this.proxyToSource[N.key][K.id]:[N];if(!ne)continue;const ce=ne;d.viewport.set([0,0,z.fb.width,z.fb.height]),U!==(K?K.id:null)&&(this._setupStencil(z,ne,H,K),U=K?K.id:null),a.renderLayer(a,K,H,ce)}if(this._drapedRenderBatches.length===0)for(const Y of this._pendingGroundEffectLayers){const H=a.style._mergedLayers[T[Y]];if(H.isHidden(a.transform.zoom))continue;const K=a.style.getLayerSourceCache(H),ne=K?this.proxyToSource[N.key][K.id]:[N];if(!ne)continue;const ce=ne;d.viewport.set([0,0,z.fb.width,z.fb.height]),U!==(K?K.id:null)&&(this._setupStencil(z,ne,H,K),U=K?K.id:null),a.renderLayer(a,K,H,ce)}this.renderedToTile?(z.dirty=!0,I.push(j.tileID)):B||--k,k===5&&(k=0,this.renderToBackBuffer(I))}return this.renderToBackBuffer(I),this.renderingToTexture=!1,d.bindFramebuffer.set(null),d.viewport.set([0,0,a.width,a.height]),b.end+1}postRender(){}isLayerOrderingCorrect(t){const a=t.order.length;let d=-1,g=a;for(let _=0;_<a;++_)this._style.isLayerDraped(t._mergedLayers[t.order[_]])?d=Math.max(d,_):g=Math.min(g,_);return g>d}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(a=>a.dem).forEach(a=>{t=Math.min(t,a.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,a,d){if(!this._visibleDemTiles)return null;const g=this._visibleDemTiles.filter(_=>_.dem).map(_=>{const b=_.tileID,T=1<<b.overscaledZ,{x:I,y:k}=b.canonical,N=I/T,j=(I+1)/T,R=k/T,z=(k+1)/T;return{minx:N,miny:R,maxx:j,maxy:z,t:_.dem.tree.raycastRoot(N,R,j,z,t,a,d),tile:_}});g.sort((_,b)=>(_.t!==null?_.t:Number.MAX_VALUE)-(b.t!==null?b.t:Number.MAX_VALUE));for(const _ of g){if(_.t==null)return null;const b=_.tile.dem.tree.raycast(_.minx,_.miny,_.maxx,_.maxy,t,a,d);if(b!=null)return b}return null}_createFBO(){const t=this.painter.context,a=t.gl,d=this.drapeBufferSize;t.activeTexture.set(a.TEXTURE0);const g=new o.T(t,{width:d[0],height:d[1],data:null},a.RGBA8);g.bind(a.LINEAR,a.CLAMP_TO_EDGE);const _=t.createFramebuffer(d[0],d[1],!0,null);return _.colorAttachment.set(g.texture),_.depthAttachment=new ib(t,_.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,d[0],d[1]),this._stencilRef=0,_.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):_.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:_,tex:g,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const a=this._style._mergedLayers[t],d=a.isHidden(this.painter.transform.zoom);return a.type==="hillshade"||a.type==="custom"?!d&&a.shouldRedrape():!d&&a.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const d of this._style.getSources())if(d instanceof is){t=!0;break}if(!t)return;const a={};for(let d=0;d<this._style.order.length;++d){const g=this._style._mergedLayers[this._style.order[d]],_=this._style.getLayerSourceCache(g);if(_&&!a[_.id]&&!g.isHidden(this.painter.transform.zoom)&&g.type==="line"&&g.widthExpression()instanceof o.ad){a[_.id]=!0;for(const b of this.proxyCoords){const T=this.proxyToSource[b.key][_.id];if(T)for(const I of T)this._clearRenderCacheForTile(_.id,I)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const d in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[d]._source instanceof Ic){t=!0;break}if(!t)return;const a={};for(let d=0;d<this._style.order.length;++d){const g=this._style._mergedLayers[this._style.order[d]],_=this._style.getLayerSourceCache(g);if(!_||a[_.id]||g.isHidden(this.painter.transform.zoom)||g.type!=="raster")continue;const b=g.paint.get("raster-fade-duration");for(const T of this.proxyCoords){const I=this.proxyToSource[T.key][_.id];if(I)for(const k of I){const N=ql(_.getTile(k),_.findLoadedParent(k,0),_,this.painter.transform,b);(N.opacity!==1||N.mix!==0)&&this._clearRenderCacheForTile(_.id,k)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,a=t.length;if(a===0)return;const d=[];this._pendingGroundEffectLayers=[];let g,_=0,b=this._style._mergedLayers[t[_]];for(;!this._style.isLayerDraped(b)&&b.isHidden(this.painter.transform.zoom)&&++_<a;)b=this._style._mergedLayers[t[_]];for(;_<a;++_){const T=this._style._mergedLayers[t[_]];T.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(T)?g===void 0&&(g=_):(T.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(_),g!==void 0&&(d.push({start:g,end:_-1}),g=void 0)))}if(g!==void 0&&d.push({start:g,end:_-1}),d.length!==0){const T=d[d.length-1];this._pendingGroundEffectLayers.every(I=>I>T.end)||o.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=d}_setupRenderCache(t){const a=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,a.renderCache.length>a.renderCachePool.length){const b=Object.values(a.proxyCachedFBO);a.proxyCachedFBO={};for(let T=0;T<b.length;++T){const I=Object.values(b[T]);a.renderCachePool.push(...I)}}return}this._clearRasterLayersFromRenderCache();const d=this.proxyCoords,g=this._tilesDirty;for(let b=d.length-1;b>=0;b--){const T=d[b];if(a.getTileByID(T.key),a.proxyCachedFBO[T.key]!==void 0){const I=t[T.key],k=this.proxyToSource[T.key];let N=0;for(const j in k){const R=k[j],z=I[j];if(!z||z.length!==R.length||R.some((B,U)=>B!==z[U]||g[j]&&g[j].hasOwnProperty(B.key))){N=-1;break}++N}for(const j in a.proxyCachedFBO[T.key])a.renderCache[a.proxyCachedFBO[T.key][j]].dirty=N<0||N!==Object.values(I).length}}const _=[...this._drapedRenderBatches];_.sort((b,T)=>T.end-T.start-(b.end-b.start));for(const b of _)for(const T of d){if(a.proxyCachedFBO[T.key])continue;let I=a.renderCachePool.pop();I===void 0&&a.renderCache.length<50&&(I=a.renderCache.length,a.renderCache.push(this._createFBO())),I!==void 0&&(a.proxyCachedFBO[T.key]={},a.proxyCachedFBO[T.key][b.start]=I,a.renderCache[I].dirty=!0)}this._tilesDirty={}}_setupStencil(t,a,d,g){if(!g||!this._sourceTilesOverlap[g.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const _=this.painter.context,b=_.gl;if(a.length<=1)return void(this._overlapStencilType=!1);let T;if(d.isTileClipped())T=a.length,this._overlapStencilMode.test={func:b.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(a[0].overscaledZ>a[a.length-1].overscaledZ))return void(this._overlapStencilType=!1);T=1,this._overlapStencilMode.test={func:b.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+T>255&&(_.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=T,this._overlapStencilMode.ref=this._stencilRef,d.isTileClipped()&&this._renderTileClippingMasks(a,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Jt.disabled}_renderTileClippingMasks(t,a){const d=this.painter,g=this.painter.context,_=g.gl;d._tileClippingMaskIDs={},g.setColorMode(vr.disabled),g.setDepthMode(At.disabled);const b=d.getOrCreateProgram("clippingMask");for(const T of t){const I=d._tileClippingMaskIDs[T.key]=--a;b.draw(d,_.TRIANGLES,At.disabled,new Jt({func:_.ALWAYS,mask:0},I,255,_.KEEP,_.KEEP,_.REPLACE),vr.disabled,ir.disabled,Gl(T.projMatrix),"$clipping",d.tileExtentBuffer,d.quadTriangleIndexBuffer,d.tileExtentSegments)}}pointCoordinate(t){const a=this.painter.transform;if(t.x<0||t.x>a.width||t.y<0||t.y>a.height)return null;const d=[t.x,t.y,1,1];o.aC(d,d,a.pixelMatrixInverse),o.cJ(d,d,1/d[3]),d[0]/=a.worldSize,d[1]/=a.worldSize;const g=a._camera.position,_=o.ce(1,a.center.lat),b=[g[0],g[1],g[2]/_,0],T=o.d9([],d.slice(0,3),b);o.aw(T,T);const I=this.raycast(b,T,this._exaggeration);return I!==null&&I?(o.bH(b,b,T,I),b[3]=b[2],b[2]*=_,b):null}_setupProxiedCoordsForOrtho(t,a,d){if(t.getSource()instanceof o.aS)return this._setupProxiedCoordsForImageSource(t,a,d);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const g=this.proxiedCoords[t.id]=[],_=this.proxyCoords;for(let I=0;I<_.length;I++){const k=_[I],N=this._findTileCoveringTileID(k,t);if(N){const j=this._createProxiedId(k,N,d[k.key]&&d[k.key][t.id]);g.push(j),this.proxyToSource[k.key][t.id]=[j]}}let b=!1;const T=new Set;for(let I=0;I<a.length;I++){const k=t.getTile(a[I]);if(!k||!k.hasData())continue;const N=this._findTileCoveringTileID(k.tileID,this.proxySourceCache);if(N&&N.tileID.canonical.z!==k.tileID.canonical.z){const j=this.proxyToSource[N.tileID.key][t.id],R=this._createProxiedId(N.tileID,k,d[N.tileID.key]&&d[N.tileID.key][t.id]);j?j.splice(j.length-1,0,R):this.proxyToSource[N.tileID.key][t.id]=[R];const z=this.proxyToSource[N.tileID.key][t.id];T.has(z)||T.add(z),g.push(R),b=!0}}if(this._sourceTilesOverlap[t.id]=b,b&&this._debugParams.sortTilesHiZFirst)for(const I of T)I.sort((k,N)=>N.overscaledZ-k.overscaledZ)}_setupProxiedCoordsForImageSource(t,a,d){if(!t.getSource().loaded())return;const g=this.proxiedCoords[t.id]=[],_=this.proxyCoords,b=t.getSource(),T=b.tileID;if(!T)return;const I=new o.P(T.x,T.y)._div(1<<T.z),k=b.coordinates.map(o.ae.fromLngLat).reduce((j,R)=>(j.min.x=Math.min(j.min.x,R.x-I.x),j.min.y=Math.min(j.min.y,R.y-I.y),j.max.x=Math.max(j.max.x,R.x-I.x),j.max.y=Math.max(j.max.y,R.y-I.y),j),{min:new o.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),N=(j,R)=>{const z=j.wrap+j.canonical.x/(1<<j.canonical.z),B=j.canonical.y/(1<<j.canonical.z),U=o.al/(1<<j.canonical.z),Y=R.wrap+R.canonical.x/(1<<R.canonical.z),H=R.canonical.y/(1<<R.canonical.z);return z+U<Y+k.min.x||z>Y+k.max.x||B+U<H+k.min.y||B>H+k.max.y};for(let j=0;j<_.length;j++){const R=_[j];for(let z=0;z<a.length;z++){const B=t.getTile(a[z]);if(!B||!B.hasData()||N(R,B.tileID))continue;const U=this._createProxiedId(R,B,d[R.key]&&d[R.key][t.id]),Y=this.proxyToSource[R.key][t.id];Y?Y.push(U):this.proxyToSource[R.key][t.id]=[U],g.push(U)}}}_createProxiedId(t,a,d){let g=this.orthoMatrix;if(d){const _=d.find(b=>b.key===a.tileID.key);if(_)return _}if(a.tileID.key!==t.key){const _=t.canonical.z-a.tileID.canonical.z;let b,T,I;g=o.bC();const k=a.tileID.wrap-t.wrap<<t.overscaledZ;_>0?(b=o.al>>_,T=b*((a.tileID.canonical.x<<_)-t.canonical.x+k),I=b*((a.tileID.canonical.y<<_)-t.canonical.y)):(b=o.al<<-_,T=o.al*(a.tileID.canonical.x-(t.canonical.x+k<<-_)),I=o.al*(a.tileID.canonical.y-(t.canonical.y<<-_))),o.cd(g,0,b,0,b,0,1),o.br(g,g,[T,I,0])}return new Hh(a.tileID,t.key,g)}_findTileCoveringTileID(t,a){let d=a.getTile(t);if(d&&d.hasData())return d;const g=this._findCoveringTileCache[a.id],_=g[t.key];if(d=_?a.getTileByID(_):null,d&&d.hasData()||_===null)return d;let b=d?d.tileID:t,T=b.overscaledZ;const I=a.getSource().minzoom,k=[];if(!_){const j=a.getSource().maxzoom;if(t.canonical.z>=j){const R=t.canonical.z-j;a.getSource().reparseOverscaled?(T=Math.max(t.canonical.z+2,a.transform.tileZoom),b=new o.aO(T,t.wrap,j,t.canonical.x>>R,t.canonical.y>>R)):R!==0&&(T=j,b=new o.aO(T,t.wrap,j,t.canonical.x>>R,t.canonical.y>>R))}b.key!==t.key&&(k.push(b.key),d=a.getTile(b))}const N=j=>{k.forEach(R=>{g[R]=j}),k.length=0};for(T-=1;T>=I&&(!d||!d.hasData());T--){d&&N(d.tileID.key);const j=b.calculateScaledKey(T);if(d=a.getTileByID(j),d&&d.hasData())break;const R=g[j];if(R===null)break;R===void 0?k.push(j):d=a.getTileByID(R)}return N(d?d.tileID.key:null),d&&d.hasData()?d:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,a){let d=this._tilesDirty[t];d||(d=this._tilesDirty[t]={}),d[a.key]=!0}}function Wh(h,t,a){const d=function(T,I,k){const N=o.bJ(I,T),j=o.bJ(k,[.2126,.7152,.0722]),R=(B,U,Y)=>(1-Y)*B+Y*U,z=R(1-.3*Math.min(j,1),1,Math.min(N+1,1));return R(.92,1,Math.asin(o.aA(I[2],-1,1))/Math.PI+.5)*z}(h,[0,0,1],t),g=[0,0,0];o.c4(g,a.slice(0,3),d);const _=[0,0,0];o.c4(_,t.slice(0,3),h[2]);const b=[0,0,0];return o.d7(b,g,_),o.da(b)}const hm=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],fm=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Zh{static cacheKey(t,a,d,g){let _=`${a}${g?g.cacheKey:""}`;for(const b of d)t.usedDefines.includes(b)&&(_+=`/${b}`);return _}constructor(t,a,d,g,_,b){const T=t.gl;this.program=T.createProgram(),this.configuration=g,this.name=a,this.fixedDefines=[...b];let I=g?g.defines():[];I=I.concat(b.map(B=>`#define ${B}`));const k=`#version 300 es
`;let N=k+I.concat("precision mediump float;",ta,hd.fragmentSource).join(`
`);for(const B of d.fragmentIncludes)N+=`
${Bc[B]}`;N+=`
${d.fragmentSource}`;let j=k+I.concat("precision highp float;",ta,hd.vertexSource).join(`
`);for(const B of d.vertexIncludes)j+=`
${Bc[B]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&d.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(j+=`
uniform int u_instanceID;
`),j+=`
${d.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(j=j.replaceAll("gl_InstanceID","u_instanceID"));const R=T.createShader(T.FRAGMENT_SHADER);if(T.isContextLost())return void(this.failedToCreate=!0);T.shaderSource(R,N),T.compileShader(R),T.attachShader(this.program,R);const z=T.createShader(T.VERTEX_SHADER);T.isContextLost()?this.failedToCreate=!0:(T.shaderSource(z,j),T.compileShader(z),T.attachShader(this.program,z),this.attributes={},T.linkProgram(this.program),T.deleteShader(z),T.deleteShader(R),this.fixedUniforms=_(t),this.binderUniforms=g?g.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(B=>({u_instanceID:new o.cg(B)}))(t)),(b.includes("TERRAIN")||a.indexOf("symbol")!==-1||a.indexOf("circle")!==-1)&&(this.terrainUniforms=(B=>({u_dem:new o.cg(B),u_dem_prev:new o.cg(B),u_dem_tl:new o.cj(B),u_dem_scale:new o.ci(B),u_dem_tl_prev:new o.cj(B),u_dem_scale_prev:new o.ci(B),u_dem_size:new o.ci(B),u_dem_lerp:new o.ci(B),u_exaggeration:new o.ci(B),u_depth:new o.cg(B),u_depth_size_inv:new o.cj(B),u_depth_range_unpack:new o.cj(B),u_occluder_half_size:new o.ci(B),u_occlusion_depth_offset:new o.ci(B),u_meter_to_dem:new o.ci(B),u_label_plane_matrix_inv:new o.ck(B)}))(t)),b.includes("GLOBE")&&(this.globeUniforms=(B=>({u_tile_tl_up:new o.ch(B),u_tile_tr_up:new o.ch(B),u_tile_br_up:new o.ch(B),u_tile_bl_up:new o.ch(B),u_tile_up_scale:new o.ci(B)}))(t)),b.includes("FOG")&&(this.fogUniforms=(B=>({u_fog_matrix:new o.ck(B),u_fog_range:new o.cj(B),u_fog_color:new o.d2(B),u_fog_horizon_blend:new o.ci(B),u_fog_vertical_limit:new o.cj(B),u_fog_temporal_offset:new o.ci(B),u_frustum_tl:new o.ch(B),u_frustum_tr:new o.ch(B),u_frustum_br:new o.ch(B),u_frustum_bl:new o.ch(B),u_globe_pos:new o.ch(B),u_globe_radius:new o.ci(B),u_globe_transition:new o.ci(B),u_is_globe:new o.cg(B),u_viewport:new o.cj(B)}))(t)),b.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(B=>({u_cutoff_params:new o.d2(B)}))(t)),b.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(B=>({u_lighting_ambient_color:new o.ch(B),u_lighting_directional_dir:new o.ch(B),u_lighting_directional_color:new o.ch(B),u_ground_radiance:new o.ch(B)}))(t)),b.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(B=>({u_light_matrix_0:new o.ck(B),u_light_matrix_1:new o.ck(B),u_fade_range:new o.cj(B),u_shadow_normal_offset:new o.ch(B),u_shadow_intensity:new o.ci(B),u_shadow_texel_size:new o.ci(B),u_shadow_map_resolution:new o.ci(B),u_shadow_direction:new o.ch(B),u_shadow_bias:new o.ch(B),u_shadowmap_0:new o.cg(B),u_shadowmap_1:new o.cg(B)}))(t)))}getAttributeLocation(t,a){let d=this.attributes[a];return d===void 0&&(d=this.attributes[a]=t.getAttribLocation(this.program,a)),d}setTerrainUniformValues(t,a){if(!this.terrainUniforms)return;const d=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const g in a)d[g]&&d[g].set(this.program,g,a[g])}}setGlobeUniformValues(t,a){if(!this.globeUniforms)return;const d=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const g in a)d[g]&&d[g].set(this.program,g,a[g])}}setFogUniformValues(t,a){if(!this.fogUniforms)return;const d=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const g in a)d[g].set(this.program,g,a[g])}}setCutoffUniformValues(t,a){if(!this.cutoffUniforms)return;const d=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const g in a)d[g].set(this.program,g,a[g])}}setLightsUniformValues(t,a){if(!this.lightsUniforms)return;const d=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const g in a)d[g].set(this.program,g,a[g])}}setShadowUniformValues(t,a){if(this.failedToCreate||!this.shadowUniforms)return;const d=this.shadowUniforms;t.program.set(this.program);for(const g in a)d[g].set(this.program,g,a[g])}_drawDebugWireframe(t,a,d,g,_,b,T,I,k,N){const j=t.options.wireframe;if(j.terrain===!1&&j.layers2D===!1&&j.layers3D===!1)return;const R=t.context;if(!(!(!j.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!j.layers2D||t._terrain&&t._terrain.renderingToTexture||!hm.includes(this.name))||!(!j.layers3D||!fm.includes(this.name))))return;const z=R.gl,B=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,_,R);if(!B)return;const U=[...this.fixedDefines];U.push("DEBUG_WIREFRAME");const Y=t.getOrCreateProgram(this.name,{config:this.configuration,defines:U});R.program.set(Y.program);const H=(ce,ge,pe)=>{if(ge[ce]&&pe[ce])for(const _e in ge[ce])pe[ce][_e]&&pe[ce][_e].set(pe.program,_e,ge[ce][_e].current)};k&&k.setUniforms(Y.program,R,Y.binderUniforms,T,{zoom:I}),H("fixedUniforms",this,Y),H("terrainUniforms",this,Y),H("globeUniforms",this,Y),H("fogUniforms",this,Y),H("lightsUniforms",this,Y),H("shadowUniforms",this,Y),B.bind(),R.setColorMode(new vr([z.ONE,z.ONE_MINUS_SRC_ALPHA,z.ZERO,z.ONE],o.ao.transparent,[!0,!0,!0,!1])),R.setDepthMode(new At(a.func===z.LESS?z.LEQUAL:a.func,At.ReadOnly,a.range)),R.setStencilMode(Jt.disabled);const K=3*b.primitiveLength*2,ne=3*b.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const ce=N||1;for(let ge=0;ge<ce;++ge)Y.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ge),z.drawElements(z.LINES,K,z.UNSIGNED_SHORT,ne)}else N&&N>1?z.drawElementsInstanced(z.LINES,K,z.UNSIGNED_SHORT,ne,N):z.drawElements(z.LINES,K,z.UNSIGNED_SHORT,ne);_.bind(),R.program.set(this.program),R.setDepthMode(a),R.setStencilMode(d),R.setColorMode(g)}checkUniforms(t,a,d){if(this.fixedDefines.includes(a)){for(const g of Object.keys(d))if(!d[g].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${g} not set but required by ${a} being defined`)}}draw(t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y){const H=t.context,K=H.gl;if(this.failedToCreate)return;H.program.set(this.program),H.setDepthMode(d),H.setStencilMode(g),H.setColorMode(_),H.setCullFace(b);for(const ge of Object.keys(this.fixedUniforms))this.fixedUniforms[ge].set(this.program,ge,T[ge]);B&&B.setUniforms(this.program,H,this.binderUniforms,R,{zoom:z});const ne={[K.POINTS]:1,[K.LINES]:2,[K.TRIANGLES]:3,[K.LINE_STRIP]:1}[a];this.checkUniforms(I,"RENDER_SHADOWS",this.shadowUniforms);const ce=Y&&Y>0?1:void 0;for(const ge of j.get()){const pe=ge.vaos||(ge.vaos={});if((pe[I]||(pe[I]=new Uc)).bind(H,this,k,B?B.getPaintVertexBuffers():[],N,ge.vertexOffset,U||[],ce),this.forceManualRenderingForInstanceIDShaders){const _e=Y||1;for(let me=0;me<_e;++me)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",me),N?K.drawElements(a,ge.primitiveLength*ne,K.UNSIGNED_SHORT,ge.primitiveOffset*ne*2):K.drawArrays(a,ge.vertexOffset,ge.vertexLength)}else Y&&Y>1?K.drawElementsInstanced(a,ge.primitiveLength*ne,K.UNSIGNED_SHORT,ge.primitiveOffset*ne*2,Y):N?K.drawElements(a,ge.primitiveLength*ne,K.UNSIGNED_SHORT,ge.primitiveOffset*ne*2):K.drawArrays(a,ge.vertexOffset,ge.vertexLength);a===K.TRIANGLES&&N&&this._drawDebugWireframe(t,d,g,_,N,ge,R,z,B,Y)}}}function md(h,t,a=0){const d=Math.pow(2,t.tileID.overscaledZ),g=t.tileSize*Math.pow(2,h.transform.tileZoom)/d,_=g*(t.tileID.canonical.x+t.tileID.wrap*d),b=g*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/o.ay(t,1,h.transform.tileZoom),u_pixel_coord_upper:[_>>16,b>>16],u_pixel_coord_lower:[65535&_,65535&b],u_pattern_transition:a}}const qc={terrain:0,flat:1},pm=o.bC(),gd=(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H)=>{const K=t.style.light,ne=K.properties.get("position"),ce=[ne.x,ne.y,ne.z],ge=o.dL();K.properties.get("anchor")==="viewport"&&(o.dM(ge,-t.transform.angle),o.dN(ce,ce,ge));const pe=K.properties.get("color").toPremultipliedRenderColor(null),_e=t.transform,me={u_matrix:h,u_lightpos:ce,u_lightintensity:K.properties.get("intensity"),u_lightcolor:[pe.r,pe.g,pe.b],u_vertical_gradient:+a,u_opacity:d,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:pm,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:qc[k],u_base_type:qc[N],u_ao:g,u_edge_radius:_,u_width_scale:b,u_flood_light_color:B,u_vertical_scale:U,u_flood_light_intensity:Y,u_ground_shadow_factor:H};return _e.projection.name==="globe"&&(me.u_tile_id=[T.canonical.x,T.canonical.y,1<<T.canonical.z],me.u_zoom_transition=j,me.u_inv_rot_matrix=z,me.u_merc_center=R,me.u_up_dir=_e.projection.upVector(new o.cC(0,0,0),R[0]*o.al,R[1]*o.al),me.u_height_lift=I),me},mm=(h,t,a,d,g,_)=>({u_matrix:h,u_edge_radius:t,u_width_scale:a,u_vertical_scale:d,u_height_type:qc[g],u_base_type:qc[_]}),y0=(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H)=>{const K=gd(h,t,a,d,g,_,b,T,k,N,j,R,z,B,U,Y,1,[0,0,0]),ne={u_height_factor:-Math.pow(2,T.overscaledZ)/I.tileSize/8};return Object.assign(K,md(t,I,H),ne)},gm=(h,t,a)=>({u_matrix:h,u_emissive_strength:t,u_ground_shadow_factor:a}),Hl=(h,t,a,d,g,_=0)=>Object.assign(gm(h,t,g),md(a,d,_)),sb=(h,t,a,d)=>({u_matrix:h,u_world:a,u_emissive_strength:t,u_ground_shadow_factor:d}),ob=(h,t,a,d,g,_,b=0)=>Object.assign(Hl(h,t,a,d,_,b),{u_world:g}),ab=(h,t)=>({u_matrix:h,u_ground_shadow_factor:t}),Xh=(h,t,a,d,g)=>({u_matrix:h,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:a,u_height_scale:d,u_reset_depth:g}),lb=(h,t,a,d,g,_,b)=>({u_matrix:h,u_normal_matrix:t,u_opacity:a,u_faux_facade_ao_intensity:d,u_camera_pos:g,u_tile_to_meter:_,u_facade_emissive_chance:b}),cb=h=>({u_matrix:h}),_m=h=>({u_matrix:h}),ym=(h,t,a,d,g,_,b,T)=>{const I=o.al/_.tileSize;return{u_matrix:h,u_inv_rot_matrix:t,u_camera_to_center_distance:a.getCameraToCenterDistance(T),u_extrude_scale:[a.pixelsToGLUnits[0]/I,a.pixelsToGLUnits[1]/I],u_zoom_transition:d,u_tile_id:b,u_merc_center:g}},xm=(h,t,a=1)=>({u_matrix:h,u_color:t,u_overlay:0,u_overlay_scale:a}),Hc=o.bC(),x0=(h,t,a,d,g,_,b)=>{const T=h.transform,I=T.projection.name==="globe",k=I?o.dO(T.zoom,t.canonical)*T._pixelsPerMercatorPixel:o.ay(a,1,_),N={u_matrix:t.projMatrix,u_extrude_scale:k,u_intensity:b,u_inv_rot_matrix:Hc,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(I){N.u_inv_rot_matrix=d,N.u_merc_center=g,N.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],N.u_zoom_transition=o.aj(T.zoom);const j=g[0]*o.al,R=g[1]*o.al;N.u_up_dir=T.projection.upVector(new o.cC(0,0,0),j,R)}return N};function vm(h,[t,a,d,g],[_,b]){if(_===b)return[0,0,0,0];const T=255*(h-1)/(h*(b-_));return[t*T,a*T,d*T,g*T]}function bm(h,t,[a,d]){return a===d?0:.5/h+(t-a)*(h-1)/(h*(d-a))}const Yh=(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H,K,ne,ce)=>({u_matrix:h,u_normalize_matrix:t,u_globe_matrix:a,u_merc_matrix:d,u_grid_matrix:g,u_tl_parent:_,u_scale_parent:k,u_fade_t:N.mix,u_opacity:N.opacity*j.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:j.paint.get("raster-brightness-min"),u_brightness_high:j.paint.get("raster-brightness-max"),u_saturation_factor:o.dQ(j.paint.get("raster-saturation")),u_contrast_factor:o.dP(j.paint.get("raster-contrast")),u_spin_weights:Wl(j.paint.get("raster-hue-rotate")),u_perspective_transform:R,u_raster_elevation:z,u_zoom_transition:b,u_merc_center:T,u_cutoff_params:I,u_colorization_mix:vm(o.dR,U,H),u_colorization_offset:bm(o.dR,Y,H),u_color_ramp:B,u_texture_offset:[ne/(K+2*ne),K/(K+2*ne)],u_texture_res:[K+2*ne,K+2*ne],u_emissive_strength:ce});function Wl(h){h*=Math.PI/180;const t=Math.sin(h),a=Math.cos(h);return[(2*a+1)/3,(-Math.sqrt(3)*t-a+1)/3,(Math.sqrt(3)*t-a+1)/3]}const Zl=.05,sl=(h,t,a,d,g,_,b,T,I,k,N,j)=>({u_matrix:h,u_normalize_matrix:t,u_globe_matrix:a,u_merc_matrix:d,u_grid_matrix:g,u_tl_parent:_,u_scale_parent:k,u_fade_t:N.mix,u_opacity:N.opacity,u_image0:0,u_image1:1,u_raster_elevation:j,u_zoom_transition:b,u_merc_center:T,u_cutoff_params:I}),wm=(h,t,a,d,g,_,b,T,I,k)=>({u_particle_texture:h,u_particle_texture_side_len:t,u_tile_offset:a,u_velocity:d,u_color_ramp:_,u_velocity_res:g,u_max_speed:b,u_uv_offset:T,u_data_scale:[255*I[0],255*I[1]],u_data_offset:k,u_particle_pos_scale:1.1,u_particle_pos_offset:[Zl,Zl]}),Kh=(h,t,a,d,g,_,b,T,I,k)=>({u_particle_texture:h,u_particle_texture_side_len:t,u_velocity:a,u_velocity_res:d,u_max_speed:g,u_speed_factor:_,u_reset_rate:b,u_rand_seed:Math.random(),u_uv_offset:T,u_data_scale:[255*I[0],255*I[1]],u_data_offset:k,u_particle_pos_scale:1.1,u_particle_pos_offset:[Zl,Zl]}),Sm=o.bC(),Tm=(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H,K,ne,ce,ge,pe,_e)=>{const me=g.transform,fe={u_is_size_zoom_constant:+(h==="constant"||h==="source"),u_is_size_feature_constant:+(h==="constant"||h==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:me.getCameraToCenterDistance(K),u_rotate_symbol:+a,u_aspect_ratio:me.width/me.height,u_fade_change:g.options.fadeDuration?g.symbolFadeChange:1,u_matrix:_,u_label_plane_matrix:b,u_coord_matrix:T,u_is_text:+k,u_elevation_from_sea:I?1:0,u_pitch_with_map:+d,u_texsize:N,u_texsize_icon:j,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Sm,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Sm,u_up_vector:[0,-1,0],u_color_adj_mat:ge,u_icon_transition:pe||0,u_gamma_scale:d?g.transform.getCameraToCenterDistance(K)*Math.cos(g.terrain?0:g.transform._pitch):1,u_device_pixel_ratio:o.o.devicePixelRatio,u_is_halo:1,u_scale_factor:_e||1,u_ground_shadow_factor:ne,u_inv_matrix:o.bl(o.bC(),b),u_normal_scale:ce,u_lutTexture:nn.LUT};return K.name==="globe"&&(fe.u_tile_id=[z.canonical.x,z.canonical.y,1<<z.canonical.z],fe.u_zoom_transition=B,fe.u_inv_rot_matrix=Y,fe.u_merc_center=U,fe.u_camera_forward=me._camera.forward(),fe.u_ecef_origin=o.dS(me.globeMatrix,z.toUnwrapped()),fe.u_tile_matrix=Float32Array.from(me.globeMatrix),fe.u_up_vector=H),fe},Jh=(h,t,a,d)=>({u_matrix:h,u_emissive_strength:t,u_opacity:a,u_color:d}),Qh=(h,t,a,d,g,_,b,T,I)=>Object.assign(function(k,N,j,R,z,B){const{width:U,height:Y}=R.imageManager.getPixelSize(N),H=Math.pow(2,B.tileID.overscaledZ),K=B.tileSize*Math.pow(2,R.transform.tileZoom)/H,ne=K*(B.tileID.canonical.x+B.tileID.wrap*H),ce=K*B.tileID.canonical.y;return{u_image:0,u_pattern_tl:j.tl,u_pattern_br:j.br,u_texsize:[U,Y],u_pattern_size:j.displaySize,u_pattern_units_to_pixels:z?[R.transform.width,-1*R.transform.height]:[1/o.ay(B,1,R.transform.tileZoom),1/o.ay(B,1,R.transform.tileZoom)],u_pixel_coord_upper:[ne>>16,ce>>16],u_pixel_coord_lower:[65535&ne,65535&ce]}}(0,_,b,d,T,I),{u_matrix:h,u_emissive_strength:t,u_opacity:a}),Em=new Float32Array(o.bA([])),ef=(h,t,a,d,g,_,b,T,I,k,N,j,R,z=[0,0,0],B)=>{const U=g.style.light,Y=U.properties.get("position"),H=[-Y.x,-Y.y,Y.z],K=o.dL();U.properties.get("anchor")==="viewport"&&(o.dM(K,-g.transform.angle),o.dN(H,H,K));const ne=N.alphaMode==="MASK",ce=U.properties.get("color").toNonPremultipliedRenderColor(null),ge=R.paint.get("model-ambient-occlusion-intensity"),pe=R.paint.get("model-color").constantOr(o.ao.white).toNonPremultipliedRenderColor(null);return pe.a=R.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:h,u_lighting_matrix:t,u_normal_matrix:a,u_node_matrix:d||Em,u_lightpos:H,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[ce.r,ce.g,ce.b],u_camera_pos:z,u_opacity:_,u_baseTextureIsAlpha:0,u_alphaMask:+ne,u_alphaCutoff:N.alphaCutoff,u_baseColorFactor:b.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:T.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:I,u_roughnessFactor:k,u_baseColorTexture:nn.BaseColor,u_metallicRoughnessTexture:nn.MetallicRoughness,u_normalTexture:nn.Normal,u_occlusionTexture:nn.Occlusion,u_emissionTexture:nn.Emission,u_lutTexture:nn.LUT,u_color_mix:pe.toArray01(),u_aoIntensity:ge,u_emissive_strength:j,u_occlusionTextureTransform:B||[0,0,0,0]}},Wc=(h,t=Em,a=Em)=>({u_matrix:h,u_instance:t,u_node_matrix:a}),ub={fillExtrusion:h=>({u_matrix:new o.ck(h),u_lightpos:new o.ch(h),u_lightintensity:new o.ci(h),u_lightcolor:new o.ch(h),u_vertical_gradient:new o.ci(h),u_opacity:new o.ci(h),u_edge_radius:new o.ci(h),u_width_scale:new o.ci(h),u_ao:new o.cj(h),u_height_type:new o.cg(h),u_base_type:new o.cg(h),u_tile_id:new o.ch(h),u_zoom_transition:new o.ci(h),u_inv_rot_matrix:new o.ck(h),u_merc_center:new o.cj(h),u_up_dir:new o.ch(h),u_height_lift:new o.ci(h),u_flood_light_color:new o.ch(h),u_vertical_scale:new o.ci(h),u_flood_light_intensity:new o.ci(h),u_ground_shadow_factor:new o.ch(h)}),fillExtrusionDepth:h=>({u_matrix:new o.ck(h),u_edge_radius:new o.ci(h),u_width_scale:new o.ci(h),u_vertical_scale:new o.ci(h),u_height_type:new o.cg(h),u_base_type:new o.cg(h)}),fillExtrusionPattern:h=>({u_matrix:new o.ck(h),u_lightpos:new o.ch(h),u_lightintensity:new o.ci(h),u_lightcolor:new o.ch(h),u_vertical_gradient:new o.ci(h),u_height_factor:new o.ci(h),u_edge_radius:new o.ci(h),u_width_scale:new o.ci(h),u_ao:new o.cj(h),u_height_type:new o.cg(h),u_base_type:new o.cg(h),u_tile_id:new o.ch(h),u_zoom_transition:new o.ci(h),u_inv_rot_matrix:new o.ck(h),u_merc_center:new o.cj(h),u_up_dir:new o.ch(h),u_height_lift:new o.ci(h),u_image:new o.cg(h),u_texsize:new o.cj(h),u_pixel_coord_upper:new o.cj(h),u_pixel_coord_lower:new o.cj(h),u_tile_units_to_pixels:new o.ci(h),u_opacity:new o.ci(h),u_pattern_transition:new o.ci(h)}),fillExtrusionGroundEffect:h=>({u_matrix:new o.ck(h),u_opacity:new o.ci(h),u_ao_pass:new o.ci(h),u_meter_to_tile:new o.ci(h),u_ao:new o.cj(h),u_flood_light_intensity:new o.ci(h),u_flood_light_color:new o.ch(h),u_attenuation:new o.ci(h),u_edge_radius:new o.ci(h),u_fb:new o.cg(h),u_fb_size:new o.ci(h),u_dynamic_offset:new o.ci(h)}),fill:h=>({u_matrix:new o.ck(h),u_emissive_strength:new o.ci(h),u_ground_shadow_factor:new o.ch(h)}),fillPattern:h=>({u_matrix:new o.ck(h),u_emissive_strength:new o.ci(h),u_image:new o.cg(h),u_texsize:new o.cj(h),u_pixel_coord_upper:new o.cj(h),u_pixel_coord_lower:new o.cj(h),u_tile_units_to_pixels:new o.ci(h),u_ground_shadow_factor:new o.ch(h),u_pattern_transition:new o.ci(h)}),fillOutline:h=>({u_matrix:new o.ck(h),u_emissive_strength:new o.ci(h),u_world:new o.cj(h),u_ground_shadow_factor:new o.ch(h)}),fillOutlinePattern:h=>({u_matrix:new o.ck(h),u_emissive_strength:new o.ci(h),u_world:new o.cj(h),u_image:new o.cg(h),u_texsize:new o.cj(h),u_pixel_coord_upper:new o.cj(h),u_pixel_coord_lower:new o.cj(h),u_tile_units_to_pixels:new o.ci(h),u_ground_shadow_factor:new o.ch(h),u_pattern_transition:new o.ci(h)}),building:h=>({u_matrix:new o.ck(h),u_normal_matrix:new o.ck(h),u_opacity:new o.ci(h),u_faux_facade_ao_intensity:new o.ci(h),u_camera_pos:new o.ch(h),u_tile_to_meter:new o.ci(h),u_facade_emissive_chance:new o.ci(h)}),buildingBloom:h=>({u_matrix:new o.ck(h)}),buildingDepth:h=>({u_matrix:new o.ck(h)}),elevatedStructuresDepth:h=>({u_matrix:new o.ck(h),u_depth_bias:new o.ci(h)}),elevatedStructures:h=>({u_matrix:new o.ck(h),u_ground_shadow_factor:new o.ch(h)}),elevatedStructuresDepthReconstruct:h=>({u_matrix:new o.ck(h),u_camera_pos:new o.ch(h),u_depth_bias:new o.ci(h),u_height_scale:new o.ci(h),u_reset_depth:new o.ci(h)}),circle:o.dV,collisionBox:h=>({u_matrix:new o.ck(h),u_inv_rot_matrix:new o.ck(h),u_camera_to_center_distance:new o.ci(h),u_extrude_scale:new o.cj(h),u_zoom_transition:new o.ci(h),u_merc_center:new o.cj(h),u_tile_id:new o.ch(h)}),collisionCircle:h=>({u_matrix:new o.ck(h),u_inv_matrix:new o.ck(h),u_camera_to_center_distance:new o.ci(h),u_viewport_size:new o.cj(h)}),debug:h=>({u_color:new o.dx(h),u_matrix:new o.ck(h),u_overlay:new o.cg(h),u_overlay_scale:new o.ci(h)}),clippingMask:h=>({u_matrix:new o.ck(h)}),heatmap:h=>({u_extrude_scale:new o.ci(h),u_intensity:new o.ci(h),u_matrix:new o.ck(h),u_inv_rot_matrix:new o.ck(h),u_merc_center:new o.cj(h),u_tile_id:new o.ch(h),u_zoom_transition:new o.ci(h),u_up_dir:new o.ch(h)}),heatmapTexture:h=>({u_image:new o.cg(h),u_color_ramp:new o.cg(h),u_opacity:new o.ci(h)}),hillshade:h=>({u_matrix:new o.ck(h),u_image:new o.cg(h),u_latrange:new o.cj(h),u_light:new o.cj(h),u_shadow:new o.dx(h),u_highlight:new o.dx(h),u_emissive_strength:new o.ci(h),u_accent:new o.dx(h)}),hillshadePrepare:h=>({u_matrix:new o.ck(h),u_image:new o.cg(h),u_dimension:new o.cj(h),u_zoom:new o.ci(h)}),line:o.dU,linePattern:o.dT,raster:h=>({u_matrix:new o.ck(h),u_normalize_matrix:new o.ck(h),u_globe_matrix:new o.ck(h),u_merc_matrix:new o.ck(h),u_grid_matrix:new o.dy(h),u_tl_parent:new o.cj(h),u_scale_parent:new o.ci(h),u_fade_t:new o.ci(h),u_opacity:new o.ci(h),u_image0:new o.cg(h),u_image1:new o.cg(h),u_brightness_low:new o.ci(h),u_brightness_high:new o.ci(h),u_saturation_factor:new o.ci(h),u_contrast_factor:new o.ci(h),u_spin_weights:new o.ch(h),u_perspective_transform:new o.cj(h),u_raster_elevation:new o.ci(h),u_zoom_transition:new o.ci(h),u_merc_center:new o.cj(h),u_cutoff_params:new o.d2(h),u_colorization_mix:new o.d2(h),u_colorization_offset:new o.ci(h),u_color_ramp:new o.cg(h),u_texture_offset:new o.cj(h),u_texture_res:new o.cj(h),u_emissive_strength:new o.ci(h)}),rasterParticle:h=>({u_matrix:new o.ck(h),u_normalize_matrix:new o.ck(h),u_globe_matrix:new o.ck(h),u_merc_matrix:new o.ck(h),u_grid_matrix:new o.dy(h),u_tl_parent:new o.cj(h),u_scale_parent:new o.ci(h),u_fade_t:new o.ci(h),u_opacity:new o.ci(h),u_image0:new o.cg(h),u_image1:new o.cg(h),u_raster_elevation:new o.ci(h),u_zoom_transition:new o.ci(h),u_merc_center:new o.cj(h),u_cutoff_params:new o.d2(h)}),rasterParticleTexture:h=>({u_texture:new o.cg(h),u_opacity:new o.ci(h)}),rasterParticleDraw:h=>({u_particle_texture:new o.cg(h),u_particle_texture_side_len:new o.ci(h),u_tile_offset:new o.cj(h),u_velocity:new o.cg(h),u_color_ramp:new o.cg(h),u_velocity_res:new o.cj(h),u_max_speed:new o.ci(h),u_uv_offset:new o.cj(h),u_data_scale:new o.cj(h),u_data_offset:new o.ci(h),u_particle_pos_scale:new o.ci(h),u_particle_pos_offset:new o.cj(h)}),rasterParticleUpdate:h=>({u_particle_texture:new o.cg(h),u_particle_texture_side_len:new o.ci(h),u_velocity:new o.cg(h),u_velocity_res:new o.cj(h),u_max_speed:new o.ci(h),u_speed_factor:new o.ci(h),u_reset_rate:new o.ci(h),u_rand_seed:new o.ci(h),u_uv_offset:new o.cj(h),u_data_scale:new o.cj(h),u_data_offset:new o.ci(h),u_particle_pos_scale:new o.ci(h),u_particle_pos_offset:new o.cj(h)}),symbol:h=>({u_is_size_zoom_constant:new o.cg(h),u_is_size_feature_constant:new o.cg(h),u_size_t:new o.ci(h),u_size:new o.ci(h),u_camera_to_center_distance:new o.ci(h),u_rotate_symbol:new o.cg(h),u_aspect_ratio:new o.ci(h),u_fade_change:new o.ci(h),u_matrix:new o.ck(h),u_label_plane_matrix:new o.ck(h),u_coord_matrix:new o.ck(h),u_is_text:new o.cg(h),u_elevation_from_sea:new o.cg(h),u_pitch_with_map:new o.cg(h),u_texsize:new o.cj(h),u_texsize_icon:new o.cj(h),u_texture:new o.cg(h),u_texture_icon:new o.cg(h),u_gamma_scale:new o.ci(h),u_device_pixel_ratio:new o.ci(h),u_tile_id:new o.ch(h),u_zoom_transition:new o.ci(h),u_inv_rot_matrix:new o.ck(h),u_merc_center:new o.cj(h),u_camera_forward:new o.ch(h),u_tile_matrix:new o.ck(h),u_up_vector:new o.ch(h),u_ecef_origin:new o.ch(h),u_is_halo:new o.cg(h),u_icon_transition:new o.ci(h),u_color_adj_mat:new o.ck(h),u_scale_factor:new o.ci(h),u_ground_shadow_factor:new o.ch(h),u_inv_matrix:new o.ck(h),u_normal_scale:new o.ci(h),u_lutTexture:new o.cg(h)}),background:h=>({u_matrix:new o.ck(h),u_emissive_strength:new o.ci(h),u_opacity:new o.ci(h),u_color:new o.dx(h)}),backgroundPattern:h=>({u_matrix:new o.ck(h),u_emissive_strength:new o.ci(h),u_opacity:new o.ci(h),u_image:new o.cg(h),u_pattern_tl:new o.cj(h),u_pattern_br:new o.cj(h),u_texsize:new o.cj(h),u_pattern_size:new o.cj(h),u_pixel_coord_upper:new o.cj(h),u_pixel_coord_lower:new o.cj(h),u_pattern_units_to_pixels:new o.cj(h)}),terrainRaster:h=>({u_matrix:new o.ck(h),u_image0:new o.cg(h),u_skirt_height:new o.ci(h),u_ground_shadow_factor:new o.ch(h)}),skybox:h=>({u_matrix:new o.ck(h),u_sun_direction:new o.ch(h),u_cubemap:new o.cg(h),u_opacity:new o.ci(h),u_temporal_offset:new o.ci(h)}),skyboxGradient:h=>({u_matrix:new o.ck(h),u_color_ramp:new o.cg(h),u_center_direction:new o.ch(h),u_radius:new o.ci(h),u_opacity:new o.ci(h),u_temporal_offset:new o.ci(h)}),skyboxCapture:h=>({u_matrix_3f:new o.dy(h),u_sun_direction:new o.ch(h),u_sun_intensity:new o.ci(h),u_color_tint_r:new o.d2(h),u_color_tint_m:new o.d2(h),u_luminance:new o.ci(h)}),globeRaster:h=>({u_proj_matrix:new o.ck(h),u_globe_matrix:new o.ck(h),u_normalize_matrix:new o.ck(h),u_merc_matrix:new o.ck(h),u_zoom_transition:new o.ci(h),u_merc_center:new o.cj(h),u_image0:new o.cg(h),u_grid_matrix:new o.dy(h),u_skirt_height:new o.ci(h),u_far_z_cutoff:new o.ci(h),u_frustum_tl:new o.ch(h),u_frustum_tr:new o.ch(h),u_frustum_br:new o.ch(h),u_frustum_bl:new o.ch(h),u_globe_pos:new o.ch(h),u_globe_radius:new o.ci(h),u_viewport:new o.cj(h)}),globeAtmosphere:h=>({u_frustum_tl:new o.ch(h),u_frustum_tr:new o.ch(h),u_frustum_br:new o.ch(h),u_frustum_bl:new o.ch(h),u_horizon:new o.ci(h),u_transition:new o.ci(h),u_fadeout_range:new o.ci(h),u_atmosphere_fog_color:new o.d2(h),u_high_color:new o.d2(h),u_space_color:new o.d2(h),u_temporal_offset:new o.ci(h),u_horizon_angle:new o.ci(h)}),model:h=>({u_matrix:new o.ck(h),u_lighting_matrix:new o.ck(h),u_normal_matrix:new o.ck(h),u_node_matrix:new o.ck(h),u_lightpos:new o.ch(h),u_lightintensity:new o.ci(h),u_lightcolor:new o.ch(h),u_camera_pos:new o.ch(h),u_opacity:new o.ci(h),u_baseColorFactor:new o.d2(h),u_emissiveFactor:new o.d2(h),u_metallicFactor:new o.ci(h),u_roughnessFactor:new o.ci(h),u_baseTextureIsAlpha:new o.cg(h),u_alphaMask:new o.cg(h),u_alphaCutoff:new o.ci(h),u_baseColorTexture:new o.cg(h),u_metallicRoughnessTexture:new o.cg(h),u_normalTexture:new o.cg(h),u_occlusionTexture:new o.cg(h),u_emissionTexture:new o.cg(h),u_lutTexture:new o.cg(h),u_color_mix:new o.d2(h),u_aoIntensity:new o.ci(h),u_emissive_strength:new o.ci(h),u_occlusionTextureTransform:new o.d2(h)}),modelDepth:h=>({u_matrix:new o.ck(h),u_instance:new o.ck(h),u_node_matrix:new o.ck(h)}),groundShadow:h=>({u_matrix:new o.ck(h),u_ground_shadow_factor:new o.ch(h)}),stars:h=>({u_matrix:new o.ck(h),u_up:new o.ch(h),u_right:new o.ch(h),u_intensity_multiplier:new o.ci(h)}),snowParticle:h=>({u_modelview:new o.ck(h),u_projection:new o.ck(h),u_time:new o.ci(h),u_cam_pos:new o.ch(h),u_velocityConeAperture:new o.ci(h),u_velocity:new o.ci(h),u_horizontalOscillationRadius:new o.ci(h),u_horizontalOscillationRate:new o.ci(h),u_boxSize:new o.ci(h),u_billboardSize:new o.ci(h),u_simpleShapeParameters:new o.cj(h),u_screenSize:new o.cj(h),u_thinningCenterPos:new o.cj(h),u_thinningShape:new o.ch(h),u_thinningAffectedRatio:new o.ci(h),u_thinningParticleOffset:new o.ci(h),u_particleColor:new o.d2(h),u_direction:new o.ch(h)}),rainParticle:h=>({u_modelview:new o.ck(h),u_projection:new o.ck(h),u_time:new o.ci(h),u_cam_pos:new o.ch(h),u_texScreen:new o.cg(h),u_velocityConeAperture:new o.ci(h),u_velocity:new o.ci(h),u_boxSize:new o.ci(h),u_rainDropletSize:new o.cj(h),u_distortionStrength:new o.ci(h),u_rainDirection:new o.ch(h),u_color:new o.d2(h),u_screenSize:new o.cj(h),u_thinningCenterPos:new o.cj(h),u_thinningShape:new o.ch(h),u_thinningAffectedRatio:new o.ci(h),u_thinningParticleOffset:new o.ci(h),u_shapeDirectionalPower:new o.ci(h),u_shapeNormalPower:new o.ci(h),u_mode:new o.ci(h)}),vignette:h=>({u_vignetteShape:new o.ch(h),u_vignetteColor:new o.d2(h)}),occlusion:h=>({u_matrix:new o.ck(h),u_anchorPos:new o.ch(h),u_screenSizePx:new o.cj(h),u_occluderSizePx:new o.cj(h),u_color:new o.d2(h)})};class ol{constructor(t,a,d,g){this.id=ol.uniqueIdxCounter,ol.uniqueIdxCounter++,this.context=t;const _=t.gl;this.buffer=_.createBuffer(),this.dynamicDraw=!!d,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?_.DYNAMIC_DRAW:_.STATIC_DRAW),this.dynamicDraw||g||a.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=ol.uniqueIdxCounter,ol.uniqueIdxCounter++;const a=this.context.gl;this.context.unbindVAO(),this.bind(),a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ol.uniqueIdxCounter=0;const v0={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class db{constructor(t,a,d,g,_,b){this.length=a.length,this.attributes=d,this.itemSize=a.bytesPerElement,this.dynamicDraw=g,this.instanceCount=b,this.context=t;const T=t.gl;this.buffer=T.createBuffer(),t.bindVertexBuffer.set(this.buffer),T.bufferData(T.ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?T.DYNAMIC_DRAW:T.STATIC_DRAW),this.dynamicDraw||_||a.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const a=this.context.gl;this.bind(),a.bufferSubData(a.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,a){for(let d=0;d<this.attributes.length;d++){const g=a.getAttributeLocation(t,this.attributes[d].name);g!==-1&&t.enableVertexAttribArray(g)}}setVertexAttribPointers(t,a,d){for(let g=0;g<this.attributes.length;g++){const _=this.attributes[g],b=a.getAttributeLocation(t,_.name);b!==-1&&t.vertexAttribPointer(b,_.components,t[v0[_.type]],!1,this.itemSize,_.offset+this.itemSize*(d||0))}}setVertexAttribDivisor(t,a,d){for(let g=0;g<this.attributes.length;g++){const _=a.getAttributeLocation(t,this.attributes[g].name);_!==-1&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(_,d)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class tf{constructor(t,a,d,g,_){this.context=t,this.width=a,this.height=d;const b=this.framebuffer=t.gl.createFramebuffer();g&&(this.colorAttachment=new m0(t,b)),_&&(this.depthAttachmentType=_,this.depthAttachment=_==="renderbuffer"?new g0(t,b):new rb(t,b))}destroy(){const t=this.context.gl;if(this.colorAttachment){const a=this.colorAttachment.get();a&&t.deleteTexture(a)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const a=this.depthAttachment.get();a&&t.deleteRenderbuffer(a)}else{const a=this.depthAttachment.get();a&&t.deleteTexture(a)}t.deleteFramebuffer(this.framebuffer)}}class Im{constructor(t,a){this.gl=t,this.clearColor=new a0(this),this.clearDepth=new nm(this),this.clearStencil=new Yv(this),this.colorMask=new Kv(this),this.depthMask=new Jv(this),this.stencilMask=new Qv(this),this.stencilFunc=new l0(this),this.stencilOp=new eb(this),this.stencilTest=new jh(this),this.depthRange=new tb(this),this.depthTest=new c0(this),this.depthFunc=new sm(this),this.blend=new zh(this),this.blendFunc=new om(this),this.blendColor=new $l(this),this.blendEquation=new Vc(this),this.cullFace=new Fh(this),this.cullFaceSide=new Bh(this),this.frontFace=new $c(this),this.program=new u0(this),this.activeTexture=new am(this),this.viewport=new d0(this),this.bindFramebuffer=new Gc(this),this.bindRenderbuffer=new Uh(this),this.bindTexture=new Vh(this),this.bindVertexBuffer=new lm(this),this.bindElementBuffer=new $h(this),this.bindVertexArrayOES=new fd(this),this.pixelStoreUnpack=new h0(this),this.pixelStoreUnpackPremultiplyAlpha=new f0(this),this.pixelStoreUnpackFlipY=new p0(this),this.options=a?Object.assign({},a):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=a&&!!a.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,a,d){return new ol(this,t,a,d)}createVertexBuffer(t,a,d,g,_){return new db(this,t,a,d,g,_)}createRenderbuffer(t,a,d){const g=this.gl,_=g.createRenderbuffer();return this.bindRenderbuffer.set(_),g.renderbufferStorage(g.RENDERBUFFER,t,a,d),this.bindRenderbuffer.set(null),_}createFramebuffer(t,a,d,g){return new tf(this,t,a,d,g)}clear({color:t,depth:a,stencil:d,colorMask:g}){const _=this.gl;let b=0;t&&(b|=_.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(g||[!0,!0,!0,!0])),a!==void 0&&(b|=_.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(a),this.depthMask.set(!0)),d!==void 0&&(b|=_.STENCIL_BUFFER_BIT,this.clearStencil.set(d),this.stencilMask.set(255)),_.clear(b)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){o.by(t.blendFunction,vr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let ra;function _d(h,t,a,d,g,_,b){const T=h.context,I=T.gl,k=h.transform,N=[o.aF(k.center.lng),o.aJ(k.center.lat)],j=a.layout.get("symbol-placement"),R=a.layout.get("text-variable-anchor"),z=a.layout.get("icon-rotation-alignment")==="map",B=a.layout.get("text-rotation-alignment")==="map",U=j!=="point",Y=[];let H=0,K=0;for(let fe=0;fe<d.length;fe++){const ye=d[fe],Fe=t.getTile(ye),Pe=Fe.getBucket(a);if(!Pe)continue;const Ze=Pe.getProjection().createInversionMatrix(k,ye.canonical),De=[],He=K_(ye,Pe,k),_t=!b&&z&&U,ze=b&&B&&U,Ie=R&&Pe.hasTextData(),Ye=Pe.hasIconTextFit()&&Ie&&Pe.hasIconData(),Ue=_t||ze||b&&Ie||Ye,nt=Pe.projection.name==="globe",gt=nt?o.aj(k.zoom):0;nt&&(De.push("PROJECTION_GLOBE_VIEW"),Ue&&De.push("PROJECTED_POS_ON_VIEWPORT"));const Et=h.getOrCreateProgram("collisionBox",{defines:De});let dt=He;g[0]===0&&g[1]===0||(dt=h.translatePosMatrix(He,Fe,g,_));const lt=b?Pe.textCollisionBox:Pe.iconCollisionBox,Ft=Pe.collisionCircleArray;if(Ft.length>0){const zt=o.bC(),Ot=dt;o.cO(zt,Pe.placementInvProjMatrix,k.glCoordMatrix),o.cO(zt,zt,Pe.placementViewportMatrix),Y.push({circleArray:Ft,circleOffset:K,transform:Ot,invTransform:zt,projection:Pe.getProjection()}),H+=Ft.length/4,K=H}if(!lt)continue;h.terrain&&h.terrain.setupElevationDraw(Fe,Et);const Dt=nt?[ye.canonical.x,ye.canonical.y,1<<ye.canonical.z]:[0,0,0];Et.draw(h,I.LINES,At.disabled,Jt.disabled,h.colorModeForRenderPass(),ir.disabled,ym(dt,Ze,k,gt,N,Fe,Dt,Pe.getProjection()),a.id,lt.layoutVertexBuffer,lt.indexBuffer,lt.segments,null,k.zoom,null,[lt.collisionVertexBuffer,lt.collisionVertexBufferExt])}if(!b||!Y.length)return;const ne=h.getOrCreateProgram("collisionCircle"),ce=new o.dW;ce.resize(4*H),ce._trim();let ge=0;for(const fe of Y)for(let ye=0;ye<fe.circleArray.length/4;ye++){const Fe=4*ye,Pe=fe.circleArray[Fe+0],Ze=fe.circleArray[Fe+1],De=fe.circleArray[Fe+2],He=fe.circleArray[Fe+3];ce.emplace(ge++,Pe,Ze,De,He,0),ce.emplace(ge++,Pe,Ze,De,He,1),ce.emplace(ge++,Pe,Ze,De,He,2),ce.emplace(ge++,Pe,Ze,De,He,3)}(!ra||ra.length<2*H)&&(ra=function(fe){const ye=2*fe,Fe=new o.b1;Fe.resize(ye),Fe._trim();for(let Pe=0;Pe<ye;Pe++){const Ze=6*Pe;Fe.uint16[Ze+0]=4*Pe+0,Fe.uint16[Ze+1]=4*Pe+1,Fe.uint16[Ze+2]=4*Pe+2,Fe.uint16[Ze+3]=4*Pe+2,Fe.uint16[Ze+4]=4*Pe+3,Fe.uint16[Ze+5]=4*Pe+0}return Fe}(H));const pe=T.createIndexBuffer(ra,!0),_e=T.createVertexBuffer(ce,o.dX.members,!0);for(const fe of Y){const ye={u_matrix:fe.transform,u_inv_matrix:fe.invTransform,u_camera_to_center_distance:(me=k).getCameraToCenterDistance(fe.projection),u_viewport_size:[me.width,me.height]};ne.draw(h,I.TRIANGLES,At.disabled,Jt.disabled,h.colorModeForRenderPass(),ir.disabled,ye,a.id,_e,pe,o.bg.simpleSegment(0,2*fe.circleOffset,fe.circleArray.length,fe.circleArray.length/2),null,k.zoom)}var me;_e.destroy(),pe.destroy()}const al=o.bC();function Cm(h){const t=h._camera.getWorldToCamera(h.worldSize,1),a=o.aB([],t,h.globeMatrix);o.bl(a,a);const d=[0,0,0],g=[0,1,0,0];return o.aC(g,g,a),d[0]=g[0],d[1]=g[1],d[2]=g[2],o.aw(d,d),d}function rf({width:h,height:t,anchor:a,textOffset:d,textScale:g},_){const{horizontalAlign:b,verticalAlign:T}=o.c0(a),I=-(b-.5)*h,k=-(T-.5)*t,N=o.c1(a,d);return new o.P((I/g+N[0])*_,(k/g+N[1])*_)}function nf(h,t,a,d,g,_,b,T,I,k){const N=h.text.placedSymbolArray,j=h.text.dynamicLayoutVertexArray,R=h.icon.dynamicLayoutVertexArray,z={},B=h.getProjection(),U=jl(b,B,g),Y=g.elevation,H=B.upVectorScale(b.canonical,g.center.lat,g.worldSize).metersToTile;j.clear();for(let K=0;K<N.length;K++){const ne=N.get(K),{tileAnchorX:ce,tileAnchorY:ge,numGlyphs:pe}=ne,_e=ne.hidden||!ne.crossTileID||h.allowVerticalPlacement&&!ne.placedOrientation?null:d[ne.crossTileID];if(_e){let me=0,fe=0,ye=0;if(Y){const Ye=Y?Y.getAtTileOffset(b,ce,ge):0,[Ue,nt,gt]=B.upVector(b.canonical,ce,ge);me=Ye*Ue*H,fe=Ye*nt*H,ye=Ye*gt*H}let[Fe,Pe,Ze,De]=Zs(ne.projectedAnchorX+me,ne.projectedAnchorY+fe,ne.projectedAnchorZ+ye,a?U:_);const He=zl(g.getCameraToCenterDistance(B),De);let _t=o.bM(h.textSizeData,I,ne)*He/o.bX;a&&(_t*=h.tilePixelRatio/T);const ze=rf(_e,_t);a?({x:Fe,y:Pe,z:Ze}=B.projectTilePoint(ce+ze.x,ge+ze.y,b.canonical),[Fe,Pe,Ze]=Zs(Fe+me,Pe+fe,Ze+ye,_)):(t&&ze._rotate(-g.angle),Fe+=ze.x,Pe+=ze.y,Ze=0);const Ie=h.allowVerticalPlacement&&ne.placedOrientation===o.bL.vertical?Math.PI/2:0;for(let Ye=0;Ye<pe;Ye++)o.bO(j,Fe,Pe,Ze,Ie);k&&ne.associatedIconIndex>=0&&(z[ne.associatedIconIndex]={x:Fe,y:Pe,z:Ze,angle:Ie})}else Yt(pe,j)}if(k){R.clear();const K=h.icon.placedSymbolArray;for(let ne=0;ne<K.length;ne++){const ce=K.get(ne),{numGlyphs:ge}=ce,pe=z[ne];if(ce.hidden||!pe)Yt(ge,R);else{const{x:_e,y:me,z:fe,angle:ye}=pe;for(let Fe=0;Fe<ge;Fe++)o.bO(R,_e,me,fe,ye)}}h.icon.dynamicLayoutVertexBuffer.updateData(R)}h.text.dynamicLayoutVertexBuffer.updateData(j)}function yd(h,t,a,d,g,_,b={}){const T=a.paint.get("icon-translate"),I=a.paint.get("text-translate"),k=a.paint.get("icon-translate-anchor"),N=a.paint.get("text-translate-anchor"),j=a.layout.get("icon-rotation-alignment"),R=a.layout.get("text-rotation-alignment"),z=a.layout.get("icon-pitch-alignment"),B=a.layout.get("text-pitch-alignment"),U=a.layout.get("icon-keep-upright"),Y=a.layout.get("text-keep-upright"),H=a.paint.get("icon-color-saturation"),K=a.paint.get("icon-color-contrast"),ne=a.paint.get("icon-color-brightness-min"),ce=a.paint.get("icon-color-brightness-max"),ge=a.layout.get("symbol-elevation-reference")==="sea",pe=a.layout.get("icon-image-use-theme")==="none",_e=h.context,me=_e.gl,fe=h.transform,ye=j==="map",Fe=R==="map",Pe=z==="map",Ze=B==="map",De=a.layout.get("symbol-sort-key").constantOr(1)!==void 0;let He=!1;const _t=h.depthModeForSublayer(0,At.ReadOnly),ze=new At(h.context.gl.LEQUAL,At.ReadOnly,h.depthRangeFor3D),Ie=[o.aF(fe.center.lng),o.aJ(fe.center.lat)],Ye=a.layout.get("text-variable-anchor"),Ue=fe.projection.name==="globe",nt=[],gt=[0,-1,0];for(const Et of d){const dt=t.getTile(Et),lt=dt.getBucket(a);if(!lt||lt.projection.name==="mercator"&&Ue||lt.fullyClipped)continue;const Ft=lt.projection.name==="globe",Dt=Ft?o.aj(fe.zoom):0,zt=jl(Et,lt.getProjection(),fe),Ot=fe.calculatePixelsToTileUnitsMatrix(dt),nr=Ye&&lt.hasTextData(),gr=lt.hasIconTextFit()&&nr&&lt.hasIconData(),br=lt.getProjection().createInversionMatrix(fe,Et.canonical),ii=(1<<dt.tileID.canonical.z)*o.al/h.transform.worldSize,lr=ki=>{let wr=[0,0,0];if(ki){const Qt=h.style.directionalLight,ni=h.style.ambientLight;Qt&&ni&&(wr=Oo(h.style,Qt,ni))}return wr},qr=ki=>{fe.depthOcclusionForSymbolsAndCircles&&(a.hasOcclusionOpacityProperties||h.terrain)&&(ki.push("DEPTH_D24"),ki.push("DEPTH_OCCLUSION"))},ei=ki=>{a.lut&&!pe&&(a.lut.texture||(a.lut.texture=new o.dY(h.context,a.lut.image,[a.lut.image.height,a.lut.image.height,a.lut.image.height],_e.gl.RGBA8)),_e.activeTexture.set(_e.gl.TEXTURE0+nn.LUT),a.lut.texture&&a.lut.texture.bind(_e.gl.LINEAR,_e.gl.CLAMP_TO_EDGE),ki.push("APPLY_LUT_ON_GPU"))},Ii=()=>{const ki=ye&&a.layout.get("symbol-placement")!=="point",wr=[];qr(wr),ei(wr);const Qt=ki||gr,ni=lt.elevationType==="road",Gi=h.shadowRenderer,Ri=ni&&Pe&&!!Gi&&Gi.enabled,sn=lr(Ri),zn=ni&&Pe&&!h.terrain?ze:_t,eo=a.paint.get("icon-image-cross-fade");h.terrainRenderModeElevated()&&Pe&&wr.push("PITCH_WITH_MAP_TERRAIN"),Ft&&(wr.push("PROJECTION_GLOBE_VIEW"),Qt&&wr.push("PROJECTED_POS_ON_VIEWPORT")),eo>0&&lt.hasAnySecondaryIcon&&wr.push("ICON_TRANSITION"),!lt.icon.zOffsetVertexBuffer||ni&&h.terrain||wr.push("Z_OFFSET"),H===0&&K===0&&ne===0&&ce===1||wr.push("COLOR_ADJUSTMENT"),lt.sdfIcons&&wr.push("RENDER_SDF"),Ri&&wr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ni&&Pe&&!h.terrain&&lt.icon.orientationVertexBuffer&&wr.push("ELEVATED_ROADS");const to=lt.icon.programConfigurations.get(a.id),Ls=h.getOrCreateProgram("symbol",{config:to,defines:wr}),Os=dt.imageAtlasTexture?dt.imageAtlasTexture.size:[0,0],gs=lt.iconSizeData,_o=o.bK(gs,fe.zoom),Fo=Pe||!fe.isOrthographic,Xi=No(zt,dt.tileID.canonical,Pe,ye,fe,lt.getProjection(),Ot),Ji=bh(zt,dt.tileID.canonical,Pe,ye,fe,lt.getProjection(),Ot),Li=h.translatePosMatrix(Ji,dt,T,k,!0),mn=h.translatePosMatrix(zt,dt,T,k),Pn=Qt?al:Xi,en=ye&&!Pe&&!ki;let Xn=gt;!Ue&&!fe.mercatorFromTransition||ye||(Xn=Cm(fe));const oa=Ft?Xn:gt,Aa=a.getColorAdjustmentMatrix(H,K,ne,ce),Bo=Tm(gs.kind,_o,en,Pe,h,mn,Pn,Li,ge,!1,Os,[0,0],0,Et,Dt,Ie,br,oa,lt.getProjection(),sn,ii,Aa,eo,null),gl=dt.imageAtlasTexture?dt.imageAtlasTexture:null,_l=a.layout.get("icon-size").constantOr(0)!==1||lt.iconsNeedLinear,aa=lt.sdfIcons||h.options.rotating||h.options.zooming||_l||Fo?me.LINEAR:me.NEAREST,su=lt.sdfIcons&&a.paint.get("icon-halo-width").constantOr(1)!==0,Pa=h.terrain&&Pe&&ki?o.bl(o.bC(),Xi):al;if(ki&&lt.icon){const la=fe.elevation,ka=la?la.getAtTileOffsetFunc(Et,fe.center.lat,fe.worldSize,lt.getProjection()):null,Ef=td(zt,dt.tileID.canonical,Pe,ye,fe,lt.getProjection(),Ot);Hp(lt,zt,h,!1,Ef,Ji,Pe,U,ka,Et)}return{program:Ls,buffers:lt.icon,uniformValues:Bo,atlasTexture:gl,atlasTextureIcon:null,atlasInterpolation:aa,atlasInterpolationIcon:null,isSDF:lt.sdfIcons,hasHalo:su,depthMode:zn,tile:dt,renderWithShadows:Ri,labelPlaneMatrixInv:Pa}},_r=()=>{const ki=Fe&&a.layout.get("symbol-placement")!=="point",wr=[],Qt=ki||Ye||gr,ni=lt.elevationType==="road",Gi=h.shadowRenderer,Ri=ni&&Ze&&!!Gi&&Gi.enabled,sn=lr(Ri),zn=ni&&Ze&&!h.terrain?ze:_t;h.terrainRenderModeElevated()&&Ze&&wr.push("PITCH_WITH_MAP_TERRAIN"),Ft&&(wr.push("PROJECTION_GLOBE_VIEW"),Qt&&wr.push("PROJECTED_POS_ON_VIEWPORT")),!lt.text.zOffsetVertexBuffer||ni&&h.terrain||wr.push("Z_OFFSET"),lt.iconsInText&&wr.push("RENDER_TEXT_AND_SYMBOL"),wr.push("RENDER_SDF"),Ri&&wr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ni&&Ze&&!h.terrain&&lt.text.orientationVertexBuffer&&wr.push("ELEVATED_ROADS"),qr(wr);const eo=lt.text.programConfigurations.get(a.id),to=h.getOrCreateProgram("symbol",{config:eo,defines:wr});let Ls,Os=[0,0],gs=null;const _o=lt.textSizeData;lt.iconsInText&&(Os=dt.imageAtlasTexture?dt.imageAtlasTexture.size:[0,0],gs=dt.imageAtlasTexture?dt.imageAtlasTexture:null,Ls=Ze||!fe.isOrthographic||h.options.rotating||h.options.zooming||_o.kind==="composite"||_o.kind==="camera"?me.LINEAR:me.NEAREST);const Fo=dt.glyphAtlasTexture?dt.glyphAtlasTexture.size:[0,0],Xi=a.layout.get("text-size-scale-range"),Ji=o.aA(h.scaleFactor,Xi[0],Xi[1]),Li=o.bK(_o,fe.zoom,Ji),mn=No(zt,dt.tileID.canonical,Ze,Fe,fe,lt.getProjection(),Ot),Pn=bh(zt,dt.tileID.canonical,Ze,Fe,fe,lt.getProjection(),Ot),en=h.translatePosMatrix(Pn,dt,I,N,!0),Xn=h.translatePosMatrix(zt,dt,I,N),oa=Qt?al:mn,Aa=Fe&&!Ze&&!ki;let Bo=gt;!Ue&&!fe.mercatorFromTransition||Fe||(Bo=Cm(fe));const gl=Tm(_o.kind,Li,Aa,Ze,h,Xn,oa,en,ge,!0,Fo,Os,0,Et,Dt,Ie,br,Ft?Bo:gt,lt.getProjection(),sn,ii,null,null,Ji),_l=dt.glyphAtlasTexture?dt.glyphAtlasTexture:null,aa=me.LINEAR,su=a.paint.get("text-halo-width").constantOr(1)!==0,Pa=h.terrain&&Ze&&ki?o.bl(o.bC(),mn):al;if(ki&&lt.text){const la=fe.elevation,ka=la?la.getAtTileOffsetFunc(Et,fe.center.lat,fe.worldSize,lt.getProjection()):null,Ef=td(zt,dt.tileID.canonical,Ze,Fe,fe,lt.getProjection(),Ot);Hp(lt,zt,h,!0,Ef,Pn,Ze,Y,ka,Et)}return{program:to,buffers:lt.text,uniformValues:gl,atlasTexture:_l,atlasTextureIcon:gs,atlasInterpolation:aa,atlasInterpolationIcon:Ls,isSDF:!0,hasHalo:su,depthMode:zn,tile:dt,renderWithShadows:Ri,labelPlaneMatrixInv:Pa}},Xr=lt.icon.segments.get().length,Wr=lt.text.segments.get().length,Jr=Xr&&!b.onlyText?Ii():null,Pi=Wr&&!b.onlyIcons?_r():null,Ki=a.paint.get("icon-opacity").constantOr(1),An=a.paint.get("text-opacity").constantOr(1);if(De&&lt.canOverlap){He=!0;const ki=Ki&&!b.onlyText?lt.icon.segments.get():[],wr=An&&!b.onlyIcons?lt.text.segments.get():[];for(const Qt of ki)nt.push({segments:new o.bg([Qt]),sortKey:Qt.sortKey,state:Jr});for(const Qt of wr)nt.push({segments:new o.bg([Qt]),sortKey:Qt.sortKey,state:Pi})}else b.onlyText||nt.push({segments:Ki?lt.icon.segments:new o.bg([]),sortKey:0,state:Jr}),b.onlyIcons||nt.push({segments:An?lt.text.segments:new o.bg([]),sortKey:0,state:Pi})}He&&nt.sort((Et,dt)=>Et.sortKey-dt.sortKey);for(const Et of nt){const dt=Et.state;if(dt)if(h.terrain?h.terrain.setupElevationDraw(dt.tile,dt.program,{useDepthForOcclusion:fe.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:dt.labelPlaneMatrixInv}):h.setupDepthForOcclusion(fe.depthOcclusionForSymbolsAndCircles,dt.program),_e.activeTexture.set(me.TEXTURE0),dt.atlasTexture&&dt.atlasTexture.bind(dt.atlasInterpolation,me.CLAMP_TO_EDGE,!0),dt.atlasTextureIcon&&(_e.activeTexture.set(me.TEXTURE1),dt.atlasTextureIcon&&dt.atlasTextureIcon.bind(dt.atlasInterpolationIcon,me.CLAMP_TO_EDGE,!0)),dt.renderWithShadows&&h.shadowRenderer.setupShadows(dt.tile.tileID.toUnwrapped(),dt.program,"vector-tile"),h.uploadCommonLightUniforms(h.context,dt.program),dt.hasHalo){const lt=dt.uniformValues;lt.u_is_halo=1,sf(dt.buffers,Et.segments,a,h,dt.program,dt.depthMode,g,_,lt,2),lt.u_is_halo=0}else{if(dt.isSDF){const lt=dt.uniformValues;dt.hasHalo&&(lt.u_is_halo=1,sf(dt.buffers,Et.segments,a,h,dt.program,dt.depthMode,g,_,lt,1)),lt.u_is_halo=0}sf(dt.buffers,Et.segments,a,h,dt.program,dt.depthMode,g,_,dt.uniformValues,1)}}}function sf(h,t,a,d,g,_,b,T,I,k){const N=[h.dynamicLayoutVertexBuffer,h.opacityVertexBuffer,h.iconTransitioningVertexBuffer,h.globeExtVertexBuffer,h.zOffsetVertexBuffer,h.orientationVertexBuffer];g.draw(d,d.context.gl.TRIANGLES,_,b,T,ir.disabled,I,a.id,h.layoutVertexBuffer,h.indexBuffer,t,a.paint,d.transform.zoom,h.programConfigurations.get(a.id),N,k)}function b0(h,t){const a=1<<h.canonical.z,d=(t.x*a-h.canonical.x-h.wrap*a)*o.al,g=(t.y*a-h.canonical.y)*o.al,_=o.e5(t.z,t.y);return o.d4(d,g,_)}function Xl(h,t,a,d,g){if(!a.layout||a.layout.get("fill-elevation-reference")==="none")return;const _=h.context.gl,b=new At(h.context.gl.LEQUAL,At.ReadWrite,h.depthRangeFor3D),T=new At(h.context.gl.GREATER,At.ReadWrite,h.depthRangeFor3D),I=function(z){let B=.01;return z.isOrthographic&&(B=o.ak(1e-4,B,o.c$(z.pitch>=Sa?1:z.pitch/Sa))),2*B}(h.transform),k=h.transform.getFreeCameraOptions().position,N="elevatedStructuresDepthReconstruct",j=h.getOrCreateProgram(N,{defines:["DEPTH_RECONSTRUCTION"]}),R=h.getOrCreateProgram(N);for(const z of d){const B=t.getTile(z),U=B.getBucket(a);if(!U)continue;const Y=U.elevatedStructures;if(!Y)continue;const H=U.elevationBufferData.heightRange,K=b0(z.toUnwrapped(),k),ne=h.translatePosMatrix(z.projMatrix,B,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor"));let ce,ge,pe,_e;if(g==="initialize"){if(!H||H.min>=1||Y.depthSegments.segments[0].primitiveLength===0)continue;ce=Xh(ne,K,I,1,0),ge=b,pe=Y.depthSegments,_e=j}else if(g==="reset"){if(!H||H.min>=0||Y.maskSegments.segments[0].primitiveLength===0)continue;ce=Xh(ne,K,0,0,1),ge=T,pe=Y.maskSegments,_e=j}else if(g==="geometry"){if(Y.depthSegments.segments[0].primitiveLength===0)continue;ce=Xh(ne,K,I,1,0),ge=b,pe=Y.depthSegments,_e=R}_e.draw(h,_.TRIANGLES,ge,Jt.disabled,vr.disabled,ir.disabled,ce,a.id,Y.vertexBuffer,Y.indexBuffer,pe,a.paint,h.transform.zoom)}}function Zc(h,t,a){const{painter:d,sourceCache:g,layer:_,coords:b,colorMode:T,elevationType:I,terrainEnabled:k,pass:N}=h,j=d.context.gl,R=_.paint.get("fill-pattern"),z=_.paint.get("fill-pattern-cross-fade"),B=R.constantOr(null);let U=I;I!=="road"||t&&!k||(U="none");const Y=U==="road",H=h.painter.shadowRenderer,K=Y&&!!H&&H.enabled,ne=new At(d.context.gl.LEQUAL,At.ReadOnly,d.depthRangeFor3D);let ce=[0,0,0];if(K){const _e=d.style.directionalLight,me=d.style.ambientLight;_e&&me&&(ce=Oo(d.style,_e,me))}const ge=R&&R.constantOr(1),pe=(_e,me)=>{let fe,ye,Fe,Pe,Ze;me?(fe=ge&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Fe=j.LINES):(fe=ge?"fillPattern":"fill",Fe=j.TRIANGLES);for(const De of b){const He=g.getTile(De);if(ge&&!He.patternsLoaded())continue;const _t=He.getBucket(_);if(!_t)continue;const ze=t?_t.elevationBufferData:_t.bufferData;if(ze.isEmpty())continue;d.prepareDrawTile();const Ie=ze.programConfigurations.get(_.id),Ye=d.isTileAffectedByFog(De),Ue=[],nt=[];Y&&(Ue.push("ELEVATED_ROADS"),nt.push(ze.elevatedLayoutVertexBuffer)),K&&Ue.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ge&&(d.context.activeTexture.set(j.TEXTURE0),He.imageAtlasTexture&&He.imageAtlasTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE),Ie.updatePaintBuffers());let gt=!1;if(B&&He.imageAtlas){const Dt=He.imageAtlas,zt=o.e0.from(B),Ot=zt.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),nr=zt.getSecondary(),gr=Dt.patternPositions.get(Ot),br=nr?Dt.patternPositions.get(nr.scaleSelf(o.o.devicePixelRatio).toString()):null;gt=!!gr&&!!br,gr&&Ie.setConstantPatternPositions(gr,br)}z>0&&(gt||Ie.getPatternTransitionVertexBuffer("fill-pattern"))&&Ue.push("FILL_PATTERN_TRANSITION");const Et=d.getOrCreateProgram(fe,{config:Ie,overrideFog:Ye,defines:Ue}),dt=d.translatePosMatrix(De.projMatrix,He,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));K&&H.setupShadows(He.tileID.toUnwrapped(),Et,"vector-tile");const lt=_.paint.get("fill-emissive-strength");if(me){Pe=ze.lineIndexBuffer,Ze=ze.lineSegments;const Dt=d.terrain&&d.terrain.renderingToTexture?d.terrain.drapeBufferSize:[j.drawingBufferWidth,j.drawingBufferHeight];ye=fe==="fillOutlinePattern"&&ge?ob(dt,lt,d,He,Dt,ce,z):sb(dt,lt,Dt,ce)}else Pe=ze.indexBuffer,Ze=ze.triangleSegments,ye=ge?Hl(dt,lt,d,He,ce,z):gm(dt,lt,ce);d.uploadCommonUniforms(d.context,Et,De.toUnwrapped());let Ft=_e;(I==="road"&&!k||I==="offset")&&(Ft=ne),Et.draw(d,Fe,Ft,a||d.stencilModeForClipping(De),T,ir.disabled,ye,_.id,ze.layoutVertexBuffer,Pe,Ze,_.paint,d.transform.zoom,Ie,nt)}};d.renderPass===N&&pe(d.depthModeForSublayer(1,d.renderPass==="opaque"?At.ReadWrite:At.ReadOnly),!1),U==="none"&&d.renderPass==="translucent"&&_.paint.get("fill-antialias")&&pe(d.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,At.ReadOnly),!0)}function Pt(h,t,a,d,g,_,b,T){a.resetLayerRenderingStats(h);const I=h.context,k=I.gl,N=h.transform,j=a.paint.get("fill-extrusion-pattern"),R=a.paint.get("fill-extrusion-pattern-cross-fade"),z=j.constantOr(null),B=j.constantOr(1),U=a.paint.get("fill-extrusion-opacity"),Y=h.style.enable3dLights(),H=a.paint.get(Y&&!B?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),K=[a.paint.get("fill-extrusion-ambient-occlusion-intensity"),H],ne=a.layout.get("fill-extrusion-edge-radius"),ce=ne>0&&!a.paint.get("fill-extrusion-rounded-roof"),ge=ce?0:ne,pe=N.projection.name==="globe"?o.e8():0,_e=N.projection.name==="globe",me=_e?o.aj(N.zoom):0,fe=[o.aF(N.center.lng),o.aJ(N.center.lat)],ye=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Fe=a.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ye?null:a.lut).toArray01().slice(0,3),Pe=a.paint.get("fill-extrusion-flood-light-intensity"),Ze=a.paint.get("fill-extrusion-vertical-scale"),De=a.paint.get("fill-extrusion-line-width").constantOr(1)!==0,He=a.paint.get("fill-extrusion-height-alignment"),_t=a.paint.get("fill-extrusion-base-alignment"),ze=tl(h,a.paint.get("fill-extrusion-cutoff-fade-range")),Ie=[];let Ye;_e&&Ie.push("PROJECTION_GLOBE_VIEW"),K[0]>0&&Ie.push("FAUX_AO"),ce&&Ie.push("ZERO_ROOF_RADIUS"),T&&Ie.push("HAS_CENTROID"),Pe>0&&Ie.push("FLOOD_LIGHT"),ze.shouldRenderCutoff&&Ie.push("RENDER_CUTOFF"),De&&Ie.push("RENDER_WALL_MODE");const Ue=h.renderPass==="shadow",nt=h.shadowRenderer,gt=Ue&&!!nt,Et=Ue?ir.disabled:ir.backCCW;h.shadowRenderer&&(h.shadowRenderer.useNormalOffset=!0);let dt=[0,0,0];if(nt){const Dt=h.style.directionalLight,zt=h.style.ambientLight;Dt&&zt&&(dt=Oo(h.style,Dt,zt)),Ue||(Ie.push("RENDER_SHADOWS","DEPTH_TEXTURE"),nt.useNormalOffset&&Ie.push("NORMAL_OFFSET")),Ye=Ie.concat(["SHADOWS_SINGLE_CASCADE"])}const lt=gt?"fillExtrusionDepth":B?"fillExtrusionPattern":"fillExtrusion",Ft=a.getLayerRenderingStats();for(const Dt of d){const zt=t.getTile(Dt),Ot=zt.getBucket(a);if(!Ot||Ot.projection.name!==N.projection.name)continue;let nr=!1;nt&&(nr=nt.getMaxCascadeForTile(Dt.toUnwrapped())===0);const gr=h.isTileAffectedByFog(Dt),br=Ot.programConfigurations.get(a.id);let ii=!1;if(z&&zt.imageAtlas){const Wr=zt.imageAtlas,Jr=o.e0.from(z),Pi=Jr.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),Ki=Jr.getSecondary(),An=Wr.patternPositions.get(Pi),ki=Ki?Wr.patternPositions.get(Ki.scaleSelf(o.o.devicePixelRatio).toString()):null;ii=!!An&&!!ki,An&&br.setConstantPatternPositions(An,ki)}R>0&&(ii||br.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&Ie.push("FILL_EXTRUSION_PATTERN_TRANSITION");const lr=h.getOrCreateProgram(lt,{config:br,defines:nr?Ye:Ie,overrideFog:gr});if(h.terrain&&h.terrain.setupElevationDraw(zt,lr,{useMeterToDem:!0}),!Ot.centroidVertexBuffer){const Wr=lr.getAttributeLocation(k,"a_centroid_pos");Wr!==-1&&k.vertexAttrib2f(Wr,0,0)}!Ue&&nt&&nt.setupShadows(zt.tileID.toUnwrapped(),lr,"vector-tile"),B&&(h.context.activeTexture.set(k.TEXTURE0),zt.imageAtlasTexture&&zt.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),br.updatePaintBuffers());const qr=a.paint.get("fill-extrusion-vertical-gradient"),ei=1/Ot.tileToMeter;let Ii;if(Ue&&nt){if(w0(zt.tileID,Ot.maxHeight,h))continue;const Wr=nt.calculateShadowPassMatrixFromTile(zt.tileID.toUnwrapped());Ii=mm(Wr,ge,ei,Ze,He,_t)}else{const Wr=h.translatePosMatrix(Dt.expandedProjMatrix,zt,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Jr=N.projection.createInversionMatrix(N,Dt.canonical);Ii=B?y0(Wr,h,qr,U,K,ge,ei,Dt,zt,pe,He,_t,me,fe,Jr,Fe,Ze,R):gd(Wr,h,qr,U,K,ge,ei,Dt,pe,He,_t,me,fe,Jr,Fe,Ze,Pe,dt)}h.uploadCommonUniforms(I,lr,Dt.toUnwrapped(),null,ze);let _r=Ot.segments;if(N.projection.name==="mercator"&&!Ue&&(_r=Ot.getVisibleSegments(zt.tileID,h.terrain,h.transform.getFrustum(0)),!_r.get().length))continue;if(Ft)if(Ue)for(const Wr of _r.get())Ft.numRenderedVerticesInShadowPass+=Wr.primitiveLength;else for(const Wr of _r.get())Ft.numRenderedVerticesInTransparentPass+=Wr.primitiveLength;const Xr=[];(h.terrain||T)&&Xr.push(Ot.centroidVertexBuffer),_e&&Xr.push(Ot.layoutVertexExtBuffer),De&&Xr.push(Ot.wallVertexBuffer),lr.draw(h,I.gl.TRIANGLES,g,_,b,Et,Ii,a.id,Ot.layoutVertexBuffer,Ot.indexBuffer,_r,a.paint,h.transform.zoom,br,Xr)}h.shadowRenderer&&(h.shadowRenderer.useNormalOffset=!1)}class Am{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function Ta(h,t,a,d,g,_,b,T,I,k,N,j,R,z,B,U,Y,H,K,ne){const ce=t.context,ge=ce.gl,pe=t.transform,_e=t.transform.zoom,me=[],fe=h.translate,ye=h.translateAnchor,Fe=h.edgeRadius,Pe=tl(t,h.cutoffFadeRange);N==="clear"?(me.push("CLEAR_SUBPASS"),ne&&(me.push("CLEAR_FROM_TEXTURE"),ce.activeTexture.set(ge.TEXTURE0),ne.bind(ge.LINEAR,ge.CLAMP_TO_EDGE))):N==="sdf"&&me.push("SDF_SUBPASS"),H&&me.push("HAS_CENTROID"),Pe.shouldRenderCutoff&&me.push("RENDER_CUTOFF");const Ze=(De,He,_t,ze,Ie)=>{const Ye=He.programConfigurations.get(d.id),Ue=t.isTileAffectedByFog(De),nt=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Ye,defines:me,overrideFog:Ue}),gt=((dt,lt,Ft,Dt,zt,Ot,nr,gr,br,ii,lr)=>({u_matrix:lt,u_opacity:Ft,u_ao_pass:Dt?1:0,u_meter_to_tile:zt,u_ao:Ot,u_flood_light_intensity:nr,u_flood_light_color:gr,u_attenuation:br,u_edge_radius:ii,u_fb:0,u_fb_size:lr,u_dynamic_offset:1}))(0,ze,j,k,Ie,[R,z*Ie],B,U,Y,_e>=17?0:Fe*Ie,ne?ne.size[0]:0),Et=[];H&&Et.push(He.hiddenByLandmarkVertexBuffer),t.uploadCommonUniforms(ce,nt,De.toUnwrapped(),null,Pe),nt.draw(t,ce.gl.TRIANGLES,_,b,T,I,gt,d.id,He.vertexBuffer,He.indexBuffer,_t,d.paint,_e,Ye,Et)};for(const De of g){const He=a.getTile(De),_t=He.getBucket(d);if(!_t||_t.projection.name!==pe.projection.name||!_t.groundEffect||_t.groundEffect&&!_t.groundEffect.hasData())continue;const ze=_t.groundEffect,Ie=1/_t.tileToMeter;{const Ye=t.translatePosMatrix(De.projMatrix,He,fe,ye),Ue=ze.getDefaultSegment();Ze(De,ze,Ue,Ye,Ie)}if(K)for(let Ye=0;Ye<4;Ye++){const Ue=o.e6[Ye](De),nt=a.getTile(Ue);if(!nt)continue;const gt=nt.getBucket(d);if(!gt||gt.projection.name!==pe.projection.name||!gt.groundEffect||gt.groundEffect&&!gt.groundEffect.hasData())continue;const Et=gt.groundEffect;let dt,lt;Ye===0?(dt=[-o.al,0,0],lt=1):Ye===1?(dt=[o.al,0,0],lt=0):Ye===2?(dt=[0,-o.al,0],lt=3):(dt=[0,o.al,0],lt=2);const Ft=Et.regionSegments[lt];if(!Ft)continue;const Dt=new Float32Array(16);o.br(Dt,De.projMatrix,dt),Ze(De,Et,Ft,t.translatePosMatrix(Dt,He,fe,ye),Ie)}}}function ll(h,t,a,d,g,_,b){d.centroidVertexArray.length===0&&d.createCentroidsBuffer();const T=_?_.findDEMTileFor(a):null;if(!(T&&T.dem||b))return;_&&T&&T.dem&&d.selfDEMTileTimestamp!==T.dem._timestamp&&(d.borderDoneWithNeighborZ=[-1,-1,-1,-1],d.selfDEMTileTimestamp=T.dem._timestamp);const I=H=>new o.P(Math.ceil((H+o.ea)*o.eb),0),k=H=>{const K=t.getSource().minzoom,ne=ge=>{const pe=t.getTileByID(ge);if(pe&&pe.hasData())return pe.getBucket(g)},ce=[0,-1,1];for(const ge of ce){if(H.overscaledZ+ge<K)continue;const pe=ne(H.calculateScaledKey(H.overscaledZ+ge));if(pe)return pe}},N=[0,0,0],j=(H,K)=>(N[0]=Math.min(H.min.y,K.min.y),N[1]=Math.max(H.max.y,K.max.y),N[2]=o.al-K.min.x>H.max.x?K.min.x-o.al:H.max.x,N),R=(H,K)=>(N[0]=Math.min(H.min.x,K.min.x),N[1]=Math.max(H.max.x,K.max.x),N[2]=o.al-K.min.y>H.max.y?K.min.y-o.al:H.max.y,N),z=[(H,K)=>j(H,K),(H,K)=>j(K,H),(H,K)=>R(H,K),(H,K)=>R(K,H)],B=(H,K,ne,ce,ge,pe,_e)=>{if(!_)return 0;const me=[[pe?ne:H,pe?H:ne,0],[pe?ne:K,pe?K:ne,0]],fe=_e<0?o.al+_e:_e,ye=[pe?fe:(H+K)/2,pe?(H+K)/2:fe,0];return ne===0&&_e<0||ne!==0&&_e>0?_.getForTilePoints(ge,[ye],!0,ce):me.push(ye),_.getForTilePoints(a,me,!0,T),Math.max(me[0][2],me[1][2],ye[2])/_.exaggeration()};for(let H=0;H<4;H++){const K=d.borderFeatureIndices[H];if(K.length===0)continue;const ne=o.e6[H](a),ce=k(ne);if(!(ce&&ce instanceof o.e7))continue;const ge=_?_.findDEMTileFor(ne):null;if(!(ge&&ge.dem||b)||(_&&ge&&ge.dem&&d.borderDEMTileTimestamp[H]!==ge.dem._timestamp&&(d.borderDoneWithNeighborZ[H]=-1,d.borderDEMTileTimestamp[H]=ge.dem._timestamp),d.borderDoneWithNeighborZ[H]===ce.canonical.z))continue;ce.centroidVertexArray.length===0&&ce.createCentroidsBuffer();const pe=(H<2?1:5)-H,_e=ce.borderDoneWithNeighborZ[pe]!==d.canonical.z,me=ce.borderFeatureIndices[pe];let fe=0;if(d.canonical.z!==ce.canonical.z){for(const ye of K)d.showCentroid(d.featuresOnBorder[ye]);if(_e)for(const ye of me)ce.showCentroid(ce.featuresOnBorder[ye]);d.borderDoneWithNeighborZ[H]=ce.canonical.z,ce.borderDoneWithNeighborZ[pe]=d.canonical.z}for(const ye of K){const Fe=d.featuresOnBorder[ye],Pe=d.centroidData[Fe.centroidDataIndex],Ze=Fe.borders[H];let De;for(;fe<me.length;){De=ce.featuresOnBorder[me[fe]];const He=De.borders[pe];if(He[1]>Ze[0]+3||He[0]>Ze[0]-3)break;ce.showCentroid(De),fe++}if(De&&fe<me.length){const He=fe;let _t=0;for(;!(De.borders[pe][0]>Ze[1]-3)&&(_t++,++fe!==me.length);)De=ce.featuresOnBorder[me[fe]];De=ce.featuresOnBorder[me[He]];let ze=!1;if(_t>=1){const Ue=De.borders[pe];Math.abs(Ze[0]-Ue[0])<3&&Math.abs(Ze[1]-Ue[1])<3&&(_t=1,ze=!0,fe=He+1)}else if(_t===0){d.showCentroid(Fe);continue}const Ie=ce.centroidData[De.centroidDataIndex];b&&ze&&(((U=Pe).flags|(Y=Ie).flags)&o.e9?(U.flags|=o.e9,Y.flags|=o.e9):(U.flags&=~o.e9,Y.flags&=~o.e9));const Ye=Fe.intersectsCount()>1||De.intersectsCount()>1;if(_t>1)fe=He,Pe.centroidXY=Ie.centroidXY=new o.P(0,0);else if(ge&&ge.dem&&!Ye){const Ue=z[H](Pe,Ie),nt=H%2?o.al-1:0,gt=B(Ue[0],Math.min(o.al-1,Ue[1]),nt,ge,ne,H<2,Ue[2]);Pe.centroidXY=Ie.centroidXY=I(gt)}else Ye?Pe.centroidXY=Ie.centroidXY=new o.P(0,0):(Pe.centroidXY=d.encodeBorderCentroid(Fe),Ie.centroidXY=ce.encodeBorderCentroid(De));d.writeCentroidToBuffer(Pe),ce.writeCentroidToBuffer(Ie)}else d.showCentroid(Fe)}d.borderDoneWithNeighborZ[H]=ce.canonical.z,ce.borderDoneWithNeighborZ[pe]=d.canonical.z}var U,Y;(d.needsCentroidUpdate||!d.centroidVertexBuffer&&d.centroidVertexArray.length!==0)&&d.uploadCentroid(h)}const cl=[1,0,0],Xt=[0,1,0],Pm=[0,0,1];function w0(h,t,a){const d=a.transform,g=a.shadowRenderer;if(!g)return!0;const _=h.toUnwrapped(),b=d.tileSize*g._cascades[a.currentShadowCascade].scale;let T=t;if(d.elevation){const U=d.elevation.getMinMaxForTile(h);U&&(T+=U.max)}const I=[...g.shadowDirection];I[2]=-I[2];const k=g.computeSimplifiedTileShadowVolume(_,T,b,I);if(!k)return!1;const N=[cl,Xt,Pm,I,[I[0],0,I[2]],[0,I[1],I[2]]],j=d.projection.name==="globe",R=d.scaleZoom(b),z=o.cA.fromInvProjectionMatrix(d.invProjMatrix,d.worldSize,R,!j),B=g.getCurrentCascadeFrustum();return z.intersectsPrecise(k.vertices,k.planes,N)===0||B.intersectsPrecise(k.vertices,k.planes,N)===0}function of(h){const{painter:t,source:a,layer:d,coords:g}=h;let _=h.defines;const b=t.context,T=t.renderPass==="shadow",I=t.renderPass==="light-beam",k=t.shadowRenderer,N=o.ec(t.transform.center.lat,t.transform.zoom),j=tl(t,d.paint.get("building-cutoff-fade-range"));j.shouldRenderCutoff&&(_=_.concat("RENDER_CUTOFF"));for(const R of g){const z=a.getTile(R),B=z.getBucket(d);if(!B)continue;k&&k.getMaxCascadeForTile(R.toUnwrapped())===0&&(_=_.concat("SHADOWS_SINGLE_CASCADE"));const U=B.programConfigurations.get(d.id);let Y,H,K,ne=t.translatePosMatrix(R.expandedProjMatrix,z,[0,0],"map");if(ne=o.cR(o.bC(),ne,[1,1,h.verticalScale]),T&&k){if(w0(z.tileID,B.maxHeight*N,t))continue;let ge=k.calculateShadowPassMatrixFromTile(z.tileID.toUnwrapped());ge=o.cR(o.bC(),ge,[1,1,h.verticalScale]),K=_m(ge),Y=H=t.getOrCreateProgram("buildingDepth",{config:U,defines:_,overrideFog:!1})}else if(I)Y=H=t.getOrCreateProgram("buildingBloom",{config:U,defines:_,overrideFog:!1}),K=cb(ne);else{const ge=t.transform.calculatePosMatrix(R.toUnwrapped(),t.transform.worldSize);o.cR(ge,ge,[1,1,h.verticalScale]);const pe=o.bC();o.cR(pe,ge,[1,-1,1/N]),o.bl(pe,pe),o.ed(pe,pe);const _e=t.transform.getFreeCameraOptions().position,me=1<<R.canonical.z;K=lb(ne,pe,h.opacity,h.facadeAOIntensity,[((_e.x-R.wrap)*me-R.canonical.x)*o.al,(_e.y*me-R.canonical.y)*o.al,_e.z*me*o.al],B.tileToMeter,h.facadeEmissiveChance),H=t.getOrCreateProgram("building",{config:U,defines:_,overrideFog:!1});const fe=_.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);Y=t.getOrCreateProgram("building",{config:U,defines:fe,overrideFog:!1}),k&&(k.setupShadowsFromMatrix(ge,H,!0),k.setupShadowsFromMatrix(ge,Y,!0))}const ce=(ge,pe)=>{if(I){const _e=ge.entranceBloom;pe.draw(t,b.gl.TRIANGLES,h.depthMode,Jt.disabled,h.blendMode,ir.disabled,K,d.id,_e.layoutVertexBuffer,_e.indexBuffer,_e.segmentsBucket,d.paint,t.transform.zoom,U,[_e.layoutAttenuationBuffer,_e.layoutColorBuffer])}else{const _e=ge.segmentsBucket;let me=[ge.layoutNormalBuffer,ge.layoutCentroidBuffer,ge.layoutColorBuffer];ge.layoutFacadePaintBuffer&&(me=me.concat([ge.layoutFacadeDataBuffer,ge.layoutFacadeVerticalRangeBuffer,ge.layoutFacadePaintBuffer])),pe.draw(t,b.gl.TRIANGLES,h.depthMode,Jt.disabled,h.blendMode,T?ir.disabled:ir.backCW,K,d.id,ge.layoutVertexBuffer,ge.indexBuffer,_e,d.paint,t.transform.zoom,U,me)}};t.uploadCommonUniforms(b,H,R.toUnwrapped(),null,j),B.buildingWithoutFacade&&ce(B.buildingWithoutFacade,H),Y!==H&&t.uploadCommonUniforms(b,Y,R.toUnwrapped(),null,j),B.buildingWithFacade&&ce(B.buildingWithFacade,Y)}}function af(h){return[h[0]*o.ee,h[1]*o.ee,h[2]*o.ee,0]}function lf(h,t,a,d,g,_,b,T,I){const k=d.getSource(),N=a.globeSharedBuffers;if(!N)return;let j,R,z;if(t&&(j=d.getTile(t)),k instanceof o.aS?(R=k.texture,z=o.dG(0,0,a.transform)):j&&t&&(R=j.texture,z=o.dG(t.canonical.z,t.canonical.x,a.transform)),!R||!z)return;h||(z=o.cR(o.bC(),z,[1,-1,1]));const B=a.context,U=B.gl,Y=g.paint.get("raster-resampling")==="nearest"?U.NEAREST:U.LINEAR,H=a.colorModeForDrapableLayerRenderPass(_),K=b.defines;K.push("GLOBE_POLES");const ne=new At(U.LEQUAL,At.ReadWrite,a.depthRangeFor3D),ce=Float32Array.from(a.transform.expandedFarZProjMatrix),ge=Float32Array.from(o.bk(o.dF(new o.cC(0,0,0))));a.terrain&&a.terrain.prepareDrawTile(),B.activeTexture.set(U.TEXTURE0),R.bind(Y,U.CLAMP_TO_EDGE),B.activeTexture.set(U.TEXTURE1),R.bind(Y,U.CLAMP_TO_EDGE),"useMipmap"in R&&B.extTextureFilterAnisotropic&&a.transform.pitch>20&&U.texParameterf(U.TEXTURE_2D,B.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,B.extTextureFilterAnisotropicMax);const[pe,_e,me,fe]=t?N.getPoleBuffers(t.canonical.z,!1):N.getPoleBuffers(0,!0),ye=g.paint.get("raster-elevation");let Fe;h?(Fe=pe,a.renderDefaultNorthPole=ye!==0):(Fe=_e,a.renderDefaultSouthPole=ye!==0);const Pe=af(b.mix),Ze=((He,_t,ze,Ie,Ye,Ue,nt,gt,Et,dt,lt,Ft,Dt)=>Yh(He,_t,ze,new Float32Array(16),new Float32Array(9),[0,0],Ie,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Ue,[0,0],gt,2,dt,lt,Ft,1,0,Dt))(ce,ge,z,o.aj(a.transform.zoom),0,g,0,ye,0,Pe,b.offset,b.range,_),De=a.getOrCreateProgram("raster",{defines:K});a.uploadCommonUniforms(B,De,null),De.draw(a,U.TRIANGLES,ne,I,H,T,Ze,g.id,Fe,me,fe)}function hb(h){const t=h._nearZ,a=h.projection.farthestPixelDistance(h),d=a-t,g=.2*h.height,_=t+g;return[t,a,(_-g-t)/d,(_-t)/d]}function S0(h,t,a,d){if(h)return t instanceof Xa&&h instanceof Ju?t.getTextureDescriptor(h,a,!0):{texture:h.texture,mix:af(d.mix),offset:d.offset,buffer:0,tileSize:1}}var fb=o.ef([{name:"a_index",type:"Int16",components:1}]);class pb{constructor(t,a,d,g){const _={width:d[0],height:d[1],data:null},b=t.gl;this.targetColorTexture=new o.T(t,_,b.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new o.T(t,_,b.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(a,g),this.lastInvalidatedAt=0}updateParticleTexture(t,a){if(this.particleTextureDimension===a.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const d=this.context.gl,g=a.width*a.height;this.particleTexture0=new o.T(this.context,a,d.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new o.T(this.context,a,d.RGBA8,{premultiply:!1,useMipmap:!1});const _=new o.eg;_.reserve(g);for(let b=0;b<g;b++)_.emplaceBack(b);this.particleIndexBuffer=this.context.createVertexBuffer(_,fb.members,!0),this.particleSegment=o.bg.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=a.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=o.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Rs(h,t,a){if(!h)return null;const d=t.getTextureDescriptor(h,a,!0);if(!d)return null;let{texture:g,mix:_,offset:b,tileSize:T,buffer:I,format:k}=d;if(!g||!k)return null;let N=!1;return k==="uint32"&&(N=!0,_[3]=0,_=vm(o.eh,_,[0,a.paint.get("raster-particle-max-speed")]),b=bm(o.eh,b,[0,a.paint.get("raster-particle-max-speed")])),{texture:g,textureOffset:[I/(T+2*I),T/(T+2*I)],tileSize:T,scalarData:N,scale:_,offset:b,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[k]]}}function km(h){const t=h._nearZ,a=h.projection.farthestPixelDistance(h),d=a-t,g=.2*h.height,_=t+g;return[t,a,(_-g-t)/d,(_-t)/d]}const ms=new o.ao(1,0,0,1),ul=new o.ao(0,1,0,1),T0=new o.ao(0,0,1,1),Mm=new o.ao(1,0,1,1),Nm=new o.ao(0,1,1,1);function cf(h,t,a,d,g,_){for(let b=0;b<a.length;b++)if(g){const k=new o.ao(d.r*.8,d.g*.8,d.b*.8,1);Yl(h,t,a[b],d,-1,-1,_),Yl(h,t,a[b],d,-1,1,_),Yl(h,t,a[b],d,1,1,_),Yl(h,t,a[b],d,1,-1,_),Yl(h,t,a[b],k,0,0,_)}else Yl(h,t,a[b],d,0,0,_)}function Yl(h,t,a,d,g,_,b){const T=h.context,I=h.transform,k=T.gl,N=I.projection.name==="globe",j=N?["PROJECTION_GLOBE_VIEW"]:[];let R=o.bz(a.projMatrix);if(N&&o.aj(I.zoom)>0){const Pe=o.bj(a.canonical,I),Ze=o.ei(Pe);R=o.aB(new Float32Array(16),I.globeMatrix,Ze),o.aB(R,I.projMatrix,R)}const z=o.bC();z[12]+=2*g/(o.o.devicePixelRatio*I.width),z[13]+=2*_/(o.o.devicePixelRatio*I.height),o.aB(R,z,R);const B=h.getOrCreateProgram("debug",{defines:j}),U=t.getTileByID(a.key);h.terrain&&h.terrain.setupElevationDraw(U,B);const Y=At.disabled,H=Jt.disabled,K=h.colorModeForRenderPass(),ne="$debug";T.activeTexture.set(k.TEXTURE0),h.emptyTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),N?U._makeGlobeTileDebugBuffers(h.context,I):U._makeDebugTileBoundsBuffers(h.context,I.projection);const ce=U._tileDebugBuffer||h.debugBuffer,ge=U._tileDebugIndexBuffer||h.debugIndexBuffer,pe=U._tileDebugSegments||h.debugSegments;if(B.draw(h,k.LINE_STRIP,Y,H,K,ir.disabled,xm(R,d.toPremultipliedRenderColor(null)),ne,ce,ge,pe,null,null,null,[U._globeTileDebugBorderBuffer]),b){const Pe=U.latestRawTileData,Ze=Math.floor((Pe&&Pe.byteLength||0)/1024);let De=a.canonical.toString();a.overscaledZ!==a.canonical.z&&(De+=` => ${a.overscaledZ}`),De+=` ${U.state}`,De+=` ${Ze}kb`,function(He,_t){He.initDebugOverlayCanvas();const ze=He.debugOverlayCanvas,Ie=He.context.gl,Ye=He.debugOverlayCanvas.getContext("2d");Ye.clearRect(0,0,ze.width,ze.height),Ye.shadowColor="white",Ye.shadowBlur=2,Ye.lineWidth=1.5,Ye.strokeStyle="white",Ye.textBaseline="top",Ye.font="bold 36px Open Sans, sans-serif",Ye.fillText(_t,5,5),Ye.strokeText(_t,5,5),He.debugOverlayTexture.update(ze),He.debugOverlayTexture.bind(Ie.LINEAR,Ie.CLAMP_TO_EDGE)}(h,De)}const _e=t.getTile(a).tileSize,me=512/Math.min(_e,512)*(a.overscaledZ/I.zoom)*.5,fe=U._tileDebugTextBuffer||h.debugBuffer,ye=U._tileDebugTextIndexBuffer||h.quadTriangleIndexBuffer,Fe=U._tileDebugTextSegments||h.debugSegments;B.draw(h,k.TRIANGLES,Y,H,vr.alphaBlended,ir.disabled,xm(R,o.ao.transparent.toPremultipliedRenderColor(null),me),ne,fe,ye,Fe,null,null,null,[U._globeTileDebugTextBuffer])}function ia(h,t,a,d){Kl(h,0,t+a/2,h.transform.width,a,d)}function gi(h,t,a,d){Kl(h,t-a/2,0,a,h.transform.height,d)}function Kl(h,t,a,d,g,_){const b=h.context,T=b.gl;T.enable(T.SCISSOR_TEST),T.scissor(t*o.o.devicePixelRatio,a*o.o.devicePixelRatio,d*o.o.devicePixelRatio,g*o.o.devicePixelRatio),b.clear({color:_}),T.disable(T.SCISSOR_TEST)}const Rm=o.ef([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:E0}=Rm;function Ea(h,t,a,d){h.emplaceBack(t,a,d)}class Lm{constructor(t){this.vertexArray=new o.ej,this.indices=new o.b1,Ea(this.vertexArray,-1,-1,1),Ea(this.vertexArray,1,-1,1),Ea(this.vertexArray,-1,1,1),Ea(this.vertexArray,1,1,1),Ea(this.vertexArray,-1,-1,-1),Ea(this.vertexArray,1,-1,-1),Ea(this.vertexArray,-1,1,-1),Ea(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,E0),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=o.bg.simpleSegment(0,0,36,12)}}function Jl(h,t,a,d,g,_){const b=h.context.gl,T=t.paint.get("sky-atmosphere-color"),I=t.paint.get("sky-atmosphere-halo-color"),k=t.paint.get("sky-atmosphere-sun-intensity"),N=((j,R,z,B,U)=>({u_matrix_3f:j,u_sun_direction:R,u_sun_intensity:z,u_color_tint_r:[B.r,B.g,B.b,B.a],u_color_tint_m:[U.r,U.g,U.b,U.a],u_luminance:5e-5}))(o.el(o.dL(),d),g,k,T.toPremultipliedRenderColor(null),I.toPremultipliedRenderColor(null));b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+_,t.skyboxTexture,0),a.draw(h,b.TRIANGLES,At.disabled,Jt.disabled,vr.unblended,ir.frontCW,N,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const Ql=o.ef([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class ec{constructor(t){const a=new o.em;a.emplaceBack(-1,1,1,0,0),a.emplaceBack(1,1,1,1,0),a.emplaceBack(1,-1,1,1,1),a.emplaceBack(-1,-1,1,0,1);const d=new o.b1;d.emplaceBack(0,1,2),d.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(a,Ql.members),this.indexBuffer=t.createIndexBuffer(d),this.segments=o.bg.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const mt=o.ef([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Tt{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Xc{constructor(t){this.colorModeAlphaBlendedWriteRGB=new vr([1,Cs,1,Cs],o.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new vr([1,0,1,0],o.ao.transparent,[!1,!1,!1,!0]),this.params=new Tt,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){const a=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new ec(a);const d=this.params.sizeRange,g=this.params.intensityRange,_=function(N){const j=o.eo(30),R=[];for(let z=0;z<N;++z){const B=2*Math.PI*j(),U=Math.acos(1-2*j())-.5*Math.PI;R.push(o.d4(Math.cos(U)*Math.cos(B),Math.cos(U)*Math.sin(B),Math.sin(U)))}return R}(this.params.starsCount),b=o.eo(300),T=new o.en,I=new o.b1;let k=0;for(let N=0;N<_.length;++N){const j=o.c4([],_[N],200),R=Math.max(0,1+.01*d*(1*b()-.5)),z=Math.max(0,1+.01*g*(1*b()-.5));T.emplaceBack(j[0],j[1],j[2],-1,-1,R,z),T.emplaceBack(j[0],j[1],j[2],1,-1,R,z),T.emplaceBack(j[0],j[1],j[2],1,1,R,z),T.emplaceBack(j[0],j[1],j[2],-1,1,R,z),I.emplaceBack(k+0,k+1,k+2),I.emplaceBack(k+0,k+2,k+3),k+=4}this.starsVx=a.createVertexBuffer(T,mt.members),this.starsIdx=a.createIndexBuffer(I),this.starsSegments=o.bg.simpleSegment(0,0,T.length,I.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,a){const d=t.context,g=d.gl,_=t.transform,b=new At(g.LEQUAL,At.ReadOnly,[0,1]),T=o.aj(_.zoom),I=t.style.getLut(a.scope),k=a.properties.get("color-use-theme")==="none",N=a.properties.get("color").toNonPremultipliedRenderColor(k?null:I),j=a.properties.get("high-color-use-theme")==="none",R=a.properties.get("high-color").toNonPremultipliedRenderColor(j?null:I),z=a.properties.get("space-color-use-theme")==="none",B=a.properties.get("space-color").toNonPremultipliedRenderColor(z?null:I),U=5e-4,Y=o.ep(a.properties.get("horizon-blend"),0,1,U,.25),H=o.dA(t,d,_)&&Y===U?_.worldSize/(2*Math.PI*1.025)-1:_.globeRadius,K=t.frameCounter/1e3%1,ne=o.ag(_.globeCenterInViewSpace),ce=Math.sqrt(Math.pow(ne,2)-Math.pow(H,2)),ge=Math.acos(ce/ne),pe=_e=>{const me=_.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];_e&&me.push("ALPHA_PASS");const fe=t.getOrCreateProgram("globeAtmosphere",{defines:me}),ye=((Pe,Ze,De,He,_t,ze,Ie,Ye,Ue,nt,gt,Et)=>({u_frustum_tl:Pe,u_frustum_tr:Ze,u_frustum_br:De,u_frustum_bl:He,u_horizon:_t,u_transition:ze,u_fadeout_range:Ie,u_atmosphere_fog_color:Ye.toArray01(),u_high_color:Ue.toArray01(),u_space_color:nt.toArray01(),u_temporal_offset:gt,u_horizon_angle:Et}))(_.frustumCorners.TL,_.frustumCorners.TR,_.frustumCorners.BR,_.frustumCorners.BL,_.frustumCorners.horizon,T,Y,N,R,B,K,ge);t.uploadCommonUniforms(d,fe);const Fe=this.atmosphereBuffer;Fe&&fe.draw(t,g.TRIANGLES,b,Jt.disabled,_e?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ir.backCW,ye,_e?"atmosphere_glow_alpha":"atmosphere_glow",Fe.vertexBuffer,Fe.indexBuffer,Fe.segments)};pe(!1),pe(!0)}drawStars(t,a){const d=o.aA(a.properties.get("star-intensity"),0,1);if(d===0)return;const g=t.context,_=g.gl,b=t.transform,T=t.getOrCreateProgram("stars"),I=o.c6([]);o.c8(I,I,-b._pitch),o.c7(I,I,-b.angle),o.c8(I,I,o.an(b._center.lat)),o.eq(I,I,-o.an(b._center.lng));const k=o.cb(new Float32Array(16),I),N=o.aB([],b.starsProjMatrix,k),j=o.el([],k),R=o.er([],j),z=[0,1,0];o.dN(z,z,R),o.c4(z,z,this.params.sizeMultiplier);const B=[1,0,0];o.dN(B,B,R),o.c4(B,B,this.params.sizeMultiplier);const U=(Y=z,H=B,K=d,{u_matrix:Float32Array.from(N),u_up:Y,u_right:H,u_intensity_multiplier:K});var Y,H,K;t.uploadCommonUniforms(g,T),this.starsVx&&this.starsIdx&&T.draw(t,_.TRIANGLES,At.disabled,Jt.disabled,this.colorModeAlphaBlendedWriteRGB,ir.disabled,U,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class $i{constructor(){this.visibleTiles=[]}updateBorders(t,a){const d=[],g=[],_=t._getRenderableCoordinates(!1,!0);for(const I of _){const k=t.getTile(I);if(!k.hasData())continue;const N=k.getBucket(a);N&&(N.isEmpty()||(d.push(I.key),g.push({bucket:N,tileID:I.canonical})))}let b=d.length!==this.visibleTiles.length;if(!b){d.sort();for(let I=0;I<d.length;I++)if(d[I]!==this.visibleTiles[I]){b=!0;break}}if(!b)return;const T=new Set;this.visibleTiles=d,g.sort((I,k)=>I.tileID.z-k.tileID.z||I.tileID.x-k.tileID.x||I.tileID.y-k.tileID.y);for(const I of g){const k=new Array,N=new Array,j=I.bucket;for(const R of j.featuresOnBorder)T.has(R.featureId)?N.push(R.footprintIndex):(T.add(R.featureId),k.push(R.footprintIndex));j.updateFootprintHiddenFlags(k,o.es,!1),j.updateFootprintHiddenFlags(N,o.es,!0)}}}function Le(h,t){const a=[...h],d=t.cameraWorldSizeForFog/t.worldSize,g=o.bA([]);return o.cR(g,g,[d,d,1]),o.aB(a,g,a),o.aB(a,t.worldToFogMatrix,a),a}function uf(h,t,a,d,g){const _=a.material,b=d.context,{baseColorTexture:T,metallicRoughnessTexture:I}=_.pbrMetallicRoughness,{normalTexture:k,occlusionTexture:N,emissionTexture:j}=_;function R(B,U,Y){if(B&&(h.push(U),b.activeTexture.set(b.gl.TEXTURE0+Y),B.gfxTexture)){const{minFilter:H,magFilter:K,wrapS:ne,wrapT:ce}=B.sampler;B.gfxTexture.bindExtraParam(H,K,ne,ce)}}R(T,"HAS_TEXTURE_u_baseColorTexture",nn.BaseColor),R(I,"HAS_TEXTURE_u_metallicRoughnessTexture",nn.MetallicRoughness),R(k,"HAS_TEXTURE_u_normalTexture",nn.Normal),R(N,"HAS_TEXTURE_u_occlusionTexture",nn.Occlusion),R(j,"HAS_TEXTURE_u_emissionTexture",nn.Emission),g&&(g.texture||(g.texture=new o.dY(d.context,g.image,[g.image.height,g.image.height,g.image.height],b.gl.RGBA8)),b.activeTexture.set(b.gl.TEXTURE0+nn.LUT),g.texture&&g.texture.bind(b.gl.LINEAR,b.gl.CLAMP_TO_EDGE),h.push("APPLY_LUT_ON_GPU")),a.texcoordBuffer&&(h.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(a.texcoordBuffer)),a.colorBuffer&&(h.push(a.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(a.colorBuffer)),a.normalBuffer&&(h.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(a.normalBuffer)),a.pbrBuffer&&(h.push("HAS_ATTRIBUTE_a_pbr"),h.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(a.pbrBuffer)),_.alphaMode!=="OPAQUE"&&_.alphaMode!=="MASK"||h.push("UNPREMULT_TEXTURE_IN_SHADER"),_.defined||h.push("DIFFUSE_SHADED");const z=d.shadowRenderer;z&&(h.push("RENDER_SHADOWS","DEPTH_TEXTURE"),z.useNormalOffset&&h.push("NORMAL_OFFSET"))}function tc(h,t,a,d,g,_){const b=a.paint.get("model-opacity").constantOr(1),T=t.context,I=new At(t.context.gl.LEQUAL,At.ReadWrite,t.depthRangeFor3D),k=t.transform,N=h.mesh,j=N.material,R=j.pbrMetallicRoughness,z=t.style.fog;let B;B=t.transform.projection.zAxisUnit==="pixels"?[...h.nodeModelMatrix]:o.aB([],d.zScaleMatrix,h.nodeModelMatrix),o.aB(B,d.negCameraPosMatrix,B);const U=o.bl([],B);o.ed(U,U);const Y=a.paint.get("model-color-use-theme").constantOr("default")==="none",H=a.paint.get("model-emissive-strength").constantOr(0),K=ef(new Float32Array(h.worldViewProjection),new Float32Array(B),new Float32Array(U),null,t,b,R.baseColorFactor,j.emissiveFactor,R.metallicFactor,R.roughnessFactor,j,H,a),ne={defines:[]},ce=[],ge=t.shadowRenderer;ge&&(ge.useNormalOffset=!1),uf(ne.defines,ce,N,t,Y?null:a.lut);let pe=null;if(z){const fe=Le(h.nodeModelMatrix,t.transform);if(pe=new Float32Array(fe),k.projection.name!=="globe"){const ye=N.aabb.min,Fe=N.aabb.max,[Pe,Ze]=z.getOpacityForBounds(fe,ye[0],ye[1],Fe[0],Fe[1]);ne.overrideFog=Pe>=Gt||Ze>=Gt}}const _e=tl(t,a.paint.get("model-cutoff-fade-range"));_e.shouldRenderCutoff&&ne.defines.push("RENDER_CUTOFF");const me=t.getOrCreateProgram("model",ne);t.uploadCommonUniforms(T,me,null,pe,_e),t.renderPass!=="shadow"&&ge&&ge.setupShadowsFromMatrix(h.nodeModelMatrix,me),me.draw(t,T.gl.TRIANGLES,I,g,_,N.material.doubleSided?ir.disabled:ir.backCCW,K,a.id,N.vertexBuffer,N.indexBuffer,N.segments,a.paint,t.transform.zoom,void 0,ce)}function df(h,t,a,d,g,_,b){let T;T=h.projection.name==="globe"?o.eu(a,h):[...a],o.aB(T,T,t.matrix);const I=o.aB([],d,T);if(t.meshes)for(const k of t.meshes){if(k.material.alphaMode!=="BLEND"){b.push({mesh:k,depth:0,modelIndex:g,worldViewProjection:I,nodeModelMatrix:T});continue}const N=o.af([],k.centroid,I);!h.isOrthographic&&N[2]<=0||_.push({mesh:k,depth:N[2],modelIndex:g,worldViewProjection:I,nodeModelMatrix:T})}if(t.children)for(const k of t.children)df(h,k,a,d,g,_,b)}function xd(h,t,a,d){const g=a.shadowRenderer;if(!g)return;const _=g.getShadowPassDepthMode(),b=g.getShadowPassColorMode(),T=g.calculateShadowPassMatrixFromMatrix(t),I=Wc(T);a.getOrCreateProgram("modelDepth",{defines:a._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(a,a.context.gl.TRIANGLES,_,Jt.disabled,b,ir.backCCW,I,d.id,h.vertexBuffer,h.indexBuffer,h.segments,d.paint,a.transform.zoom,void 0,void 0)}function I0(h,t,a){const d=t.updateZoomBasedPaintProperties(),g=function(_,b,T){let I,k,N,j=_.terrain?_.terrain.exaggeration():0;if(_.terrain&&j>0){const R=_.terrain,z=R.findDEMTileFor(T);z&&z.dem?I=o.ew.create(R,T,z):j=0}if(j===0&&(b.terrainElevationMin=0,b.terrainElevationMax=0),j===b.validForExaggeration&&(j===0||I&&I._demTile&&I._demTile.tileID===b.validForDEMTile.id&&I._dem._timestamp===b.validForDEMTile.timestamp))return!1;for(const R in b.instancesPerModel){const z=b.instancesPerModel[R];for(let B=0;B<z.instancedDataArray.length;++B){const U=(I?j*I.getElevationAt(0|z.instancedDataArray.float32[16*B],0|z.instancedDataArray.float32[16*B+1],!0,!0):0)+z.instancesEvaluatedElevation[B];z.instancedDataArray.float32[16*B+6]=U,k=k?Math.min(b.terrainElevationMin,U):U,N=N?Math.max(b.terrainElevationMax,U):U}}return b.terrainElevationMin=k||0,b.terrainElevationMax=N||0,b.validForExaggeration=j,b.validForDEMTile=I&&I._demTile?{id:I._demTile.tileID,timestamp:I._dem._timestamp}:{id:void 0,timestamp:0},!0}(h,t,a);(d||g)&&(t.uploaded=!1,t.upload(h.context))}const Do={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new o.d8([0,0,0],[o.al,o.al,0])};function Yc(h,t){const a=1<<h.canonical.z,d=t.getFreeCameraOptions().position,g=t.elevation,_=h.canonical.x/a,b=(h.canonical.x+1)/a,T=h.canonical.y/a,I=(h.canonical.y+1)/a;let k=t._centerAltitude;if(g){const z=g.getMinMaxForTile(h);z&&z.max>k&&(k=z.max)}const N=o.aA(d.x,_,b)-d.x,j=o.aA(d.y,T,I)-d.y,R=o.ce(k,t.center.lat)-d.z;return t._zoomFromMercatorZ(Math.sqrt(N*N+j*j+R*R))}function C0(h,t,a,d,g,_,b){const T=h.context,I=h.renderPass==="shadow",k=h.shadowRenderer,N=I&&k?k.getShadowPassDepthMode():new At(T.gl.LEQUAL,At.ReadWrite,h.depthRangeFor3D),j=h.isTileAffectedByFog(_);if(a.meshes)for(const R of a.meshes){const z=["MODEL_POSITION_ON_GPU"],B=[];let U,Y,H;d.instancedDataArray.length>20&&z.push("INSTANCED_ARRAYS");const K=tl(h,t.paint.get("model-cutoff-fade-range"));if(K.shouldRenderCutoff&&z.push("RENDER_CUTOFF"),I&&k)U=h.getOrCreateProgram("modelDepth",{defines:z}),Y=Wc(b.shadowTileMatrix,b.shadowTileMatrix,Float32Array.from(a.matrix)),H=k.getShadowPassColorMode();else{uf(z,B,R,h,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),U=h.getOrCreateProgram("model",{defines:z,overrideFog:j});const ce=R.material,ge=ce.pbrMetallicRoughness,pe=t.paint.get("model-opacity").constantOr(1),_e=t.paint.get("model-emissive-strength").constantOr(0);Y=ef(_.expandedProjMatrix,Float32Array.from(a.matrix),new Float32Array(16),null,h,pe,ge.baseColorFactor,ce.emissiveFactor,ge.metallicFactor,ge.roughnessFactor,ce,_e,t,g),k&&(b.shadowUniformsInitialized?U.setShadowUniformValues(T,k.getShadowUniformValues()):(k.setupShadows(_.toUnwrapped(),U,"model-tile"),b.shadowUniformsInitialized=!0)),H=K.shouldRenderCutoff||pe<1||ce.alphaMode!=="OPAQUE"?vr.alphaBlended:vr.unblended}h.uploadCommonUniforms(T,U,_.toUnwrapped(),null,K);const ne=R.material.doubleSided?ir.disabled:ir.backCCW;if(d.instancedDataArray.length>20)B.push(d.instancedDataBuffer),U.draw(h,T.gl.TRIANGLES,N,Jt.disabled,H,ne,Y,t.id,R.vertexBuffer,R.indexBuffer,R.segments,t.paint,h.transform.zoom,void 0,B,d.instancedDataArray.length);else{const ce=I?"u_instance":"u_normal_matrix";for(let ge=0;ge<d.instancedDataArray.length;++ge)Y[ce]=new Float32Array(d.instancedDataArray.arrayBuffer,64*ge,16),U.draw(h,T.gl.TRIANGLES,N,Jt.disabled,H,ne,Y,t.id,R.vertexBuffer,R.indexBuffer,R.segments,t.paint,h.transform.zoom,void 0,B)}}if(a.children)for(const R of a.children)C0(h,t,R,d,g,_,b)}const mb=[1,-1,1];function A0(h,t,a,d){if(!a.modelManager)return!0;const g=a.modelManager;if(!a.shadowRenderer)return!0;const _=a.shadowRenderer,b=t.aabb;let T=!0,I=h.maxHeight;if(I===0){let N=0;for(const j in h.instancesPerModel){const R=g.getModel(j,d);R?N=Math.max(N,Math.max(Math.max(R.aabb.max[0],R.aabb.max[1]),R.aabb.max[2])):T=!1}I=h.maxScale*N*1.41+h.maxVerticalOffset,T&&(h.maxHeight=I)}b.max[2]=I,b.min[2]+=h.terrainElevationMin,b.max[2]+=h.terrainElevationMax,o.af(b.min,b.min,t.tileMatrix),o.af(b.max,b.max,t.tileMatrix);const k=b.intersects(_.getCurrentCascadeFrustum());return a.currentShadowCascade===0&&(h.isInsideFirstShadowMapFrustum=k===2),k===0}function hf(h,t){const a=h.uniformValues.u_cutoff_params[0],d=h.uniformValues.u_cutoff_params[1],g=h.uniformValues.u_cutoff_params[2],_=h.uniformValues.u_cutoff_params[3];return d===a||_===g?1:o.aA(((t-a)/(d-a)-g)/(_-g),0,1)}function Om(h,t,a,d){if(t.pitch<20)return 1;const g=t.getWorldToCameraMatrix();o.aB(g,g,h);const _=o.bU(a.min[0],a.min[1],a.min[2],1);let b=o.aC(o.ex(),_,g),T=b,I=b;_[1]=a.max[1],b=o.aC(o.ex(),_,g),T=b[1]<T[1]?b:T,I=b[1]>I[1]?b:I,_[0]=a.max[0],b=o.aC(o.ex(),_,g),T=b[1]<T[1]?b:T,I=b[1]>I[1]?b:I,_[1]=a.min[1],b=o.aC(o.ex(),_,g),T=b[1]<T[1]?b:T,I=b[1]>I[1]?b:I;const k=o.aA(d[0],0,1),N=100*t.pixelsPerMeter*o.aA(d[1],0,1),j=o.aA(d[2],0,1),R=o.ey(o.ex(),T,I,k),z=Math.tan(.5*t.fovX),B=-R[2]*z;if(N===0)return R[1]<-Math.abs(B)?j:1;const U=(-Math.abs(B)-R[1])/N,Y=(K,ne,ce)=>(1-ce)*K+ce*ne,H=o.aA(Y(1,j,U),j,1);return Y(1,H,o.aA((t.pitch-20)/20,0,1))}class P0{}class k0{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,a,d){{const j=this._storage.get(a.id);if(j)return j.lastUsedFrameIdx=t,j.buf}const g=d.gl,_=g.getBufferParameter(g.ELEMENT_ARRAY_BUFFER,g.BUFFER_SIZE),b=new ArrayBuffer(_),T=new Int16Array(b);g.getBufferSubData(g.ELEMENT_ARRAY_BUFFER,0,new Int16Array(b));const I=new o.eA;for(let j=0;j<_/2;j+=3){const R=T[j],z=T[j+1],B=T[j+2];I.emplaceBack(R,z),I.emplaceBack(z,B),I.emplaceBack(B,R)}const k=d.bindVertexArrayOES.current,N=new P0;return N.buf=new ol(d,I),N.lastUsedFrameIdx=t,this._storage.set(a.id,N),d.bindVertexArrayOES.set(k),N.buf}update(t){for(const[a,d]of this._storage)t-d.lastUsedFrameIdx>30&&(d.buf.destroy(),this._storage.delete(a))}destroy(){for(const[t,a]of this._storage)a.buf.destroy(),this._storage.delete(t)}}class ff{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const vd=o.ef([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Kc{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Dm{constructor(t,a){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...a,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...a,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const M0=o.ef([{type:"Float32",name:"a_pos_2f",components:2}]);class gb{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,a){const d=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const b=new o.eB,T=new o.b1;b.emplaceBack(-1,-1),b.emplaceBack(1,-1),b.emplaceBack(1,1),b.emplaceBack(-1,1),T.emplaceBack(0,1,2),T.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(b,M0.members),this.vignetteIdx=t.context.createIndexBuffer(T)}const g=o.bg.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,d);const b={u_vignetteShape:(_={vignetteShape:[a.start,a.range,Math.pow(10,a.fadePower)],vignetteColor:[a.color.r,a.color.g,a.color.b,a.color.a*a.strength]}).vignetteShape,u_vignetteColor:_.vignetteColor};d.draw(t,t.context.gl.TRIANGLES,At.disabled,Jt.disabled,vr.alphaBlended,ir.disabled,b,"vignette",this.vignetteVx,this.vignetteIdx,g)}var _}}class N0{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,a){const d=t.getFreeCameraOptions().position,g=d.toAltitude(),_=d.toLngLat(),b=o.an(_.lng),T=o.an(_.lat),I=t.pixelsPerMeter/a,k=b*o.eD,N=o.eD*Math.log(Math.tan(Math.PI/4+T/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const j=-this._offsetYPrev+N,R=-this._elevationPrev+g;this._accumulatedOffsetX+=(-this._offsetXPrev+k)*I,this._accumulatedOffsetY+=j*I,this._accumulatedElevation+=R*I,this._offsetXPrev=k,this._offsetYPrev=N,this._elevationPrev=g}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function R0(h,t){return[-(h[0]-Math.floor(h[0]/t)*t),-(h[1]-Math.floor(h[1]/t)*t),-(h[2]-Math.floor(h[2]/t)*t)]}function ss(h){const t=o.eo(1323123451230),a=[];for(let d=0;d<h;++d){const g=2*t()-1,_=2*t()-1,b=2*t()-1;a.push(o.d4(g,_,b))}return a}function dl(h,t,a,d,g){const _=o.aA((g-a)/(d-a),0,1);return(1-_)*h+_*t}class Jc{constructor(t){this._movement=new N0,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new gb,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,a){const d=t.transform;this._movement.update(d,this._ppmScaleFactor);const g=d.starsProjMatrix,_=o.c6([]);o.c8(_,_,o.an(90)-d._pitch),o.c7(_,_,-d.angle);const b=o.cb(new Float32Array(16),_),T=o.eC(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),I=o.ed([],T),k=o.aB([],I,b),N=Date.now()/1e3;return this._accumulatedTimeFromStart+=(N-this._prevTime)*a,this._prevTime=N,{projectionMatrix:g,modelviewMatrix:k}}}class Ei extends Jc{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Dm(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const a=t.context;if(!this.particlesVx){const d=ss(this.particlesCount),g=new o.eE,_=new o.b1;let b=0;const T=o.eo(1323123451230);for(let I=0;I<d.length;++I){const k=d[I],N=[2*T()-1,T(),T(),T()];g.emplaceBack(k[0],k[1],k[2],-1,-1,...N),g.emplaceBack(k[0],k[1],k[2],1,-1,...N),g.emplaceBack(k[0],k[1],k[2],1,1,...N),g.emplaceBack(k[0],k[1],k[2],-1,1,...N),_.emplaceBack(b+0,b+1,b+2),_.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=a.createVertexBuffer(g,vd.members),this.particlesIdx=a.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const a=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},d=t.transform.zoom;if(a.revealStart>d)return;const g=dl(0,1,a.revealStart,a.revealStart+a.revealRange,d);if(!this.particlesVx||!this.particlesIdx)return;const _=structuredClone(this._params);let b=[-_.direction.x,_.direction.y,-100];o.aw(b,b);const T=structuredClone(this._vignetteParams);T.strength*=g,_.overrideStyleParameters||(_.intensity=t.style.rain.state.density,_.timeFactor=t.style.rain.state.intensity,_.color=structuredClone(t.style.rain.state.color),b=structuredClone(t.style.rain.state.direction),_.screenThinning.intensity=t.style.rain.state.centerThinning,_.dropletSizeX=t.style.rain.state.dropletSize[0],_.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],_.distortionStrength=100*t.style.rain.state.distortionStrength,T.strength=1,T.color=structuredClone(t.style.rain.state.vignetteColor));const I=this.updateOnRender(t,_.timeFactor),k=t.context,N=k.gl,j=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new o.T(k,{width:t.width,height:t.height,data:null},N.RGBA8)),_.distortionStrength>0&&(k.activeTexture.set(N.TEXTURE0),this.screenTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),N.copyTexSubImage2D(N.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const R=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(k,R),k.activeTexture.set(N.TEXTURE0),this.screenTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE);const z=[_.color.r,_.color.g,_.color.b,_.color.a],B=(U,Y)=>{const H=R0(this._movement.getPosition(),U),K=_.dropletSizeX,ne=_.dropletSizeX*_.dropletSizeYScale,ce=t.width/2,ge=t.height/2,pe=dl(0,_.screenThinning.start,0,1,_.screenThinning.intensity),_e=dl(.001,_.screenThinning.range,0,1,_.screenThinning.intensity),me=dl(0,_.screenThinning.particleOffset,0,1,_.screenThinning.intensity),fe=(ye={modelview:I.modelviewMatrix,projection:I.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:H,velocityConeAperture:_.velocityConeAperture,velocity:_.velocity,boxSize:U,rainDropletSize:[K,ne],distortionStrength:_.distortionStrength,rainDirection:b,color:z,screenSize:[j.width,j.height],thinningCenterPos:[ce,ge],thinningShape:[pe,_e,Math.pow(10,_.screenThinning.fadePower)],thinningAffectedRatio:_.screenThinning.affectedRatio,thinningParticleOffset:me,shapeDirectionalPower:_.shapeDirPower,shapeNormalPower:_.shapeNormalPower,mode:Y?0:1},{u_modelview:Float32Array.from(ye.modelview),u_projection:Float32Array.from(ye.projection),u_time:ye.time,u_cam_pos:ye.camPos,u_texScreen:0,u_velocityConeAperture:ye.velocityConeAperture,u_velocity:ye.velocity,u_boxSize:ye.boxSize,u_rainDropletSize:ye.rainDropletSize,u_distortionStrength:ye.distortionStrength,u_rainDirection:ye.rainDirection,u_color:ye.color,u_screenSize:ye.screenSize,u_thinningCenterPos:ye.thinningCenterPos,u_thinningShape:ye.thinningShape,u_thinningAffectedRatio:ye.thinningAffectedRatio,u_thinningParticleOffset:ye.thinningParticleOffset,u_shapeDirectionalPower:ye.shapeDirectionalPower,u_shapeNormalPower:ye.shapeNormalPower,u_mode:ye.mode});var ye;const Fe=Math.round(_.intensity*this.particlesCount),Pe=o.bg.simpleSegment(0,0,4*Fe,2*Fe);R.draw(t,N.TRIANGLES,At.disabled,Jt.disabled,vr.alphaBlended,ir.disabled,fe,"rain_particles",this.particlesVx,this.particlesIdx,Pe)};_.distortionStrength>0&&B(_.boxSize,!0),B(_.boxSize,!1),this._vignette.draw(t,T)}}const Dr=o.ef([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class L0 extends Jc{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Dm(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const a=t.context;if(!this.particlesVx){const d=ss(this.particlesCount),g=new o.eF,_=new o.b1;let b=0;const T=o.eo(1323123451230);for(let I=0;I<d.length;++I){const k=d[I],N=T(),j=T(),R=T(),z=[I/d.length,N,j,R],B=[T(),T()];g.emplaceBack(k[0],k[1],k[2],-1,-1,...z,...B),g.emplaceBack(k[0],k[1],k[2],1,-1,...z,...B),g.emplaceBack(k[0],k[1],k[2],1,1,...z,...B),g.emplaceBack(k[0],k[1],k[2],-1,1,...z,...B),_.emplaceBack(b+0,b+1,b+2),_.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=a.createVertexBuffer(g,Dr.members),this.particlesIdx=a.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const a=structuredClone(this._params);let d=[-a.direction.x,a.direction.y,-100];o.aw(d,d);const g=structuredClone(this._vignetteParams),_=a.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},b=t.transform.zoom;if(_.revealStart>b)return;const T=dl(0,1,_.revealStart,_.revealStart+_.revealRange,b);g.strength*=T,a.overrideStyleParameters||(a.intensity=t.style.snow.state.density,a.timeFactor=t.style.snow.state.intensity,a.color=structuredClone(t.style.snow.state.color),d=structuredClone(t.style.snow.state.direction),a.screenThinning.intensity=t.style.snow.state.centerThinning,a.billboardSize=2.79*t.style.snow.state.flakeSize,g.strength=1,g.color=structuredClone(t.style.snow.state.vignetteColor));const I=this.updateOnRender(t,a.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const k=t.context,N=k.gl,j=t.transform,R=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(k,R),((z,B,U)=>{const Y=R0(this._movement.getPosition(),z),H=j.width/2,K=j.height/2,ne=dl(0,U.screenThinning.start,0,1,U.screenThinning.intensity),ce=dl(.001,U.screenThinning.range,0,1,U.screenThinning.intensity),ge=dl(0,U.screenThinning.particleOffset,0,1,U.screenThinning.intensity),pe=(_e={modelview:I.modelviewMatrix,projection:I.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Y,velocityConeAperture:U.velocityConeAperture,velocity:U.velocity,horizontalOscillationRadius:U.horizontalOscillationRadius,horizontalOscillationRate:U.horizontalOscillationRate,boxSize:z,billboardSize:1*U.billboardSize,simpleShapeParameters:[U.shapeFadeStart,U.shapeFadePower],screenSize:[j.width,j.height],thinningCenterPos:[H,K],thinningShape:[ne,ce,Math.pow(10,U.screenThinning.fadePower)],thinningAffectedRatio:U.screenThinning.affectedRatio,thinningParticleOffset:ge,color:[U.color.r,U.color.g,U.color.b,U.color.a],direction:d},{u_modelview:Float32Array.from(_e.modelview),u_projection:Float32Array.from(_e.projection),u_time:_e.time,u_cam_pos:_e.camPos,u_velocityConeAperture:_e.velocityConeAperture,u_velocity:_e.velocity,u_horizontalOscillationRadius:_e.horizontalOscillationRadius,u_horizontalOscillationRate:_e.horizontalOscillationRate,u_boxSize:_e.boxSize,u_billboardSize:_e.billboardSize,u_simpleShapeParameters:_e.simpleShapeParameters,u_screenSize:_e.screenSize,u_thinningCenterPos:_e.thinningCenterPos,u_thinningShape:_e.thinningShape,u_thinningAffectedRatio:_e.thinningAffectedRatio,u_thinningParticleOffset:_e.thinningParticleOffset,u_particleColor:_e.color,u_direction:_e.direction});var _e;const me=Math.round(U.intensity*this.particlesCount),fe=o.bg.simpleSegment(0,0,4*me,2*me);this.particlesVx&&this.particlesIdx&&R.draw(t,N.TRIANGLES,At.disabled,Jt.disabled,vr.alphaBlended,ir.disabled,pe,"snow_particles",this.particlesVx,this.particlesIdx,fe)})(a.boxSize,0,a),this._vignette.draw(t,g)}}const hl={symbol:function(h,t,a,d,g){if(h.renderPass!=="translucent")return;const _=Jt.disabled,b=h.colorModeForRenderPass(),T=a.layout.get("text-variable-anchor"),I=a.layout.get("text-size-scale-range"),k=o.aA(h.scaleFactor,I[0],I[1]);T&&function(R,z,B,U,Y,H,K,ne){const ce=z.transform,ge=Y==="map",pe=H==="map";for(const _e of R){const me=U.getTile(_e),fe=me.getBucket(B);if(!fe||!fe.text||!fe.text.segments.get().length)continue;const ye=o.bK(fe.textSizeData,ce.zoom,ne),Fe=jl(_e,fe.getProjection(),ce),Pe=ce.calculatePixelsToTileUnitsMatrix(me),Ze=No(Fe,me.tileID.canonical,pe,ge,ce,fe.getProjection(),Pe),De=fe.hasIconTextFit()&&fe.hasIconData();ye&&nf(fe,ge,pe,K,ce,Ze,_e,Math.pow(2,ce.zoom-me.tileID.overscaledZ),ye,De)}}(d,h,a,t,a.layout.get("text-rotation-alignment"),a.layout.get("text-pitch-alignment"),g,k);const N=a.paint.get("icon-opacity").constantOr(1)!==0,j=a.paint.get("text-opacity").constantOr(1)!==0;a.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(N||j)?yd(h,t,a,d,_,b):(N&&yd(h,t,a,d,_,b,{onlyIcons:!0}),j&&yd(h,t,a,d,_,b,{onlyText:!0})),t.map.showCollisionBoxes&&(_d(h,t,a,d,a.paint.get("text-translate"),a.paint.get("text-translate-anchor"),!0),_d(h,t,a,d,a.paint.get("icon-translate"),a.paint.get("icon-translate-anchor"),!1))},circle:function(h,t,a,d){if(h.renderPass!=="translucent")return;const g=a.paint.get("circle-opacity"),_=a.paint.get("circle-stroke-width"),b=a.paint.get("circle-stroke-opacity"),T=a.layout.get("circle-sort-key").constantOr(1)!==void 0,I=a.paint.get("circle-emissive-strength");if(g.constantOr(1)===0&&(_.constantOr(1)===0||b.constantOr(1)===0))return;const k=h.context,N=k.gl,j=h.transform,R=!(!h.terrain||!h.terrain.enabled),z=a.layout.get("circle-elevation-reference"),B=h.depthModeForSublayer(0,At.ReadOnly),U=new At(h.context.gl.LEQUAL,At.ReadOnly,h.depthRangeFor3D),Y=z==="none"||R?B:U,H=Jt.disabled,K=h.colorModeForDrapableLayerRenderPass(I),ne=j.projection.name==="globe",ce=[o.aF(j.center.lng),o.aJ(j.center.lat)],ge=[];for(let _e=0;_e<d.length;_e++){const me=d[_e],fe=t.getTile(me),ye=fe.getBucket(a);if(!ye||ye.projection.name!==j.projection.name)continue;const Fe=ye.programConfigurations.get(a.id),Pe=ye.layoutVertexBuffer,Ze=ye.globeExtVertexBuffer,De=ye.indexBuffer,He=o.dZ(a),_t=[Ze],ze=h.isTileAffectedByFog(me);ne&&He.push("PROJECTION_GLOBE_VIEW"),He.push("DEPTH_D24"),h.terrain&&j.depthOcclusionForSymbolsAndCircles&&He.push("DEPTH_OCCLUSION"),ye.hasElevation&&!h.terrain&&(He.push("ELEVATED_ROADS"),_t.push(ye.elevatedLayoutVertexBuffer));const Ie=h.getOrCreateProgram("circle",{config:Fe,defines:He,overrideFog:ze}),Ye=j.projection.createInversionMatrix(j,me.canonical),Ue={programConfiguration:Fe,program:Ie,layoutVertexBuffer:Pe,dynamicBuffers:_t,indexBuffer:De,uniformValues:o.d_(h,me,fe,Ye,ce,a),tile:fe};if(T){const nt=ye.segments.get();for(const gt of nt)ge.push({segments:new o.bg([gt]),sortKey:gt.sortKey,state:Ue})}else ge.push({segments:ye.segments,sortKey:0,state:Ue})}T&&ge.sort((_e,me)=>_e.sortKey-me.sortKey);const pe={useDepthForOcclusion:j.depthOcclusionForSymbolsAndCircles};for(const _e of ge){const{programConfiguration:me,program:fe,layoutVertexBuffer:ye,dynamicBuffers:Fe,indexBuffer:Pe,uniformValues:Ze,tile:De}=_e.state,He=_e.segments;h.terrain&&h.terrain.setupElevationDraw(De,fe,pe),h.uploadCommonUniforms(k,fe,De.tileID.toUnwrapped()),fe.draw(h,N.TRIANGLES,Y,H,K,ir.disabled,Ze,a.id,ye,Pe,He,a.paint,j.zoom,me,Fe)}},heatmap:function(h,t,a,d){if(a.paint.get("heatmap-opacity")!==0)if(h.renderPass==="offscreen"){const g=h.context,_=g.gl,b=Jt.disabled,T=new vr([_.ONE,_.ONE,_.ONE,_.ONE],o.ao.transparent,[!0,!0,!0,!0]);(function(z,B,U,Y){const H=z.gl,K=B.width*Y,ne=B.height*Y;z.activeTexture.set(H.TEXTURE1),z.viewport.set([0,0,K,ne]);let ce=U.heatmapFbo;if(!ce||ce&&(ce.width!==K||ce.height!==ne)){ce&&ce.destroy();const ge=H.createTexture();H.bindTexture(H.TEXTURE_2D,ge),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_MAG_FILTER,H.LINEAR),ce=U.heatmapFbo=z.createFramebuffer(K,ne,!0,null),function(pe,_e,me,fe,ye,Fe){const Pe=pe.gl;Pe.texImage2D(Pe.TEXTURE_2D,0,pe.extRenderToTextureHalfFloat?Pe.RGBA16F:Pe.RGBA,ye,Fe,0,Pe.RGBA,pe.extRenderToTextureHalfFloat?Pe.HALF_FLOAT:Pe.UNSIGNED_BYTE,null),fe.colorAttachment.set(me)}(z,0,ge,ce,K,ne)}else H.bindTexture(H.TEXTURE_2D,ce.colorAttachment.get()),z.bindFramebuffer.set(ce.framebuffer)})(g,h,a,h.transform.projection.name==="globe"?.5:.25),g.clear({color:o.ao.transparent});const I=h.transform,k=I.projection.name==="globe",N=k?["PROJECTION_GLOBE_VIEW"]:[],j=k?ir.frontCCW:ir.disabled,R=[o.aF(I.center.lng),o.aJ(I.center.lat)];for(let z=0;z<d.length;z++){const B=d[z];if(t.hasRenderableParent(B))continue;const U=t.getTile(B),Y=U.getBucket(a);if(!Y||Y.projection.name!==I.projection.name)continue;const H=h.isTileAffectedByFog(B),K=Y.programConfigurations.get(a.id),ne=h.getOrCreateProgram("heatmap",{config:K,defines:N,overrideFog:H}),{zoom:ce}=h.transform;h.terrain&&h.terrain.setupElevationDraw(U,ne),h.uploadCommonUniforms(g,ne,B.toUnwrapped());const ge=I.projection.createInversionMatrix(I,B.canonical);ne.draw(h,_.TRIANGLES,At.disabled,b,T,j,x0(h,B,U,ge,R,ce,a.paint.get("heatmap-intensity")),a.id,Y.layoutVertexBuffer,Y.indexBuffer,Y.segments,a.paint,h.transform.zoom,K,k?[Y.globeExtVertexBuffer]:null)}g.viewport.set([0,0,h.width,h.height])}else h.renderPass==="translucent"&&(h.context.setColorMode(h.colorModeForRenderPass()),function(g,_){const b=g.context,T=b.gl,I=_.heatmapFbo;if(!I)return;b.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,I.colorAttachment.get()),b.activeTexture.set(T.TEXTURE1);let k=_.colorRampTexture;k||(k=_.colorRampTexture=new o.T(b,_.colorRamp,T.RGBA8)),k.bind(T.LINEAR,T.CLAMP_TO_EDGE),g.getOrCreateProgram("heatmapTexture").draw(g,T.TRIANGLES,At.disabled,Jt.disabled,g.colorModeForRenderPass(),ir.disabled,((N,j,R,z)=>({u_image:0,u_color_ramp:1,u_opacity:j.paint.get("heatmap-opacity")}))(0,_),_.id,g.viewportBuffer,g.quadTriangleIndexBuffer,g.viewportSegments,_.paint,g.transform.zoom)}(h,a))},line:function(h,t,a,d){if(h.renderPass!=="translucent")return;const g=a.paint.get("line-opacity"),_=a.paint.get("line-width");if(g.constantOr(1)===0||_.constantOr(1)===0)return;const b=a.paint.get("line-emissive-strength"),T=a.paint.get("line-occlusion-opacity"),I=a.layout.get("line-elevation-reference"),k=a.layout.get("line-width-unit")==="meters",N=I==="sea",j=!(!h.terrain||!h.terrain.enabled),R=h.context,z=R.gl;if(a.hasElevatedBuckets&&h.transform.projection.name==="globe")return;const B=a.layout.get("line-cross-slope"),U=B!==void 0,Y=B<1,H=h.colorModeForDrapableLayerRenderPass(b),K=h.terrain&&h.terrain.renderingToTexture,ne=K?1:o.o.devicePixelRatio,ce=a.paint.get("line-dasharray"),ge=ce.constantOr(1),pe=a.layout.get("line-cap"),_e=ce.constantOr(null),me=pe.constantOr(null),fe=a.paint.get("line-pattern"),ye=fe.constantOr(1),Fe=a.paint.get("line-pattern-cross-fade"),Pe=fe.constantOr(null),Ze=a.paint.get("line-opacity").constantOr(1);let De=!ye&&Ze!==1||h.depthOcclusion&&T>0&&T<1;const He=a.paint.get("line-gradient"),_t=ye?"linePattern":"line",ze=o.d$(a);let Ie;if(K&&h.terrain&&h.terrain.clipOrMaskOverlapStencilType()&&(De=!1),T!==0&&h.depthOcclusion){const gt=a.paint._values["line-opacity"];gt&&gt.value&&gt.value.kind==="constant"?Ie=gt.value:o.w(`Occlusion opacity for layer ${a.id} is supported only when line-opacity isn't data-driven.`)}_.value.kind!=="constant"&&_.value.isLineProgressConstant===!1&&ze.push("VARIABLE_LINE_WIDTH");const Ye=(gt,Et,dt,lt,Ft,Dt)=>{for(const zt of gt){const Ot=t.getTile(zt);if(ye&&!Ot.patternsLoaded())continue;const nr=Ot.getBucket(a);if(!nr||nr.elevationType!=="none"&&!Ft||nr.elevationType==="none"&&Ft)continue;h.prepareDrawTile();const gr=[...Et],br=h.shadowRenderer,ii=nr.elevationType==="road"&&!!br&&br.enabled;let lr=[0,0,0];if(ii){const wr=h.style.directionalLight,Qt=h.style.ambientLight;wr&&Qt&&(lr=Oo(h.style,wr,Qt)),gr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const qr=nr.programConfigurations.get(a.id);let ei=!1;if(Pe&&Ot.imageAtlas){const wr=o.e0.from(Pe),Qt=wr.getPrimary().scaleSelf(ne).toString(),ni=Ot.imageAtlas.patternPositions.get(Qt),Gi=wr.getSecondary(),Ri=Gi?Ot.imageAtlas.patternPositions.get(Gi.scaleSelf(ne).toString()):null;ei=!!ni&&!!Ri,ni&&qr.setConstantPatternPositions(ni,Ri)}Fe>0&&(ei||qr.getPatternTransitionVertexBuffer("line-pattern"))&&gr.push("LINE_PATTERN_TRANSITION");const Ii=h.isTileAffectedByFog(zt),_r=h.getOrCreateProgram(_t,{config:qr,defines:gr,overrideFog:Ii});if(!ye&&_e&&me&&Ot.lineAtlas){const wr=Ot.lineAtlas.getDash(_e,me);wr&&qr.setConstantPatternPositions(wr)}ii&&br.setupShadows(Ot.tileID.toUnwrapped(),_r,"vector-tile");let[Xr,Wr]=a.paint.get("line-trim-offset");(me==="round"||me==="square")&&Xr!==Wr&&(Xr===0&&(Xr-=1),Wr===1&&(Wr+=1));const Jr=K?zt.projMatrix:null,Pi=k?1/nr.tileToMeter/o.ay(Ot,1,h.transform.zoom):1,Ki=k?1/nr.tileToMeter/o.ay(Ot,1,Math.floor(h.transform.zoom)):1,An=ye?o.e1(h,Ot,a,Jr,ne,Pi,Ki,[Xr,Wr],lr,Fe):o.e2(h,Ot,a,Jr,nr.lineClipsArray.length,ne,Pi,Ki,[Xr,Wr],lr);if(He){const wr=nr.gradients[a.id];let Qt=wr.texture;if(a.gradientVersion!==wr.version){let ni=256;if(a.stepInterpolant){const Gi=t.getSource().maxzoom,Ri=zt.canonical.z===Gi?Math.ceil(1<<h.transform.maxZoom-zt.canonical.z):1;ni=o.aA(o.e3(nr.maxLineLength/o.al*1024*Ri),256,R.maxTextureSize)}wr.gradient=o.e4({expression:a.gradientExpression(),evaluationKey:"lineProgress",resolution:ni,image:wr.gradient||void 0,clips:nr.lineClipsArray}),wr.texture?wr.texture.update(wr.gradient):wr.texture=new o.T(R,wr.gradient,z.RGBA8),wr.version=a.gradientVersion,Qt=wr.texture}R.activeTexture.set(z.TEXTURE1),Qt.bind(a.stepInterpolant?z.NEAREST:z.LINEAR,z.CLAMP_TO_EDGE)}ge&&(R.activeTexture.set(z.TEXTURE0),Ot.lineAtlasTexture&&Ot.lineAtlasTexture.bind(z.LINEAR,z.REPEAT),qr.updatePaintBuffers()),ye&&(R.activeTexture.set(z.TEXTURE0),Ot.imageAtlasTexture&&Ot.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),qr.updatePaintBuffers()),Ft&&!N&&h.terrain.setupElevationDraw(Ot,_r),h.uploadCommonUniforms(R,_r,zt.toUnwrapped());const ki=wr=>{Ie!=null&&(Ie.value=Ze*T),_r.draw(h,z.TRIANGLES,dt,wr,H,ir.disabled,An,a.id,nr.layoutVertexBuffer,nr.indexBuffer,nr.segments,a.paint,h.transform.zoom,qr,[nr.layoutVertexBuffer2,nr.patternVertexBuffer,nr.zOffsetVertexBuffer]),Ie!=null&&(Ie.value=Ze)};if(De&&!Ft){const wr=h.stencilModeForClipping(zt).ref;wr===0&&K&&R.clear({stencil:0});const Qt={func:z.EQUAL,mask:255};An.u_alpha_discard_threshold=.8,ki(new Jt(Qt,wr,255,z.KEEP,z.KEEP,z.INVERT)),An.u_alpha_discard_threshold=0,ki(new Jt(Qt,wr,255,z.KEEP,z.KEEP,z.KEEP))}else An.u_alpha_discard_threshold=De&&Ft&&Dt?.8:0,ki(Ft?lt:h.stencilModeForClipping(zt))}};let Ue=h.depthModeForSublayer(0,At.ReadOnly);const nt=new At(h.depthOcclusion?z.GREATER:z.LEQUAL,At.ReadOnly,h.depthRangeFor3D);if(a.hasNonElevatedBuckets){const gt=!K&&h.terrain;T!==0&&gt?o.w(`Occlusion opacity for layer ${a.id} is supported on terrain only if the layer has line-z-offset enabled.`):gt?o.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${a.id}.`):Ye(d,ze,Ue,Jt.disabled,!1,!0)}if(a.hasElevatedBuckets){I==="hd-road-markup"?j||(Ue=nt,ze.push("ELEVATED_ROADS")):(ze.push("ELEVATED"),Ue=nt,U&&ze.push(Y?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),N&&ze.push("ELEVATION_REFERENCE_SEA"));const gt=De?h.stencilModeFor3D():Jt.disabled;h.forceTerrainMode=!0,Ye(d,ze,Ue,gt,!0,!0),De&&Ye(d,ze,Ue,gt,!0,!1),h.forceTerrainMode=!1}De&&(h.resetStencilClippingMasks(),K&&R.clear({stencil:0})),T===0||h.depthOcclusion||K||h.layersWithOcclusionOpacity.push(h.currentLayer)},fill:function(h,t,a,d){const g=a.paint.get("fill-color"),_=a.paint.get("fill-opacity");if(_.constantOr(1)===0)return;const b=a.paint.get("fill-emissive-strength"),T=h.colorModeForDrapableLayerRenderPass(b),I=a.paint.get("fill-pattern"),k=h.opaquePassEnabledForLayer()&&!I.constantOr(1)&&g.constantOr(o.ao.transparent).a===1&&_.constantOr(0)===1?"opaque":"translucent";let N="none";a.layout.get("fill-elevation-reference")!=="none"?N="road":a.paint.get("fill-z-offset").constantOr(1)!==0&&(N="offset");const j=!(!h.terrain||!h.terrain.enabled),R={painter:h,sourceCache:t,layer:a,coords:d,colorMode:T,elevationType:N,terrainEnabled:j,pass:k};if(h.renderPass!=="shadow")if(N!=="offset"){if(Zc(R,!1),N==="road"){const z=!j&&h.renderPass==="translucent";z&&Xl(h,t,a,d,"geometry"),Zc(R,!0,Jt.disabled),z&&function(B){const{painter:U,sourceCache:Y,layer:H,coords:K,colorMode:ne}=B,ce=U.context.gl,ge=B.painter.shadowRenderer,pe=!!ge&&ge.enabled,_e=new At(U.context.gl.LEQUAL,At.ReadOnly,U.depthRangeFor3D);let me=[0,0,0];if(pe){const ye=U.style.directionalLight,Fe=U.style.ambientLight;ye&&Fe&&(me=Oo(U.style,ye,Fe))}const fe=ye=>{for(const Fe of K){const Pe=Y.getTile(Fe),Ze=Pe.getBucket(H);if(!Ze)continue;const De=Ze.elevatedStructures;if(!De)continue;let He,_t;if(ye?(He=De.renderableBridgeSegments,_t=De.bridgeProgramConfigurations.get(H.id)):(He=De.renderableTunnelSegments,_t=De.tunnelProgramConfigurations.get(H.id)),!He||He.segments[0].primitiveLength===0)continue;_t.updatePaintBuffers(),U.prepareDrawTile();const ze=U.isTileAffectedByFog(Fe),Ie=[];pe&&Ie.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Ye=U.getOrCreateProgram("elevatedStructures",{config:_t,overrideFog:ze,defines:Ie}),Ue=U.translatePosMatrix(Fe.projMatrix,Pe,H.paint.get("fill-translate"),H.paint.get("fill-translate-anchor"));pe&&ge.setupShadows(Pe.tileID.toUnwrapped(),Ye,"vector-tile");const nt=ab(Ue,me);U.uploadCommonUniforms(U.context,Ye,Fe.toUnwrapped()),Ye.draw(U,ce.TRIANGLES,_e,Jt.disabled,ne,ir.backCCW,nt,H.id,De.vertexBuffer,De.indexBuffer,He,H.paint,U.transform.zoom,_t,[De.vertexBufferNormal])}};fe(!0),fe(!1)}(R)}}else Zc(R,!1,h.stencilModeFor3D());else h.shadowRenderer&&N==="road"&&!j&&function(z){const{painter:B,sourceCache:U,layer:Y,coords:H}=z,K=B.context.gl,ne=z.painter.shadowRenderer;for(const ce of H){const ge=U.getTile(ce),pe=ge.getBucket(Y);if(!pe)continue;const _e=pe.elevatedStructures;if(!_e||!_e.shadowCasterSegments||_e.shadowCasterSegments.segments[0].primitiveLength===0)continue;B.prepareDrawTile();const me=pe.bufferData.programConfigurations.get(Y.id),fe=B.isTileAffectedByFog(ce),ye=B.getOrCreateProgram("elevatedStructuresDepth",{config:me,overrideFog:fe}),Fe=ne.calculateShadowPassMatrixFromTile(ge.tileID.toUnwrapped());B.uploadCommonUniforms(B.context,ye,ce.toUnwrapped());const Pe={u_matrix:Fe,u_depth_bias:0};ye.draw(B,K.TRIANGLES,ne.getShadowPassDepthMode(),Jt.disabled,ne.getShadowPassColorMode(),ir.disabled,Pe,Y.id,_e.vertexBuffer,_e.indexBuffer,_e.shadowCasterSegments,Y.paint,B.transform.zoom,me)}}(R)},"fill-extrusion":function(h,t,a,d){const g=a.paint.get("fill-extrusion-opacity"),_=h.context,b=_.gl,T=h.terrain,I=T&&T.renderingToTexture;if(g===0)return;const k=h.conflationActive&&h.style.isLayerClipped(a,t.getSource()),N=h.style.order.indexOf(a.fqid);if(k&&function(j,R,z,B,U){for(const Y of B){const H=R.getTile(Y).getBucket(z);H&&(H.updateReplacement(Y,j.replacementSource,U),H.uploadCentroid(j.context))}}(h,t,a,d,N),T||k)for(const j of d){const R=t.getTile(j).getBucket(a);R&&ll(h.context,t,j,R,a,T,k)}if(h.renderPass==="shadow"&&h.shadowRenderer){const j=h.shadowRenderer;if(T&&g<.65&&a._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof o.ad)return;const R=j.getShadowPassDepthMode(),z=j.getShadowPassColorMode();Pt(h,t,a,d,R,Jt.disabled,z,k)}else if(h.renderPass==="translucent"){const j=!a.paint.get("fill-extrusion-pattern").constantOr(1),R=a.paint.get("fill-extrusion-color").constantOr(o.ao.white);if(!I&&R.a!==0){const z=new At(h.context.gl.LEQUAL,At.ReadWrite,h.depthRangeFor3D);g===1&&j?Pt(h,t,a,d,z,Jt.disabled,vr.unblended,k):(Pt(h,t,a,d,z,Jt.disabled,vr.disabled,k),Pt(h,t,a,d,z,h.stencilModeFor3D(),h.colorModeForRenderPass(),k),h.resetStencilClippingMasks())}if(h.style.enable3dLights()&&j&&(!T&&h.transform.projection.name!=="globe"||I)){const z=a.paint.get("fill-extrusion-opacity"),B=a.paint.get("fill-extrusion-ambient-occlusion-intensity"),U=a.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Y=a.paint.get("fill-extrusion-flood-light-intensity"),H=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",K=a.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(H?null:a.lut).toArray01().slice(0,3),ne=B>0&&U>0,ce=Y>0,ge=(me,fe,ye)=>(1-ye)*me+ye*fe,pe=new Am;pe.translate=a.paint.get("fill-extrusion-translate"),pe.translateAnchor=a.paint.get("fill-extrusion-translate-anchor"),pe.edgeRadius=a.layout.get("fill-extrusion-edge-radius"),pe.cutoffFadeRange=a.paint.get("fill-extrusion-cutoff-fade-range");const _e=me=>{const fe=h.depthModeForSublayer(1,At.ReadOnly,b.LEQUAL,!0),ye=a.paint.get(me?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Fe=ge(.1,3,ye),Pe=h._showOverdrawInspector;if(!Pe){const Ze=new Jt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),De=new vr([b.ONE,b.ONE,b.ONE,b.ONE],o.ao.transparent,[!1,!1,!1,!0],b.MIN);Ta(pe,h,t,a,d,fe,Ze,De,ir.disabled,me,"sdf",z,B,U,Y,K,Fe,k,!1)}{const Ze=Pe?Jt.disabled:new Jt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),De=Pe?h.colorModeForRenderPass():new vr([b.ONE_MINUS_DST_ALPHA,b.DST_ALPHA,b.ONE,b.ONE],o.ao.transparent,[!0,!0,!0,!0]);Ta(pe,h,t,a,d,fe,Ze,De,ir.disabled,me,"color",z,B,U,Y,K,Fe,k,!1)}};if(I){const me=(fe,ye,Fe)=>{const Pe=h.depthModeForSublayer(1,At.ReadOnly,b.LEQUAL,!1),Ze=a.paint.get(fe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),De=ge(.1,3,Ze);{const He=new vr([b.ONE,b.ONE,b.ONE,b.ONE],o.ao.transparent,[!1,!1,!1,!0]);Ta(pe,h,t,a,d,Pe,Jt.disabled,He,ir.disabled,fe,"clear",z,B,U,Y,K,De,k,ye)}{const He=new Jt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),_t=new vr([b.ONE,b.ONE,b.ONE,b.ONE],o.ao.transparent,[!1,!1,!1,!0],b.MIN);Ta(pe,h,t,a,d,Pe,He,_t,ir.disabled,fe,"sdf",z,B,U,Y,K,De,k,ye)}{const He=fe?b.ZERO:b.ONE_MINUS_DST_ALPHA,_t=new Jt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),ze=new vr([He,b.DST_ALPHA,b.ONE_MINUS_DST_ALPHA,b.ZERO],o.ao.transparent,[!0,!0,!0,!0]);Ta(pe,h,t,a,d,Pe,_t,ze,ir.disabled,fe,"color",z,B,U,Y,K,De,k,ye)}{const He=new vr([b.ONE,b.ONE,b.ONE,fe?b.ZERO:b.ONE],o.ao.transparent,[!1,!1,!1,!0],fe?b.FUNC_ADD:b.MAX);Ta(pe,h,t,a,d,Pe,Jt.disabled,He,ir.disabled,fe,"clear",z,B,U,Y,K,De,k,ye,Fe)}};if(ne||ce){let fe;if(h.prepareDrawTile(),T){const ye=T.drapeBufferSize[0],Fe=T.drapeBufferSize[1];fe=T.framebufferCopyTexture,fe&&(!fe||fe.size[0]===ye&&fe.size[1]===Fe)||(fe&&fe.destroy(),fe=T.framebufferCopyTexture=new o.T(_,new o.q({width:ye,height:Fe}),b.RGBA8)),fe.bind(b.LINEAR,b.CLAMP_TO_EDGE),b.copyTexSubImage2D(b.TEXTURE_2D,0,0,0,0,0,ye,Fe)}ne&&me(!0,!1,fe),ce&&me(!1,!0,fe)}}else ne&&_e(!0),ce&&_e(!1),(ne||ce)&&h.resetStencilClippingMasks()}}},building:function(h,t,a,d){h.currentLayer<h.firstLightBeamLayer&&(h.firstLightBeamLayer=h.currentLayer);const g=a.paint.get("building-ambient-occlusion-ground-intensity"),_=a.paint.get("building-ambient-occlusion-ground-radius"),b=a.paint.get("building-ambient-occlusion-ground-attenuation"),T=a.paint.get("building-opacity");if(T<=0)return;let I=g>0&&_>0,k=!0;const N=a.paint.get("building-vertical-scale");(!h.shadowRenderer||N<1)&&(k=!1);const j=h.conflationActive&&h.style.isLayerClipped(a,t.getSource()),R=h.style.order.indexOf(a.fqid);if(function(z,B,U,Y,H,K){for(const ne of K){const ce=B.getTile(ne).getBucket(U);ce&&(H&&ce.updateReplacement(ne,z.replacementSource,Y),ce.uploadUpdatedIndexBuffer(z.context))}}(h,t,a,R,j,d),function(z,B,U,Y){for(const H of Y){const K=B.getTile(H).getBucket(U);K&&K.needsEvaluation()&&K.uploadUpdatedColorBuffer(z.context)}}(h,t,a,d),a.resetLayerRenderingStats(h),h.shadowRenderer&&(h.shadowRenderer.useNormalOffset=!0),h.renderPass==="shadow"&&h.shadowRenderer){const z=h.shadowRenderer,B=[],U=z.getShadowPassDepthMode();of({painter:h,source:t,layer:a,coords:d,defines:B,blendMode:z.getShadowPassColorMode(),depthMode:U,opacity:T,verticalScale:N,facadeEmissiveChance:0,facadeAOIntensity:0})}else if(h.renderPass==="translucent"){let z=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];k&&(z=z.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),h.shadowRenderer&&h.shadowRenderer.useNormalOffset&&(z=z.concat("NORMAL_OFFSET"));const B=a.paint.get("building-facade-emissive-chance"),U=a.paint.get("building-ambient-occlusion-intensity"),Y=new At(h.context.gl.LEQUAL,At.ReadWrite,h.depthRangeFor3D);T<1&&of({painter:h,source:t,layer:a,coords:d,defines:z,blendMode:vr.disabled,depthMode:Y,opacity:T,verticalScale:N,facadeEmissiveChance:B,facadeAOIntensity:U});const H=h.colorModeForRenderPass();of({painter:h,source:t,layer:a,coords:d,defines:z,blendMode:H,depthMode:Y,opacity:T,verticalScale:N,facadeEmissiveChance:B,facadeAOIntensity:U}),I&&function(K,ne,ce,ge,pe,_e,me,fe,ye,Fe,Pe,Ze,De){const He=K.context.gl,_t=K.depthModeForSublayer(1,At.ReadOnly,He.LEQUAL,!0),ze=.1*(1-(Ie=Pe))+3*Ie;var Ie;const Ye=K._showOverdrawInspector,Ue=Ze,nt=new Am;Ye||Ta(nt,K,ne,ce,ge,_t,new Jt({func:He.ALWAYS,mask:255},255,255,He.KEEP,He.KEEP,He.REPLACE),new vr([He.ONE,He.ONE,He.ONE,He.ONE],o.ao.transparent,[!1,!1,!1,!0],He.MIN),ir.disabled,pe,"sdf",_e,me,fe,0,Fe,ze,Ue,!1);{const gt=Ye?Jt.disabled:new Jt({func:He.EQUAL,mask:255},255,255,He.KEEP,He.DECR,He.DECR),Et=Ye?K.colorModeForRenderPass():new vr([He.ONE_MINUS_DST_ALPHA,He.DST_ALPHA,He.ONE,He.ONE],o.ao.transparent,[!0,!0,!0,!0]);Ta(nt,K,ne,ce,ge,_t,gt,Et,ir.disabled,pe,"color",_e,me,fe,0,Fe,ze,Ue,!1)}}(h,t,a,d,!0,T,g,_,0,[0,0,0],b,j)}else if(h.renderPass==="light-beam"){const z=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],B=new At(h.context.gl.LEQUAL,At.ReadOnly,h.depthRangeFor3D);of({painter:h,source:t,layer:a,coords:d,defines:z,blendMode:vr.alphaBlended,depthMode:B,opacity:T,verticalScale:N,facadeEmissiveChance:0,facadeAOIntensity:0})}h.shadowRenderer&&(h.shadowRenderer.useNormalOffset=!1),h.resetStencilClippingMasks()},hillshade:function(h,t,a,d){if(h.renderPass!=="offscreen"&&h.renderPass!=="translucent"||h.style.disableElevatedTerrain)return;const g=h.context,_=h.terrain&&h.terrain.renderingToTexture,[b,T]=h.renderPass!=="translucent"||_?[{},d]:h.stencilConfigForOverlap(d);for(const I of T){const k=t.getTile(I);if(k.needsHillshadePrepare&&h.renderPass==="offscreen")Xv(h,k,a);else if(h.renderPass==="translucent"){const N=h.depthModeForSublayer(0,At.ReadOnly),j=a.paint.get("hillshade-emissive-strength"),R=h.colorModeForDrapableLayerRenderPass(j),z=_&&h.terrain?h.terrain.stencilModeForRTTOverlap(I):b[I.overscaledZ];Zv(h,I,k,a,N,z,R)}}g.viewport.set([0,0,h.width,h.height]),h.resetStencilClippingMasks()},raster:function(h,t,a,d,g,_){if(h.renderPass!=="translucent"||a.paint.get("raster-opacity")===0)return;const b=h.transform.projection.name==="globe",T=a.paint.get("raster-elevation")!==0,I=T&&b;if(h.renderElevatedRasterBackface&&!I)return;const k=h.context,N=k.gl,j=t.getSource(),R=function(pe,_e,me,fe){const ye=_e.paint.get("raster-color"),Fe=pe.type==="raster-array",Pe=[],Ze=_e.paint.get("raster-resampling"),De=_e.paint.get("raster-color-mix");let He=_e.paint.get("raster-color-range");const _t=[De[0],De[1],De[2],0],ze=De[3];let Ie=Ze==="nearest"?fe.NEAREST:fe.LINEAR;if(Fe&&(Pe.push("RASTER_ARRAY"),ye||Pe.push("RASTER_COLOR"),Ze==="linear"&&Pe.push("RASTER_ARRAY_LINEAR"),Ie=fe.NEAREST,!He&&pe.rasterLayers)){const Ye=pe.rasterLayers.find(({id:Ue})=>Ue===_e.sourceLayer);Ye&&Ye.fields&&Ye.fields.range&&(He=Ye.fields.range)}if(He=He||[0,1],ye){Pe.push("RASTER_COLOR"),me.activeTexture.set(fe.TEXTURE2),_e.updateColorRamp(He);let Ye=_e.colorRampTexture;Ye||(Ye=_e.colorRampTexture=new o.T(me,_e.colorRamp,fe.RGBA8)),Ye.bind(fe.LINEAR,fe.CLAMP_TO_EDGE)}return{mix:_t,range:He,offset:ze,defines:Pe,resampling:Ie}}(j,a,k,N);if(j instanceof o.aS&&!d.length&&!b)return;const z=a.paint.get("raster-emissive-strength"),B=h.colorModeForDrapableLayerRenderPass(z),U=h.terrain&&h.terrain.renderingToTexture,Y=!h.options.moving,H=a.paint.get("raster-resampling")==="nearest"?N.NEAREST:N.LINEAR;if(j instanceof o.aS&&!d.length&&(j.onNorthPole||j.onSouthPole)){const pe=T?h.stencilModeFor3D():Jt.disabled;return void lf(!!j.onNorthPole,null,h,t,a,z,R,ir.disabled,pe)}if(!d.length)return;const[K,ne]=j instanceof o.aS||U?[{},d]:h.stencilConfigForOverlap(d),ce=ne[ne.length-1].overscaledZ;I&&R.defines.push("PROJECTION_GLOBE_VIEW"),T&&R.defines.push("RENDER_CUTOFF");const ge=(pe,_e,me)=>{for(const fe of pe){const ye=fe.toUnwrapped(),Fe=t.getTile(fe);if(U&&(!Fe||!Fe.hasData()))continue;k.activeTexture.set(N.TEXTURE0);const Pe=S0(Fe,j,a,R);if(!Pe||!Pe.texture)continue;const{texture:Ze,mix:De,offset:He,tileSize:_t,buffer:ze}=Pe;let Ie,Ye;U?(Ie=At.disabled,Ye=fe.projMatrix):T?(Ie=new At(N.LEQUAL,At.ReadWrite,h.depthRangeFor3D),Ye=b?Float32Array.from(h.transform.expandedFarZProjMatrix):h.transform.calculateProjMatrix(ye,Y)):(Ie=h.depthModeForSublayer(fe.overscaledZ-ce,a.paint.get("raster-opacity")===1?At.ReadWrite:At.ReadOnly,N.LESS),Ye=h.transform.calculateProjMatrix(ye,Y));const Ue=h.terrain&&U?h.terrain.stencilModeForRTTOverlap(fe):K[fe.overscaledZ],nt=_?0:a.paint.get("raster-fade-duration");Fe.registerFadeDuration(nt);const gt=t.findLoadedParent(fe,0),Et=ql(Fe,gt,t,h.transform,nt);let dt,lt;!Et.isFading&&Fe.refreshedUponExpiration&&(Fe.refreshedUponExpiration=!1),h.terrain&&h.terrain.prepareDrawTile(),k.activeTexture.set(N.TEXTURE0),Ze.bind(H,N.CLAMP_TO_EDGE),k.activeTexture.set(N.TEXTURE1),gt?(gt.texture&&gt.texture.bind(H,N.CLAMP_TO_EDGE),dt=Math.pow(2,gt.tileID.overscaledZ-Fe.tileID.overscaledZ),lt=[Fe.tileID.canonical.x*dt%1,Fe.tileID.canonical.y*dt%1]):Ze.bind(H,N.CLAMP_TO_EDGE),"useMipmap"in Ze&&k.extTextureFilterAnisotropic&&h.transform.pitch>20&&N.texParameterf(N.TEXTURE_2D,k.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,k.extTextureFilterAnisotropicMax);const Ft=h.transform;let Dt;const zt=T?hb(Ft):[0,0,0,0];let Ot,nr,gr,br,ii,lr=0;if(I&&j instanceof o.aS&&j.coordinates.length>3)Ot=Float32Array.from(o.bk(o.dF(new o.cC(0,0,0)))),nr=Float32Array.from(Ft.globeMatrix),gr=Float32Array.from(o.dB(Ft)),br=[o.aF(Ft.center.lng),o.aJ(Ft.center.lat)],Dt=j.elevatedGlobePerspectiveTransform,ii=j.elevatedGlobeGridMatrix||new Float32Array(9);else if(I){const _r=o.dC(fe.canonical);lr=o.dD(_r.getCenter().lat),Ot=Float32Array.from(o.bk(o.dF(fe.canonical))),nr=Float32Array.from(Ft.globeMatrix),gr=Float32Array.from(o.dB(Ft)),br=[o.aF(Ft.center.lng),o.aJ(Ft.center.lat)],Dt=[0,0],ii=Float32Array.from(o.dE(fe.canonical,_r,lr,Ft.worldSize/Ft._pixelsPerMercatorPixel))}else Dt=j instanceof o.aS?j.perspectiveTransform:[0,0],Ot=new Float32Array(16),nr=new Float32Array(9),gr=new Float32Array(16),br=[0,0],ii=new Float32Array(9);const qr=Yh(Ye,Ot,nr,gr,ii,lt||[0,0],o.aj(h.transform.zoom),br,zt,dt||1,Et,a,Dt,T?a.paint.get("raster-elevation"):0,2,De,He,R.range,_t,ze,z),ei=h.isTileAffectedByFog(fe),Ii=h.getOrCreateProgram("raster",{defines:R.defines,overrideFog:ei});if(h.uploadCommonUniforms(k,Ii,ye),j instanceof o.aS){const _r=j.elevatedGlobeVertexBuffer,Xr=j.elevatedGlobeIndexBuffer;if(U||!b)j.boundsBuffer&&j.boundsSegments&&Ii.draw(h,N.TRIANGLES,Ie,Jt.disabled,B,ir.disabled,qr,a.id,j.boundsBuffer,h.quadTriangleIndexBuffer,j.boundsSegments);else if(_r&&Xr){const Wr=Ft.zoom<=o.cZ?j.elevatedGlobeSegments:j.getSegmentsForLongitude(Ft.center.lng);Wr&&Ii.draw(h,N.TRIANGLES,Ie,Jt.disabled,B,_e,qr,a.id,_r,Xr,Wr)}}else if(I){Ie=new At(N.LEQUAL,At.ReadOnly,h.depthRangeFor3D);const _r=h.globeSharedBuffers;if(_r){const[Xr,Wr,Jr]=_r.getGridBuffers(lr,!1);Ii.draw(h,N.TRIANGLES,Ie,me||Ue,h.colorModeForRenderPass(),_e,qr,a.id,Xr,Wr,Jr)}}else{const{tileBoundsBuffer:_r,tileBoundsIndexBuffer:Xr,tileBoundsSegments:Wr}=h.getTileBoundsBuffers(Fe);Ii.draw(h,N.TRIANGLES,Ie,Ue,B,ir.disabled,qr,a.id,_r,Xr,Wr)}}if(!(j instanceof o.aS)&&I)for(const fe of pe){const ye=fe.canonical.y===(1<<fe.canonical.z)-1;fe.canonical.y===0&&lf(!0,fe,h,t,a,z,R,_e,me||Jt.disabled),ye&&lf(!1,fe,h,t,a,z,R,_e===ir.frontCW?ir.backCW:ir.frontCW,me||Jt.disabled)}};I?ge(ne,h.renderElevatedRasterBackface?ir.backCW:ir.frontCW,h.stencilModeFor3D()):ge(ne,ir.disabled,void 0),h.resetStencilClippingMasks()},"raster-particle":function(h,t,a,d,g,_){h.renderPass==="offscreen"&&function(b,T,I,k){if(!k.length)return;const N=b.context,j=N.gl,R=T.getSource();if(!(R instanceof Xa))return;const z=Math.ceil(Math.sqrt(I.paint.get("raster-particle-count")));let B=I.particlePositionRGBAImage;if(!B||B.width!==z){const ne=function(ce){const ge=ce*ce,pe=new Uint8Array(4*ge),_e=function(fe){return fe|=0,fe=Math.imul(2747636419^fe,2654435769),fe=Math.imul(fe^fe>>>16,2654435769),((fe=Math.imul(fe^fe>>>16,2654435769))>>>0)/4294967296},me=1/1.1;for(let fe=0;fe<ge;fe++){const ye=me*(_e(2*fe+0)+Zl),Fe=me*(_e(2*fe+1)+Zl),Pe=255*ye%1,Ze=255*Fe%1,De=Pe,He=Fe-Ze/255,_t=Ze;pe[4*fe+0]=255*(ye-Pe/255),pe[4*fe+1]=255*De,pe[4*fe+2]=255*He,pe[4*fe+3]=255*_t}return pe}(z);B=I.particlePositionRGBAImage=new o.q({width:z,height:z},ne)}let U=I.particleFramebuffer;U?U.width!==z&&(U.destroy(),U=I.particleFramebuffer=N.createFramebuffer(z,z,!0,null)):U=I.particleFramebuffer=N.createFramebuffer(z,z,!0,null);const Y=[];for(const ne of k){const ce=T.getTile(ne);if(!(ce instanceof Ju))continue;const ge=Rs(ce,R,I);if(!ge)continue;const pe=[ce.tileSize,ce.tileSize];let _e=I.tileFramebuffer;_e||(_e=I.tileFramebuffer=N.createFramebuffer(pe[0],pe[1],!0,null));let me=ce.rasterParticleState;me||(me=ce.rasterParticleState=new pb(N,ne,pe,B));const fe=me.update(I.lastInvalidatedAt);me.particleTextureDimension!==z&&me.updateParticleTexture(ne,B);const ye=me.targetColorTexture;me.targetColorTexture=me.backgroundColorTexture,me.backgroundColorTexture=ye;const Fe=me.particleTexture0;me.particleTexture0=me.particleTexture1,me.particleTexture1=Fe,Y.push([ne,ge,me,fe])}if(Y.length===0)return;const H=o.o.now(),K=I.previousDrawTimestamp?.001*(H-I.previousDrawTimestamp):.0167;if(I.previousDrawTimestamp=H,I.hasColorMap()){N.activeTexture.set(j.TEXTURE0+2);let ne=I.colorRampTexture;ne||(ne=I.colorRampTexture=new o.T(N,I.colorRamp,j.RGBA8)),ne.bind(j.LINEAR,j.CLAMP_TO_EDGE)}N.bindFramebuffer.set(I.tileFramebuffer.framebuffer),function(ne,ce,ge){const pe=ne.context,_e=pe.gl,me=ce.tileFramebuffer;pe.activeTexture.set(_e.TEXTURE0);const fe={u_texture:0,u_opacity:1.05*(Fe=ce.paint.get("raster-particle-fade-opacity-factor"))/(Fe+.05)},ye=ne.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Fe;for(const Pe of ge){const[,,Ze,De]=Pe;me.colorAttachment.set(Ze.targetColorTexture.texture),pe.viewport.set([0,0,me.width,me.height]),pe.clear({color:o.ao.transparent}),De&&(Ze.backgroundColorTexture.bind(_e.NEAREST,_e.CLAMP_TO_EDGE),ye.draw(ne,_e.TRIANGLES,At.disabled,Jt.disabled,vr.alphaBlended,ir.disabled,fe,ce.id,ne.viewportBuffer,ne.quadTriangleIndexBuffer,ne.viewportSegments))}}(b,I,Y),function(ne,ce,ge,pe){const _e=ne.context,me=_e.gl,fe=ge.tileFramebuffer,ye=ne.transform.projection.name==="globe",Fe=ge.paint.get("raster-particle-max-speed");for(const Pe of pe){const[Ze,De,He]=Pe;_e.activeTexture.set(me.TEXTURE0+0),De.texture.bind(me.LINEAR,me.CLAMP_TO_EDGE),fe.colorAttachment.set(He.targetColorTexture.texture);const _t=ne.getOrCreateProgram("rasterParticleDraw",{defines:De.defines,overrideFog:!1});_e.activeTexture.set(me.TEXTURE0+1);const ze=De.scalarData?[]:[0,1,2,3].map(Ue=>o.e6[Ue](Ze));ze.push(Ze);const Ie=Ze.canonical.x,Ye=Ze.canonical.y;for(const Ue of ze){const nt=ce.getTile(ye?Ue.wrapped():Ue);if(!nt)continue;const gt=nt.rasterParticleState;if(!gt)continue;const Et=Ue.canonical.x+(1<<Ue.canonical.z)*(Ue.wrap-Ze.wrap),dt=Ue.canonical.y;gt.particleTexture0.bind(me.NEAREST,me.CLAMP_TO_EDGE);const lt=wm(1,gt.particleTexture0.size[0],[Et-Ie,dt-Ye],0,De.texture.size,2,Fe,De.textureOffset,De.scale,De.offset);_t.draw(ne,me.POINTS,At.disabled,Jt.disabled,vr.alphaBlended,ir.disabled,lt,ge.id,gt.particleIndexBuffer,void 0,gt.particleSegment)}}}(b,T,I,Y),N.bindFramebuffer.set(I.particleFramebuffer.framebuffer),function(ne,ce,ge,pe){const _e=ne.context,me=_e.gl,fe=ce.paint.get("raster-particle-max-speed"),ye=pe*ce.paint.get("raster-particle-speed-factor")*.15,Fe=function(Ze){return Math.pow(Ze,6)}(.01+1*ce.paint.get("raster-particle-reset-rate-factor")),Pe=ce.particleFramebuffer;_e.viewport.set([0,0,Pe.width,Pe.height]);for(const Ze of ge){const[,De,He]=Ze;_e.activeTexture.set(me.TEXTURE0+0),De.texture.bind(me.LINEAR,me.CLAMP_TO_EDGE),_e.activeTexture.set(me.TEXTURE0+1);const _t=He.particleTexture0;_t.bind(me.NEAREST,me.CLAMP_TO_EDGE);const ze=Kh(1,_t.size[0],0,De.texture.size,fe,ye,Fe,De.textureOffset,De.scale,De.offset);Pe.colorAttachment.set(He.particleTexture1.texture),_e.clear({color:o.ao.transparent}),ne.getOrCreateProgram("rasterParticleUpdate",{defines:De.defines}).draw(ne,me.TRIANGLES,At.disabled,Jt.disabled,vr.unblended,ir.disabled,ze,ce.id,ne.viewportBuffer,ne.quadTriangleIndexBuffer,ne.viewportSegments)}}(b,I,Y,K)}(h,t,a,d),h.renderPass==="translucent"&&(function(b,T,I,k,N){const j=b.context,R=j.gl,z=T.getSource().tileSize,B=5*(1-o.ah(o.cK,o.cK+1,b.transform.zoom))*z+I.paint.get("raster-particle-elevation"),U=!b.options.moving,Y=b.transform.projection.name==="globe";if(!k.length)return;const[H,K]=b.stencilConfigForOverlap(k),ne=[];Y&&ne.push("PROJECTION_GLOBE_VIEW");const ce=b.stencilModeFor3D();for(const ge of K){const pe=ge.toUnwrapped(),_e=T.getTile(ge);if(!_e.rasterParticleState)continue;const me=_e.rasterParticleState,fe=100;_e.registerFadeDuration(fe);const ye=T.findLoadedParent(ge,0),Fe=ql(_e,ye,T,b.transform,fe);let Pe,Ze;b.terrain&&b.terrain.prepareDrawTile(),j.activeTexture.set(R.TEXTURE0),me.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),j.activeTexture.set(R.TEXTURE1),ye&&ye.rasterParticleState?(ye.rasterParticleState.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),Pe=Math.pow(2,ye.tileID.overscaledZ-_e.tileID.overscaledZ),Ze=[_e.tileID.canonical.x*Pe%1,_e.tileID.canonical.y*Pe%1]):me.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE);const De=Y?Float32Array.from(b.transform.expandedFarZProjMatrix):b.transform.calculateProjMatrix(pe,U),He=b.transform,_t=km(He),ze=o.dC(ge.canonical),Ie=o.dD(ze.getCenter().lat);let Ye,Ue,nt,gt,Et;Y?(Ye=Float32Array.from(o.bk(o.dF(ge.canonical))),Ue=Float32Array.from(He.globeMatrix),nt=Float32Array.from(o.dB(He)),gt=[o.aF(He.center.lng),o.aJ(He.center.lat)],Et=Float32Array.from(o.dE(ge.canonical,ze,Ie,He.worldSize/He._pixelsPerMercatorPixel))):(Ye=new Float32Array(16),Ue=new Float32Array(9),nt=new Float32Array(16),gt=[0,0],Et=new Float32Array(9));const dt=sl(De,Ye,Ue,nt,Et,Ze||[0,0],o.aj(b.transform.zoom),gt,_t,Pe||1,Fe,B),lt=b.isTileAffectedByFog(ge),Ft=b.getOrCreateProgram("rasterParticle",{defines:ne,overrideFog:lt});if(b.uploadCommonUniforms(j,Ft,pe),Y){const Dt=new At(R.LEQUAL,At.ReadOnly,b.depthRangeFor3D),zt=0,Ot=b.globeSharedBuffers;if(Ot){const[nr,gr,br]=Ot.getGridBuffers(Ie,zt!==0);Ft.draw(b,R.TRIANGLES,Dt,ce,vr.alphaBlended,b.renderElevatedRasterBackface?ir.frontCCW:ir.backCCW,dt,I.id,nr,gr,br)}}else{const Dt=b.depthModeForSublayer(0,At.ReadOnly),zt=H[ge.overscaledZ],{tileBoundsBuffer:Ot,tileBoundsIndexBuffer:nr,tileBoundsSegments:gr}=b.getTileBoundsBuffers(_e);Ft.draw(b,R.TRIANGLES,Dt,zt,vr.alphaBlended,ir.disabled,dt,I.id,Ot,nr,gr)}}b.resetStencilClippingMasks()}(h,t,a,d),h.style.map.triggerRepaint())},background:function(h,t,a,d){const g=a.paint.get("background-color"),_=a.paint.get("background-color-use-theme").constantOr("default")==="none",b=a.paint.get("background-opacity"),T=a.paint.get("background-emissive-strength"),I=a.paint.get("background-pitch-alignment")==="viewport";if(b===0)return;const k=h.context,N=k.gl,j=h.transform,R=j.tileSize,z=a.paint.get("background-pattern");let B;if(z!==void 0&&(z===null||(B=h.imageManager.getPattern(o.I.from(z.toString()),a.scope,h.style.getLut(a.scope)),!B)))return;const U=!z&&g.a===1&&b===1&&h.opaquePassEnabledForLayer()?"opaque":"translucent";if(h.renderPass!==U)return;const Y=Jt.disabled,H=h.depthModeForSublayer(0,U==="opaque"?At.ReadWrite:At.ReadOnly),K=h.colorModeForDrapableLayerRenderPass(T),ne=z?"backgroundPattern":"background";let ce,ge=d;if(ge||(ce=h.getBackgroundTiles(),ge=Object.values(ce).map(pe=>pe.tileID)),z&&(k.activeTexture.set(N.TEXTURE0),h.imageManager.bind(h.context,a.scope)),I){const pe=h.getOrCreateProgram(ne,{overrideFog:!1,overrideRtt:!0}),_e=new Float32Array(o.bA([])),me=new o.aO(0,0,0,0,0),fe=z?Qh(_e,T,b,h,0,a.scope,B,I,{tileID:me,tileSize:R}):Jh(_e,T,b,g.toPremultipliedRenderColor(_?null:a.lut));pe.draw(h,N.TRIANGLES,H,Y,K,ir.disabled,fe,a.id,h.viewportBuffer,h.quadTriangleIndexBuffer,h.viewportSegments)}else for(const pe of ge){const _e=h.isTileAffectedByFog(pe),me=h.getOrCreateProgram(ne,{overrideFog:_e}),fe=pe.toUnwrapped(),ye=d?pe.projMatrix:h.transform.calculateProjMatrix(fe);h.prepareDrawTile();const Fe=t?t.getTile(pe):ce?ce[pe.key]:new Ka(pe,R,j.zoom,h),Pe=z?Qh(ye,T,b,h,0,a.scope,B,I,{tileID:pe,tileSize:R}):Jh(ye,T,b,g.toPremultipliedRenderColor(_?null:a.lut));h.uploadCommonUniforms(k,me,fe);const{tileBoundsBuffer:Ze,tileBoundsIndexBuffer:De,tileBoundsSegments:He}=h.getTileBoundsBuffers(Fe);me.draw(h,N.TRIANGLES,H,Y,K,ir.disabled,Pe,a.id,Ze,De,He)}},sky:function(h,t,a){const d=h._atmosphere?o.aj(h.transform.zoom):1,g=a.paint.get("sky-opacity")*d;if(g===0)return;const _=h.context,b=a.paint.get("sky-type"),T=new At(_.gl.LEQUAL,At.ReadOnly,[0,1]),I=h.frameCounter/1e3%1;b==="atmosphere"?h.renderPass==="offscreen"?a.needsSkyboxCapture(h)&&(function(k,N,j,R){const z=k.context,B=z.gl;let U=N.skyboxFbo;if(!U){U=N.skyboxFbo=z.createFramebuffer(32,32,!0,null),N.skyboxGeometry=new Lm(z),N.skyboxTexture=z.gl.createTexture(),B.bindTexture(B.TEXTURE_CUBE_MAP,N.skyboxTexture),B.texParameteri(B.TEXTURE_CUBE_MAP,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_CUBE_MAP,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_CUBE_MAP,B.TEXTURE_MIN_FILTER,B.LINEAR),B.texParameteri(B.TEXTURE_CUBE_MAP,B.TEXTURE_MAG_FILTER,B.LINEAR);for(let ne=0;ne<6;++ne)B.texImage2D(B.TEXTURE_CUBE_MAP_POSITIVE_X+ne,0,B.RGBA,32,32,0,B.RGBA,B.UNSIGNED_BYTE,null)}z.bindFramebuffer.set(U.framebuffer),z.viewport.set([0,0,32,32]);const Y=N.getCenter(k,!0),H=k.getOrCreateProgram("skyboxCapture"),K=new Float64Array(16);o.bA(K),o.ek(K,K,.5*-Math.PI),Jl(k,N,H,K,Y,0),o.bA(K),o.ek(K,K,.5*Math.PI),Jl(k,N,H,K,Y,1),o.bA(K),o.cT(K,K,.5*-Math.PI),Jl(k,N,H,K,Y,2),o.bA(K),o.cT(K,K,.5*Math.PI),Jl(k,N,H,K,Y,3),o.bA(K),Jl(k,N,H,K,Y,4),o.bA(K),o.ek(K,K,Math.PI),Jl(k,N,H,K,Y,5),z.viewport.set([0,0,k.width,k.height])}(h,a),a.markSkyboxValid(h)):h.renderPass==="sky"&&function(k,N,j,R,z){const B=k.context,U=B.gl,Y=k.transform,H=k.getOrCreateProgram("skybox");B.activeTexture.set(U.TEXTURE0),U.bindTexture(U.TEXTURE_CUBE_MAP,N.skyboxTexture);const K=((ne,ce,ge,pe,_e)=>({u_matrix:ne,u_sun_direction:ce,u_cubemap:0,u_opacity:pe,u_temporal_offset:_e}))(Y.skyboxMatrix,N.getCenter(k,!1),0,R,z);k.uploadCommonUniforms(B,H),H.draw(k,U.TRIANGLES,j,Jt.disabled,k.colorModeForRenderPass(),ir.backCW,K,"skybox",N.skyboxGeometry.vertexBuffer,N.skyboxGeometry.indexBuffer,N.skyboxGeometry.segment)}(h,a,T,g,I):b==="gradient"&&h.renderPass==="sky"&&function(k,N,j,R,z){const B=k.context,U=B.gl,Y=k.transform,H=k.getOrCreateProgram("skyboxGradient");N.skyboxGeometry||(N.skyboxGeometry=new Lm(B)),B.activeTexture.set(U.TEXTURE0);let K=N.colorRampTexture;K||(K=N.colorRampTexture=new o.T(B,N.colorRamp,U.RGBA8)),K.bind(U.LINEAR,U.CLAMP_TO_EDGE);const ne=((ce,ge,pe,_e,me)=>({u_matrix:ce,u_color_ramp:0,u_center_direction:ge,u_radius:o.an(pe),u_opacity:_e,u_temporal_offset:me}))(Y.skyboxMatrix,N.getCenter(k,!1),N.paint.get("sky-gradient-radius"),R,z);k.uploadCommonUniforms(B,H),H.draw(k,U.TRIANGLES,j,Jt.disabled,k.colorModeForRenderPass(),ir.backCW,ne,"skyboxGradient",N.skyboxGeometry.vertexBuffer,N.skyboxGeometry.indexBuffer,N.skyboxGeometry.segment)}(h,a,T,g,I)},custom:function(h,t,a,d){const g=h.context,_=a.implementation;if(!h.transform.projection.unsupportedLayers||!h.transform.projection.unsupportedLayers.includes("custom")||h.terrain&&(h.terrain.renderingToTexture||h.renderPass==="offscreen")&&a.isDraped(t)){if(h.renderPass==="offscreen"){const b=_.prerender;if(b){if(h.setCustomLayerDefaults(),g.setColorMode(h.colorModeForRenderPass()),h.transform.projection.name==="globe"){const T=h.transform.pointMerc;b.call(_,g.gl,h.transform.customLayerMatrix(),h.transform.getProjection(),h.transform.globeToMercatorMatrix(),o.aj(h.transform.zoom),[T.x,T.y],h.transform.pixelsPerMeterRatio)}else b.call(_,g.gl,h.transform.customLayerMatrix());g.setDirty(),h.setBaseState()}}else if(h.renderPass==="translucent"){if(h.terrain&&h.terrain.renderingToTexture){const T=_.renderToTile;if(T){const I=d[0].canonical,k={x:I.x+d[0].wrap*(_.wrapTileId?0:1<<I.z),y:I.y,z:I.z};g.setDepthMode(At.disabled),g.setStencilMode(Jt.disabled),g.setColorMode(h.colorModeForRenderPass()),h.setCustomLayerDefaults(),T.call(_,g.gl,k),g.setDirty(),h.setBaseState()}return}h.setCustomLayerDefaults(),g.setColorMode(h.colorModeForRenderPass()),g.setStencilMode(Jt.disabled);const b=_.renderingMode==="3d"?new At(h.context.gl.LEQUAL,At.ReadWrite,h.depthRangeFor3D):h.depthModeForSublayer(0,At.ReadOnly);if(g.setDepthMode(b),h.transform.projection.name==="globe"){const T=h.transform.pointMerc;_.render(g.gl,h.transform.customLayerMatrix(),h.transform.getProjection(),h.transform.globeToMercatorMatrix(),o.aj(h.transform.zoom),[T.x,T.y],h.transform.pixelsPerMeterRatio)}else _.render(g.gl,h.transform.customLayerMatrix());g.setDirty(),h.setBaseState(),g.bindFramebuffer.set(null)}}else o.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(h,t,a,d){if(h.renderPass==="opaque")return;const g=a.paint.get("model-opacity").constantOr(1);if(g===0)return;const _=a.paint.get("model-cast-shadows");if(h.renderPass==="shadow"&&(!_||h.terrain&&g<.65&&a._transitionablePaint._values["model-opacity"].value.expression instanceof o.ad))return;const b=h.shadowRenderer,T=a.paint.get("model-receive-shadows");b&&(b.useNormalOffset=!0,T||(b.enabled=!1));const I=()=>{b&&(b.useNormalOffset=!0,T||(b.enabled=!0))},k=t.getSource();if(h.renderPass==="light-beam"&&k.type!=="batched-model")return;if(k.type==="vector"||k.type==="geojson")return function(H,K,ne,ce,ge){const pe=H.transform;if(pe.projection.name!=="mercator")return void o.w(`Drawing 3D models for ${pe.projection.name} projection is not yet implemented`);const _e=pe.getFreeCameraOptions().position;if(!H.modelManager)return;const me=H.modelManager;ne.modelManager=me;const fe=H.shadowRenderer;if(!ne._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ye=ne._unevaluatedLayout._values["model-id"],Fe=Object.assign({},ne.layout.get("model-id").parameters),Pe=H.style.order.indexOf(ne.fqid);for(const Ze of ce){const De=K.getTile(Ze).getBucket(ne);if(!De||De.projection.name!==pe.projection.name)continue;const He=De.getModelUris();He&&!De.modelsRequested&&(me.addModelsFromBucket(He,ge),De.modelsRequested=!0);const _t=Yc(Ze,pe);Fe.zoom=_t;const ze=ye.possiblyEvaluate(Fe);if(I0(H,De,Ze),Do.shadowUniformsInitialized=!1,Do.useSingleShadowCascade=!!fe&&fe.getMaxCascadeForTile(Ze.toUnwrapped())===0,H.renderPass==="shadow"&&fe){if(H.currentShadowCascade===1&&De.isInsideFirstShadowMapFrustum)continue;const Ue=pe.calculatePosMatrix(Ze.toUnwrapped(),pe.worldSize);if(Do.tileMatrix.set(Ue),Do.shadowTileMatrix=Float32Array.from(fe.calculateShadowPassMatrixFromMatrix(Ue)),Do.aabb.min=[0,0,0],Do.aabb.max[0]=Do.aabb.max[1]=o.al,Do.aabb.max[2]=0,A0(De,Do,H,ne.scope))continue}const Ie=1<<Ze.canonical.z,Ye=[((_e.x-Ze.wrap)*Ie-Ze.canonical.x)*o.al,(_e.y*Ie-Ze.canonical.y)*o.al,_e.z*Ie*o.al];H.conflationActive&&Object.keys(De.instancesPerModel).length>0&&H.style.isLayerClipped(ne,K.getSource())&&De.updateReplacement(Ze,H.replacementSource,Pe,ge)&&(De.uploaded=!1,De.upload(H.context));for(let Ue in De.instancesPerModel){const nt=De.instancesPerModel[Ue];nt.features.length>0&&(Ue=ze.evaluate(nt.features[0].feature,{}));const gt=me.getModel(Ue,ge);if(gt||me.hasURLBeenRequested(Ue)||De.modelUris.includes(Ue)||(De.modelUris.push(Ue),De.modelsRequested=!1),gt&&gt.uploaded)for(const Et of gt.nodes)C0(H,ne,Et,nt,Ye,Ze,Do)}}}(h,t,a,d,k.type==="vector"?a.scope:""),void I();if(!k.loaded())return;if(k.type==="batched-model")return function(H,K,ne,ce){ne.resetLayerRenderingStats(H);const ge=H.context,pe=H.transform,_e=H.style.fog,me=H.shadowRenderer;if(pe.projection.name!=="mercator")return void o.w(`Drawing 3D landmark models for ${pe.projection.name} projection is not yet implemented`);const fe=H.transform.getFreeCameraOptions().position,ye=o.c4([],[fe.x,fe.y,fe.z],H.transform.worldSize),Fe=o.et([],ye),Pe=o.bA([]),Ze=o.ec(pe.center.lat,pe.zoom),De=o.bq([],[1,1,1/Ze]);o.br(Pe,Pe,Fe);const He=ne.paint.get("model-opacity").constantOr(1),_t=new At(ge.gl.LEQUAL,At.ReadWrite,H.depthRangeFor3D),ze=new At(ge.gl.LEQUAL,At.ReadOnly,H.depthRangeFor3D),Ie=new o.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ye=H.renderPass==="shadow",Ue=Ye&&me?me.getCurrentCascadeFrustum():pe.getFrustum(pe.scaleZoom(pe.worldSize)),nt=ne.paint.get("model-front-cutoff"),gt=nt[2]<1,Et=tl(H,ne.paint.get("model-cutoff-fade-range")),dt=ne.getLayerRenderingStats();(function(lt,Ft,Dt,zt){const Ot=lt.terrain?lt.terrain.exaggeration():0,nr=lt.transform.zoom;for(const gr of zt){const br=Ft.getTile(gr).getBucket(Dt);br&&(br.setFilter(Dt.filter),lt.conflationActive&&br.updateReplacement(gr,lt.replacementSource),br.evaluateTransform(lt,Dt),lt.terrain&&Ot>0&&br.elevationUpdate(lt.terrain,Ot,gr,Dt.source),br.needsReEvaluation(lt,nr,Dt)&&br.evaluate(Dt))}})(H,K,ne,ce),function(){let lt,Ft,Dt;gt?(lt=ce.length-1,Ft=-1,Dt=-1):(lt=0,Ft=ce.length,Dt=1);const zt=new Float64Array(16),Ot=o.cz(),nr=new o.P(0,0);for(let gr=lt;gr!==Ft;gr+=Dt){const br=ce[gr],ii=K.getTile(br).getBucket(ne);if(!ii||!ii.uploaded)continue;let lr=!1;me&&(lr=me.getMaxCascadeForTile(br.toUnwrapped())===0);const qr=pe.calculatePosMatrix(br.toUnwrapped(),pe.worldSize),ei=ii.modelTraits;!Ye&&gt&&(o.bl(zt,qr),o.af(Ot,ye,zt),nr.x=Ot[0],nr.y=Ot[1]);const Ii=[];ii.setFilter(ne.filter);for(const _r of ii.getNodesInfo()){if(_r.hiddenByReplacement||!_r.node.meshes)continue;const Xr=_r.node;let Wr=0;H.terrain&&Xr.elevation&&(Wr=Xr.elevation*H.terrain.exaggeration());const Jr=(()=>{const zn=_r.aabb;return Ie.min=[...zn.min],Ie.max=[...zn.max],Ie.min[2]+=Wr,Ie.max[2]+=Wr,o.af(Ie.min,Ie.min,qr),o.af(Ie.max,Ie.max,qr),Ie})(),Pi=_r.evaluatedScale;if(Pi[0]<=1&&Pi[1]<=1&&Pi[2]<=1&&Jr.intersects(Ue)===0)continue;if(!Ye&&gt){const zn=.16666666666666666;_r.cameraCollisionOpacity=ye[0]>Jr.min[0]&&ye[0]<Jr.max[0]&&ye[1]>Jr.min[1]&&ye[1]<Jr.max[1]&&ye[2]*Ze<Jr.max[2]&&Xr.footprint&&o.b$(nr,Xr.footprint)?Math.max(_r.cameraCollisionOpacity-zn,0):Math.min(1,_r.cameraCollisionOpacity+zn)}const Ki=[...qr],An=1/o.d6(br.canonical),ki=Xr.anchor?Xr.anchor[0]:0,wr=Xr.anchor?Xr.anchor[1]:0;o.br(Ki,Ki,[ki*(Pi[0]-1)+_r.evaluatedTranslation[0]*An,wr*(Pi[1]-1)+_r.evaluatedTranslation[1]*An,Wr+_r.evaluatedTranslation[2]]),o.cp(Pi,o.ev)||o.cR(Ki,Ki,Pi);const Qt=o.aB([],Ki,Xr.matrix),ni=o.aB([],pe.expandedFarZProjMatrix,Qt),Gi=o.aB([],pe.expandedFarZProjMatrix,Ki),Ri=o.aC([],[ki,wr,Wr,1],ni)[2];Xr.hidden=!1;let sn=He;Ye||(gt&&(sn*=_r.cameraCollisionOpacity,sn*=Om(Ki,pe,_r.aabb,nt)),sn*=hf(Et,Ri)),sn!==0?Ii.push({nodeInfo:_r,depth:Ri,opacity:sn,wvpForNode:ni,wvpForTile:Gi,nodeModelMatrix:Qt,tileModelMatrix:Ki}):Xr.hidden=!0}Ye||Ii.sort((_r,Xr)=>!gt||_r.opacity===1&&Xr.opacity===1?_r.depth<Xr.depth?-1:1:_r.opacity===1?-1:Xr.opacity===1?1:_r.depth>Xr.depth?-1:1);for(const _r of Ii){const Xr=_r.nodeInfo,Wr=Xr.node;let Jr=o.aB([],De,_r.tileModelMatrix);o.aB(Jr,Pe,Jr);const Pi=o.bl([],Jr);o.ed(Pi,Pi),o.cR(Pi,Pi,mb),Jr=o.aB(Jr,Jr,Wr.matrix);const Ki=H.renderPass==="light-beam",An=ne.paint.get("model-color-use-theme").constantOr("default")==="none",ki=ei&o.ez.HasMapboxMeshFeatures,wr=ki?0:Xr.evaluatedRMEA[0][2];for(let Qt=0;Qt<Wr.meshes.length;++Qt){const ni=Wr.meshes[Qt],Gi=Qt===Wr.lightMeshIndex;let Ri=_r.wvpForNode;if(Gi){if(!Ki&&!H.terrain&&H.shadowRenderer){H.currentLayer<H.firstLightBeamLayer&&(H.firstLightBeamLayer=H.currentLayer);continue}Ri=_r.wvpForTile}else if(Ki)continue;const sn={defines:[]},zn=[];if(!Ye&&me&&(me.useNormalOffset=!!ni.normalBuffer),uf(sn.defines,zn,ni,H,An?null:ne.lut),ki||sn.defines.push("DIFFUSE_SHADED"),lr&&sn.defines.push("SHADOWS_SINGLE_CASCADE"),dt&&(Ye?dt.numRenderedVerticesInShadowPass+=ni.vertexArray.length:dt.numRenderedVerticesInTransparentPass+=ni.vertexArray.length),Ye){xd(ni,_r.nodeModelMatrix,H,ne);continue}let eo=null;if(_e){const Fo=Le(_r.nodeModelMatrix,H.transform);if(eo=new Float32Array(Fo),pe.projection.name!=="globe"){const Xi=ni.aabb.min,Ji=ni.aabb.max,[Li,mn]=_e.getOpacityForBounds(Fo,Xi[0],Xi[1],Ji[0],Ji[1]);sn.overrideFog=Li>=Gt||mn>=Gt}}const to=ni.material;let Ls;to.occlusionTexture&&to.occlusionTexture.offsetScale&&(Ls=to.occlusionTexture.offsetScale,sn.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Os=H.getOrCreateProgram("model",sn);!Ye&&me&&me.setupShadowsFromMatrix(_r.tileModelMatrix,Os,me.useNormalOffset),H.uploadCommonUniforms(ge,Os,null,eo);const gs=to.pbrMetallicRoughness;gs.metallicFactor=.9,gs.roughnessFactor=.5;const _o=ef(new Float32Array(Ri),new Float32Array(Jr),new Float32Array(Pi),new Float32Array(Wr.matrix),H,_r.opacity,gs.baseColorFactor,to.emissiveFactor,gs.metallicFactor,gs.roughnessFactor,to,wr,ne,[0,0,0],Ls);!Gi&&(Xr.hasTranslucentParts||_r.opacity<1)&&Os.draw(H,ge.gl.TRIANGLES,_t,Jt.disabled,vr.disabled,ir.backCCW,_o,ne.id,ni.vertexBuffer,ni.indexBuffer,ni.segments,ne.paint,H.transform.zoom,void 0,zn),Os.draw(H,ge.gl.TRIANGLES,Gi?ze:_t,Jt.disabled,Gi||_r.opacity<1||Xr.hasTranslucentParts?vr.alphaBlended:vr.unblended,ir.backCCW,_o,ne.id,ni.vertexBuffer,ni.indexBuffer,ni.segments,ne.paint,H.transform.zoom,void 0,zn)}}}}()}(h,t,a,d),void I();if(k.type!=="model")return;const N=k.getModels(),j=[],R=h.transform.getFreeCameraOptions().position,z=o.c4([],[R.x,R.y,R.z],h.transform.worldSize);o.et(z,z);const B=[],U=[];let Y=0;for(const H of N){const K=a.paint.get("model-rotation").constantOr(null),ne=a.paint.get("model-scale").constantOr(null),ce=a.paint.get("model-translation").constantOr(null);H.computeModelMatrix(h,K,ne,ce,!0,!0,!1);const ge=o.bA([]),pe=o.ec(H.position.lat,h.transform.zoom),_e=o.bq([],[1,1,1/pe]);o.br(ge,ge,z),j.push({zScaleMatrix:_e,negCameraPosMatrix:ge});for(const me of H.nodes)df(h.transform,me,H.matrix,h.transform.expandedFarZProjMatrix,Y,B,U);Y++}if(B.sort((H,K)=>K.depth-H.depth),h.renderPass!=="shadow"){if(g===1)for(const H of U)tc(H,h,a,j[H.modelIndex],Jt.disabled,h.colorModeForRenderPass());else{for(const H of U)tc(H,h,a,j[H.modelIndex],Jt.disabled,vr.disabled);for(const H of U)tc(H,h,a,j[H.modelIndex],h.stencilModeFor3D(),h.colorModeForRenderPass());h.resetStencilClippingMasks()}for(const H of B)tc(H,h,a,j[H.modelIndex],Jt.disabled,h.colorModeForRenderPass());I()}else{for(const H of U)xd(H.mesh,H.nodeModelMatrix,h,a);for(const H of B)xd(H.mesh,H.nodeModelMatrix,h,a);I()}}},rc={line:function(h,t,a){if(h.hasElevatedBuckets=!1,h.hasNonElevatedBuckets=!1,h._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||h._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const d=t.getVisibleCoordinates();for(const g of d){const _=t.getTile(g).getBucket(h);if(_&&(_.elevationType!=="none"?h.hasElevatedBuckets=!0:h.hasNonElevatedBuckets=!0,h.hasElevatedBuckets&&h.hasNonElevatedBuckets))break}}}else h.hasNonElevatedBuckets=!0},model:function(h,t,a){const d=t.getSource();if(!d.loaded())return;if(d.type==="vector"||d.type==="geojson")return void(a.modelManager&&a.modelManager.upload(a,d.type==="vector"?h.scope:""));if(d.type==="batched-model"||d.type!=="model")return;const g=d.getModels();for(const _ of g)_.upload(a.context)},raster:function(h,t,a){const d=t.getSource();if(!(d instanceof Xa&&d.loaded()))return;const g=h.sourceLayer||d.rasterLayerIds&&d.rasterLayerIds[0];if(!g)return;const _=h.paint.get("raster-array-band")||d.getInitialBand(g);if(_==null)return;const b=t.getIds().map(T=>t.getTileByID(T));for(const T of b)T.updateNeeded(h.id,_)&&d.prepareTile(T,g,h.id,_)},"raster-particle":function(h,t,a){const d=t.getSource();if(!(d instanceof Xa&&d.loaded()))return;const g=h.sourceLayer||d.rasterLayerIds&&d.rasterLayerIds[0];if(!g)return;const _=h.paint.get("raster-particle-array-band")||d.getInitialBand(g);if(_==null)return;const b=t.getIds().map(T=>t.getTileByID(T));for(const T of b)T.updateNeeded(h.id,_)&&d.prepareTile(T,g,h.id,_)}},ic={fill:Xl},fl={fill:function(h,t,a,d){if(!a.layout||a.layout.get("fill-elevation-reference")==="none")return;const g=h.context.gl,_=new At(g.LEQUAL,At.ReadOnly,h.depthRangeFor3D),b=new Jt({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),T=h.transform.getFreeCameraOptions().position,I=h.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const k of d){const N=t.getTile(k),j=N.getBucket(a);if(!j)continue;const R=j.elevatedStructures;if(!R||R.depthSegments.segments[0].primitiveLength===0)continue;const z=b0(k.toUnwrapped(),T),B=h.translatePosMatrix(k.projMatrix,N,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor")),U=Xh(B,z,0,1,0);I.draw(h,g.TRIANGLES,_,b,vr.disabled,ir.disabled,U,a.id,R.vertexBuffer,R.indexBuffer,R.depthSegments,a.paint,h.transform.zoom)}}};class jm{constructor(t,a,d,g,_,b){this.context=new Im(t,a),this.transform=d,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=_,this._timeStamp=o.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const T=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const k of T)this._debugParams.enabledLayers[k]=!0;_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),_.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const k of T)_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],k);this.occlusionParams=new ff(_),this.setup(),this.numSublayers=Ws.maxUnderzooming+Ws.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new o.eG,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new $v(this),this._wireframeDebugCache=new k0,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const I=new o.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new o.T(this.context,I,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=g,this.worldview=b}updateTerrain(t,a){const d=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(d||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new pd(this,t));const g=this._terrain;this.transform.elevation=d?g:null,g.update(t,this.transform,a),this.transform.elevation&&!g.enabled&&(this.transform.elevation=null)}_updateFog(t){const a=t.fog;if(!a||this.transform.projection.name==="globe"||a.getOpacity(this.transform.pitch)<1||a.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[d,g]=a.getFovAdjustedRange(this.transform._fov);if(d>g)return void(this.transform.fogCullDistSq=null);const _=d+.78*(g-d);this.transform.fogCullDistSq=_*_}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new pd(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,a){if(this.width=t*o.o.devicePixelRatio,this.height=a*o.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const d of this.style.order)this.style._mergedLayers[d].resize()}setup(){const t=this.context,a=new o.bd;a.emplaceBack(0,0),a.emplaceBack(o.al,0),a.emplaceBack(0,o.al),a.emplaceBack(o.al,o.al),this.tileExtentBuffer=t.createVertexBuffer(a,o.bf.members),this.tileExtentSegments=o.bg.simpleSegment(0,0,4,2);const d=new o.bd;d.emplaceBack(0,0),d.emplaceBack(o.al,0),d.emplaceBack(0,o.al),d.emplaceBack(o.al,o.al),this.debugBuffer=t.createVertexBuffer(d,o.bf.members),this.debugSegments=o.bg.simpleSegment(0,0,4,5);const g=new o.bd;g.emplaceBack(-1,-1),g.emplaceBack(1,-1),g.emplaceBack(-1,1),g.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(g,o.bf.members),this.viewportSegments=o.bg.simpleSegment(0,0,4,2);const _=new o.b0;_.emplaceBack(0,0,0,0),_.emplaceBack(o.al,0,o.al,0),_.emplaceBack(0,o.al,0,o.al),_.emplaceBack(o.al,o.al,o.al,o.al),this.mercatorBoundsBuffer=t.createVertexBuffer(_,o.bi.members),this.mercatorBoundsSegments=o.bg.simpleSegment(0,0,4,2);const b=new o.b1;b.emplaceBack(0,1,2),b.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(b);const T=new o.be;for(const k of[0,1,3,2,0])T.emplaceBack(k);this.debugIndexBuffer=t.createIndexBuffer(T),this.emptyTexture=new o.T(t,new o.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=o.bC();const I=this.context.gl;this.stencilClearMode=new Jt({func:I.ALWAYS,mask:0},0,255,I.ZERO,I.ZERO,I.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,At.disabled,this.stencilClearMode,vr.disabled,ir.disabled,Gl(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,a,d){if(!a||this.currentStencilSource===a.id||!t.isTileClipped()||!d||d.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let T=!1;for(const I of d)if(this._tileClippingMaskIDs[I.key]===void 0){T=!0;break}if(!T)return}this.currentStencilSource=a.id;const g=this.context,_=g.gl;this.nextStencilID+d.length>256&&this.clearStencil(),g.setColorMode(vr.disabled),g.setDepthMode(At.disabled);const b=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const T of d){const I=a.getTile(T),k=this._tileClippingMaskIDs[T.key]=this.nextStencilID++,{tileBoundsBuffer:N,tileBoundsIndexBuffer:j,tileBoundsSegments:R}=this.getTileBoundsBuffers(I);b.draw(this,_.TRIANGLES,At.disabled,new Jt({func:_.ALWAYS,mask:0},k,255,_.KEEP,_.KEEP,_.REPLACE),vr.disabled,ir.disabled,Gl(T.projMatrix),"$clipping",N,j,R)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,a=this.context.gl;return new Jt({func:a.NOTEQUAL,mask:255},t,255,a.KEEP,a.KEEP,a.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const a=this.context.gl;return new Jt({func:a.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,a.KEEP,a.KEEP,a.REPLACE)}stencilConfigForOverlap(t){const a=this.context.gl,d=t.sort((b,T)=>T.overscaledZ-b.overscaledZ),g=d[d.length-1].overscaledZ,_=d[0].overscaledZ-g+1;if(_>1){this.currentStencilSource=void 0,this.nextStencilID+_>256&&this.clearStencil();const b={};for(let T=0;T<_;T++)b[T+g]=new Jt({func:a.GEQUAL,mask:255},T+this.nextStencilID,255,a.KEEP,a.KEEP,a.REPLACE);return this.nextStencilID+=_,[b,d]}return[{[g]:Jt.disabled},d]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new vr([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new o.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?vr.unblended:vr.alphaBlended}colorModeForDrapableLayerRenderPass(t){const a=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new vr([a.ONE,a.ONE_MINUS_SRC_ALPHA,a.CONSTANT_ALPHA,a.ONE_MINUS_SRC_ALPHA],new o.ao(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,a,d,g=!1){if(this.depthOcclusion)return new At(this.context.gl.GREATER,At.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!g)return At.disabled;const _=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new At(d||this.context.gl.LEQUAL,a,[_,_])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,a=Math.ceil(this.width),d=Math.ceil(this.height),g=this.context.bindFramebuffer.get(),_=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===a&&this.depthFBO.height===d||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),a!==0&&d!==0&&(this.depthFBO=new tf(this.context,a,d,!1,"texture"),this.depthTexture=new o.T(this.context,{width:a,height:d,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(g),t.bindTexture(t.TEXTURE_2D,_),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,a,d,0,0,a,d,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,a)=>t+a/this._fpsHistory.length,0))}render(t,a){const d=o.o.now();this._dt=d-this._timeStamp,this._timeStamp=d,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=a;const g=this.style._mergedLayers,_=!(!this.terrain||!this.terrain.enabled),b=()=>this.style._getOrder(_).filter(ze=>{const Ie=g[ze];return!(Ie.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Ie.type]});let T=b(),I=!1,k=!1,N=null;for(const ze of T){const Ie=g[ze];Ie.type==="circle"?I=!0:Ie.type==="building"?N=Ie:Ie.type==="symbol"&&(Ie.hasOcclusionOpacityProperties?k=!0:I=!0)}let j=T.map(ze=>g[ze]);const R=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(o.o.now()),this.imageManager.beginFrame();let z=0,B=!1;for(const ze in R){const Ie=R[ze];Ie.used&&(Ie.prepare(this.context),Ie.getSource().usedInConflation&&++z)}let U=!1;for(const ze of j)ze.isHidden(this.transform.zoom)||(ze.type==="clip"&&(U=!0),this.prepareLayer(ze));const Y={},H={},K={},ne={},ce={};for(const ze in R){const Ie=R[ze];Y[ze]=Ie.getVisibleCoordinates(),H[ze]=Y[ze].slice().reverse(),K[ze]=Ie.getVisibleCoordinates(!0).reverse(),ne[ze]=Ie.getShadowCasterCoordinates(),ce[ze]=Ie.sortCoordinatesByDistance(Y[ze])}const ge=ze=>{const Ie=this.style.getLayerSourceCache(ze);return Ie&&Ie.used?Ie.getSource():null};if(z||U||this._clippingActiveLastFrame){const ze=[],Ie=[];let Ye=0;for(const Ue of j)this.isSourceForClippingOrConflation(Ue,ge(Ue))&&(ze.push(Ue),Ie.push(Ye)),Ye++;if(ze&&(U||ze.length>1)||this._clippingActiveLastFrame){U=!1;const Ue=[];for(let nt=0;nt<ze.length;nt++){const gt=ze[nt],Et=Ie[nt],dt=this.style.getLayerSourceCache(gt);if(!dt||!dt.used||!dt.getSource().usedInConflation&&gt.type!=="clip"&&gt.type!=="building")continue;let lt=o.eH,Ft=o.bZ.None;const Dt=[];let zt=!0;if(gt.type==="building")lt=o.eJ;else if(gt.type==="clip"){lt=Et;for(const Ot of gt.layout.get("clip-layer-types"))Ft|=Ot==="model"?o.bZ.Model:Ot==="symbol"?o.bZ.Symbol:o.bZ.FillExtrusion;for(const Ot of gt.layout.get("clip-layer-scope"))Dt.push(Ot);gt.isHidden(this.transform.zoom)?zt=!1:U=!0}zt&&Ue.push({layer:gt.fqid,cache:dt,order:lt,clipMask:Ft,clipScope:Dt})}this.replacementSource.setSources(Ue),B=!0}}this._clippingActiveLastFrame=U,B||this.replacementSource.clear(),this.conflationActive=B,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ze=0;ze<j.length;ze++){const Ie=j[ze],Ye=Ie.cutoffRange();if(this.longestCutoffRange=Math.max(Ye,this.longestCutoffRange),Ye>0){const Ue=ge(Ie);Ue&&(this.minCutoffZoom=Math.max(Ue.minzoom,this.minCutoffZoom)),Ie.minzoom&&(this.minCutoffZoom=Math.max(Ie.minzoom,this.minCutoffZoom))}Ie.is3D(_)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ze),this._lastOcclusionLayer=ze)}const pe=this.style&&this.style.fog;pe?(this._fogVisible=pe.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=pe.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(K),this.opaquePassCutoff=0,T=b(),j=T.map(ze=>g[ze]));const _e=this._shadowRenderer;if(_e){_e.updateShadowParameters(this.transform,this.style.directionalLight);for(const ze in R)for(const Ie of Y[ze]){let Ye={min:0,max:0};this.terrain&&(Ye=this.terrain.getMinMaxForTile(Ie)||Ye),_e.addShadowReceiver(Ie.toUnwrapped(),Ye.min,Ye.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new o.eI(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Xc(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const me=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),fe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(me&&!this._snow&&(this._snow=new L0(this)),!me&&this._snow&&(this._snow.destroy(),delete this._snow),fe&&!this._rain&&(this._rain=new Ei(this)),!fe&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),N){this.buildingTileBorderManager||(this.buildingTileBorderManager=new $i);const ze=this.style.getLayerSourceCache(N);this.buildingTileBorderManager.updateBorders(ze,N)}if(!pr.has(this.context.gl))return;this.renderPass="offscreen";for(const ze of j){const Ie=t.getLayerSourceCache(ze);if(!ze.hasOffscreenPass()||ze.isHidden(this.transform.zoom))continue;const Ye=Ie?H[Ie.id]:void 0;(ze.type==="custom"||ze.type==="raster"||ze.type==="raster-particle"||ze.isSky()||Ye&&Ye.length)&&this.renderLayer(this,Ie,ze,Ye)}this.depthRangeFor3D=[0,1-(j.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ne)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ye=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Fe=(()=>{if(a.showOverdrawInspector)return o.ao.black;const ze=this.style.fog;if(ze&&this.transform.projection.supportsFog){const Ie=this.style.getLut(ze.scope);if(!ye){const Ye=ze.properties.get("color-use-theme")==="none",Ue=ze.properties.get("color").toNonPremultipliedRenderColor(Ye?null:Ie).toArray01();return new o.ao(...Ue)}if(ye){const Ye=ze.properties.get("space-color-use-theme")==="none",Ue=ze.properties.get("space-color").toNonPremultipliedRenderColor(Ye?null:Ie).toArray01();return new o.ao(...Ue)}}return o.ao.transparent})();if(this.context.clear({color:Fe,depth:1}),this.clearStencil(),this._showOverdrawInspector=a.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ye&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=T.length-1;this.currentLayer>=0;this.currentLayer--){const ze=j[this.currentLayer],Ie=t.getLayerSourceCache(ze);if(ze.isSky())continue;const Ye=Ie?(ze.is3D(_)?ce:H)[Ie.id]:void 0;this._renderTileClippingMasks(ze,Ie,Ye),this.renderLayer(this,Ie,ze,Ye)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ye&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||o.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<T.length;this.currentLayer++){const ze=j[this.currentLayer],Ie=t.getLayerSourceCache(ze);ze.isSky()&&this.renderLayer(this,Ie,ze,Ie?H[Ie.id]:void 0)}function Pe(ze,Ie){let Ye;return Ie&&(Ye=(ze.type==="symbol"?K:ze.is3D(_)?ce:H)[Ie.id]),Ye}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<T.length;){const ze=j[this.currentLayer];if(ze.type==="raster"||ze.type==="raster-particle"){const Ie=t.getLayerSourceCache(ze);this.renderLayer(this,Ie,ze,Pe(ze,Ie))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ze=0;_e&&(Ze=_e.getShadowCastingLayerCount());let De=!1,He=-1;for(let ze=0;ze<T.length;++ze){const Ie=j[ze];Ie.isHidden(this.transform.zoom)||Ie.is3D(_)&&(He=ze)}k&&He===-1&&(I=!0);let _t=!1;for(;this.currentLayer<T.length;){const ze=j[this.currentLayer],Ie=t.getLayerSourceCache(ze);if(ze.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(ze)){if(ze.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!_t&&ze.is3D(_)&&!_){const Ye=this.currentLayer,Ue=nt=>{for(this.currentLayer=0;this.currentLayer<j.length;this.currentLayer++){const gt=j[this.currentLayer];if(ic[gt.type]){const Et=this.style.getLayerSourceCache(gt);ic[gt.type](this,Et,gt,Pe(gt,Et),nt)}}};Ue("initialize"),Ue("reset"),this.currentLayer=Ye,_t=!0}if(I&&!De&&this.terrain&&!this.transform.isOrthographic&&(De=!0,this.blitDepth()),k&&He!==-1&&this.currentLayer===He+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(ze,Ie,Ie?Y[Ie.id]:void 0),this.renderLayer(this,Ie,ze,Pe(ze,Ie)),!this.terrain&&_e&&Ze>0&&ze.hasShadowPass()&&--Ze==0){{this.clearStencil(),this.resetStencilClippingMasks();const Ye=this.currentLayer;for(this.currentLayer=0;this.currentLayer<j.length;this.currentLayer++){const Ue=j[this.currentLayer];if(fl[Ue.type]){const nt=this.style.getLayerSourceCache(Ue);fl[Ue.type](this,nt,Ue,Pe(Ue,nt))}}this.currentLayer=Ye}if(_e.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Ye=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ye;this.currentLayer++){const Ue=j[this.currentLayer];if(!Ue.hasLightBeamPass())continue;const nt=t.getLayerSourceCache(Ue);this.renderLayer(this,nt,Ue,nt?H[nt.id]:void 0)}this.currentLayer=Ye,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Ye=this.currentLayer;this.depthOcclusion=!0;for(const Ue of this.layersWithOcclusionOpacity){this.currentLayer=Ue;const nt=j[this.currentLayer],gt=t.getLayerSourceCache(nt),Et=gt?H[gt.id]:void 0;this.terrain||this._renderTileClippingMasks(nt,gt,gt?Y[gt.id]:void 0),this.renderLayer(this,gt,nt,Et)}this.depthOcclusion=!1,this.currentLayer=Ye,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let ze=null;j.forEach(Ie=>{const Ye=t.getLayerSourceCache(Ie);Ye&&!Ie.isHidden(this.transform.zoom)&&Ye.getVisibleCoordinates().length&&(!ze||ze.getSource().maxzoom<Ye.getSource().maxzoom)&&(ze=Ye)}),ze&&this.options.showTileBoundaries&&cf(this,ze,ze.getVisibleCoordinates(),o.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&cf(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new o.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(ze){const Ie=ze.transform.padding;ia(ze,ze.transform.height-(Ie.top||0),3,ms),ia(ze,Ie.bottom||0,3,ul),gi(ze,Ie.left||0,3,T0),gi(ze,ze.transform.width-(Ie.right||0),3,Mm);const Ye=ze.transform.centerPoint;(function(Ue,nt,gt,Et){Kl(Ue,nt-1,gt-10,2,20,Et),Kl(Ue,nt-10,gt-1,20,2,Et)})(ze,Ye.x,ze.transform.height-Ye.y,Nm)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),B||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:a}=this.transform.projection,d=!a||!a.includes(t.type);if(rc[t.type]&&(d||this.terrain&&t.type==="custom")){const g=this.style.getLayerSourceCache(t);rc[t.type](t,g,this)}this.gpuTimingEnd()}renderLayer(t,a,d,g){d.isHidden(this.transform.zoom)||(d.type==="background"||d.type==="sky"||d.type==="custom"||d.type==="model"||d.type==="raster"||d.type==="raster-particle"||g&&g.length)&&(this.id=d.id,this.gpuTimingStart(d),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(d.type)&&(!t.terrain||d.type!=="custom")||d.type==="clip"||hl[d.type](t,a,d,g,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const a=this.context.extTimerQuery,d=this.context.gl;let g=this.gpuTimers[t.id];g||(g=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:d.createQuery()}),g.calls++,d.beginQuery(a.TIME_ELAPSED_EXT,g.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,a=this.context.gl,d=a.createQuery();this.deferredRenderGpuTimeQueries.push(d),a.beginQuery(t.TIME_ELAPSED_EXT,d)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const a={};for(const d in t){const g=t[d],_=this.context.extTimerQuery,b=_.getQueryParameter(g.query,this.context.gl.QUERY_RESULT)/1e6;_.deleteQueryEXT(g.query),a[d]=b}return a}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const a=this.context.gl;let d=0;for(const g of t)d+=a.getQueryParameter(g,a.QUERY_RESULT)/1e6,a.deleteQuery(g);return d}translatePosMatrix(t,a,d,g,_){if(!d[0]&&!d[1])return t;const b=_?g==="map"?this.transform.angle:0:g==="viewport"?-this.transform.angle:0;if(b){const k=Math.sin(b),N=Math.cos(b);d=[d[0]*N-d[1]*k,d[0]*k+d[1]*N]}const T=[_?d[0]:o.ay(a,d[0],this.transform.zoom),_?d[1]:o.ay(a,d[1],this.transform.zoom),0],I=new Float32Array(16);return o.br(I,t,T),I}saveTileTexture(t){if(t.context!==this.context)return;const a=t.size[0],d=this._tileTextures[a];d?d.push(t):this._tileTextures[a]=[t]}getTileTexture(t){const a=this._tileTextures[t];return a&&a.length>0?a.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,a,d){const g=d===void 0?this.terrain&&this.terrain.renderingToTexture:d,_=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(_.push("LIGHTING_3D_MODE"),_.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):g||_.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||_.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(_.push("TERRAIN"),this.linearFloatFilteringSupported()&&_.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&_.push("GLOBE"),!this._fogVisible||g||a!==void 0&&!a||_.push("FOG","FOG_DITHERING"),g&&_.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&_.push("OVERDRAW_INSPECTOR"),_}getOrCreateProgram(t,a){this.cache=this.cache||{};const d=a&&a.defines||[],g=a&&a.config,_=this.currentGlobalDefines(t,a&&a.overrideFog,a&&a.overrideRtt).concat(d),b=Zh.cacheKey(Oh[t],t,_,g);return this.cache[b]||(this.cache[b]=new Zh(this.context,t,Oh[t],g,ub[t],_)),this.cache[b]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,a){if(this.style.enable3dLights()){const d=this.style.directionalLight,g=this.style.ambientLight;if(d&&g){const _=((b,T,I)=>{const k=b.properties.get("direction"),N=b.properties.get("color-use-theme")==="none",j=b.properties.get("color").toNonPremultipliedRenderColor(N?null:I.getLut(b.scope)).toArray01(),R=b.properties.get("intensity"),z=T.properties.get("color-use-theme")==="none",B=T.properties.get("color").toNonPremultipliedRenderColor(z?null:I.getLut(T.scope)).toArray01(),U=T.properties.get("intensity"),Y=[k.x,k.y,k.z],H=o.dK(B,U),K=o.dK(j,R);return{u_lighting_ambient_color:H,u_lighting_directional_dir:Y,u_lighting_directional_color:K,u_ground_radiance:Wh(Y,K,H)}})(d,g,this.style);a.setLightsUniformValues(t,_)}}}uploadCommonUniforms(t,a,d,g,_){if(this.uploadCommonLightUniforms(t,a),this.terrain&&this.terrain.renderingToTexture)return;const b=this.style.fog;if(b){const T=b.getOpacity(this.transform.pitch),I=((k,N,j,R,z,B,U,Y,H,K,ne,ce)=>{const ge=k.transform,pe=N.properties.get("color-use-theme")==="none",_e=N.properties.get("color").toNonPremultipliedRenderColor(pe?null:k.style.getLut(N.scope)).toArray01();_e[3]=R;const me=k.frameCounter/1e3%1,[fe,ye]=N.properties.get("vertical-range");return{u_fog_matrix:j?ge.calculateFogTileMatrix(j):ce||k.identityMat,u_fog_range:N.getFovAdjustedRange(ge._fov),u_fog_color:_e,u_fog_horizon_blend:N.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(fe,ye),ye],u_fog_temporal_offset:me,u_frustum_tl:z,u_frustum_tr:B,u_frustum_br:U,u_frustum_bl:Y,u_globe_pos:H,u_globe_radius:K,u_viewport:ne,u_globe_transition:o.aj(ge.zoom),u_is_globe:+(ge.projection.name==="globe")}})(this,b,d,T,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.o.devicePixelRatio,this.transform.height*o.o.devicePixelRatio],g);a.setFogUniformValues(t,I)}_&&a.setCutoffUniformValues(t,_.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),a}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,a=this._backgroundTiles={},d=this.transform.coveringTiles({tileSize:512});for(const g of d)a[g.key]=t[g.key]||new Ka(g,512,this.transform.tileZoom,this,void 0,this.worldview);return a}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,a){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!a||a.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let a=this._cachedTileFogOpacities[t.key];return a||(this._cachedTileFogOpacities[t.key]=a=this.style.fog.getOpacityForTile(t)),a[0]>=Gt||a[1]>=Gt}setupDepthForOcclusion(t,a,d){const g=this.context,_=g.gl,b=!!d;var T;d||(d={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),g.activeTexture.set(_.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),d.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],d.u_depth_range_unpack=[2/((T=this.depthRangeFor3D)[1]-T[0]),-1-2*T[0]/(T[1]-T[0])],d.u_occluder_half_size=.5*this.occlusionParams.occluderSize,d.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),g.activeTexture.set(_.TEXTURE0),b||a.setTerrainUniformValues(g,d)}}function pf(h,t){let a=!1,d=null;const g=()=>{d=null,a&&(h(),d=setTimeout(g,t),a=!1)};return()=>(a=!0,d||g(),d)}class zm{constructor(t){this._hashName=t&&encodeURIComponent(t),o.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=pf(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const a=mf(t);if(this._hashName){const d=this._hashName;let g=!1;const _=location.hash.slice(1).split("&").map(b=>{const T=b.split("=")[0];return T===d?(g=!0,`${T}=${a}`):b}).filter(b=>b);return g||_.push(`${d}=${a}`),`#${_.join("&")}`}return`#${a}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let a;return t.split("&").map(d=>d.split("=")).forEach(d=>{d[0]===this._hashName&&(a=d)}),(a&&a[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const a=this._getCurrentHash();if(a.length>=3&&!a.some(d=>isNaN(Number(d)))){const d=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(a[3]||0):t.getBearing();return t.jumpTo({center:[+a[2],+a[1]],zoom:+a[0],bearing:d,pitch:+(a[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function mf(h,t){const a=h.getCenter(),d=Math.round(100*h.getZoom())/100,g=Math.ceil((d*Math.LN2+Math.log(512/360/.5))/Math.LN10),_=Math.pow(10,g),b=Math.round(a.lng*_)/_,T=Math.round(a.lat*_)/_,I=h.getBearing(),k=h.getPitch();let N=t?`/${b}/${T}/${d}`:`${d}/${T}/${b}`;return(I||k)&&(N+="/"+Math.round(10*I)/10),k&&(N+=`/${Math.round(k)}`),N}const As={linearity:.3,easing:o.eK(0,0,.3,1)},pl=Object.assign({deceleration:2500,maxSpeed:1400},As),Qc=Object.assign({deceleration:20,maxSpeed:1400},As),gf=Object.assign({deceleration:1e3,maxSpeed:360},As),Fm=Object.assign({deceleration:1e3,maxSpeed:90},As);class Bm{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,a=o.o.now();for(;t.length>0&&a-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const a={zoom:0,bearing:0,pitch:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:_}of this._inertiaBuffer)a.zoom+=_.zoomDelta||0,a.bearing+=_.bearingDelta||0,a.pitch+=_.pitchDelta||0,_.panDelta&&a.pan._add(_.panDelta),_.around&&(a.around=_.around),_.pinchAround&&(a.pinchAround=_.pinchAround);const d=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(a.pan.mag()){const _=eu(a.pan.mag(),d,Object.assign({},pl,t||{}));g.offset=a.pan.mult(_.amount/a.pan.mag()),g.center=this._map.transform.center,jo(g,_)}if(a.zoom){const _=eu(a.zoom,d,Qc);g.zoom=this._map.transform.zoom+_.amount,jo(g,_)}if(a.bearing){const _=eu(a.bearing,d,gf);g.bearing=this._map.transform.bearing+o.aA(_.amount,-179,179),jo(g,_)}if(a.pitch){const _=eu(a.pitch,d,Fm);g.pitch=this._map.transform.pitch+_.amount,jo(g,_)}if(g.zoom||g.bearing){const _=a.pinchAround===void 0?a.around:a.pinchAround;g.around=_?this._map.unproject(_):this._map.getCenter()}return this.clear(),g.noMoveStart=!0,g}}function jo(h,t){(!h.duration||h.duration<t.duration)&&(h.duration=t.duration,h.easing=t.easing)}function eu(h,t,a){const{maxSpeed:d,linearity:g,deceleration:_}=a,b=o.aA(h*g/(t/1e3),-d,d),T=Math.abs(b)/(_*g);return{easing:a.easing,duration:1e3*T,amount:b*(T/2)}}class pn extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,a,d,g={}){const _=it(a.getCanvasContainer(),d),b=a.unproject(_);super(t,Object.assign({point:_,lngLat:b,originalEvent:d},g)),this._defaultPrevented=!1,this.target=a}}class tu extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,a,d){const g=t==="touchend"?d.changedTouches:d.touches,_=We(a.getCanvasContainer(),g),b=_.map(I=>a.unproject(I)),T=_.reduce((I,k,N,j)=>I.add(k.div(j.length)),new o.P(0,0));super(t,{points:_,point:T,lngLats:b,lngLat:a.unproject(T),originalEvent:d}),this._defaultPrevented=!1}}class _f extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,a){super("wheel",{originalEvent:a}),this._defaultPrevented=!1}}class Um{constructor(t,a){this._map=t,this._clickTolerance=a.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new _f(this._map,t))}mousedown(t,a){return this._mousedownPos=a,this._firePreventable(new pn(t.type,this._map,t))}mouseup(t){this._map.fire(new pn(t.type,this._map,t))}preclick(t){const a=new MouseEvent("preclick",t);this._map.fire(new pn(a.type,this._map,a))}click(t,a){this._mousedownPos&&this._mousedownPos.dist(a)>=this._clickTolerance||(this.preclick(t),this._map.fire(new pn(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new pn(t.type,this._map,t))}mouseover(t){this._map.fire(new pn(t.type,this._map,t))}mouseout(t){this._map.fire(new pn(t.type,this._map,t))}touchstart(t){return this._firePreventable(new tu(t.type,this._map,t))}touchmove(t){this._map.fire(new tu(t.type,this._map,t))}touchend(t){this._map.fire(new tu(t.type,this._map,t))}touchcancel(t){this._map.fire(new tu(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Vm{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new pn(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new pn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new pn(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class bn{constructor(t,a){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=a.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,a){this.isEnabled()&&t.shiftKey&&t.button===0&&(Ee(),this._startPos=this._lastPos=a,this._active=!0)}mousemoveWindow(t,a){if(!this._active)return;const d=a,g=this._startPos,_=this._lastPos;if(!g||!_||_.equals(d)||!this._box&&d.dist(g)<this._clickTolerance)return;this._lastPos=d,this._box||(this._box=ae("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const b=Math.min(g.x,d.x),T=Math.max(g.x,d.x),I=Math.min(g.y,d.y),k=Math.max(g.y,d.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${b}px,${I}px)`,this._box.style.width=T-b+"px",this._box.style.height=k-I+"px")})}mouseupWindow(t,a){if(!this._active)return;const d=this._startPos,g=a;if(d&&t.button===0){if(this.reset(),tt(),d.x!==g.x||d.y!==g.y)return this._map.fire(new o.z("boxzoomend",{originalEvent:t})),{cameraAnimation:_=>_.fitScreenCoordinates(d,g,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),je(),delete this._startPos,delete this._lastPos}_fireEvent(t,a){return this._map.fire(new o.z(t,{originalEvent:a}))}}function bd(h,t){const a={};for(let d=0;d<h.length;d++)a[h[d].identifier]=t[d];return a}class $m{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,a,d){(this.centroid||d.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),d.length===this.numTouches&&(this.centroid=function(g){const _=new o.P(0,0);for(const b of g)_._add(b);return _.div(g.length)}(a),this.touches=bd(d,a)))}touchmove(t,a,d){if(this.aborted||!this.centroid)return;const g=bd(d,a);for(const _ in this.touches){const b=g[_];(!b||b.dist(this.touches[_])>30)&&(this.aborted=!0)}}touchend(t,a,d){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),d.length===0){const g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class wd{constructor(t){this.singleTap=new $m(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,a,d){this.singleTap.touchstart(t,a,d)}touchmove(t,a,d){this.singleTap.touchmove(t,a,d)}touchend(t,a,d){const g=this.singleTap.touchend(t,a,d);if(g){const _=t.timeStamp-this.lastTime<500,b=!this.lastTap||this.lastTap.dist(g)<30;if(_&&b||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class nc{constructor(){this._zoomIn=new wd({numTouches:1,numTaps:2}),this._zoomOut=new wd({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,a,d){this._zoomIn.touchstart(t,a,d),this._zoomOut.touchstart(t,a,d)}touchmove(t,a,d){this._zoomIn.touchmove(t,a,d),this._zoomOut.touchmove(t,a,d)}touchend(t,a,d){const g=this._zoomIn.touchend(t,a,d),_=this._zoomOut.touchend(t,a,d);return g?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()+1,around:b.unproject(g)},{originalEvent:t})}):_?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()-1,around:b.unproject(_)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Gm={0:1,2:2},yf={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Sd{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,a){return!1}_move(t,a){return{}}mousedown(t,a){if(this._lastPoint)return;const d=Ct(t);this._correctButton(t,d)&&(this._lastPoint=a,this._eventButton=d)}mousemoveWindow(t,a){const d=this._lastPoint;if(d){if(t.preventDefault(),this._eventButton!=null&&function(g,_){const b=Gm[_];return g.buttons===void 0||(g.buttons&b)!==b}(t,this._eventButton))this.reset();else if(this._moved||!(a.dist(d)<this._clickTolerance))return this._moved=!0,this._lastPoint=a,this._move(d,a)}}mouseupWindow(t){this._lastPoint&&Ct(t)===this._eventButton&&(this._moved&&tt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ru extends Sd{mousedown(t,a){super.mousedown(t,a),this._lastPoint&&(this._active=!0)}_correctButton(t,a){return a===0&&!t.ctrlKey}_move(t,a){return{around:a,panDelta:a.sub(t)}}}class xf extends Sd{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?yf[t.pitchRotateKey]:void 0}_correctButton(t,a){return this._pitchRotateKey?a===0&&t[this._pitchRotateKey]:a===0&&t.ctrlKey||a===2}_move(t,a){const d=.8*(a.x-t.x);if(d)return this._active=!0,{bearingDelta:d}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class vf extends Sd{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?yf[t.pitchRotateKey]:void 0}_correctButton(t,a){return this._pitchRotateKey?a===0&&t[this._pitchRotateKey]:a===0&&t.ctrlKey||a===2}_move(t,a){const d=-.5*(a.y-t.y);if(d)return this._active=!0,{pitchDelta:d}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class qm{constructor(t,a){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=a.clickTolerance||1,this.reset(),o.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}touchstart(t,a,d){return this._calculateTransform(t,a,d)}touchmove(t,a,d){if(this._active&&!(d.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(d.length===1&&!o.eL())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,a,d)}}touchend(t,a,d){this._calculateTransform(t,a,d),this._active&&d.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,a,d){d.length>0&&(this._active=!0);const g=bd(d,a),_=new o.P(0,0),b=new o.P(0,0);let T=0;for(const k in g){const N=g[k],j=this._touches[k];j&&(_._add(N),b._add(N.sub(j)),T++,g[k]=N)}if(this._touches=g,T<this._minTouches||!b.mag())return;const I=b.div(T);return this._sum._add(I),this._sum.mag()<this._clickTolerance?void 0:{around:_.div(T),panDelta:I}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ae("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class iu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,a,d){return{}}touchstart(t,a,d){this._firstTwoTouches||d.length<2||(this._firstTwoTouches=[d[0].identifier,d[1].identifier],this._start([a[0],a[1]]))}touchmove(t,a,d){const g=this._firstTwoTouches;if(!g)return;t.preventDefault();const[_,b]=g,T=nu(d,a,_),I=nu(d,a,b);if(!T||!I)return;const k=this._aroundCenter?null:T.add(I).div(2);return this._move([T,I],k,t)}touchend(t,a,d){if(!this._firstTwoTouches)return;const[g,_]=this._firstTwoTouches,b=nu(d,a,g),T=nu(d,a,_);b&&T||(this._active&&tt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function nu(h,t,a){for(let d=0;d<h.length;d++)if(h[d].identifier===a)return t[d]}function bf(h,t){return Math.log2(h/t)}class O0 extends iu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,a){const d=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(bf(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:bf(this._distance,d),pinchAround:a}}}function Hm(h,t){return 180*h.angleWith(t)/Math.PI}class D0 extends iu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,a){const d=this._vector;if(this._vector=t[0].sub(t[1]),d&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Hm(this._vector,d),pinchAround:a}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const a=25/(Math.PI*this._minDiameter)*360,d=this._startVector;if(!d)return!1;const g=Hm(t,d);return Math.abs(g)<a}}function wf(h){return Math.abs(h.y)>Math.abs(h.x)}class j0 extends iu{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,wf(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,a,d){const g=this._lastPoints;if(!g)return;const _=t[0].sub(g[0]),b=t[1].sub(g[1]);return this._map._cooperativeGestures&&!o.eL()&&d.touches.length<3||(this._valid=this.gestureBeginsVertically(_,b,d.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(_.y+b.y)/2*-.5})}gestureBeginsVertically(t,a,d){if(this._valid!==void 0)return this._valid;const g=t.mag()>=2,_=a.mag()>=2;if(!g&&!_)return;if(!g||!_)return this._firstMove==null&&(this._firstMove=d),d-this._firstMove<100&&void 0;const b=t.y>0==a.y>0;return wf(t)&&wf(a)&&b}}const z0={panStep:100,bearingStep:15,pitchStep:10};class F0{constructor(){const t=z0;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let a=0,d=0,g=0,_=0,b=0;switch(t.keyCode){case 61:case 107:case 171:case 187:a=1;break;case 189:case 109:case 173:a=-1;break;case 37:t.shiftKey?d=-1:(t.preventDefault(),_=-1);break;case 39:t.shiftKey?d=1:(t.preventDefault(),_=1);break;case 38:t.shiftKey?g=1:(t.preventDefault(),b=-1);break;case 40:t.shiftKey?g=-1:(t.preventDefault(),b=1);break;default:return}return this._rotationDisabled&&(d=0,g=0),{cameraAnimation:T=>{const I=T.getZoom();T.easeTo({duration:300,easeId:"keyboardHandler",easing:B0,zoom:a?Math.round(I)+a*(t.shiftKey?2:1):I,bearing:T.getBearing()+d*this._bearingStep,pitch:T.getPitch()+g*this._pitchStep,offset:[-_*this._panStep,-b*this._panStep],center:T.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function B0(h){return h*(2-h)}const Wm=4.000244140625,U0=1/450;class V0{constructor(t,a){this._map=t,this._el=t.getCanvasContainer(),this._handler=a,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=U0,o.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||o.eL()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let a=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const d=o.o.now(),g=d-(this._lastWheelEventTime||0);this._lastWheelEventTime=d,a!==0&&a%Wm==0?this._type="wheel":a!==0&&Math.abs(a)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=a,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(g*a)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,a+=this._lastValue)),t.shiftKey&&a&&(a/=4),this._type&&(this._lastWheelEvent=t,this._delta-=a,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const a=it(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:a,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const a=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const k=this._type==="wheel"&&Math.abs(this._delta)>Wm?this._wheelZoomRate:this._defaultZoomRate;let N=2/(1+Math.exp(-Math.abs(this._delta*k)));this._delta<0&&N!==0&&(N=1/N);const j=a(),R=Math.pow(2,j),z=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):R;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(z*N))),this._type==="wheel"&&(this._startZoom=j,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const d=typeof this._targetZoom=="number"?this._targetZoom:a(),g=this._startZoom,_=this._easing;let b,T=!1;if(this._type==="wheel"&&g&&_){const k=Math.min((o.o.now()-this._lastWheelEventTime)/200,1),N=_(k);b=o.ak(g,d,N),k<1?this._frameId||(this._frameId=!0):T=!0}else b=d,T=!0;this._active=!0,T&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let I=b-a();return I*this._lastDelta<0&&(I=0),{noInertia:!0,needsRenderFrame:!T,zoomDelta:I,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let a=o.eM;if(this._prevEase){const d=this._prevEase,g=(o.o.now()-d.start)/d.duration,_=d.easing(g+.01)-d.easing(g),b=.27/Math.sqrt(_*_+1e-4)*.01,T=Math.sqrt(.0729-b*b);a=o.eK(b,T,.25,1)}return this._prevEase={start:o.o.now(),duration:t,easing:a},a}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ae("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class $0{constructor(t,a){this._clickZoom=t,this._tapZoom=a}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class G0{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,a){return t.preventDefault(),{cameraAnimation:d=>{d.easeTo({duration:300,zoom:d.getZoom()+(t.shiftKey?-1:1),around:d.unproject(a)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class _b{constructor(){this._tap=new wd({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,a,d){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?d.length>0&&(this._swipePoint=a[0],this._swipeTouch=d[0].identifier):this._tap.touchstart(t,a,d))}touchmove(t,a,d){if(this._tapTime){if(this._swipePoint){if(d[0].identifier!==this._swipeTouch)return;const g=a[0],_=g.y-this._swipePoint.y;return this._swipePoint=g,t.preventDefault(),this._active=!0,{zoomDelta:_/128}}}else this._tap.touchmove(t,a,d)}touchend(t,a,d){this._tapTime?this._swipePoint&&d.length===0&&this.reset():this._tap.touchend(t,a,d)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class yb{constructor(t,a,d){this._el=t,this._mousePan=a,this._touchPan=d}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class xb{constructor(t,a,d){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=a,this._mousePitch=d}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Fi{constructor(t,a,d,g){this._el=t,this._touchZoom=a,this._touchRotate=d,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Td=h=>h.zoom||h.drag||h.pitch||h.rotate;class vb extends o.z{}class bb{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,a){const d=o.av([],a,t);this.radius=o.ag(d[2]<0?o.eO([],d,this.constants):[d[0],d[1],0])}projectRay(t){o.eO(t,t,this.constants),o.aw(t,t),o.eP(t,t,this.constants);const a=o.c4([],t,this.radius);if(a[2]>0){const d=o.c4([],[0,0,1],o.bJ(a,[0,0,1])),g=o.c4([],o.aw([],[a[0],a[1],0]),this.radius),_=o.d7([],a,o.c4([],o.av([],o.d7([],g,d),a),2));a[0]=_[0],a[1]=_[1]}return a}}function Sf(h){return h.panDelta&&h.panDelta.mag()||h.zoomDelta||h.bearingDelta||h.pitchDelta}class Ed{constructor(t,a){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Bm(t),this._bearingSnap=a.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new bb,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(a),o.aY(["handleEvent","handleWindowEvent"],this);const d=this._el;this._listeners=[[d,"touchstart",{passive:!0}],[d,"touchmove",{passive:!1}],[d,"touchend",void 0],[d,"touchcancel",void 0],[d,"mousedown",void 0],[d,"mousemove",void 0],[d,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[d,"mouseover",void 0],[d,"mouseout",void 0],[d,"dblclick",void 0],[d,"click",void 0],[d,"keydown",{capture:!1}],[d,"keyup",void 0],[d,"wheel",{passive:!1}],[d,"contextmenu",void 0],[window,"blur",void 0]];for(const[g,_,b]of this._listeners){const T=g===document?this.handleWindowEvent:this.handleEvent;g.addEventListener(_,T,b)}}destroy(){for(const[t,a,d]of this._listeners){const g=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(a,g,d)}}_addDefaultHandlers(t){const a=this._map,d=a.getCanvasContainer();this._add("mapEvent",new Um(a,t));const g=a.boxZoom=new bn(a,t);this._add("boxZoom",g);const _=new nc,b=new G0;a.doubleClickZoom=new $0(b,_),this._add("tapZoom",_),this._add("clickZoom",b);const T=new _b;this._add("tapDragZoom",T);const I=a.touchPitch=new j0(a);this._add("touchPitch",I);const k=new xf(t),N=new vf(t);a.dragRotate=new xb(t,k,N),this._add("mouseRotate",k,["mousePitch"]),this._add("mousePitch",N,["mouseRotate"]);const j=new ru(t),R=new qm(a,t);a.dragPan=new yb(d,j,R),this._add("mousePan",j),this._add("touchPan",R,["touchZoom","touchRotate"]);const z=new D0,B=new O0;a.touchZoomRotate=new Fi(d,B,z,T),this._add("touchRotate",z,["touchPan","touchZoom"]),this._add("touchZoom",B,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Vm(a));const U=a.scrollZoom=new V0(a,this);this._add("scrollZoom",U,["mousePan"]);const Y=a.keyboard=new F0;this._add("keyboard",Y);for(const H of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[H]&&a[H].enable(t[H])}_add(t,a,d){this._handlers.push({handlerName:t,handler:a,allowed:d}),this._handlersById[t]=a}stop(t){if(!this._updatingCamera){for(const{handler:a}of this._handlers)a.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Td(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,a,d){for(const g in t)if(g!==d&&(!a||a.indexOf(g)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const a=[];for(const d of t)this._el.contains(d.target)&&a.push(d);return a}handleEvent(t,a){this._updatingCamera=!0;const d=t.type==="renderFrame",g=d?void 0:t,_={needsRenderFrame:!1},b={},T={},I=t.touches?this._getMapTouches(t.touches):void 0,k=I?We(this._el,I):d?void 0:it(this._el,t);for(const{handlerName:R,handler:z,allowed:B}of this._handlers){if(!z.isEnabled())continue;let U;this._blockedByActive(T,B,R)?z.reset():z[a||t.type]&&(U=z[a||t.type](t,k,I),this.mergeHandlerResult(_,b,U,R,g),U&&U.needsRenderFrame&&this._triggerRenderFrame()),(U||z.isActive())&&(T[R]=z)}const N={};for(const R in this._previousActiveHandlers)T[R]||(N[R]=g);this._previousActiveHandlers=T,(Object.keys(N).length||Sf(_))&&(this._changes.push([_,b,N]),this._triggerRenderFrame()),(Object.keys(T).length||Sf(_))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:j}=_;j&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],j(this._map))}mergeHandlerResult(t,a,d,g,_){if(!d)return;Object.assign(t,d);const b={handlerName:g,originalEvent:d.originalEvent||_};d.zoomDelta!==void 0&&(a.zoom=b),d.panDelta!==void 0&&(a.drag=b),d.pitchDelta!==void 0&&(a.pitch=b),d.bearingDelta!==void 0&&(a.rotate=b)}_applyChanges(){const t={},a={},d={};for(const[g,_,b]of this._changes)g.panDelta&&(t.panDelta=(t.panDelta||new o.P(0,0))._add(g.panDelta)),g.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+g.pitchDelta),g.around!==void 0&&(t.around=g.around),g.aroundCoord!==void 0&&(t.aroundCoord=g.aroundCoord),g.pinchAround!==void 0&&(t.pinchAround=g.pinchAround),g.noInertia&&(t.noInertia=g.noInertia),Object.assign(a,_),Object.assign(d,b);this._updateMapTransform(t,a,d),this._changes=[]}_updateMapTransform(t,a,d){const g=this._map,_=g.transform,b=K=>[K.x,K.y,K.z];if((K=>{const ne=this._eventsInProgress.drag;return ne&&!this._handlersById[ne.handlerName].isActive()})()&&!Sf(t)){const K=_.zoom;_.cameraElevationReference="sea",this._originalZoom!=null&&_._orthographicProjectionAtLowPitch&&_.projection.name!=="globe"&&_.pitch===0?(_.cameraElevationReference="ground",_.zoom=this._originalZoom):(_.recenterOnTerrain(),_.cameraElevationReference="ground"),K!==_.zoom&&this._map._update(!0)}if(_._isCameraConstrained&&g._stop(!0),!Sf(t))return void this._fireEvents(a,d,!0);let{panDelta:T,zoomDelta:I,bearingDelta:k,pitchDelta:N,around:j,aroundCoord:R,pinchAround:z}=t;_._isCameraConstrained&&(I>0&&(I=0),_._isCameraConstrained=!1),z!==void 0&&(j=z),(I||(K=>a[K]&&!this._eventsInProgress[K])("drag"))&&j&&(this._dragOrigin=b(_.pointCoordinate3D(j)),this._originalZoom=_.zoom,this._trackingEllipsoid.setup(_._camera.position,this._dragOrigin)),_.cameraElevationReference="sea",g._stop(!0),j=j||g.transform.centerPoint,k&&(_.bearing+=k),N&&(_.pitch+=N),_._updateCameraState();const B=[0,0,0];if(T)if(_.projection.name==="mercator"){const K=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(j).dir),ne=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(j.sub(T)).dir);B[0]=ne[0]-K[0],B[1]=ne[1]-K[1]}else{const K=_.pointCoordinate(j);if(_.projection.name==="globe"){T=T.rotate(-_.angle);const ne=_._pixelsPerMercatorPixel/_.worldSize;B[0]=-T.x*o.eN(o.a$(K.y))*ne,B[1]=-T.y*o.eN(_.center.lat)*ne}else{const ne=_.pointCoordinate(j.sub(T));K&&ne&&(B[0]=ne.x-K.x,B[1]=ne.y-K.y)}}const U=_.zoom,Y=[0,0,0];if(I){const K=b(R||_.pointCoordinate3D(j)),ne={dir:o.aw([],o.av([],K,_._camera.position))};if(ne.dir[2]<0){const ce=_.zoomDeltaToMovement(K,I);o.c4(Y,ne.dir,ce)}}const H=o.d7(B,B,Y);_._translateCameraConstrained(H),I&&Math.abs(_.zoom-U)>1e-4&&_.recenterOnTerrain(),_.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(a,d,!0)}_fireEvents(t,a,d){const g=Td(this._eventsInProgress),_=Td(t),b={};for(const N in t){const{originalEvent:j}=t[N];this._eventsInProgress[N]||(b[`${N}start`]=j),this._eventsInProgress[N]=t[N]}!g&&_&&this._fireEvent("movestart",_.originalEvent);for(const N in b)this._fireEvent(N,b[N]);_&&this._fireEvent("move",_.originalEvent);for(const N in t){const{originalEvent:j}=t[N];this._fireEvent(N,j)}const T={};let I;for(const N in this._eventsInProgress){const{handlerName:j,originalEvent:R}=this._eventsInProgress[N];this._handlersById[j].isActive()||(delete this._eventsInProgress[N],I=a[j]||R,T[`${N}end`]=I)}for(const N in T)this._fireEvent(N,T[N]);const k=Td(this._eventsInProgress);if(d&&(g||_)&&!k){this._updatingCamera=!0;const N=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),j=R=>R!==0&&-this._bearingSnap<R&&R<this._bearingSnap;N?(j(N.bearing||this._map.getBearing())&&(N.bearing=0),this._map.easeTo(N,{originalEvent:I})):(this._map.fire(new o.z("moveend",{originalEvent:I})),j(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,a){this._map.fire(new o.z(t,a?{originalEvent:a}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new vb("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Zm="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Xm extends o.E{constructor(t,a){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=a.bearingSnap,this._respectPrefersReducedMotion=a.respectPrefersReducedMotion!==!1,o.aY(["_renderFrameCallback"],this)}getCenter(){return new o.aR(this.transform.center.lng,this.transform.center.lat)}setCenter(t,a){return this.jumpTo({center:t},a)}panBy(t,a,d){return t=o.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},a),d)}panTo(t,a,d){return this.easeTo(Object.assign({center:t},a),d)}getZoom(){return this.transform.zoom}setZoom(t,a){return this.jumpTo({zoom:t},a),this}zoomTo(t,a,d){return this.easeTo(Object.assign({zoom:t},a),d)}zoomIn(t,a){return this.zoomTo(this.getZoom()+1,t,a),this}zoomOut(t,a){return this.zoomTo(this.getZoom()-1,t,a),this}getBearing(){return this.transform.bearing}setBearing(t,a){return this.jumpTo({bearing:t},a),this}getPadding(){return this.transform.padding}setPadding(t,a){return this.jumpTo({padding:t},a),this}rotateTo(t,a,d){return this.easeTo(Object.assign({bearing:t},a),d)}resetNorth(t,a){return this.rotateTo(0,Object.assign({duration:1e3},t),a),this}resetNorthPitch(t,a){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},t),a),this}snapToNorth(t,a){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,a):this}getPitch(){return this.transform.pitch}setPitch(t,a){return this.jumpTo({pitch:t},a),this}cameraForBounds(t,a){t=o.aI.convert(t);const d=a&&a.bearing||0,g=a&&a.pitch||0,_=t.getNorthWest(),b=t.getSouthEast();return this._cameraForBounds(this.transform,_,b,d,g,a)}_extendPadding(t){const a={top:0,right:0,bottom:0,left:0};return t==null?Object.assign({},a,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:Object.assign({},a,t)}_extendCameraOptions(t){return(t=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,a){const d=a.max[0]-a.min[0],g=a.max[1]-a.min[1];return d/g>t.aspect?d/(2*Math.tan(.5*t.fovX)*t.aspect):g/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,a,d,g,_,b){const T=t.clone(),I=this._extendCameraOptions(b);T.bearing=g,T.pitch=_;const k=o.aR.convert(a),N=o.aR.convert(d),j=.5*(k.lat+N.lat),R=.5*(k.lng+N.lng),z=o.eQ(j,R),B=o.aw([],z),U=o.aw([],o.bI([],B,[0,1,0])),Y=o.bI([],U,B),H=[U[0],U[1],U[2],0,Y[0],Y[1],Y[2],0,B[0],B[1],B[2],0,0,0,0,1],K=[z,o.eQ(k.lat,k.lng),o.eQ(N.lat,k.lng),o.eQ(N.lat,N.lng),o.eQ(k.lat,N.lng),o.eQ(j,k.lng),o.eQ(j,N.lng),o.eQ(k.lat,R),o.eQ(N.lat,R)];let ne=o.d8.fromPoints(K.map(Ue=>[o.bJ(U,Ue),o.bJ(Y,Ue),o.bJ(B,Ue)]));const ce=o.af([],ne.center,H);o.eR(ce)===0&&o.eS(ce,0,0,1),o.aw(ce,ce),o.c4(ce,ce,o.aD),T.center=o.eT(ce);const ge=T.getWorldToCameraMatrix(),pe=o.bl(new Float64Array(16),ge);ne=o.d8.applyTransform(ne,o.aB([],ge,H));const _e=this._extendAABB(ne,T,I,g);if(!_e)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ne=_e,o.af(ce,ce,ge);const me=.5*(ne.max[2]-ne.min[2]),fe=this._minimumAABBFrustumDistance(T,ne),ye=o.c4([],[0,0,1],me),Fe=o.d7(ye,ce,ye),Pe=fe+(T.pitch===0?0:o.bG(ce,Fe)),Ze=T.globeCenterInViewSpace,De=o.av([],ce,[Ze[0],Ze[1],Ze[2]]);o.aw(De,De),o.c4(De,De,Pe);const He=o.d7([],ce,De);o.af(He,He,pe);const _t=o.eD/o.aD,ze=o.ag(He),Ie=o.ce(Math.max(ze*_t-o.eD,Number.EPSILON),0),Ye=Math.min(T.zoomFromMercatorZAdjusted(Ie),I.maxZoom);return Ye>.5*(o.cZ+o.cK)?(T.setProjection({name:"mercator"}),T.zoom=Ye,this._cameraForBounds(T,a,d,g,_,b)):{center:T.center,zoom:Ye,bearing:g,pitch:_}}_extendAABB(t,a,d,g){const _=.5*((d.padding.left||0)+(d.padding.right||0)),b=.5*((d.padding.top||0)+(d.padding.bottom||0)),T=b,I=_,k=_,N=b,j=a.width-(I+k),R=a.height-(T+N),z=o.av([],t.max,t.min),B=Math.min(j/z[0],R/z[1]),U=Math.min(a.scaleZoom(a.scale*B),d.maxZoom);if(isNaN(U))return null;const Y=a.scale/a.zoomScale(U),H=new o.d8([t.min[0]-I*Y,t.min[1]-N*Y,t.min[2]],[t.max[0]+k*Y,t.max[1]+T*Y,t.max[2]]),K=(typeof d.offset.x=="number"&&typeof d.offset.y=="number"?new o.P(d.offset.x,d.offset.y):o.P.convert(d.offset)).rotate(-o.an(g));return H.center[0]-=K.x*Y,H.center[1]+=K.y*Y,H}queryTerrainElevation(t,a){const d=this.transform.elevation;return d?(a=Object.assign({},{exaggerated:!0},a),d.getAtPoint(o.ae.fromLngLat(t),null,a.exaggerated)):null}_cameraForBounds(t,a,d,g,_,b){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,a,d,g,_,b);const T=t.clone(),I=this._extendCameraOptions(b);T.bearing=g,T.pitch=_;const k=o.aR.convert(a),N=o.aR.convert(d),j=new o.aR(k.lng,N.lat),R=new o.aR(N.lng,k.lat),z=T.project(k),B=T.project(N),U=this.queryTerrainElevation(k),Y=this.queryTerrainElevation(N),H=this.queryTerrainElevation(j),K=this.queryTerrainElevation(R),ne=[[z.x,z.y,Math.min(U||0,Y||0,H||0,K||0)],[B.x,B.y,Math.max(U||0,Y||0,H||0,K||0)]];let ce=o.d8.fromPoints(ne);const ge=T.getWorldToCameraMatrix(),pe=o.bl(new Float64Array(16),ge);ce=o.d8.applyTransform(ce,ge);const _e=this._extendAABB(ce,T,I,g);if(!_e)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ce=_e;const me=.5*o.av([],ce.max,ce.min)[2],fe=this._minimumAABBFrustumDistance(T,ce),ye=[0,0,1,0];o.aC(ye,ye,ge),o.eU(ye,ye);const Fe=o.c4([],ye,fe+me),Pe=o.d7([],ce.center,Fe);o.af(ce.center,ce.center,pe),o.af(Pe,Pe,pe);const Ze=T.unproject(new o.P(ce.center[0],ce.center[1])),De=o.eV(T.projection,Ze),He=Math.pow(2,De),_t=Math.min(T._zoomFromMercatorZ(Pe[2]*T.pixelsPerMeter*He/T.worldSize),I.maxZoom);return T.mercatorFromTransition&&_t<.5*(o.cZ+o.cK)?(T.setProjection({name:"globe"}),T.zoom=_t,this._cameraForBounds(T,a,d,g,_,b)):{center:Ze,zoom:_t,bearing:g,pitch:_}}fitBounds(t,a,d){const g=this.cameraForBounds(t,a);return this._fitInternal(g,a,d)}fitScreenCoordinates(t,a,d,g,_){const b=o.P.convert(t),T=o.P.convert(a),I=new o.P(Math.min(b.x,T.x),Math.min(b.y,T.y)),k=new o.P(Math.max(b.x,T.x),Math.max(b.y,T.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(b,T))return this;const N=this.transform.pointLocation3D(I),j=this.transform.pointLocation3D(k),R=this.transform.pointLocation3D(new o.P(I.x,k.y)),z=this.transform.pointLocation3D(new o.P(k.x,I.y)),B=[Math.min(N.lng,j.lng,R.lng,z.lng),Math.min(N.lat,j.lat,R.lat,z.lat)],U=[Math.max(N.lng,j.lng,R.lng,z.lng),Math.max(N.lat,j.lat,R.lat,z.lat)],Y=g&&g.pitch?g.pitch:this.getPitch(),H=this._cameraForBounds(this.transform,B,U,d,Y,g);return this._fitInternal(H,g,_)}_fitInternal(t,a,d){return t?(a=Object.assign(t,a)).linear?this.easeTo(a,d):this.flyTo(a,d):this}jumpTo(t,a){this.stop();const d=t.preloadOnly?this.transform.clone():this.transform;let g=!1,_=!1,b=!1;"zoom"in t&&d.zoom!==+t.zoom&&(g=!0,d.zoom=+t.zoom),t.center!==void 0&&(d.center=o.aR.convert(t.center)),"bearing"in t&&d.bearing!==+t.bearing&&(_=!0,d.bearing=+t.bearing),"pitch"in t&&d.pitch!==+t.pitch&&(b=!0,d.pitch=+t.pitch);const T=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!d.isPaddingEqual(T))if(t.retainPadding===!1){const I=d.clone();I.padding=T,d.setLocationAtPoint(d.center,I.centerPoint)}else d.padding=T;return t.preloadOnly?(this._preloadTiles(d),this):(this.fire(new o.z("movestart",a)).fire(new o.z("move",a)),g&&this.fire(new o.z("zoomstart",a)).fire(new o.z("zoom",a)).fire(new o.z("zoomend",a)),_&&this.fire(new o.z("rotatestart",a)).fire(new o.z("rotate",a)).fire(new o.z("rotateend",a)),b&&this.fire(new o.z("pitchstart",a)).fire(new o.z("pitch",a)).fire(new o.z("pitchend",a)),this.fire(new o.z("moveend",a)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.w(Zm),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,a){const d=this.transform;if(!d.projection.supportsFreeCamera)return o.w(Zm),this;this.stop();const g=d.zoom,_=d.pitch,b=d.bearing;d.setFreeCameraOptions(t);const T=g!==d.zoom,I=_!==d.pitch,k=b!==d.bearing;return this.fire(new o.z("movestart",a)).fire(new o.z("move",a)),T&&this.fire(new o.z("zoomstart",a)).fire(new o.z("zoom",a)).fire(new o.z("zoomend",a)),k&&this.fire(new o.z("rotatestart",a)).fire(new o.z("rotate",a)).fire(new o.z("rotateend",a)),I&&this.fire(new o.z("pitchstart",a)).fire(new o.z("pitch",a)).fire(new o.z("pitchend",a)),this.fire(new o.z("moveend",a)),this}easeTo(t,a){this._stop(!1,t.easeId),((t=Object.assign({offset:[0,0],duration:500,easing:o.eM},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const d=this.transform,g=this.getZoom(),_=this.getBearing(),b=this.getPitch(),T=this.getPadding(),I="zoom"in t?+t.zoom:g,k="bearing"in t?this._normalizeBearing(t.bearing,_):_,N="pitch"in t?+t.pitch:b,j=this._extendPadding(t.padding),R=o.P.convert(t.offset);let z,B,U;if(d.projection.name==="globe"){const ye=o.ae.fromLngLat(d.center),Fe=R.rotate(-d.angle);ye.x+=Fe.x/d.worldSize,ye.y+=Fe.y/d.worldSize;const Pe=ye.toLngLat(),Ze=o.aR.convert(t.center||Pe);this._normalizeCenter(Ze),z=d.centerPoint.add(Fe),B=new o.P(ye.x,ye.y).mult(d.worldSize),U=new o.P(o.aF(Ze.lng),o.aJ(Ze.lat)).mult(d.worldSize).sub(B)}else{z=d.centerPoint.add(R);const ye=d.pointLocation(z),Fe=o.aR.convert(t.center||ye);this._normalizeCenter(Fe),B=d.project(ye),U=d.project(Fe).sub(B)}const Y=d.zoomScale(I-g);let H,K;t.around&&(H=o.aR.convert(t.around),K=d.locationPoint(H));const ne=this._zooming||I!==g,ce=this._rotating||_!==k,ge=this._pitching||N!==b,pe=!d.isPaddingEqual(j),_e=t.retainPadding===!1?d.clone():d,me=ye=>Fe=>{if(ne&&(ye.zoom=o.ak(g,I,Fe)),ce&&(ye.bearing=o.ak(_,k,Fe)),ge&&(ye.pitch=o.ak(b,N,Fe)),pe&&(_e.interpolatePadding(T,j,Fe),z=_e.centerPoint.add(R)),H)ye.setLocationAtPoint(H,K);else{const Pe=ye.zoomScale(ye.zoom-g),Ze=I>g?Math.min(2,Y):Math.max(.5,Y),De=Math.pow(Ze,1-Fe),He=ye.unproject(B.add(U.mult(Fe*De)).mult(Pe));ye.setLocationAtPoint(ye.renderWorldCopies?He.wrap():He,z)}return t.preloadOnly||this._fireMoveEvents(a),ye};if(t.preloadOnly){const ye=this._emulate(me,t.duration,d);return this._preloadTiles(ye),this}const fe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ne,this._rotating=ce,this._pitching=ge,this._padding=pe,this._easeId=t.easeId,this._prepareEase(a,t.noMoveStart,fe),this._ease(me(d),ye=>{d.cameraElevationReference==="sea"&&d.recenterOnTerrain(),this._afterEase(a,ye)},t),this}_prepareEase(t,a,d={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),a||d.moving||this.fire(new o.z("movestart",t)),this._zooming&&!d.zooming&&this.fire(new o.z("zoomstart",t)),this._rotating&&!d.rotating&&this.fire(new o.z("rotatestart",t)),this._pitching&&!d.pitching&&this.fire(new o.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new o.z("move",t)),this._zooming&&this.fire(new o.z("zoom",t)),this._rotating&&this.fire(new o.z("rotate",t)),this._pitching&&this.fire(new o.z("pitch",t))}_afterEase(t,a){if(this._easeId&&a&&this._easeId===a)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const d=this._zooming,g=this._rotating,_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,d&&this.fire(new o.z("zoomend",t)),g&&this.fire(new o.z("rotateend",t)),_&&this.fire(new o.z("pitchend",t)),this.fire(new o.z("moveend",t))}flyTo(t,a){if(this._prefersReducedMotion(t)){const Ue=o.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Ue,a)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:o.eM},t);const d=this.transform,g=this.getZoom(),_=this.getBearing(),b=this.getPitch(),T=this.getPadding(),I="zoom"in t?o.aA(+t.zoom,d.minZoom,d.maxZoom):g,k="bearing"in t?this._normalizeBearing(t.bearing,_):_,N="pitch"in t?+t.pitch:b,j=this._extendPadding(t.padding),R=d.zoomScale(I-g),z=o.P.convert(t.offset);let B=d.centerPoint.add(z);const U=d.pointLocation(B),Y=o.aR.convert(t.center||U);this._normalizeCenter(Y);const H=d.project(U),K=d.project(Y).sub(H);let ne=t.curve;const ce=Math.max(d.width,d.height),ge=ce/R,pe=K.mag();if("minZoom"in t){const Ue=o.aA(Math.min(t.minZoom,g,I),d.minZoom,d.maxZoom),nt=ce/d.zoomScale(Ue-g);ne=Math.sqrt(nt/pe*2)}const _e=ne*ne;function me(Ue){const nt=(ge*ge-ce*ce+(Ue?-1:1)*_e*_e*pe*pe)/(2*(Ue?ge:ce)*_e*pe);return Math.log(Math.sqrt(nt*nt+1)-nt)}function fe(Ue){return(Math.exp(Ue)-Math.exp(-Ue))/2}function ye(Ue){return(Math.exp(Ue)+Math.exp(-Ue))/2}const Fe=me(0);let Pe=function(Ue){return ye(Fe)/ye(Fe+ne*Ue)},Ze=function(Ue){return ce*((ye(Fe)*(fe(nt=Fe+ne*Ue)/ye(nt))-fe(Fe))/_e)/pe;var nt},De=(me(1)-Fe)/ne;if(Math.abs(pe)<1e-6||!isFinite(De)){if(Math.abs(ce-ge)<1e-6)return this.easeTo(t,a);const Ue=ge<ce?-1:1;De=Math.abs(Math.log(ge/ce))/ne,Ze=function(){return 0},Pe=function(nt){return Math.exp(Ue*ne*nt)}}t.duration="duration"in t?+t.duration:1e3*De/("screenSpeed"in t?+t.screenSpeed/ne:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const He=_!==k,_t=N!==b,ze=!d.isPaddingEqual(j),Ie=t.retainPadding===!1?d.clone():d,Ye=Ue=>nt=>{const gt=nt*De,Et=1/Pe(gt);Ue.zoom=nt===1?I:g+Ue.scaleZoom(Et),He&&(Ue.bearing=o.ak(_,k,nt)),_t&&(Ue.pitch=o.ak(b,N,nt)),ze&&(Ie.interpolatePadding(T,j,nt),B=Ie.centerPoint.add(z));const dt=nt===1?Y:Ue.unproject(H.add(K.mult(Ze(gt))).mult(Et));return Ue.setLocationAtPoint(Ue.renderWorldCopies?dt.wrap():dt,B),Ue._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(a),Ue};if(t.preloadOnly){const Ue=this._emulate(Ye,t.duration,d);return this._preloadTiles(Ue),this}return this._zooming=!0,this._rotating=He,this._pitching=_t,this._padding=ze,this._prepareEase(a,!1),this._ease(Ye(d),()=>this._afterEase(a),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,a){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const d=this._onEaseEnd;this._onEaseEnd=void 0,d.call(this,a)}if(!t){const d=this.handlers;d&&d.stop(!1)}return this}_ease(t,a,d){d.animate===!1||d.duration===0?(t(1),a()):(this._easeStart=o.o.now(),this._easeOptions=d,this._onEaseFrame=t,this._onEaseEnd=a,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((o.o.now()-this._easeStart)/this._easeOptions.duration,1),a=this._onEaseFrame;a&&a(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,a){t=o.bT(t,-180,180);const d=Math.abs(t-a);return Math.abs(t-360-a)<d&&(t-=360),Math.abs(t+360-a)<d&&(t+=360),t}_normalizeCenter(t){const a=this.transform;if(a.maxBounds||a.projection.name!=="globe"&&!a.renderWorldCopies)return;const d=t.lng-a.center.lng;t.lng+=d>180?-360:d<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&o.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,a,d){const g=Math.ceil(15*a/1e3),_=[],b=t(d.clone());for(let T=0;T<=g;T++){const I=b(T/g);_.push(I.clone())}return _}_preloadTiles(t,a){}}class Id{constructor(t={}){this.options=t,o.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const a=this.options&&this.options.compact,d=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=ae("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=ae("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",d);const g=ae("span","mapboxgl-ctrl-icon",this._compactButton);return g.setAttribute("aria-hidden","true"),g.setAttribute("title",d),this._innerContainer=ae("div","mapboxgl-ctrl-attrib-inner",this._container),a&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),a===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const a=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.e.ACCESS_TOKEN}];if(t){const d=a.reduce((g,_,b)=>(_.value&&(g+=`${_.key}=${_.value}${b<a.length-1?"&":""}`),g),"?");t.href=`${o.e.FEEDBACK_URL}/${d}#${mf(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||(t.dataType!=="source"||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility")&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}const a=this._map.style._mergedSourceCaches;for(const g in a){const _=a[g];if(_.used){const b=_.getSource();b.attribution&&t.indexOf(b.attribution)<0&&t.push(b.attribution)}}t.sort((g,_)=>g.length-_.length),t=t.filter((g,_)=>{for(let b=_+1;b<t.length;b++)if(t[b].indexOf(g)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const d=t.join(" | ");d!==this._attribHTML&&(this._attribHTML=d,t.length?(this._innerContainer.innerHTML=d,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class na{constructor(){o.aY(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=ae("div","mapboxgl-ctrl");const a=ae("a","mapboxgl-ctrl-logo");return a.target="_blank",a.rel="noopener nofollow",a.href="https://www.mapbox.com/",a.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),a.setAttribute("rel","noopener nofollow"),this._container.appendChild(a),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const a in t){const d=t[a].getSource();if(d.hasOwnProperty("mapbox_logo")&&!d.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const a=t[0];this._map.getCanvasContainer().offsetWidth<250?a.classList.add("mapboxgl-compact"):a.classList.remove("mapboxgl-compact")}}}class Cd{constructor(){o.aY(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=ae("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",a=>this._onIndoorUpdate({selectedFloorId:a.selectedFloorId,floors:a.floors})),this._container}_createButton(t,a){const d=ae("button",t,this._container);return d.type="button",d.addEventListener("click",a),d}_createSeparator(){return ae("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(t,a){this._map&&(t.setAttribute("aria-label",a),t.textContent=a)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return void(this._container.style.display="none");const a=this._model;this._model=t,this._container.style.display="inline-block",this._container.style.borderRadius="8px";const d=t.floors.sort((g,_)=>_.levelOrder-g.levelOrder);a?(Array.from(this._container.children).forEach(g=>g.remove()),this.addCurrentFloors(d)):this.addCurrentFloors(d)}addCurrentFloors(t){for(let a=0;a<t.length;a++){const d=t[a],g=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(d.id),this._model&&(this._model.selectedFloorId=d.id),Array.from(this._container.children).forEach(_=>{_.classList.contains("mapboxgl-ctrl-level-button")&&_.classList.remove("mapboxgl-ctrl-level-button-selected")}),g.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(g,d.shortName),this._model&&d.id===this._model.selectedFloorId&&g.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(g),a<t.length-1&&this._createSeparator()}}}class Qi{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const a=++this._id;return this._queue.push({callback:t,id:a,cancelled:!1}),a}remove(t){const a=this._currentlyRunning,d=a?this._queue.concat(a):this._queue;for(const g of d)if(g.id===t)return void(g.cancelled=!0)}run(t=0){const a=this._currentlyRunning=this._queue;this._queue=[];for(const d of a)if(!d.cancelled&&(d.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class sa{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const a=o.dz((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-a)+this._end*a}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,a,d){this._start=this.getValue(a),this._end=t,this._startTime=a,this._endTime=a+d}}const Ad={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Pd extends o.z{constructor(t,a,d,g){const{point:_,lngLat:b,originalEvent:T,target:I}=t;super(t.type,{point:_,lngLat:b,originalEvent:T,target:I}),this.preventDefault=()=>{t.preventDefault()},this.id=a,this.interaction=d,this.feature=g}}class q0{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,a){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const d=a.filter;let g=a.type;d&&this.filters.set(t,o.b6(d)),g==="mouseover"&&(g="mouseenter"),g==="mouseout"&&(g="mouseleave");const _=this.interactionsByType.get(g)||new Map;g==="mouseenter"||g==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,a)):_.size===0&&this.map.on(g,this.handleType),_.size===0&&this.interactionsByType.set(g,_),_.set(t,a),this.typeById.set(t,g)}get(t){const a=this.typeById.get(t);if(!a)return;const d=this.interactionsByType.get(a);return d?d.get(t):void 0}remove(t){const a=this.typeById.get(t);if(!a)return;this.typeById.delete(t),this.filters.delete(t);const d=this.interactionsByType.get(a);d&&(d.delete(t),a==="mouseenter"||a==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):d.size===0&&this.map.off(a,this.handleType))}queryTargets(t,a){const d=[];for(const[g,_]of a)_.target&&d.push({targetId:g,target:_.target,filter:this.filters.get(g)});return this.map.style.queryRenderedTargets(t,d,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const a=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());a.length&&(t.type="mouseenter",this.handleType(t,a));const d=new Map;for(const[g,{feature:_}]of this.prevHoveredFeatures)this.hoveredFeatures.has(g)||d.set(_.id,_);d.size&&(t.type="mouseleave",this.handleType(t,Array.from(d.values())))}handleOut(t){const a=Array.from(this.hoveredFeatures.values()).map(({feature:d})=>d);a.length&&(t.type="mouseleave",this.handleType(t,a)),this.hoveredFeatures.clear()}handleType(t,a){const d=t.type==="mouseenter";if(d&&!this.interactionsByType.has(t.type))return void o.w("mouseenter interaction required for mouseleave to work.");const g=Array.from(this.interactionsByType.get(t.type)).reverse(),_=!!a;a=a||this.queryTargets(t.point,g);let b=!1;const T=new Set;for(const I of a){for(const[k,N]of g){if(!N.target)continue;const j=I.variants?I.variants[k]:null;if(j){for(const R of j){if(Ya(R,I,T,k))continue;const z=new o.dt(I,R),B=Xu(R,I,k);_&&(z.state=this.map.getFeatureState(z));const U=d?this.prevHoveredFeatures.get(B):null,Y=new Pd(t,k,N,z),H=U?U.stop:N.handler(Y);if(d&&this.hoveredFeatures.set(B,{feature:I,stop:H}),H!==!1){b=!0;break}}if(b)break}}if(b)break}if(!b)for(const[I,k]of g){const{handler:N,target:j}=k;if(!j&&N(new Pd(t,I,k,null))!==!1)break}}}function wb(h,t){if(Array.isArray(h)&&Array.isArray(t)){const a=new Set(h),d=new Set(t);return a.size===d.size&&h.every(g=>d.has(g))}return o.by(h,t)}const kd={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Sb={showCompass:!0,showZoom:!0,visualizePitch:!1};class Tb{constructor(t,a,d=!1){this._clickTolerance=10,this.element=a,this.mouseRotate=new xf({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,d&&(this.mousePitch=new vf({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),o.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener("mousedown",this.mousedown),a.addEventListener("touchstart",this.touchstart,{passive:!1}),a.addEventListener("touchmove",this.touchmove),a.addEventListener("touchend",this.touchend),a.addEventListener("touchcancel",this.reset)}down(t,a){this.mouseRotate.mousedown(t,a),this.mousePitch&&this.mousePitch.mousedown(t,a),Ee()}move(t,a){const d=this.map,g=this.mouseRotate.mousemoveWindow(t,a),_=g&&g.bearingDelta;if(_&&d.setBearing(d.getBearing()+_),this.mousePitch){const b=this.mousePitch.mousemoveWindow(t,a),T=b&&b.pitchDelta;T&&d.setPitch(d.getPitch()+T)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){je(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Object.assign({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),it(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,it(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=We(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=We(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Tf(h,t,a){if(h=new o.aR(h.lng,h.lat),t){const d=new o.aR(h.lng-360,h.lat),g=new o.aR(h.lng+360,h.lat),_=360*Math.ceil(Math.abs(h.lng-a.center.lng)/360),b=a.locationPoint3D(h).distSqr(t),T=t.x<0||t.y<0||t.x>a.width||t.y>a.height;a.locationPoint3D(d).distSqr(t)<b&&(T||Math.abs(d.lng-a.center.lng)<_)?h=d:a.locationPoint3D(g).distSqr(t)<b&&(T||Math.abs(g.lng-a.center.lng)<_)&&(h=g)}for(;Math.abs(h.lng-a.center.lng)>180;){const d=a.locationPoint3D(h);if(d.x>=0&&d.y>=0&&d.x<=a.width&&d.y<=a.height)break;h.lng>a.center.lng?h.lng-=360:h.lng+=360}return h}const Md={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Qs={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class sc extends o.E{constructor(t,a){super(),(t instanceof HTMLElement||a)&&(t=Object.assign({element:t},a)),o.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:d="center",color:g="#3FB1CE",scale:_=1,draggable:b=!1,clickTolerance:T=0,rotation:I=Qs.rotation,rotationAlignment:k=Qs.rotationAlignment,pitchAlignment:N=Qs.pitchAlignment,occludedOpacity:j=Qs.occludedOpacity,altitude:R=Qs.altitude}=t||{};this._anchor=d,this._color=g,this._scale=_,this._draggable=b,this._clickTolerance=T,this._rotation=I,this._rotationAlignment=k,this._pitchAlignment=N,this._occludedOpacity=j,this._altitude=R,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=o.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=o.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",U=>{U.preventDefault()}),this._element.addEventListener("mousedown",U=>{U.preventDefault()});const z=this._element.classList;for(const U in Md)z.remove(`mapboxgl-marker-anchor-${U}`);z.add(`mapboxgl-marker-anchor-${this._anchor}`);const B=t&&t.className?t.className.trim().split(/\s+/):[];z.add(...B),this._popup=null}_createDefaultMarker(){const t=ae("div"),a=ke("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const d=ke("radialGradient",{id:"shadowGradient"},ke("defs",{},a));ke("stop",{offset:"10%","stop-opacity":.4},d),ke("stop",{offset:"100%","stop-opacity":.05},d),ke("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},a)}return ke("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},a),ke("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},a),ke("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},a),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=o.aR.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||Qs.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const g=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const a=t.code,d=t.charCode||t.keyCode;a!=="Space"&&a!=="Enter"&&d!==32&&d!==13||this.togglePopup()}_onMapClick(t){const a=t.originalEvent.target,d=this._element;this._popup&&(a===d||d.contains(a))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,a=this._pos;if(!t||!a)return!1;const d=t.unproject(a,this._altitude),g=t.getFreeCameraOptions();if(!g.position)return!1;const _=g.position.toLngLat();return _.distanceTo(d)<.9*_.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const a=this._pos;if(!a||a.x<0||a.x>t.transform.width||a.y<0||a.y>t.transform.height)return void this._clearFadeTimer();const d=t.unproject(a,this._altitude);let g;t._showingGlobe()&&o.eY(t.transform,this._lngLat)?g=0:(g=1-t._queryFogOpacity(d),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(g*=this._occludedOpacity)),this._element.style.opacity=`${g}`,this._element.style.pointerEvents=g>0?"auto":"none",this._popup&&this._popup._setOpacity(g),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const a=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Md[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${a.x}px,${a.y}px)
        `}_calculateXYTransform(){const t=this._pos,a=this._map,d=this.getPitchAlignment();if(!a||!t||d!=="map")return"";if(!a._showingGlobe()){const I=a.getPitch();return I?`rotateX(${I}deg)`:""}const g=o.cW(o.eZ(a.transform,this._lngLat)),_=t.sub(o.e_(a.transform)),b=Math.abs(_.x)+Math.abs(_.y);if(b===0)return"";const T=g/b;return`rotateX(${-_.y*T}deg) rotateY(${_.x*T}deg)`}_calculateZTransform(){const t=this._pos,a=this._map;if(!a||!t)return"";let d=0;const g=this.getRotationAlignment();if(g==="map")if(a._showingGlobe()){const _=a.project(new o.aR(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),b=a.project(new o.aR(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(_);d=o.cW(Math.atan2(b.y,b.x))-90}else d=-a.getBearing();else if(g==="horizon"){const _=o.ah(4,6,a.getZoom()),b=o.e_(a.transform);b.y+=_*a.transform.height;const T=t.sub(b),I=o.cW(Math.atan2(T.y,T.x));d=(I>90?I-270:I+90)*(1-_)}return d+=this._rotation,d?`rotateZ(${d}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const a=this._map;a&&(a.transform.renderWorldCopies&&(this._lngLat=Tf(this._lngLat,this._pos,a.transform)),this._pos=a.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),a._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(a._showingGlobe()||a.getTerrain()||a.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=o.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const a=this._map;if(!a)return;const d=this._pointerdownPos,g=this._positionDelta;if(d&&g){if(!this._isDragging){const _=this._clickTolerance||a._clickTolerance;if(t.point.dist(d)<_)return;this._isDragging=!0}this._pos=t.point.sub(g),this._lngLat=a.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.z("dragstart"))),this.fire(new o.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new o.z("dragend")),this._state="inactive"}_addDragHandler(t){const a=this._map,d=this._pos;a&&d&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(d),this._pointerdownPos=t.point,this._state="pending",a.on("mousemove",this._onMove),a.on("touchmove",this._onMove),a.once("mouseup",this._onUp),a.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const a=this._map;return a&&(t?(a.on("mousedown",this._addDragHandler),a.on("touchstart",this._addDragHandler)):(a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||Qs.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||Qs.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||Qs.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||Qs.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const ml={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Ia={maxWidth:100,unit:"metric"},Ca={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},oc={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},zo=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function H0(h=new o.P(0,0),t="bottom"){if(typeof h=="number"){const a=Math.round(Math.sqrt(.5*Math.pow(h,2)));switch(t){case"top":return new o.P(0,h);case"top-left":return new o.P(a,a);case"top-right":return new o.P(-a,a);case"bottom":return new o.P(0,-h);case"bottom-left":return new o.P(a,-a);case"bottom-right":return new o.P(-a,-a);case"left":return new o.P(h,0);case"right":return new o.P(-h,0)}return new o.P(0,0)}return h instanceof o.P||Array.isArray(h)?o.P.convert(h):o.P.convert(h[t]||[0,0])}return{version:L,supported:ie.supported,setRTLTextPlugin:o.f2,getRTLTextPluginStatus:o.f1,Map:class extends Xm{constructor(h){Z.mark(F.create);const t=h;if((h=Object.assign({},kd,h)).minZoom!=null&&h.maxZoom!=null&&h.minZoom>h.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(h.minPitch!=null&&h.maxPitch!=null&&h.minPitch>h.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(h.minPitch!=null&&h.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(h.maxPitch!=null&&h.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(h.antialias&&o.eW(window)&&(h.antialias=!1,o.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new ps(h.minZoom,h.maxZoom,h.minPitch,h.maxPitch,h.renderWorldCopies,null,null),h),this._repaint=!!h.repaint,this._interactive=h.interactive,this._minTileCacheSize=h.minTileCacheSize,this._maxTileCacheSize=h.maxTileCacheSize,this._failIfMajorPerformanceCaveat=h.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=h.preserveDrawingBuffer,this._antialias=h.antialias,this._trackResize=h.trackResize,this._bearingSnap=h.bearingSnap,this._refreshExpiredTiles=h.refreshExpiredTiles,this._fadeDuration=h.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=h.crossSourceCollisions,this._collectResourceTiming=h.collectResourceTiming,this._language=this._parseLanguage(h.language),this._worldview=h.worldview,this._renderTaskQueue=new Qi,this._domRenderTaskQueue=new Qi,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.b2(),this._locale=Object.assign({},Ad,h.locale),this._clickTolerance=h.clickTolerance,this._cooperativeGestures=h.cooperativeGestures,this._performanceMetricsCollection=h.performanceMetricsCollection,this._tessellationStep=h.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=h.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new sa(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=h.scaleFactor,this._requestManager=new dr(h.transformRequest,h.accessToken,h.testMode),this._silenceAuthErrors=!!h.testMode,this._contextCreateOptions=h.contextCreateOptions?Object.assign({},h.contextCreateOptions):{},typeof h.container=="string"){const a=document.getElementById(h.container);if(!a)throw new Error(`Container '${h.container.toString()}' not found.`);this._container=a}else{if(!(h.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=h.container}if(this._container.childNodes.length>0&&o.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),h.maxBounds&&this.setMaxBounds(h.maxBounds),this._spriteFormat=h.spriteFormat,o.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Kc),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Ed(this,h),this._localFontFamily=h.localFontFamily,this._localIdeographFontFamily=h.localIdeographFontFamily,(h.style||!h.testMode)&&this.setStyle(h.style||o.e.DEFAULT_STYLE,{config:h.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),h.projection&&this.setProjection(h.projection),this.indoor=new Vl(this),h.hash&&(this._hash=new zm(typeof h.hash=="string"&&h.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:h.center,zoom:h.zoom,bearing:h.bearing,pitch:h.pitch});const a=h.bounds;a&&(this.resize(),this.fitBounds(a,Object.assign({},h.fitBoundsOptions,{duration:0})))}this.resize(),h.attributionControl&&this.addControl(new Id({customAttribution:h.customAttribution})),this._logoControl=new na,this.addControl(this._logoControl,h.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",a=>{this._update(a.dataType==="style"),this.fire(new o.z(`${a.dataType}data`,a))}),this.on("dataloading",a=>{this.fire(new o.z(`${a.dataType}dataloading`,a))}),this._interactions=new q0(this)}_getMapId(){return this._mapId}addControl(h,t){if(t===void 0&&(t=h.getDefaultPosition?h.getDefaultPosition():"top-right"),!h||!h.onAdd)return this.fire(new o.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const a=h.onAdd(this);this._controls.push(h);const d=this._controlPositions[t];return t.indexOf("bottom")!==-1?d.insertBefore(a,d.firstChild):d.appendChild(a),this}removeControl(h){if(!h||!h.onRemove)return this.fire(new o.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(h);return t>-1&&this._controls.splice(t,1),h.onRemove(this),this}hasControl(h){return this._controls.indexOf(h)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(h){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new o.z("movestart",h)).fire(new o.z("move",h)),this.fire(new o.z("resize",h)),t&&this.fire(new o.z("moveend",h)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(h){return this.transform.setMaxBounds(o.aI.convert(h)),this._update()}setMinZoom(h){if((h=h??-2)>=-2&&h<=this.transform.maxZoom)return this.transform.minZoom=h,this._update(),this.getZoom()<h?this.setZoom(h):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(h){if((h=h??22)>=this.transform.minZoom)return this.transform.maxZoom=h,this._update(),this.getZoom()>h?this.setZoom(h):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(h){if((h=h??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(h>=0&&h<=this.transform.maxPitch)return this.transform.minPitch=h,this._update(),this.getPitch()<h?this.setPitch(h):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(h){if((h=h??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(h>=this.transform.minPitch)return this.transform.maxPitch=h,this._update(),this.getPitch()>h?this.setPitch(h):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(h){return this._scaleFactor=h,this.painter.scaleFactor=h,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(h){return this.transform.renderWorldCopies=h,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(h){return h==="auto"?navigator.language:Array.isArray(h)?h.length===0?void 0:h.map(t=>t==="auto"?navigator.language:t):h}setLanguage(h){const t=this._parseLanguage(h);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const a of this._controls)a._setLanguage&&a._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(h){return this.style&&h!==this._worldview?(this._worldview=h,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(h){return this._lazyInitEmptyStyle(),h?typeof h=="string"&&(h={name:h}):h=null,this._useExplicitProjection=!!h,this._prioritizeAndUpdateProjection(h,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const h=this.transform,t=h.projection.name;let a;t==="globe"&&h.zoom>=o.cK?(h.setMercatorFromTransition(),a=!0):t==="mercator"&&h.zoom<o.cK&&(h.setProjection({name:"globe"}),a=!0),a&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(h,t){return this._updateProjection(h||t||{name:"mercator"})}_updateProjection(h){let t;return t=h.name==="globe"&&this.transform.zoom>=o.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(h),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(h,t){return this.transform.locationPoint3D(o.aR.convert(h),t)}unproject(h,t){return this.transform.pointLocation3D(o.P.convert(h),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(h,t,a){const d=g=>{let _=[];if(Array.isArray(t)){const b=t.filter(T=>this.getLayer(T));_=b.length?this.queryRenderedFeatures(g,{layers:b}):[]}else _=this.queryRenderedFeatures(g,{target:t});return _};if(h==="mouseenter"||h==="mouseover"){let g=!1;return{listener:a,targets:t,delegates:{mousemove:b=>{const T=d(b.point);T.length?g||(g=!0,a.call(this,new pn(h,this,b.originalEvent,{features:T}))):g=!1},mouseout:()=>{g=!1}}}}if(h==="mouseleave"||h==="mouseout"){let g=!1;return{listener:a,targets:t,delegates:{mousemove:T=>{d(T.point).length?g=!0:g&&(g=!1,a.call(this,new pn(h,this,T.originalEvent)))},mouseout:T=>{g&&(g=!1,a.call(this,new pn(h,this,T.originalEvent)))}}}}{const g=_=>{const b=d(_.point);b.length&&(_.features=b,a.call(this,_),delete _.features)};return{listener:a,targets:t,delegates:{[h]:g}}}}on(h,t,a){if(typeof t=="function"||a===void 0)return super.on(h,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const d=this._createDelegatedListener(h,t,a);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[h]=this._delegatedListeners[h]||[],this._delegatedListeners[h].push(d);for(const g in d.delegates)this.on(g,d.delegates[g]);return this}once(h,t,a){if(typeof t=="function"||a===void 0)return super.once(h,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const d=this._createDelegatedListener(h,t,a);for(const g in d.delegates)this.once(g,d.delegates[g]);return this}off(h,t,a){if(typeof t=="function"||a===void 0)return super.off(h,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const d=this._delegatedListeners?this._delegatedListeners[h]:void 0;return d&&(g=>{for(let _=0;_<g.length;_++){const b=g[_];if(b.listener===a&&wb(b.targets,t)){for(const T in b.delegates)this.off(T,b.delegates[T]);return g.splice(_,1),this}}})(d),this}queryRenderedFeatures(h,t){if(!this.style)return[];if(h===void 0||h instanceof o.P||Array.isArray(h)||t!==void 0||(t=h,h=void 0),h=h||[[0,0],[this.transform.width,this.transform.height]],!t){const _=this.style.queryRenderedFeatures(h,void 0,this.transform),b=this.style.queryRenderedFeatureset(h,void 0,this.transform);return _.concat(b)}let a=!0;if(t.target&&(a=this._isTargetValid(t.target),a&&!t.layers))return this.style.queryRenderedFeatureset(h,t,this.transform);let d=!0;if(t.layers&&Array.isArray(t.layers)){for(const _ of t.layers)if(!this._isValidId(_)){d=!1;break}if(d&&!t.target)return this.style.queryRenderedFeatures(h,t,this.transform)}let g=[];return d&&(g=g.concat(this.style.queryRenderedFeatures(h,t,this.transform))),a&&(g=g.concat(this.style.queryRenderedFeatureset(h,t,this.transform))),g}querySourceFeatures(h,t){return!h||typeof h=="string"&&!this._isValidId(h)?[]:this.style.querySourceFeatures(h,t)}queryRasterValue(h,t,a){return this._isValidId(h)?this.style.queryRasterValue(h,t,a):Promise.resolve(null)}isPointOnSurface(h){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&o.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(o.P.convert(h))}addInteraction(h,t){return this._interactions.add(h,t),this}removeInteraction(h){return this._interactions.remove(h),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(h){return this._cooperativeGestures=h,this}setStyle(h,t){return t=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&h&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(h,(a,d)=>{if(a){const g=typeof a=="string"?a:a instanceof Error?a.message:a.error;o.w(`Unable to perform style diff: ${g}. Rebuilding the style from scratch.`),this._updateStyle(h,t)}else d&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(h,t))}_getUIString(h){const t=this._locale[h];if(t==null)throw new Error(`Missing UI string '${h}'`);return t}_updateStyle(h,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),h){const a=Object.assign({},t);t&&t.config&&(a.initialConfig=t.config,delete a.config),this.style=new mo(this,a).load(h),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new mo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.w("There is no style added to the map."),!1)}_isValidId(h){return h==null?(this.fire(new o.y(new Error("IDs can't be empty."))),!1):!o.dm(h)||(this.fire(new o.y(new Error(`IDs can't contain special symbols: "${h}".`))),!1)}_isTargetValid(h){return"featuresetId"in h?this._isValidId("importId"in h?h.importId:h.featuresetId):"layerId"in h&&this._isValidId(h.layerId)}_areTargetsValid(h){if(Array.isArray(h)){for(const t of h)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(h)}addSource(h,t){return this._isValidId(h)?(this._lazyInitEmptyStyle(),this.style.addSource(h,t),this._update(!0)):this}isSourceLoaded(h){return!!this._isValidId(h)&&!!this.style&&this.style._isSourceCacheLoaded(h)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(h,t,a){this._lazyInitEmptyStyle(),this.style.addSourceType(h,t,a)}removeSource(h){return this._isValidId(h)?(this.style.removeSource(h),this._updateTerrain(),this._update(!0)):this}getSource(h){return this._isValidId(h)?this.style.getOwnSource(h):null}addImage(h,t,{pixelRatio:a=1,sdf:d=!1,stretchX:g,stretchY:_,content:b}={}){this._lazyInitEmptyStyle();const T=o.I.from(h);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:I,height:k,data:N}=o.o.getImageData(t);this.style.addImage(T,{data:new o.q({width:I,height:k},N),pixelRatio:a,stretchX:g,stretchY:_,content:b,sdf:d,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new o.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:I,height:k}=t,N=t;this.style.addImage(T,{data:new o.q({width:I,height:k},new Uint8Array(N.data)),pixelRatio:a,stretchX:g,stretchY:_,content:b,sdf:d,usvg:!1,version:0,userImage:N}),N.onAdd&&N.onAdd(this,h)}}updateImage(h,t){this._lazyInitEmptyStyle();const a=o.I.from(h),d=this.style.getImage(a);if(!d)return void this.fire(new o.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const g=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?o.o.getImageData(t):t,{width:_,height:b,data:T}=g;if(_===void 0||b===void 0)return void this.fire(new o.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(_!==(d.usvg?d.icon.usvg_tree.width:d.data.width)||b!==(d.usvg?d.icon.usvg_tree.height:d.data.height))return void this.fire(new o.y(new Error(`The width and height of the updated image (${_}, ${b})
                must be that same as the previous version of the image
                (${d.data.width}, ${d.data.height})`)));const I=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let k=!1;d.usvg?(d.data=new o.q({width:_,height:b},new Uint8Array(T)),d.usvg=!1,d.icon=void 0,k=!0):d.data.replace(T,I),this.style.updateImage(a,d,k)}hasImage(h){return h?!!this.style&&!!this.style.getImage(o.I.from(h)):(this.fire(new o.y(new Error("Missing required image id"))),!1)}removeImage(h){this.style.removeImage(o.I.from(h))}loadImage(h,t){o.n(this._requestManager.transformRequest(h,o.R.Image),(a,d)=>{t(a,d instanceof HTMLImageElement?o.o.getImageData(d):d)})}listImages(){return this.style.listImages().map(h=>h.name)}addModel(h,t){this._lazyInitEmptyStyle(),this.style.addModel(h,t)}hasModel(h){return h?this.style.hasModel(h):(this.fire(new o.y(new Error("Missing required model id"))),!1)}removeModel(h){this.style.removeModel(h)}listModels(){return this.style.listModels()}addLayer(h,t){return this._isValidId(h.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(h,t),this._update(!0)):this}getSlot(h){const t=this.getLayer(h);return t&&t.slot||null}setSlot(h,t){return this.style.setSlot(h,t),this.style.mergeLayers(),this._update(!0)}addImport(h,t){return this.style.addImport(h,t).catch(a=>this.fire(new o.y(new Error("Failed to add import",a)))),this}updateImport(h,t){return typeof t!="string"&&t.id!==h?(this.removeImport(h),this.addImport(t)):(this.style.updateImport(h,t),this._update(!0))}removeImport(h){return this.style.removeImport(h),this}moveImport(h,t){return this.style.moveImport(h,t),this._update(!0)}moveLayer(h,t){return this._isValidId(h)?(this.style.moveLayer(h,t),this._update(!0)):this}removeLayer(h){return this._isValidId(h)?(this.style.removeLayer(h),this._update(!0)):this}getLayer(h){if(!this._isValidId(h))return null;const t=this.style.getOwnLayer(h);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(h,t,a){return this._isValidId(h)?(this.style.setLayerZoomRange(h,t,a),this._update(!0)):this}setFilter(h,t,a={}){return this._isValidId(h)?(this.style.setFilter(h,t,a),this._update(!0)):this}getFilter(h){return this._isValidId(h)?this.style.getFilter(h):null}setPaintProperty(h,t,a,d={}){return this._isValidId(h)?(this.style.setPaintProperty(h,t,a,d),this._update(!0)):this}getPaintProperty(h,t){return this._isValidId(h)?this.style.getPaintProperty(h,t):null}setLayoutProperty(h,t,a,d={}){return this._isValidId(h)?(this.style.setLayoutProperty(h,t,a,d),this._update(!0)):this}getLayoutProperty(h,t){return this._isValidId(h)?this.style.getLayoutProperty(h,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(h){return this.style.setGlyphsUrl(h),this._update(!0)}getSchema(h){return this.style.getSchema(h)}setSchema(h,t){return this.style.setSchema(h,t),this._update(!0)}getConfig(h){return this.style.getConfig(h)}setConfig(h,t){return this.style.setConfig(h,t),this._update(!0)}getConfigProperty(h,t){return this.style.getConfigProperty(h,t)}setConfigProperty(h,t,a){return this.style.setConfigProperty(h,t,a),this._update(!0)}getFeaturesetDescriptors(h){return this.style.getFeaturesetDescriptors(h)}setLights(h){if(this._lazyInitEmptyStyle(),h&&h.length===1&&h[0].type==="flat"){const t=h[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(h),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const h=this.style.getLights()||[];return h.length===0&&h.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),h}setLight(h,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:h}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(h){return this._lazyInitEmptyStyle(),!h&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(h),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(h){return this._lazyInitEmptyStyle(),this.style.setFog(h),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(h){return this._lazyInitEmptyStyle(),this.style.setSnow(h),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(h){return this._lazyInitEmptyStyle(),this.style.setRain(h),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(h){return this._lazyInitEmptyStyle(),this.style.setColorTheme(h),this._update(!0)}setImportColorTheme(h,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(h,t),this._update(!0)}setCamera(h){return this.style.setCamera(h),this._triggerCameraUpdate(h)}_triggerCameraUpdate(h){return this._update(this.transform.setOrthographicProjectionAtLowPitch(h["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(h){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.aR.convert(h),this.transform):0}setFeatureState(h,t){return h.source&&!this._isValidId(h.source)?this:(this.style.setFeatureState(h,t),this._update())}removeFeatureState(h,t){return h.source&&!this._isValidId(h.source)?this:(this.style.removeFeatureState(h,t),this._update())}getFeatureState(h){return h.source&&!this._isValidId(h.source)?null:this.style.getFeatureState(h)}_selectIndoorFloor(h){this.indoor.selectFloor(h)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Cd),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const h=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let a,d,g,_=this._container;for(;_&&(!d||!g);){const b=window.getComputedStyle(_).transform;b&&b!=="none"&&(a=b.match(/matrix.*\((.+)\)/)[1].split(", "),a[0]&&a[0]!=="0"&&a[0]!=="1"&&(d=a[0]),a[3]&&a[3]!=="0"&&a[3]!=="1"&&(g=a[3])),_=_.parentElement}this._containerWidth=d?Math.abs(h/d):h,this._containerHeight=g?Math.abs(t/g):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&o.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const h=this._container;h.classList.add("mapboxgl-map"),(this._missingCSSCanary=ae("div","mapboxgl-canary",h)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=ae("div","mapboxgl-canvas-container",h);this._canvas=ae("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const a=this._controlContainer=ae("div","mapboxgl-control-container",h),d=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(g=>{d[g]=ae("div",`mapboxgl-ctrl-${g}`,a)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(h,t){const a=o.o.devicePixelRatio||1;this._canvas.width=a*Math.ceil(h),this._canvas.height=a*Math.ceil(t),this._canvas.style.width=`${h}px`,this._canvas.style.height=`${t}px`}_addMarker(h){this._markers.push(h)}_removeMarker(h){const t=this._markers.indexOf(h);t!==-1&&this._markers.splice(t,1)}_addPopup(h){this._popups.push(h)}_removePopup(h){const t=this._popups.indexOf(h);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const h=Object.assign({},ie.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",h);t?($r(t,!0),this.painter=new jm(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",a=>{a.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),o.k.testSupport(t)):this.fire(new o.y(new Error("Failed to initialize WebGL")))}_contextLost(h){h.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.z("webglcontextlost",{originalEvent:h}))}_contextRestored(h){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new o.z("webglcontextrestored",{originalEvent:h}))}_onMapScroll(h){if(h.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(h){return this.style?(this._styleDirty=this._styleDirty||h,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(h){return this._update(),this._renderTaskQueue.add(h)}_cancelRenderFrame(h){this._renderTaskQueue.remove(h)}_requestDomTask(h){!this.loaded()||this.loaded()&&!this.isMoving()?h():this._domRenderTaskQueue.add(h)}_render(h){let t;this.fire(new o.z("renderstart")),++this._frameId;const a=this.painter.context.extTimerQuery,d=o.o.now(),g=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=g.createQuery(),g.beginQuery(a.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(h),this._domRenderTaskQueue.run(h),this._removed)return;this._updateProjectionTransition();const _=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const k=this.transform.zoom,N=this.transform.pitch,j=o.o.now(),R=new o.ac(k,{now:j,fadeDuration:_,pitch:N,transition:this.style.transition,worldview:this._worldview});this.style.update(R)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let b=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),b=this._updateAverageElevation(d),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):b=this._updateAverageElevation(d);const T=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,_,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),T&&(this._placementDirty=T.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:_,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Z.mark(F.load),this.fire(new o.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const k=o.o.now()-d;g.endQuery(a.TIME_ELAPSED_EXT),setTimeout(()=>{const N=g.getQueryParameter(t,g.QUERY_RESULT)/1e6;g.deleteQuery(t),this.fire(new o.z("gpu-timing-frame",{cpuTime:k,gpuTime:N}))},50)}if(this.listens("gpu-timing-layer")){const k=this.painter.collectGpuTimers();setTimeout(()=>{const N=this.painter.queryGpuTimers(k);this.fire(new o.z("gpu-timing-layer",{layerTimes:N}))},50)}if(this.listens("gpu-timing-deferred-render")){const k=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const N=this.painter.queryGpuTimeDeferredRender(k);this.fire(new o.z("gpu-timing-deferred-render",{gpuTime:N}))},50)}const I=this._sourcesDirty||this._styleDirty||this._placementDirty||b;if(I||this._repaint)this.triggerRepaint();else{const k=this.idle();if(k&&(b=this._updateAverageElevation(d,!0)),b)this.triggerRepaint();else if(this._triggerFrame(!1),k&&(this.fire(new o.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const N=this._calculateSpeedIndex();this.fire(new o.z("speedindexcompleted",{speedIndex:N})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||I||(this._fullyLoaded=!0,Z.mark(F.fullLoad),this._performanceMetricsCollection&&Vi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(h){for(const t of this._markers)h&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!h||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(h,t=!1){const a=g=>(this.transform.averageElevation=g,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&a(0);const d=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(d||(t||h-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(h)){const g=this.transform.averageElevation;let _=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(_)?_=0:this._averageElevationLastSampledAt=h;const b=Math.abs(g-_);if(b>1){if(this._isInitialLoad||d)return this._averageElevation.jumpTo(_),a(_);this._averageElevation.easeTo(_,h,300)}else if(b>1e-4)return this._averageElevation.jumpTo(_),a(_)}return!!this._averageElevation.isEasing(h)&&a(this._averageElevation.getValue(h))}_authenticate(){or(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,h=>{if(h&&(h.message===fr||h.status===401)){const t=this.painter.context.gl;$r(t,!1),this._logoControl instanceof na&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),us(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Yr(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const h=this._isDragging();this.painter.updateTerrain(this.style,h)}_calculateSpeedIndex(){const h=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const a=this.painter.context.gl,d=a.createFramebuffer();function g(_){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,_,0);const b=new Uint8Array(a.drawingBufferWidth*a.drawingBufferHeight*4);return a.readPixels(0,0,a.drawingBufferWidth,a.drawingBufferHeight,a.RGBA,a.UNSIGNED_BYTE,b),b}return a.bindFramebuffer(a.FRAMEBUFFER,d),this._canvasPixelComparison(g(h),t.canvasCopies.map(g),t.timeStamps)}_canvasPixelComparison(h,t,a){let d=a[1]-a[0];const g=h.length/4;for(let _=0;_<t.length;_++){const b=t[_];let T=0;for(let I=0;I<b.length;I+=4)b[I]===h[I]&&b[I+1]===h[I+1]&&b[I+2]===h[I+2]&&b[I+3]===h[I+3]&&(T+=1);d+=(a[_+2]-a[_+1])*(1-T/g)}return d}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const h=this.painter.context.gl.getExtension("WEBGL_lose_context");h&&h.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),pr.delete(this.painter.context.gl),Vn.remove(),Un.remove(),this._removed=!0,this.fire(new o.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(h){this._renderNextFrame=this._renderNextFrame||h,this.style&&!this._frame&&(this._frame=o.o.frame(t=>{const a=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,a&&this._render(t)}))}_preloadTiles(h){const t=this.style?this.style.getSourceCaches():[];return o.bw(t,(a,d)=>a._preloadTiles(h,d),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(h){this._trackResize&&this.resize({originalEvent:h})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(h){this._showTileBoundaries!==h&&(this._showTileBoundaries=h,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(h){this._showParseStatus!==h&&(this._showParseStatus=h,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(h){this._showTerrainWireframe!==h&&(this._showTerrainWireframe=h,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(h){this._showLayers2DWireframe!==h&&(this._showLayers2DWireframe=h,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(h){this._showLayers3DWireframe!==h&&(this._showLayers3DWireframe=h,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(h){this._speedIndexTiming!==h&&(this._speedIndexTiming=h,this._update())}get showPadding(){return!!this._showPadding}set showPadding(h){this._showPadding!==h&&(this._showPadding=h,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(h){this._showCollisionBoxes!==h&&(this._showCollisionBoxes=h,this._tp.refreshUI(),h?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(h){this._showOverdrawInspector!==h&&(this._showOverdrawInspector=h,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(h){this._repaint!==h&&(this._repaint=h,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(h){this._vertices=h,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(h){this._showTileAABBs!==h&&(this._showTileAABBs=h,this._tp.refreshUI(),h&&this._update())}_setCacheLimits(h,t){o.eX(h,t)}get version(){return L}},NavigationControl:class{constructor(h={}){this.options=Object.assign({},Sb,h),this._container=ae("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(o.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),ae("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),ae("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const a=this._map;a&&(this.options.visualizePitch?a.resetNorthPitch({},{originalEvent:t}):a.resetNorth({},{originalEvent:t}))}),this._compassIcon=ae("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const h=this._map;if(!h)return;const t=h.getZoom(),a=t===h.getMaxZoom(),d=t===h.getMinZoom();this._zoomInButton.disabled=a,this._zoomOutButton.disabled=d,this._zoomInButton.setAttribute("aria-disabled",a.toString()),this._zoomOutButton.setAttribute("aria-disabled",d.toString())}_rotateCompassArrow(){const h=this._map;if(!h)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(h.transform.pitch*(Math.PI/180)),.5)}) rotateX(${h.transform.pitch}deg) rotateZ(${h.transform.angle*(180/Math.PI)}deg)`:`rotate(${h.transform.angle*(180/Math.PI)}deg)`;h._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(h){return this._map=h,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),h.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&h.on("pitch",this._rotateCompassArrow),h.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Tb(h,this._compass,this.options.visualizePitch)),this._container}onRemove(){const h=this._map;h&&(this._container.remove(),this.options.showZoom&&h.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&h.off("pitch",this._rotateCompassArrow),h.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(h,t){const a=ae("button",h,this._container);return a.type="button",a.addEventListener("click",t),a}_setButtonTitle(h,t){if(!this._map)return;const a=this._map._getUIString(`NavigationControl.${t}`);h.setAttribute("aria-label",a),h.firstElementChild&&h.firstElementChild.setAttribute("title",a)}},GeolocateControl:class extends o.E{constructor(h={}){super();const t=navigator.geolocation;this.options=Object.assign({geolocation:t},ml,h),o.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=pf(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(h){return this._map=h,this._container=ae("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(h){const t=(a=!!this.options.geolocation)=>{this._supportsGeolocation=a,h(a)};this._supportsGeolocation!==void 0?h(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(a=>t(a.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(h){const t=this._map.getMaxBounds(),a=h.coords;return!!t&&(a.longitude<t.getWest()||a.longitude>t.getEast()||a.latitude<t.getSouth()||a.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(h){if(this._map){if(this._isOutOfMapMaxBounds(h))return this._setErrorState(),this.fire(new o.z("outofmaxbounds",h)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=h,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(h),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(h),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("geolocate",h)),this._finish()}}_updateCamera(h){const t=new o.aR(h.coords.longitude,h.coords.latitude),a=h.coords.accuracy,d=this._map.getBearing(),g=Object.assign({bearing:d},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(a),g,{geolocateSource:!0})}_updateMarker(h){if(h){const t=new o.aR(h.coords.longitude,h.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=h.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const h=this._map.transform,t=o.ce(1,h._center.lat)*h.worldSize,a=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${a}px`,this._circleElement.style.height=`${a}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(h){if(this._map){if(this.options.trackUserLocation)if(h.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(h.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("error",h)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(h){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=ae("button","mapboxgl-ctrl-geolocate",this._container),ae("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",h===!1){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=ae("div","mapboxgl-user-location"),this._dotElement.appendChild(ae("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(ae("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new sc({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=ae("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new sc({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.z("trackuserlocationend")))})}}_onDeviceOrientation(h){this._userLocationDotMarker&&(h.webkitCompassHeading?this._heading=h.webkitCompassHeading:h.absolute===!0&&(this._heading=-1*h.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let h;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(h={maximumAge:6e5,timeout:0},this._noTimeout=!0):(h=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,h),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const h=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&h()}).catch(console.error):h()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Id,ScaleControl:class{constructor(h={}){this.options=Object.assign({},Ia,h),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),o.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const h=this.options.maxWidth||100,t=this._map,a=t._containerHeight/2,d=t._containerWidth/2-h/2,g=t.unproject([d,a]),_=t.unproject([d+h,a]),b=g.distanceTo(_);if(this.options.unit==="imperial"){const T=3.2808*b;T>5280?this._setScale(h,T/5280,"mile"):this._setScale(h,T,"foot")}else this.options.unit==="nautical"?this._setScale(h,b/1852,"nautical-mile"):b>=1e3?this._setScale(h,b/1e3,"kilometer"):this._setScale(h,b,"meter")}_setScale(h,t,a){this._map._requestDomTask(()=>{const d=function(_){const b=Math.pow(10,`${Math.floor(_)}`.length-1);let T=_/b;return T=T>=10?10:T>=5?5:T>=3?3:T>=2?2:T>=1?1:function(I){const k=Math.pow(10,Math.ceil(-Math.log(I)/Math.LN10));return Math.round(I*k)/k}(T),b*T}(t),g=d/t;this._container.innerHTML=this._isNumberFormatSupported&&a!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:a}).format(d):`${d}&nbsp;${Ca[a]}`,this._container.style.width=h*g+"px"})}onAdd(h){return this._map=h,this._language=h.getLanguage(),this._container=ae("div","mapboxgl-ctrl mapboxgl-ctrl-scale",h.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(h){this._language=h,this._update()}setUnit(h){this.options.unit=h,this._update()}},FullscreenControl:class{constructor(h={}){this._fullscreen=!1,h&&h.container&&(h.container instanceof HTMLElement?this._container=h.container:o.w("Full screen control 'container' must be a DOM element.")),o.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(h){return this._map=h,this._container||(this._container=this._map.getContainer()),this._controlContainer=ae("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const h=this._fullscreenButton=ae("button","mapboxgl-ctrl-fullscreen",this._controlContainer);ae("span","mapboxgl-ctrl-icon",h).setAttribute("aria-hidden","true"),h.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const h=this._getTitle();this._fullscreenButton.setAttribute("aria-label",h),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",h)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Cd,Popup:class extends o.E{constructor(h){super(),this.options=Object.assign(Object.create(oc),h),this._altitude=this.options.altitude,o.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(h&&h.className?h.className.trim().split(/\s+/):[])}addTo(h){return this._map&&this.remove(),this._map=h,this.options.closeOnClick&&h.on("preclick",this._onClose),this.options.closeOnMove&&h.on("move",this._onClose),h.on("remove",this.remove),this._update(),h._addPopup(this),this._focusFirstElement(),this._trackPointer?(h.on("mousemove",this._onMouseEvent),h.on("mouseup",this._onMouseEvent),h._canvasContainer.classList.add("mapboxgl-track-pointer")):h.on("move",this._update),this.fire(new o.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const h=this._map;return h&&(h.off("move",this._update),h.off("move",this._onClose),h.off("preclick",this._onClose),h.off("click",this._onClose),h.off("remove",this.remove),h.off("mousemove",this._onMouseEvent),h.off("mouseup",this._onMouseEvent),h.off("drag",this._onMouseEvent),h._canvasContainer&&h._canvasContainer.classList.remove("mapboxgl-track-pointer"),h._removePopup(this),this._map=void 0),this.fire(new o.z("close")),this}getLngLat(){return this._lngLat}setLngLat(h){this._lngLat=o.aR.convert(h),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(h){return this._altitude=h,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const h=this._map;return h&&(h.off("move",this._update),h.on("mousemove",this._onMouseEvent),h.on("drag",this._onMouseEvent),h._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(h){return this.setDOMContent(document.createTextNode(h))}setHTML(h){const t=document.createDocumentFragment(),a=document.createElement("body");let d;for(a.innerHTML=h;d=a.firstChild,d;)t.appendChild(d);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(h){return this.options.maxWidth=h,this._update(),this}setDOMContent(h){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=ae("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(h),this.options.closeButton){const a=this._closeButton=ae("button","mapboxgl-popup-close-button",t);a.type="button",a.setAttribute("aria-label","Close popup"),a.innerHTML='<span aria-hidden="true">&#215;</span>',a.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(h){return this._classList.add(h),this._updateClassList(),this}removeClassName(h){return this._classList.delete(h),this._updateClassList(),this}setOffset(h){return this.options.offset=h,this._update(),this}toggleClassName(h){let t;return this._classList.delete(h)?t=!1:(this._classList.add(h),t=!0),this._updateClassList(),t}_onMouseEvent(h){this._update(h.point)}_getAnchor(h){if(this.options.anchor)return this.options.anchor;const t=this._map,a=this._container,d=this._pos;if(!t||!a||!d)return"bottom";const g=a.offsetWidth,_=a.offsetHeight,b=d.x<g/2,T=d.x>t.transform.width-g/2;if(d.y+h<_)return b?"top-left":T?"top-right":"top";if(d.y>t.transform.height-_){if(b)return"bottom-left";if(T)return"bottom-right"}return b?"left":T?"right":"bottom"}_updateClassList(){const h=this._container;if(!h)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),h.className=t.join(" ")}_update(h){const t=this._map,a=this._content;if(!t||!this._lngLat&&!this._trackPointer||!a)return;let d=this._container;if(d||(d=this._container=ae("div","mapboxgl-popup",t.getContainer()),this._tip=ae("div","mapboxgl-popup-tip",d),d.appendChild(a)),this.options.maxWidth&&d.style.maxWidth!==this.options.maxWidth&&(d.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Tf(this._lngLat,this._pos,t.transform)),!this._trackPointer||h){const g=this._pos=this._trackPointer&&h instanceof o.P?h:t.project(this._lngLat,this._altitude),_=H0(this.options.offset),b=this._anchor=this._getAnchor(_.y),T=H0(this.options.offset,b),I=g.add(T).round();t._requestDomTask(()=>{this._container&&b&&(this._container.style.transform=`${Md[b]} translate(${I.x}px,${I.y}px)`)})}if(!this._marker&&t._showingGlobe()){const g=o.eY(t.transform,this._lngLat)?0:1;this._setOpacity(g)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const h=this._container.querySelector(zo);h&&h.focus()}_onClose(){this.remove()}_setOpacity(h){this._container&&(this._container.style.opacity=`${h}`),this._content&&(this._content.style.pointerEvents=h?"auto":"none")}},Marker:sc,Style:mo,LngLat:o.aR,LngLatBounds:o.aI,Point:o.P,MercatorCoordinate:o.ae,FreeCameraOptions:Jp,Evented:o.E,config:o.e,prewarm:o.f0,clearPrewarmedResources:o.e$,get accessToken(){return o.e.ACCESS_TOKEN},set accessToken(h){o.e.ACCESS_TOKEN=h},get baseApiUrl(){return o.e.API_URL},set baseApiUrl(h){o.e.API_URL=h},get workerCount(){return o.f9.workerCount},set workerCount(h){o.f9.workerCount=h},get maxParallelImageRequests(){return o.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(h){o.e.MAX_PARALLEL_IMAGE_REQUESTS=h},clearStorage(h){o.f8(h)},get workerUrl(){return o.f7.workerUrl},set workerUrl(h){o.f7.workerUrl=h},get workerClass(){return o.f7.workerClass},set workerClass(h){o.f7.workerClass=h},get workerParams(){return o.f7.workerParams},set workerParams(h){o.f7.workerParams=h},get dracoUrl(){return o.f6()},set dracoUrl(h){o.f5(h)},get meshoptUrl(){return o.f4()},set meshoptUrl(h){o.f3(h)},setNow:o.o.setNow,restoreNow:o.o.restoreNow}});var C=v;return C})})(yN);var $z=yN.exports;const yp=U2($z),Gz="pk.eyJ1IjoiZGlhenBvbGFuY28xMyIsImEiOiJjbWd0bXV1MzkwNjc2Mm1weG5iZGtxajZvIn0.6v22Z0fCiQbs5QDiiwLS6g",oo={DARK:"mapbox://styles/mapbox/dark-v11",SATELLITE_STREETS:"mapbox://styles/mapbox/satellite-streets-v12",NAVIGATION_NIGHT:"mapbox://styles/mapbox/navigation-night-v1",LIGHT:"mapbox://styles/mapbox/light-v11",STREETS:"mapbox://styles/mapbox/streets-v12",OUTDOORS:"mapbox://styles/mapbox/outdoors-v12",SATELLITE:"mapbox://styles/mapbox/satellite-v9",NAVIGATION_DAY:"mapbox://styles/mapbox/navigation-day-v1"};function qz(){const r=localStorage.getItem("selectedMapStyle")||"satellite-streets";return{dark:oo.DARK,"satellite-streets":oo.SATELLITE_STREETS,"navigation-night":oo.NAVIGATION_NIGHT,light:oo.LIGHT,streets:oo.STREETS,outdoors:oo.OUTDOORS,satellite:oo.SATELLITE,"navigation-day":oo.NAVIGATION_DAY}[r]||oo.SATELLITE_STREETS}const nx={center:[parseFloat("-66.1057")||-66.1057,parseFloat("14.2095")||14.2095],zoom:parseInt("5.5")||5.5,style:qz(),options:{minZoom:2,maxZoom:18,pitch:45,bearing:0,antialias:!0}};/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hz=r=>r.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),Wz=r=>r.replace(/^([A-Z])|[\s-_]+(\w)/g,(s,c,m)=>m?m.toUpperCase():c.toLowerCase()),nP=r=>{const s=Wz(r);return s.charAt(0).toUpperCase()+s.slice(1)},vN=(...r)=>r.filter((s,c,m)=>!!s&&s.trim()!==""&&m.indexOf(s)===c).join(" ").trim(),Zz=r=>{for(const s in r)if(s.startsWith("aria-")||s==="role"||s==="title")return!0};/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var Xz={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yz=Ne.forwardRef(({color:r="currentColor",size:s=24,strokeWidth:c=2,absoluteStrokeWidth:m,className:v="",children:S,iconNode:C,...o},L)=>Ne.createElement("svg",{ref:L,...Xz,width:s,height:s,stroke:r,strokeWidth:m?Number(c)*24/Number(s):c,className:vN("lucide",v),...!S&&!Zz(o)&&{"aria-hidden":"true"},...o},[...C.map(([F,Z])=>Ne.createElement(F,Z)),...Array.isArray(S)?S:[S]]));/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Er=(r,s)=>{const c=Ne.forwardRef(({className:m,...v},S)=>Ne.createElement(Yz,{ref:S,iconNode:s,className:vN(`lucide-${Hz(nP(r))}`,`lucide-${r}`,m),...v}));return c.displayName=nP(r),c};/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kz=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],Kx=Er("activity",Kz);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jz=[["path",{d:"M12 22V8",key:"qkxhtm"}],["path",{d:"M5 12H2a10 10 0 0 0 20 0h-3",key:"1hv3nh"}],["circle",{cx:"12",cy:"5",r:"3",key:"rqqgnr"}]],j_=Er("anchor",Jz);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qz=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h2",key:"tvwodi"}],["path",{d:"M20 8v11a2 2 0 0 1-2 2h-2",key:"1gkqxj"}],["path",{d:"m9 15 3-3 3 3",key:"1pd0qc"}],["path",{d:"M12 12v9",key:"192myk"}]],eF=Er("archive-restore",Qz);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tF=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],E_=Er("archive",tF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rF=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],y2=Er("calendar",rF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const iF=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],I_=Er("check",iF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nF=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],Ap=Er("chevron-down",nF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sF=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],sP=Er("chevron-right",sF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oF=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],aF=Er("chevron-up",oF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lF=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],z_=Er("circle-alert",lF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cF=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],DS=Er("circle-check-big",cF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uF=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],bN=Er("circle-x",uF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dF=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],hF=Er("circle",dF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fF=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],wN=Er("clock",fF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pF=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],mF=Er("copy",pF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gF=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"22",x2:"18",y1:"12",y2:"12",key:"l9bcsi"}],["line",{x1:"6",x2:"2",y1:"12",y2:"12",key:"13hhkx"}],["line",{x1:"12",x2:"12",y1:"6",y2:"2",key:"10w3f3"}],["line",{x1:"12",x2:"12",y1:"22",y2:"18",key:"15g9kq"}]],_F=Er("crosshair",gF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yF=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],xF=Er("external-link",yF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vF=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],F_=Er("eye-off",vF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bF=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],kl=Er("eye",bF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wF=[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]],SF=Er("folder-open",wF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const TF=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],x2=Er("funnel",TF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const EF=[["path",{d:"m12 14 4-4",key:"9kzdfg"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0",key:"19p75a"}]],jS=Er("gauge",EF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const IF=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],C_=Er("image",IF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const CF=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],SN=Er("info",CF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const AF=[["path",{d:"m5 8 6 6",key:"1wu5hv"}],["path",{d:"m4 14 6-6 2-3",key:"1k1g8d"}],["path",{d:"M2 5h12",key:"or177f"}],["path",{d:"M7 2h1",key:"1t2jsx"}],["path",{d:"m22 22-5-10-5 10",key:"don7ne"}],["path",{d:"M14 18h6",key:"1m8k6r"}]],PF=Er("languages",AF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kF=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],TN=Er("layers",kF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const MF=[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]],oP=Er("link",MF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const NF=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Wd=Er("loader-circle",NF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const RF=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],LF=Er("lock-open",RF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const OF=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],EN=Er("lock",OF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const DF=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],ju=Er("map-pin",DF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jF=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],IN=Er("map",jF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zF=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],FF=Er("maximize-2",zF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const BF=[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]],UF=Er("minimize-2",BF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const VF=[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]],$F=Er("monitor",VF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const GF=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],qF=Er("moon",GF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const HF=[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]],WF=Er("mountain",HF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ZF=[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]],zS=Er("navigation",ZF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const XF=[["path",{d:"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z",key:"e79jfc"}],["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}]],YF=Er("palette",XF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const KF=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],FS=Er("pen",KF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const JF=[["path",{d:"M10.83 2.38a2 2 0 0 1 2.34 0l8 5.74a2 2 0 0 1 .73 2.25l-3.04 9.26a2 2 0 0 1-1.9 1.37H7.04a2 2 0 0 1-1.9-1.37L2.1 10.37a2 2 0 0 1 .73-2.25z",key:"2hea0t"}]],QF=Er("pentagon",JF);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const e4=[["path",{d:"M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z",key:"1v9wt8"}]],Wa=Er("plane",e4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const t4=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],r4=Er("play",t4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const i4=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],lh=Er("plus",i4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const n4=[["path",{d:"M19.07 4.93A10 10 0 0 0 6.99 3.34",key:"z3du51"}],["path",{d:"M4 6h.01",key:"oypzma"}],["path",{d:"M2.29 9.62A10 10 0 1 0 21.31 8.35",key:"qzzz0"}],["path",{d:"M16.24 7.76A6 6 0 1 0 8.23 16.67",key:"1yjesh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M17.99 11.66A6 6 0 0 1 15.77 16.67",key:"1u2y91"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"m13.41 10.59 5.66-5.66",key:"mhq4k0"}]],Jx=Er("radar",n4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const s4=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],f1=Er("refresh-cw",s4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const o4=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],aP=Er("rotate-ccw",o4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const a4=[["path",{d:"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z",key:"icamh8"}],["path",{d:"m14.5 12.5 2-2",key:"inckbg"}],["path",{d:"m11.5 9.5 2-2",key:"fmmyf7"}],["path",{d:"m8.5 6.5 2-2",key:"vc6u1g"}],["path",{d:"m17.5 15.5 2-2",key:"wo5hmg"}]],v2=Er("ruler",a4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const l4=[["path",{d:"m13.5 6.5-3.148-3.148a1.205 1.205 0 0 0-1.704 0L6.352 5.648a1.205 1.205 0 0 0 0 1.704L9.5 10.5",key:"dzhfyz"}],["path",{d:"M16.5 7.5 19 5",key:"1ltcjm"}],["path",{d:"m17.5 10.5 3.148 3.148a1.205 1.205 0 0 1 0 1.704l-2.296 2.296a1.205 1.205 0 0 1-1.704 0L13.5 14.5",key:"nfoymv"}],["path",{d:"M9 21a6 6 0 0 0-6-6",key:"1iajcf"}],["path",{d:"M9.352 10.648a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l4.296-4.296a1.205 1.205 0 0 0 0-1.704l-2.296-2.296a1.205 1.205 0 0 0-1.704 0z",key:"nv9zqy"}]],lP=Er("satellite",l4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const c4=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],CN=Er("save",c4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const u4=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],Pp=Er("search",u4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const d4=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],h4=Er("send",d4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const f4=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],B_=Er("settings",f4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const p4=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],Zo=Er("shield",p4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const m4=[["path",{d:"M12 10.189V14",key:"1p8cqu"}],["path",{d:"M12 2v3",key:"qbqxhf"}],["path",{d:"M19 13V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6",key:"qpkstq"}],["path",{d:"M19.38 20A11.6 11.6 0 0 0 21 14l-8.188-3.639a2 2 0 0 0-1.624 0L3 14a11.6 11.6 0 0 0 2.81 7.76",key:"7tigtc"}],["path",{d:"M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1s1.2 1 2.5 1c2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"1924j5"}]],Ai=Er("ship",m4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const g4=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}],["path",{d:"M20 2v4",key:"1rf3ol"}],["path",{d:"M22 4h-4",key:"gwowj6"}],["circle",{cx:"4",cy:"20",r:"2",key:"6kqj1y"}]],_4=Er("sparkles",g4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const y4=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],AN=Er("star",y4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const x4=[["polyline",{points:"14.5 17.5 3 6 3 3 6 3 17.5 14.5",key:"1hfsw2"}],["line",{x1:"13",x2:"19",y1:"19",y2:"13",key:"1vrmhu"}],["line",{x1:"16",x2:"20",y1:"16",y2:"20",key:"1bron3"}],["line",{x1:"19",x2:"21",y1:"21",y2:"19",key:"13pww6"}],["polyline",{points:"14.5 6.5 18 3 21 3 21 6 17.5 9.5",key:"hbey2j"}],["line",{x1:"5",x2:"9",y1:"14",y2:"18",key:"1hf58s"}],["line",{x1:"7",x2:"4",y1:"17",y2:"20",key:"pidxm4"}],["line",{x1:"3",x2:"5",y1:"19",y2:"21",key:"1pehsh"}]],BS=Er("swords",x4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const v4=[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]],b4=Er("tag",v4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const w4=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]],b2=Er("target",w4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S4=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Sc=Er("trash-2",S4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T4=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],PN=Er("trending-up",T4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E4=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],Qx=Er("triangle-alert",E4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I4=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],ev=Er("upload",I4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C4=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],A4=Er("user",C4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P4=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],vs=Er("users",P4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k4=[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]],kN=Er("waves",k4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M4=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],En=Er("x",M4);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N4=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],MN=Er("zap",N4),NN=Ne.createContext();function R4({children:r}){const[s,c]=Ne.useState(new Set),[m,v]=Ne.useState(!1);Ne.useEffect(()=>{const ie=le=>{(le.ctrlKey||le.metaKey)&&v(!0)},ae=le=>{!le.ctrlKey&&!le.metaKey&&v(!1)},ke=()=>{v(!1)};return window.addEventListener("keydown",ie),window.addEventListener("keyup",ae),window.addEventListener("blur",ke),()=>{window.removeEventListener("keydown",ie),window.removeEventListener("keyup",ae),window.removeEventListener("blur",ke)}},[]);const S=Ne.useCallback(ie=>{c(new Set([ie]))},[]),C=Ne.useCallback(ie=>{c(ae=>{const ke=new Set(ae);return ke.has(ie)?ke.delete(ie):ke.add(ie),ke})},[]),o=Ne.useCallback(ie=>{c(ae=>{const ke=new Set(ae);return ke.delete(ie),ke})},[]),L=Ne.useCallback(()=>{c(new Set)},[]),F=Ne.useCallback(ie=>{c(new Set(ie))},[]),Z=Ne.useCallback(ie=>s.has(ie),[s]),$=Ne.useCallback(()=>Array.from(s),[s]),W=Ne.useCallback(()=>s.size,[s]),ee={selectedIds:s,isCtrlPressed:m,setIsCtrlPressed:v,selectEntity:S,addToSelection:C,deselectEntity:o,clearSelection:L,selectMultiple:F,isSelected:Z,getSelectedIds:$,getSelectedCount:W};return x.jsx(NN.Provider,{value:ee,children:r})}function Ev(){const r=Ne.useContext(NN);if(!r)throw new Error("useSelection debe usarse dentro de SelectionProvider");return r}const RN=Ne.createContext();function L4({children:r}){const[s,c]=Ne.useState(!0),m=()=>{c(C=>!C)},v=()=>{c(!0)},S=()=>{c(!1)};return x.jsx(RN.Provider,{value:{isLocked:s,toggleLock:m,lock:v,unlock:S},children:r})}function US(){const r=Ne.useContext(RN);if(!r)throw new Error("useLock debe usarse dentro de LockProvider");return r}function O4(r){switch(r){case"destructor":return Ai;case"fragata":return j_;case"avion":return Wa;case"tropas":return vs;default:return Ai}}function cP(r){switch(r){case"destructor":return"#ef4444";case"fragata":return"#3b82f6";case"avion":return"#6b7280";case"tropas":return"#22c55e";default:return"#10b981"}}function D4(r){const s=parseInt(localStorage.getItem("iconSize")||"48");switch(r){case"destructor":return s*1.33;case"fragata":return s*1.17;case"avion":return s;case"tropas":return s*1.17;default:return s}}function uP(r){return r.type==="tropas",r.name}function dP(r){return{destructor:"Destructor",fragata:"Fragata",avion:"Aeronave",tropas:"Tropas",tanque:"Tanque",submarino:"Submarino"}[r.type]||r.type}function sx(r){return r.class||""}function j4({entity:r,template:s,map:c,onPositionChange:m,onEntityClick:v}){const S=Ne.useRef(null),C=Ne.useRef(null),o=Ne.useRef(!1),[L,F]=Ne.useState(()=>parseInt(localStorage.getItem("iconSize")||"48")),[Z,$]=Ne.useState(()=>localStorage.getItem("useImages")==="true"),[W,ee]=Ne.useState(()=>localStorage.getItem("showLabelName")!=="false"),[ie,ae]=Ne.useState(()=>localStorage.getItem("showLabelType")!=="false"),[ke,le]=Ne.useState(()=>localStorage.getItem("showLabelClass")==="true"),{isCtrlPressed:se,isSelected:J,selectEntity:Ee,addToSelection:je}=Ev(),{isLocked:Xe}=US();Ne.useEffect(()=>{const it=We=>{We.detail.iconSize!==void 0&&F(We.detail.iconSize),We.detail.useImages!==void 0&&$(We.detail.useImages),We.detail.showLabelName!==void 0&&ee(We.detail.showLabelName),We.detail.showLabelType!==void 0&&ae(We.detail.showLabelType),We.detail.showLabelClass!==void 0&&le(We.detail.showLabelClass)};return window.addEventListener("settingsChanged",it),()=>window.removeEventListener("settingsChanged",it)},[]);const tt=J(r.id);return Ne.useEffect(()=>{if(!c||!r)return;const it=document.createElement("div");it.className="entity-marker-container",it.style.cursor="grab",it.style.display="flex",it.style.flexDirection="column",it.style.alignItems="center",it.style.gap="4px";const We=cP(r.type),Ct=D4(r.type),Nt=r.image_thumbnail_url||(s==null?void 0:s.icon_url)||(s==null?void 0:s.image_url);if(Z&&Nt)T_(it).render(x.jsxs("div",{className:"flex flex-col items-center gap-1",children:[x.jsx("div",{className:"entity-marker-icon flex items-center justify-center bg-military-bg-secondary/90 backdrop-blur-sm rounded-full border-2 shadow-lg transition-all hover:scale-110 overflow-hidden",style:{borderColor:We,width:`${Ct}px`,height:`${Ct}px`},children:x.jsx("img",{src:Nt,alt:r.name,className:"w-full h-full object-cover",onError:cr=>{cr.target.style.display="none"}})}),x.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[W&&x.jsx("div",{className:"px-2 py-0.5 bg-slate-900/95 backdrop-blur-sm text-white text-xs font-semibold rounded shadow-lg border whitespace-nowrap",style:{borderColor:We,borderWidth:"1px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:uP(r)}),ie&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-800/90 backdrop-blur-sm text-slate-300 rounded shadow-md whitespace-nowrap",style:{fontSize:"10px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:dP(r)}),ke&&sx(r)&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-700/80 backdrop-blur-sm text-slate-400 rounded shadow-sm whitespace-nowrap",style:{fontSize:"9px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:sx(r)})]})]}));else{const dr=O4(r.type);T_(it).render(x.jsxs("div",{className:"flex flex-col items-center gap-1",children:[x.jsxs("div",{style:{position:"relative"},children:[x.jsx("div",{className:"entity-marker-icon flex items-center justify-center bg-military-bg-secondary/90 backdrop-blur-sm rounded-full border-2 shadow-lg transition-all hover:scale-110",style:{borderColor:We,width:`${Ct}px`,height:`${Ct}px`},children:x.jsx(dr,{size:Ct*.6,color:We,strokeWidth:2.5})}),r.type==="tropas"&&r.crew_count&&x.jsx("div",{className:"absolute top-0 -right-2 translate-x-full bg-green-600 text-white rounded-full px-2 py-1 text-xs font-bold border-2 border-slate-900 shadow-lg whitespace-nowrap",children:r.crew_count>=1e3?`${(r.crew_count/1e3).toFixed(1)}k`:r.crew_count})]}),x.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[W&&x.jsx("div",{className:"px-2 py-0.5 bg-slate-900/95 backdrop-blur-sm text-white text-xs font-semibold rounded shadow-lg border whitespace-nowrap",style:{borderColor:We,borderWidth:"1px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:uP(r)}),ie&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-800/90 backdrop-blur-sm text-slate-300 rounded shadow-md whitespace-nowrap",style:{fontSize:"10px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:dP(r)}),ke&&sx(r)&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-700/80 backdrop-blur-sm text-slate-400 rounded shadow-sm whitespace-nowrap",style:{fontSize:"9px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:sx(r)})]})]}))}it.addEventListener("click",dr=>{if(o.current)return;dr.ctrlKey||dr.metaKey?(je(r.id),dr.stopPropagation()):(Ee(r.id),v&&v())});const fr=new yp.Marker({element:it,anchor:"center",draggable:!Xe}).setLngLat([r.longitude,r.latitude]).addTo(c);return fr.on("dragstart",()=>{o.current=!0,it.style.cursor="grabbing"}),fr.on("dragend",async()=>{const dr=fr.getLngLat();if(m)try{await m(r.id,{latitude:dr.lat,longitude:dr.lng})}catch(cr){console.error("❌ Error al guardar posición:",cr),fr.setLngLat([r.longitude,r.latitude])}setTimeout(()=>{it.style.cursor="grab",o.current=!1},100)}),S.current=fr,C.current=it,()=>{S.current&&S.current.remove()}},[c,L,Z,s,W,ie,ke]),Ne.useEffect(()=>{if(!S.current||!r||o.current)return;if(!r.latitude||!r.longitude||isNaN(r.latitude)||isNaN(r.longitude)){console.warn(`⚠️ Coordenadas inválidas para ${r.name}, ignorando actualización`);return}const it=S.current,We=it.getLngLat();(Math.abs(We.lat-r.latitude)>1e-4||Math.abs(We.lng-r.longitude)>1e-4)&&it.setLngLat([r.longitude,r.latitude])},[r.latitude,r.longitude,r.name]),Ne.useEffect(()=>{if(!S.current)return;const it=S.current,We=C.current;it.setDraggable(!Xe),We&&(We.style.cursor=Xe?"not-allowed":"grab")},[Xe]),Ne.useEffect(()=>{if(!C.current)return;const We=C.current.querySelector(".entity-marker-icon");if(tt)We&&(We.style.borderColor="#fbbf24",We.style.borderWidth="4px",We.style.boxShadow="0 0 20px rgba(251, 191, 36, 0.6), 0 0 40px rgba(251, 191, 36, 0.3)",We.style.transform="scale(1.15)");else if(We){const Ct=cP(r.type);We.style.borderColor=Ct,We.style.borderWidth="2px",We.style.boxShadow="",We.style.transform="scale(1)"}},[tt,r.type]),null}function z4({group:r,map:s,onGroupClick:c,onGroupMove:m}){const v=Ne.useRef(null),S=Ne.useRef(!1),[C,o]=Ne.useState(()=>parseInt(localStorage.getItem("iconSize")||"48")),[L,F]=Ne.useState(()=>localStorage.getItem("showLabelName")!=="false"),[Z,$]=Ne.useState(()=>localStorage.getItem("showLabelType")!=="false");return Ne.useEffect(()=>{const W=ee=>{ee.detail.iconSize!==void 0&&o(ee.detail.iconSize),ee.detail.showLabelName!==void 0&&F(ee.detail.showLabelName),ee.detail.showLabelType!==void 0&&$(ee.detail.showLabelType)};return window.addEventListener("settingsChanged",W),()=>window.removeEventListener("settingsChanged",W)},[]),Ne.useEffect(()=>{var Xe;if(!s||!r||!r.members||r.members.length===0)return;const W=r.members.reduce((tt,it)=>tt+parseFloat(it.entity.latitude),0)/r.members.length,ee=r.members.reduce((tt,it)=>tt+parseFloat(it.entity.longitude),0)/r.members.length,ie=(Xe=r.members[0])==null?void 0:Xe.entity,ae=(ie==null?void 0:ie.type)==="avion"?Wa:Ai,ke=r.icon_color||"#3b82f6",le=C*1.5,se=le*.35,J=document.createElement("div");J.className="group-marker-container",J.style.cursor="grab",T_(J).render(x.jsxs("div",{className:"flex flex-col items-center gap-1",children:[x.jsxs("div",{className:"group-marker-icon flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-sm rounded-lg border-4 shadow-xl transition-all hover:scale-110",style:{borderColor:ke,width:`${le}px`,height:`${le}px`,position:"relative"},children:[x.jsx(ae,{size:le*.5,color:ke,strokeWidth:2.5}),x.jsx("div",{className:"absolute -bottom-1 -right-1 bg-blue-600 text-white rounded-full flex items-center justify-center border-2 border-white font-bold shadow-lg",style:{width:`${se}px`,height:`${se}px`,fontSize:`${se*.45}px`},children:r.count})]}),x.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[L&&x.jsx("div",{className:"px-3 py-1 bg-slate-900/95 backdrop-blur-sm text-white text-xs font-semibold rounded shadow-lg border-2",style:{borderColor:ke,maxWidth:"200px",textAlign:"center"},children:r.name}),Z&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-800/90 backdrop-blur-sm text-slate-300 rounded shadow-md whitespace-nowrap",style:{fontSize:"10px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis"},children:r.group_type||"Grupo"})]})]})),J.addEventListener("click",()=>{!S.current&&c&&c(r)});const je=new yp.Marker({element:J,anchor:"center",draggable:!0}).setLngLat([ee,W]).addTo(s);return je.on("dragstart",()=>{S.current=!0,J.style.cursor="grabbing"}),je.on("dragend",async()=>{const tt=je.getLngLat(),it=tt.lat-W,We=tt.lng-ee;m&&await m(r,it,We),setTimeout(()=>{J.style.cursor="grab",S.current=!1},100)}),v.current=je,()=>{v.current&&v.current.remove()}},[s,r,c,m,C,L,Z]),null}function F4(r=[],s=!0){const[c,m]=Ne.useState(null),[v,S]=Ne.useState(!1),[C,o]=Ne.useState(null),L=Ne.useRef("");Ne.useEffect(()=>{try{Object.keys(localStorage).forEach(Z=>{Z.startsWith("maritime_boundaries_")&&(localStorage.removeItem(Z),console.log("🧹 Removed old cache:",Z))})}catch(Z){console.warn("Error cleaning cache:",Z)}},[]);const F="https://geo.vliz.be/geoserver/MarineRegions/ows";return Ne.useEffect(()=>{if(!s||r.length===0){m(null);return}const Z=[...r].sort().join("_");if(L.current===Z)return;L.current=Z,$();async function $(){var W,ee;S(!0),o(null);try{const ie=r.map(se=>`iso_sov1='${se}'`).join(" OR "),ae=new URLSearchParams({service:"WFS",version:"2.0.0",request:"GetFeature",typeName:"MarineRegions:eez",outputFormat:"application/json",srsName:"EPSG:4326",cql_filter:ie}),ke=await fetch(`${F}?${ae}`);if(!ke.ok)throw new Error(`HTTP error! status: ${ke.status}`);const le=await ke.json();console.log("🌊 Maritime boundaries loaded:",{requestedCountries:r,featuresCount:((W=le.features)==null?void 0:W.length)||0,loadedCountries:(ee=le.features)==null?void 0:ee.map(se=>({name:se.properties.geoname||se.properties.territory,iso3:se.properties.iso_sov1,iso2:se.properties.iso_ter1}))}),m(le)}catch(ie){console.error("❌ Error fetching maritime boundaries:",ie),o(ie.message)}finally{S(!1)}}},[r,s]),{boundaries:c,loading:v,error:C}}const uc={VENEZUELA:"VEN",CUBA:"CUB",COLOMBIA:"COL",JAMAICA:"JAM",HAITI:"HTI",DOMINICAN_REPUBLIC:"DOM",PUERTO_RICO:"USA",TRINIDAD_TOBAGO:"TTO",GUYANA:"GUY"},p1={VEN:"#ef4444",CUB:"#f97316",COL:"#fbbf24",JAM:"#84cc16",HTI:"#22c55e",DOM:"#14b8a6",PRI:"#06b6d4",TTO:"#0ea5e9",GUY:"#10b981",SUR:"#14b8a6",BHS:"#3b82f6",ABW:"#6366f1",CUW:"#8b5cf6",PAN:"#a855f7",CRI:"#d946ef",NIC:"#ec4899",HND:"#f43f5e",BLZ:"#10b981",GTM:"#059669",MEX:"#dc2626",USA:"#06b6d4"};function B4({map:r,boundaries:s,visible:c=!0,colorMap:m=p1}){const v=Ne.useRef({source:"maritime-boundaries",fillLayer:"maritime-boundaries-fill",lineLayer:"maritime-boundaries-line"}),S=()=>{const C=m||p1,o=[];return Object.entries(C).forEach(([L,F])=>{o.push(L,F)}),{fill:{"fill-color":["match",["get","iso_sov1"],...o,"#64748b"],"fill-opacity":.2},line:{"line-color":["match",["get","iso_sov1"],...o,"#64748b"],"line-width":2,"line-opacity":.7}}};return Ne.useEffect(()=>{const C=()=>{if(!r)return;const{fillLayer:o,lineLayer:L}=v.current,F=S();r.getLayer(o)&&r.setPaintProperty(o,"fill-color",F.fill["fill-color"]),r.getLayer(L)&&r.setPaintProperty(L,"line-color",F.line["line-color"]),console.log("🎨 Maritime colors updated")};return window.addEventListener("maritimeColorsChanged",C),()=>window.removeEventListener("maritimeColorsChanged",C)},[r]),Ne.useEffect(()=>{var W;if(console.log("🌊 MaritimeBoundariesLayer effect:",{hasMap:!!r,hasBoundaries:!!s,featuresCount:(W=s==null?void 0:s.features)==null?void 0:W.length,visible:c}),!r||!s||!s.features||s.features.length===0){console.log("⚠️ No boundaries to display, removing layers"),$();return}const{source:C,fillLayer:o,lineLayer:L}=v.current,F=()=>{console.log("🗺️ Style loaded, re-adding maritime layers"),Z()};if(!r.isStyleLoaded()){r.once("load",Z);return}return Z(),r.on("style.load",F),()=>{r.off("style.load",F)};function Z(){console.log("🗺️ Adding maritime boundaries layer...",{sourceId:C,featuresCount:s.features.length}),r.getLayer(o)&&r.removeLayer(o),r.getLayer(L)&&r.removeLayer(L),r.getSource(C)&&r.removeSource(C),r.addSource(C,{type:"geojson",data:s}),console.log("✅ Source added:",C);const ee=S();r.addLayer({id:o,type:"fill",source:C,layout:{visibility:c?"visible":"none"},paint:ee.fill}),r.addLayer({id:L,type:"line",source:C,layout:{visibility:c?"visible":"none"},paint:ee.line}),console.log("✅ Layers added:",{fillLayer:o,lineLayer:L,visible:c}),r.on("mouseenter",o,ie=>{if(r.getCanvas().style.cursor="pointer",ie.features&&ie.features.length>0){const ke=ie.features[0].properties,le=p1[ke.iso_sov1]||"#64748b";console.log("🖱️ Hover on maritime boundary:",{country:ke.geoname||ke.territory,iso3:ke.iso_sov1,color:le,area:ke.area_km2})}}),r.on("mouseleave",o,()=>{r.getCanvas().style.cursor=""})}function $(){const{source:ee,fillLayer:ie,lineLayer:ae}=v.current;r&&r.getLayer(ie)&&r.removeLayer(ie),r&&r.getLayer(ae)&&r.removeLayer(ae),r&&r.getSource(ee)&&r.removeSource(ee)}},[r,s,m]),Ne.useEffect(()=>{if(!r)return;const{fillLayer:C,lineLayer:o}=v.current;r.getLayer(C)&&r.setLayoutProperty(C,"visibility",c?"visible":"none"),r.getLayer(o)&&r.setLayoutProperty(o,"visibility",c?"visible":"none")},[r,c]),null}const U4="modulepreload",V4=function(r){return"/"+r},hP={},U_=function(s,c,m){let v=Promise.resolve();if(c&&c.length>0){document.getElementsByTagName("link");const C=document.querySelector("meta[property=csp-nonce]"),o=(C==null?void 0:C.nonce)||(C==null?void 0:C.getAttribute("nonce"));v=Promise.allSettled(c.map(L=>{if(L=V4(L),L in hP)return;hP[L]=!0;const F=L.endsWith(".css"),Z=F?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${L}"]${Z}`))return;const $=document.createElement("link");if($.rel=F?"stylesheet":U4,F||($.as="script"),$.crossOrigin="",$.href=L,o&&$.setAttribute("nonce",o),document.head.appendChild($),F)return new Promise((W,ee)=>{$.addEventListener("load",W),$.addEventListener("error",()=>ee(new Error(`Unable to preload CSS for ${L}`)))})}))}function S(C){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=C,window.dispatchEvent(o),!o.defaultPrevented)throw C}return v.then(C=>{for(const o of C||[])o.status==="rejected"&&S(o.reason);return s().catch(S)})},$4=r=>{let s;return r?s=r:typeof fetch>"u"?s=(...c)=>U_(async()=>{const{default:m}=await Promise.resolve().then(()=>jp);return{default:m}},void 0).then(({default:m})=>m(...c)):s=fetch,(...c)=>s(...c)};class VS extends Error{constructor(s,c="FunctionsError",m){super(s),this.name=c,this.context=m}}class fP extends VS{constructor(s){super("Failed to send a request to the Edge Function","FunctionsFetchError",s)}}class pP extends VS{constructor(s){super("Relay Error invoking the Edge Function","FunctionsRelayError",s)}}class mP extends VS{constructor(s){super("Edge Function returned a non-2xx status code","FunctionsHttpError",s)}}var w2;(function(r){r.Any="any",r.ApNortheast1="ap-northeast-1",r.ApNortheast2="ap-northeast-2",r.ApSouth1="ap-south-1",r.ApSoutheast1="ap-southeast-1",r.ApSoutheast2="ap-southeast-2",r.CaCentral1="ca-central-1",r.EuCentral1="eu-central-1",r.EuWest1="eu-west-1",r.EuWest2="eu-west-2",r.EuWest3="eu-west-3",r.SaEast1="sa-east-1",r.UsEast1="us-east-1",r.UsWest1="us-west-1",r.UsWest2="us-west-2"})(w2||(w2={}));var G4=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};class q4{constructor(s,{headers:c={},customFetch:m,region:v=w2.Any}={}){this.url=s,this.headers=c,this.region=v,this.fetch=$4(m)}setAuth(s){this.headers.Authorization=`Bearer ${s}`}invoke(s){return G4(this,arguments,void 0,function*(c,m={}){var v;try{const{headers:S,method:C,body:o,signal:L}=m;let F={},{region:Z}=m;Z||(Z=this.region);const $=new URL(`${this.url}/${c}`);Z&&Z!=="any"&&(F["x-region"]=Z,$.searchParams.set("forceFunctionRegion",Z));let W;o&&(S&&!Object.prototype.hasOwnProperty.call(S,"Content-Type")||!S)&&(typeof Blob<"u"&&o instanceof Blob||o instanceof ArrayBuffer?(F["Content-Type"]="application/octet-stream",W=o):typeof o=="string"?(F["Content-Type"]="text/plain",W=o):typeof FormData<"u"&&o instanceof FormData?W=o:(F["Content-Type"]="application/json",W=JSON.stringify(o)));const ee=yield this.fetch($.toString(),{method:C||"POST",headers:Object.assign(Object.assign(Object.assign({},F),this.headers),S),body:W,signal:L}).catch(le=>{throw le.name==="AbortError"?le:new fP(le)}),ie=ee.headers.get("x-relay-error");if(ie&&ie==="true")throw new pP(ee);if(!ee.ok)throw new mP(ee);let ae=((v=ee.headers.get("Content-Type"))!==null&&v!==void 0?v:"text/plain").split(";")[0].trim(),ke;return ae==="application/json"?ke=yield ee.json():ae==="application/octet-stream"?ke=yield ee.blob():ae==="text/event-stream"?ke=ee:ae==="multipart/form-data"?ke=yield ee.formData():ke=yield ee.text(),{data:ke,error:null,response:ee}}catch(S){return S instanceof Error&&S.name==="AbortError"?{data:null,error:new fP(S)}:{data:null,error:S,response:S instanceof mP||S instanceof pP?S.context:void 0}}})}}var wo={},$S={},Iv={},V_={},Cv={},Av={},H4=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},kp=H4();const W4=kp.fetch,LN=kp.fetch.bind(kp),ON=kp.Headers,Z4=kp.Request,X4=kp.Response,jp=Object.freeze(Object.defineProperty({__proto__:null,Headers:ON,Request:Z4,Response:X4,default:LN,fetch:W4},Symbol.toStringTag,{value:"Module"})),Y4=gD(jp);var Pv={};Object.defineProperty(Pv,"__esModule",{value:!0});let K4=class extends Error{constructor(s){super(s.message),this.name="PostgrestError",this.details=s.details,this.hint=s.hint,this.code=s.code}};Pv.default=K4;var DN=Ho&&Ho.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Av,"__esModule",{value:!0});const J4=DN(Y4),Q4=DN(Pv);let e5=class{constructor(s){var c,m;this.shouldThrowOnError=!1,this.method=s.method,this.url=s.url,this.headers=new Headers(s.headers),this.schema=s.schema,this.body=s.body,this.shouldThrowOnError=(c=s.shouldThrowOnError)!==null&&c!==void 0?c:!1,this.signal=s.signal,this.isMaybeSingle=(m=s.isMaybeSingle)!==null&&m!==void 0?m:!1,s.fetch?this.fetch=s.fetch:typeof fetch>"u"?this.fetch=J4.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(s,c){return this.headers=new Headers(this.headers),this.headers.set(s,c),this}then(s,c){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const m=this.fetch;let v=m(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async S=>{var C,o,L,F;let Z=null,$=null,W=null,ee=S.status,ie=S.statusText;if(S.ok){if(this.method!=="HEAD"){const se=await S.text();se===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((C=this.headers.get("Accept"))===null||C===void 0)&&C.includes("application/vnd.pgrst.plan+text"))?$=se:$=JSON.parse(se))}const ke=(o=this.headers.get("Prefer"))===null||o===void 0?void 0:o.match(/count=(exact|planned|estimated)/),le=(L=S.headers.get("content-range"))===null||L===void 0?void 0:L.split("/");ke&&le&&le.length>1&&(W=parseInt(le[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray($)&&($.length>1?(Z={code:"PGRST116",details:`Results contain ${$.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},$=null,W=null,ee=406,ie="Not Acceptable"):$.length===1?$=$[0]:$=null)}else{const ke=await S.text();try{Z=JSON.parse(ke),Array.isArray(Z)&&S.status===404&&($=[],Z=null,ee=200,ie="OK")}catch{S.status===404&&ke===""?(ee=204,ie="No Content"):Z={message:ke}}if(Z&&this.isMaybeSingle&&(!((F=Z==null?void 0:Z.details)===null||F===void 0)&&F.includes("0 rows"))&&(Z=null,ee=200,ie="OK"),Z&&this.shouldThrowOnError)throw new Q4.default(Z)}return{error:Z,data:$,count:W,status:ee,statusText:ie}});return this.shouldThrowOnError||(v=v.catch(S=>{var C,o,L;return{error:{message:`${(C=S==null?void 0:S.name)!==null&&C!==void 0?C:"FetchError"}: ${S==null?void 0:S.message}`,details:`${(o=S==null?void 0:S.stack)!==null&&o!==void 0?o:""}`,hint:"",code:`${(L=S==null?void 0:S.code)!==null&&L!==void 0?L:""}`},data:null,count:null,status:0,statusText:""}})),v.then(s,c)}returns(){return this}overrideTypes(){return this}};Av.default=e5;var t5=Ho&&Ho.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Cv,"__esModule",{value:!0});const r5=t5(Av);let i5=class extends r5.default{select(s){let c=!1;const m=(s??"*").split("").map(v=>/\s/.test(v)&&!c?"":(v==='"'&&(c=!c),v)).join("");return this.url.searchParams.set("select",m),this.headers.append("Prefer","return=representation"),this}order(s,{ascending:c=!0,nullsFirst:m,foreignTable:v,referencedTable:S=v}={}){const C=S?`${S}.order`:"order",o=this.url.searchParams.get(C);return this.url.searchParams.set(C,`${o?`${o},`:""}${s}.${c?"asc":"desc"}${m===void 0?"":m?".nullsfirst":".nullslast"}`),this}limit(s,{foreignTable:c,referencedTable:m=c}={}){const v=typeof m>"u"?"limit":`${m}.limit`;return this.url.searchParams.set(v,`${s}`),this}range(s,c,{foreignTable:m,referencedTable:v=m}={}){const S=typeof v>"u"?"offset":`${v}.offset`,C=typeof v>"u"?"limit":`${v}.limit`;return this.url.searchParams.set(S,`${s}`),this.url.searchParams.set(C,`${c-s+1}`),this}abortSignal(s){return this.signal=s,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:s=!1,verbose:c=!1,settings:m=!1,buffers:v=!1,wal:S=!1,format:C="text"}={}){var o;const L=[s?"analyze":null,c?"verbose":null,m?"settings":null,v?"buffers":null,S?"wal":null].filter(Boolean).join("|"),F=(o=this.headers.get("Accept"))!==null&&o!==void 0?o:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${C}; for="${F}"; options=${L};`),C==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(s){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${s}`),this}};Cv.default=i5;var n5=Ho&&Ho.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(V_,"__esModule",{value:!0});const s5=n5(Cv);let o5=class extends s5.default{eq(s,c){return this.url.searchParams.append(s,`eq.${c}`),this}neq(s,c){return this.url.searchParams.append(s,`neq.${c}`),this}gt(s,c){return this.url.searchParams.append(s,`gt.${c}`),this}gte(s,c){return this.url.searchParams.append(s,`gte.${c}`),this}lt(s,c){return this.url.searchParams.append(s,`lt.${c}`),this}lte(s,c){return this.url.searchParams.append(s,`lte.${c}`),this}like(s,c){return this.url.searchParams.append(s,`like.${c}`),this}likeAllOf(s,c){return this.url.searchParams.append(s,`like(all).{${c.join(",")}}`),this}likeAnyOf(s,c){return this.url.searchParams.append(s,`like(any).{${c.join(",")}}`),this}ilike(s,c){return this.url.searchParams.append(s,`ilike.${c}`),this}ilikeAllOf(s,c){return this.url.searchParams.append(s,`ilike(all).{${c.join(",")}}`),this}ilikeAnyOf(s,c){return this.url.searchParams.append(s,`ilike(any).{${c.join(",")}}`),this}is(s,c){return this.url.searchParams.append(s,`is.${c}`),this}in(s,c){const m=Array.from(new Set(c)).map(v=>typeof v=="string"&&new RegExp("[,()]").test(v)?`"${v}"`:`${v}`).join(",");return this.url.searchParams.append(s,`in.(${m})`),this}contains(s,c){return typeof c=="string"?this.url.searchParams.append(s,`cs.${c}`):Array.isArray(c)?this.url.searchParams.append(s,`cs.{${c.join(",")}}`):this.url.searchParams.append(s,`cs.${JSON.stringify(c)}`),this}containedBy(s,c){return typeof c=="string"?this.url.searchParams.append(s,`cd.${c}`):Array.isArray(c)?this.url.searchParams.append(s,`cd.{${c.join(",")}}`):this.url.searchParams.append(s,`cd.${JSON.stringify(c)}`),this}rangeGt(s,c){return this.url.searchParams.append(s,`sr.${c}`),this}rangeGte(s,c){return this.url.searchParams.append(s,`nxl.${c}`),this}rangeLt(s,c){return this.url.searchParams.append(s,`sl.${c}`),this}rangeLte(s,c){return this.url.searchParams.append(s,`nxr.${c}`),this}rangeAdjacent(s,c){return this.url.searchParams.append(s,`adj.${c}`),this}overlaps(s,c){return typeof c=="string"?this.url.searchParams.append(s,`ov.${c}`):this.url.searchParams.append(s,`ov.{${c.join(",")}}`),this}textSearch(s,c,{config:m,type:v}={}){let S="";v==="plain"?S="pl":v==="phrase"?S="ph":v==="websearch"&&(S="w");const C=m===void 0?"":`(${m})`;return this.url.searchParams.append(s,`${S}fts${C}.${c}`),this}match(s){return Object.entries(s).forEach(([c,m])=>{this.url.searchParams.append(c,`eq.${m}`)}),this}not(s,c,m){return this.url.searchParams.append(s,`not.${c}.${m}`),this}or(s,{foreignTable:c,referencedTable:m=c}={}){const v=m?`${m}.or`:"or";return this.url.searchParams.append(v,`(${s})`),this}filter(s,c,m){return this.url.searchParams.append(s,`${c}.${m}`),this}};V_.default=o5;var a5=Ho&&Ho.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Iv,"__esModule",{value:!0});const Vg=a5(V_);let l5=class{constructor(s,{headers:c={},schema:m,fetch:v}){this.url=s,this.headers=new Headers(c),this.schema=m,this.fetch=v}select(s,c){const{head:m=!1,count:v}=c??{},S=m?"HEAD":"GET";let C=!1;const o=(s??"*").split("").map(L=>/\s/.test(L)&&!C?"":(L==='"'&&(C=!C),L)).join("");return this.url.searchParams.set("select",o),v&&this.headers.append("Prefer",`count=${v}`),new Vg.default({method:S,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(s,{count:c,defaultToNull:m=!0}={}){var v;const S="POST";if(c&&this.headers.append("Prefer",`count=${c}`),m||this.headers.append("Prefer","missing=default"),Array.isArray(s)){const C=s.reduce((o,L)=>o.concat(Object.keys(L)),[]);if(C.length>0){const o=[...new Set(C)].map(L=>`"${L}"`);this.url.searchParams.set("columns",o.join(","))}}return new Vg.default({method:S,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(v=this.fetch)!==null&&v!==void 0?v:fetch})}upsert(s,{onConflict:c,ignoreDuplicates:m=!1,count:v,defaultToNull:S=!0}={}){var C;const o="POST";if(this.headers.append("Prefer",`resolution=${m?"ignore":"merge"}-duplicates`),c!==void 0&&this.url.searchParams.set("on_conflict",c),v&&this.headers.append("Prefer",`count=${v}`),S||this.headers.append("Prefer","missing=default"),Array.isArray(s)){const L=s.reduce((F,Z)=>F.concat(Object.keys(Z)),[]);if(L.length>0){const F=[...new Set(L)].map(Z=>`"${Z}"`);this.url.searchParams.set("columns",F.join(","))}}return new Vg.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(C=this.fetch)!==null&&C!==void 0?C:fetch})}update(s,{count:c}={}){var m;const v="PATCH";return c&&this.headers.append("Prefer",`count=${c}`),new Vg.default({method:v,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(m=this.fetch)!==null&&m!==void 0?m:fetch})}delete({count:s}={}){var c;const m="DELETE";return s&&this.headers.append("Prefer",`count=${s}`),new Vg.default({method:m,url:this.url,headers:this.headers,schema:this.schema,fetch:(c=this.fetch)!==null&&c!==void 0?c:fetch})}};Iv.default=l5;var jN=Ho&&Ho.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty($S,"__esModule",{value:!0});const c5=jN(Iv),u5=jN(V_);let d5=class zN{constructor(s,{headers:c={},schema:m,fetch:v}={}){this.url=s,this.headers=new Headers(c),this.schemaName=m,this.fetch=v}from(s){const c=new URL(`${this.url}/${s}`);return new c5.default(c,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(s){return new zN(this.url,{headers:this.headers,schema:s,fetch:this.fetch})}rpc(s,c={},{head:m=!1,get:v=!1,count:S}={}){var C;let o;const L=new URL(`${this.url}/rpc/${s}`);let F;m||v?(o=m?"HEAD":"GET",Object.entries(c).filter(([$,W])=>W!==void 0).map(([$,W])=>[$,Array.isArray(W)?`{${W.join(",")}}`:`${W}`]).forEach(([$,W])=>{L.searchParams.append($,W)})):(o="POST",F=c);const Z=new Headers(this.headers);return S&&Z.set("Prefer",`count=${S}`),new u5.default({method:o,url:L,headers:Z,schema:this.schemaName,body:F,fetch:(C=this.fetch)!==null&&C!==void 0?C:fetch})}};$S.default=d5;var zp=Ho&&Ho.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(wo,"__esModule",{value:!0});wo.PostgrestError=wo.PostgrestBuilder=wo.PostgrestTransformBuilder=wo.PostgrestFilterBuilder=wo.PostgrestQueryBuilder=wo.PostgrestClient=void 0;const FN=zp($S);wo.PostgrestClient=FN.default;const BN=zp(Iv);wo.PostgrestQueryBuilder=BN.default;const UN=zp(V_);wo.PostgrestFilterBuilder=UN.default;const VN=zp(Cv);wo.PostgrestTransformBuilder=VN.default;const $N=zp(Av);wo.PostgrestBuilder=$N.default;const GN=zp(Pv);wo.PostgrestError=GN.default;var h5=wo.default={PostgrestClient:FN.default,PostgrestQueryBuilder:BN.default,PostgrestFilterBuilder:UN.default,PostgrestTransformBuilder:VN.default,PostgrestBuilder:$N.default,PostgrestError:GN.default};const{PostgrestClient:f5,PostgrestQueryBuilder:w$,PostgrestFilterBuilder:S$,PostgrestTransformBuilder:T$,PostgrestBuilder:E$,PostgrestError:I$}=h5;class p5{static detectEnvironment(){var s;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((s=navigator.userAgent)===null||s===void 0)&&s.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){const c=process.versions;if(c&&c.node){const m=c.node,v=parseInt(m.replace(/^v/,"").split(".")[0]);return v>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${v} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${v} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const s=this.detectEnvironment();if(s.constructor)return s.constructor;let c=s.error||"WebSocket not supported in this environment.";throw s.workaround&&(c+=`

Suggested solution: ${s.workaround}`),new Error(c)}static createWebSocket(s,c){const m=this.getWebSocketConstructor();return new m(s,c)}static isWebSocketSupported(){try{const s=this.detectEnvironment();return s.type==="native"||s.type==="ws"}catch{return!1}}}const m5="2.75.0",g5=`realtime-js/${m5}`,_5="1.0.0",S2=1e4,y5=1e3,x5=100;var n_;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(n_||(n_={}));var as;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(as||(as={}));var Fa;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(Fa||(Fa={}));var T2;(function(r){r.websocket="websocket"})(T2||(T2={}));var Zd;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(Zd||(Zd={}));class v5{constructor(){this.HEADER_LENGTH=1}decode(s,c){return s.constructor===ArrayBuffer?c(this._binaryDecode(s)):c(typeof s=="string"?JSON.parse(s):{})}_binaryDecode(s){const c=new DataView(s),m=new TextDecoder;return this._decodeBroadcast(s,c,m)}_decodeBroadcast(s,c,m){const v=c.getUint8(1),S=c.getUint8(2);let C=this.HEADER_LENGTH+2;const o=m.decode(s.slice(C,C+v));C=C+v;const L=m.decode(s.slice(C,C+S));C=C+S;const F=JSON.parse(m.decode(s.slice(C,s.byteLength)));return{ref:null,topic:o,event:L,payload:F}}}class qN{constructor(s,c){this.callback=s,this.timerCalc=c,this.timer=void 0,this.tries=0,this.callback=s,this.timerCalc=c}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var yn;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(yn||(yn={}));const gP=(r,s,c={})=>{var m;const v=(m=c.skipTypes)!==null&&m!==void 0?m:[];return s?Object.keys(s).reduce((S,C)=>(S[C]=b5(C,r,s,v),S),{}):{}},b5=(r,s,c,m)=>{const v=s.find(o=>o.name===r),S=v==null?void 0:v.type,C=c[r];return S&&!m.includes(S)?HN(S,C):E2(C)},HN=(r,s)=>{if(r.charAt(0)==="_"){const c=r.slice(1,r.length);return E5(s,c)}switch(r){case yn.bool:return w5(s);case yn.float4:case yn.float8:case yn.int2:case yn.int4:case yn.int8:case yn.numeric:case yn.oid:return S5(s);case yn.json:case yn.jsonb:return T5(s);case yn.timestamp:return I5(s);case yn.abstime:case yn.date:case yn.daterange:case yn.int4range:case yn.int8range:case yn.money:case yn.reltime:case yn.text:case yn.time:case yn.timestamptz:case yn.timetz:case yn.tsrange:case yn.tstzrange:return E2(s);default:return E2(s)}},E2=r=>r,w5=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},S5=r=>{if(typeof r=="string"){const s=parseFloat(r);if(!Number.isNaN(s))return s}return r},T5=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch(s){return console.log(`JSON parse error: ${s}`),r}return r},E5=(r,s)=>{if(typeof r!="string")return r;const c=r.length-1,m=r[c];if(r[0]==="{"&&m==="}"){let S;const C=r.slice(1,c);try{S=JSON.parse("["+C+"]")}catch{S=C?C.split(","):[]}return S.map(o=>HN(s,o))}return r},I5=r=>typeof r=="string"?r.replace(" ","T"):r,WN=r=>{let s=r;return s=s.replace(/^ws/i,"http"),s=s.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),s.replace(/\/+$/,"")+"/api/broadcast"};class m1{constructor(s,c,m={},v=S2){this.channel=s,this.event=c,this.payload=m,this.timeout=v,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(s){this.timeout=s,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(s){this.payload=Object.assign(Object.assign({},this.payload),s)}receive(s,c){var m;return this._hasReceived(s)&&c((m=this.receivedResp)===null||m===void 0?void 0:m.response),this.recHooks.push({status:s,callback:c}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const s=c=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=c,this._matchReceive(c)};this.channel._on(this.refEvent,{},s),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(s,c){this.refEvent&&this.channel._trigger(this.refEvent,{status:s,response:c})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:s,response:c}){this.recHooks.filter(m=>m.status===s).forEach(m=>m.callback(c))}_hasReceived(s){return this.receivedResp&&this.receivedResp.status===s}}var _P;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(_P||(_P={}));class s_{constructor(s,c){this.channel=s,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const m=(c==null?void 0:c.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(m.state,{},v=>{const{onJoin:S,onLeave:C,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=s_.syncState(this.state,v,S,C),this.pendingDiffs.forEach(L=>{this.state=s_.syncDiff(this.state,L,S,C)}),this.pendingDiffs=[],o()}),this.channel._on(m.diff,{},v=>{const{onJoin:S,onLeave:C,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(v):(this.state=s_.syncDiff(this.state,v,S,C),o())}),this.onJoin((v,S,C)=>{this.channel._trigger("presence",{event:"join",key:v,currentPresences:S,newPresences:C})}),this.onLeave((v,S,C)=>{this.channel._trigger("presence",{event:"leave",key:v,currentPresences:S,leftPresences:C})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(s,c,m,v){const S=this.cloneDeep(s),C=this.transformState(c),o={},L={};return this.map(S,(F,Z)=>{C[F]||(L[F]=Z)}),this.map(C,(F,Z)=>{const $=S[F];if($){const W=Z.map(ke=>ke.presence_ref),ee=$.map(ke=>ke.presence_ref),ie=Z.filter(ke=>ee.indexOf(ke.presence_ref)<0),ae=$.filter(ke=>W.indexOf(ke.presence_ref)<0);ie.length>0&&(o[F]=ie),ae.length>0&&(L[F]=ae)}else o[F]=Z}),this.syncDiff(S,{joins:o,leaves:L},m,v)}static syncDiff(s,c,m,v){const{joins:S,leaves:C}={joins:this.transformState(c.joins),leaves:this.transformState(c.leaves)};return m||(m=()=>{}),v||(v=()=>{}),this.map(S,(o,L)=>{var F;const Z=(F=s[o])!==null&&F!==void 0?F:[];if(s[o]=this.cloneDeep(L),Z.length>0){const $=s[o].map(ee=>ee.presence_ref),W=Z.filter(ee=>$.indexOf(ee.presence_ref)<0);s[o].unshift(...W)}m(o,Z,L)}),this.map(C,(o,L)=>{let F=s[o];if(!F)return;const Z=L.map($=>$.presence_ref);F=F.filter($=>Z.indexOf($.presence_ref)<0),s[o]=F,v(o,F,L),F.length===0&&delete s[o]}),s}static map(s,c){return Object.getOwnPropertyNames(s).map(m=>c(m,s[m]))}static transformState(s){return s=this.cloneDeep(s),Object.getOwnPropertyNames(s).reduce((c,m)=>{const v=s[m];return"metas"in v?c[m]=v.metas.map(S=>(S.presence_ref=S.phx_ref,delete S.phx_ref,delete S.phx_ref_prev,S)):c[m]=v,c},{})}static cloneDeep(s){return JSON.parse(JSON.stringify(s))}onJoin(s){this.caller.onJoin=s}onLeave(s){this.caller.onLeave=s}onSync(s){this.caller.onSync=s}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var yP;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(yP||(yP={}));var o_;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes",r.SYSTEM="system"})(o_||(o_={}));var hc;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(hc||(hc={}));class GS{constructor(s,c={config:{}},m){var v,S;if(this.topic=s,this.params=c,this.socket=m,this.bindings={},this.state=as.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=s.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},c.config),this.timeout=this.socket.timeout,this.joinPush=new m1(this,Fa.join,this.params,this.timeout),this.rejoinTimer=new qN(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=as.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(C=>C.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=as.closed,this.socket._remove(this)}),this._onError(C=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,C),this.state=as.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=as.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",C=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,C),this.state=as.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Fa.reply,{},(C,o)=>{this._trigger(this._replyEventName(o),C)}),this.presence=new s_(this),this.broadcastEndpointURL=WN(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((S=(v=this.params.config)===null||v===void 0?void 0:v.broadcast)===null||S===void 0)&&S.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(s,c=this.timeout){var m,v,S;if(this.socket.isConnected()||this.socket.connect(),this.state==as.closed){const{config:{broadcast:C,presence:o,private:L}}=this.params,F=(v=(m=this.bindings.postgres_changes)===null||m===void 0?void 0:m.map(ee=>ee.filter))!==null&&v!==void 0?v:[],Z=!!this.bindings[o_.PRESENCE]&&this.bindings[o_.PRESENCE].length>0||((S=this.params.config.presence)===null||S===void 0?void 0:S.enabled)===!0,$={},W={broadcast:C,presence:Object.assign(Object.assign({},o),{enabled:Z}),postgres_changes:F,private:L};this.socket.accessTokenValue&&($.access_token=this.socket.accessTokenValue),this._onError(ee=>s==null?void 0:s(hc.CHANNEL_ERROR,ee)),this._onClose(()=>s==null?void 0:s(hc.CLOSED)),this.updateJoinPayload(Object.assign({config:W},$)),this.joinedOnce=!0,this._rejoin(c),this.joinPush.receive("ok",async({postgres_changes:ee})=>{var ie;if(this.socket.setAuth(),ee===void 0){s==null||s(hc.SUBSCRIBED);return}else{const ae=this.bindings.postgres_changes,ke=(ie=ae==null?void 0:ae.length)!==null&&ie!==void 0?ie:0,le=[];for(let se=0;se<ke;se++){const J=ae[se],{filter:{event:Ee,schema:je,table:Xe,filter:tt}}=J,it=ee&&ee[se];if(it&&it.event===Ee&&it.schema===je&&it.table===Xe&&it.filter===tt)le.push(Object.assign(Object.assign({},J),{id:it.id}));else{this.unsubscribe(),this.state=as.errored,s==null||s(hc.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=le,s&&s(hc.SUBSCRIBED);return}}).receive("error",ee=>{this.state=as.errored,s==null||s(hc.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(ee).join(", ")||"error")))}).receive("timeout",()=>{s==null||s(hc.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(s,c={}){return await this.send({type:"presence",event:"track",payload:s},c.timeout||this.timeout)}async untrack(s={}){return await this.send({type:"presence",event:"untrack"},s)}on(s,c,m){return this.state===as.joined&&s===o_.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(s,c,m)}async send(s,c={}){var m,v;if(!this._canPush()&&s.type==="broadcast"){const{event:S,payload:C}=s,L={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:S,payload:C,private:this.private}]})};try{const F=await this._fetchWithTimeout(this.broadcastEndpointURL,L,(m=c.timeout)!==null&&m!==void 0?m:this.timeout);return await((v=F.body)===null||v===void 0?void 0:v.cancel()),F.ok?"ok":"error"}catch(F){return F.name==="AbortError"?"timed out":"error"}}else return new Promise(S=>{var C,o,L;const F=this._push(s.type,s,c.timeout||this.timeout);s.type==="broadcast"&&!(!((L=(o=(C=this.params)===null||C===void 0?void 0:C.config)===null||o===void 0?void 0:o.broadcast)===null||L===void 0)&&L.ack)&&S("ok"),F.receive("ok",()=>S("ok")),F.receive("error",()=>S("error")),F.receive("timeout",()=>S("timed out"))})}updateJoinPayload(s){this.joinPush.updatePayload(s)}unsubscribe(s=this.timeout){this.state=as.leaving;const c=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Fa.close,"leave",this._joinRef())};this.joinPush.destroy();let m=null;return new Promise(v=>{m=new m1(this,Fa.leave,{},s),m.receive("ok",()=>{c(),v("ok")}).receive("timeout",()=>{c(),v("timed out")}).receive("error",()=>{v("error")}),m.send(),this._canPush()||m.trigger("ok",{})}).finally(()=>{m==null||m.destroy()})}teardown(){this.pushBuffer.forEach(s=>s.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=as.closed,this.bindings={}}async _fetchWithTimeout(s,c,m){const v=new AbortController,S=setTimeout(()=>v.abort(),m),C=await this.socket.fetch(s,Object.assign(Object.assign({},c),{signal:v.signal}));return clearTimeout(S),C}_push(s,c,m=this.timeout){if(!this.joinedOnce)throw`tried to push '${s}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let v=new m1(this,s,c,m);return this._canPush()?v.send():this._addToPushBuffer(v),v}_addToPushBuffer(s){if(s.startTimeout(),this.pushBuffer.push(s),this.pushBuffer.length>x5){const c=this.pushBuffer.shift();c&&(c.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${c.event}`,c.payload))}}_onMessage(s,c,m){return c}_isMember(s){return this.topic===s}_joinRef(){return this.joinPush.ref}_trigger(s,c,m){var v,S;const C=s.toLocaleLowerCase(),{close:o,error:L,leave:F,join:Z}=Fa;if(m&&[o,L,F,Z].indexOf(C)>=0&&m!==this._joinRef())return;let W=this._onMessage(C,c,m);if(c&&!W)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(C)?(v=this.bindings.postgres_changes)===null||v===void 0||v.filter(ee=>{var ie,ae,ke;return((ie=ee.filter)===null||ie===void 0?void 0:ie.event)==="*"||((ke=(ae=ee.filter)===null||ae===void 0?void 0:ae.event)===null||ke===void 0?void 0:ke.toLocaleLowerCase())===C}).map(ee=>ee.callback(W,m)):(S=this.bindings[C])===null||S===void 0||S.filter(ee=>{var ie,ae,ke,le,se,J;if(["broadcast","presence","postgres_changes"].includes(C))if("id"in ee){const Ee=ee.id,je=(ie=ee.filter)===null||ie===void 0?void 0:ie.event;return Ee&&((ae=c.ids)===null||ae===void 0?void 0:ae.includes(Ee))&&(je==="*"||(je==null?void 0:je.toLocaleLowerCase())===((ke=c.data)===null||ke===void 0?void 0:ke.type.toLocaleLowerCase()))}else{const Ee=(se=(le=ee==null?void 0:ee.filter)===null||le===void 0?void 0:le.event)===null||se===void 0?void 0:se.toLocaleLowerCase();return Ee==="*"||Ee===((J=c==null?void 0:c.event)===null||J===void 0?void 0:J.toLocaleLowerCase())}else return ee.type.toLocaleLowerCase()===C}).map(ee=>{if(typeof W=="object"&&"ids"in W){const ie=W.data,{schema:ae,table:ke,commit_timestamp:le,type:se,errors:J}=ie;W=Object.assign(Object.assign({},{schema:ae,table:ke,commit_timestamp:le,eventType:se,new:{},old:{},errors:J}),this._getPayloadRecords(ie))}ee.callback(W,m)})}_isClosed(){return this.state===as.closed}_isJoined(){return this.state===as.joined}_isJoining(){return this.state===as.joining}_isLeaving(){return this.state===as.leaving}_replyEventName(s){return`chan_reply_${s}`}_on(s,c,m){const v=s.toLocaleLowerCase(),S={type:v,filter:c,callback:m};return this.bindings[v]?this.bindings[v].push(S):this.bindings[v]=[S],this}_off(s,c){const m=s.toLocaleLowerCase();return this.bindings[m]&&(this.bindings[m]=this.bindings[m].filter(v=>{var S;return!(((S=v.type)===null||S===void 0?void 0:S.toLocaleLowerCase())===m&&GS.isEqual(v.filter,c))})),this}static isEqual(s,c){if(Object.keys(s).length!==Object.keys(c).length)return!1;for(const m in s)if(s[m]!==c[m])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(s){this._on(Fa.close,{},s)}_onError(s){this._on(Fa.error,{},c=>s(c))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(s=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=as.joining,this.joinPush.resend(s))}_getPayloadRecords(s){const c={new:{},old:{}};return(s.type==="INSERT"||s.type==="UPDATE")&&(c.new=gP(s.columns,s.record)),(s.type==="UPDATE"||s.type==="DELETE")&&(c.old=gP(s.columns,s.old_record)),c}}const g1=()=>{},ox={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},C5=[1e3,2e3,5e3,1e4],A5=1e4,P5=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class k5{constructor(s,c){var m;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=S2,this.transport=null,this.heartbeatIntervalMs=ox.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=g1,this.ref=0,this.reconnectTimer=null,this.logger=g1,this.conn=null,this.sendBuffer=[],this.serializer=new v5,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=v=>{let S;return v?S=v:typeof fetch>"u"?S=(...C)=>U_(async()=>{const{default:o}=await Promise.resolve().then(()=>jp);return{default:o}},void 0).then(({default:o})=>o(...C)).catch(o=>{throw new Error(`Failed to load @supabase/node-fetch: ${o.message}. This is required for HTTP requests in Node.js environments without native fetch.`)}):S=fetch,(...C)=>S(...C)},!(!((m=c==null?void 0:c.params)===null||m===void 0)&&m.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=c.params.apikey,this.endPoint=`${s}/${T2.websocket}`,this.httpEndpoint=WN(s),this._initializeOptions(c),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(c==null?void 0:c.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=p5.createWebSocket(this.endpointURL())}catch(s){this._setConnectionState("disconnected");const c=s.message;throw c.includes("Node.js")?new Error(`${c}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${c}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:_5}))}disconnect(s,c){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const m=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(m),this._setConnectionState("disconnected")},s?this.conn.close(s,c??""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(s){const c=await s.unsubscribe();return this.channels.length===0&&this.disconnect(),c}async removeAllChannels(){const s=await Promise.all(this.channels.map(c=>c.unsubscribe()));return this.channels=[],this.disconnect(),s}log(s,c,m){this.logger(s,c,m)}connectionState(){switch(this.conn&&this.conn.readyState){case n_.connecting:return Zd.Connecting;case n_.open:return Zd.Open;case n_.closing:return Zd.Closing;default:return Zd.Closed}}isConnected(){return this.connectionState()===Zd.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(s,c={config:{}}){const m=`realtime:${s}`,v=this.getChannels().find(S=>S.topic===m);if(v)return v;{const S=new GS(`realtime:${s}`,c,this);return this.channels.push(S),S}}push(s){const{topic:c,event:m,payload:v,ref:S}=s,C=()=>{this.encode(s,o=>{var L;(L=this.conn)===null||L===void 0||L.send(o)})};this.log("push",`${c} ${m} (${S})`,v),this.isConnected()?C():this.sendBuffer.push(C)}async setAuth(s=null){this._authPromise=this._performAuth(s);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var s;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(c){this.log("error","error in heartbeat callback",c)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(c){this.log("error","error in heartbeat callback",c)}this._wasManualDisconnect=!1,(s=this.conn)===null||s===void 0||s.close(y5,"heartbeat timeout"),setTimeout(()=>{var c;this.isConnected()||(c=this.reconnectTimer)===null||c===void 0||c.scheduleTimeout()},ox.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(c){this.log("error","error in heartbeat callback",c)}this._setAuthSafely("heartbeat")}onHeartbeat(s){this.heartbeatCallback=s}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(s=>s()),this.sendBuffer=[])}_makeRef(){let s=this.ref+1;return s===this.ref?this.ref=0:this.ref=s,this.ref.toString()}_leaveOpenTopic(s){let c=this.channels.find(m=>m.topic===s&&(m._isJoined()||m._isJoining()));c&&(this.log("transport",`leaving duplicate topic "${s}"`),c.unsubscribe())}_remove(s){this.channels=this.channels.filter(c=>c.topic!==s.topic)}_onConnMessage(s){this.decode(s.data,c=>{if(c.topic==="phoenix"&&c.event==="phx_reply")try{this.heartbeatCallback(c.payload.status==="ok"?"ok":"error")}catch(F){this.log("error","error in heartbeat callback",F)}c.ref&&c.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:m,event:v,payload:S,ref:C}=c,o=C?`(${C})`:"",L=S.status||"";this.log("receive",`${L} ${m} ${v} ${o}`.trim(),S),this.channels.filter(F=>F._isMember(m)).forEach(F=>F._trigger(v,S,C)),this._triggerStateCallbacks("message",c)})}_clearTimer(s){var c;s==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):s==="reconnect"&&((c=this.reconnectTimer)===null||c===void 0||c.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=s=>this._onConnError(s),this.conn.onmessage=s=>this._onConnMessage(s),this.conn.onclose=s=>this._onConnClose(s))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(s=>s.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const s=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(s),this.workerRef.onerror=c=>{this.log("worker","worker error",c.message),this.workerRef.terminate()},this.workerRef.onmessage=c=>{c.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(s){var c;this._setConnectionState("disconnected"),this.log("transport","close",s),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(c=this.reconnectTimer)===null||c===void 0||c.scheduleTimeout(),this._triggerStateCallbacks("close",s)}_onConnError(s){this._setConnectionState("disconnected"),this.log("transport",`${s}`),this._triggerChanError(),this._triggerStateCallbacks("error",s)}_triggerChanError(){this.channels.forEach(s=>s._trigger(Fa.error))}_appendParams(s,c){if(Object.keys(c).length===0)return s;const m=s.match(/\?/)?"&":"?",v=new URLSearchParams(c);return`${s}${m}${v}`}_workerObjectUrl(s){let c;if(s)c=s;else{const m=new Blob([P5],{type:"application/javascript"});c=URL.createObjectURL(m)}return c}_setConnectionState(s,c=!1){this._connectionState=s,s==="connecting"?this._wasManualDisconnect=!1:s==="disconnecting"&&(this._wasManualDisconnect=c)}async _performAuth(s=null){let c;s?c=s:this.accessToken?c=await this.accessToken():c=this.accessTokenValue,this.accessTokenValue!=c&&(this.accessTokenValue=c,this.channels.forEach(m=>{const v={access_token:c,version:g5};c&&m.updateJoinPayload(v),m.joinedOnce&&m._isJoined()&&m._push(Fa.access_token,{access_token:c})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(s="general"){this.setAuth().catch(c=>{this.log("error",`error setting auth in ${s}`,c)})}_triggerStateCallbacks(s,c){try{this.stateChangeCallbacks[s].forEach(m=>{try{m(c)}catch(v){this.log("error",`error in ${s} callback`,v)}})}catch(m){this.log("error",`error triggering ${s} callbacks`,m)}}_setupReconnectionTimer(){this.reconnectTimer=new qN(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},ox.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(s){var c,m,v,S,C,o,L,F,Z;if(this.transport=(c=s==null?void 0:s.transport)!==null&&c!==void 0?c:null,this.timeout=(m=s==null?void 0:s.timeout)!==null&&m!==void 0?m:S2,this.heartbeatIntervalMs=(v=s==null?void 0:s.heartbeatIntervalMs)!==null&&v!==void 0?v:ox.HEARTBEAT_INTERVAL,this.worker=(S=s==null?void 0:s.worker)!==null&&S!==void 0?S:!1,this.accessToken=(C=s==null?void 0:s.accessToken)!==null&&C!==void 0?C:null,this.heartbeatCallback=(o=s==null?void 0:s.heartbeatCallback)!==null&&o!==void 0?o:g1,s!=null&&s.params&&(this.params=s.params),s!=null&&s.logger&&(this.logger=s.logger),(s!=null&&s.logLevel||s!=null&&s.log_level)&&(this.logLevel=s.logLevel||s.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(L=s==null?void 0:s.reconnectAfterMs)!==null&&L!==void 0?L:$=>C5[$-1]||A5,this.encode=(F=s==null?void 0:s.encode)!==null&&F!==void 0?F:($,W)=>W(JSON.stringify($)),this.decode=(Z=s==null?void 0:s.decode)!==null&&Z!==void 0?Z:this.serializer.decode.bind(this.serializer),this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=s==null?void 0:s.workerUrl}}}class qS extends Error{constructor(s){super(s),this.__isStorageError=!0,this.name="StorageError"}}function es(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}class M5 extends qS{constructor(s,c,m){super(s),this.name="StorageApiError",this.status=c,this.statusCode=m}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class I2 extends qS{constructor(s,c){super(s),this.name="StorageUnknownError",this.originalError=c}}var N5=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};const ZN=r=>{let s;return r?s=r:typeof fetch>"u"?s=(...c)=>U_(async()=>{const{default:m}=await Promise.resolve().then(()=>jp);return{default:m}},void 0).then(({default:m})=>m(...c)):s=fetch,(...c)=>s(...c)},R5=()=>N5(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield U_(()=>Promise.resolve().then(()=>jp),void 0)).Response:Response}),C2=r=>{if(Array.isArray(r))return r.map(c=>C2(c));if(typeof r=="function"||r!==Object(r))return r;const s={};return Object.entries(r).forEach(([c,m])=>{const v=c.replace(/([-_][a-z])/gi,S=>S.toUpperCase().replace(/[-_]/g,""));s[v]=C2(m)}),s},L5=r=>{if(typeof r!="object"||r===null)return!1;const s=Object.getPrototypeOf(r);return(s===null||s===Object.prototype||Object.getPrototypeOf(s)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)};var dh=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};const _1=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),O5=(r,s,c)=>dh(void 0,void 0,void 0,function*(){const m=yield R5();r instanceof m&&!(c!=null&&c.noResolveJson)?r.json().then(v=>{const S=r.status||500,C=(v==null?void 0:v.statusCode)||S+"";s(new M5(_1(v),S,C))}).catch(v=>{s(new I2(_1(v),v))}):s(new I2(_1(r),r))}),D5=(r,s,c,m)=>{const v={method:r,headers:(s==null?void 0:s.headers)||{}};return r==="GET"||!m?v:(L5(m)?(v.headers=Object.assign({"Content-Type":"application/json"},s==null?void 0:s.headers),v.body=JSON.stringify(m)):v.body=m,s!=null&&s.duplex&&(v.duplex=s.duplex),Object.assign(Object.assign({},v),c))};function $_(r,s,c,m,v,S){return dh(this,void 0,void 0,function*(){return new Promise((C,o)=>{r(c,D5(s,m,v,S)).then(L=>{if(!L.ok)throw L;return m!=null&&m.noResolveJson?L:L.json()}).then(L=>C(L)).catch(L=>O5(L,o,m))})})}function tv(r,s,c,m){return dh(this,void 0,void 0,function*(){return $_(r,"GET",s,c,m)})}function Tl(r,s,c,m,v){return dh(this,void 0,void 0,function*(){return $_(r,"POST",s,m,v,c)})}function A2(r,s,c,m,v){return dh(this,void 0,void 0,function*(){return $_(r,"PUT",s,m,v,c)})}function j5(r,s,c,m){return dh(this,void 0,void 0,function*(){return $_(r,"HEAD",s,Object.assign(Object.assign({},c),{noResolveJson:!0}),m)})}function XN(r,s,c,m,v){return dh(this,void 0,void 0,function*(){return $_(r,"DELETE",s,m,v,c)})}var z5=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};class F5{constructor(s,c){this.downloadFn=s,this.shouldThrowOnError=c}then(s,c){return this.execute().then(s,c)}execute(){return z5(this,void 0,void 0,function*(){try{return{data:(yield this.downloadFn()).body,error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(es(s))return{data:null,error:s};throw s}})}}var B5=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};class U5{constructor(s,c){this.downloadFn=s,this.shouldThrowOnError=c}asStream(){return new F5(this.downloadFn,this.shouldThrowOnError)}then(s,c){return this.execute().then(s,c)}execute(){return B5(this,void 0,void 0,function*(){try{return{data:yield(yield this.downloadFn()).blob(),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(es(s))return{data:null,error:s};throw s}})}}var yo=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};const V5={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},xP={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class $5{constructor(s,c={},m,v){this.shouldThrowOnError=!1,this.url=s,this.headers=c,this.bucketId=m,this.fetch=ZN(v)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(s,c,m,v){return yo(this,void 0,void 0,function*(){try{let S;const C=Object.assign(Object.assign({},xP),v);let o=Object.assign(Object.assign({},this.headers),s==="POST"&&{"x-upsert":String(C.upsert)});const L=C.metadata;typeof Blob<"u"&&m instanceof Blob?(S=new FormData,S.append("cacheControl",C.cacheControl),L&&S.append("metadata",this.encodeMetadata(L)),S.append("",m)):typeof FormData<"u"&&m instanceof FormData?(S=m,S.append("cacheControl",C.cacheControl),L&&S.append("metadata",this.encodeMetadata(L))):(S=m,o["cache-control"]=`max-age=${C.cacheControl}`,o["content-type"]=C.contentType,L&&(o["x-metadata"]=this.toBase64(this.encodeMetadata(L)))),v!=null&&v.headers&&(o=Object.assign(Object.assign({},o),v.headers));const F=this._removeEmptyFolders(c),Z=this._getFinalPath(F),$=yield(s=="PUT"?A2:Tl)(this.fetch,`${this.url}/object/${Z}`,S,Object.assign({headers:o},C!=null&&C.duplex?{duplex:C.duplex}:{}));return{data:{path:F,id:$.Id,fullPath:$.Key},error:null}}catch(S){if(this.shouldThrowOnError)throw S;if(es(S))return{data:null,error:S};throw S}})}upload(s,c,m){return yo(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",s,c,m)})}uploadToSignedUrl(s,c,m,v){return yo(this,void 0,void 0,function*(){const S=this._removeEmptyFolders(s),C=this._getFinalPath(S),o=new URL(this.url+`/object/upload/sign/${C}`);o.searchParams.set("token",c);try{let L;const F=Object.assign({upsert:xP.upsert},v),Z=Object.assign(Object.assign({},this.headers),{"x-upsert":String(F.upsert)});typeof Blob<"u"&&m instanceof Blob?(L=new FormData,L.append("cacheControl",F.cacheControl),L.append("",m)):typeof FormData<"u"&&m instanceof FormData?(L=m,L.append("cacheControl",F.cacheControl)):(L=m,Z["cache-control"]=`max-age=${F.cacheControl}`,Z["content-type"]=F.contentType);const $=yield A2(this.fetch,o.toString(),L,{headers:Z});return{data:{path:S,fullPath:$.Key},error:null}}catch(L){if(this.shouldThrowOnError)throw L;if(es(L))return{data:null,error:L};throw L}})}createSignedUploadUrl(s,c){return yo(this,void 0,void 0,function*(){try{let m=this._getFinalPath(s);const v=Object.assign({},this.headers);c!=null&&c.upsert&&(v["x-upsert"]="true");const S=yield Tl(this.fetch,`${this.url}/object/upload/sign/${m}`,{},{headers:v}),C=new URL(this.url+S.url),o=C.searchParams.get("token");if(!o)throw new qS("No token returned by API");return{data:{signedUrl:C.toString(),path:s,token:o},error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(es(m))return{data:null,error:m};throw m}})}update(s,c,m){return yo(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",s,c,m)})}move(s,c,m){return yo(this,void 0,void 0,function*(){try{return{data:yield Tl(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:s,destinationKey:c,destinationBucket:m==null?void 0:m.destinationBucket},{headers:this.headers}),error:null}}catch(v){if(this.shouldThrowOnError)throw v;if(es(v))return{data:null,error:v};throw v}})}copy(s,c,m){return yo(this,void 0,void 0,function*(){try{return{data:{path:(yield Tl(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:s,destinationKey:c,destinationBucket:m==null?void 0:m.destinationBucket},{headers:this.headers})).Key},error:null}}catch(v){if(this.shouldThrowOnError)throw v;if(es(v))return{data:null,error:v};throw v}})}createSignedUrl(s,c,m){return yo(this,void 0,void 0,function*(){try{let v=this._getFinalPath(s),S=yield Tl(this.fetch,`${this.url}/object/sign/${v}`,Object.assign({expiresIn:c},m!=null&&m.transform?{transform:m.transform}:{}),{headers:this.headers});const C=m!=null&&m.download?`&download=${m.download===!0?"":m.download}`:"";return S={signedUrl:encodeURI(`${this.url}${S.signedURL}${C}`)},{data:S,error:null}}catch(v){if(this.shouldThrowOnError)throw v;if(es(v))return{data:null,error:v};throw v}})}createSignedUrls(s,c,m){return yo(this,void 0,void 0,function*(){try{const v=yield Tl(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:c,paths:s},{headers:this.headers}),S=m!=null&&m.download?`&download=${m.download===!0?"":m.download}`:"";return{data:v.map(C=>Object.assign(Object.assign({},C),{signedUrl:C.signedURL?encodeURI(`${this.url}${C.signedURL}${S}`):null})),error:null}}catch(v){if(this.shouldThrowOnError)throw v;if(es(v))return{data:null,error:v};throw v}})}download(s,c){const v=typeof(c==null?void 0:c.transform)<"u"?"render/image/authenticated":"object",S=this.transformOptsToQueryString((c==null?void 0:c.transform)||{}),C=S?`?${S}`:"",o=this._getFinalPath(s),L=()=>tv(this.fetch,`${this.url}/${v}/${o}${C}`,{headers:this.headers,noResolveJson:!0});return new U5(L,this.shouldThrowOnError)}info(s){return yo(this,void 0,void 0,function*(){const c=this._getFinalPath(s);try{const m=yield tv(this.fetch,`${this.url}/object/info/${c}`,{headers:this.headers});return{data:C2(m),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(es(m))return{data:null,error:m};throw m}})}exists(s){return yo(this,void 0,void 0,function*(){const c=this._getFinalPath(s);try{return yield j5(this.fetch,`${this.url}/object/${c}`,{headers:this.headers}),{data:!0,error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(es(m)&&m instanceof I2){const v=m.originalError;if([400,404].includes(v==null?void 0:v.status))return{data:!1,error:m}}throw m}})}getPublicUrl(s,c){const m=this._getFinalPath(s),v=[],S=c!=null&&c.download?`download=${c.download===!0?"":c.download}`:"";S!==""&&v.push(S);const o=typeof(c==null?void 0:c.transform)<"u"?"render/image":"object",L=this.transformOptsToQueryString((c==null?void 0:c.transform)||{});L!==""&&v.push(L);let F=v.join("&");return F!==""&&(F=`?${F}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${m}${F}`)}}}remove(s){return yo(this,void 0,void 0,function*(){try{return{data:yield XN(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:s},{headers:this.headers}),error:null}}catch(c){if(this.shouldThrowOnError)throw c;if(es(c))return{data:null,error:c};throw c}})}list(s,c,m){return yo(this,void 0,void 0,function*(){try{const v=Object.assign(Object.assign(Object.assign({},V5),c),{prefix:s||""});return{data:yield Tl(this.fetch,`${this.url}/object/list/${this.bucketId}`,v,{headers:this.headers},m),error:null}}catch(v){if(this.shouldThrowOnError)throw v;if(es(v))return{data:null,error:v};throw v}})}listV2(s,c){return yo(this,void 0,void 0,function*(){try{const m=Object.assign({},s);return{data:yield Tl(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,m,{headers:this.headers},c),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(es(m))return{data:null,error:m};throw m}})}encodeMetadata(s){return JSON.stringify(s)}toBase64(s){return typeof Buffer<"u"?Buffer.from(s).toString("base64"):btoa(s)}_getFinalPath(s){return`${this.bucketId}/${s.replace(/^\/+/,"")}`}_removeEmptyFolders(s){return s.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(s){const c=[];return s.width&&c.push(`width=${s.width}`),s.height&&c.push(`height=${s.height}`),s.resize&&c.push(`resize=${s.resize}`),s.format&&c.push(`format=${s.format}`),s.quality&&c.push(`quality=${s.quality}`),c.join("&")}}const G5="2.75.0",q5={"X-Client-Info":`storage-js/${G5}`};var qf=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};class H5{constructor(s,c={},m,v){this.shouldThrowOnError=!1;const S=new URL(s);v!=null&&v.useNewHostname&&/supabase\.(co|in|red)$/.test(S.hostname)&&!S.hostname.includes("storage.supabase.")&&(S.hostname=S.hostname.replace("supabase.","storage.supabase.")),this.url=S.href.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},q5),c),this.fetch=ZN(m)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(){return qf(this,void 0,void 0,function*(){try{return{data:yield tv(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(es(s))return{data:null,error:s};throw s}})}getBucket(s){return qf(this,void 0,void 0,function*(){try{return{data:yield tv(this.fetch,`${this.url}/bucket/${s}`,{headers:this.headers}),error:null}}catch(c){if(this.shouldThrowOnError)throw c;if(es(c))return{data:null,error:c};throw c}})}createBucket(s){return qf(this,arguments,void 0,function*(c,m={public:!1}){try{return{data:yield Tl(this.fetch,`${this.url}/bucket`,{id:c,name:c,type:m.type,public:m.public,file_size_limit:m.fileSizeLimit,allowed_mime_types:m.allowedMimeTypes},{headers:this.headers}),error:null}}catch(v){if(this.shouldThrowOnError)throw v;if(es(v))return{data:null,error:v};throw v}})}updateBucket(s,c){return qf(this,void 0,void 0,function*(){try{return{data:yield A2(this.fetch,`${this.url}/bucket/${s}`,{id:s,name:s,public:c.public,file_size_limit:c.fileSizeLimit,allowed_mime_types:c.allowedMimeTypes},{headers:this.headers}),error:null}}catch(m){if(this.shouldThrowOnError)throw m;if(es(m))return{data:null,error:m};throw m}})}emptyBucket(s){return qf(this,void 0,void 0,function*(){try{return{data:yield Tl(this.fetch,`${this.url}/bucket/${s}/empty`,{},{headers:this.headers}),error:null}}catch(c){if(this.shouldThrowOnError)throw c;if(es(c))return{data:null,error:c};throw c}})}deleteBucket(s){return qf(this,void 0,void 0,function*(){try{return{data:yield XN(this.fetch,`${this.url}/bucket/${s}`,{},{headers:this.headers}),error:null}}catch(c){if(this.shouldThrowOnError)throw c;if(es(c))return{data:null,error:c};throw c}})}}class W5 extends H5{constructor(s,c={},m,v){super(s,c,m,v)}from(s){return new $5(this.url,this.headers,s,this.fetch)}}const Z5="2.75.0";let Zg="";typeof Deno<"u"?Zg="deno":typeof document<"u"?Zg="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Zg="react-native":Zg="node";const X5={"X-Client-Info":`supabase-js-${Zg}/${Z5}`},Y5={headers:X5},K5={schema:"public"},J5={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Q5={};var eB=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};const tB=r=>{let s;return r?s=r:typeof fetch>"u"?s=LN:s=fetch,(...c)=>s(...c)},rB=()=>typeof Headers>"u"?ON:Headers,iB=(r,s,c)=>{const m=tB(c),v=rB();return(S,C)=>eB(void 0,void 0,void 0,function*(){var o;const L=(o=yield s())!==null&&o!==void 0?o:r;let F=new v(C==null?void 0:C.headers);return F.has("apikey")||F.set("apikey",r),F.has("Authorization")||F.set("Authorization",`Bearer ${L}`),m(S,Object.assign(Object.assign({},C),{headers:F}))})};var nB=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};function sB(r){return r.endsWith("/")?r:r+"/"}function oB(r,s){var c,m;const{db:v,auth:S,realtime:C,global:o}=r,{db:L,auth:F,realtime:Z,global:$}=s,W={db:Object.assign(Object.assign({},L),v),auth:Object.assign(Object.assign({},F),S),realtime:Object.assign(Object.assign({},Z),C),storage:{},global:Object.assign(Object.assign(Object.assign({},$),o),{headers:Object.assign(Object.assign({},(c=$==null?void 0:$.headers)!==null&&c!==void 0?c:{}),(m=o==null?void 0:o.headers)!==null&&m!==void 0?m:{})}),accessToken:()=>nB(this,void 0,void 0,function*(){return""})};return r.accessToken?W.accessToken=r.accessToken:delete W.accessToken,W}function aB(r){const s=r==null?void 0:r.trim();if(!s)throw new Error("supabaseUrl is required.");if(!s.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(sB(s))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}const YN="2.75.0",Jf=30*1e3,P2=3,y1=P2*Jf,lB="http://localhost:9999",cB="supabase.auth.token",uB={"X-Client-Info":`gotrue-js/${YN}`},k2="X-Supabase-Api-Version",KN={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},dB=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,hB=10*60*1e3;class A_ extends Error{constructor(s,c,m){super(s),this.__isAuthError=!0,this.name="AuthError",this.status=c,this.code=m}}function Hr(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class fB extends A_{constructor(s,c,m){super(s,c,m),this.name="AuthApiError",this.status=c,this.code=m}}function pB(r){return Hr(r)&&r.name==="AuthApiError"}class Xd extends A_{constructor(s,c){super(s),this.name="AuthUnknownError",this.originalError=c}}class Uu extends A_{constructor(s,c,m,v){super(s,m,v),this.name=c,this.status=m}}class yu extends Uu{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function mB(r){return Hr(r)&&r.name==="AuthSessionMissingError"}class Hf extends Uu{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class ax extends Uu{constructor(s){super(s,"AuthInvalidCredentialsError",400,void 0)}}class lx extends Uu{constructor(s,c=null){super(s,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=c}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function gB(r){return Hr(r)&&r.name==="AuthImplicitGrantRedirectError"}class vP extends Uu{constructor(s,c=null){super(s,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=c}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class M2 extends Uu{constructor(s,c){super(s,"AuthRetryableFetchError",c,void 0)}}function x1(r){return Hr(r)&&r.name==="AuthRetryableFetchError"}class bP extends Uu{constructor(s,c,m){super(s,"AuthWeakPasswordError",c,"weak_password"),this.reasons=m}}class N2 extends Uu{constructor(s){super(s,"AuthInvalidJwtError",400,"invalid_jwt")}}const rv="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),wP=` 	
\r=`.split(""),_B=(()=>{const r=new Array(128);for(let s=0;s<r.length;s+=1)r[s]=-1;for(let s=0;s<wP.length;s+=1)r[wP[s].charCodeAt(0)]=-2;for(let s=0;s<rv.length;s+=1)r[rv[s].charCodeAt(0)]=s;return r})();function SP(r,s,c){if(r!==null)for(s.queue=s.queue<<8|r,s.queuedBits+=8;s.queuedBits>=6;){const m=s.queue>>s.queuedBits-6&63;c(rv[m]),s.queuedBits-=6}else if(s.queuedBits>0)for(s.queue=s.queue<<6-s.queuedBits,s.queuedBits=6;s.queuedBits>=6;){const m=s.queue>>s.queuedBits-6&63;c(rv[m]),s.queuedBits-=6}}function JN(r,s,c){const m=_B[r];if(m>-1)for(s.queue=s.queue<<6|m,s.queuedBits+=6;s.queuedBits>=8;)c(s.queue>>s.queuedBits-8&255),s.queuedBits-=8;else{if(m===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(r)}"`)}}function TP(r){const s=[],c=C=>{s.push(String.fromCodePoint(C))},m={utf8seq:0,codepoint:0},v={queue:0,queuedBits:0},S=C=>{vB(C,m,c)};for(let C=0;C<r.length;C+=1)JN(r.charCodeAt(C),v,S);return s.join("")}function yB(r,s){if(r<=127){s(r);return}else if(r<=2047){s(192|r>>6),s(128|r&63);return}else if(r<=65535){s(224|r>>12),s(128|r>>6&63),s(128|r&63);return}else if(r<=1114111){s(240|r>>18),s(128|r>>12&63),s(128|r>>6&63),s(128|r&63);return}throw new Error(`Unrecognized Unicode codepoint: ${r.toString(16)}`)}function xB(r,s){for(let c=0;c<r.length;c+=1){let m=r.charCodeAt(c);if(m>55295&&m<=56319){const v=(m-55296)*1024&65535;m=(r.charCodeAt(c+1)-56320&65535|v)+65536,c+=1}yB(m,s)}}function vB(r,s,c){if(s.utf8seq===0){if(r<=127){c(r);return}for(let m=1;m<6;m+=1)if(!(r>>7-m&1)){s.utf8seq=m;break}if(s.utf8seq===2)s.codepoint=r&31;else if(s.utf8seq===3)s.codepoint=r&15;else if(s.utf8seq===4)s.codepoint=r&7;else throw new Error("Invalid UTF-8 sequence");s.utf8seq-=1}else if(s.utf8seq>0){if(r<=127)throw new Error("Invalid UTF-8 sequence");s.codepoint=s.codepoint<<6|r&63,s.utf8seq-=1,s.utf8seq===0&&c(s.codepoint)}}function xp(r){const s=[],c={queue:0,queuedBits:0},m=v=>{s.push(v)};for(let v=0;v<r.length;v+=1)JN(r.charCodeAt(v),c,m);return new Uint8Array(s)}function bB(r){const s=[];return xB(r,c=>s.push(c)),new Uint8Array(s)}function Qd(r){const s=[],c={queue:0,queuedBits:0},m=v=>{s.push(v)};return r.forEach(v=>SP(v,c,m)),SP(null,c,m),s.join("")}function wB(r){return Math.round(Date.now()/1e3)+r}function SB(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const s=Math.random()*16|0;return(r=="x"?s:s&3|8).toString(16)})}const Vo=()=>typeof window<"u"&&typeof document<"u",Fd={tested:!1,writable:!1},QN=()=>{if(!Vo())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Fd.tested)return Fd.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),Fd.tested=!0,Fd.writable=!0}catch{Fd.tested=!0,Fd.writable=!1}return Fd.writable};function TB(r){const s={},c=new URL(r);if(c.hash&&c.hash[0]==="#")try{new URLSearchParams(c.hash.substring(1)).forEach((v,S)=>{s[S]=v})}catch{}return c.searchParams.forEach((m,v)=>{s[v]=m}),s}const eR=r=>{let s;return r?s=r:typeof fetch>"u"?s=(...c)=>U_(async()=>{const{default:m}=await Promise.resolve().then(()=>jp);return{default:m}},void 0).then(({default:m})=>m(...c)):s=fetch,(...c)=>s(...c)},EB=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",Qf=async(r,s,c)=>{await r.setItem(s,JSON.stringify(c))},Bd=async(r,s)=>{const c=await r.getItem(s);if(!c)return null;try{return JSON.parse(c)}catch{return c}},gu=async(r,s)=>{await r.removeItem(s)};class kv{constructor(){this.promise=new kv.promiseConstructor((s,c)=>{this.resolve=s,this.reject=c})}}kv.promiseConstructor=Promise;function v1(r){const s=r.split(".");if(s.length!==3)throw new N2("Invalid JWT structure");for(let m=0;m<s.length;m++)if(!dB.test(s[m]))throw new N2("JWT not in base64url format");return{header:JSON.parse(TP(s[0])),payload:JSON.parse(TP(s[1])),signature:xp(s[2]),raw:{header:s[0],payload:s[1]}}}async function IB(r){return await new Promise(s=>{setTimeout(()=>s(null),r)})}function CB(r,s){return new Promise((m,v)=>{(async()=>{for(let S=0;S<1/0;S++)try{const C=await r(S);if(!s(S,null,C)){m(C);return}}catch(C){if(!s(S,C)){v(C);return}}})()})}function AB(r){return("0"+r.toString(16)).substr(-2)}function PB(){const s=new Uint32Array(56);if(typeof crypto>"u"){const c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",m=c.length;let v="";for(let S=0;S<56;S++)v+=c.charAt(Math.floor(Math.random()*m));return v}return crypto.getRandomValues(s),Array.from(s,AB).join("")}async function kB(r){const c=new TextEncoder().encode(r),m=await crypto.subtle.digest("SHA-256",c),v=new Uint8Array(m);return Array.from(v).map(S=>String.fromCharCode(S)).join("")}async function MB(r){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const c=await kB(r);return btoa(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Wf(r,s,c=!1){const m=PB();let v=m;c&&(v+="/PASSWORD_RECOVERY"),await Qf(r,`${s}-code-verifier`,v);const S=await MB(m);return[S,m===S?"plain":"s256"]}const NB=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function RB(r){const s=r.headers.get(k2);if(!s||!s.match(NB))return null;try{return new Date(`${s}T00:00:00.0Z`)}catch{return null}}function LB(r){if(!r)throw new Error("Missing exp claim");const s=Math.floor(Date.now()/1e3);if(r<=s)throw new Error("JWT has expired")}function OB(r){switch(r){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const DB=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Zf(r){if(!DB.test(r))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function b1(){const r={};return new Proxy(r,{get:(s,c)=>{if(c==="__isUserNotAvailableProxy")return!0;if(typeof c=="symbol"){const m=c.toString();if(m==="Symbol(Symbol.toPrimitive)"||m==="Symbol(Symbol.toStringTag)"||m==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${c}" property of the session object is not supported. Please use getUser() instead.`)},set:(s,c)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${c}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(s,c)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${c}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function EP(r){return JSON.parse(JSON.stringify(r))}var jB=function(r,s){var c={};for(var m in r)Object.prototype.hasOwnProperty.call(r,m)&&s.indexOf(m)<0&&(c[m]=r[m]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var v=0,m=Object.getOwnPropertySymbols(r);v<m.length;v++)s.indexOf(m[v])<0&&Object.prototype.propertyIsEnumerable.call(r,m[v])&&(c[m[v]]=r[m[v]]);return c};const qd=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),zB=[502,503,504];async function IP(r){var s;if(!EB(r))throw new M2(qd(r),0);if(zB.includes(r.status))throw new M2(qd(r),r.status);let c;try{c=await r.json()}catch(S){throw new Xd(qd(S),S)}let m;const v=RB(r);if(v&&v.getTime()>=KN["2024-01-01"].timestamp&&typeof c=="object"&&c&&typeof c.code=="string"?m=c.code:typeof c=="object"&&c&&typeof c.error_code=="string"&&(m=c.error_code),m){if(m==="weak_password")throw new bP(qd(c),r.status,((s=c.weak_password)===null||s===void 0?void 0:s.reasons)||[]);if(m==="session_not_found")throw new yu}else if(typeof c=="object"&&c&&typeof c.weak_password=="object"&&c.weak_password&&Array.isArray(c.weak_password.reasons)&&c.weak_password.reasons.length&&c.weak_password.reasons.reduce((S,C)=>S&&typeof C=="string",!0))throw new bP(qd(c),r.status,c.weak_password.reasons);throw new fB(qd(c),r.status||500,m)}const FB=(r,s,c,m)=>{const v={method:r,headers:(s==null?void 0:s.headers)||{}};return r==="GET"?v:(v.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},s==null?void 0:s.headers),v.body=JSON.stringify(m),Object.assign(Object.assign({},v),c))};async function di(r,s,c,m){var v;const S=Object.assign({},m==null?void 0:m.headers);S[k2]||(S[k2]=KN["2024-01-01"].name),m!=null&&m.jwt&&(S.Authorization=`Bearer ${m.jwt}`);const C=(v=m==null?void 0:m.query)!==null&&v!==void 0?v:{};m!=null&&m.redirectTo&&(C.redirect_to=m.redirectTo);const o=Object.keys(C).length?"?"+new URLSearchParams(C).toString():"",L=await BB(r,s,c+o,{headers:S,noResolveJson:m==null?void 0:m.noResolveJson},{},m==null?void 0:m.body);return m!=null&&m.xform?m==null?void 0:m.xform(L):{data:Object.assign({},L),error:null}}async function BB(r,s,c,m,v,S){const C=FB(s,m,v,S);let o;try{o=await r(c,Object.assign({},C))}catch(L){throw console.error(L),new M2(qd(L),0)}if(o.ok||await IP(o),m!=null&&m.noResolveJson)return o;try{return await o.json()}catch(L){await IP(L)}}function Da(r){var s;let c=null;$B(r)&&(c=Object.assign({},r),r.expires_at||(c.expires_at=wB(r.expires_in)));const m=(s=r.user)!==null&&s!==void 0?s:r;return{data:{session:c,user:m},error:null}}function CP(r){const s=Da(r);return!s.error&&r.weak_password&&typeof r.weak_password=="object"&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.message&&typeof r.weak_password.message=="string"&&r.weak_password.reasons.reduce((c,m)=>c&&typeof m=="string",!0)&&(s.data.weak_password=r.weak_password),s}function Su(r){var s;return{data:{user:(s=r.user)!==null&&s!==void 0?s:r},error:null}}function UB(r){return{data:r,error:null}}function VB(r){const{action_link:s,email_otp:c,hashed_token:m,redirect_to:v,verification_type:S}=r,C=jB(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:s,email_otp:c,hashed_token:m,redirect_to:v,verification_type:S},L=Object.assign({},C);return{data:{properties:o,user:L},error:null}}function AP(r){return r}function $B(r){return r.access_token&&r.refresh_token&&r.expires_in}const w1=["global","local","others"];var GB=function(r,s){var c={};for(var m in r)Object.prototype.hasOwnProperty.call(r,m)&&s.indexOf(m)<0&&(c[m]=r[m]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var v=0,m=Object.getOwnPropertySymbols(r);v<m.length;v++)s.indexOf(m[v])<0&&Object.prototype.propertyIsEnumerable.call(r,m[v])&&(c[m[v]]=r[m[v]]);return c};class qB{constructor({url:s="",headers:c={},fetch:m}){this.url=s,this.headers=c,this.fetch=eR(m),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(s,c=w1[0]){if(w1.indexOf(c)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${w1.join(", ")}`);try{return await di(this.fetch,"POST",`${this.url}/logout?scope=${c}`,{headers:this.headers,jwt:s,noResolveJson:!0}),{data:null,error:null}}catch(m){if(Hr(m))return{data:null,error:m};throw m}}async inviteUserByEmail(s,c={}){try{return await di(this.fetch,"POST",`${this.url}/invite`,{body:{email:s,data:c.data},headers:this.headers,redirectTo:c.redirectTo,xform:Su})}catch(m){if(Hr(m))return{data:{user:null},error:m};throw m}}async generateLink(s){try{const{options:c}=s,m=GB(s,["options"]),v=Object.assign(Object.assign({},m),c);return"newEmail"in m&&(v.new_email=m==null?void 0:m.newEmail,delete v.newEmail),await di(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:v,headers:this.headers,xform:VB,redirectTo:c==null?void 0:c.redirectTo})}catch(c){if(Hr(c))return{data:{properties:null,user:null},error:c};throw c}}async createUser(s){try{return await di(this.fetch,"POST",`${this.url}/admin/users`,{body:s,headers:this.headers,xform:Su})}catch(c){if(Hr(c))return{data:{user:null},error:c};throw c}}async listUsers(s){var c,m,v,S,C,o,L;try{const F={nextPage:null,lastPage:0,total:0},Z=await di(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(m=(c=s==null?void 0:s.page)===null||c===void 0?void 0:c.toString())!==null&&m!==void 0?m:"",per_page:(S=(v=s==null?void 0:s.perPage)===null||v===void 0?void 0:v.toString())!==null&&S!==void 0?S:""},xform:AP});if(Z.error)throw Z.error;const $=await Z.json(),W=(C=Z.headers.get("x-total-count"))!==null&&C!==void 0?C:0,ee=(L=(o=Z.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&L!==void 0?L:[];return ee.length>0&&(ee.forEach(ie=>{const ae=parseInt(ie.split(";")[0].split("=")[1].substring(0,1)),ke=JSON.parse(ie.split(";")[1].split("=")[1]);F[`${ke}Page`]=ae}),F.total=parseInt(W)),{data:Object.assign(Object.assign({},$),F),error:null}}catch(F){if(Hr(F))return{data:{users:[]},error:F};throw F}}async getUserById(s){Zf(s);try{return await di(this.fetch,"GET",`${this.url}/admin/users/${s}`,{headers:this.headers,xform:Su})}catch(c){if(Hr(c))return{data:{user:null},error:c};throw c}}async updateUserById(s,c){Zf(s);try{return await di(this.fetch,"PUT",`${this.url}/admin/users/${s}`,{body:c,headers:this.headers,xform:Su})}catch(m){if(Hr(m))return{data:{user:null},error:m};throw m}}async deleteUser(s,c=!1){Zf(s);try{return await di(this.fetch,"DELETE",`${this.url}/admin/users/${s}`,{headers:this.headers,body:{should_soft_delete:c},xform:Su})}catch(m){if(Hr(m))return{data:{user:null},error:m};throw m}}async _listFactors(s){Zf(s.userId);try{const{data:c,error:m}=await di(this.fetch,"GET",`${this.url}/admin/users/${s.userId}/factors`,{headers:this.headers,xform:v=>({data:{factors:v},error:null})});return{data:c,error:m}}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _deleteFactor(s){Zf(s.userId),Zf(s.id);try{return{data:await di(this.fetch,"DELETE",`${this.url}/admin/users/${s.userId}/factors/${s.id}`,{headers:this.headers}),error:null}}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _listOAuthClients(s){var c,m,v,S,C,o,L;try{const F={nextPage:null,lastPage:0,total:0},Z=await di(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(m=(c=s==null?void 0:s.page)===null||c===void 0?void 0:c.toString())!==null&&m!==void 0?m:"",per_page:(S=(v=s==null?void 0:s.perPage)===null||v===void 0?void 0:v.toString())!==null&&S!==void 0?S:""},xform:AP});if(Z.error)throw Z.error;const $=await Z.json(),W=(C=Z.headers.get("x-total-count"))!==null&&C!==void 0?C:0,ee=(L=(o=Z.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&L!==void 0?L:[];return ee.length>0&&(ee.forEach(ie=>{const ae=parseInt(ie.split(";")[0].split("=")[1].substring(0,1)),ke=JSON.parse(ie.split(";")[1].split("=")[1]);F[`${ke}Page`]=ae}),F.total=parseInt(W)),{data:Object.assign(Object.assign({},$),F),error:null}}catch(F){if(Hr(F))return{data:{clients:[]},error:F};throw F}}async _createOAuthClient(s){try{return await di(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:s,headers:this.headers,xform:c=>({data:c,error:null})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _getOAuthClient(s){try{return await di(this.fetch,"GET",`${this.url}/admin/oauth/clients/${s}`,{headers:this.headers,xform:c=>({data:c,error:null})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _deleteOAuthClient(s){try{return await di(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${s}`,{headers:this.headers,xform:c=>({data:c,error:null})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _regenerateOAuthClientSecret(s){try{return await di(this.fetch,"POST",`${this.url}/admin/oauth/clients/${s}/regenerate_secret`,{headers:this.headers,xform:c=>({data:c,error:null})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}}function PP(r={}){return{getItem:s=>r[s]||null,setItem:(s,c)=>{r[s]=c},removeItem:s=>{delete r[s]}}}const Xf={debug:!!(globalThis&&QN()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class tR extends Error{constructor(s){super(s),this.isAcquireTimeout=!0}}class HB extends tR{}async function WB(r,s,c){Xf.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",r,s);const m=new globalThis.AbortController;return s>0&&setTimeout(()=>{m.abort(),Xf.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",r)},s),await Promise.resolve().then(()=>globalThis.navigator.locks.request(r,s===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:m.signal},async v=>{if(v){Xf.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",r,v.name);try{return await c()}finally{Xf.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",r,v.name)}}else{if(s===0)throw Xf.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",r),new HB(`Acquiring an exclusive Navigator LockManager lock "${r}" immediately failed`);if(Xf.debug)try{const S=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(S,null,"  "))}catch(S){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",S)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await c()}}))}function ZB(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function rR(r){if(!/^0x[a-fA-F0-9]{40}$/.test(r))throw new Error(`@supabase/auth-js: Address "${r}" is invalid.`);return r.toLowerCase()}function XB(r){return parseInt(r,16)}function YB(r){const s=new TextEncoder().encode(r);return"0x"+Array.from(s,m=>m.toString(16).padStart(2,"0")).join("")}function KB(r){var s;const{chainId:c,domain:m,expirationTime:v,issuedAt:S=new Date,nonce:C,notBefore:o,requestId:L,resources:F,scheme:Z,uri:$,version:W}=r;{if(!Number.isInteger(c))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${c}`);if(!m)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(C&&C.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${C}`);if(!$)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(W!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${W}`);if(!((s=r.statement)===null||s===void 0)&&s.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${r.statement}`)}const ee=rR(r.address),ie=Z?`${Z}://${m}`:m,ae=r.statement?`${r.statement}
`:"",ke=`${ie} wants you to sign in with your Ethereum account:
${ee}

${ae}`;let le=`URI: ${$}
Version: ${W}
Chain ID: ${c}${C?`
Nonce: ${C}`:""}
Issued At: ${S.toISOString()}`;if(v&&(le+=`
Expiration Time: ${v.toISOString()}`),o&&(le+=`
Not Before: ${o.toISOString()}`),L&&(le+=`
Request ID: ${L}`),F){let se=`
Resources:`;for(const J of F){if(!J||typeof J!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${J}`);se+=`
- ${J}`}le+=se}return`${ke}
${le}`}class Qn extends Error{constructor({message:s,code:c,cause:m,name:v}){var S;super(s,{cause:m}),this.__isWebAuthnError=!0,this.name=(S=v??(m instanceof Error?m.name:void 0))!==null&&S!==void 0?S:"Unknown Error",this.code=c}}class iv extends Qn{constructor(s,c){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:c,message:s}),this.name="WebAuthnUnknownError",this.originalError=c}}function JB({error:r,options:s}){var c,m,v;const{publicKey:S}=s;if(!S)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(s.signal instanceof AbortSignal)return new Qn({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else if(r.name==="ConstraintError"){if(((c=S.authenticatorSelection)===null||c===void 0?void 0:c.requireResidentKey)===!0)return new Qn({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:r});if(s.mediation==="conditional"&&((m=S.authenticatorSelection)===null||m===void 0?void 0:m.userVerification)==="required")return new Qn({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:r});if(((v=S.authenticatorSelection)===null||v===void 0?void 0:v.userVerification)==="required")return new Qn({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:r})}else{if(r.name==="InvalidStateError")return new Qn({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:r});if(r.name==="NotAllowedError")return new Qn({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="NotSupportedError")return S.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new Qn({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:r}):new Qn({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:r});if(r.name==="SecurityError"){const C=window.location.hostname;if(nR(C)){if(S.rp.id!==C)return new Qn({message:`The RP ID "${S.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new Qn({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="TypeError"){if(S.user.id.byteLength<1||S.user.id.byteLength>64)return new Qn({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:r})}else if(r.name==="UnknownError")return new Qn({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new Qn({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}function QB({error:r,options:s}){const{publicKey:c}=s;if(!c)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(s.signal instanceof AbortSignal)return new Qn({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else{if(r.name==="NotAllowedError")return new Qn({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="SecurityError"){const m=window.location.hostname;if(nR(m)){if(c.rpId!==m)return new Qn({message:`The RP ID "${c.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new Qn({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="UnknownError")return new Qn({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new Qn({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}var iR=function(r,s){var c={};for(var m in r)Object.prototype.hasOwnProperty.call(r,m)&&s.indexOf(m)<0&&(c[m]=r[m]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var v=0,m=Object.getOwnPropertySymbols(r);v<m.length;v++)s.indexOf(m[v])<0&&Object.prototype.propertyIsEnumerable.call(r,m[v])&&(c[m[v]]=r[m[v]]);return c};class eU{createNewAbortSignal(){if(this.controller){const c=new Error("Cancelling existing WebAuthn API call for new one");c.name="AbortError",this.controller.abort(c)}const s=new AbortController;return this.controller=s,s.signal}cancelCeremony(){if(this.controller){const s=new Error("Manually cancelling existing WebAuthn API call");s.name="AbortError",this.controller.abort(s),this.controller=void 0}}}const tU=new eU;function rU(r){if(!r)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(r);const{challenge:s,user:c,excludeCredentials:m}=r,v=iR(r,["challenge","user","excludeCredentials"]),S=xp(s).buffer,C=Object.assign(Object.assign({},c),{id:xp(c.id).buffer}),o=Object.assign(Object.assign({},v),{challenge:S,user:C});if(m&&m.length>0){o.excludeCredentials=new Array(m.length);for(let L=0;L<m.length;L++){const F=m[L];o.excludeCredentials[L]=Object.assign(Object.assign({},F),{id:xp(F.id).buffer,type:F.type||"public-key",transports:F.transports})}}return o}function iU(r){if(!r)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(r);const{challenge:s,allowCredentials:c}=r,m=iR(r,["challenge","allowCredentials"]),v=xp(s).buffer,S=Object.assign(Object.assign({},m),{challenge:v});if(c&&c.length>0){S.allowCredentials=new Array(c.length);for(let C=0;C<c.length;C++){const o=c[C];S.allowCredentials[C]=Object.assign(Object.assign({},o),{id:xp(o.id).buffer,type:o.type||"public-key",transports:o.transports})}}return S}function nU(r){var s;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const c=r;return{id:r.id,rawId:r.id,response:{attestationObject:Qd(new Uint8Array(r.response.attestationObject)),clientDataJSON:Qd(new Uint8Array(r.response.clientDataJSON))},type:"public-key",clientExtensionResults:r.getClientExtensionResults(),authenticatorAttachment:(s=c.authenticatorAttachment)!==null&&s!==void 0?s:void 0}}function sU(r){var s;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const c=r,m=r.getClientExtensionResults(),v=r.response;return{id:r.id,rawId:r.id,response:{authenticatorData:Qd(new Uint8Array(v.authenticatorData)),clientDataJSON:Qd(new Uint8Array(v.clientDataJSON)),signature:Qd(new Uint8Array(v.signature)),userHandle:v.userHandle?Qd(new Uint8Array(v.userHandle)):void 0},type:"public-key",clientExtensionResults:m,authenticatorAttachment:(s=c.authenticatorAttachment)!==null&&s!==void 0?s:void 0}}function nR(r){return r==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(r)}function kP(){var r,s;return!!(Vo()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((r=navigator==null?void 0:navigator.credentials)===null||r===void 0?void 0:r.create)=="function"&&typeof((s=navigator==null?void 0:navigator.credentials)===null||s===void 0?void 0:s.get)=="function")}async function oU(r){try{const s=await navigator.credentials.create(r);return s?s instanceof PublicKeyCredential?{data:s,error:null}:{data:null,error:new iv("Browser returned unexpected credential type",s)}:{data:null,error:new iv("Empty credential response",s)}}catch(s){return{data:null,error:JB({error:s,options:r})}}}async function aU(r){try{const s=await navigator.credentials.get(r);return s?s instanceof PublicKeyCredential?{data:s,error:null}:{data:null,error:new iv("Browser returned unexpected credential type",s)}:{data:null,error:new iv("Empty credential response",s)}}catch(s){return{data:null,error:QB({error:s,options:r})}}}const lU={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"none"},cU={userVerification:"preferred",hints:["security-key"]};function nv(...r){const s=v=>v!==null&&typeof v=="object"&&!Array.isArray(v),c=v=>v instanceof ArrayBuffer||ArrayBuffer.isView(v),m={};for(const v of r)if(v)for(const S in v){const C=v[S];if(C!==void 0)if(Array.isArray(C))m[S]=C;else if(c(C))m[S]=C;else if(s(C)){const o=m[S];s(o)?m[S]=nv(o,C):m[S]=nv(C)}else m[S]=C}return m}function uU(r,s){return nv(lU,r,s||{})}function dU(r,s){return nv(cU,r,s||{})}class hU{constructor(s){this.client=s,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(s){return this.client.mfa.enroll(Object.assign(Object.assign({},s),{factorType:"webauthn"}))}async _challenge({factorId:s,webauthn:c,friendlyName:m,signal:v},S){try{const{data:C,error:o}=await this.client.mfa.challenge({factorId:s,webauthn:c});if(!C)return{data:null,error:o};const L=v??tU.createNewAbortSignal();if(C.webauthn.type==="create"){const{user:F}=C.webauthn.credential_options.publicKey;F.name||(F.name=`${F.id}:${m}`),F.displayName||(F.displayName=F.name)}switch(C.webauthn.type){case"create":{const F=uU(C.webauthn.credential_options.publicKey,S==null?void 0:S.create),{data:Z,error:$}=await oU({publicKey:F,signal:L});return Z?{data:{factorId:s,challengeId:C.id,webauthn:{type:C.webauthn.type,credential_response:Z}},error:null}:{data:null,error:$}}case"request":{const F=dU(C.webauthn.credential_options.publicKey,S==null?void 0:S.request),{data:Z,error:$}=await aU(Object.assign(Object.assign({},C.webauthn.credential_options),{publicKey:F,signal:L}));return Z?{data:{factorId:s,challengeId:C.id,webauthn:{type:C.webauthn.type,credential_response:Z}},error:null}:{data:null,error:$}}}}catch(C){return Hr(C)?{data:null,error:C}:{data:null,error:new Xd("Unexpected error in challenge",C)}}}async _verify({challengeId:s,factorId:c,webauthn:m}){return this.client.mfa.verify({factorId:c,challengeId:s,webauthn:m})}async _authenticate({factorId:s,webauthn:{rpId:c=typeof window<"u"?window.location.hostname:void 0,rpOrigins:m=typeof window<"u"?[window.location.origin]:void 0,signal:v}},S){if(!c)return{data:null,error:new A_("rpId is required for WebAuthn authentication")};try{if(!kP())return{data:null,error:new Xd("Browser does not support WebAuthn",null)};const{data:C,error:o}=await this.challenge({factorId:s,webauthn:{rpId:c,rpOrigins:m},signal:v},{request:S});if(!C)return{data:null,error:o};const{webauthn:L}=C;return this._verify({factorId:s,challengeId:C.challengeId,webauthn:{type:L.type,rpId:c,rpOrigins:m,credential_response:L.credential_response}})}catch(C){return Hr(C)?{data:null,error:C}:{data:null,error:new Xd("Unexpected error in authenticate",C)}}}async _register({friendlyName:s,rpId:c=typeof window<"u"?window.location.hostname:void 0,rpOrigins:m=typeof window<"u"?[window.location.origin]:void 0,signal:v},S){if(!c)return{data:null,error:new A_("rpId is required for WebAuthn registration")};try{if(!kP())return{data:null,error:new Xd("Browser does not support WebAuthn",null)};const{data:C,error:o}=await this._enroll({friendlyName:s});if(!C)return await this.client.mfa.listFactors().then(Z=>{var $;return($=Z.data)===null||$===void 0?void 0:$.all.find(W=>W.factor_type==="webauthn"&&W.friendly_name===s&&W.status!=="unverified")}).then(Z=>Z?this.client.mfa.unenroll({factorId:Z==null?void 0:Z.id}):void 0),{data:null,error:o};const{data:L,error:F}=await this._challenge({factorId:C.id,friendlyName:C.friendly_name,webauthn:{rpId:c,rpOrigins:m},signal:v},{create:S});return L?this._verify({factorId:C.id,challengeId:L.challengeId,webauthn:{rpId:c,rpOrigins:m,type:L.webauthn.type,credential_response:L.webauthn.credential_response}}):{data:null,error:F}}catch(C){return Hr(C)?{data:null,error:C}:{data:null,error:new Xd("Unexpected error in register",C)}}}}ZB();const fU={url:lB,storageKey:cB,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:uB,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function MP(r,s,c){return await c()}const Yf={};class P_{get jwks(){var s,c;return(c=(s=Yf[this.storageKey])===null||s===void 0?void 0:s.jwks)!==null&&c!==void 0?c:{keys:[]}}set jwks(s){Yf[this.storageKey]=Object.assign(Object.assign({},Yf[this.storageKey]),{jwks:s})}get jwks_cached_at(){var s,c;return(c=(s=Yf[this.storageKey])===null||s===void 0?void 0:s.cachedAt)!==null&&c!==void 0?c:Number.MIN_SAFE_INTEGER}set jwks_cached_at(s){Yf[this.storageKey]=Object.assign(Object.assign({},Yf[this.storageKey]),{cachedAt:s})}constructor(s){var c,m;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=P_.nextInstanceID,P_.nextInstanceID+=1,this.instanceID>0&&Vo()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const v=Object.assign(Object.assign({},fU),s);if(this.logDebugMessages=!!v.debug,typeof v.debug=="function"&&(this.logger=v.debug),this.persistSession=v.persistSession,this.storageKey=v.storageKey,this.autoRefreshToken=v.autoRefreshToken,this.admin=new qB({url:v.url,headers:v.headers,fetch:v.fetch}),this.url=v.url,this.headers=v.headers,this.fetch=eR(v.fetch),this.lock=v.lock||MP,this.detectSessionInUrl=v.detectSessionInUrl,this.flowType=v.flowType,this.hasCustomAuthorizationHeader=v.hasCustomAuthorizationHeader,v.lock?this.lock=v.lock:Vo()&&(!((c=globalThis==null?void 0:globalThis.navigator)===null||c===void 0)&&c.locks)?this.lock=WB:this.lock=MP,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new hU(this)},this.persistSession?(v.storage?this.storage=v.storage:QN()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=PP(this.memoryStorage)),v.userStorage&&(this.userStorage=v.userStorage)):(this.memoryStorage={},this.storage=PP(this.memoryStorage)),Vo()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(S){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",S)}(m=this.broadcastChannel)===null||m===void 0||m.addEventListener("message",async S=>{this._debug("received broadcast notification from other tab or client",S),await this._notifyAllSubscribers(S.data.event,S.data.session,!1)})}this.initialize()}_debug(...s){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${YN}) ${new Date().toISOString()}`,...s),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var s;try{const c=TB(window.location.href);let m="none";if(this._isImplicitGrantCallback(c)?m="implicit":await this._isPKCECallback(c)&&(m="pkce"),Vo()&&this.detectSessionInUrl&&m!=="none"){const{data:v,error:S}=await this._getSessionFromURL(c,m);if(S){if(this._debug("#_initialize()","error detecting session from URL",S),gB(S)){const L=(s=S.details)===null||s===void 0?void 0:s.code;if(L==="identity_already_exists"||L==="identity_not_found"||L==="single_identity_not_deletable")return{error:S}}return await this._removeSession(),{error:S}}const{session:C,redirectType:o}=v;return this._debug("#_initialize()","detected session in URL",C,"redirect type",o),await this._saveSession(C),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",C):await this._notifyAllSubscribers("SIGNED_IN",C)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(c){return Hr(c)?{error:c}:{error:new Xd("Unexpected error during initialization",c)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(s){var c,m,v;try{const S=await di(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(m=(c=s==null?void 0:s.options)===null||c===void 0?void 0:c.data)!==null&&m!==void 0?m:{},gotrue_meta_security:{captcha_token:(v=s==null?void 0:s.options)===null||v===void 0?void 0:v.captchaToken}},xform:Da}),{data:C,error:o}=S;if(o||!C)return{data:{user:null,session:null},error:o};const L=C.session,F=C.user;return C.session&&(await this._saveSession(C.session),await this._notifyAllSubscribers("SIGNED_IN",L)),{data:{user:F,session:L},error:null}}catch(S){if(Hr(S))return{data:{user:null,session:null},error:S};throw S}}async signUp(s){var c,m,v;try{let S;if("email"in s){const{email:Z,password:$,options:W}=s;let ee=null,ie=null;this.flowType==="pkce"&&([ee,ie]=await Wf(this.storage,this.storageKey)),S=await di(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:W==null?void 0:W.emailRedirectTo,body:{email:Z,password:$,data:(c=W==null?void 0:W.data)!==null&&c!==void 0?c:{},gotrue_meta_security:{captcha_token:W==null?void 0:W.captchaToken},code_challenge:ee,code_challenge_method:ie},xform:Da})}else if("phone"in s){const{phone:Z,password:$,options:W}=s;S=await di(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:Z,password:$,data:(m=W==null?void 0:W.data)!==null&&m!==void 0?m:{},channel:(v=W==null?void 0:W.channel)!==null&&v!==void 0?v:"sms",gotrue_meta_security:{captcha_token:W==null?void 0:W.captchaToken}},xform:Da})}else throw new ax("You must provide either an email or phone number and a password");const{data:C,error:o}=S;if(o||!C)return{data:{user:null,session:null},error:o};const L=C.session,F=C.user;return C.session&&(await this._saveSession(C.session),await this._notifyAllSubscribers("SIGNED_IN",L)),{data:{user:F,session:L},error:null}}catch(S){if(Hr(S))return{data:{user:null,session:null},error:S};throw S}}async signInWithPassword(s){try{let c;if("email"in s){const{email:S,password:C,options:o}=s;c=await di(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:S,password:C,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:CP})}else if("phone"in s){const{phone:S,password:C,options:o}=s;c=await di(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:S,password:C,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:CP})}else throw new ax("You must provide either an email or phone number and a password");const{data:m,error:v}=c;return v?{data:{user:null,session:null},error:v}:!m||!m.session||!m.user?{data:{user:null,session:null},error:new Hf}:(m.session&&(await this._saveSession(m.session),await this._notifyAllSubscribers("SIGNED_IN",m.session)),{data:Object.assign({user:m.user,session:m.session},m.weak_password?{weakPassword:m.weak_password}:null),error:v})}catch(c){if(Hr(c))return{data:{user:null,session:null},error:c};throw c}}async signInWithOAuth(s){var c,m,v,S;return await this._handleProviderSignIn(s.provider,{redirectTo:(c=s.options)===null||c===void 0?void 0:c.redirectTo,scopes:(m=s.options)===null||m===void 0?void 0:m.scopes,queryParams:(v=s.options)===null||v===void 0?void 0:v.queryParams,skipBrowserRedirect:(S=s.options)===null||S===void 0?void 0:S.skipBrowserRedirect})}async exchangeCodeForSession(s){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(s))}async signInWithWeb3(s){const{chain:c}=s;switch(c){case"ethereum":return await this.signInWithEthereum(s);case"solana":return await this.signInWithSolana(s);default:throw new Error(`@supabase/auth-js: Unsupported chain "${c}"`)}}async signInWithEthereum(s){var c,m,v,S,C,o,L,F,Z,$,W;let ee,ie;if("message"in s)ee=s.message,ie=s.signature;else{const{chain:ae,wallet:ke,statement:le,options:se}=s;let J;if(Vo())if(typeof ke=="object")J=ke;else{const We=window;if("ethereum"in We&&typeof We.ethereum=="object"&&"request"in We.ethereum&&typeof We.ethereum.request=="function")J=We.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof ke!="object"||!(se!=null&&se.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");J=ke}const Ee=new URL((c=se==null?void 0:se.url)!==null&&c!==void 0?c:window.location.href),je=await J.request({method:"eth_requestAccounts"}).then(We=>We).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!je||je.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const Xe=rR(je[0]);let tt=(m=se==null?void 0:se.signInWithEthereum)===null||m===void 0?void 0:m.chainId;if(!tt){const We=await J.request({method:"eth_chainId"});tt=XB(We)}const it={domain:Ee.host,address:Xe,statement:le,uri:Ee.href,version:"1",chainId:tt,nonce:(v=se==null?void 0:se.signInWithEthereum)===null||v===void 0?void 0:v.nonce,issuedAt:(C=(S=se==null?void 0:se.signInWithEthereum)===null||S===void 0?void 0:S.issuedAt)!==null&&C!==void 0?C:new Date,expirationTime:(o=se==null?void 0:se.signInWithEthereum)===null||o===void 0?void 0:o.expirationTime,notBefore:(L=se==null?void 0:se.signInWithEthereum)===null||L===void 0?void 0:L.notBefore,requestId:(F=se==null?void 0:se.signInWithEthereum)===null||F===void 0?void 0:F.requestId,resources:(Z=se==null?void 0:se.signInWithEthereum)===null||Z===void 0?void 0:Z.resources};ee=KB(it),ie=await J.request({method:"personal_sign",params:[YB(ee),Xe]})}try{const{data:ae,error:ke}=await di(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:ee,signature:ie},!(($=s.options)===null||$===void 0)&&$.captchaToken?{gotrue_meta_security:{captcha_token:(W=s.options)===null||W===void 0?void 0:W.captchaToken}}:null),xform:Da});if(ke)throw ke;return!ae||!ae.session||!ae.user?{data:{user:null,session:null},error:new Hf}:(ae.session&&(await this._saveSession(ae.session),await this._notifyAllSubscribers("SIGNED_IN",ae.session)),{data:Object.assign({},ae),error:ke})}catch(ae){if(Hr(ae))return{data:{user:null,session:null},error:ae};throw ae}}async signInWithSolana(s){var c,m,v,S,C,o,L,F,Z,$,W,ee;let ie,ae;if("message"in s)ie=s.message,ae=s.signature;else{const{chain:ke,wallet:le,statement:se,options:J}=s;let Ee;if(Vo())if(typeof le=="object")Ee=le;else{const Xe=window;if("solana"in Xe&&typeof Xe.solana=="object"&&("signIn"in Xe.solana&&typeof Xe.solana.signIn=="function"||"signMessage"in Xe.solana&&typeof Xe.solana.signMessage=="function"))Ee=Xe.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof le!="object"||!(J!=null&&J.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");Ee=le}const je=new URL((c=J==null?void 0:J.url)!==null&&c!==void 0?c:window.location.href);if("signIn"in Ee&&Ee.signIn){const Xe=await Ee.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},J==null?void 0:J.signInWithSolana),{version:"1",domain:je.host,uri:je.href}),se?{statement:se}:null));let tt;if(Array.isArray(Xe)&&Xe[0]&&typeof Xe[0]=="object")tt=Xe[0];else if(Xe&&typeof Xe=="object"&&"signedMessage"in Xe&&"signature"in Xe)tt=Xe;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in tt&&"signature"in tt&&(typeof tt.signedMessage=="string"||tt.signedMessage instanceof Uint8Array)&&tt.signature instanceof Uint8Array)ie=typeof tt.signedMessage=="string"?tt.signedMessage:new TextDecoder().decode(tt.signedMessage),ae=tt.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in Ee)||typeof Ee.signMessage!="function"||!("publicKey"in Ee)||typeof Ee!="object"||!Ee.publicKey||!("toBase58"in Ee.publicKey)||typeof Ee.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");ie=[`${je.host} wants you to sign in with your Solana account:`,Ee.publicKey.toBase58(),...se?["",se,""]:[""],"Version: 1",`URI: ${je.href}`,`Issued At: ${(v=(m=J==null?void 0:J.signInWithSolana)===null||m===void 0?void 0:m.issuedAt)!==null&&v!==void 0?v:new Date().toISOString()}`,...!((S=J==null?void 0:J.signInWithSolana)===null||S===void 0)&&S.notBefore?[`Not Before: ${J.signInWithSolana.notBefore}`]:[],...!((C=J==null?void 0:J.signInWithSolana)===null||C===void 0)&&C.expirationTime?[`Expiration Time: ${J.signInWithSolana.expirationTime}`]:[],...!((o=J==null?void 0:J.signInWithSolana)===null||o===void 0)&&o.chainId?[`Chain ID: ${J.signInWithSolana.chainId}`]:[],...!((L=J==null?void 0:J.signInWithSolana)===null||L===void 0)&&L.nonce?[`Nonce: ${J.signInWithSolana.nonce}`]:[],...!((F=J==null?void 0:J.signInWithSolana)===null||F===void 0)&&F.requestId?[`Request ID: ${J.signInWithSolana.requestId}`]:[],...!(($=(Z=J==null?void 0:J.signInWithSolana)===null||Z===void 0?void 0:Z.resources)===null||$===void 0)&&$.length?["Resources",...J.signInWithSolana.resources.map(tt=>`- ${tt}`)]:[]].join(`
`);const Xe=await Ee.signMessage(new TextEncoder().encode(ie),"utf8");if(!Xe||!(Xe instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");ae=Xe}}try{const{data:ke,error:le}=await di(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:ie,signature:Qd(ae)},!((W=s.options)===null||W===void 0)&&W.captchaToken?{gotrue_meta_security:{captcha_token:(ee=s.options)===null||ee===void 0?void 0:ee.captchaToken}}:null),xform:Da});if(le)throw le;return!ke||!ke.session||!ke.user?{data:{user:null,session:null},error:new Hf}:(ke.session&&(await this._saveSession(ke.session),await this._notifyAllSubscribers("SIGNED_IN",ke.session)),{data:Object.assign({},ke),error:le})}catch(ke){if(Hr(ke))return{data:{user:null,session:null},error:ke};throw ke}}async _exchangeCodeForSession(s){const c=await Bd(this.storage,`${this.storageKey}-code-verifier`),[m,v]=(c??"").split("/");try{const{data:S,error:C}=await di(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:s,code_verifier:m},xform:Da});if(await gu(this.storage,`${this.storageKey}-code-verifier`),C)throw C;return!S||!S.session||!S.user?{data:{user:null,session:null,redirectType:null},error:new Hf}:(S.session&&(await this._saveSession(S.session),await this._notifyAllSubscribers("SIGNED_IN",S.session)),{data:Object.assign(Object.assign({},S),{redirectType:v??null}),error:C})}catch(S){if(Hr(S))return{data:{user:null,session:null,redirectType:null},error:S};throw S}}async signInWithIdToken(s){try{const{options:c,provider:m,token:v,access_token:S,nonce:C}=s,o=await di(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:m,id_token:v,access_token:S,nonce:C,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken}},xform:Da}),{data:L,error:F}=o;return F?{data:{user:null,session:null},error:F}:!L||!L.session||!L.user?{data:{user:null,session:null},error:new Hf}:(L.session&&(await this._saveSession(L.session),await this._notifyAllSubscribers("SIGNED_IN",L.session)),{data:L,error:F})}catch(c){if(Hr(c))return{data:{user:null,session:null},error:c};throw c}}async signInWithOtp(s){var c,m,v,S,C;try{if("email"in s){const{email:o,options:L}=s;let F=null,Z=null;this.flowType==="pkce"&&([F,Z]=await Wf(this.storage,this.storageKey));const{error:$}=await di(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(c=L==null?void 0:L.data)!==null&&c!==void 0?c:{},create_user:(m=L==null?void 0:L.shouldCreateUser)!==null&&m!==void 0?m:!0,gotrue_meta_security:{captcha_token:L==null?void 0:L.captchaToken},code_challenge:F,code_challenge_method:Z},redirectTo:L==null?void 0:L.emailRedirectTo});return{data:{user:null,session:null},error:$}}if("phone"in s){const{phone:o,options:L}=s,{data:F,error:Z}=await di(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(v=L==null?void 0:L.data)!==null&&v!==void 0?v:{},create_user:(S=L==null?void 0:L.shouldCreateUser)!==null&&S!==void 0?S:!0,gotrue_meta_security:{captcha_token:L==null?void 0:L.captchaToken},channel:(C=L==null?void 0:L.channel)!==null&&C!==void 0?C:"sms"}});return{data:{user:null,session:null,messageId:F==null?void 0:F.message_id},error:Z}}throw new ax("You must provide either an email or phone number.")}catch(o){if(Hr(o))return{data:{user:null,session:null},error:o};throw o}}async verifyOtp(s){var c,m;try{let v,S;"options"in s&&(v=(c=s.options)===null||c===void 0?void 0:c.redirectTo,S=(m=s.options)===null||m===void 0?void 0:m.captchaToken);const{data:C,error:o}=await di(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},s),{gotrue_meta_security:{captcha_token:S}}),redirectTo:v,xform:Da});if(o)throw o;if(!C)throw new Error("An error occurred on token verification.");const L=C.session,F=C.user;return L!=null&&L.access_token&&(await this._saveSession(L),await this._notifyAllSubscribers(s.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",L)),{data:{user:F,session:L},error:null}}catch(v){if(Hr(v))return{data:{user:null,session:null},error:v};throw v}}async signInWithSSO(s){var c,m,v;try{let S=null,C=null;return this.flowType==="pkce"&&([S,C]=await Wf(this.storage,this.storageKey)),await di(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in s?{provider_id:s.providerId}:null),"domain"in s?{domain:s.domain}:null),{redirect_to:(m=(c=s.options)===null||c===void 0?void 0:c.redirectTo)!==null&&m!==void 0?m:void 0}),!((v=s==null?void 0:s.options)===null||v===void 0)&&v.captchaToken?{gotrue_meta_security:{captcha_token:s.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:S,code_challenge_method:C}),headers:this.headers,xform:UB})}catch(S){if(Hr(S))return{data:null,error:S};throw S}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async s=>{const{data:{session:c},error:m}=s;if(m)throw m;if(!c)throw new yu;const{error:v}=await di(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:c.access_token});return{data:{user:null,session:null},error:v}})}catch(s){if(Hr(s))return{data:{user:null,session:null},error:s};throw s}}async resend(s){try{const c=`${this.url}/resend`;if("email"in s){const{email:m,type:v,options:S}=s,{error:C}=await di(this.fetch,"POST",c,{headers:this.headers,body:{email:m,type:v,gotrue_meta_security:{captcha_token:S==null?void 0:S.captchaToken}},redirectTo:S==null?void 0:S.emailRedirectTo});return{data:{user:null,session:null},error:C}}else if("phone"in s){const{phone:m,type:v,options:S}=s,{data:C,error:o}=await di(this.fetch,"POST",c,{headers:this.headers,body:{phone:m,type:v,gotrue_meta_security:{captcha_token:S==null?void 0:S.captchaToken}}});return{data:{user:null,session:null,messageId:C==null?void 0:C.message_id},error:o}}throw new ax("You must provide either an email or phone number and a type")}catch(c){if(Hr(c))return{data:{user:null,session:null},error:c};throw c}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async c=>c))}async _acquireLock(s,c){this._debug("#_acquireLock","begin",s);try{if(this.lockAcquired){const m=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),v=(async()=>(await m,await c()))();return this.pendingInLock.push((async()=>{try{await v}catch{}})()),v}return await this.lock(`lock:${this.storageKey}`,s,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const m=c();for(this.pendingInLock.push((async()=>{try{await m}catch{}})()),await m;this.pendingInLock.length;){const v=[...this.pendingInLock];await Promise.all(v),this.pendingInLock.splice(0,v.length)}return await m}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(s){this._debug("#_useSession","begin");try{const c=await this.__loadSession();return await s(c)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let s=null;const c=await Bd(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",c),c!==null&&(this._isValidSession(c)?s=c:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!s)return{data:{session:null},error:null};const m=s.expires_at?s.expires_at*1e3-Date.now()<y1:!1;if(this._debug("#__loadSession()",`session has${m?"":" not"} expired`,"expires_at",s.expires_at),!m){if(this.userStorage){const C=await Bd(this.userStorage,this.storageKey+"-user");C!=null&&C.user?s.user=C.user:s.user=b1()}if(this.storage.isServer&&s.user){let C=this.suppressGetSessionWarning;s=new Proxy(s,{get:(L,F,Z)=>(!C&&F==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),C=!0,this.suppressGetSessionWarning=!0),Reflect.get(L,F,Z))})}return{data:{session:s},error:null}}const{data:v,error:S}=await this._callRefreshToken(s.refresh_token);return S?{data:{session:null},error:S}:{data:{session:v},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(s){return s?await this._getUser(s):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(s){try{return s?await di(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:s,xform:Su}):await this._useSession(async c=>{var m,v,S;const{data:C,error:o}=c;if(o)throw o;return!(!((m=C.session)===null||m===void 0)&&m.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new yu}:await di(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(S=(v=C.session)===null||v===void 0?void 0:v.access_token)!==null&&S!==void 0?S:void 0,xform:Su})})}catch(c){if(Hr(c))return mB(c)&&(await this._removeSession(),await gu(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:c};throw c}}async updateUser(s,c={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(s,c))}async _updateUser(s,c={}){try{return await this._useSession(async m=>{const{data:v,error:S}=m;if(S)throw S;if(!v.session)throw new yu;const C=v.session;let o=null,L=null;this.flowType==="pkce"&&s.email!=null&&([o,L]=await Wf(this.storage,this.storageKey));const{data:F,error:Z}=await di(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:c==null?void 0:c.emailRedirectTo,body:Object.assign(Object.assign({},s),{code_challenge:o,code_challenge_method:L}),jwt:C.access_token,xform:Su});if(Z)throw Z;return C.user=F.user,await this._saveSession(C),await this._notifyAllSubscribers("USER_UPDATED",C),{data:{user:C.user},error:null}})}catch(m){if(Hr(m))return{data:{user:null},error:m};throw m}}async setSession(s){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(s))}async _setSession(s){try{if(!s.access_token||!s.refresh_token)throw new yu;const c=Date.now()/1e3;let m=c,v=!0,S=null;const{payload:C}=v1(s.access_token);if(C.exp&&(m=C.exp,v=m<=c),v){const{data:o,error:L}=await this._callRefreshToken(s.refresh_token);if(L)return{data:{user:null,session:null},error:L};if(!o)return{data:{user:null,session:null},error:null};S=o}else{const{data:o,error:L}=await this._getUser(s.access_token);if(L)throw L;S={access_token:s.access_token,refresh_token:s.refresh_token,user:o.user,token_type:"bearer",expires_in:m-c,expires_at:m},await this._saveSession(S),await this._notifyAllSubscribers("SIGNED_IN",S)}return{data:{user:S.user,session:S},error:null}}catch(c){if(Hr(c))return{data:{session:null,user:null},error:c};throw c}}async refreshSession(s){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(s))}async _refreshSession(s){try{return await this._useSession(async c=>{var m;if(!s){const{data:C,error:o}=c;if(o)throw o;s=(m=C.session)!==null&&m!==void 0?m:void 0}if(!(s!=null&&s.refresh_token))throw new yu;const{data:v,error:S}=await this._callRefreshToken(s.refresh_token);return S?{data:{user:null,session:null},error:S}:v?{data:{user:v.user,session:v},error:null}:{data:{user:null,session:null},error:null}})}catch(c){if(Hr(c))return{data:{user:null,session:null},error:c};throw c}}async _getSessionFromURL(s,c){try{if(!Vo())throw new lx("No browser detected.");if(s.error||s.error_description||s.error_code)throw new lx(s.error_description||"Error in URL with unspecified error_description",{error:s.error||"unspecified_error",code:s.error_code||"unspecified_code"});switch(c){case"implicit":if(this.flowType==="pkce")throw new vP("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new lx("Not a valid implicit grant flow url.");break;default:}if(c==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!s.code)throw new vP("No code detected.");const{data:se,error:J}=await this._exchangeCodeForSession(s.code);if(J)throw J;const Ee=new URL(window.location.href);return Ee.searchParams.delete("code"),window.history.replaceState(window.history.state,"",Ee.toString()),{data:{session:se.session,redirectType:null},error:null}}const{provider_token:m,provider_refresh_token:v,access_token:S,refresh_token:C,expires_in:o,expires_at:L,token_type:F}=s;if(!S||!o||!C||!F)throw new lx("No session defined in URL");const Z=Math.round(Date.now()/1e3),$=parseInt(o);let W=Z+$;L&&(W=parseInt(L));const ee=W-Z;ee*1e3<=Jf&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${ee}s, should have been closer to ${$}s`);const ie=W-$;Z-ie>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",ie,W,Z):Z-ie<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",ie,W,Z);const{data:ae,error:ke}=await this._getUser(S);if(ke)throw ke;const le={provider_token:m,provider_refresh_token:v,access_token:S,expires_in:$,expires_at:W,refresh_token:C,token_type:F,user:ae.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:le,redirectType:s.type},error:null}}catch(m){if(Hr(m))return{data:{session:null,redirectType:null},error:m};throw m}}_isImplicitGrantCallback(s){return!!(s.access_token||s.error_description)}async _isPKCECallback(s){const c=await Bd(this.storage,`${this.storageKey}-code-verifier`);return!!(s.code&&c)}async signOut(s={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(s))}async _signOut({scope:s}={scope:"global"}){return await this._useSession(async c=>{var m;const{data:v,error:S}=c;if(S)return{error:S};const C=(m=v.session)===null||m===void 0?void 0:m.access_token;if(C){const{error:o}=await this.admin.signOut(C,s);if(o&&!(pB(o)&&(o.status===404||o.status===401||o.status===403)))return{error:o}}return s!=="others"&&(await this._removeSession(),await gu(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(s){const c=SB(),m={id:c,callback:s,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",c),this.stateChangeEmitters.delete(c)}};return this._debug("#onAuthStateChange()","registered callback with id",c),this.stateChangeEmitters.set(c,m),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(c)})))(),{data:{subscription:m}}}async _emitInitialSession(s){return await this._useSession(async c=>{var m,v;try{const{data:{session:S},error:C}=c;if(C)throw C;await((m=this.stateChangeEmitters.get(s))===null||m===void 0?void 0:m.callback("INITIAL_SESSION",S)),this._debug("INITIAL_SESSION","callback id",s,"session",S)}catch(S){await((v=this.stateChangeEmitters.get(s))===null||v===void 0?void 0:v.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",s,"error",S),console.error(S)}})}async resetPasswordForEmail(s,c={}){let m=null,v=null;this.flowType==="pkce"&&([m,v]=await Wf(this.storage,this.storageKey,!0));try{return await di(this.fetch,"POST",`${this.url}/recover`,{body:{email:s,code_challenge:m,code_challenge_method:v,gotrue_meta_security:{captcha_token:c.captchaToken}},headers:this.headers,redirectTo:c.redirectTo})}catch(S){if(Hr(S))return{data:null,error:S};throw S}}async getUserIdentities(){var s;try{const{data:c,error:m}=await this.getUser();if(m)throw m;return{data:{identities:(s=c.user.identities)!==null&&s!==void 0?s:[]},error:null}}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async linkIdentity(s){return"token"in s?this.linkIdentityIdToken(s):this.linkIdentityOAuth(s)}async linkIdentityOAuth(s){var c;try{const{data:m,error:v}=await this._useSession(async S=>{var C,o,L,F,Z;const{data:$,error:W}=S;if(W)throw W;const ee=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,s.provider,{redirectTo:(C=s.options)===null||C===void 0?void 0:C.redirectTo,scopes:(o=s.options)===null||o===void 0?void 0:o.scopes,queryParams:(L=s.options)===null||L===void 0?void 0:L.queryParams,skipBrowserRedirect:!0});return await di(this.fetch,"GET",ee,{headers:this.headers,jwt:(Z=(F=$.session)===null||F===void 0?void 0:F.access_token)!==null&&Z!==void 0?Z:void 0})});if(v)throw v;return Vo()&&!(!((c=s.options)===null||c===void 0)&&c.skipBrowserRedirect)&&window.location.assign(m==null?void 0:m.url),{data:{provider:s.provider,url:m==null?void 0:m.url},error:null}}catch(m){if(Hr(m))return{data:{provider:s.provider,url:null},error:m};throw m}}async linkIdentityIdToken(s){return await this._useSession(async c=>{var m;try{const{error:v,data:{session:S}}=c;if(v)throw v;const{options:C,provider:o,token:L,access_token:F,nonce:Z}=s,$=await di(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(m=S==null?void 0:S.access_token)!==null&&m!==void 0?m:void 0,body:{provider:o,id_token:L,access_token:F,nonce:Z,link_identity:!0,gotrue_meta_security:{captcha_token:C==null?void 0:C.captchaToken}},xform:Da}),{data:W,error:ee}=$;return ee?{data:{user:null,session:null},error:ee}:!W||!W.session||!W.user?{data:{user:null,session:null},error:new Hf}:(W.session&&(await this._saveSession(W.session),await this._notifyAllSubscribers("USER_UPDATED",W.session)),{data:W,error:ee})}catch(v){if(Hr(v))return{data:{user:null,session:null},error:v};throw v}})}async unlinkIdentity(s){try{return await this._useSession(async c=>{var m,v;const{data:S,error:C}=c;if(C)throw C;return await di(this.fetch,"DELETE",`${this.url}/user/identities/${s.identity_id}`,{headers:this.headers,jwt:(v=(m=S.session)===null||m===void 0?void 0:m.access_token)!==null&&v!==void 0?v:void 0})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _refreshAccessToken(s){const c=`#_refreshAccessToken(${s.substring(0,5)}...)`;this._debug(c,"begin");try{const m=Date.now();return await CB(async v=>(v>0&&await IB(200*Math.pow(2,v-1)),this._debug(c,"refreshing attempt",v),await di(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:s},headers:this.headers,xform:Da})),(v,S)=>{const C=200*Math.pow(2,v);return S&&x1(S)&&Date.now()+C-m<Jf})}catch(m){if(this._debug(c,"error",m),Hr(m))return{data:{session:null,user:null},error:m};throw m}finally{this._debug(c,"end")}}_isValidSession(s){return typeof s=="object"&&s!==null&&"access_token"in s&&"refresh_token"in s&&"expires_at"in s}async _handleProviderSignIn(s,c){const m=await this._getUrlForProvider(`${this.url}/authorize`,s,{redirectTo:c.redirectTo,scopes:c.scopes,queryParams:c.queryParams});return this._debug("#_handleProviderSignIn()","provider",s,"options",c,"url",m),Vo()&&!c.skipBrowserRedirect&&window.location.assign(m),{data:{provider:s,url:m},error:null}}async _recoverAndRefresh(){var s,c;const m="#_recoverAndRefresh()";this._debug(m,"begin");try{const v=await Bd(this.storage,this.storageKey);if(v&&this.userStorage){let C=await Bd(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!C&&(C={user:v.user},await Qf(this.userStorage,this.storageKey+"-user",C)),v.user=(s=C==null?void 0:C.user)!==null&&s!==void 0?s:b1()}else if(v&&!v.user&&!v.user){const C=await Bd(this.storage,this.storageKey+"-user");C&&(C!=null&&C.user)?(v.user=C.user,await gu(this.storage,this.storageKey+"-user"),await Qf(this.storage,this.storageKey,v)):v.user=b1()}if(this._debug(m,"session from storage",v),!this._isValidSession(v)){this._debug(m,"session is not valid"),v!==null&&await this._removeSession();return}const S=((c=v.expires_at)!==null&&c!==void 0?c:1/0)*1e3-Date.now()<y1;if(this._debug(m,`session has${S?"":" not"} expired with margin of ${y1}s`),S){if(this.autoRefreshToken&&v.refresh_token){const{error:C}=await this._callRefreshToken(v.refresh_token);C&&(console.error(C),x1(C)||(this._debug(m,"refresh failed with a non-retryable error, removing the session",C),await this._removeSession()))}}else if(v.user&&v.user.__isUserNotAvailableProxy===!0)try{const{data:C,error:o}=await this._getUser(v.access_token);!o&&(C!=null&&C.user)?(v.user=C.user,await this._saveSession(v),await this._notifyAllSubscribers("SIGNED_IN",v)):this._debug(m,"could not get user data, skipping SIGNED_IN notification")}catch(C){console.error("Error getting user data:",C),this._debug(m,"error getting user data, skipping SIGNED_IN notification",C)}else await this._notifyAllSubscribers("SIGNED_IN",v)}catch(v){this._debug(m,"error",v),console.error(v);return}finally{this._debug(m,"end")}}async _callRefreshToken(s){var c,m;if(!s)throw new yu;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const v=`#_callRefreshToken(${s.substring(0,5)}...)`;this._debug(v,"begin");try{this.refreshingDeferred=new kv;const{data:S,error:C}=await this._refreshAccessToken(s);if(C)throw C;if(!S.session)throw new yu;await this._saveSession(S.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",S.session);const o={data:S.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(S){if(this._debug(v,"error",S),Hr(S)){const C={data:null,error:S};return x1(S)||await this._removeSession(),(c=this.refreshingDeferred)===null||c===void 0||c.resolve(C),C}throw(m=this.refreshingDeferred)===null||m===void 0||m.reject(S),S}finally{this.refreshingDeferred=null,this._debug(v,"end")}}async _notifyAllSubscribers(s,c,m=!0){const v=`#_notifyAllSubscribers(${s})`;this._debug(v,"begin",c,`broadcast = ${m}`);try{this.broadcastChannel&&m&&this.broadcastChannel.postMessage({event:s,session:c});const S=[],C=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(s,c)}catch(L){S.push(L)}});if(await Promise.all(C),S.length>0){for(let o=0;o<S.length;o+=1)console.error(S[o]);throw S[0]}}finally{this._debug(v,"end")}}async _saveSession(s){this._debug("#_saveSession()",s),this.suppressGetSessionWarning=!0;const c=Object.assign({},s),m=c.user&&c.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!m&&c.user&&await Qf(this.userStorage,this.storageKey+"-user",{user:c.user});const v=Object.assign({},c);delete v.user;const S=EP(v);await Qf(this.storage,this.storageKey,S)}else{const v=EP(c);await Qf(this.storage,this.storageKey,v)}}async _removeSession(){this._debug("#_removeSession()"),await gu(this.storage,this.storageKey),await gu(this.storage,this.storageKey+"-code-verifier"),await gu(this.storage,this.storageKey+"-user"),this.userStorage&&await gu(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const s=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{s&&Vo()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",s)}catch(c){console.error("removing visibilitychange callback failed",c)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const s=setInterval(()=>this._autoRefreshTokenTick(),Jf);this.autoRefreshTicker=s,s&&typeof s=="object"&&typeof s.unref=="function"?s.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(s),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const s=this.autoRefreshTicker;this.autoRefreshTicker=null,s&&clearInterval(s)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const s=Date.now();try{return await this._useSession(async c=>{const{data:{session:m}}=c;if(!m||!m.refresh_token||!m.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const v=Math.floor((m.expires_at*1e3-s)/Jf);this._debug("#_autoRefreshTokenTick()",`access token expires in ${v} ticks, a tick lasts ${Jf}ms, refresh threshold is ${P2} ticks`),v<=P2&&await this._callRefreshToken(m.refresh_token)})}catch(c){console.error("Auto refresh tick failed with error. This is likely a transient error.",c)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(s){if(s.isAcquireTimeout||s instanceof tR)this._debug("auto refresh token tick lock not available");else throw s}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Vo()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(s){console.error("_handleVisibilityChange",s)}}async _onVisibilityChanged(s){const c=`#_onVisibilityChanged(${s})`;this._debug(c,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),s||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(c,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(s,c,m){const v=[`provider=${encodeURIComponent(c)}`];if(m!=null&&m.redirectTo&&v.push(`redirect_to=${encodeURIComponent(m.redirectTo)}`),m!=null&&m.scopes&&v.push(`scopes=${encodeURIComponent(m.scopes)}`),this.flowType==="pkce"){const[S,C]=await Wf(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(S)}`,code_challenge_method:`${encodeURIComponent(C)}`});v.push(o.toString())}if(m!=null&&m.queryParams){const S=new URLSearchParams(m.queryParams);v.push(S.toString())}return m!=null&&m.skipBrowserRedirect&&v.push(`skip_http_redirect=${m.skipBrowserRedirect}`),`${s}?${v.join("&")}`}async _unenroll(s){try{return await this._useSession(async c=>{var m;const{data:v,error:S}=c;return S?{data:null,error:S}:await di(this.fetch,"DELETE",`${this.url}/factors/${s.factorId}`,{headers:this.headers,jwt:(m=v==null?void 0:v.session)===null||m===void 0?void 0:m.access_token})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _enroll(s){try{return await this._useSession(async c=>{var m,v;const{data:S,error:C}=c;if(C)return{data:null,error:C};const o=Object.assign({friendly_name:s.friendlyName,factor_type:s.factorType},s.factorType==="phone"?{phone:s.phone}:s.factorType==="totp"?{issuer:s.issuer}:{}),{data:L,error:F}=await di(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(m=S==null?void 0:S.session)===null||m===void 0?void 0:m.access_token});return F?{data:null,error:F}:(s.factorType==="totp"&&L.type==="totp"&&(!((v=L==null?void 0:L.totp)===null||v===void 0)&&v.qr_code)&&(L.totp.qr_code=`data:image/svg+xml;utf-8,${L.totp.qr_code}`),{data:L,error:null})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}}async _verify(s){return this._acquireLock(-1,async()=>{try{return await this._useSession(async c=>{var m;const{data:v,error:S}=c;if(S)return{data:null,error:S};const C=Object.assign({challenge_id:s.challengeId},"webauthn"in s?{webauthn:Object.assign(Object.assign({},s.webauthn),{credential_response:s.webauthn.type==="create"?nU(s.webauthn.credential_response):sU(s.webauthn.credential_response)})}:{code:s.code}),{data:o,error:L}=await di(this.fetch,"POST",`${this.url}/factors/${s.factorId}/verify`,{body:C,headers:this.headers,jwt:(m=v==null?void 0:v.session)===null||m===void 0?void 0:m.access_token});return L?{data:null,error:L}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),{data:o,error:L})})}catch(c){if(Hr(c))return{data:null,error:c};throw c}})}async _challenge(s){return this._acquireLock(-1,async()=>{try{return await this._useSession(async c=>{var m;const{data:v,error:S}=c;if(S)return{data:null,error:S};const C=await di(this.fetch,"POST",`${this.url}/factors/${s.factorId}/challenge`,{body:s,headers:this.headers,jwt:(m=v==null?void 0:v.session)===null||m===void 0?void 0:m.access_token});if(C.error)return C;const{data:o}=C;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:rU(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:iU(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(c){if(Hr(c))return{data:null,error:c};throw c}})}async _challengeAndVerify(s){const{data:c,error:m}=await this._challenge({factorId:s.factorId});return m?{data:null,error:m}:await this._verify({factorId:s.factorId,challengeId:c.id,code:s.code})}async _listFactors(){var s;const{data:{user:c},error:m}=await this.getUser();if(m)return{data:null,error:m};const v={all:[],phone:[],totp:[],webauthn:[]};for(const S of(s=c==null?void 0:c.factors)!==null&&s!==void 0?s:[])v.all.push(S),S.status==="verified"&&v[S.factor_type].push(S);return{data:v,error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async s=>{var c,m;const{data:{session:v},error:S}=s;if(S)return{data:null,error:S};if(!v)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:C}=v1(v.access_token);let o=null;C.aal&&(o=C.aal);let L=o;((m=(c=v.user.factors)===null||c===void 0?void 0:c.filter($=>$.status==="verified"))!==null&&m!==void 0?m:[]).length>0&&(L="aal2");const Z=C.amr||[];return{data:{currentLevel:o,nextLevel:L,currentAuthenticationMethods:Z},error:null}}))}async fetchJwk(s,c={keys:[]}){let m=c.keys.find(o=>o.kid===s);if(m)return m;const v=Date.now();if(m=this.jwks.keys.find(o=>o.kid===s),m&&this.jwks_cached_at+hB>v)return m;const{data:S,error:C}=await di(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(C)throw C;return!S.keys||S.keys.length===0||(this.jwks=S,this.jwks_cached_at=v,m=S.keys.find(o=>o.kid===s),!m)?null:m}async getClaims(s,c={}){try{let m=s;if(!m){const{data:ee,error:ie}=await this.getSession();if(ie||!ee.session)return{data:null,error:ie};m=ee.session.access_token}const{header:v,payload:S,signature:C,raw:{header:o,payload:L}}=v1(m);c!=null&&c.allowExpired||LB(S.exp);const F=!v.alg||v.alg.startsWith("HS")||!v.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(v.kid,c!=null&&c.keys?{keys:c.keys}:c==null?void 0:c.jwks);if(!F){const{error:ee}=await this.getUser(m);if(ee)throw ee;return{data:{claims:S,header:v,signature:C},error:null}}const Z=OB(v.alg),$=await crypto.subtle.importKey("jwk",F,Z,!0,["verify"]);if(!await crypto.subtle.verify(Z,$,C,bB(`${o}.${L}`)))throw new N2("Invalid JWT signature");return{data:{claims:S,header:v,signature:C},error:null}}catch(m){if(Hr(m))return{data:null,error:m};throw m}}}P_.nextInstanceID=0;const pU=P_;class mU extends pU{constructor(s){super(s)}}var gU=function(r,s,c,m){function v(S){return S instanceof c?S:new c(function(C){C(S)})}return new(c||(c=Promise))(function(S,C){function o(Z){try{F(m.next(Z))}catch($){C($)}}function L(Z){try{F(m.throw(Z))}catch($){C($)}}function F(Z){Z.done?S(Z.value):v(Z.value).then(o,L)}F((m=m.apply(r,s||[])).next())})};class _U{constructor(s,c,m){var v,S,C;this.supabaseUrl=s,this.supabaseKey=c;const o=aB(s);if(!c)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const L=`sb-${o.hostname.split(".")[0]}-auth-token`,F={db:K5,realtime:Q5,auth:Object.assign(Object.assign({},J5),{storageKey:L}),global:Y5},Z=oB(m??{},F);this.storageKey=(v=Z.auth.storageKey)!==null&&v!==void 0?v:"",this.headers=(S=Z.global.headers)!==null&&S!==void 0?S:{},Z.accessToken?(this.accessToken=Z.accessToken,this.auth=new Proxy({},{get:($,W)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(W)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((C=Z.auth)!==null&&C!==void 0?C:{},this.headers,Z.global.fetch),this.fetch=iB(c,this._getAccessToken.bind(this),Z.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},Z.realtime)),this.rest=new f5(new URL("rest/v1",o).href,{headers:this.headers,schema:Z.db.schema,fetch:this.fetch}),this.storage=new W5(this.storageUrl.href,this.headers,this.fetch,m==null?void 0:m.storage),Z.accessToken||this._listenForAuthEvents()}get functions(){return new q4(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(s){return this.rest.from(s)}schema(s){return this.rest.schema(s)}rpc(s,c={},m={head:!1,get:!1,count:void 0}){return this.rest.rpc(s,c,m)}channel(s,c={config:{}}){return this.realtime.channel(s,c)}getChannels(){return this.realtime.getChannels()}removeChannel(s){return this.realtime.removeChannel(s)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){return gU(this,void 0,void 0,function*(){var s,c;if(this.accessToken)return yield this.accessToken();const{data:m}=yield this.auth.getSession();return(c=(s=m.session)===null||s===void 0?void 0:s.access_token)!==null&&c!==void 0?c:this.supabaseKey})}_initSupabaseAuthClient({autoRefreshToken:s,persistSession:c,detectSessionInUrl:m,storage:v,userStorage:S,storageKey:C,flowType:o,lock:L,debug:F},Z,$){const W={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new mU({url:this.authUrl.href,headers:Object.assign(Object.assign({},W),Z),storageKey:C,autoRefreshToken:s,persistSession:c,detectSessionInUrl:m,storage:v,userStorage:S,flowType:o,lock:L,debug:F,fetch:$,hasCustomAuthorizationHeader:Object.keys(this.headers).some(ee=>ee.toLowerCase()==="authorization")})}_initRealtimeClient(s){return new k5(this.realtimeUrl.href,Object.assign(Object.assign({},s),{params:Object.assign({apikey:this.supabaseKey},s==null?void 0:s.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((c,m)=>{this._handleTokenChanged(c,"CLIENT",m==null?void 0:m.access_token)})}_handleTokenChanged(s,c,m){(s==="TOKEN_REFRESHED"||s==="SIGNED_IN")&&this.changedAccessToken!==m?(this.changedAccessToken=m,this.realtime.setAuth(m)):s==="SIGNED_OUT"&&(this.realtime.setAuth(),c=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const yU=(r,s,c)=>new _U(r,s,c);function xU(){if(typeof window<"u"||typeof process>"u")return!1;const r=process.version;if(r==null)return!1;const s=r.match(/^v(\d+)\./);return s?parseInt(s[1],10)<=18:!1}xU()&&console.warn("⚠️  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const vU="https://oqhujdqbszbvozsuunkw.supabase.co",bU="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xaHVqZHFic3pidm96c3V1bmt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY1NDYsImV4cCI6MjA3NjIwMjU0Nn0.Rd0GMUcx1J_UCzwfzW0csZPjjppzp0o64g5nggKq9GM",yr=yU(vU,bU,{auth:{persistSession:!0,autoRefreshToken:!0},realtime:{params:{eventsPerSecond:10}}});function Mv(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!0),[v,S]=Ne.useState(null),C=async(F=!1)=>{try{F||m(!0);const{data:Z,error:$}=await yr.from("entities").select("*").eq("is_visible",!0).is("archived_at",null).order("name",{ascending:!0});if($)throw $;s(Z||[]),S(null)}catch(Z){console.error("❌ Error al cargar entidades:",Z),S(Z.message)}finally{F||m(!1)}};return Ne.useEffect(()=>{C();const F=yr.channel("entities_changes").on("postgres_changes",{event:"*",schema:"public",table:"entities"},Z=>{console.log("🔄 Cambio detectado:",Z),Z.eventType==="INSERT"?s($=>[...$,Z.new]):Z.eventType==="UPDATE"?s($=>$.map(W=>W.id===Z.new.id?Z.new:W)):Z.eventType==="DELETE"&&s($=>$.filter(W=>W.id!==Z.old.id))}).subscribe();return()=>{F.unsubscribe()}},[]),{entities:r,loading:c,error:v,refetch:C,addEntity:F=>{s(Z=>[...Z,F])},removeEntity:F=>{s(Z=>Z.filter($=>$.id!==F))}}}function HS(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!0),[v,S]=Ne.useState(null),C=async()=>{try{m(!0);const{data:W,error:ee}=await yr.from("entity_groups").select("*").eq("is_visible",!0).order("created_at",{ascending:!1});if(ee)throw ee;const ie=await Promise.all((W||[]).map(async ae=>{const{data:ke,error:le}=await yr.from("entity_group_members").select(`
              id,
              role,
              joined_at,
              entity:entities(*)
            `).eq("group_id",ae.id);return le?(console.error("Error loading members:",le),{...ae,members:[]}):{...ae,members:ke||[],count:(ke==null?void 0:ke.length)||0}}));s(ie),S(null)}catch(W){console.error("Error fetching groups:",W),S(W.message)}finally{m(!1)}};return Ne.useEffect(()=>{C()},[]),{groups:r,loading:c,error:v,fetchGroups:C,createGroup:async W=>{try{const{data:ee,error:ie}=await yr.from("entity_groups").insert(W).select().single();if(ie)throw ie;return await C(),{success:!0,data:ee}}catch(ee){return console.error("Error creating group:",ee),{success:!1,error:ee.message}}},addEntitiesToGroup:async(W,ee,ie="member")=>{try{const ae=ee.map(le=>({group_id:W,entity_id:le,role:ie})),{error:ke}=await yr.from("entity_group_members").insert(ae);if(ke)throw ke;return await C(),{success:!0}}catch(ae){return console.error("Error adding entities to group:",ae),{success:!1,error:ae.message}}},removeEntityFromGroup:async(W,ee)=>{try{const{error:ie}=await yr.from("entity_group_members").delete().eq("group_id",W).eq("entity_id",ee);if(ie)throw ie;return await C(),{success:!0}}catch(ie){return console.error("Error removing entity from group:",ie),{success:!1,error:ie.message}}},deleteGroup:async W=>{try{const{error:ee}=await yr.from("entity_groups").delete().eq("id",W);if(ee)throw ee;return await C(),{success:!0}}catch(ee){return console.error("Error deleting group:",ee),{success:!1,error:ee.message}}},suggestGroups:W=>{const ee=[],ie=new Set;return W.forEach((ae,ke)=>{if(ie.has(ae.id))return;const le=W.filter((se,J)=>{if(J===ke||ie.has(se.id)||se.type!==ae.type||se.class!==ae.class)return!1;const Ee=Math.abs(ae.latitude-se.latitude),je=Math.abs(ae.longitude-se.longitude);return Math.sqrt(Ee*Ee+je*je)<.5});if(le.length>=1){const se=[ae,...le];se.forEach(J=>ie.add(J.id)),ee.push({name:`${ae.class} Squadron`,type:ae.type,class:ae.class,entities:se,count:se.length,centerLat:se.reduce((J,Ee)=>J+parseFloat(Ee.latitude),0)/se.length,centerLng:se.reduce((J,Ee)=>J+parseFloat(Ee.longitude),0)/se.length})}}),ee}}}function wU(){const[r,s]=Ne.useState(!1),[c,m]=Ne.useState(null);return{updatePosition:async(C,{latitude:o,longitude:L})=>{try{console.log("🚀 [updatePosition] INICIANDO..."),console.log("🚀 [updatePosition] entityId:",C),console.log("🚀 [updatePosition] coords:",{latitude:o,longitude:L}),s(!0),m(null),console.log("🚢 Llamando a Supabase RPC: update_entity_position");const{data:F,error:Z}=await yr.rpc("update_entity_position",{p_entity_id:C,p_latitude:o,p_longitude:L});if(console.log("📦 Respuesta de Supabase:",{data:F,error:Z}),Z)throw console.error("❌ Error de Supabase:",Z),Z;return console.log("✅ Posición actualizada correctamente en BD"),F}catch(F){throw console.error("❌ EXCEPCIÓN en updatePosition:",F),console.error("❌ Error completo:",JSON.stringify(F,null,2)),m(F.message),F}finally{s(!1),console.log("🏁 [updatePosition] FINALIZADO")}},updateEntity:async(C,o)=>{try{s(!0),m(null);const{data:L,error:F}=await yr.from("entities").update(o).eq("id",C).select().single();if(F)throw F;return console.log("✅ Entidad actualizada:",L),L}catch(L){throw console.error("❌ Error al actualizar entidad:",L),m(L.message),L}finally{s(!1)}},updating:r,error:c}}function sR(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!0),[v,S]=Ne.useState(null);Ne.useEffect(()=>{C()},[]);async function C(){try{m(!0);const{data:ie,error:ae}=await yr.from("maritime_boundaries_settings").select("*").order("country_name");if(ae)throw ae;s(ie||[])}catch(ie){console.error("Error fetching maritime settings:",ie),S(ie.message)}finally{m(!1)}}async function o(ie,ae,ke="#3b82f6"){try{const{data:le,error:se}=await yr.from("maritime_boundaries_settings").insert([{country_code:ie,country_name:ae,color:ke,is_visible:!0}]).select().single();if(se)throw se;return console.log("✅ Country added to DB:",le),s(J=>{const Ee=[...J,le];return console.log("📊 Settings updated:",{prev:J.length,new:Ee.length}),Ee}),{success:!0,data:le}}catch(le){return console.error("Error adding country:",le),{success:!1,error:le.message}}}async function L(ie){try{const ae=r.find(se=>se.country_code===ie);if(!ae)return{success:!1,error:"País no encontrado"};const{data:ke,error:le}=await yr.from("maritime_boundaries_settings").update({is_visible:!ae.is_visible}).eq("country_code",ie).select().single();if(le)throw le;return s(se=>se.map(J=>J.country_code===ie?ke:J)),{success:!0,data:ke}}catch(ae){return console.error("Error toggling visibility:",ae),{success:!1,error:ae.message}}}async function F(ie,ae){try{const{data:ke,error:le}=await yr.from("maritime_boundaries_settings").update({color:ae}).eq("country_code",ie).select().single();if(le)throw le;return s(se=>se.map(J=>J.country_code===ie?ke:J)),{success:!0,data:ke}}catch(ke){return console.error("Error updating color:",ke),{success:!1,error:ke.message}}}async function Z(ie){try{const{error:ae}=await yr.from("maritime_boundaries_settings").delete().eq("country_code",ie);if(ae)throw ae;return s(ke=>ke.filter(le=>le.country_code!==ie)),{success:!0}}catch(ae){return console.error("Error removing country:",ae),{success:!1,error:ae.message}}}function $(){return r.filter(ie=>ie.is_visible)}function W(){return r.filter(ie=>ie.is_visible).map(ie=>ie.country_code)}function ee(){const ie={};return r.forEach(ae=>{ie[ae.country_code]=ae.color}),ie}return{settings:r,loading:c,error:v,addCountry:o,toggleVisibility:L,updateColor:F,removeCountry:Z,getVisibleCountries:$,getVisibleCountryCodes:W,getColorMap:ee,refetch:C}}const oR=Ne.createContext();function SU({children:r}){const[s,c]=Ne.useState(()=>localStorage.getItem("showMaritimeBoundaries")==="true"),[m,v]=Ne.useState(()=>{const L=localStorage.getItem("maritimeCountries");return L?JSON.parse(L):[uc.VENEZUELA,uc.CUBA,uc.COLOMBIA,uc.JAMAICA,uc.HAITI,uc.DOMINICAN_REPUBLIC,uc.PUERTO_RICO,uc.TRINIDAD_TOBAGO,uc.GUYANA]}),S=()=>{c(L=>{const F=!L;return localStorage.setItem("showMaritimeBoundaries",F),F})},C=L=>{v(L),localStorage.setItem("maritimeCountries",JSON.stringify(L))},o=L=>{v(F=>{const Z=F.includes(L)?F.filter($=>$!==L):[...F,L];return localStorage.setItem("maritimeCountries",JSON.stringify(Z)),Z})};return x.jsx(oR.Provider,{value:{showBoundaries:s,toggleBoundaries:S,selectedCountries:m,updateCountries:C,toggleCountry:o},children:r})}function aR(){const r=Ne.useContext(oR);if(!r)throw new Error("useMaritimeBoundariesContext debe usarse dentro de MaritimeBoundariesProvider");return r}function Nv(){const[r,s]=Ne.useState(!1),[c,m]=Ne.useState(null);async function v(F,Z){try{s(!0),m(null);const{error:$}=await yr.from("entities").update({is_visible:!Z}).eq("id",F);if($)throw $;return{success:!0}}catch($){return console.error("Error al cambiar visibilidad:",$),m($.message),{success:!1,error:$.message}}finally{s(!1)}}async function S(F){try{s(!0),m(null);const{error:Z}=await yr.from("entities").update({archived_at:new Date().toISOString()}).eq("id",F);if(Z)throw Z;return{success:!0}}catch(Z){return console.error("Error al archivar entidad:",Z),m(Z.message),{success:!1,error:Z.message}}finally{s(!1)}}async function C(F){try{s(!0),m(null);const{error:Z}=await yr.from("entities").update({archived_at:null}).eq("id",F);if(Z)throw Z;return{success:!0}}catch(Z){return console.error("Error al restaurar entidad:",Z),m(Z.message),{success:!1,error:Z.message}}finally{s(!1)}}async function o(F){try{s(!0),m(null);const{error:Z}=await yr.from("entities").delete().eq("id",F);if(Z)throw Z;return{success:!0}}catch(Z){return console.error("Error al eliminar entidad:",Z),m(Z.message),{success:!1,error:Z.message}}finally{s(!1)}}async function L(F,Z){try{s(!0),m(null);const{error:$}=await yr.from("entities").update(Z).eq("id",F);if($)throw $;return{success:!0}}catch($){return console.error("Error al actualizar entidad:",$),m($.message),{success:!1,error:$.message}}finally{s(!1)}}return{toggleVisibility:v,archiveEntity:S,unarchiveEntity:C,deleteEntity:o,updateEntity:L,processing:r,error:c}}function k_({isOpen:r,onClose:s,onConfirm:c,title:m="¿Estás seguro?",message:v,confirmText:S="Confirmar",cancelText:C="Cancelar",type:o="danger"}){if(!r)return null;const L={danger:{icon:"text-red-400",bg:"bg-red-900/30",border:"border-red-900/50",button:"bg-red-600 hover:bg-red-700"},warning:{icon:"text-yellow-400",bg:"bg-yellow-900/30",border:"border-yellow-900/50",button:"bg-yellow-600 hover:bg-yellow-700"},info:{icon:"text-blue-400",bg:"bg-blue-900/30",border:"border-blue-900/50",button:"bg-blue-600 hover:bg-blue-700"}},F=L[o]||L.danger,Z=()=>{c(),s()};return x.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in",children:x.jsxs("div",{className:"relative w-full max-w-md bg-slate-900 border border-slate-700 rounded-lg shadow-2xl animate-in zoom-in-95 duration-200",children:[x.jsx("div",{className:`flex items-center justify-center w-16 h-16 mx-auto -mt-8 rounded-full ${F.bg} ${F.border} border-2`,children:x.jsx(Qx,{className:`w-8 h-8 ${F.icon}`})}),x.jsxs("div",{className:"p-6 pt-4",children:[x.jsx("h3",{className:"text-lg font-bold text-white text-center mb-2",children:m}),v&&x.jsx("p",{className:"text-sm text-slate-300 text-center mb-6 leading-relaxed",children:v}),x.jsxs("div",{className:"flex gap-3",children:[x.jsx("button",{onClick:s,className:"flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors",children:C}),x.jsx("button",{onClick:Z,className:`flex-1 px-4 py-2.5 ${F.button} text-white rounded-lg font-medium transition-colors shadow-lg`,children:S})]})]})]})})}const TU={destructor:Ai,fragata:j_,avion:Wa,tropas:vs,tanque:Zo,submarino:Ai},NP={activo:{label:"Activo",color:"bg-green-500",textColor:"text-green-400"},patrullando:{label:"Patrullando",color:"bg-yellow-500",textColor:"text-yellow-400"},estacionado:{label:"Estacionado",color:"bg-blue-500",textColor:"text-blue-400"},en_transito:{label:"En Tránsito",color:"bg-purple-500",textColor:"text-purple-400"},en_vuelo:{label:"En Vuelo",color:"bg-cyan-500",textColor:"text-cyan-400"},vigilancia:{label:"Vigilancia",color:"bg-orange-500",textColor:"text-orange-400"}};function EU({entity:r,onClose:s,isOpen:c=!1}){var Ct,Nt,Wt;const{toggleVisibility:m,archiveEntity:v,deleteEntity:S,processing:C}=Nv(),[o,L]=Ne.useState(null),[F,Z]=Ne.useState(!1),[$,W]=Ne.useState(!1),[ee,ie]=Ne.useState(!1);Ne.useEffect(()=>{async function fr(){if(r!=null&&r.template_id){Z(!0);try{const{data:dr,error:cr}=await yr.from("entity_templates").select("*").eq("id",r.template_id).single();!cr&&dr&&L(dr)}catch(dr){console.error("Error loading template:",dr)}finally{Z(!1)}}else L(null)}fr()},[r==null?void 0:r.template_id]);const ae=async()=>{const fr=await m(r.id,r.is_visible);fr.success?(window.removeEntityDirectly&&window.removeEntityDirectly(r.id),s()):console.error(`Error: ${fr.error}`)},ke=async()=>{const fr=await v(r.id);fr.success?(window.removeEntityDirectly&&window.removeEntityDirectly(r.id),s()):console.error(`Error al archivar: ${fr.error}`)},le=async()=>{const fr=await S(r.id);fr.success?(window.removeEntityDirectly&&window.removeEntityDirectly(r.id),s()):console.error(`Error al eliminar: ${fr.error}`)},se=()=>{ie(!0)},J=()=>{W(!0)};if(!r)return x.jsx("div",{className:`fixed w-[380px] bg-slate-900 shadow-2xl flex flex-col border-l border-slate-700 transition-transform duration-300 ease-in-out ${c?"translate-x-0":"translate-x-full"}`,style:{right:0,top:"56px",height:"calc(100vh - 56px)",zIndex:60},children:x.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:x.jsxs("div",{className:"text-center text-slate-400",children:[x.jsx(Ai,{className:"w-16 h-16 mx-auto mb-4 opacity-30",strokeWidth:1}),x.jsx("p",{className:"text-sm",children:"Selecciona una entidad del mapa"})]})})});const Ee=fr=>r[fr]??(o==null?void 0:o[fr])??null,je=TU[r.type]||Ai,Xe=NP[r.status]||NP.activo,tt=r.last_position_update?new Date(r.last_position_update).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}):"N/A",it=r.video_url||o!=null&&o.video_url||(Ct=o==null?void 0:o.image_url)!=null&&Ct.match(/\.(webm|mp4)$/i)?o==null?void 0:o.image_url:null,We=r.image_thumbnail_url||r.image_url||(o==null?void 0:o.image_url);return x.jsxs("div",{className:`fixed w-[380px] bg-slate-900 shadow-2xl flex flex-col border-l border-slate-700 transition-transform duration-300 ease-in-out ${c?"translate-x-0":"translate-x-full"}`,style:{right:0,top:"56px",height:"calc(100vh - 56px)",zIndex:60},children:[x.jsxs("div",{className:"relative bg-gradient-to-br from-slate-800 to-slate-900 overflow-hidden flex-shrink-0",style:{aspectRatio:it?"16/9":"auto",height:it?"auto":"256px",maxHeight:"400px"},children:[it?x.jsxs("div",{className:"relative z-10 h-full w-full bg-black",children:[x.jsx("video",{src:it,autoPlay:!0,loop:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),x.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/40 pointer-events-none"})]}):We?x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"absolute inset-0 bg-cover bg-center filter blur-lg opacity-30",style:{backgroundImage:`url(${We})`}}),x.jsx("div",{className:"relative z-10 flex items-center justify-center h-full p-6",children:x.jsx("img",{src:We,alt:r.name,className:"max-h-full max-w-full object-contain drop-shadow-2xl"})})]}):x.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:x.jsx(je,{className:"w-32 h-32 text-slate-700 opacity-30",strokeWidth:1})}),x.jsx("button",{onClick:s,className:"absolute top-4 right-4 p-2 bg-slate-900/80 hover:bg-slate-800 backdrop-blur-sm rounded-lg transition-colors z-20 border border-slate-700",children:x.jsx(En,{className:"w-5 h-5 text-white"})}),x.jsxs("div",{className:"absolute top-4 left-4 flex items-center gap-2 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700 z-20",children:[x.jsx(je,{className:"w-4 h-4 text-blue-400"}),x.jsx("span",{className:"text-xs font-semibold uppercase tracking-wider text-slate-200",children:r.type})]}),x.jsxs("div",{className:`absolute bottom-4 left-4 flex items-center gap-2 ${Xe.color}/20 backdrop-blur-md px-3 py-2 rounded-full border ${Xe.color}/50 z-20`,children:[x.jsx("div",{className:`w-2 h-2 rounded-full ${Xe.color} animate-pulse`}),x.jsx("span",{className:`text-xs font-bold ${Xe.textColor}`,children:Xe.label.toUpperCase()})]})]}),x.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:x.jsxs("div",{className:"p-6 space-y-6",children:[x.jsxs("div",{children:[x.jsx("h2",{className:"text-2xl font-bold text-white mb-1",children:r.name}),r.class&&x.jsx("p",{className:"text-sm text-slate-400 font-mono uppercase tracking-wide",children:r.class})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.jsx(ju,{className:"w-4 h-4 text-blue-400"}),x.jsx("span",{className:"text-xs text-slate-400 font-semibold",children:"Posición"})]}),x.jsxs("p",{className:"text-white font-mono text-xs",children:[(Nt=r.latitude)==null?void 0:Nt.toFixed(4),"°"]}),x.jsxs("p",{className:"text-white font-mono text-xs",children:[(Wt=r.longitude)==null?void 0:Wt.toFixed(4),"°"]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.jsx(zS,{className:"w-4 h-4 text-purple-400"}),x.jsx("span",{className:"text-xs text-slate-400 font-semibold",children:"Rumbo"})]}),x.jsxs("p",{className:"text-white font-mono text-2xl font-bold",children:[r.heading||0,"°"]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.jsx(jS,{className:"w-4 h-4 text-green-400"}),x.jsx("span",{className:"text-xs text-slate-400 font-semibold",children:"Velocidad"})]}),x.jsxs("p",{className:"text-white font-mono text-lg font-bold",children:[r.speed||0," kn"]}),x.jsxs("p",{className:"text-slate-500 text-xs",children:["máx: ",Ee("max_speed_knots")||"N/A"," kn"]})]}),r.altitude&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.jsx(_F,{className:"w-4 h-4 text-cyan-400"}),x.jsx("span",{className:"text-xs text-slate-400 font-semibold",children:"Altitud"})]}),x.jsxs("p",{className:"text-white font-mono text-lg font-bold",children:[r.altitude," m"]})]})]}),(Ee("displacement_tons")||Ee("length_meters")||Ee("crew_count"))&&x.jsxs("div",{className:"bg-gradient-to-br from-blue-950/30 to-slate-800/30 rounded-lg p-4 border border-blue-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-blue-400 uppercase tracking-wide mb-4 flex items-center gap-2",children:[x.jsx(Zo,{className:"w-4 h-4"}),"Especificaciones Técnicas"]}),x.jsxs("div",{className:"space-y-3",children:[Ee("displacement_tons")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Desplazamiento"}),x.jsxs("span",{className:"text-sm text-white font-bold",children:[Ee("displacement_tons").toLocaleString()," tons"]})]}),Ee("length_meters")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Longitud"}),x.jsxs("span",{className:"text-sm text-white font-bold",children:[Ee("length_meters")," m"]})]}),Ee("beam_meters")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Manga"}),x.jsxs("span",{className:"text-sm text-white font-bold",children:[Ee("beam_meters")," m"]})]}),Ee("crew_count")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Tripulación"}),x.jsxs("span",{className:"text-sm text-white font-bold",children:[Ee("crew_count")," miembros"]})]}),Ee("range_km")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Alcance"}),x.jsxs("span",{className:"text-sm text-white font-bold",children:[Ee("range_km").toLocaleString()," km"]})]}),r.commissioned_year&&x.jsxs("div",{className:"flex justify-between items-center",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"En servicio desde"}),x.jsx("span",{className:"text-sm text-white font-bold",children:r.commissioned_year})]})]})]}),Ee("armamento")&&x.jsxs("div",{className:"bg-gradient-to-br from-red-950/30 to-slate-800/30 rounded-lg p-4 border border-red-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-red-400 uppercase tracking-wide mb-3 flex items-center gap-2",children:[x.jsx(BS,{className:"w-4 h-4"}),"Armamento"]}),x.jsx("p",{className:"text-xs text-slate-300 leading-relaxed",children:Ee("armamento")})]}),x.jsxs("div",{className:"pt-4 border-t border-slate-700/50 space-y-2",children:[x.jsx("h3",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3",children:"Acciones"}),x.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[x.jsxs("button",{onClick:()=>alert("Función de editar en desarrollo"),disabled:C,className:"flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-800 disabled:cursor-not-allowed text-white rounded-lg transition-colors text-sm font-medium",title:"Editar entidad",children:[x.jsx(FS,{size:16}),"Editar"]}),x.jsxs("button",{onClick:ae,disabled:C,className:"flex items-center justify-center gap-2 px-3 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white rounded-lg transition-colors text-sm font-medium",title:r!=null&&r.is_visible?"Ocultar del mapa":"Mostrar en mapa",children:[r!=null&&r.is_visible?x.jsx(F_,{size:16}):x.jsx(kl,{size:16}),r!=null&&r.is_visible?"Ocultar":"Mostrar"]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[x.jsxs("button",{onClick:se,disabled:C,className:"flex items-center justify-center gap-2 px-3 py-2 bg-yellow-900/30 hover:bg-yellow-900/50 disabled:opacity-50 disabled:cursor-not-allowed text-yellow-400 rounded-lg transition-colors text-sm font-medium",title:"Archivar entidad",children:[x.jsx(E_,{size:16}),"Archivar"]}),x.jsxs("button",{onClick:J,disabled:C,className:"flex items-center justify-center gap-2 px-3 py-2 bg-red-900/30 hover:bg-red-900/50 disabled:opacity-50 disabled:cursor-not-allowed text-red-400 rounded-lg transition-colors text-sm font-medium",title:"Eliminar permanentemente",children:[x.jsx(Sc,{size:16}),"Eliminar"]})]}),C&&x.jsxs("div",{className:"flex items-center justify-center gap-2 text-blue-400 text-sm",children:[x.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-blue-400 border-t-transparent rounded-full"}),"Procesando..."]})]}),x.jsx("div",{className:"flex items-center justify-between pt-4 border-t border-slate-700/50 mt-4",children:x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx(y2,{className:"w-3.5 h-3.5 text-slate-500"}),x.jsxs("span",{className:"text-xs text-slate-500",children:["Actualizado: ",tt]})]})})]})}),x.jsx(k_,{isOpen:ee,onClose:()=>ie(!1),onConfirm:ke,title:"¿Archivar esta entidad?",message:`La entidad "${r.name}" se archivará y podrá ser restaurada más tarde desde el menú Ver → Ver Archivadas.`,confirmText:"Archivar",cancelText:"Cancelar",type:"warning"}),x.jsx(k_,{isOpen:$,onClose:()=>W(!1),onConfirm:le,title:"⚠️ ¿Eliminar permanentemente?",message:`La entidad "${r.name}" será eliminada de forma PERMANENTE. Esta acción NO se puede deshacer.`,confirmText:"Eliminar Permanentemente",cancelText:"Cancelar",type:"danger"})]})}function IU({group:r,onClose:s,onSelectMember:c,onDissolveGroup:m,isOpen:v=!1}){var W,ee;const[S,C]=Ne.useState(null),[o,L]=Ne.useState(!1);if(!r)return x.jsx("div",{className:`fixed w-[380px] bg-slate-900 shadow-2xl flex flex-col border-l border-slate-700 transition-transform duration-300 ease-in-out ${v?"translate-x-0":"translate-x-full"}`,style:{right:0,top:"56px",height:"calc(100vh - 56px)",zIndex:60},children:x.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:x.jsxs("div",{className:"text-center text-slate-400",children:[x.jsx(vs,{className:"w-16 h-16 mx-auto mb-4 opacity-30",strokeWidth:1}),x.jsx("p",{className:"text-sm",children:"Selecciona un grupo del mapa"})]})})});const F=(W=r.members[0])==null?void 0:W.entity,Z=(F==null?void 0:F.type)==="avion"?Wa:Ai,$=r.icon_color||"#3b82f6";return x.jsxs("div",{className:`fixed w-[380px] bg-slate-900 shadow-2xl flex flex-col border-l border-slate-700 transition-transform duration-300 ease-in-out ${v?"translate-x-0":"translate-x-full"}`,style:{right:0,top:"56px",height:"calc(100vh - 56px)",zIndex:60},children:[x.jsxs("div",{className:"relative h-48 bg-gradient-to-br from-slate-800 to-slate-900 overflow-hidden flex-shrink-0 flex items-center justify-center",children:[x.jsxs("div",{className:"relative z-10 flex flex-col items-center",children:[x.jsx("div",{className:"w-24 h-24 rounded-lg border-4 flex items-center justify-center bg-slate-800 shadow-2xl",style:{borderColor:$},children:x.jsx(Z,{size:48,style:{color:$},strokeWidth:2})}),x.jsx("div",{className:"absolute -bottom-2 -right-2 bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center border-4 border-slate-900 font-bold text-lg shadow-xl",children:r.count})]}),x.jsx("button",{onClick:s,className:"absolute top-4 right-4 p-2 bg-slate-900/80 hover:bg-slate-800 backdrop-blur-sm rounded-lg transition-colors z-20 border border-slate-700",children:x.jsx(En,{className:"w-5 h-5 text-white"})}),x.jsxs("div",{className:"absolute top-4 left-4 flex items-center gap-2 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700 z-20",children:[x.jsx(vs,{className:"w-4 h-4 text-blue-400"}),x.jsx("span",{className:"text-xs font-semibold uppercase tracking-wider text-slate-200",children:r.group_type||"grupo"})]})]}),x.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:x.jsxs("div",{className:"p-6 space-y-6",children:[x.jsxs("div",{children:[x.jsx("h2",{className:"text-2xl font-bold text-white mb-1",children:r.name}),r.description&&x.jsx("p",{className:"text-sm text-slate-400",children:r.description})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.jsx(vs,{className:"w-4 h-4 text-blue-400"}),x.jsx("span",{className:"text-xs text-slate-400 font-semibold",children:"Miembros"})]}),x.jsx("p",{className:"text-white font-mono text-2xl font-bold",children:r.count})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.jsx(Z,{className:"w-4 h-4 text-purple-400"}),x.jsx("span",{className:"text-xs text-slate-400 font-semibold",children:"Tipo"})]}),x.jsx("p",{className:"text-white font-mono text-sm font-bold capitalize",children:(F==null?void 0:F.type)||"N/A"})]})]}),x.jsxs("div",{children:[x.jsxs("h3",{className:"text-sm font-bold text-slate-400 uppercase tracking-wide mb-3 flex items-center gap-2",children:[x.jsx(vs,{className:"w-4 h-4"}),"Miembros del ",r.group_type||"Grupo"]}),x.jsx("div",{className:"space-y-2",children:(ee=r.members)==null?void 0:ee.map(ie=>{var ke,le;const ae=ie.entity;return ae?x.jsx("button",{onClick:()=>c(ae),className:"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 border border-slate-700/30 transition-all text-left",children:x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{className:"flex-1",children:[x.jsx("h4",{className:"text-sm font-semibold text-white",children:ae.name}),x.jsx("p",{className:"text-xs text-slate-400 mt-0.5",children:ae.class}),x.jsxs("div",{className:"flex items-center gap-3 mt-2 text-xs text-slate-500",children:[x.jsxs("div",{className:"flex items-center gap-1",children:[x.jsx(ju,{className:"w-3 h-3"}),(ke=ae.latitude)==null?void 0:ke.toFixed(2),"°, ",(le=ae.longitude)==null?void 0:le.toFixed(2),"°"]}),ae.speed>0&&x.jsxs("div",{className:"flex items-center gap-1",children:[x.jsx(jS,{className:"w-3 h-3"}),ae.speed," kn"]})]})]}),x.jsx("div",{className:"flex-shrink-0 ml-3",children:x.jsx("div",{className:"w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center",children:x.jsx(Z,{size:16,style:{color:$}})})})]})},ie.id):null})})]}),x.jsxs("div",{className:"pt-4 border-t border-slate-700/50 space-y-2",children:[x.jsx("h3",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3",children:"Acciones del Grupo"}),x.jsxs("button",{className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm font-medium",children:[x.jsx(kl,{size:16}),"Ver Todas en Mapa"]}),x.jsxs("button",{onClick:()=>L(!0),className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded-lg transition-colors text-sm font-medium",children:[x.jsx(Sc,{size:16}),"Disolver Grupo"]})]})]})}),x.jsx(k_,{isOpen:o,onClose:()=>L(!1),onConfirm:async()=>{m&&(await m(r.id),s())},title:"¿Disolver este grupo?",message:`El grupo "${r.name}" será disuelto. Las ${r.count} entidades volverán a aparecer individualmente en el mapa.`,confirmText:"Disolver Grupo",cancelText:"Cancelar",type:"warning"})]})}function CU(){const{entities:r}=Mv(),{groups:s}=HS(),[c,m]=Ne.useState(null),[v,S]=Ne.useState(!1);return Ne.useEffect(()=>{if(!r||r.length===0)return;const C=r.filter($=>$.is_visible!==!1&&!$.archived_at),o={destructor:{count:0,personnel:0,icon:Ai,color:"#ef4444",label:"Buques"},fragata:{count:0,personnel:0,icon:j_,color:"#3b82f6",label:"Fragatas"},avion:{count:0,personnel:0,icon:Wa,color:"#6b7280",label:"Aeronaves"},tropas:{count:0,personnel:0,icon:vs,color:"#22c55e",label:"Tropas"},submarino:{count:0,personnel:0,icon:b2,color:"#8b5cf6",label:"Submarinos"}};C.forEach($=>{o[$.type]&&(o[$.type].count++,o[$.type].personnel+=$.crew_count||0)});const L=C.length,F=Object.values(o).reduce(($,W)=>$+W.personnel,0),Z=s.filter($=>$.is_visible).length;m({byType:o,totalUnits:L,totalPersonnel:F,totalGroups:Z})},[r,s]),c?x.jsxs(x.Fragment,{children:[x.jsx("button",{onClick:()=>S(!v),className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl transition-all hover:scale-105 hover:border-cyan-500 z-40",children:x.jsxs("div",{className:"px-4 py-2 flex items-center gap-3",children:[x.jsx(Kx,{className:"w-5 h-5 text-cyan-400"}),x.jsxs("div",{className:"text-left",children:[x.jsxs("div",{className:"text-white font-bold text-sm",children:[c.totalUnits," unidades activas"]}),x.jsxs("div",{className:"text-slate-400 text-xs",children:[c.totalPersonnel.toLocaleString()," efectivos"]})]})]})}),v&&x.jsxs("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2 w-96 bg-slate-900/98 backdrop-blur-md border border-slate-700 rounded-lg shadow-2xl animate-in slide-in-from-bottom duration-300 z-40",children:[x.jsxs("div",{className:"p-4 border-b border-slate-700 bg-gradient-to-r from-blue-900/30 to-slate-900",children:[x.jsxs("h3",{className:"text-white font-bold text-lg flex items-center gap-2",children:[x.jsx(Kx,{className:"w-5 h-5 text-blue-400"}),"ESTADO DEL DESPLIEGUE"]}),x.jsx("p",{className:"text-slate-400 text-xs mt-1",children:"SOUTHCOM - Caribe - Octubre 2025"})]}),x.jsxs("div",{className:"p-4 grid grid-cols-3 gap-3 border-b border-slate-800",children:[x.jsxs("div",{className:"bg-blue-900/20 rounded-lg p-3 border border-blue-900/30 text-center",children:[x.jsx("div",{className:"text-2xl font-bold text-white",children:c.totalUnits}),x.jsx("div",{className:"text-xs text-blue-400 font-semibold",children:"UNIDADES"})]}),x.jsxs("div",{className:"bg-green-900/20 rounded-lg p-3 border border-green-900/30 text-center",children:[x.jsx("div",{className:"text-2xl font-bold text-white",children:c.totalPersonnel.toLocaleString()}),x.jsx("div",{className:"text-xs text-green-400 font-semibold",children:"EFECTIVOS"})]}),x.jsxs("div",{className:"bg-purple-900/20 rounded-lg p-3 border border-purple-900/30 text-center",children:[x.jsx("div",{className:"text-2xl font-bold text-white",children:c.totalGroups}),x.jsx("div",{className:"text-xs text-purple-400 font-semibold",children:"GRUPOS"})]})]}),x.jsxs("div",{className:"p-4 space-y-2",children:[x.jsx("h4",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3",children:"Desglose por Tipo"}),Object.entries(c.byType).filter(([C,o])=>o.count>0).sort((C,o)=>o[1].count-C[1].count).map(([C,o])=>{const L=o.icon;return x.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg border border-slate-700/50 transition-all group",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center",style:{backgroundColor:`${o.color}20`,borderColor:o.color,borderWidth:"2px"},children:x.jsx(L,{size:20,style:{color:o.color},strokeWidth:2.5})}),x.jsxs("div",{children:[x.jsx("div",{className:"text-white font-semibold text-sm",children:o.label}),o.personnel>0&&x.jsxs("div",{className:"text-slate-400 text-xs",children:[o.personnel.toLocaleString()," efectivos"]})]})]}),x.jsxs("div",{className:"text-right",children:[x.jsx("div",{className:"text-white font-bold text-xl",children:o.count}),x.jsx("div",{className:"text-slate-500 text-xs",children:"unidades"})]})]},C)})]}),x.jsx("div",{className:"p-3 border-t border-slate-800 bg-slate-800/30 text-center",children:x.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-slate-400",children:[x.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),x.jsx("span",{children:"Actualización en tiempo real"})]})})]})]}):null}function AU(){const[r,s]=Ne.useState(!1),[c,m]=Ne.useState(null);return{updateEntityFull:async(S,C)=>{try{if(s(!0),m(null),C.latitude!==void 0&&C.longitude!==void 0){const{error:o}=await yr.rpc("update_entity_position",{p_entity_id:S,p_latitude:C.latitude,p_longitude:C.longitude});if(o)throw o;delete C.latitude,delete C.longitude}if(Object.keys(C).length>0){const{error:o}=await yr.from("entities").update(C).eq("id",S);if(o)throw o}return{success:!0}}catch(o){return console.error("Error updating entity:",o),m(o.message),{success:!1,error:o.message}}finally{s(!1)}},updating:r,error:c}}function PU({message:r,type:s="success",onClose:c}){Ne.useEffect(()=>{const L=setTimeout(()=>{c()},3e3);return()=>clearTimeout(L)},[c]);const m={success:{icon:DS,bgColor:"bg-green-600/95",borderColor:"border-green-400",iconColor:"text-green-200"},error:{icon:bN,bgColor:"bg-red-600/95",borderColor:"border-red-400",iconColor:"text-red-200"},warning:{icon:z_,bgColor:"bg-yellow-600/95",borderColor:"border-yellow-400",iconColor:"text-yellow-200"}},{icon:v,bgColor:S,borderColor:C,iconColor:o}=m[s]||m.success;return x.jsx("div",{className:"fixed top-20 left-1/2 -translate-x-1/2 z-[200] animate-slideInFromTop",children:x.jsxs("div",{className:`${S} backdrop-blur-md ${C} border-2 rounded-lg shadow-2xl px-4 py-3 flex items-center gap-3 min-w-[320px]`,children:[x.jsx(v,{className:`w-5 h-5 ${o} flex-shrink-0`}),x.jsx("p",{className:"text-white font-medium text-sm flex-1",children:r}),x.jsx("button",{onClick:c,className:"text-white/70 hover:text-white transition-colors flex-shrink-0",children:x.jsx(En,{className:"w-4 h-4"})})]})})}async function kU(r,s=800,c=800,m=.95){return new Promise((v,S)=>{const C=new FileReader;C.onload=o=>{const L=new Image;L.onload=()=>{let F=L.width,Z=L.height;if(F<=100&&Z<=100)console.log("🎨 Imagen pequeña detectada, manteniendo tamaño original:",F,"x",Z),F=L.width,Z=L.height;else if(F>s||Z>c){const ae=F/Z;F>Z?(F=s,Z=s/ae):(Z=c,F=c*ae)}const $=document.createElement("canvas");$.width=F,$.height=Z;const W=$.getContext("2d");W.imageSmoothingEnabled=!0,W.imageSmoothingQuality="high",W.drawImage(L,0,0,F,Z);const ie=r.type==="image/png"?"image/png":"image/jpeg";$.toBlob(ae=>{ae?(console.log(`✅ Imagen optimizada: ${ie}, ${(ae.size/1024).toFixed(2)} KB`),v(ae)):S(new Error("Error al convertir canvas a blob"))},ie,m)},L.onerror=()=>S(new Error("Error al cargar imagen")),L.src=o.target.result},C.onerror=()=>S(new Error("Error al leer archivo")),C.readAsDataURL(r)})}async function MU(r,s=200){return new Promise((c,m)=>{const v=new FileReader;v.onload=S=>{const C=new Image;C.onload=()=>{const o=C.width<=100&&C.height<=100,L=o?Math.max(C.width,C.height):s;console.log("🖼️ Creando miniatura:",{original:`${C.width}x${C.height}`,target:`${L}x${L}`,isSmall:o});const F=document.createElement("canvas");if(o){F.width=C.width,F.height=C.height;const W=F.getContext("2d");W.imageSmoothingEnabled=!0,W.imageSmoothingQuality="high",W.drawImage(C,0,0)}else{F.width=L,F.height=L;const W=F.getContext("2d"),ee=Math.min(C.width,C.height),ie=(C.width-ee)/2,ae=(C.height-ee)/2;W.imageSmoothingEnabled=!0,W.imageSmoothingQuality="high",W.drawImage(C,ie,ae,ee,ee,0,0,L,L)}const $=r.type==="image/png"?"image/png":"image/jpeg";F.toBlob(W=>{W?(console.log(`✅ Miniatura creada: ${$}, ${(W.size/1024).toFixed(2)} KB`),c(W)):m(new Error("Error al crear miniatura"))},$,.95)},C.onerror=()=>m(new Error("Error al cargar imagen")),C.src=S.target.result},v.onerror=()=>m(new Error("Error al leer archivo")),v.readAsDataURL(r)})}function NU(r){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(r.type))throw new Error("Formato no válido. Solo se permiten JPG, PNG y WebP.");if(r.size>5242880)throw new Error("La imagen es demasiado grande. Máximo 5MB.");return!0}function RP(r,s){return new File([r],s,{type:r.type})}function RU(r){if(r===0)return"0 Bytes";const s=1024,c=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(r)/Math.log(s));return Math.round(r/Math.pow(s,m)*100)/100+" "+c[m]}async function LU(r,s){try{if(console.log("📤 Subiendo archivo para entidad:",s),console.log("📦 Tamaño original:",(r.size/1024).toFixed(2),"KB"),r.type.startsWith("video/")||r.name.match(/\.(webm|mp4)$/i))return await OU(r,s);NU(r);const m=r.type==="image/png",v=m?"png":"jpg",S=m?"image/png":"image/jpeg";console.log("🔧 Optimizando imagen principal...");const C=await kU(r,400,400,.85),o=RP(C,`${s}-original.${v}`);console.log("✅ Imagen optimizada:",(C.size/1024).toFixed(2),"KB"),console.log("🔧 Creando miniatura...");const L=await MU(r,128),F=RP(L,`${s}-thumbnail.${v}`);console.log("✅ Miniatura creada:",(L.size/1024).toFixed(2),"KB");const Z=`entities/${s}/image.${v}`,{error:$}=await yr.storage.from("entity-images").upload(Z,o,{contentType:S,cacheControl:"3600",upsert:!0});if($)throw console.error("❌ Error al subir imagen:",$),new Error(`Error al subir imagen: ${$.message}`);console.log("✅ Imagen principal subida");const W=`entities/${s}/thumbnail.${v}`,{error:ee}=await yr.storage.from("entity-images").upload(W,F,{contentType:S,cacheControl:"3600",upsert:!0});if(ee)throw console.error("❌ Error al subir miniatura:",ee),new Error(`Error al subir miniatura: ${ee.message}`);console.log("✅ Miniatura subida");const{data:ie}=yr.storage.from("entity-images").getPublicUrl(Z),{data:ae}=yr.storage.from("entity-images").getPublicUrl(W),ke=ie.publicUrl,le=ae.publicUrl;if(console.log("🔗 URL imagen:",ke),console.log("🔗 URL miniatura:",le),s.startsWith("template-"))console.log("✅ Upload para plantilla - skip actualización de BD");else{const{error:J}=await yr.from("entities").update({image_url:ke,image_thumbnail_url:le}).eq("id",s);if(J)throw console.error("❌ Error al actualizar entidad:",J),new Error(`Error al actualizar entidad: ${J.message}`);console.log("✅ Entidad actualizada con URLs de imágenes")}return{full:ke,thumbnail:le,imageUrl:ke,thumbnailUrl:le}}catch(c){throw console.error("❌ Error en uploadEntityImage:",c),c}}async function OU(r,s){var c;try{const m=((c=r.name.match(/\.(webm|mp4)$/i))==null?void 0:c[1])||"webm",v=`entities/${s}/video.${m}`;console.log("🎬 Subiendo video...");const{error:S}=await yr.storage.from("entity-videos").upload(v,r,{contentType:r.type,cacheControl:"3600",upsert:!0});if(S)throw new Error(`Error al subir video: ${S.message}`);console.log("✅ Video subido");const{data:C}=yr.storage.from("entity-videos").getPublicUrl(v),o=C.publicUrl;if(console.log("🔗 URL video:",o),!s.startsWith("template-")){const{error:F}=await yr.from("entities").update({video_url:o}).eq("id",s);F?console.error("⚠️ Error al actualizar entidad con video:",F):console.log("✅ Entidad actualizada con video_url")}return{full:o,thumbnail:o,videoUrl:o,imageUrl:o,thumbnailUrl:o}}catch(m){throw console.error("❌ Error en uploadVideoFile:",m),m}}function lR({entityId:r,entityName:s,onUploadComplete:c,allowTemplateUpload:m=!1}){const[v,S]=Ne.useState(null),[C,o]=Ne.useState(null),[L,F]=Ne.useState(!1),[Z,$]=Ne.useState(null),[W,ee]=Ne.useState(!1),ie=Ne.useRef(null),ae=Ee=>{if(!Ee)return;const je=Ee.type.startsWith("image/"),Xe=Ee.type.startsWith("video/")||Ee.name.match(/\.(webm|mp4)$/i);if(!je&&!Xe){$("Por favor selecciona una imagen (JPG, PNG, WebP) o video (WEBM, MP4)");return}const tt=Xe?10*1024*1024:5*1024*1024;if(Ee.size>tt){$(`El archivo es demasiado grande. Máximo ${Xe?"10MB":"5MB"}.`);return}S(Ee),$(null),ee(!1);const it=new FileReader;it.onloadend=()=>{o(it.result)},it.readAsDataURL(Ee)},ke=Ee=>{Ee.preventDefault();const je=Ee.dataTransfer.files[0];ae(je)},le=Ee=>{Ee.preventDefault()},se=async()=>{if(!v)return;const Ee=r||`template-${Date.now()}`;F(!0),$(null);try{const je=await LU(v,Ee);ee(!0),F(!1),c&&c(je),setTimeout(()=>{S(null),o(null),ee(!1)},2e3)}catch(je){$(je.message),F(!1)}},J=()=>{S(null),o(null),$(null),ee(!1),ie.current&&(ie.current.value="")};return x.jsxs("div",{className:"w-full max-w-md mx-auto",children:[x.jsxs("div",{onDrop:ke,onDragOver:le,onClick:()=>{var Ee;return(Ee=ie.current)==null?void 0:Ee.click()},className:`
          relative border-2 border-dashed rounded-lg p-6 cursor-pointer
          transition-all duration-200
          ${v?"border-blue-500 bg-blue-500/10":"border-slate-600 hover:border-blue-500 bg-slate-800/50"}
        `,children:[x.jsx("input",{ref:ie,type:"file",accept:m?"image/*,video/webm,video/mp4":"image/*",onChange:Ee=>ae(Ee.target.files[0]),className:"hidden"}),v?x.jsxs("div",{className:"space-y-3",children:[x.jsxs("div",{className:"relative",children:[v.type.startsWith("video/")||v.name.match(/\.(webm|mp4)$/i)?x.jsx("video",{src:C,className:"w-full h-48 object-cover rounded-md bg-black",controls:!0,loop:!0,muted:!0}):x.jsx("img",{src:C,alt:"Preview",className:"w-full h-48 object-cover rounded-md"}),x.jsx("button",{onClick:Ee=>{Ee.stopPropagation(),J()},className:"absolute top-2 right-2 p-1 bg-red-500 rounded-full hover:bg-red-600 transition",children:x.jsx(En,{className:"w-4 h-4 text-white"})})]}),x.jsxs("div",{className:"text-xs text-slate-400",children:[x.jsx("p",{className:"font-semibold truncate",children:v.name}),x.jsx("p",{children:RU(v.size)})]})]}):x.jsxs("div",{className:"text-center",children:[x.jsx(ev,{className:"w-12 h-12 mx-auto mb-3 text-slate-500"}),x.jsxs("p",{className:"text-sm text-slate-300 mb-1",children:["Arrastra ",m?"una imagen o video":"una imagen"," aquí o haz click"]}),x.jsx("p",{className:"text-xs text-slate-500",children:m?"PNG, JPG, WEBM, MP4 (máx. 10MB)":"JPG, PNG o WebP (máx. 5MB)"})]})]}),v&&!W&&x.jsx("button",{onClick:Ee=>{Ee.stopPropagation(),se()},disabled:L,className:`
            mt-3 w-full py-2 px-4 rounded-md font-semibold
            flex items-center justify-center gap-2
            transition-all duration-200
            ${L?"bg-slate-700 text-slate-400 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}
          `,children:L?x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"}),"Subiendo..."]}):x.jsxs(x.Fragment,{children:[x.jsx(C_,{className:"w-4 h-4"}),"Subir imagen de ",s]})}),W&&x.jsxs("div",{className:"mt-3 p-3 bg-green-500/20 border border-green-500/50 rounded-md flex items-center gap-2",children:[x.jsx(DS,{className:"w-5 h-5 text-green-400 flex-shrink-0"}),x.jsx("p",{className:"text-sm text-green-400",children:"¡Imagen subida y optimizada correctamente!"})]}),Z&&x.jsxs("div",{className:"mt-3 p-3 bg-red-500/20 border border-red-500/50 rounded-md flex items-center gap-2",children:[x.jsx(z_,{className:"w-5 h-5 text-red-400 flex-shrink-0"}),x.jsx("p",{className:"text-sm text-red-400",children:Z})]})]})}function DU({entity:r,onClose:s,onSuccess:c}){var le,se;const{updateEntityFull:m,updating:v}=AU(),[S,C]=Ne.useState(null),[o,L]=Ne.useState(!1),[F,Z]=Ne.useState("icon"),[$,W]=Ne.useState({name:"",class:"",status:"activo",latitude:0,longitude:0,heading:0,speed:0,weapon_type:"",fire_range_km:null,radar_range_km:null,has_surface_to_surface:!1,has_surface_to_air:!1,has_torpedoes:!1,has_cruise_missiles:!1,defensive_systems:"",ship_type_description:"",country_origin:"",manufacturer:"",commissioned_year:null,homeport:"",displacement_tons:null,length_meters:null,beam_meters:null,crew_count:null,range_km:null,max_speed_knots:null,icon_url:"",image_url:"",video_url:""});if(Ne.useEffect(()=>{r&&W({name:r.name||"",class:r.class||"",status:r.status||"activo",latitude:r.latitude||0,longitude:r.longitude||0,heading:r.heading||0,speed:r.speed||0,weapon_type:r.weapon_type||"",fire_range_km:r.fire_range_km||null,radar_range_km:r.radar_range_km||null,has_surface_to_surface:r.has_surface_to_surface||!1,has_surface_to_air:r.has_surface_to_air||!1,has_torpedoes:r.has_torpedoes||!1,has_cruise_missiles:r.has_cruise_missiles||!1,defensive_systems:r.defensive_systems||"",ship_type_description:r.ship_type_description||"",country_origin:r.country_origin||"",manufacturer:r.manufacturer||"",commissioned_year:r.commissioned_year||null,homeport:r.homeport||"",displacement_tons:r.displacement_tons||null,length_meters:r.length_meters||null,beam_meters:r.beam_meters||null,crew_count:r.crew_count||null,range_km:r.range_km||null,max_speed_knots:r.max_speed_knots||null,icon_url:r.icon_url||"",image_url:r.image_url||"",video_url:r.video_url||""})},[r]),!r)return null;const ee=async J=>{if(J.preventDefault(),!$.name.trim()){C({message:"El nombre es obligatorio",type:"error"});return}const Ee=await m(r.id,$);Ee.success?(C({message:"Entidad actualizada correctamente",type:"success"}),await new Promise(je=>setTimeout(je,500)),window.refetchEntities&&await window.refetchEntities(),c&&c(),s()):C({message:`Error al actualizar: ${Ee.error}`,type:"error"})},ie=(J,Ee)=>{W(je=>({...je,[J]:Ee}))},ke={destructor:Ai,fragata:Ai,avion:Wa,tropas:vs,tanque:Zo,submarino:Ai}[r.type]||Ai;return x.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm",children:[x.jsxs("div",{className:"bg-slate-800 rounded-xl shadow-2xl border border-slate-700 w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col",children:[x.jsx("div",{className:"p-6 border-b border-slate-700 bg-gradient-to-r from-blue-900/30 to-slate-800 flex-shrink-0",children:x.jsxs("div",{className:"flex items-start justify-between",children:[x.jsxs("div",{className:"flex items-center space-x-3",children:[x.jsx("div",{className:"p-3 rounded-lg bg-blue-900/30",children:x.jsx(ke,{size:28,className:"text-blue-400"})}),x.jsxs("div",{children:[x.jsxs("h2",{className:"text-xl font-bold text-white",children:["Editar: ",r.name]}),x.jsxs("p",{className:"text-sm text-slate-400 mt-0.5",children:[r.type," - ",r.class]}),r.template_id&&x.jsxs("p",{className:"text-xs text-cyan-400 mt-1 flex items-center gap-1",children:[x.jsx(Zo,{size:12}),"Al editar, sobrescribes los valores de la plantilla solo para este barco"]})]})]}),x.jsx("button",{onClick:s,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-white",children:x.jsx(En,{size:20})})]})}),x.jsx("form",{onSubmit:ee,className:"flex-1 overflow-y-auto custom-scrollbar",children:x.jsxs("div",{className:"p-6 space-y-6",children:[x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-4 border border-slate-700",children:[x.jsx("h3",{className:"text-sm font-bold text-cyan-400 uppercase tracking-wide mb-4",children:"Información Básica"}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{className:"col-span-2",children:[x.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:["Nombre ",x.jsx("span",{className:"text-red-400",children:"*"})]}),x.jsx("input",{type:"text",value:$.name,onChange:J=>ie("name",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition-colors",placeholder:"USS Lake Erie",required:!0})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Clase/Modelo"}),x.jsx("input",{type:"text",value:$.class,onChange:J=>ie("class",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500",placeholder:"CG-70 TICONDEROGA"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Estado"}),x.jsxs("select",{value:$.status,onChange:J=>ie("status",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",children:[x.jsx("option",{value:"activo",children:"Activo"}),x.jsx("option",{value:"patrullando",children:"Patrullando"}),x.jsx("option",{value:"estacionado",children:"Estacionado"}),x.jsx("option",{value:"en_transito",children:"En Tránsito"}),x.jsx("option",{value:"en_vuelo",children:"En Vuelo"}),x.jsx("option",{value:"vigilancia",children:"Vigilancia"})]})]})]})]}),x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-4 border border-slate-700",children:[x.jsx("h3",{className:"text-sm font-bold text-blue-400 uppercase tracking-wide mb-4",children:"Posición"}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Latitud"}),x.jsx("input",{type:"number",step:"0.0001",value:$.latitude,onChange:J=>ie("latitude",parseFloat(J.target.value)),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white font-mono focus:outline-none focus:border-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Longitud"}),x.jsx("input",{type:"number",step:"0.0001",value:$.longitude,onChange:J=>ie("longitude",parseFloat(J.target.value)),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white font-mono focus:outline-none focus:border-blue-500"})]})]})]}),x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-4 border border-slate-700",children:[x.jsx("h3",{className:"text-sm font-bold text-red-400 uppercase tracking-wide mb-4",children:"Capacidades Militares"}),x.jsxs("div",{className:"space-y-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Armamento Principal"}),x.jsx("input",{type:"text",value:$.weapon_type,onChange:J=>ie("weapon_type",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500",placeholder:"Tomahawk BGM-109, SM-2/3, Harpoon"})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Alcance de Fuego (km)"}),x.jsx("input",{type:"number",value:$.fire_range_km||"",onChange:J=>ie("fire_range_km",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:"2500"})]}),r.type!=="tropas"&&x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Alcance de Radar (km)"}),x.jsx("input",{type:"number",value:$.radar_range_km||"",onChange:J=>ie("radar_range_km",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:"320"})]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700/70 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_surface_to_surface,onChange:J=>ie("has_surface_to_surface",J.target.checked),className:"w-4 h-4 accent-red-500"}),x.jsx("span",{className:"text-sm text-slate-300",children:"🎯 Ataque Mar-Mar"})]}),x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700/70 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_surface_to_air,onChange:J=>ie("has_surface_to_air",J.target.checked),className:"w-4 h-4 accent-blue-500"}),x.jsx("span",{className:"text-sm text-slate-300",children:"🛡️ Antiaéreo"})]}),x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700/70 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_torpedoes,onChange:J=>ie("has_torpedoes",J.target.checked),className:"w-4 h-4 accent-cyan-500"}),x.jsx("span",{className:"text-sm text-slate-300",children:"🐟 Torpedos"})]}),x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700/70 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_cruise_missiles,onChange:J=>ie("has_cruise_missiles",J.target.checked),className:"w-4 h-4 accent-purple-500"}),x.jsx("span",{className:"text-sm text-slate-300",children:"🚀 Misiles Crucero"})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Sistemas Defensivos"}),x.jsx("textarea",{value:$.defensive_systems,onChange:J=>ie("defensive_systems",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 resize-none",placeholder:"Phalanx CIWS, SRBOC, AN/SLQ-32",rows:"2"})]})]})]}),x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-4 border border-slate-700",children:[x.jsx("h3",{className:"text-sm font-bold text-purple-400 uppercase tracking-wide mb-4",children:"Información Histórica"}),x.jsxs("div",{className:"space-y-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Descripción del Tipo de Plataforma"}),x.jsx("textarea",{value:$.ship_type_description,onChange:J=>ie("ship_type_description",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 resize-none",placeholder:"Crucero lanzamisiles guiados clase Ticonderoga equipado con sistema Aegis",rows:"2"})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"País de Origen"}),x.jsx("input",{type:"text",value:$.country_origin,onChange:J=>ie("country_origin",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500",placeholder:"Estados Unidos"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Astillero"}),x.jsx("input",{type:"text",value:$.manufacturer,onChange:J=>ie("manufacturer",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500",placeholder:"Bath Iron Works"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Año de Comisión"}),x.jsx("input",{type:"number",value:$.commissioned_year||"",onChange:J=>ie("commissioned_year",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:"1993"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:r.type==="tropas"?"Base de Operaciones":r.type==="avion"?"Base Aérea":"Puerto Base"}),x.jsx("input",{type:"text",value:$.homeport,onChange:J=>ie("homeport",J.target.value),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500",placeholder:r.type==="tropas"?"Guantánamo Bay, Cuba":r.type==="avion"?"Homestead AFB, Florida":"Pearl Harbor, Hawái"})]})]})]})]}),x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-4 border border-slate-700",children:[x.jsx("h3",{className:"text-sm font-bold text-green-400 uppercase tracking-wide mb-4",children:r.type==="tropas"?"Especificaciones Unidad":"Especificaciones Técnicas"}),x.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[r.type!=="tropas"&&x.jsxs(x.Fragment,{children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:r.type==="avion"?"Peso (tons)":"Desplazamiento (tons)"}),x.jsx("input",{type:"number",value:$.displacement_tons||"",onChange:J=>ie("displacement_tons",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:r.type==="avion"?"30":"9800"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:r.type==="avion"?"Longitud (m)":"Eslora (m)"}),x.jsx("input",{type:"number",step:"0.1",value:$.length_meters||"",onChange:J=>ie("length_meters",J.target.value?parseFloat(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:r.type==="avion"?"15.5":"173"})]}),r.type!=="avion"&&x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Manga (m)"}),x.jsx("input",{type:"number",step:"0.1",value:$.beam_meters||"",onChange:J=>ie("beam_meters",J.target.value?parseFloat(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:"16.8"})]}),x.jsxs("div",{children:[x.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:["Velocidad Máx. (",r.type==="avion"?"km/h":"nudos",")"]}),x.jsx("input",{type:"number",value:$.max_speed_knots||"",onChange:J=>ie("max_speed_knots",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:r.type==="avion"?"2200":"30"})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:r.type==="tropas"?"Efectivos":(r.type==="avion","Tripulación")}),x.jsx("input",{type:"number",value:$.crew_count||"",onChange:J=>ie("crew_count",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:r.type==="tropas"?"2700":r.type==="avion"?"2":"330"})]}),r.type!=="tropas"&&x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Alcance Op. (km)"}),x.jsx("input",{type:"number",value:$.range_km||"",onChange:J=>ie("range_km",J.target.value?parseInt(J.target.value):null),className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-blue-500",placeholder:r.type==="avion"?"5000":"11000"})]})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700",children:[x.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Visualización"}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Icono PNG (mapa)"}),x.jsx("div",{className:"text-xs text-slate-500 mb-2",children:"PNG sin fondo, transparente"}),$.icon_url||r.image_thumbnail_url||r.icon_url?x.jsxs("div",{className:"space-y-2",children:[x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-3 border border-slate-700 flex items-center justify-center h-24 relative",children:[x.jsx("img",{src:$.icon_url||r.image_thumbnail_url||r.icon_url,alt:"Icon preview",className:"max-h-full max-w-full object-contain"}),!$.icon_url&&!r.icon_url&&!r.image_thumbnail_url&&x.jsx("div",{className:"absolute top-1 right-1 text-xs bg-cyan-600/80 px-2 py-0.5 rounded",children:"Heredado"})]}),x.jsx("div",{className:"text-xs text-slate-500 truncate font-mono",children:(le=$.icon_url||r.image_thumbnail_url||r.icon_url)==null?void 0:le.split("/").pop()}),x.jsxs("button",{type:"button",onClick:()=>{Z("icon"),L(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 border-2 border-dashed border-blue-500/50 hover:border-blue-500 text-blue-300 rounded-lg transition-all text-sm",children:[x.jsx(C_,{size:16}),"Cambiar Icono"]})]}):x.jsxs("button",{type:"button",onClick:()=>{Z("icon"),L(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 border-2 border-dashed border-blue-500/50 hover:border-blue-500 text-blue-300 rounded-lg transition-all text-sm",children:[x.jsx(C_,{size:16}),"Subir Icono PNG"]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Video WEBM (sidebar)"}),x.jsx("div",{className:"text-xs text-slate-500 mb-2 flex items-center gap-1",children:"⚡ Recomendado: 720p, ≤5 segundos, <2MB para carga rápida"}),$.video_url||r.video_url?x.jsxs("div",{className:"space-y-2",children:[x.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-3 border border-slate-700 flex items-center justify-center h-24 relative",children:[x.jsx("video",{src:$.video_url||r.video_url,className:"max-h-full max-w-full object-contain rounded",muted:!0,loop:!0,autoPlay:!0}),!$.video_url&&!r.video_url&&x.jsx("div",{className:"absolute top-1 right-1 text-xs bg-cyan-600/80 px-2 py-0.5 rounded",children:"Heredado"})]}),x.jsx("div",{className:"text-xs text-slate-500 truncate font-mono",children:(se=$.video_url||r.video_url)==null?void 0:se.split("/").pop()}),x.jsxs("button",{type:"button",onClick:()=>{Z("video"),L(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-purple-600/20 hover:bg-purple-600/30 border-2 border-dashed border-purple-500/50 hover:border-purple-500 text-purple-300 rounded-lg transition-all text-sm",children:[x.jsx(ev,{size:16}),"Cambiar Video"]})]}):x.jsxs("button",{type:"button",onClick:()=>{Z("video"),L(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-purple-600/20 hover:bg-purple-600/30 border-2 border-dashed border-purple-500/50 hover:border-purple-500 text-purple-300 rounded-lg transition-all text-sm",children:[x.jsx(ev,{size:16}),"Subir Video WEBM"]})]})]}),x.jsx("div",{className:"mt-4 p-3 bg-blue-900/20 rounded-lg border border-blue-900/50",children:x.jsxs("p",{className:"text-xs text-slate-400",children:["💡 ",x.jsx("strong",{children:"Icono PNG:"})," usado en el mapa. ",x.jsx("strong",{children:"Video WEBM:"})," usado en sidebar y modal de detalles"]})})]})]})}),x.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800/50 flex justify-between items-center flex-shrink-0",children:[x.jsx("button",{type:"button",onClick:s,className:"px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors",children:"Cancelar"}),x.jsx("button",{type:"submit",onClick:ee,disabled:v,className:"px-6 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 disabled:from-slate-600 disabled:to-slate-600 text-white rounded-lg font-medium transition-all flex items-center gap-2 disabled:cursor-not-allowed",children:v?x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"}),"Guardando..."]}):x.jsxs(x.Fragment,{children:[x.jsx(CN,{size:16}),"Guardar Cambios"]})})]})]}),S&&x.jsx(PU,{message:S.message,type:S.type,onClose:()=>C(null)}),o&&x.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-sm",children:x.jsxs("div",{className:"bg-slate-800 rounded-xl shadow-2xl border border-slate-700 w-full max-w-2xl p-6",children:[x.jsxs("div",{className:"flex items-center justify-between mb-4",children:[x.jsx("h3",{className:"text-lg font-bold text-white",children:F==="icon"?"📌 Subir Icono PNG":"🎬 Subir Video WEBM"}),x.jsx("button",{onClick:()=>L(!1),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-white",children:x.jsx(En,{size:20})})]}),x.jsx(lR,{entityId:r.id,entityName:r.name,allowTemplateUpload:!1,onUploadComplete:J=>{F==="icon"?(J.thumbnailUrl&&W(Ee=>({...Ee,icon_url:J.thumbnailUrl})),C({message:"Icono subido y optimizado (128×128)",type:"success"})):F==="video"&&(J.videoUrl&&W(Ee=>({...Ee,video_url:J.videoUrl})),C({message:"Video subido correctamente",type:"success"})),L(!1)}})]})})]})}const jU={destructor:Ai,fragata:Ai,avion:"✈️",tropas:vs,tanque:Zo,submarino:Ai},LP={activo:{label:"Activo",emoji:"🟢",color:"#22c55e"},patrullando:{label:"Patrullando",emoji:"🟡",color:"#f59e0b"},estacionado:{label:"Estacionado",emoji:"🔵",color:"#3b82f6"},en_transito:{label:"En Tránsito",emoji:"🟣",color:"#a855f7"},en_vuelo:{label:"En Vuelo",emoji:"🔵",color:"#06b6d4"},vigilancia:{label:"Vigilancia",emoji:"🟠",color:"#f97316"}};function zU({entity:r,onClose:s,onOpenDetails:c}){var Wt;const{toggleVisibility:m,archiveEntity:v,deleteEntity:S,processing:C}=Nv(),[o,L]=Ne.useState(null),[F,Z]=Ne.useState(!1),[$,W]=Ne.useState(!1),[ee,ie]=Ne.useState(!1),[ae,ke]=Ne.useState(!1),[le,se]=Ne.useState(0);Ne.useEffect(()=>{async function fr(){if(r!=null&&r.template_id){Z(!0);try{const{data:dr,error:cr}=await yr.from("entity_templates").select("*").eq("id",r.template_id).single();!cr&&dr&&L(dr)}catch(dr){console.error("Error loading template:",dr)}finally{Z(!1)}}else L(null)}fr()},[r==null?void 0:r.template_id]);const J=async()=>{(await m(r.id,r.is_visible)).success&&(window.removeEntityDirectly&&window.removeEntityDirectly(r.id),s())},Ee=async()=>{(await v(r.id)).success&&(window.removeEntityDirectly&&window.removeEntityDirectly(r.id),s())},je=async()=>{(await S(r.id)).success&&(window.removeEntityDirectly&&window.removeEntityDirectly(r.id),s())};if(!r)return null;const Xe=fr=>r[fr]??(o==null?void 0:o[fr])??null,tt=jU[r.type]||Ai,it=LP[r.status]||LP.activo,We=r.video_url||(o==null?void 0:o.video_url)||((Wt=o==null?void 0:o.image_url)!=null&&Wt.match(/\.(webm|mp4)$/i)?o==null?void 0:o.image_url:null),Ct=r.image_url||r.image_thumbnail_url||(o==null?void 0:o.image_url)||(o==null?void 0:o.icon_url),Nt=[];return We||(Ct&&Nt.push(Ct),r.image_thumbnail_url&&r.image_url&&r.image_thumbnail_url!==r.image_url&&Nt.push(r.image_url)),x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"fixed top-20 right-4 z-50 animate-slideInFromRight flex flex-col",style:{width:"340px",maxHeight:"calc(100vh - 100px)"},children:x.jsxs("div",{className:"bg-gradient-to-br from-slate-900/95 to-slate-800/95 backdrop-blur-xl rounded-2xl border-2 shadow-2xl flex flex-col overflow-hidden",style:{borderColor:it.color,boxShadow:`0 0 30px ${it.color}30, 0 20px 60px rgba(0,0,0,0.5)`,maxHeight:"calc(100vh - 100px)"},children:[x.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-slate-700/50 flex-shrink-0",children:[x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{backgroundColor:it.color}}),x.jsx("span",{className:"text-xs font-mono text-slate-400 uppercase tracking-wider truncate max-w-[200px]",children:r.name})]}),x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx("button",{onClick:()=>alert("Configuración en desarrollo"),className:"p-1.5 hover:bg-slate-700/50 rounded-lg transition-colors",title:"Configuración",children:x.jsx(B_,{className:"w-4 h-4 text-slate-400"})}),x.jsx("button",{onClick:s,className:"p-1.5 hover:bg-slate-700/50 rounded-lg transition-colors",title:"Cerrar",children:x.jsx(En,{className:"w-4 h-4 text-slate-400"})})]})]}),x.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:[x.jsxs("div",{className:"relative bg-gradient-to-br from-slate-800 to-slate-900 overflow-hidden",style:{height:"180px"},children:[We?x.jsxs("div",{className:"relative z-10 h-full w-full bg-black flex items-center justify-center",children:[x.jsx("video",{src:We,autoPlay:!0,loop:!0,muted:!0,playsInline:!0,className:"h-full w-auto object-contain",style:{maxWidth:"100%"}}),x.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-black/20 pointer-events-none"})]}):Nt.length>0?x.jsxs(x.Fragment,{children:[x.jsx("img",{src:Nt[le],alt:r.name,className:"w-full h-full object-contain p-2"}),Nt.length>1&&x.jsx("div",{className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-2",children:Nt.map((fr,dr)=>x.jsx("div",{className:`w-2 h-2 rounded-full transition-all ${dr===le?"bg-white scale-125":"bg-white/40"}`},dr))})]}):x.jsx("div",{className:"w-full h-full flex items-center justify-center",children:typeof tt=="string"?x.jsx("span",{className:"text-7xl opacity-30",children:tt}):x.jsx(tt,{className:"w-24 h-24 text-slate-700 opacity-30",strokeWidth:1})}),(Xe("length_meters")||Xe("beam_meters"))&&x.jsxs("div",{className:"absolute bottom-2 left-2 px-2 py-1 bg-slate-900/90 backdrop-blur-sm rounded text-xs text-slate-300 font-mono",children:[Xe("length_meters"),"m × ",Xe("beam_meters"),"m"]})]}),x.jsx("div",{className:"px-4 py-2 bg-slate-800/30 border-b border-slate-700/30",children:x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:"text-base font-bold text-cyan-400 uppercase",children:r.type==="destructor"?"DESTRUCTOR":r.type==="fragata"?"FRAGATA":r.type==="avion"?"AERONAVE":r.type==="submarino"?"SUBMARINO":r.type==="tropas"?"TROPAS":r.type.toUpperCase()}),r.class&&x.jsx("div",{className:"text-xs text-slate-400 mt-0.5",children:r.class})]})}),(Xe("has_surface_to_surface")||Xe("has_surface_to_air")||Xe("has_torpedoes")||Xe("has_cruise_missiles"))&&x.jsx("div",{className:"px-4 py-2 border-b border-slate-700/30",children:x.jsxs("div",{className:"flex flex-wrap justify-center gap-1.5",children:[Xe("has_surface_to_surface")&&x.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-red-900/30 border border-red-500/50 rounded text-xs text-red-300",children:[x.jsx("span",{children:"🎯"})," Mar-Mar"]}),Xe("has_surface_to_air")&&x.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-blue-900/30 border border-blue-500/50 rounded text-xs text-blue-300",children:[x.jsx("span",{children:"🛡️"})," Antiaéreo"]}),Xe("has_torpedoes")&&x.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-cyan-900/30 border border-cyan-500/50 rounded text-xs text-cyan-300",children:[x.jsx("span",{children:"🐟"})," Torpedos"]}),Xe("has_cruise_missiles")&&x.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-purple-900/30 border border-purple-500/50 rounded text-xs text-purple-300",children:[x.jsx("span",{children:"🚀"})," Crucero"]})]})}),Xe("weapon_type")&&x.jsxs("div",{className:"px-4 py-2 bg-red-950/20 border-b border-slate-700/30",children:[x.jsxs("div",{className:"text-xs text-red-400 flex items-center gap-1 mb-1",children:[x.jsx(BS,{className:"w-3 h-3"})," ",x.jsx("span",{className:"uppercase tracking-wider",children:"Armamento"})]}),x.jsx("div",{className:"text-xs text-white leading-tight",children:Xe("weapon_type")})]}),(Xe("fire_range_km")&&Xe("fire_range_km")>=0||Xe("radar_range_km")&&r.type!=="tropas"&&Xe("radar_range_km")>0)&&x.jsxs("div",{className:"px-4 py-3 grid grid-cols-2 gap-3 border-b border-slate-700/30",children:[Xe("fire_range_km")&&Xe("fire_range_km")>=0&&x.jsxs("div",{className:`text-center p-2 bg-orange-900/20 rounded border border-orange-500/30 ${Xe("radar_range_km")&&r.type!=="tropas"&&Xe("radar_range_km")>=0?"":"col-span-2"}`,children:[x.jsx("div",{className:"text-xs text-orange-400 mb-1",children:"🔥 Alcance Fuego"}),x.jsxs("div",{className:"text-lg font-bold text-white",children:[Xe("fire_range_km").toLocaleString()," km"]})]}),Xe("radar_range_km")&&r.type!=="tropas"&&Xe("radar_range_km")>=0&&x.jsxs("div",{className:"text-center p-2 bg-green-900/20 rounded border border-green-500/30",children:[x.jsx("div",{className:"text-xs text-green-400 mb-1",children:"📡 Alcance Radar"}),x.jsxs("div",{className:"text-lg font-bold text-white",children:[Xe("radar_range_km")," km"]})]})]}),x.jsx("div",{className:"px-3 py-2",children:x.jsxs("button",{onClick:c,className:"w-full py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-1",children:[x.jsx(Zo,{className:"w-3 h-3"}),"VER DETALLES"]})}),x.jsxs("div",{className:"px-3 py-1.5 flex items-center justify-center gap-1 bg-slate-900/50 border-t border-slate-700/30",children:[x.jsx("button",{onClick:()=>ke(!0),className:"p-1.5 hover:bg-slate-700/50 rounded transition-colors",title:"Editar",children:x.jsx(FS,{className:"w-4 h-4 text-blue-400"})}),x.jsx("button",{onClick:J,disabled:C,className:"p-1.5 hover:bg-slate-700/50 rounded transition-colors disabled:opacity-50",title:r.is_visible?"Ocultar":"Mostrar",children:r.is_visible?x.jsx(F_,{className:"w-4 h-4 text-slate-400"}):x.jsx(kl,{className:"w-4 h-4 text-green-400"})}),x.jsx("button",{onClick:()=>ie(!0),disabled:C,className:"p-1.5 hover:bg-slate-700/50 rounded transition-colors disabled:opacity-50",title:"Archivar",children:x.jsx(E_,{className:"w-4 h-4 text-yellow-400"})}),x.jsx("button",{onClick:()=>W(!0),disabled:C,className:"p-1.5 hover:bg-slate-700/50 rounded transition-colors disabled:opacity-50",title:"Eliminar",children:x.jsx(Sc,{className:"w-4 h-4 text-red-400"})})]})]}),C&&x.jsxs("div",{className:"px-4 py-2 flex items-center justify-center gap-2 text-cyan-400 text-sm bg-slate-900/50 border-t border-slate-700/50 flex-shrink-0",children:[x.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-cyan-400 border-t-transparent rounded-full"}),"Procesando..."]})]})}),x.jsx(k_,{isOpen:ee,onClose:()=>ie(!1),onConfirm:Ee,title:"¿Archivar esta entidad?",message:`La entidad "${r.name}" se archivará y podrá ser restaurada más tarde.`,confirmText:"Archivar",cancelText:"Cancelar",type:"warning"}),x.jsx(k_,{isOpen:$,onClose:()=>W(!1),onConfirm:je,title:"⚠️ ¿Eliminar permanentemente?",message:`La entidad "${r.name}" será eliminada PERMANENTEMENTE.`,confirmText:"Eliminar",cancelText:"Cancelar",type:"danger"}),ae&&x.jsx(DU,{entity:r,onClose:()=>ke(!1),onSuccess:async()=>{ke(!1),window.refetchEntities&&await window.refetchEntities()}})]})}const FU={destructor:Ai,fragata:j_,avion:Wa,tropas:vs,tanque:Zo,submarino:Ai},OP={activo:{label:"Activo",color:"bg-green-500",textColor:"text-green-400"},patrullando:{label:"Patrullando",color:"bg-yellow-500",textColor:"text-yellow-400"},estacionado:{label:"Estacionado",color:"bg-blue-500",textColor:"text-blue-400"},en_transito:{label:"En Tránsito",color:"bg-purple-500",textColor:"text-purple-400"},en_vuelo:{label:"En Vuelo",color:"bg-cyan-500",textColor:"text-cyan-400"},vigilancia:{label:"Vigilancia",color:"bg-orange-500",textColor:"text-orange-400"}};function BU({entity:r,onClose:s}){var ie,ae,ke;const[c,m]=Ne.useState(null),[v,S]=Ne.useState(!1),[C,o]=Ne.useState("general");if(Ne.useEffect(()=>{async function le(){if(r!=null&&r.template_id){S(!0);try{const{data:se,error:J}=await yr.from("entity_templates").select("*").eq("id",r.template_id).single();!J&&se&&m(se)}catch(se){console.error("Error loading template:",se)}finally{S(!1)}}else m(null)}le()},[r==null?void 0:r.template_id]),!r)return null;const L=le=>r[le]??(c==null?void 0:c[le])??null,F=FU[r.type]||Ai,Z=OP[r.status]||OP.activo,$=r.last_position_update?new Date(r.last_position_update).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}):"N/A",W=r.video_url||(c==null?void 0:c.video_url)||((ie=c==null?void 0:c.image_url)!=null&&ie.match(/\.(webm|mp4)$/i)?c==null?void 0:c.image_url:null),ee=r.image_url||r.image_thumbnail_url||(c==null?void 0:c.image_url)||(c==null?void 0:c.icon_url);return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] animate-fadeIn",onClick:s}),x.jsx("div",{className:"fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[70] w-[90vw] max-w-[800px] max-h-[90vh] overflow-hidden animate-scaleIn",children:x.jsxs("div",{className:"bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border-2 border-cyan-500/30 flex flex-col",style:{maxHeight:"90vh"},children:[x.jsxs("div",{className:"relative bg-gradient-to-br from-slate-800 to-slate-900 overflow-hidden flex-shrink-0",style:{aspectRatio:W?"16/9":"auto",height:W?"auto":"280px",maxHeight:"400px"},children:[W?x.jsxs("div",{className:"relative z-10 h-full w-full bg-black flex items-center justify-center",children:[x.jsx("video",{src:W,autoPlay:!0,loop:!0,muted:!0,playsInline:!0,className:"h-full w-auto object-contain",style:{maxWidth:"100%"}}),x.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/40 pointer-events-none"})]}):ee?x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"absolute inset-0 bg-cover bg-center filter blur-lg opacity-30",style:{backgroundImage:`url(${ee})`}}),x.jsx("div",{className:"relative z-10 flex items-center justify-center h-full p-6",children:x.jsx("img",{src:ee,alt:r.name,className:"max-h-full max-w-full object-contain drop-shadow-2xl"})})]}):x.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:x.jsx(F,{className:"w-32 h-32 text-slate-700 opacity-30",strokeWidth:1})}),x.jsx("button",{onClick:s,className:"absolute top-4 right-4 p-2 bg-slate-900/80 hover:bg-slate-800 backdrop-blur-sm rounded-lg transition-colors z-20 border border-slate-700",children:x.jsx(En,{className:"w-5 h-5 text-white"})}),x.jsxs("div",{className:"absolute top-4 left-4 flex items-center gap-2 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700 z-20",children:[x.jsx(F,{className:"w-4 h-4 text-blue-400"}),x.jsx("span",{className:"text-xs font-semibold uppercase tracking-wider text-slate-200",children:r.type})]}),x.jsxs("div",{className:`absolute bottom-4 left-4 flex items-center gap-2 ${Z.color}/20 backdrop-blur-md px-3 py-2 rounded-full border ${Z.color}/50 z-20`,children:[x.jsx("div",{className:`w-2 h-2 rounded-full ${Z.color} animate-pulse`}),x.jsx("span",{className:`text-xs font-bold ${Z.textColor}`,children:Z.label.toUpperCase()})]})]}),x.jsx("div",{className:"flex-shrink-0 bg-slate-800/50 border-b border-slate-700",children:x.jsxs("div",{className:"flex",children:[x.jsx("button",{onClick:()=>o("general"),className:`flex-1 py-3 text-sm font-semibold uppercase tracking-wider transition-all ${C==="general"?"bg-cyan-600/30 text-cyan-400 border-b-2 border-cyan-400":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:"General"}),x.jsx("button",{onClick:()=>o("armamento"),className:`flex-1 py-3 text-sm font-semibold uppercase tracking-wider transition-all ${C==="armamento"?"bg-cyan-600/30 text-cyan-400 border-b-2 border-cyan-400":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:"Armamento"}),x.jsx("button",{onClick:()=>o("capacidades"),className:`flex-1 py-3 text-sm font-semibold uppercase tracking-wider transition-all ${C==="capacidades"?"bg-cyan-600/30 text-cyan-400 border-b-2 border-cyan-400":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:"Capacidades"}),x.jsx("button",{onClick:()=>o("specs"),className:`flex-1 py-3 text-sm font-semibold uppercase tracking-wider transition-all ${C==="specs"?"bg-cyan-600/30 text-cyan-400 border-b-2 border-cyan-400":"text-slate-400 hover:text-slate-300 hover:bg-slate-700/30"}`,children:"Specs"})]})}),x.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:x.jsxs("div",{className:"p-6 space-y-6",children:[x.jsxs("div",{children:[x.jsx("h2",{className:"text-3xl font-bold text-white mb-1",children:r.name}),r.class&&x.jsx("p",{className:"text-sm text-slate-400 font-mono uppercase tracking-wide",children:r.class})]}),C==="general"&&x.jsxs(x.Fragment,{children:[x.jsxs("div",{className:"bg-gradient-to-br from-cyan-950/30 to-slate-800/30 rounded-lg p-4 border border-cyan-900/30",children:[x.jsx("h3",{className:"text-sm font-bold text-cyan-400 uppercase tracking-wide mb-3",children:"Tipo de Plataforma"}),x.jsx("div",{className:"text-2xl font-bold text-white mb-2",children:r.type==="destructor"?"DESTRUCTOR":r.type==="fragata"?"FRAGATA":r.type==="avion"?"AERONAVE":r.type==="submarino"?"SUBMARINO":r.type==="tropas"?"TROPAS":r.type.toUpperCase()}),L("ship_type_description")?x.jsx("p",{className:"text-sm text-slate-300 leading-relaxed",children:L("ship_type_description")}):x.jsxs("p",{className:"text-sm text-slate-300",children:[r.type==="destructor"&&"Buque de guerra de superficie diseñado para escoltar flotas y proporcionar defensa antiaérea y antisubmarina.",r.type==="fragata"&&"Buque de guerra versátil diseñado para operaciones de escolta y patrulla.",r.type==="submarino"&&"Nave submarina de ataque diseñada para operaciones sigilosas y ataques de precisión.",r.type==="avion"&&"Plataforma aérea para superioridad, ataque, reconocimiento o transporte."]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[L("country_origin")&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"País de Origen"}),x.jsx("div",{className:"text-base text-white font-bold",children:L("country_origin")})]}),L("manufacturer")&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:r.type==="tropas"?"Organización":r.type==="avion"?"Fabricante":"Astillero"}),x.jsx("div",{className:"text-base text-white font-bold",children:L("manufacturer")})]}),r.commissioned_year&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"En Servicio Desde"}),x.jsx("div",{className:"text-base text-white font-bold",children:r.commissioned_year})]}),L("cost_millions")&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/30",children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Costo"}),x.jsxs("div",{className:"text-base text-white font-bold",children:["$",L("cost_millions"),"M USD"]})]})]}),(L("laid_down_date")||L("launched_date")||L("commissioned_date")||L("homeport"))&&x.jsxs("div",{className:"bg-gradient-to-br from-blue-950/30 to-slate-800/30 rounded-lg p-4 border border-blue-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-blue-400 uppercase tracking-wide mb-4 flex items-center gap-2",children:[x.jsx(y2,{className:"w-4 h-4"}),r.type==="tropas"?"Base de Operaciones":"Historial de Servicio"]}),x.jsxs("div",{className:"space-y-3",children:[r.type!=="tropas"&&L("laid_down_date")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Quilla Colocada"}),x.jsx("span",{className:"text-sm text-white font-semibold",children:new Date(L("laid_down_date")).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})})]}),r.type!=="tropas"&&L("launched_date")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Botadura"}),x.jsx("span",{className:"text-sm text-white font-semibold",children:new Date(L("launched_date")).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})})]}),r.type!=="tropas"&&L("commissioned_date")&&x.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-slate-700/30",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"Puesta en Servicio"}),x.jsx("span",{className:"text-sm text-white font-semibold",children:new Date(L("commissioned_date")).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})})]}),L("homeport")&&x.jsxs("div",{className:"flex justify-between items-center",children:[x.jsx("span",{className:"text-xs text-slate-400",children:r.type==="tropas"?"Base de Operaciones":r.type==="avion"?"Base Aérea":"Puerto Base"}),x.jsx("span",{className:"text-sm text-white font-semibold",children:L("homeport")})]})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/30",children:[x.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[x.jsx(ju,{className:"w-4 h-4 text-blue-400"}),x.jsx("span",{className:"text-sm text-slate-300 font-semibold",children:"Posición Actual"})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Latitud"}),x.jsxs("div",{className:"text-sm font-mono text-white",children:[(ae=r.latitude)==null?void 0:ae.toFixed(4),"°"]})]}),x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Longitud"}),x.jsxs("div",{className:"text-sm font-mono text-white",children:[(ke=r.longitude)==null?void 0:ke.toFixed(4),"°"]})]})]})]})]}),C==="armamento"&&x.jsxs(x.Fragment,{children:[L("weapon_type")&&x.jsxs("div",{className:"bg-gradient-to-br from-red-950/30 to-slate-800/30 rounded-lg p-4 border border-red-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-red-400 uppercase tracking-wide mb-3 flex items-center gap-2",children:[x.jsx(BS,{className:"w-4 h-4"}),"Sistema Principal"]}),x.jsx("p",{className:"text-base text-white font-semibold",children:L("weapon_type")})]}),L("armamento")&&x.jsxs("div",{className:"bg-gradient-to-br from-orange-950/30 to-slate-800/30 rounded-lg p-4 border border-orange-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-orange-400 uppercase tracking-wide mb-3 flex items-center gap-2",children:[x.jsx(b2,{className:"w-4 h-4"}),"Arsenal Completo"]}),x.jsx("p",{className:"text-sm text-slate-300 leading-relaxed",children:L("armamento")})]}),L("defensive_systems")&&x.jsxs("div",{className:"bg-gradient-to-br from-blue-950/30 to-slate-800/30 rounded-lg p-4 border border-blue-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-blue-400 uppercase tracking-wide mb-3 flex items-center gap-2",children:[x.jsx(Zo,{className:"w-4 h-4"}),"Sistemas Defensivos"]}),x.jsx("p",{className:"text-sm text-slate-300 leading-relaxed",children:L("defensive_systems")})]})]}),C==="capacidades"&&x.jsxs(x.Fragment,{children:[x.jsxs("div",{className:"bg-gradient-to-br from-purple-950/30 to-slate-800/30 rounded-lg p-4 border border-purple-900/30",children:[x.jsx("h3",{className:"text-sm font-bold text-purple-400 uppercase tracking-wide mb-4",children:"Capacidades Tácticas"}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("div",{className:`p-3 rounded-lg border ${L("has_surface_to_surface")?"bg-red-900/20 border-red-500/50":"bg-slate-800/30 border-slate-600/30"}`,children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Ataque Mar-Mar"}),x.jsx("div",{className:`text-lg font-bold ${L("has_surface_to_surface")?"text-red-400":"text-slate-600"}`,children:L("has_surface_to_surface")?"✓ Activa":"✗ No"})]}),x.jsxs("div",{className:`p-3 rounded-lg border ${L("has_surface_to_air")?"bg-blue-900/20 border-blue-500/50":"bg-slate-800/30 border-slate-600/30"}`,children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Defensa Antiaérea"}),x.jsx("div",{className:`text-lg font-bold ${L("has_surface_to_air")?"text-blue-400":"text-slate-600"}`,children:L("has_surface_to_air")?"✓ Activa":"✗ No"})]}),x.jsxs("div",{className:`p-3 rounded-lg border ${L("has_torpedoes")?"bg-cyan-900/20 border-cyan-500/50":"bg-slate-800/30 border-slate-600/30"}`,children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Torpedos"}),x.jsx("div",{className:`text-lg font-bold ${L("has_torpedoes")?"text-cyan-400":"text-slate-600"}`,children:L("has_torpedoes")?"✓ Activa":"✗ No"})]}),x.jsxs("div",{className:`p-3 rounded-lg border ${L("has_cruise_missiles")?"bg-purple-900/20 border-purple-500/50":"bg-slate-800/30 border-slate-600/30"}`,children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Misiles Crucero"}),x.jsx("div",{className:`text-lg font-bold ${L("has_cruise_missiles")?"text-purple-400":"text-slate-600"}`,children:L("has_cruise_missiles")?"✓ Activa":"✗ No"})]})]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[L("fire_range_km")&&x.jsxs("div",{className:"bg-gradient-to-br from-orange-950/30 to-slate-800/30 rounded-lg p-4 border border-orange-900/30",children:[x.jsxs("h3",{className:"text-xs text-orange-400 mb-2 flex items-center gap-1",children:[x.jsx(b2,{className:"w-3 h-3"})," Alcance de Fuego"]}),x.jsx("p",{className:"text-3xl font-bold text-white",children:L("fire_range_km").toLocaleString()}),x.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"kilómetros"})]}),L("radar_range_km")&&x.jsxs("div",{className:"bg-gradient-to-br from-green-950/30 to-slate-800/30 rounded-lg p-4 border border-green-900/30",children:[x.jsxs("h3",{className:"text-xs text-green-400 mb-2 flex items-center gap-1",children:[x.jsx(Jx,{className:"w-3 h-3"})," Alcance de Radar"]}),x.jsx("p",{className:"text-3xl font-bold text-white",children:L("radar_range_km")}),x.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"kilómetros"})]})]})]}),C==="specs"&&x.jsxs(x.Fragment,{children:[x.jsxs("div",{className:"bg-gradient-to-br from-blue-950/30 to-slate-800/30 rounded-lg p-4 border border-blue-900/30",children:[x.jsxs("h3",{className:"text-sm font-bold text-blue-400 uppercase tracking-wide mb-4 flex items-center gap-2",children:[x.jsx(Zo,{className:"w-4 h-4"}),"Especificaciones Técnicas"]}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.type!=="tropas"&&L("displacement_tons")&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:r.type==="avion"?"Peso":"Desplazamiento"}),x.jsxs("div",{className:"text-xl text-white font-bold",children:[L("displacement_tons").toLocaleString()," tons"]})]}),r.type!=="tropas"&&L("length_meters")&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:r.type==="avion"?"Longitud":"Eslora"}),x.jsxs("div",{className:"text-xl text-white font-bold",children:[L("length_meters")," m"]})]}),r.type!=="tropas"&&r.type!=="avion"&&L("beam_meters")&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Manga"}),x.jsxs("div",{className:"text-xl text-white font-bold",children:[L("beam_meters")," m"]})]}),L("crew_count")&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:r.type==="tropas"?"Efectivos":"Tripulación"}),x.jsxs("div",{className:"text-xl text-white font-bold",children:[L("crew_count").toLocaleString(),r.type==="tropas"&&" personal"]})]}),r.type!=="tropas"&&L("range_km")&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Alcance Operativo"}),x.jsxs("div",{className:"text-xl text-white font-bold",children:[L("range_km").toLocaleString()," km"]})]}),r.commissioned_year&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:r.type==="tropas"?"Establecido":"En Servicio"}),x.jsx("div",{className:"text-xl text-white font-bold",children:r.commissioned_year})]}),r.type!=="tropas"&&L("max_speed_knots")&&x.jsxs("div",{children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:(r.type==="avion","Velocidad Máxima")}),x.jsxs("div",{className:"text-xl text-white font-bold",children:[L("max_speed_knots")," ",r.type==="avion"?"km/h":"nudos"]})]}),r.type!=="tropas"&&L("propulsion")&&x.jsxs("div",{className:"col-span-2",children:[x.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Propulsión"}),x.jsx("div",{className:"text-sm text-white",children:L("propulsion")})]})]})]}),x.jsxs("div",{className:"flex items-center justify-center gap-2 pt-4 border-t border-slate-700/50",children:[x.jsx(y2,{className:"w-3.5 h-3.5 text-slate-500"}),x.jsxs("span",{className:"text-xs text-slate-500",children:["Actualizado: ",$]})]})]})]})}),x.jsx("div",{className:"p-4 border-t border-slate-700/50 bg-slate-900/50 flex-shrink-0",children:x.jsx("button",{onClick:s,className:"w-full py-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg transition-colors",children:"Cerrar"})})]})})]})}yp.accessToken=Gz;function UU({onRefetchNeeded:r,onTemplateDrop:s,showPalette:c,onMapReady:m}){const v=Ne.useRef(null),S=Ne.useRef(null),[C,o]=Ne.useState(!1),[L,F]=Ne.useState(null),[Z,$]=Ne.useState(null),[W,ee]=Ne.useState(null),[ie,ae]=Ne.useState(6),[ke,le]=Ne.useState(()=>parseInt(localStorage.getItem("clusterZoomThreshold")||"8")),[se,J]=Ne.useState(()=>parseInt(localStorage.getItem("clusterRadius")||"60")),{isLocked:Ee}=US(),{selectEntity:je}=Ev(),[Xe,tt]=Ne.useState(()=>localStorage.getItem("entityViewMode")||"card"),[it,We]=Ne.useState(!1),{showBoundaries:Ct}=aR(),{settings:Nt,loading:Wt}=sR(),fr=Ne.useMemo(()=>!Nt||Wt?[]:Nt.filter(pr=>pr.is_visible).map(pr=>pr.country_code),[Nt,Wt]),dr=Ne.useMemo(()=>{if(!Nt||Wt)return{};const pr={};return Nt.forEach($r=>{pr[$r.country_code]=$r.color}),pr},[Nt,Wt]),{boundaries:cr}=F4(fr,Ct),{entities:Ut,loading:jr,error:Ht,refetch:xr,addEntity:Rt,removeEntity:rr}=Mv(),{groups:Nr,loading:Un,deleteGroup:us,fetchGroups:rs}=HS(),[Yr,vi]=Ne.useState({});Ne.useEffect(()=>{async function pr(){if(!(localStorage.getItem("useImages")==="true")||!Ut||Ut.length===0)return;const Di=[...new Set(Ut.map(oi=>oi.template_id).filter(Boolean))];if(Di.length!==0)try{const{data:oi}=await yr.from("entity_templates").select("id, icon_url, image_url").in("id",Di);if(oi){const Gr={};oi.forEach(un=>{Gr[un.id]=un}),vi(Gr)}}catch(oi){console.error("Error caching templates:",oi)}}pr()},[Ut]),Ne.useEffect(()=>{r&&(window.refetchEntities=xr,window.addEntityDirectly=Rt,window.removeEntityDirectly=rr)},[xr,Rt,rr,r]),Ne.useEffect(()=>{const pr=$r=>{$r.detail.clusterZoomThreshold!==void 0&&le($r.detail.clusterZoomThreshold),$r.detail.clusterRadius!==void 0&&J($r.detail.clusterRadius),$r.detail.entityViewMode!==void 0&&tt($r.detail.entityViewMode)};return window.addEventListener("settingsChanged",pr),()=>window.removeEventListener("settingsChanged",pr)},[]);const{updatePosition:Vi}=wU(),Vn=async(pr,$r)=>{try{await Vi(pr,$r),await xr()}catch(Di){console.error("❌ Error al mover entidad:",Di),alert("Error al actualizar posición. Por favor, intenta de nuevo.")}},or=async(pr,$r,Di)=>{try{const oi=pr.members.map(async Gr=>{const un=Gr.entity;if(!un)return;const Zn={latitude:parseFloat(un.latitude)+$r,longitude:parseFloat(un.longitude)+Di};return Vi(un.id,Zn)});await Promise.all(oi),setTimeout(()=>{xr(),rs()},200)}catch(oi){console.error("❌ Error al mover grupo:",oi),alert("Error al mover el grupo. Por favor, intenta de nuevo.")}};return Ne.useEffect(()=>{if(S.current)return;S.current=new yp.Map({container:v.current,style:nx.style,center:nx.center,zoom:nx.zoom,...nx.options}),S.current.addControl(new yp.NavigationControl({visualizePitch:!0,showCompass:!0}),"top-right"),S.current.addControl(new yp.ScaleControl({maxWidth:200,unit:"metric"}),"bottom-left"),S.current.on("load",()=>{o(!0),m&&m(S.current)});const pr=v.current,$r=Gr=>{if(Gr.preventDefault(),Gr.dataTransfer.dropEffect="copy",S.current){const un=pr.getBoundingClientRect(),Zn=Gr.clientX-un.left,po=Gr.clientY-un.top,In=S.current.unproject([Zn,po]);ee({x:Gr.clientX,y:Gr.clientY,lat:In.lat,lng:In.lng})}},Di=()=>{ee(null)},oi=Gr=>{Gr.preventDefault(),ee(null);try{const un=JSON.parse(Gr.dataTransfer.getData("application/json"));if(un&&S.current){const Zn=pr.getBoundingClientRect(),po=Gr.clientX-Zn.left,In=Gr.clientY-Zn.top,ji=S.current.unproject([po,In]);s&&s(un,{lat:ji.lat,lng:ji.lng})}}catch(un){console.error("Error al procesar drop:",un)}};return pr.addEventListener("dragover",$r),pr.addEventListener("dragleave",Di),pr.addEventListener("drop",oi),()=>{pr.removeEventListener("dragover",$r),pr.removeEventListener("dragleave",Di),pr.removeEventListener("drop",oi),S.current&&(S.current.remove(),S.current=null)}},[]),Ne.useEffect(()=>{if(!S.current||!C||jr||!Ut||Ut.length===0)return;const pr="entities-source",$r="clusters",Di="cluster-count",oi="unclustered-point",Gr={type:"FeatureCollection",features:Ut.filter(ji=>ji.latitude&&ji.longitude&&ji.is_visible!==!1).map(ji=>({type:"Feature",geometry:{type:"Point",coordinates:[parseFloat(ji.longitude),parseFloat(ji.latitude)]},properties:{id:ji.id,name:ji.name,type:ji.type,class:ji.class||"",status:ji.status||"activo"}}))};if(S.current.getSource(pr)){S.current.getSource(pr).setData(Gr);return}S.current.addSource(pr,{type:"geojson",data:Gr,cluster:!0,clusterMaxZoom:ke-1,clusterRadius:se}),S.current.addLayer({id:"clusters-pulse-outer",type:"circle",source:pr,filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#3b82f6",5,"#f59e0b",10,"#ef4444"],"circle-radius":["step",["get","point_count"],40,5,50,10,60],"circle-opacity":0,"circle-blur":1}}),S.current.addLayer({id:$r,type:"circle",source:pr,filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#3b82f6",5,"#f59e0b",10,"#ef4444"],"circle-radius":["step",["get","point_count"],26,5,32,10,38],"circle-stroke-width":0,"circle-opacity":.95}}),S.current.addLayer({id:Di,type:"symbol",source:pr,filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#ffffff","text-halo-color":"rgba(0, 0, 0, 0.8)","text-halo-width":2}}),S.current.addLayer({id:`${oi}-glow`,type:"circle",source:pr,filter:["!",["has","point_count"]],paint:{"circle-color":"#ef4444","circle-radius":22,"circle-opacity":0,"circle-blur":1}}),S.current.addLayer({id:oi,type:"circle",source:pr,filter:["!",["has","point_count"]],paint:{"circle-color":"#ef4444","circle-radius":12,"circle-stroke-width":0,"circle-opacity":.95}}),S.current.on("click",$r,ji=>{const on=S.current.queryRenderedFeatures(ji.point,{layers:[$r]});if(on.length>0){const $s=on[0].properties.cluster_id;S.current.getSource(pr).getClusterExpansionZoom($s,(Ts,Co)=>{Ts||S.current.easeTo({center:on[0].geometry.coordinates,zoom:Co+.5,duration:500})})}}),S.current.on("click",oi,ji=>{const $s=ji.features[0].properties.id,Ts=Ut.find(Co=>Co.id===$s);Ts&&(F(Ts),je(Ts.id))}),S.current.on("mouseenter",$r,()=>{S.current.getCanvas().style.cursor="pointer"}),S.current.on("mouseleave",$r,()=>{S.current.getCanvas().style.cursor=""}),S.current.on("mouseenter",oi,()=>{S.current.getCanvas().style.cursor="pointer"}),S.current.on("mouseleave",oi,()=>{S.current.getCanvas().style.cursor=""});const un=()=>{const ji=S.current.getZoom();ae(ji);const on=ji<ke;S.current.getLayer("clusters-pulse-outer")&&S.current.setLayoutProperty("clusters-pulse-outer","visibility",on?"visible":"none"),S.current.getLayer($r)&&S.current.setLayoutProperty($r,"visibility",on?"visible":"none"),S.current.getLayer(Di)&&S.current.setLayoutProperty(Di,"visibility",on?"visible":"none"),S.current.getLayer(`${oi}-glow`)&&S.current.setLayoutProperty(`${oi}-glow`,"visibility",on?"visible":"none"),S.current.getLayer(oi)&&S.current.setLayoutProperty(oi,"visibility",on?"visible":"none")};S.current.on("zoom",un),un();let Zn=0;const po=()=>{if(!S.current)return;Zn++;const ji=.15+Math.sin(Zn*.04)*.12;S.current.getLayer("clusters-pulse-outer")&&S.current.setPaintProperty("clusters-pulse-outer","circle-opacity",ji),S.current.getLayer(`${oi}-glow`)&&S.current.setPaintProperty(`${oi}-glow`,"circle-opacity",ji*.8),requestAnimationFrame(po)},In=requestAnimationFrame(po);return()=>{cancelAnimationFrame(In),S.current&&(S.current.getLayer("clusters-pulse-outer")&&S.current.removeLayer("clusters-pulse-outer"),S.current.getLayer($r)&&S.current.removeLayer($r),S.current.getLayer(Di)&&S.current.removeLayer(Di),S.current.getLayer(`${oi}-glow`)&&S.current.removeLayer(`${oi}-glow`),S.current.getLayer(oi)&&S.current.removeLayer(oi),S.current.getSource(pr)&&S.current.removeSource(pr))}},[C,Ut,jr,je,ke,se]),x.jsxs("div",{style:{width:"100%",height:"100vh",position:"relative"},children:[Xe==="sidebar"?x.jsx(EU,{entity:L,onClose:()=>F(null),isOpen:!!L&&!Z}):L&&!Z&&x.jsx(zU,{entity:L,onClose:()=>F(null),onOpenDetails:()=>We(!0)}),Xe==="card"&&it&&L&&x.jsx(BU,{entity:L,onClose:()=>We(!1)}),x.jsx(IU,{group:Z,onClose:()=>$(null),onSelectMember:pr=>{F(pr),$(null)},onDissolveGroup:async pr=>{await us(pr),await rs(),$(null)},isOpen:!!Z}),x.jsx("div",{ref:v,className:W?"map-drop-active":"",style:{position:"absolute",top:"56px",left:0,right:0,bottom:0}}),C&&x.jsx(B4,{map:S.current,boundaries:cr,visible:Ct,colorMap:dr}),C&&!Un&&ie>=ke&&Nr.filter(pr=>pr.is_visible&&pr.count>0).map(pr=>x.jsx(z4,{group:pr,map:S.current,onGroupClick:$r=>{$($r),F(null)},onGroupMove:or},pr.id)),C&&!jr&&ie>=ke&&(()=>{const pr=new Set(Nr.flatMap($r=>{var Di;return((Di=$r.members)==null?void 0:Di.map(oi=>{var Gr;return(Gr=oi.entity)==null?void 0:Gr.id}))||[]}));return Ut.filter($r=>$r.is_visible!==!1&&!pr.has($r.id)).map($r=>x.jsx(j4,{entity:$r,template:Yr[$r.template_id],map:S.current,onPositionChange:Vn,onEntityClick:()=>F($r)},$r.id))})(),jr&&x.jsx("div",{className:"absolute top-20 left-1/2 transform -translate-x-1/2 bg-military-bg-secondary/90 backdrop-blur-sm text-military-text-primary px-4 py-2 rounded-md shadow-lg",children:"🔄 Cargando entidades desde Supabase..."}),Ht&&x.jsxs("div",{className:"absolute top-20 left-1/2 transform -translate-x-1/2 bg-military-accent-danger/90 backdrop-blur-sm text-white px-4 py-2 rounded-md shadow-lg",children:["❌ Error: ",Ht]}),W&&x.jsxs("div",{className:"fixed pointer-events-none bg-blue-600/95 backdrop-blur-sm text-white px-3 py-2 rounded-lg shadow-xl text-sm font-mono border border-blue-400",style:{left:W.x+20,top:W.y+20,zIndex:9999},children:["📍 ",W.lat.toFixed(4),"°, ",W.lng.toFixed(4),"°"]}),Ee&&x.jsx("div",{className:"absolute top-20 left-4 bg-orange-600/90 backdrop-blur-sm text-white p-3 rounded-full shadow-lg flex items-center justify-center animate-pulse",children:x.jsx(EN,{className:"w-5 h-5"})}),C&&!jr&&x.jsx(CU,{})]})}function cR(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!0),[v,S]=Ne.useState(null);Ne.useEffect(()=>{C()},[]);async function C(){try{m(!0),S(null);const{data:le,error:se}=await yr.from("entity_templates").select("*").eq("is_active",!0).order("category",{ascending:!0}).order("entity_type",{ascending:!0}).order("display_name",{ascending:!0});if(se)throw se;s(le||[])}catch(le){console.error("Error fetching templates:",le),S(le.message)}finally{m(!1)}}async function o(le){try{const{data:se,error:J}=await yr.from("entity_templates").select("*").eq("category",le).eq("is_active",!0).order("entity_type",{ascending:!0});if(J)throw J;return se||[]}catch(se){return console.error("Error fetching templates by category:",se),[]}}async function L(le){try{const{data:se,error:J}=await yr.from("entity_templates").select("*").eq("entity_type",le).eq("is_active",!0).order("display_name",{ascending:!0});if(J)throw J;return se||[]}catch(se){return console.error("Error fetching templates by type:",se),[]}}async function F(le){try{const{data:se,error:J}=await yr.from("entity_templates").select("*").eq("code",le).single();if(J)throw J;return se}catch(se){return console.error("Error fetching template by code:",se),null}}async function Z(le){try{const{data:se,error:J}=await yr.from("entity_templates").select("*").eq("id",le).single();if(J)throw J;return se}catch(se){return console.error("Error fetching template by id:",se),null}}async function $(le){try{const{data:se,error:J}=await yr.from("entity_templates").insert(le).select().single();if(J)throw J;return await C(),{success:!0,data:se}}catch(se){return console.error("Error creating template:",se),{success:!1,error:se.message}}}async function W(le,se){try{const{data:J,error:Ee}=await yr.from("entity_templates").update(se).eq("id",le).select().single();if(Ee)throw Ee;return await C(),{success:!0,data:J}}catch(J){return console.error("Error updating template:",J),{success:!1,error:J.message}}}async function ee(le){try{const{error:se}=await yr.from("entity_templates").update({is_active:!1}).eq("id",le);if(se)throw se;return await C(),{success:!0}}catch(se){return console.error("Error deleting template:",se),{success:!1,error:se.message}}}async function ie(le=5){try{const{data:se,error:J}=await yr.from("entity_templates").select("*").eq("is_active",!0).order("usage_count",{ascending:!1}).limit(le);if(J)throw J;return se||[]}catch(se){return console.error("Error fetching top templates:",se),[]}}function ae(le){if(!le||le.trim().length===0)return[];const se=le.toLowerCase().trim();return r.filter(J=>[J.name,J.display_name,J.description,J.class,J.code,J.entity_type,J.category,J.sub_type].filter(Boolean).join(" ").toLowerCase().includes(se))}function ke(){const le={};return r.forEach(se=>{const{category:J,entity_type:Ee}=se;le[J]||(le[J]={}),le[J][Ee]||(le[J][Ee]=[]),le[J][Ee].push(se)}),le}return{templates:r,loading:c,error:v,fetchTemplates:C,getTemplatesByCategory:o,getTemplatesByType:L,getTemplateByCode:F,getTemplateById:Z,getTopTemplates:ie,searchTemplates:ae,getTemplatesHierarchy:ke,createTemplate:$,updateTemplate:W,deleteTemplate:ee}}function DP({template:r,onDragStart:s,onClick:c,isFavorite:m,onToggleFavorite:v,onShowDetails:S}){const[C,o]=Ne.useState(!1),F={destructor:Ai,fragata:Ai,portaaviones:Ai,submarino:Ai,avion:Wa,tropas:vs,tanque:Zo}[r.entity_type]||Ai,Z=ae=>{o(!0),ae.dataTransfer.effectAllowed="copy",ae.dataTransfer.setData("application/json",JSON.stringify(r));const ke=document.createElement("div");ke.style.position="absolute",ke.style.top="-9999px",document.body.appendChild(ke),ae.dataTransfer.setDragImage(ke,0,0),s&&s(r,ae)},$=()=>{o(!1)},W=()=>{c&&c(r)},ee=ae=>{ae.stopPropagation(),v&&v(r.id)},ie=ae=>{ae.stopPropagation(),S&&S(r)};return x.jsxs("div",{draggable:!0,onDragStart:Z,onDragEnd:$,onClick:W,className:`
        relative group
        bg-slate-800 border border-slate-700 rounded-lg 
        transition-all duration-200 cursor-grab
        hover:bg-slate-700 hover:border-blue-500 hover:scale-[1.02]
        hover:shadow-lg hover:shadow-blue-500/20
        ${C?"opacity-50 cursor-grabbing":""}
        ${m?"border-l-4 border-l-yellow-500":""}
      `,children:[x.jsxs("div",{className:"absolute top-2 right-2 z-10 flex gap-1",children:[x.jsx("button",{onClick:ie,className:"p-1 rounded-full bg-slate-700/80 hover:bg-blue-600 transition-colors",title:"Ver detalles completos",children:x.jsx(SN,{size:14,className:"text-slate-300"})}),x.jsx("button",{onClick:ee,className:"p-1 rounded-full hover:bg-slate-600 transition-colors",title:m?"Quitar de favoritos":"Agregar a favoritos",children:x.jsx(AN,{size:14,className:`${m?"fill-yellow-400 text-yellow-400":"text-slate-500"}`})})]}),x.jsxs("div",{className:"p-3 space-y-2",children:[x.jsxs("div",{className:"flex items-start space-x-2",children:[x.jsx("div",{className:"flex-shrink-0 p-2 rounded-lg",style:{backgroundColor:`${r.icon_color}20`},children:x.jsx(F,{size:24,style:{color:r.icon_color}})}),x.jsxs("div",{className:"flex-1 min-w-0",children:[x.jsx("h3",{className:"text-sm font-semibold text-white truncate pr-4",children:r.display_name}),x.jsx("p",{className:"text-xs text-slate-400",children:r.class||r.name})]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-1 text-xs text-slate-300",children:[r.length_meters&&x.jsxs("div",{className:"flex items-center space-x-1",children:[x.jsx("span",{className:"text-slate-500",children:"📏"}),x.jsxs("span",{children:[r.length_meters,"m"]})]}),r.displacement_tons&&x.jsxs("div",{className:"flex items-center space-x-1",children:[x.jsx("span",{className:"text-slate-500",children:"⚖️"}),x.jsxs("span",{children:[r.displacement_tons.toLocaleString(),"t"]})]}),r.max_speed_knots&&x.jsxs("div",{className:"flex items-center space-x-1",children:[x.jsx("span",{className:"text-slate-500",children:"⚡"}),x.jsxs("span",{children:[r.max_speed_knots," kn"]})]}),r.crew_count&&x.jsxs("div",{className:"flex items-center space-x-1",children:[x.jsx("span",{className:"text-slate-500",children:"👥"}),x.jsx("span",{children:r.crew_count})]})]}),x.jsxs("div",{className:"flex items-center justify-between pt-1",children:[r.country_origin&&x.jsx("span",{className:"text-xs px-2 py-0.5 bg-slate-700 text-slate-300 rounded",children:r.country_origin}),r.usage_count>0&&x.jsxs("span",{className:"text-xs text-slate-500",children:[r.usage_count," en mapa"]})]}),x.jsx("div",{className:"pt-2 border-t border-slate-700 text-center",children:x.jsx("span",{className:"text-xs text-blue-400 group-hover:text-blue-300 transition-colors",children:"🖱️ Arrastrar al mapa"})})]}),C&&x.jsx("div",{className:"absolute inset-0 bg-blue-500/20 border-2 border-blue-400 border-dashed rounded-lg pointer-events-none"})]})}function VU({onClose:r}){const{templates:s,createTemplate:c,updateTemplate:m,deleteTemplate:v}=cR(),[S,C]=Ne.useState("list"),[o,L]=Ne.useState(null),[F,Z]=Ne.useState(""),[$,W]=Ne.useState(le()),[ee,ie]=Ne.useState(!1),[ae,ke]=Ne.useState(null);function le(){return{name:"",code:"",display_name:"",description:"",category:"militar",entity_type:"destructor",sub_type:"",class:"",displacement_tons:"",length_meters:"",beam_meters:"",max_speed_knots:"",crew_count:"",range_km:"",air_wing:"",propulsion:"",thrust_hp:"",country_origin:"",manufacturer:"",era:"moderno",armamento:"",icon_color:"#3b82f6",image_url:"",weapon_type:"",fire_range_km:"",radar_range_km:"",has_surface_to_surface:!1,has_surface_to_air:!1,has_torpedoes:!1,has_cruise_missiles:!1,defensive_systems:"",ship_type_description:"",laid_down_date:"",launched_date:"",commissioned_date:"",homeport:""}}Ne.useEffect(()=>{S==="edit"&&o?W(o):S==="create"&&W(le())},[S,o]);const se=async We=>{if(We.preventDefault(),!$.name||!$.display_name){alert("Nombre y Nombre de Visualización son obligatorios");return}let Ct;S==="edit"?Ct=await m(o.id,$):Ct=await c($),Ct.success?(C("list"),L(null),W(le())):alert(`Error: ${Ct.error}`)},J=async We=>{if(!confirm(`¿Eliminar la plantilla "${We.display_name}"?`))return;const Ct=await v(We.id);Ct.success?console.log("✅ Plantilla eliminada"):alert(`Error: ${Ct.error}`)},Ee=We=>{C("create"),W({...We,id:void 0,code:`${We.code}-copy`,name:`${We.name} (Copia)`,display_name:`${We.display_name} (Copia)`,usage_count:0})},je=We=>{L(We),C("edit")},Xe=We=>{W(ae==="icon"?{...$,icon_url:We.thumbnail||We.full}:ae==="video"?{...$,image_url:We.full}:{...$,image_url:We.full,icon_url:We.thumbnail}),ie(!1),ke(null)},tt=s.filter(We=>We.display_name.toLowerCase().includes(F.toLowerCase())||We.name.toLowerCase().includes(F.toLowerCase())||We.category.toLowerCase().includes(F.toLowerCase())),it={destructor:Ai,fragata:Ai,portaaviones:Ai,submarino:Ai,avion:Wa,tropas:vs,tanque:Zo};return x.jsxs("div",{className:"fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4",children:[x.jsxs("div",{className:"bg-slate-900 rounded-xl shadow-2xl border border-slate-700 w-full max-w-6xl max-h-[95vh] flex flex-col",children:[x.jsxs("div",{className:"p-6 border-b border-slate-700 bg-gradient-to-r from-blue-900/30 to-slate-800 flex justify-between items-center",children:[x.jsxs("div",{children:[x.jsxs("h2",{className:"text-2xl font-bold text-white flex items-center gap-2",children:[x.jsx(B_,{className:"w-6 h-6"}),"Administración de Plantillas"]}),x.jsxs("p",{className:"text-sm text-slate-400 mt-1",children:[S==="list"&&`${s.length} plantillas disponibles`,S==="create"&&"Crear nueva plantilla",S==="edit"&&`Editando: ${o==null?void 0:o.display_name}`]})]}),x.jsx("button",{onClick:r,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-white",children:x.jsx(En,{size:24})})]}),x.jsxs("div",{className:"flex-1 overflow-hidden flex",children:[S==="list"&&x.jsxs("div",{className:"flex-1 flex flex-col",children:[x.jsxs("div",{className:"p-4 border-b border-slate-700 bg-slate-800/50 flex gap-3",children:[x.jsxs("div",{className:"flex-1 relative",children:[x.jsx(Pp,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400",size:18}),x.jsx("input",{type:"text",placeholder:"Buscar plantillas...",value:F,onChange:We=>Z(We.target.value),className:"w-full pl-10 pr-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("button",{onClick:()=>C("create"),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:[x.jsx(lh,{size:18}),x.jsx("span",{children:"Nueva Plantilla"})]})]}),x.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:x.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:tt.map(We=>{const Ct=it[We.entity_type]||Ai;return x.jsxs("div",{className:"bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-blue-500 transition-all group",children:[x.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[x.jsx("div",{className:"p-2 rounded-lg",style:{backgroundColor:`${We.icon_color}20`},children:x.jsx(Ct,{size:24,style:{color:We.icon_color}})}),x.jsxs("div",{className:"flex-1 min-w-0",children:[x.jsx("h3",{className:"font-semibold text-white truncate",children:We.display_name}),x.jsx("p",{className:"text-xs text-slate-400 truncate",children:We.code})]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs mb-3",children:[x.jsxs("div",{className:"text-slate-400",children:[x.jsx("span",{className:"text-slate-500",children:"Categoría:"})," ",x.jsx("span",{className:"text-white",children:We.category})]}),x.jsxs("div",{className:"text-slate-400",children:[x.jsx("span",{className:"text-slate-500",children:"Tipo:"})," ",x.jsx("span",{className:"text-white",children:We.entity_type})]}),x.jsxs("div",{className:"text-slate-400",children:[x.jsx("span",{className:"text-slate-500",children:"Usos:"})," ",x.jsx("span",{className:"text-white",children:We.usage_count})]}),We.country_origin&&x.jsxs("div",{className:"text-slate-400",children:[x.jsx("span",{className:"text-slate-500",children:"País:"})," ",x.jsx("span",{className:"text-white",children:We.country_origin})]})]}),x.jsxs("div",{className:"flex gap-2 pt-3 border-t border-slate-700",children:[x.jsxs("button",{onClick:()=>je(We),className:"flex-1 flex items-center justify-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs transition-colors",children:[x.jsx(FS,{size:12}),"Editar"]}),x.jsxs("button",{onClick:()=>Ee(We),className:"flex-1 flex items-center justify-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs transition-colors",children:[x.jsx(mF,{size:12}),"Clonar"]}),x.jsx("button",{onClick:()=>J(We),className:"flex items-center justify-center gap-1 px-3 py-1.5 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded text-xs transition-colors",children:x.jsx(Sc,{size:12})})]})]},We.id)})})})]}),(S==="create"||S==="edit")&&x.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:x.jsxs("form",{onSubmit:se,className:"max-w-4xl mx-auto space-y-6",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700",children:[x.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Información Básica"}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Nombre Interno (código) *"}),x.jsx("input",{type:"text",value:$.code,onChange:We=>W({...$,code:We.target.value}),placeholder:"destroyer-arleigh-burke",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500",required:!0}),x.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Formato: tipo-nombre (sin espacios)"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Nombre de Visualización *"}),x.jsx("input",{type:"text",value:$.display_name,onChange:We=>W({...$,display_name:We.target.value}),placeholder:"Destructor Arleigh Burke",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500",required:!0})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Nombre Corto"}),x.jsx("input",{type:"text",value:$.name,onChange:We=>W({...$,name:We.target.value}),placeholder:"Arleigh Burke",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Clase"}),x.jsx("input",{type:"text",value:$.class,onChange:We=>W({...$,class:We.target.value}),placeholder:"Arleigh Burke Class Flight IIA",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{className:"col-span-2",children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Descripción"}),x.jsx("textarea",{value:$.description,onChange:We=>W({...$,description:We.target.value}),placeholder:"Descripción detallada de la plantilla...",rows:3,className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700",children:[x.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Clasificación"}),x.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Categoría"}),x.jsxs("select",{value:$.category,onChange:We=>W({...$,category:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500",children:[x.jsx("option",{value:"militar",children:"🎖️ Militar"}),x.jsx("option",{value:"civil",children:"🏢 Civil"}),x.jsx("option",{value:"comercial",children:"🏭 Comercial"})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Tipo de Entidad"}),x.jsxs("select",{value:$.entity_type,onChange:We=>W({...$,entity_type:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500",children:[x.jsx("option",{value:"destructor",children:"🚢 Destructor"}),x.jsx("option",{value:"fragata",children:"⚓ Fragata"}),x.jsx("option",{value:"portaaviones",children:"🛳️ Portaaviones"}),x.jsx("option",{value:"submarino",children:"🔱 Submarino"}),x.jsx("option",{value:"avion",children:"✈️ Avión"}),x.jsx("option",{value:"tropas",children:"👤 Personal"}),x.jsx("option",{value:"tanque",children:"🛡️ Vehículo"})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Subtipo"}),x.jsx("input",{type:"text",value:$.sub_type,onChange:We=>W({...$,sub_type:We.target.value}),placeholder:"guiado-misiles, caza, etc.",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700",children:[x.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Especificaciones Técnicas"}),x.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Desplazamiento (tons)"}),x.jsx("input",{type:"number",value:$.displacement_tons,onChange:We=>W({...$,displacement_tons:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Longitud (m)"}),x.jsx("input",{type:"number",step:"0.01",value:$.length_meters,onChange:We=>W({...$,length_meters:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Manga (m)"}),x.jsx("input",{type:"number",step:"0.01",value:$.beam_meters,onChange:We=>W({...$,beam_meters:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Velocidad Máx (nudos)"}),x.jsx("input",{type:"number",value:$.max_speed_knots,onChange:We=>W({...$,max_speed_knots:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Tripulación"}),x.jsx("input",{type:"number",value:$.crew_count,onChange:We=>W({...$,crew_count:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Alcance (km)"}),x.jsx("input",{type:"number",value:$.range_km,onChange:We=>W({...$,range_km:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{className:"col-span-3",children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Propulsión"}),x.jsx("input",{type:"text",value:$.propulsion,onChange:We=>W({...$,propulsion:We.target.value}),placeholder:"4 turbinas GE LM 2500",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Empuje (hp)"}),x.jsx("input",{type:"number",value:$.thrust_hp,onChange:We=>W({...$,thrust_hp:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"País de Origen"}),x.jsx("input",{type:"text",value:$.country_origin,onChange:We=>W({...$,country_origin:We.target.value}),placeholder:"Estados Unidos",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Fabricante"}),x.jsx("input",{type:"text",value:$.manufacturer,onChange:We=>W({...$,manufacturer:We.target.value}),placeholder:"Bath Iron Works",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{className:"col-span-3",children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Parque Aéreo"}),x.jsx("input",{type:"text",value:$.air_wing,onChange:We=>W({...$,air_wing:We.target.value}),placeholder:"2 helicópteros SH-60 Seahawk",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700",children:[x.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Armamento Detallado"}),x.jsxs("div",{className:"space-y-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Armamento Completo"}),x.jsx("textarea",{value:$.armamento,onChange:We=>W({...$,armamento:We.target.value}),placeholder:"Lista completa de armamento...",rows:3,className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"🆕 Armamento Principal (Resumen)"}),x.jsx("input",{type:"text",value:$.weapon_type,onChange:We=>W({...$,weapon_type:We.target.value}),placeholder:"Tomahawk BGM-109, SM-2/3, Harpoon",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"🆕 Sistemas Defensivos"}),x.jsx("textarea",{value:$.defensive_systems,onChange:We=>W({...$,defensive_systems:We.target.value}),placeholder:"Phalanx CIWS, SRBOC, AN/SLQ-32...",rows:2,className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]})]})]}),x.jsxs("div",{className:"bg-gradient-to-br from-red-950/30 to-slate-800 rounded-lg p-6 border border-red-900/50",children:[x.jsx("h3",{className:"text-lg font-semibold text-red-400 mb-4",children:"🎯 Capacidades Militares"}),x.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Alcance de Fuego (km)"}),x.jsx("input",{type:"number",value:$.fire_range_km,onChange:We=>W({...$,fire_range_km:We.target.value}),placeholder:"2500",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-red-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Alcance de Radar (km)"}),x.jsx("input",{type:"number",value:$.radar_range_km,onChange:We=>W({...$,radar_range_km:We.target.value}),placeholder:"320",className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-red-500"})]})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_surface_to_surface,onChange:We=>W({...$,has_surface_to_surface:We.target.checked}),className:"w-5 h-5 accent-red-500"}),x.jsx("span",{className:"text-sm text-slate-200",children:"🎯 Ataque Mar-Mar"})]}),x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_surface_to_air,onChange:We=>W({...$,has_surface_to_air:We.target.checked}),className:"w-5 h-5 accent-blue-500"}),x.jsx("span",{className:"text-sm text-slate-200",children:"🛡️ Defensa Antiaérea"})]}),x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_torpedoes,onChange:We=>W({...$,has_torpedoes:We.target.checked}),className:"w-5 h-5 accent-cyan-500"}),x.jsx("span",{className:"text-sm text-slate-200",children:"🐟 Torpedos"})]}),x.jsxs("label",{className:"flex items-center gap-2 p-3 bg-slate-700/50 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors",children:[x.jsx("input",{type:"checkbox",checked:$.has_cruise_missiles,onChange:We=>W({...$,has_cruise_missiles:We.target.checked}),className:"w-5 h-5 accent-purple-500"}),x.jsx("span",{className:"text-sm text-slate-200",children:"🚀 Misiles de Crucero"})]})]})]}),x.jsxs("div",{className:"bg-gradient-to-br from-cyan-950/30 to-slate-800 rounded-lg p-6 border border-cyan-900/50",children:[x.jsx("h3",{className:"text-lg font-semibold text-cyan-400 mb-4",children:"📋 Descripción del Tipo"}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Descripción de la Plataforma"}),x.jsx("textarea",{value:$.ship_type_description,onChange:We=>W({...$,ship_type_description:We.target.value}),placeholder:"Destructor lanzamisiles guiados clase Arleigh Burke equipado con sistema Aegis...",rows:3,className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700",children:[x.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Visualización"}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Color del Icono"}),x.jsxs("div",{className:"flex gap-2",children:[x.jsx("input",{type:"color",value:$.icon_color,onChange:We=>W({...$,icon_color:We.target.value}),className:"w-16 h-10 bg-slate-900 border border-slate-600 rounded cursor-pointer"}),x.jsx("input",{type:"text",value:$.icon_color,onChange:We=>W({...$,icon_color:We.target.value}),placeholder:"#3b82f6",className:"flex-1 px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Era"}),x.jsxs("select",{value:$.era,onChange:We=>W({...$,era:We.target.value}),className:"w-full px-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500",children:[x.jsx("option",{value:"moderno",children:"Moderno (2000+)"}),x.jsx("option",{value:"guerra-fria",children:"Guerra Fría (1945-1991)"}),x.jsx("option",{value:"ww2",children:"Segunda Guerra Mundial"}),x.jsx("option",{value:"ww1",children:"Primera Guerra Mundial"}),x.jsx("option",{value:"clasico",children:"Clásico"})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Icono PNG (mapa)"}),x.jsx("p",{className:"text-xs text-slate-500 mb-2",children:"PNG sin fondo, transparente"}),$.icon_url?x.jsxs("div",{className:"flex items-center gap-3 p-3 bg-slate-900 border border-slate-600 rounded-lg",children:[x.jsx("img",{src:$.icon_url,alt:"Icono",className:"w-12 h-12 object-contain rounded-lg bg-slate-800"}),x.jsxs("div",{className:"flex-1",children:[x.jsx("p",{className:"text-xs text-white",children:"Icono PNG"}),x.jsx("p",{className:"text-xs text-slate-400 truncate",children:$.icon_url.split("/").pop()})]}),x.jsx("button",{type:"button",onClick:()=>W({...$,icon_url:""}),className:"p-1 hover:bg-slate-700 rounded text-red-400 transition-colors",children:x.jsx(En,{size:16})})]}):x.jsxs("button",{type:"button",onClick:()=>{ke("icon"),ie(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 border-2 border-dashed border-blue-500/50 hover:border-blue-500 text-blue-300 rounded-lg transition-all text-sm",children:[x.jsx(C_,{size:16}),"Subir Icono PNG"]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Video WEBM (sidebar)"}),x.jsx("p",{className:"text-xs text-yellow-400 mb-2",children:"⚡ Recomendado: 720p, <5 segundos, <2MB para carga rápida"}),$.image_url?x.jsxs("div",{className:"flex items-center gap-3 p-3 bg-slate-900 border border-slate-600 rounded-lg",children:[$.image_url.match(/\.(webm|mp4)$/i)?x.jsx("video",{src:$.image_url,className:"w-12 h-12 object-cover rounded-lg",muted:!0}):x.jsx("img",{src:$.image_url,alt:"Preview",className:"w-12 h-12 object-cover rounded-lg"}),x.jsxs("div",{className:"flex-1",children:[x.jsx("p",{className:"text-xs text-white",children:"Video/Imagen"}),x.jsx("p",{className:"text-xs text-slate-400 truncate",children:$.image_url.split("/").pop()})]}),x.jsx("button",{type:"button",onClick:()=>W({...$,image_url:""}),className:"p-1 hover:bg-slate-700 rounded text-red-400 transition-colors",children:x.jsx(En,{size:16})})]}):x.jsxs("button",{type:"button",onClick:()=>{ke("video"),ie(!0)},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-purple-600/20 hover:bg-purple-600/30 border-2 border-dashed border-purple-500/50 hover:border-purple-500 text-purple-300 rounded-lg transition-all text-sm",children:[x.jsx(ev,{size:16}),"Subir Video WEBM"]})]})]}),x.jsx("p",{className:"text-xs text-slate-500 col-span-2 -mt-2",children:"💡 Icono PNG: usado en el mapa. Video WEBM: usado en sidebar y modal de detalles"})]}),x.jsxs("div",{className:"flex gap-3 pt-4 sticky bottom-0 bg-slate-900 pb-4",children:[x.jsx("button",{type:"button",onClick:()=>{C("list"),L(null),W(le())},className:"px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors",children:"Cancelar"}),x.jsxs("button",{type:"submit",className:"flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium",children:[x.jsx(CN,{size:18}),S==="edit"?"Guardar Cambios":"Crear Plantilla"]})]})]})})]})]}),ee&&x.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[300]",children:x.jsxs("div",{className:"bg-slate-900 rounded-xl p-6 max-w-2xl w-full mx-4 border border-slate-700",children:[x.jsxs("div",{className:"flex items-center justify-between mb-4",children:[x.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2",children:[x.jsx(C_,{size:20}),"Subir Imagen de Plantilla"]}),x.jsx("button",{onClick:()=>ie(!1),className:"p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{size:20})})]}),x.jsx(lR,{entityId:null,entityName:$.display_name||"Plantilla",onUploadComplete:Xe,allowTemplateUpload:!0})]})})]})}function $U({template:r,onClose:s,onUseTemplate:c}){const[m,v]=Ne.useState(!1),[S,C]=Ne.useState(!1);if(!r)return null;const L=(()=>{switch(r.entity_type){case"destructor":return Ai;case"fragata":return j_;case"avion":return Wa;case"tropas":return vs;default:return Ai}})(),F=[r.displacement_tons&&{label:"Desplazamiento",value:`${r.displacement_tons.toLocaleString()} tons`},r.length_meters&&{label:"Longitud",value:`${r.length_meters} m`},r.beam_meters&&{label:"Manga",value:`${r.beam_meters} m`},r.max_speed_knots&&{label:"Velocidad Máx",value:`${r.max_speed_knots} kn`},r.crew_count&&{label:"Tripulación",value:`${r.crew_count.toLocaleString()} personas`},r.range_km&&{label:"Alcance",value:`${r.range_km.toLocaleString()} km`},r.thrust_hp&&{label:"Empuje",value:`${r.thrust_hp.toLocaleString()} HP`}].filter(Boolean);return x.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in",children:x.jsxs("div",{className:"relative w-full max-w-3xl max-h-[90vh] bg-slate-900 border border-slate-700 rounded-lg shadow-2xl flex flex-col overflow-hidden",children:[x.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700 bg-gradient-to-r from-slate-800 to-slate-900",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx("div",{className:"w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center",style:{borderColor:r.icon_color,borderWidth:"2px"},children:x.jsx(L,{className:"w-7 h-7",style:{color:r.icon_color}})}),x.jsxs("div",{children:[x.jsx("h2",{className:"text-xl font-bold text-white",children:r.display_name||r.name}),x.jsx("p",{className:"text-sm text-slate-400",children:r.class})]})]}),x.jsx("button",{onClick:s,className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-6 h-6"})})]}),x.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:x.jsxs("div",{className:"p-4 space-y-4",children:[(r.image_url||r.video_url)&&x.jsx("div",{className:"bg-slate-800 rounded-lg overflow-hidden border border-slate-700",children:(()=>{const Z=r.video_url||r.image_url,$=(Z==null?void 0:Z.match(/\.(webm|mp4|mov|avi)$/i))||r.video_url;return $&&!S?x.jsx("div",{className:"w-full h-64 bg-black flex items-center justify-center",children:x.jsx("video",{src:Z,className:"w-full h-full object-contain",loop:!0,muted:!0,autoPlay:!0,playsInline:!0,onError:()=>C(!0)})}):r.image_url&&!m&&!$?x.jsx("img",{src:r.image_url,alt:r.name,className:"w-full h-64 object-cover",onError:()=>v(!0)}):x.jsx("div",{className:"w-full h-64 bg-slate-700 flex items-center justify-center",children:x.jsx(L,{className:"w-20 h-20 text-slate-500"})})})()}),r.description&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsxs("h3",{className:"text-xs font-semibold text-slate-400 mb-2 flex items-center gap-2",children:[x.jsx(SN,{className:"w-4 h-4"}),"DESCRIPCIÓN"]}),x.jsx("p",{className:"text-sm text-slate-300 leading-relaxed",children:r.description})]}),F.length>0&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsxs("h3",{className:"text-xs font-semibold text-slate-400 mb-3 flex items-center gap-2",children:[x.jsx(MN,{className:"w-4 h-4"}),"ESPECIFICACIONES TÉCNICAS"]}),x.jsx("div",{className:"grid grid-cols-2 gap-3",children:F.map((Z,$)=>x.jsxs("div",{className:"flex flex-col",children:[x.jsx("span",{className:"text-xs text-slate-500",children:Z.label}),x.jsx("span",{className:"text-sm text-white font-medium",children:Z.value})]},$))})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.country_origin&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("span",{className:"text-xs text-slate-500",children:"País de Origen"}),x.jsx("p",{className:"text-sm text-white font-medium mt-1",children:r.country_origin})]}),r.manufacturer&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("span",{className:"text-xs text-slate-500",children:"Fabricante"}),x.jsx("p",{className:"text-sm text-white font-medium mt-1",children:r.manufacturer})]}),r.era&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("span",{className:"text-xs text-slate-500",children:"Era/Año"}),x.jsx("p",{className:"text-sm text-white font-medium mt-1",children:r.era})]})]}),r.propulsion&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("h3",{className:"text-xs font-semibold text-slate-400 mb-2",children:"PROPULSIÓN"}),x.jsx("p",{className:"text-sm text-slate-300",children:r.propulsion})]}),r.armamento&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("h3",{className:"text-xs font-semibold text-slate-400 mb-2",children:"ARMAMENTO"}),x.jsx("p",{className:"text-sm text-slate-300 leading-relaxed",children:r.armamento})]}),r.capabilities&&Object.keys(r.capabilities).length>0&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("h3",{className:"text-xs font-semibold text-slate-400 mb-3",children:"CAPACIDADES"}),x.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(r.capabilities).map(([Z,$])=>x.jsxs("div",{className:"flex flex-col",children:[x.jsx("span",{className:"text-xs text-slate-500 capitalize",children:Z.replace(/_/g," ")}),x.jsx("span",{className:"text-sm text-slate-300",children:typeof $=="object"?JSON.stringify($):$})]},Z))})]}),r.air_wing&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("h3",{className:"text-xs font-semibold text-slate-400 mb-2",children:"PARQUE AÉREO"}),x.jsx("p",{className:"text-sm text-slate-300",children:r.air_wing})]})]})}),x.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800/50 flex items-center justify-between",children:[x.jsxs("div",{className:"text-xs text-slate-400",children:[x.jsx("span",{className:"capitalize",children:r.entity_type})," • ",r.category]}),x.jsxs("div",{className:"flex gap-2",children:[x.jsx("button",{onClick:s,className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors",children:"Cerrar"}),x.jsx("button",{onClick:()=>{c(r),s()},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors shadow-lg",children:"📍 Usar Plantilla"})]})]})]})})}function GU({onSelectTemplate:r,onDragTemplate:s}){const{loading:c,getTemplatesHierarchy:m,getTopTemplates:v,searchTemplates:S}=cR(),[C,o]=Ne.useState(""),[L,F]=Ne.useState([]),[Z,$]=Ne.useState("all"),[W,ee]=Ne.useState({}),[ie,ae]=Ne.useState({}),[ke,le]=Ne.useState([]),[se,J]=Ne.useState([]),[Ee,je]=Ne.useState(!1),[Xe,tt]=Ne.useState(null);Ne.useEffect(()=>{async function Ut(){const jr=await v(5);J(jr)}c||Ut()},[c,v]),Ne.useEffect(()=>{if(C.trim().length>0){const Ut=S(C);F(Ut)}else F([])},[C]);const it=m(),We=Ut=>{ee(jr=>({...jr,[Ut]:!jr[Ut]}))},Ct=(Ut,jr)=>{const Ht=`${Ut}-${jr}`;ae(xr=>({...xr,[Ht]:!xr[Ht]}))},Nt=Ut=>{le(jr=>jr.includes(Ut)?jr.filter(Ht=>Ht!==Ut):[...jr,Ut])},Wt=Ut=>{tt(Ut)},fr=Ut=>{r&&r(Ut)},dr={militar:"🎖️ Militar",civil:"🏢 Civil",comercial:"🏭 Comercial"},cr={destructor:"🚢 Destructores",fragata:"⚓ Fragatas",portaaviones:"🛳️ Portaaviones",submarino:"🔱 Submarinos",avion:"✈️ Aviones",tropas:"👤 Personal",tanque:"🛡️ Vehículos"};return x.jsxs("div",{className:"fixed left-0 w-80 bg-slate-900 border-r border-slate-700 flex flex-col palette-enter shadow-2xl",style:{zIndex:40,top:"56px",height:"calc(100vh - 56px)"},children:[x.jsxs("div",{className:"p-4 border-b border-slate-700 bg-slate-800",children:[x.jsx("h2",{className:"text-lg font-bold text-white mb-3",children:"🎨 Paleta de Entidades"}),x.jsxs("div",{className:"relative",children:[x.jsx(Pp,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400",size:16}),x.jsx("input",{type:"text",placeholder:"Buscar plantillas...",value:C,onChange:Ut=>o(Ut.target.value),className:`w-full pl-9 pr-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent`,disabled:c})]}),x.jsxs("div",{className:"flex space-x-1 mt-3",children:[x.jsxs("button",{onClick:()=>$("all"),className:`flex-1 flex items-center justify-center space-x-1 px-3 py-1.5 rounded text-xs font-medium transition-colors
              ${Z==="all"?"bg-blue-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:[x.jsx(SF,{size:14}),x.jsx("span",{children:"Todas"})]}),x.jsxs("button",{onClick:()=>$("favorites"),className:`flex-1 flex items-center justify-center space-x-1 px-3 py-1.5 rounded text-xs font-medium transition-colors
              ${Z==="favorites"?"bg-blue-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:[x.jsx(AN,{size:14}),x.jsx("span",{children:"Favoritas"})]}),x.jsxs("button",{onClick:()=>$("recent"),className:`flex-1 flex items-center justify-center space-x-1 px-3 py-1.5 rounded text-xs font-medium transition-colors
              ${Z==="recent"?"bg-blue-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:[x.jsx(wN,{size:14}),x.jsx("span",{children:"Usadas"})]})]})]}),x.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-slate-900",children:[c&&x.jsx("div",{className:"space-y-3",children:[1,2,3].map(Ut=>x.jsx("div",{className:"border border-slate-700 rounded-lg overflow-hidden animate-pulse",children:x.jsxs("div",{className:"p-3 bg-slate-800",children:[x.jsx("div",{className:"h-4 bg-slate-700 rounded w-32 mb-2"}),x.jsx("div",{className:"h-3 bg-slate-700 rounded w-20"})]})},Ut))}),!c&&x.jsxs(x.Fragment,{children:[C&&x.jsxs("div",{className:"space-y-2",children:[x.jsxs("p",{className:"text-xs text-slate-400 mb-2",children:[L.length," resultado",L.length!==1?"s":"",' para "',C,'"']}),L.map(Ut=>x.jsx(DP,{template:Ut,onDragStart:s,onClick:r,isFavorite:ke.includes(Ut.id),onToggleFavorite:Nt,onShowDetails:Wt},Ut.id))]}),!C&&Object.keys(it).map(Ut=>x.jsxs("div",{className:"border border-slate-700 rounded-lg overflow-hidden",children:[x.jsxs("button",{onClick:()=>We(Ut),className:"w-full flex items-center justify-between p-3 bg-slate-800 hover:bg-slate-750 transition-colors",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[W[Ut]?x.jsx(Ap,{size:16,className:"text-slate-400"}):x.jsx(sP,{size:16,className:"text-slate-400"}),x.jsx("span",{className:"text-sm font-semibold text-white",children:dr[Ut]||Ut})]}),x.jsxs("span",{className:"text-xs text-slate-400",children:[Object.values(it[Ut]).reduce((jr,Ht)=>jr+Ht.length,0)," plantillas"]})]}),W[Ut]&&x.jsx("div",{className:"bg-slate-850 p-2 space-y-2",children:Object.keys(it[Ut]).map(jr=>{const Ht=`${Ut}-${jr}`,xr=it[Ut][jr];return x.jsxs("div",{className:"space-y-2",children:[x.jsxs("button",{onClick:()=>Ct(Ut,jr),className:"w-full flex items-center justify-between p-2 bg-slate-800 hover:bg-slate-700 rounded transition-colors",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[ie[Ht]?x.jsx(Ap,{size:14,className:"text-slate-400"}):x.jsx(sP,{size:14,className:"text-slate-400"}),x.jsx("span",{className:"text-xs font-medium text-slate-200",children:cr[jr]||jr})]}),x.jsx("span",{className:"text-xs text-slate-500",children:xr.length})]}),ie[Ht]&&x.jsx("div",{className:"space-y-2 pl-2",children:xr.map(Rt=>x.jsx(DP,{template:Rt,onDragStart:s,onClick:r,isFavorite:ke.includes(Rt.id),onToggleFavorite:Nt,onShowDetails:Wt},Rt.id))})]},Ht)})})]},Ut))]})]}),x.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800 space-y-2",children:[x.jsxs("button",{onClick:()=>je(!0),className:"w-full flex items-center justify-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:[x.jsx(lh,{size:16}),x.jsx("span",{className:"text-sm font-medium",children:"Crear Plantilla"})]}),x.jsxs("button",{onClick:()=>je(!0),className:"w-full flex items-center justify-center space-x-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg transition-colors",children:[x.jsx(B_,{size:16}),x.jsx("span",{className:"text-sm font-medium",children:"Administrar Plantillas"})]})]}),Ee&&x.jsx(VU,{onClose:()=>je(!1)}),Xe&&x.jsx($U,{template:Xe,onClose:()=>tt(null),onUseTemplate:fr})]})}function qU({template:r,position:s,onClose:c,onConfirm:m}){const[v,S]=Ne.useState({name:"",code:"",status:"activo",heading:180,speed:0,commissioned_year:(r==null?void 0:r.commissioned_year)||new Date().getFullYear(),latitude:(s==null?void 0:s.lat)||18.4655,longitude:(s==null?void 0:s.lng)||-66.1057}),[C,o]=Ne.useState(!1);if(!r)return null;const F={destructor:Ai,fragata:Ai,portaaviones:Ai,submarino:Ai,avion:Wa,tropas:vs,tanque:Zo}[r.entity_type]||Ai,Z=W=>{if(W.preventDefault(),!v.name.trim()){alert("El nombre es obligatorio");return}const ee={...v,template_id:r.id,type:r.entity_type};m(ee)},$=(W,ee)=>{S(ie=>({...ie,[W]:ee}))};return x.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm",children:x.jsxs("div",{className:"bg-slate-800 rounded-xl shadow-2xl border border-slate-700 w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col",children:[x.jsx("div",{className:"p-6 border-b border-slate-700 bg-gradient-to-r from-blue-900/30 to-slate-800",children:x.jsxs("div",{className:"flex items-start justify-between",children:[x.jsxs("div",{className:"flex items-center space-x-3",children:[x.jsx("div",{className:"p-3 rounded-lg",style:{backgroundColor:`${r.icon_color}20`},children:x.jsx(F,{size:28,style:{color:r.icon_color}})}),x.jsxs("div",{children:[x.jsxs("h2",{className:"text-xl font-bold text-white",children:["Crear ",r.display_name]}),x.jsxs("p",{className:"text-sm text-slate-400 mt-0.5",children:["Basado en plantilla: ",r.class]})]})]}),x.jsx("button",{onClick:c,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-white",children:x.jsx(En,{size:20})})]})}),x.jsxs("form",{onSubmit:Z,className:"flex-1 overflow-y-auto p-6 space-y-6",children:[x.jsxs("div",{className:"space-y-4",children:[x.jsxs("h3",{className:"text-sm font-semibold text-blue-400 uppercase tracking-wider flex items-center",children:[x.jsx("span",{className:"w-2 h-2 bg-blue-400 rounded-full mr-2"}),"Datos Únicos (Obligatorios)"]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Nombre de la Entidad *"}),x.jsx("input",{type:"text",value:v.name,onChange:W=>$("name",W.target.value),placeholder:"Ej: USS Porter",className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Código/Designación"}),x.jsx("input",{type:"text",value:v.code,onChange:W=>$("code",W.target.value),placeholder:"Ej: DDG-78",className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Estado Operacional"}),x.jsxs("select",{value:v.status,onChange:W=>$("status",W.target.value),className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[x.jsx("option",{value:"activo",children:"Activo"}),x.jsx("option",{value:"patrullando",children:"Patrullando"}),x.jsx("option",{value:"estacionado",children:"Estacionado"}),x.jsx("option",{value:"en_transito",children:"En Tránsito"}),x.jsx("option",{value:"en_vuelo",children:"En Vuelo"}),x.jsx("option",{value:"vigilancia",children:"Vigilancia"})]})]}),x.jsxs("div",{children:[x.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-1.5 flex items-center",children:[x.jsx(zS,{size:14,className:"mr-1"}),"Rumbo Inicial (°)"]}),x.jsx("input",{type:"number",min:"0",max:"359",value:v.heading,onChange:W=>$("heading",parseInt(W.target.value)||0),className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),x.jsxs("div",{children:[x.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-1.5 flex items-center",children:[x.jsx(jS,{size:14,className:"mr-1"}),"Velocidad Actual (nudos)"]}),x.jsx("input",{type:"number",min:"0",value:v.speed,onChange:W=>$("speed",parseFloat(W.target.value)||0),className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),x.jsxs("div",{className:"space-y-4",children:[x.jsxs("h3",{className:"text-sm font-semibold text-green-400 uppercase tracking-wider flex items-center",children:[x.jsx("span",{className:"w-2 h-2 bg-green-400 rounded-full mr-2"}),"Posición Inicial"]}),x.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-1.5 flex items-center",children:[x.jsx(ju,{size:14,className:"mr-1"}),"Latitud"]}),x.jsx("input",{type:"number",step:"0.0001",value:v.latitude,onChange:W=>$("latitude",parseFloat(W.target.value)),className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"})]}),x.jsxs("div",{children:[x.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-1.5 flex items-center",children:[x.jsx(ju,{size:14,className:"mr-1"}),"Longitud"]}),x.jsx("input",{type:"number",step:"0.0001",value:v.longitude,onChange:W=>$("longitude",parseFloat(W.target.value)),className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"})]})]})]}),x.jsxs("button",{type:"button",onClick:()=>o(!C),className:"w-full flex items-center justify-between px-4 py-3 bg-slate-900/50 hover:bg-slate-900 border border-slate-700 rounded-lg transition-colors text-slate-300",children:[x.jsx("span",{className:"text-sm font-medium",children:"Personalización Avanzada (Opcional)"}),x.jsx(kl,{size:16,className:C?"text-blue-400":""})]}),C&&x.jsxs("div",{className:"space-y-4 p-4 bg-slate-900/30 rounded-lg border border-slate-700",children:[x.jsx("p",{className:"text-xs text-slate-400",children:"Por defecto, esta entidad heredará todas las especificaciones de la plantilla. Aquí puedes sobrescribir valores específicos si es necesario."}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1.5",children:"Año de Comisionado"}),x.jsx("input",{type:"number",min:"1900",max:"2100",value:v.commissioned_year,onChange:W=>$("commissioned_year",parseInt(W.target.value)),className:"w-full px-4 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),x.jsxs("div",{className:"space-y-3 p-4 bg-gradient-to-r from-blue-950/30 to-slate-800/30 rounded-lg border border-blue-900/30",children:[x.jsxs("h3",{className:"text-sm font-semibold text-blue-400 uppercase tracking-wider flex items-center",children:[x.jsx("span",{className:"w-2 h-2 bg-blue-400 rounded-full mr-2"}),"Heredará de la Plantilla"]}),x.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[r.displacement_tons&&x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{className:"text-slate-400",children:"Desplazamiento:"}),x.jsxs("span",{className:"text-white font-medium",children:[r.displacement_tons.toLocaleString()," tons"]})]}),r.length_meters&&x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{className:"text-slate-400",children:"Longitud:"}),x.jsxs("span",{className:"text-white font-medium",children:[r.length_meters," m"]})]}),r.max_speed_knots&&x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{className:"text-slate-400",children:"Vel. Máxima:"}),x.jsxs("span",{className:"text-white font-medium",children:[r.max_speed_knots," nudos"]})]}),r.crew_count&&x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{className:"text-slate-400",children:"Tripulación:"}),x.jsxs("span",{className:"text-white font-medium",children:[r.crew_count," miembros"]})]}),r.range_km&&x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{className:"text-slate-400",children:"Alcance:"}),x.jsxs("span",{className:"text-white font-medium",children:[r.range_km.toLocaleString()," km"]})]}),r.country_origin&&x.jsxs("div",{className:"flex justify-between",children:[x.jsx("span",{className:"text-slate-400",children:"País:"}),x.jsx("span",{className:"text-white font-medium",children:r.country_origin})]})]}),x.jsx("button",{type:"button",className:"text-xs text-blue-400 hover:text-blue-300 transition-colors",children:"Ver especificaciones completas →"})]})]}),x.jsxs("div",{className:"p-6 border-t border-slate-700 bg-slate-900/50 flex justify-end space-x-3",children:[x.jsx("button",{type:"button",onClick:c,className:"px-5 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium",children:"Cancelar"}),x.jsxs("button",{onClick:Z,className:"px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center space-x-2",children:[x.jsx("span",{children:"Añadir al Mapa"}),x.jsx("span",{children:"✅"})]})]})]})})}function HU(){const[r,s]=Ne.useState(0),[c,m]=Ne.useState(!0),v=async()=>{try{const{count:S,error:C}=await yr.from("entities").select("*",{count:"exact",head:!0}).eq("is_visible",!1).is("archived_at",null);if(C)throw C;s(S||0)}catch(S){console.error("❌ Error al obtener conteo de ocultas:",S),s(0)}finally{m(!1)}};return Ne.useEffect(()=>{v();const S=yr.channel("hidden_count_changes").on("postgres_changes",{event:"*",schema:"public",table:"entities"},o=>{setTimeout(()=>{v()},100)}).subscribe(),C=setInterval(()=>{v()},5e3);return()=>{S.unsubscribe(),clearInterval(C)}},[]),{hiddenCount:r,loading:c,refetch:v}}function WU(){const[r,s]=Ne.useState(0),[c,m]=Ne.useState(!0),v=async()=>{try{const{count:S,error:C}=await yr.from("entities").select("*",{count:"exact",head:!0}).not("archived_at","is",null);if(C)throw C;s(S||0)}catch(S){console.error("❌ Error al obtener conteo de archivadas:",S),s(0)}finally{m(!1)}};return Ne.useEffect(()=>{v();const S=yr.channel("archived_count_changes").on("postgres_changes",{event:"*",schema:"public",table:"entities"},o=>{setTimeout(()=>{v()},100)}).subscribe(),C=setInterval(()=>{v()},5e3);return()=>{S.unsubscribe(),clearInterval(C)}},[]),{archivedCount:r,loading:c,refetch:v}}function ZU(r={}){const[s,c]=Ne.useState([]),[m,v]=Ne.useState(!0),[S,C]=Ne.useState(null),[o,L]=Ne.useState(0);Ne.useEffect(()=>{F(),Z()},[]);const F=async()=>{try{v(!0);let J=yr.from("intelligence_events").select("*").order("event_date",{ascending:!1});r.status?J=J.eq("status",r.status):J=J.neq("status","archived"),r.priority&&(J=J.eq("priority",r.priority)),r.source_credibility&&(J=J.eq("source_credibility",r.source_credibility)),r.event_type&&(J=J.eq("event_type",r.event_type));const{data:Ee,error:je}=await J;if(je)throw je;c(Ee||[]);const Xe=(Ee==null?void 0:Ee.filter(tt=>tt.status==="pending").length)||0;L(Xe),C(null)}catch(J){C(J.message),console.error("Error fetching intelligence events:",J)}finally{v(!1)}},Z=()=>{const J=yr.channel("intelligence_events_changes").on("postgres_changes",{event:"*",schema:"public",table:"intelligence_events"},Ee=>{console.log("🔄 Cambio en intelligence_events:",Ee),F()}).subscribe();return()=>{J.unsubscribe()}};return{events:s,loading:m,error:S,unreadCount:o,refetch:F,verifyEvent:async J=>{try{const{error:Ee}=await yr.from("intelligence_events").update({status:"verified",verified_at:new Date().toISOString()}).eq("id",J);if(Ee)throw Ee;return await F(),{success:!0}}catch(Ee){return console.error("Error verifying event:",Ee),{success:!1,error:Ee.message}}},dismissEvent:async J=>{try{const{error:Ee}=await yr.from("intelligence_events").update({status:"dismissed"}).eq("id",J);if(Ee)throw Ee;return await F(),{success:!0}}catch(Ee){return console.error("Error dismissing event:",Ee),{success:!1,error:Ee.message}}},archiveEvent:async J=>{try{const{error:Ee}=await yr.from("intelligence_events").update({status:"archived"}).eq("id",J);if(Ee)throw Ee;return await F(),{success:!0}}catch(Ee){return console.error("Error archiving event:",Ee),{success:!1,error:Ee.message}}},markAsActioned:async(J,Ee)=>{try{const{error:je}=await yr.from("intelligence_events").update({status:"actioned",action_taken:Ee}).eq("id",J);if(je)throw je;return await F(),{success:!0}}catch(je){return console.error("Error marking as actioned:",je),{success:!1,error:je.message}}},addNotes:async(J,Ee)=>{try{const{error:je}=await yr.from("intelligence_events").update({notes:Ee}).eq("id",J);if(je)throw je;return await F(),{success:!0}}catch(je){return console.error("Error adding notes:",je),{success:!1,error:je.message}}},runMonitor:async()=>{try{const J="https://oqhujdqbszbvozsuunkw.supabase.co",Ee="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xaHVqZHFic3pidm96c3V1bmt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY1NDYsImV4cCI6MjA3NjIwMjU0Nn0.Rd0GMUcx1J_UCzwfzW0csZPjjppzp0o64g5nggKq9GM",je=`${J}/functions/v1/intelligence-monitor`;console.log("🚀 Ejecutando monitor de inteligencia...");const Xe=await fetch(je,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Ee}`},body:JSON.stringify({})});if(!Xe.ok){const it=await Xe.text();throw new Error(`Error ${Xe.status}: ${it}`)}const tt=await Xe.json();if(tt.success)return await F(),{success:!0,stats:tt.stats};throw new Error(tt.error||"Error ejecutando monitor")}catch(J){return console.error("Error running monitor:",J),{success:!1,error:J.message}}},runRSSMonitor:async()=>{try{const J="https://oqhujdqbszbvozsuunkw.supabase.co",Ee="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xaHVqZHFic3pidm96c3V1bmt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY1NDYsImV4cCI6MjA3NjIwMjU0Nn0.Rd0GMUcx1J_UCzwfzW0csZPjjppzp0o64g5nggKq9GM",je=`${J}/functions/v1/rss-news-monitor`;console.log("📰 Ejecutando monitor RSS de noticias...");const Xe=await fetch(je,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Ee}`},body:JSON.stringify({})});if(!Xe.ok){const it=await Xe.text();throw new Error(`Error ${Xe.status}: ${it}`)}const tt=await Xe.json();if(tt.success)return await F(),{success:!0,stats:tt.stats};throw new Error(tt.error||"Error ejecutando monitor RSS")}catch(J){return console.error("Error running RSS monitor:",J),{success:!1,error:J.message}}},runXMonitor:async()=>{try{const J="https://oqhujdqbszbvozsuunkw.supabase.co",Ee="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xaHVqZHFic3pidm96c3V1bmt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY1NDYsImV4cCI6MjA3NjIwMjU0Nn0.Rd0GMUcx1J_UCzwfzW0csZPjjppzp0o64g5nggKq9GM",je=`${J}/functions/v1/x-intelligence-monitor`;console.log("🐦 Ejecutando monitor de X (Twitter) con cache inteligente...");const Xe=await fetch(je,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Ee}`},body:JSON.stringify({})});if(!Xe.ok){const it=await Xe.text();throw new Error(`Error ${Xe.status}: ${it}`)}const tt=await Xe.json();if(tt.success)return await F(),{success:!0,stats:tt.stats,message:tt.message,events:tt.events||[]};throw new Error(tt.error||"Error ejecutando monitor de X")}catch(J){return console.error("Error running X monitor:",J),{success:!1,error:J.message}}}}}function uR(){const[r,s]=Ne.useState(0);Ne.useEffect(()=>{c();const m=yr.channel("intelligence_unread_count").on("postgres_changes",{event:"*",schema:"public",table:"intelligence_events"},()=>{c()}).subscribe();return()=>{m.unsubscribe()}},[]);const c=async()=>{const{count:m}=await yr.from("intelligence_events").select("*",{count:"exact",head:!0}).eq("status","pending");s(m||0)};return r}function XU(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!0),[v,S]=Ne.useState(null),C=async(W=!1)=>{try{W||m(!0);const{data:ee,error:ie}=await yr.from("entities").select("*").eq("is_visible",!1).is("archived_at",null).order("created_at",{ascending:!1});if(ie)throw ie;s(ee||[]),S(null)}catch(ee){console.error("❌ Error al cargar entidades ocultas:",ee),S(ee.message)}finally{W||m(!1)}},o=async W=>{try{const{error:ee}=await yr.from("entities").update({is_visible:!0}).eq("id",W);if(ee)throw ee;return s(ie=>ie.filter(ae=>ae.id!==W)),window.refetchEntities&&window.refetchEntities(),{success:!0}}catch(ee){return console.error("❌ Error al mostrar entidad:",ee),{success:!1,error:ee.message}}},L=async()=>{try{const{error:W}=await yr.from("entities").update({is_visible:!0}).eq("is_visible",!1).is("archived_at",null);if(W)throw W;return s([]),window.refetchEntities&&window.refetchEntities(),{success:!0}}catch(W){return console.error("❌ Error al mostrar todas las entidades:",W),{success:!1,error:W.message}}},F=async W=>{try{const{error:ee}=await yr.from("entities").update({archived_at:new Date().toISOString(),is_visible:!1}).eq("id",W);if(ee)throw ee;return s(ie=>ie.filter(ae=>ae.id!==W)),{success:!0}}catch(ee){return console.error("❌ Error al archivar entidad:",ee),{success:!1,error:ee.message}}},Z=async W=>{try{const{error:ee}=await yr.from("entities").delete().eq("id",W);if(ee)throw ee;return s(ie=>ie.filter(ae=>ae.id!==W)),{success:!0}}catch(ee){return console.error("❌ Error al eliminar entidad:",ee),{success:!1,error:ee.message}}};Ne.useEffect(()=>{C();const W=yr.channel("hidden_entities_changes").on("postgres_changes",{event:"*",schema:"public",table:"entities",filter:"is_visible=eq.false"},ee=>{console.log("🔄 Cambio en entidades ocultas:",ee),ee.eventType==="INSERT"?ee.new.is_visible===!1&&!ee.new.archived_at&&s(ie=>[ee.new,...ie]):ee.eventType==="UPDATE"?ee.new.is_visible===!0||ee.new.archived_at?s(ie=>ie.filter(ae=>ae.id!==ee.new.id)):ee.new.is_visible===!1&&!ee.new.archived_at&&s(ie=>ie.find(ke=>ke.id===ee.new.id)?ie.map(ke=>ke.id===ee.new.id?ee.new:ke):[ee.new,...ie]):ee.eventType==="DELETE"&&s(ie=>ie.filter(ae=>ae.id!==ee.old.id))}).subscribe();return()=>{W.unsubscribe()}},[]);const $=()=>r.reduce((W,ee)=>(W[ee.type]=(W[ee.type]||0)+1,W),{});return{hiddenEntities:r,loading:c,error:v,refetch:C,showEntity:o,showAllEntities:L,archiveEntity:F,deleteEntity:Z,count:r.length,getEntityCountsByType:$}}function YU(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!0),[v,S]=Ne.useState(null);Nv();const C=async($=!1)=>{try{$||m(!0);const{data:W,error:ee}=await yr.from("entities").select("*").not("archived_at","is",null).order("archived_at",{ascending:!1});if(ee)throw ee;s(W||[]),S(null)}catch(W){console.error("❌ Error al cargar entidades archivadas:",W),S(W.message)}finally{$||m(!1)}};Ne.useEffect(()=>{C();const $=yr.channel("archived_entities_changes").on("postgres_changes",{event:"*",schema:"public",table:"entities"},W=>{console.log("🔄 Cambio detectado en entidades archivadas:",W),setTimeout(()=>{C(!0)},100)}).subscribe();return()=>{$.unsubscribe()}},[]);const o=async $=>{try{const{error:W}=await yr.from("entities").update({archived_at:null,is_visible:!0}).eq("id",$);if(W)throw W;return s(ee=>ee.filter(ie=>ie.id!==$)),window.refetchEntities&&window.refetchEntities(),{success:!0}}catch(W){return console.error("❌ Error al restaurar entidad:",W),{success:!1,error:W.message}}},L=async()=>{try{const{error:$}=await yr.from("entities").update({archived_at:null,is_visible:!0}).not("archived_at","is",null);if($)throw $;return s([]),window.refetchEntities&&window.refetchEntities(),{success:!0}}catch($){return console.error("❌ Error al restaurar todas las entidades:",$),{success:!1,error:$.message}}},F=async $=>{try{const{error:W}=await yr.from("entities").delete().eq("id",$);if(W)throw W;return s(ee=>ee.filter(ie=>ie.id!==$)),{success:!0}}catch(W){return console.error("❌ Error al eliminar entidad archivada:",W),{success:!1,error:W.message}}},Z=()=>r.reduce(($,W)=>($[W.type]=($[W.type]||0)+1,$),{});return{archivedEntities:r,loading:c,error:v,restoreEntity:o,restoreAllEntities:L,deleteArchivedEntity:F,count:r.length,getEntityCountsByType:Z,refetch:C}}const dR=6048e5,KU=864e5,cx=43200,jP=1440,zP=Symbol.for("constructDateFrom");function bc(r,s){return typeof r=="function"?r(s):r&&typeof r=="object"&&zP in r?r[zP](s):r instanceof Date?new r.constructor(s):new Date(s)}function Ss(r,s){return bc(s||r,r)}let JU={};function G_(){return JU}function M_(r,s){var o,L,F,Z;const c=G_(),m=(s==null?void 0:s.weekStartsOn)??((L=(o=s==null?void 0:s.locale)==null?void 0:o.options)==null?void 0:L.weekStartsOn)??c.weekStartsOn??((Z=(F=c.locale)==null?void 0:F.options)==null?void 0:Z.weekStartsOn)??0,v=Ss(r,s==null?void 0:s.in),S=v.getDay(),C=(S<m?7:0)+S-m;return v.setDate(v.getDate()-C),v.setHours(0,0,0,0),v}function sv(r,s){return M_(r,{...s,weekStartsOn:1})}function hR(r,s){const c=Ss(r,s==null?void 0:s.in),m=c.getFullYear(),v=bc(c,0);v.setFullYear(m+1,0,4),v.setHours(0,0,0,0);const S=sv(v),C=bc(c,0);C.setFullYear(m,0,4),C.setHours(0,0,0,0);const o=sv(C);return c.getTime()>=S.getTime()?m+1:c.getTime()>=o.getTime()?m:m-1}function ov(r){const s=Ss(r),c=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate(),s.getHours(),s.getMinutes(),s.getSeconds(),s.getMilliseconds()));return c.setUTCFullYear(s.getFullYear()),+r-+c}function Rv(r,...s){const c=bc.bind(null,r||s.find(m=>typeof m=="object"));return s.map(c)}function FP(r,s){const c=Ss(r,s==null?void 0:s.in);return c.setHours(0,0,0,0),c}function QU(r,s,c){const[m,v]=Rv(c==null?void 0:c.in,r,s),S=FP(m),C=FP(v),o=+S-ov(S),L=+C-ov(C);return Math.round((o-L)/KU)}function e6(r,s){const c=hR(r,s),m=bc(r,0);return m.setFullYear(c,0,4),m.setHours(0,0,0,0),sv(m)}function Tx(r,s){const c=+Ss(r)-+Ss(s);return c<0?-1:c>0?1:c}function t6(r){return bc(r,Date.now())}function r6(r){return r instanceof Date||typeof r=="object"&&Object.prototype.toString.call(r)==="[object Date]"}function i6(r){return!(!r6(r)&&typeof r!="number"||isNaN(+Ss(r)))}function n6(r,s,c){const[m,v]=Rv(c==null?void 0:c.in,r,s),S=m.getFullYear()-v.getFullYear(),C=m.getMonth()-v.getMonth();return S*12+C}function s6(r){return s=>{const m=(r?Math[r]:Math.trunc)(s);return m===0?0:m}}function o6(r,s){return+Ss(r)-+Ss(s)}function a6(r,s){const c=Ss(r,s==null?void 0:s.in);return c.setHours(23,59,59,999),c}function l6(r,s){const c=Ss(r,s==null?void 0:s.in),m=c.getMonth();return c.setFullYear(c.getFullYear(),m+1,0),c.setHours(23,59,59,999),c}function c6(r,s){const c=Ss(r,s==null?void 0:s.in);return+a6(c,s)==+l6(c,s)}function u6(r,s,c){const[m,v,S]=Rv(c==null?void 0:c.in,r,r,s),C=Tx(v,S),o=Math.abs(n6(v,S));if(o<1)return 0;v.getMonth()===1&&v.getDate()>27&&v.setDate(30),v.setMonth(v.getMonth()-C*o);let L=Tx(v,S)===-C;c6(m)&&o===1&&Tx(m,S)===1&&(L=!1);const F=C*(o-+L);return F===0?0:F}function d6(r,s,c){const m=o6(r,s)/1e3;return s6(c==null?void 0:c.roundingMethod)(m)}function h6(r,s){const c=Ss(r,s==null?void 0:s.in);return c.setFullYear(c.getFullYear(),0,1),c.setHours(0,0,0,0),c}const f6={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},p6=(r,s,c)=>{let m;const v=f6[r];return typeof v=="string"?m=v:s===1?m=v.one:m=v.other.replace("{{count}}",s.toString()),c!=null&&c.addSuffix?c.comparison&&c.comparison>0?"in "+m:m+" ago":m};function vp(r){return(s={})=>{const c=s.width?String(s.width):r.defaultWidth;return r.formats[c]||r.formats[r.defaultWidth]}}const m6={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},g6={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},_6={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},y6={date:vp({formats:m6,defaultWidth:"full"}),time:vp({formats:g6,defaultWidth:"full"}),dateTime:vp({formats:_6,defaultWidth:"full"})},x6={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},v6=(r,s,c,m)=>x6[r];function Il(r){return(s,c)=>{const m=c!=null&&c.context?String(c.context):"standalone";let v;if(m==="formatting"&&r.formattingValues){const C=r.defaultFormattingWidth||r.defaultWidth,o=c!=null&&c.width?String(c.width):C;v=r.formattingValues[o]||r.formattingValues[C]}else{const C=r.defaultWidth,o=c!=null&&c.width?String(c.width):r.defaultWidth;v=r.values[o]||r.values[C]}const S=r.argumentCallback?r.argumentCallback(s):s;return v[S]}}const b6={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},w6={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},S6={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},T6={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},E6={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},I6={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},C6=(r,s)=>{const c=Number(r),m=c%100;if(m>20||m<10)switch(m%10){case 1:return c+"st";case 2:return c+"nd";case 3:return c+"rd"}return c+"th"},A6={ordinalNumber:C6,era:Il({values:b6,defaultWidth:"wide"}),quarter:Il({values:w6,defaultWidth:"wide",argumentCallback:r=>r-1}),month:Il({values:S6,defaultWidth:"wide"}),day:Il({values:T6,defaultWidth:"wide"}),dayPeriod:Il({values:E6,defaultWidth:"wide",formattingValues:I6,defaultFormattingWidth:"wide"})};function Cl(r){return(s,c={})=>{const m=c.width,v=m&&r.matchPatterns[m]||r.matchPatterns[r.defaultMatchWidth],S=s.match(v);if(!S)return null;const C=S[0],o=m&&r.parsePatterns[m]||r.parsePatterns[r.defaultParseWidth],L=Array.isArray(o)?k6(o,$=>$.test(C)):P6(o,$=>$.test(C));let F;F=r.valueCallback?r.valueCallback(L):L,F=c.valueCallback?c.valueCallback(F):F;const Z=s.slice(C.length);return{value:F,rest:Z}}}function P6(r,s){for(const c in r)if(Object.prototype.hasOwnProperty.call(r,c)&&s(r[c]))return c}function k6(r,s){for(let c=0;c<r.length;c++)if(s(r[c]))return c}function fR(r){return(s,c={})=>{const m=s.match(r.matchPattern);if(!m)return null;const v=m[0],S=s.match(r.parsePattern);if(!S)return null;let C=r.valueCallback?r.valueCallback(S[0]):S[0];C=c.valueCallback?c.valueCallback(C):C;const o=s.slice(v.length);return{value:C,rest:o}}}const M6=/^(\d+)(th|st|nd|rd)?/i,N6=/\d+/i,R6={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},L6={any:[/^b/i,/^(a|c)/i]},O6={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},D6={any:[/1/i,/2/i,/3/i,/4/i]},j6={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},z6={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},F6={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},B6={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},U6={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},V6={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},$6={ordinalNumber:fR({matchPattern:M6,parsePattern:N6,valueCallback:r=>parseInt(r,10)}),era:Cl({matchPatterns:R6,defaultMatchWidth:"wide",parsePatterns:L6,defaultParseWidth:"any"}),quarter:Cl({matchPatterns:O6,defaultMatchWidth:"wide",parsePatterns:D6,defaultParseWidth:"any",valueCallback:r=>r+1}),month:Cl({matchPatterns:j6,defaultMatchWidth:"wide",parsePatterns:z6,defaultParseWidth:"any"}),day:Cl({matchPatterns:F6,defaultMatchWidth:"wide",parsePatterns:B6,defaultParseWidth:"any"}),dayPeriod:Cl({matchPatterns:U6,defaultMatchWidth:"any",parsePatterns:V6,defaultParseWidth:"any"})},pR={code:"en-US",formatDistance:p6,formatLong:y6,formatRelative:v6,localize:A6,match:$6,options:{weekStartsOn:0,firstWeekContainsDate:1}};function G6(r,s){const c=Ss(r,s==null?void 0:s.in);return QU(c,h6(c))+1}function q6(r,s){const c=Ss(r,s==null?void 0:s.in),m=+sv(c)-+e6(c);return Math.round(m/dR)+1}function mR(r,s){var Z,$,W,ee;const c=Ss(r,s==null?void 0:s.in),m=c.getFullYear(),v=G_(),S=(s==null?void 0:s.firstWeekContainsDate)??(($=(Z=s==null?void 0:s.locale)==null?void 0:Z.options)==null?void 0:$.firstWeekContainsDate)??v.firstWeekContainsDate??((ee=(W=v.locale)==null?void 0:W.options)==null?void 0:ee.firstWeekContainsDate)??1,C=bc((s==null?void 0:s.in)||r,0);C.setFullYear(m+1,0,S),C.setHours(0,0,0,0);const o=M_(C,s),L=bc((s==null?void 0:s.in)||r,0);L.setFullYear(m,0,S),L.setHours(0,0,0,0);const F=M_(L,s);return+c>=+o?m+1:+c>=+F?m:m-1}function H6(r,s){var o,L,F,Z;const c=G_(),m=(s==null?void 0:s.firstWeekContainsDate)??((L=(o=s==null?void 0:s.locale)==null?void 0:o.options)==null?void 0:L.firstWeekContainsDate)??c.firstWeekContainsDate??((Z=(F=c.locale)==null?void 0:F.options)==null?void 0:Z.firstWeekContainsDate)??1,v=mR(r,s),S=bc((s==null?void 0:s.in)||r,0);return S.setFullYear(v,0,m),S.setHours(0,0,0,0),M_(S,s)}function W6(r,s){const c=Ss(r,s==null?void 0:s.in),m=+M_(c,s)-+H6(c,s);return Math.round(m/dR)+1}function tn(r,s){const c=r<0?"-":"",m=Math.abs(r).toString().padStart(s,"0");return c+m}const _u={y(r,s){const c=r.getFullYear(),m=c>0?c:1-c;return tn(s==="yy"?m%100:m,s.length)},M(r,s){const c=r.getMonth();return s==="M"?String(c+1):tn(c+1,2)},d(r,s){return tn(r.getDate(),s.length)},a(r,s){const c=r.getHours()/12>=1?"pm":"am";switch(s){case"a":case"aa":return c.toUpperCase();case"aaa":return c;case"aaaaa":return c[0];case"aaaa":default:return c==="am"?"a.m.":"p.m."}},h(r,s){return tn(r.getHours()%12||12,s.length)},H(r,s){return tn(r.getHours(),s.length)},m(r,s){return tn(r.getMinutes(),s.length)},s(r,s){return tn(r.getSeconds(),s.length)},S(r,s){const c=s.length,m=r.getMilliseconds(),v=Math.trunc(m*Math.pow(10,c-3));return tn(v,s.length)}},Kf={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},BP={G:function(r,s,c){const m=r.getFullYear()>0?1:0;switch(s){case"G":case"GG":case"GGG":return c.era(m,{width:"abbreviated"});case"GGGGG":return c.era(m,{width:"narrow"});case"GGGG":default:return c.era(m,{width:"wide"})}},y:function(r,s,c){if(s==="yo"){const m=r.getFullYear(),v=m>0?m:1-m;return c.ordinalNumber(v,{unit:"year"})}return _u.y(r,s)},Y:function(r,s,c,m){const v=mR(r,m),S=v>0?v:1-v;if(s==="YY"){const C=S%100;return tn(C,2)}return s==="Yo"?c.ordinalNumber(S,{unit:"year"}):tn(S,s.length)},R:function(r,s){const c=hR(r);return tn(c,s.length)},u:function(r,s){const c=r.getFullYear();return tn(c,s.length)},Q:function(r,s,c){const m=Math.ceil((r.getMonth()+1)/3);switch(s){case"Q":return String(m);case"QQ":return tn(m,2);case"Qo":return c.ordinalNumber(m,{unit:"quarter"});case"QQQ":return c.quarter(m,{width:"abbreviated",context:"formatting"});case"QQQQQ":return c.quarter(m,{width:"narrow",context:"formatting"});case"QQQQ":default:return c.quarter(m,{width:"wide",context:"formatting"})}},q:function(r,s,c){const m=Math.ceil((r.getMonth()+1)/3);switch(s){case"q":return String(m);case"qq":return tn(m,2);case"qo":return c.ordinalNumber(m,{unit:"quarter"});case"qqq":return c.quarter(m,{width:"abbreviated",context:"standalone"});case"qqqqq":return c.quarter(m,{width:"narrow",context:"standalone"});case"qqqq":default:return c.quarter(m,{width:"wide",context:"standalone"})}},M:function(r,s,c){const m=r.getMonth();switch(s){case"M":case"MM":return _u.M(r,s);case"Mo":return c.ordinalNumber(m+1,{unit:"month"});case"MMM":return c.month(m,{width:"abbreviated",context:"formatting"});case"MMMMM":return c.month(m,{width:"narrow",context:"formatting"});case"MMMM":default:return c.month(m,{width:"wide",context:"formatting"})}},L:function(r,s,c){const m=r.getMonth();switch(s){case"L":return String(m+1);case"LL":return tn(m+1,2);case"Lo":return c.ordinalNumber(m+1,{unit:"month"});case"LLL":return c.month(m,{width:"abbreviated",context:"standalone"});case"LLLLL":return c.month(m,{width:"narrow",context:"standalone"});case"LLLL":default:return c.month(m,{width:"wide",context:"standalone"})}},w:function(r,s,c,m){const v=W6(r,m);return s==="wo"?c.ordinalNumber(v,{unit:"week"}):tn(v,s.length)},I:function(r,s,c){const m=q6(r);return s==="Io"?c.ordinalNumber(m,{unit:"week"}):tn(m,s.length)},d:function(r,s,c){return s==="do"?c.ordinalNumber(r.getDate(),{unit:"date"}):_u.d(r,s)},D:function(r,s,c){const m=G6(r);return s==="Do"?c.ordinalNumber(m,{unit:"dayOfYear"}):tn(m,s.length)},E:function(r,s,c){const m=r.getDay();switch(s){case"E":case"EE":case"EEE":return c.day(m,{width:"abbreviated",context:"formatting"});case"EEEEE":return c.day(m,{width:"narrow",context:"formatting"});case"EEEEEE":return c.day(m,{width:"short",context:"formatting"});case"EEEE":default:return c.day(m,{width:"wide",context:"formatting"})}},e:function(r,s,c,m){const v=r.getDay(),S=(v-m.weekStartsOn+8)%7||7;switch(s){case"e":return String(S);case"ee":return tn(S,2);case"eo":return c.ordinalNumber(S,{unit:"day"});case"eee":return c.day(v,{width:"abbreviated",context:"formatting"});case"eeeee":return c.day(v,{width:"narrow",context:"formatting"});case"eeeeee":return c.day(v,{width:"short",context:"formatting"});case"eeee":default:return c.day(v,{width:"wide",context:"formatting"})}},c:function(r,s,c,m){const v=r.getDay(),S=(v-m.weekStartsOn+8)%7||7;switch(s){case"c":return String(S);case"cc":return tn(S,s.length);case"co":return c.ordinalNumber(S,{unit:"day"});case"ccc":return c.day(v,{width:"abbreviated",context:"standalone"});case"ccccc":return c.day(v,{width:"narrow",context:"standalone"});case"cccccc":return c.day(v,{width:"short",context:"standalone"});case"cccc":default:return c.day(v,{width:"wide",context:"standalone"})}},i:function(r,s,c){const m=r.getDay(),v=m===0?7:m;switch(s){case"i":return String(v);case"ii":return tn(v,s.length);case"io":return c.ordinalNumber(v,{unit:"day"});case"iii":return c.day(m,{width:"abbreviated",context:"formatting"});case"iiiii":return c.day(m,{width:"narrow",context:"formatting"});case"iiiiii":return c.day(m,{width:"short",context:"formatting"});case"iiii":default:return c.day(m,{width:"wide",context:"formatting"})}},a:function(r,s,c){const v=r.getHours()/12>=1?"pm":"am";switch(s){case"a":case"aa":return c.dayPeriod(v,{width:"abbreviated",context:"formatting"});case"aaa":return c.dayPeriod(v,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return c.dayPeriod(v,{width:"narrow",context:"formatting"});case"aaaa":default:return c.dayPeriod(v,{width:"wide",context:"formatting"})}},b:function(r,s,c){const m=r.getHours();let v;switch(m===12?v=Kf.noon:m===0?v=Kf.midnight:v=m/12>=1?"pm":"am",s){case"b":case"bb":return c.dayPeriod(v,{width:"abbreviated",context:"formatting"});case"bbb":return c.dayPeriod(v,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return c.dayPeriod(v,{width:"narrow",context:"formatting"});case"bbbb":default:return c.dayPeriod(v,{width:"wide",context:"formatting"})}},B:function(r,s,c){const m=r.getHours();let v;switch(m>=17?v=Kf.evening:m>=12?v=Kf.afternoon:m>=4?v=Kf.morning:v=Kf.night,s){case"B":case"BB":case"BBB":return c.dayPeriod(v,{width:"abbreviated",context:"formatting"});case"BBBBB":return c.dayPeriod(v,{width:"narrow",context:"formatting"});case"BBBB":default:return c.dayPeriod(v,{width:"wide",context:"formatting"})}},h:function(r,s,c){if(s==="ho"){let m=r.getHours()%12;return m===0&&(m=12),c.ordinalNumber(m,{unit:"hour"})}return _u.h(r,s)},H:function(r,s,c){return s==="Ho"?c.ordinalNumber(r.getHours(),{unit:"hour"}):_u.H(r,s)},K:function(r,s,c){const m=r.getHours()%12;return s==="Ko"?c.ordinalNumber(m,{unit:"hour"}):tn(m,s.length)},k:function(r,s,c){let m=r.getHours();return m===0&&(m=24),s==="ko"?c.ordinalNumber(m,{unit:"hour"}):tn(m,s.length)},m:function(r,s,c){return s==="mo"?c.ordinalNumber(r.getMinutes(),{unit:"minute"}):_u.m(r,s)},s:function(r,s,c){return s==="so"?c.ordinalNumber(r.getSeconds(),{unit:"second"}):_u.s(r,s)},S:function(r,s){return _u.S(r,s)},X:function(r,s,c){const m=r.getTimezoneOffset();if(m===0)return"Z";switch(s){case"X":return VP(m);case"XXXX":case"XX":return Hd(m);case"XXXXX":case"XXX":default:return Hd(m,":")}},x:function(r,s,c){const m=r.getTimezoneOffset();switch(s){case"x":return VP(m);case"xxxx":case"xx":return Hd(m);case"xxxxx":case"xxx":default:return Hd(m,":")}},O:function(r,s,c){const m=r.getTimezoneOffset();switch(s){case"O":case"OO":case"OOO":return"GMT"+UP(m,":");case"OOOO":default:return"GMT"+Hd(m,":")}},z:function(r,s,c){const m=r.getTimezoneOffset();switch(s){case"z":case"zz":case"zzz":return"GMT"+UP(m,":");case"zzzz":default:return"GMT"+Hd(m,":")}},t:function(r,s,c){const m=Math.trunc(+r/1e3);return tn(m,s.length)},T:function(r,s,c){return tn(+r,s.length)}};function UP(r,s=""){const c=r>0?"-":"+",m=Math.abs(r),v=Math.trunc(m/60),S=m%60;return S===0?c+String(v):c+String(v)+s+tn(S,2)}function VP(r,s){return r%60===0?(r>0?"-":"+")+tn(Math.abs(r)/60,2):Hd(r,s)}function Hd(r,s=""){const c=r>0?"-":"+",m=Math.abs(r),v=tn(Math.trunc(m/60),2),S=tn(m%60,2);return c+v+s+S}const $P=(r,s)=>{switch(r){case"P":return s.date({width:"short"});case"PP":return s.date({width:"medium"});case"PPP":return s.date({width:"long"});case"PPPP":default:return s.date({width:"full"})}},gR=(r,s)=>{switch(r){case"p":return s.time({width:"short"});case"pp":return s.time({width:"medium"});case"ppp":return s.time({width:"long"});case"pppp":default:return s.time({width:"full"})}},Z6=(r,s)=>{const c=r.match(/(P+)(p+)?/)||[],m=c[1],v=c[2];if(!v)return $P(r,s);let S;switch(m){case"P":S=s.dateTime({width:"short"});break;case"PP":S=s.dateTime({width:"medium"});break;case"PPP":S=s.dateTime({width:"long"});break;case"PPPP":default:S=s.dateTime({width:"full"});break}return S.replace("{{date}}",$P(m,s)).replace("{{time}}",gR(v,s))},X6={p:gR,P:Z6},Y6=/^D+$/,K6=/^Y+$/,J6=["D","DD","YY","YYYY"];function Q6(r){return Y6.test(r)}function eV(r){return K6.test(r)}function tV(r,s,c){const m=rV(r,s,c);if(console.warn(m),J6.includes(r))throw new RangeError(m)}function rV(r,s,c){const m=r[0]==="Y"?"years":"days of the month";return`Use \`${r.toLowerCase()}\` instead of \`${r}\` (in \`${s}\`) for formatting ${m} to the input \`${c}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const iV=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,nV=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,sV=/^'([^]*?)'?$/,oV=/''/g,aV=/[a-zA-Z]/;function Ex(r,s,c){var Z,$,W,ee,ie,ae,ke,le;const m=G_(),v=(c==null?void 0:c.locale)??m.locale??pR,S=(c==null?void 0:c.firstWeekContainsDate)??(($=(Z=c==null?void 0:c.locale)==null?void 0:Z.options)==null?void 0:$.firstWeekContainsDate)??m.firstWeekContainsDate??((ee=(W=m.locale)==null?void 0:W.options)==null?void 0:ee.firstWeekContainsDate)??1,C=(c==null?void 0:c.weekStartsOn)??((ae=(ie=c==null?void 0:c.locale)==null?void 0:ie.options)==null?void 0:ae.weekStartsOn)??m.weekStartsOn??((le=(ke=m.locale)==null?void 0:ke.options)==null?void 0:le.weekStartsOn)??0,o=Ss(r,c==null?void 0:c.in);if(!i6(o))throw new RangeError("Invalid time value");let L=s.match(nV).map(se=>{const J=se[0];if(J==="p"||J==="P"){const Ee=X6[J];return Ee(se,v.formatLong)}return se}).join("").match(iV).map(se=>{if(se==="''")return{isToken:!1,value:"'"};const J=se[0];if(J==="'")return{isToken:!1,value:lV(se)};if(BP[J])return{isToken:!0,value:se};if(J.match(aV))throw new RangeError("Format string contains an unescaped latin alphabet character `"+J+"`");return{isToken:!1,value:se}});v.localize.preprocessor&&(L=v.localize.preprocessor(o,L));const F={firstWeekContainsDate:S,weekStartsOn:C,locale:v};return L.map(se=>{if(!se.isToken)return se.value;const J=se.value;(!(c!=null&&c.useAdditionalWeekYearTokens)&&eV(J)||!(c!=null&&c.useAdditionalDayOfYearTokens)&&Q6(J))&&tV(J,s,String(r));const Ee=BP[J[0]];return Ee(o,J,v.localize,F)}).join("")}function lV(r){const s=r.match(sV);return s?s[1].replace(oV,"'"):r}function cV(r,s,c){const m=G_(),v=(c==null?void 0:c.locale)??m.locale??pR,S=2520,C=Tx(r,s);if(isNaN(C))throw new RangeError("Invalid time value");const o=Object.assign({},c,{addSuffix:c==null?void 0:c.addSuffix,comparison:C}),[L,F]=Rv(c==null?void 0:c.in,...C>0?[s,r]:[r,s]),Z=d6(F,L),$=(ov(F)-ov(L))/1e3,W=Math.round((Z-$)/60);let ee;if(W<2)return c!=null&&c.includeSeconds?Z<5?v.formatDistance("lessThanXSeconds",5,o):Z<10?v.formatDistance("lessThanXSeconds",10,o):Z<20?v.formatDistance("lessThanXSeconds",20,o):Z<40?v.formatDistance("halfAMinute",0,o):Z<60?v.formatDistance("lessThanXMinutes",1,o):v.formatDistance("xMinutes",1,o):W===0?v.formatDistance("lessThanXMinutes",1,o):v.formatDistance("xMinutes",W,o);if(W<45)return v.formatDistance("xMinutes",W,o);if(W<90)return v.formatDistance("aboutXHours",1,o);if(W<jP){const ie=Math.round(W/60);return v.formatDistance("aboutXHours",ie,o)}else{if(W<S)return v.formatDistance("xDays",1,o);if(W<cx){const ie=Math.round(W/jP);return v.formatDistance("xDays",ie,o)}else if(W<cx*2)return ee=Math.round(W/cx),v.formatDistance("aboutXMonths",ee,o)}if(ee=u6(F,L),ee<12){const ie=Math.round(W/cx);return v.formatDistance("xMonths",ie,o)}else{const ie=ee%12,ae=Math.trunc(ee/12);return ie<3?v.formatDistance("aboutXYears",ae,o):ie<9?v.formatDistance("overXYears",ae,o):v.formatDistance("almostXYears",ae+1,o)}}function uV(r,s){return cV(r,t6(r),s)}function dV({type:r,onClose:s}){const c=r==="hidden",m=r==="archived",v=XU(),S=YU(),{hiddenEntities:C,loading:o,error:L,showEntity:F,showAllEntities:Z,archiveEntity:$,deleteEntity:W,count:ee,getEntityCountsByType:ie}=v,{archivedEntities:ae,loading:ke,error:le,restoreAllEntities:se,count:J,getEntityCountsByType:Ee}=S,je=c?C:ae,Xe=c?o:ke,tt=c?L:le,it=c?ee:J,We=c?ie:Ee,[Ct,Nt]=Ne.useState(""),[Wt,fr]=Ne.useState("all"),[dr,cr]=Ne.useState(null),[Ut,jr]=Ne.useState(null),Ht=(je||[]).filter(or=>{const pr=Ct===""||or.name.toLowerCase().includes(Ct.toLowerCase())||or.class&&or.class.toLowerCase().includes(Ct.toLowerCase()),$r=Wt==="all"||or.type===Wt;return pr&&$r}),xr=[...new Set((je||[]).map(or=>or.type))];We&&We();const Rt=async(or,pr,$r)=>{jr(pr);let Di;if(c)switch(or){case"show":Di=await F(pr);break;case"archive":Di=await $(pr);break;case"delete":Di=await W(pr);break;default:jr(null);return}else switch(or){case"restore":Di=await S.restoreEntity(pr);break;case"delete":Di=await S.deleteArchivedEntity(pr);break;default:jr(null);return}Di.success||console.error("Error en acción:",Di.error),jr(null)},rr=async or=>{jr(or);let pr;c?pr=await Z():pr=await se(),pr.success||console.error("Error en acción en lote:",pr.error),jr(null),s()},Nr=()=>c?"Entidades Ocultas":"Entidades Archivadas",Un=()=>c?F_:E_,us=()=>c?"text-red-400":"text-yellow-400",rs=()=>c?"Mostrar Todas":"Restaurar Todas",Yr=()=>c?kl:aP,vi=()=>c?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700";if(Xe)return x.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm",children:x.jsx("div",{className:"bg-slate-900 border border-slate-700 rounded-lg p-8",children:x.jsxs("div",{className:"flex items-center gap-3 text-white",children:[x.jsx(Wd,{className:"w-6 h-6 animate-spin"}),x.jsx("span",{children:"Cargando entidades..."})]})})});if(tt)return x.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm",children:x.jsx("div",{className:"bg-slate-900 border border-slate-700 rounded-lg p-8",children:x.jsxs("div",{className:"flex items-center gap-3 text-red-400",children:[x.jsx(Qx,{className:"w-6 h-6"}),x.jsxs("span",{children:["Error: ",tt]})]})})});const Vi=Un(),Vn=Yr();return x.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in",children:x.jsxs("div",{className:"relative w-full max-w-2xl max-h-[85vh] bg-slate-900 border border-slate-700 rounded-lg shadow-xl flex flex-col animate-in zoom-in-90 duration-300",children:[x.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700",children:[x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx(Vi,{className:`w-6 h-6 ${us()}`}),x.jsxs("div",{children:[x.jsx("h2",{className:"text-lg font-bold text-white",children:Nr()}),x.jsxs("p",{className:"text-xs text-slate-400",children:[it," entidades"]})]})]}),x.jsx("button",{onClick:s,className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsxs("div",{className:"p-3 flex gap-2 border-b border-slate-800",children:[x.jsxs("div",{className:"relative flex-1",children:[x.jsx(Pp,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"}),x.jsx("input",{type:"text",placeholder:"Buscar...",className:"w-full pl-8 pr-3 py-1.5 bg-slate-800 rounded text-white border border-slate-700 focus:border-blue-500 focus:ring-blue-500 text-xs",value:Ct,onChange:or=>Nt(or.target.value)})]}),x.jsxs("div",{className:"relative",children:[x.jsx(x2,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"}),x.jsxs("select",{className:"w-full pl-8 pr-3 py-1.5 bg-slate-800 rounded text-white border border-slate-700 focus:border-blue-500 focus:ring-blue-500 text-xs appearance-none",value:Wt,onChange:or=>fr(or.target.value),children:[x.jsx("option",{value:"all",children:"Todos"}),xr.map(or=>x.jsx("option",{value:or,children:or.charAt(0).toUpperCase()+or.slice(1)},or))]}),x.jsx(Ap,{className:"absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500 pointer-events-none"})]})]}),it>0&&x.jsx("div",{className:"px-3 py-2 border-b border-slate-800",children:x.jsxs("button",{onClick:()=>rr("batch"),disabled:it===0||Ut==="batch",className:`w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-xs font-medium transition-colors
                ${it===0||Ut==="batch"?"bg-slate-700 text-slate-500 cursor-not-allowed":`${vi()} text-white shadow-lg`}`,children:[Ut==="batch"?x.jsx(Wd,{className:"w-3 h-3 animate-spin"}):x.jsx(Vn,{className:"w-3 h-3"}),rs()," (",it,")"]})}),x.jsx("div",{className:"flex-1 overflow-hidden flex flex-col",children:x.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-3",children:Xe?x.jsxs("div",{className:"flex items-center justify-center py-8 text-blue-400",children:[x.jsx(Wd,{className:"w-6 h-6 animate-spin mr-2"}),x.jsx("span",{className:"text-sm",children:"Cargando..."})]}):tt?x.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-red-400",children:[x.jsx(Qx,{className:"w-8 h-8 mb-2"}),x.jsx("p",{className:"text-sm font-semibold",children:"Error al cargar entidades"}),x.jsx("p",{className:"text-xs text-slate-400",children:tt})]}):Ht.length===0?x.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-slate-500",children:[x.jsx(Vi,{className:"w-10 h-10 mb-3"}),x.jsxs("h3",{className:"text-sm font-semibold",children:["No hay entidades ",c?"ocultas":"archivadas"]}),x.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"Las entidades aparecerán aquí."})]}):x.jsx("div",{className:"grid grid-cols-1 gap-2",children:Ht.map(or=>x.jsxs("div",{className:"bg-slate-800 p-2 rounded-lg border border-slate-700",children:[x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx(hV,{entity:or}),x.jsxs("div",{children:[x.jsx("h4",{className:"text-sm font-semibold text-white",children:or.name}),x.jsxs("p",{className:"text-xs text-slate-400",children:[x.jsx("span",{className:"capitalize",children:or.type})," • ",or.class]})]})]}),x.jsxs("div",{className:"flex items-center gap-1",children:[x.jsx("button",{onClick:()=>cr(dr===or.id?null:or.id),className:"p-1 rounded hover:bg-slate-700 text-slate-400 hover:text-white transition-colors",title:"Ver detalles",children:dr===or.id?x.jsx(aF,{size:16}):x.jsx(Ap,{size:16})}),x.jsx("button",{onClick:()=>Rt(c?"show":"restore",or.id,or.name),disabled:Ut===or.id,className:`p-1.5 rounded ${c?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"} text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed`,title:c?"Mostrar en mapa":"Restaurar entidad",children:Ut===or.id?x.jsx(Wd,{className:"w-3 h-3 animate-spin"}):c?x.jsx(kl,{size:16}):x.jsx(aP,{size:16})})]})]}),dr===or.id&&x.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700 text-sm text-slate-300",children:[x.jsxs("p",{children:[x.jsx("strong",{children:"ID:"})," ",or.id]}),x.jsxs("p",{children:[x.jsx("strong",{children:"Creado:"})," ",Ex(new Date(or.created_at),"dd/MM/yyyy HH:mm")]}),m&&or.archived_at&&x.jsxs("p",{children:[x.jsx("strong",{children:"Archivado:"})," ",Ex(new Date(or.archived_at),"dd/MM/yyyy HH:mm")]}),or.last_seen_at&&x.jsxs("p",{children:[x.jsx("strong",{children:"Última vez visto:"})," ",Ex(new Date(or.last_seen_at),"dd/MM/yyyy HH:mm")]}),or.metadata&&x.jsxs("div",{className:"mt-2",children:[x.jsx("strong",{children:"Metadatos:"}),x.jsx("pre",{className:"bg-slate-700 p-2 rounded-md text-xs overflow-x-auto mt-1",children:JSON.stringify(or.metadata,null,2)})]}),x.jsx("div",{className:"flex gap-2 mt-3",children:x.jsxs("button",{onClick:()=>Rt(c?"archive":"delete",or.id,or.name),disabled:Ut===or.id,className:`flex-1 flex items-center justify-center gap-1 px-3 py-1 rounded-md ${c?"bg-yellow-700 hover:bg-yellow-800":"bg-red-700 hover:bg-red-800"} text-white text-xs disabled:opacity-50 disabled:cursor-not-allowed`,children:[Ut===or.id?x.jsx(Wd,{className:"w-3 h-3 animate-spin"}):c?x.jsx(E_,{size:14}):x.jsx(Sc,{size:14}),c?"Archivar":"Eliminar permanentemente"]})})]})]},or.id))})})}),it>0&&x.jsx("div",{className:"px-3 py-2 border-t border-slate-700 bg-slate-800/30",children:x.jsxs("div",{className:"text-xs text-slate-400 text-center",children:["Mostrando ",Ht.length," de ",it," entidades"]})})]})})}function hV({entity:r}){const[s,c]=Ne.useState(!1),[m,v]=Ne.useState(!1);return Ne.useEffect(()=>{c(!1),v(!1)},[r.id]),!r.image_url||s?x.jsx("div",{className:"w-10 h-10 bg-slate-700 rounded-md flex items-center justify-center",children:x.jsx(Ai,{className:"w-6 h-6 text-slate-400"})}):x.jsxs("div",{className:"relative w-10 h-10",children:[!m&&x.jsx("div",{className:"absolute inset-0 bg-slate-700 rounded-md flex items-center justify-center",children:x.jsx(Wd,{className:"w-4 h-4 text-slate-400 animate-spin"})}),x.jsx("img",{src:r.image_url,alt:r.name,className:"w-10 h-10 object-cover rounded-md",onLoad:()=>v(!0),onError:()=>c(!0),style:{display:m?"block":"none"}})]})}function fV({onClose:r}){const[s,c]=Ne.useState(()=>parseInt(localStorage.getItem("clusterZoomThreshold")||"5")),[m,v]=Ne.useState(()=>parseInt(localStorage.getItem("clusterRadius")||"50")),[S,C]=Ne.useState(()=>parseInt(localStorage.getItem("iconSize")||"32")),[o,L]=Ne.useState(()=>localStorage.getItem("useImages")!=="false"),[F,Z]=Ne.useState(()=>localStorage.getItem("showLabelName")!=="false"),[$,W]=Ne.useState(()=>localStorage.getItem("showLabelType")!=="false"),[ee,ie]=Ne.useState(()=>localStorage.getItem("showLabelClass")==="true"),[ae,ke]=Ne.useState(()=>localStorage.getItem("entityViewMode")||"card");Ne.useEffect(()=>{localStorage.setItem("clusterZoomThreshold",s),localStorage.setItem("clusterRadius",m),localStorage.setItem("iconSize",S),localStorage.setItem("useImages",o),localStorage.setItem("showLabelName",F),localStorage.setItem("showLabelType",$),localStorage.setItem("showLabelClass",ee),localStorage.setItem("entityViewMode",ae),window.dispatchEvent(new CustomEvent("settingsChanged",{detail:{clusterZoomThreshold:s,clusterRadius:m,iconSize:S,useImages:o,showLabelName:F,showLabelType:$,showLabelClass:ee,entityViewMode:ae}}))},[s,m,S,o,F,$,ee,ae]);const le=()=>{c(5),v(50),C(32),L(!0),Z(!0),W(!0),ie(!1),ke("card")};return x.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in",children:x.jsxs("div",{className:"relative w-full max-w-2xl max-h-[85vh] bg-slate-900 border border-slate-700 rounded-lg shadow-xl flex flex-col",children:[x.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx(B_,{className:"w-6 h-6 text-blue-400"}),x.jsx("h2",{className:"text-lg font-bold text-white",children:"Configuración del Mapa"})]}),x.jsx("button",{onClick:r,className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700",children:[x.jsxs("h3",{className:"text-sm font-semibold text-blue-400 mb-4 flex items-center gap-2",children:[x.jsx(TN,{className:"w-4 h-4"}),"CLUSTERING DE ENTIDADES"]}),x.jsxs("div",{className:"space-y-3",children:[x.jsxs("div",{children:[x.jsxs("label",{className:"flex items-center justify-between mb-2",children:[x.jsx("span",{className:"text-sm text-slate-300",children:"Cambiar a iconos en zoom:"}),x.jsx("span",{className:"text-sm font-mono text-blue-400",children:s})]}),x.jsx("input",{type:"range",min:"5",max:"12",step:"1",value:s,onChange:se=>c(parseInt(se.target.value)),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"}),x.jsxs("div",{className:"flex justify-between text-xs text-slate-500 mt-1",children:[x.jsx("span",{children:"5 (Más temprano)"}),x.jsx("span",{children:"12 (Más tarde)"})]}),x.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"ℹ️ Valor menor = iconos aparecen con menos zoom. Recomendado: 6-7 para ver iconos antes."})]}),x.jsxs("div",{className:"pt-3 border-t border-slate-700",children:[x.jsxs("label",{className:"flex items-center justify-between mb-2",children:[x.jsx("span",{className:"text-sm text-slate-300",children:"Radio de agrupación:"}),x.jsxs("span",{className:"text-sm font-mono text-blue-400",children:[m,"px"]})]}),x.jsx("input",{type:"range",min:"30",max:"100",step:"10",value:m,onChange:se=>v(parseInt(se.target.value)),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"}),x.jsxs("div",{className:"flex justify-between text-xs text-slate-500 mt-1",children:[x.jsx("span",{children:"30px (Menos agrupación)"}),x.jsx("span",{children:"100px (Más agrupación)"})]}),x.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"ℹ️ Controla qué tan cerca deben estar las entidades para agruparse."})]})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700",children:[x.jsxs("h3",{className:"text-sm font-semibold text-green-400 mb-4 flex items-center gap-2",children:[x.jsx(kl,{className:"w-4 h-4"}),"VISUALIZACIÓN DE ENTIDADES"]}),x.jsxs("div",{className:"mb-4 pb-4 border-b border-slate-700",children:[x.jsxs("label",{className:"flex items-center justify-between mb-2",children:[x.jsx("span",{className:"text-sm text-slate-300",children:"Usar imágenes de plantillas:"}),x.jsx("button",{onClick:()=>L(!o),className:`relative w-12 h-6 rounded-full transition-colors ${o?"bg-green-600":"bg-slate-600"}`,children:x.jsx("div",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${o?"translate-x-6":"translate-x-0"}`})})]}),x.jsx("p",{className:"text-xs text-slate-400",children:o?"✅ Mostrando imágenes de plantillas cuando estén disponibles":"❌ Mostrando solo iconos (más rápido)"})]}),x.jsxs("div",{children:[x.jsxs("label",{className:"flex items-center justify-between mb-2",children:[x.jsx("span",{className:"text-sm text-slate-300",children:"Tamaño de iconos:"}),x.jsxs("span",{className:"text-sm font-mono text-green-400",children:[S,"px"]})]}),x.jsx("input",{type:"range",min:"24",max:"72",step:"8",value:S,onChange:se=>C(parseInt(se.target.value)),className:"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-green-500"}),x.jsxs("div",{className:"flex justify-between text-xs text-slate-500 mt-1",children:[x.jsx("span",{children:"24px (Pequeño)"}),x.jsx("span",{children:"48px (Normal)"}),x.jsx("span",{children:"72px (Grande)"})]}),x.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"ℹ️ Tamaño de los iconos de barcos/aviones en el mapa."})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700",children:[x.jsxs("h3",{className:"text-sm font-semibold text-cyan-400 mb-4 flex items-center gap-2",children:[x.jsx($F,{className:"w-4 h-4"}),"MODO DE VISTA DE ENTIDAD"]}),x.jsx("p",{className:"text-xs text-slate-400 mb-4",children:"Elige cómo mostrar los detalles cuando haces clic en una entidad del mapa."}),x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsx("button",{onClick:()=>ke("card"),className:`p-4 rounded-lg border-2 transition-all ${ae==="card"?"border-cyan-500 bg-cyan-500/20":"border-slate-600 bg-slate-700/30 hover:border-slate-500"}`,children:x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:"text-3xl mb-2",children:"🎴"}),x.jsx("div",{className:"text-sm font-semibold text-white mb-1",children:"Card Futurista"}),x.jsx("div",{className:"text-xs text-slate-400",children:"Flotante, centrada, estilo juego"}),ae==="card"&&x.jsx("div",{className:"mt-2 text-xs font-bold text-cyan-400",children:"✓ ACTIVO"})]})}),x.jsx("button",{onClick:()=>ke("sidebar"),className:`p-4 rounded-lg border-2 transition-all ${ae==="sidebar"?"border-cyan-500 bg-cyan-500/20":"border-slate-600 bg-slate-700/30 hover:border-slate-500"}`,children:x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:"text-3xl mb-2",children:"📊"}),x.jsx("div",{className:"text-sm font-semibold text-white mb-1",children:"Sidebar Clásico"}),x.jsx("div",{className:"text-xs text-slate-400",children:"Panel lateral, más espacio"}),ae==="sidebar"&&x.jsx("div",{className:"mt-2 text-xs font-bold text-cyan-400",children:"✓ ACTIVO"})]})})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700",children:[x.jsxs("h3",{className:"text-sm font-semibold text-purple-400 mb-4 flex items-center gap-2",children:[x.jsx(b4,{className:"w-4 h-4"}),"ETIQUETAS DE INFORMACIÓN"]}),x.jsx("p",{className:"text-xs text-slate-400 mb-4",children:"Controla qué información se muestra debajo de cada entidad en el mapa."}),x.jsxs("div",{className:"space-y-3",children:[x.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/50 rounded-lg",children:[x.jsxs("div",{children:[x.jsx("div",{className:"text-sm font-medium text-white",children:"Nombre de la entidad"}),x.jsx("div",{className:"text-xs text-slate-400",children:"USS Newport News, MV Ocean Trader, etc."})]}),x.jsx("button",{onClick:()=>Z(!F),className:`relative w-12 h-6 rounded-full transition-colors ${F?"bg-purple-600":"bg-slate-600"}`,children:x.jsx("div",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${F?"translate-x-6":"translate-x-0"}`})})]}),x.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/50 rounded-lg",children:[x.jsxs("div",{children:[x.jsx("div",{className:"text-sm font-medium text-white",children:"Tipo de entidad"}),x.jsx("div",{className:"text-xs text-slate-400",children:"Destructor, Submarino, Aeronave, etc."})]}),x.jsx("button",{onClick:()=>W(!$),className:`relative w-12 h-6 rounded-full transition-colors ${$?"bg-purple-600":"bg-slate-600"}`,children:x.jsx("div",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${$?"translate-x-6":"translate-x-0"}`})})]}),x.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/50 rounded-lg",children:[x.jsxs("div",{children:[x.jsx("div",{className:"text-sm font-medium text-white",children:"Modelo/Clase"}),x.jsx("div",{className:"text-xs text-slate-400",children:"Arleigh Burke Flight IIA, Los Angeles Class, etc."})]}),x.jsx("button",{onClick:()=>ie(!ee),className:`relative w-12 h-6 rounded-full transition-colors ${ee?"bg-purple-600":"bg-slate-600"}`,children:x.jsx("div",{className:`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${ee?"translate-x-6":"translate-x-0"}`})})]})]}),x.jsxs("div",{className:"mt-4 p-3 bg-slate-900/50 rounded border border-purple-900/30",children:[x.jsx("div",{className:"text-xs text-slate-400 mb-2",children:"Vista previa:"}),x.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[F&&x.jsx("div",{className:"px-2 py-0.5 bg-slate-800 text-white text-xs font-semibold rounded border border-red-500",children:"USS Newport News"}),$&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-700 text-slate-300 rounded text-[10px]",children:"Submarino"}),ee&&x.jsx("div",{className:"px-1.5 py-0.5 bg-slate-700 text-slate-400 rounded text-[9px]",children:"Los Angeles Class"}),!F&&!$&&!ee&&x.jsx("div",{className:"text-xs text-slate-500 italic",children:"Sin etiquetas"})]})]})]}),x.jsxs("div",{className:"bg-blue-900/20 rounded-lg p-4 border border-blue-900/50",children:[x.jsxs("h3",{className:"text-sm font-semibold text-blue-400 mb-3 flex items-center gap-2",children:[x.jsx(MN,{className:"w-4 h-4"}),"CONFIGURACIÓN ACTUAL"]}),x.jsxs("div",{className:"grid grid-cols-3 gap-3 text-center",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-2xl font-bold text-white",children:s}),x.jsx("div",{className:"text-xs text-slate-400",children:"Zoom iconos"})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-2xl font-bold text-white",children:m}),x.jsx("div",{className:"text-xs text-slate-400",children:"Radio cluster"})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-2xl font-bold text-white",children:S}),x.jsx("div",{className:"text-xs text-slate-400",children:"Tamaño icono"})]})]})]})]}),x.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800/50 flex justify-between",children:[x.jsx("button",{onClick:le,className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors",children:"Restablecer Valores"}),x.jsx("button",{onClick:r,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors",children:"Aplicar y Cerrar"})]})]})})}function pV({onClose:r,onCreateGroup:s,entities:c}){const{getSelectedIds:m,getSelectedCount:v}=Ev(),S=m(),C=v(),[o,L]=Ne.useState(""),[F,Z]=Ne.useState(""),[$,W]=Ne.useState("squadron"),ee=c.filter(ae=>S.includes(ae.id)),ie=async ae=>{if(ae.preventDefault(),!o.trim()){alert("Por favor ingresa un nombre para el grupo");return}if(C===0){alert("Selecciona al menos 1 entidad en el mapa (Ctrl+Click)");return}await s({name:o,description:F,group_type:$,icon_color:"#3b82f6"},S),r()};return x.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in",children:x.jsxs("div",{className:"relative w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-lg shadow-xl",children:[x.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx(lh,{className:"w-6 h-6 text-blue-400"}),x.jsx("h2",{className:"text-lg font-bold text-white",children:"Crear Grupo Manual"})]}),x.jsx("button",{onClick:r,className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsxs("form",{onSubmit:ie,className:"p-6 space-y-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Nombre del Grupo *"}),x.jsx("input",{type:"text",value:o,onChange:ae=>L(ae.target.value),placeholder:"Ej: Task Force Alpha, Strike Group 1...",className:"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Descripción (opcional)"}),x.jsx("textarea",{value:F,onChange:ae=>Z(ae.target.value),placeholder:"Describe la misión u objetivo del grupo...",rows:3,className:"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Tipo de Grupo"}),x.jsxs("select",{value:$,onChange:ae=>W(ae.target.value),className:"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[x.jsx("option",{value:"squadron",children:"Escuadrón"}),x.jsx("option",{value:"fleet",children:"Flota"}),x.jsx("option",{value:"formation",children:"Formación"}),x.jsx("option",{value:"task_force",children:"Fuerza de Tarea"})]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700",children:[x.jsxs("h3",{className:"text-sm font-semibold text-slate-400 mb-3 flex items-center gap-2",children:[x.jsx(vs,{className:"w-4 h-4"}),"ENTIDADES SELECCIONADAS (",C,")"]}),C===0?x.jsx("p",{className:"text-xs text-slate-500",children:"Usa Ctrl+Click en el mapa para seleccionar entidades"}):x.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto custom-scrollbar",children:ee.map(ae=>x.jsxs("div",{className:"text-xs text-slate-300 flex items-center gap-2",children:[x.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"}),ae.name," (",ae.class,")"]},ae.id))})]}),x.jsxs("div",{className:"flex gap-3 pt-4",children:[x.jsx("button",{type:"button",onClick:r,className:"flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors",children:"Cancelar"}),x.jsx("button",{type:"submit",disabled:C===0||!o.trim(),className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors",children:"Crear Grupo"})]})]})]})})}function mV({onClose:r}){const{groups:s,createGroup:c,addEntitiesToGroup:m,suggestGroups:v}=HS(),{entities:S}=Mv(),[C,o]=Ne.useState([]),[L,F]=Ne.useState(!0),[Z,$]=Ne.useState(!1);Ne.useEffect(()=>{if(S&&S.length>0){const ie=v(S);o(ie)}},[S,v]);const W=async ie=>{const ae={name:ie.name,description:`Grupo automático de ${ie.count} ${ie.class}`,group_type:"squadron",icon_color:"#3b82f6"},ke=await c(ae);if(ke.success){const le=ie.entities.map(se=>se.id);await m(ke.data.id,le),o(se=>se.filter(J=>J!==ie))}},ee=async(ie,ae)=>{const ke=await c(ie);return ke.success&&await m(ke.data.id,ae),ke};return x.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in",children:[x.jsxs("div",{className:"relative w-full max-w-4xl max-h-[85vh] bg-slate-900 border border-slate-700 rounded-lg shadow-xl flex flex-col",children:[x.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx(vs,{className:"w-6 h-6 text-blue-400"}),x.jsxs("div",{children:[x.jsx("h2",{className:"text-lg font-bold text-white",children:"Gestión de Grupos"}),x.jsx("p",{className:"text-xs text-slate-400",children:"Escuadrones, formaciones y flotas"})]})]}),x.jsx("button",{onClick:r,className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar",children:[L&&C.length>0&&x.jsxs("div",{className:"bg-blue-900/20 border border-blue-900/50 rounded-lg p-4",children:[x.jsxs("div",{className:"flex items-center justify-between mb-3",children:[x.jsxs("h3",{className:"text-sm font-semibold text-blue-400 flex items-center gap-2",children:[x.jsx(_4,{className:"w-4 h-4"}),"SUGERENCIAS AUTOMÁTICAS (",C.length,")"]}),x.jsx("button",{onClick:()=>F(!1),className:"text-xs text-slate-400 hover:text-white",children:"Ocultar"})]}),x.jsx("div",{className:"space-y-2",children:C.map((ie,ae)=>x.jsx("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{className:"flex-1",children:[x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx("span",{className:"text-sm font-semibold text-white",children:ie.name}),x.jsxs("span",{className:"px-2 py-0.5 bg-blue-600/30 text-blue-400 rounded text-xs font-bold",children:[ie.count," unidades"]})]}),x.jsx("p",{className:"text-xs text-slate-400 mt-1",children:ie.entities.map(ke=>ke.name).join(", ")}),x.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["📍 Centro: ",ie.centerLat.toFixed(2),"°, ",ie.centerLng.toFixed(2),"°"]})]}),x.jsxs("button",{onClick:()=>W(ie),className:"ml-3 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-medium flex items-center gap-1 transition-colors",children:[x.jsx(I_,{className:"w-3 h-3"}),"Crear Grupo"]})]})},ae))})]}),x.jsxs("div",{children:[x.jsxs("h3",{className:"text-sm font-semibold text-slate-400 mb-3",children:["GRUPOS CREADOS (",s.length,")"]}),s.length===0?x.jsxs("div",{className:"bg-slate-800/30 rounded-lg p-8 text-center",children:[x.jsx(vs,{className:"w-12 h-12 mx-auto mb-3 text-slate-600"}),x.jsx("p",{className:"text-sm text-slate-400",children:"No hay grupos creados"}),x.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Acepta una sugerencia o crea uno manualmente"})]}):x.jsx("div",{className:"space-y-2",children:s.map(ie=>x.jsx("div",{className:"bg-slate-800 rounded-lg p-3 border border-slate-700",children:x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{className:"flex-1",children:[x.jsx("h4",{className:"text-sm font-semibold text-white",children:ie.name}),x.jsx("p",{className:"text-xs text-slate-400",children:ie.description}),x.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:[ie.count," miembros"]})]}),x.jsx("div",{className:"flex items-center gap-2",children:x.jsx("button",{className:"p-2 hover:bg-slate-700 rounded text-slate-400 hover:text-white",children:"Ver Detalles"})})]})},ie.id))})]}),C.length===0&&s.length===0&&x.jsx("div",{className:"bg-yellow-900/20 border border-yellow-900/50 rounded-lg p-4",children:x.jsxs("div",{className:"flex items-start gap-3",children:[x.jsx(z_,{className:"w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"}),x.jsxs("div",{className:"text-sm text-yellow-200",children:[x.jsx("p",{className:"font-semibold mb-1",children:"No hay sugerencias automáticas"}),x.jsx("p",{className:"text-xs text-yellow-300/80",children:'Las sugerencias aparecen cuando hay 3+ entidades del mismo tipo y clase cerca (radio ~55km). Por ejemplo: 10x F-35B en Roosevelt Roads se sugieren como "F-35B Squadron".'})]})]})})]}),x.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800/50 flex justify-between",children:[x.jsxs("button",{onClick:()=>$(!0),className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2",children:[x.jsx(lh,{className:"w-4 h-4"}),"Crear Grupo Manual"]}),x.jsx("button",{onClick:r,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors",children:"Cerrar"})]})]}),Z&&x.jsx(pV,{onClose:()=>$(!1),onCreateGroup:ee,entities:S})]})}const gV=[{code:"ARG",name:"Argentina",region:"Sudamérica"},{code:"BHS",name:"Bahamas",region:"Caribe"},{code:"BRB",name:"Barbados",region:"Caribe"},{code:"BLZ",name:"Belice",region:"Centroamérica"},{code:"BOL",name:"Bolivia",region:"Sudamérica"},{code:"BRA",name:"Brasil",region:"Sudamérica"},{code:"CAN",name:"Canadá",region:"Norteamérica"},{code:"CHL",name:"Chile",region:"Sudamérica"},{code:"COL",name:"Colombia",region:"Sudamérica"},{code:"CRI",name:"Costa Rica",region:"Centroamérica"},{code:"CUB",name:"Cuba",region:"Caribe"},{code:"DOM",name:"República Dominicana",region:"Caribe"},{code:"ECU",name:"Ecuador",region:"Sudamérica"},{code:"SLV",name:"El Salvador",region:"Centroamérica"},{code:"GRD",name:"Granada",region:"Caribe"},{code:"GTM",name:"Guatemala",region:"Centroamérica"},{code:"GUY",name:"Guyana",region:"Sudamérica"},{code:"HTI",name:"Haití",region:"Caribe"},{code:"HND",name:"Honduras",region:"Centroamérica"},{code:"JAM",name:"Jamaica",region:"Caribe"},{code:"MEX",name:"México",region:"Norteamérica"},{code:"NIC",name:"Nicaragua",region:"Centroamérica"},{code:"PAN",name:"Panamá",region:"Centroamérica"},{code:"PRY",name:"Paraguay",region:"Sudamérica"},{code:"PER",name:"Perú",region:"Sudamérica"},{code:"SUR",name:"Suriname",region:"Sudamérica"},{code:"TTO",name:"Trinidad y Tobago",region:"Caribe"},{code:"USA",name:"Estados Unidos",region:"Norteamérica"},{code:"URY",name:"Uruguay",region:"Sudamérica"},{code:"VEN",name:"Venezuela",region:"Sudamérica"},{code:"ABW",name:"Aruba",region:"Caribe"},{code:"CUW",name:"Curaçao",region:"Caribe"},{code:"ALB",name:"Albania",region:"Europa"},{code:"AND",name:"Andorra",region:"Europa"},{code:"AUT",name:"Austria",region:"Europa"},{code:"BEL",name:"Bélgica",region:"Europa"},{code:"BGR",name:"Bulgaria",region:"Europa"},{code:"HRV",name:"Croacia",region:"Europa"},{code:"CYP",name:"Chipre",region:"Europa"},{code:"CZE",name:"República Checa",region:"Europa"},{code:"DNK",name:"Dinamarca",region:"Europa"},{code:"EST",name:"Estonia",region:"Europa"},{code:"FIN",name:"Finlandia",region:"Europa"},{code:"FRA",name:"Francia",region:"Europa"},{code:"DEU",name:"Alemania",region:"Europa"},{code:"GRC",name:"Grecia",region:"Europa"},{code:"HUN",name:"Hungría",region:"Europa"},{code:"ISL",name:"Islandia",region:"Europa"},{code:"IRL",name:"Irlanda",region:"Europa"},{code:"ITA",name:"Italia",region:"Europa"},{code:"LVA",name:"Letonia",region:"Europa"},{code:"LTU",name:"Lituania",region:"Europa"},{code:"LUX",name:"Luxemburgo",region:"Europa"},{code:"MLT",name:"Malta",region:"Europa"},{code:"NLD",name:"Países Bajos",region:"Europa"},{code:"NOR",name:"Noruega",region:"Europa"},{code:"POL",name:"Polonia",region:"Europa"},{code:"PRT",name:"Portugal",region:"Europa"},{code:"ROU",name:"Rumanía",region:"Europa"},{code:"RUS",name:"Rusia",region:"Europa/Asia"},{code:"SVK",name:"Eslovaquia",region:"Europa"},{code:"SVN",name:"Eslovenia",region:"Europa"},{code:"ESP",name:"España",region:"Europa"},{code:"SWE",name:"Suecia",region:"Europa"},{code:"CHE",name:"Suiza",region:"Europa"},{code:"UKR",name:"Ucrania",region:"Europa"},{code:"GBR",name:"Reino Unido",region:"Europa"},{code:"CHN",name:"China",region:"Asia"},{code:"JPN",name:"Japón",region:"Asia"},{code:"KOR",name:"Corea del Sur",region:"Asia"},{code:"PRK",name:"Corea del Norte",region:"Asia"},{code:"IND",name:"India",region:"Asia"},{code:"IDN",name:"Indonesia",region:"Asia"},{code:"IRN",name:"Irán",region:"Asia"},{code:"IRQ",name:"Irak",region:"Asia"},{code:"ISR",name:"Israel",region:"Asia"},{code:"SAU",name:"Arabia Saudita",region:"Asia"},{code:"TUR",name:"Turquía",region:"Asia/Europa"},{code:"ARE",name:"Emiratos Árabes Unidos",region:"Asia"},{code:"VNM",name:"Vietnam",region:"Asia"},{code:"THA",name:"Tailandia",region:"Asia"},{code:"MYS",name:"Malasia",region:"Asia"},{code:"SGP",name:"Singapur",region:"Asia"},{code:"PHL",name:"Filipinas",region:"Asia"},{code:"PAK",name:"Pakistán",region:"Asia"},{code:"DZA",name:"Argelia",region:"África"},{code:"EGY",name:"Egipto",region:"África"},{code:"ZAF",name:"Sudáfrica",region:"África"},{code:"NGA",name:"Nigeria",region:"África"},{code:"KEN",name:"Kenia",region:"África"},{code:"MAR",name:"Marruecos",region:"África"},{code:"TUN",name:"Túnez",region:"África"},{code:"LBY",name:"Libia",region:"África"},{code:"AUS",name:"Australia",region:"Oceanía"},{code:"NZL",name:"Nueva Zelanda",region:"Oceanía"},{code:"FJI",name:"Fiyi",region:"Oceanía"}];function _V(r,s=10){if(!r||r.length<2)return[];const c=r.toLowerCase();return gV.filter(m=>m.name.toLowerCase().includes(c)||m.code.toLowerCase().includes(c)).slice(0,s)}function yV({onClose:r}){const{settings:s,loading:c,addCountry:m,toggleVisibility:v,updateColor:S,removeCountry:C,refetch:o}=sR(),[L,F]=Ne.useState(""),[Z,$]=Ne.useState(""),[W,ee]=Ne.useState(!1),[ie,ae]=Ne.useState("#3b82f6"),ke=_V(Z,8),le=s.filter(je=>je.country_name.toLowerCase().includes(L.toLowerCase())||je.country_code.toLowerCase().includes(L.toLowerCase()));console.log("🔍 Search filter:",{searchTerm:L,totalSettings:s.length,filtered:le.length,settings:s,filteredSettings:le});const se=je=>{J(je)},J=async je=>{console.log("➕ Adding country:",je);const Xe=await m(je.code,je.name,ie);console.log("✅ Add result:",Xe),Xe.success?(await o(),console.log("🔄 Settings refreshed"),$(""),ee(!1),ae("#3b82f6")):alert(`Error: ${Xe.error}`)},Ee=s.filter(je=>je.is_visible).length;return x.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in",children:x.jsxs("div",{className:"relative w-full max-w-5xl max-h-[90vh] bg-slate-900 border border-slate-700 rounded-lg shadow-xl flex flex-col",children:[x.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx(kN,{className:"w-6 h-6 text-cyan-400"}),x.jsxs("div",{children:[x.jsx("h2",{className:"text-lg font-bold text-white",children:"Límites Marítimos - Gestor Dinámico"}),x.jsxs("p",{className:"text-xs text-slate-400",children:[Ee," de ",s.length," países visibles"]})]})]}),x.jsx("button",{onClick:r,className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsxs("div",{className:"p-4 border-b border-slate-700 space-y-3",children:[x.jsxs("div",{className:"relative",children:[x.jsx(Pp,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"}),x.jsx("input",{type:"text",placeholder:"Buscar por nombre o código ISO3...",value:L,onChange:je=>F(je.target.value),className:"w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500"})]}),x.jsxs("div",{className:"bg-slate-800/50 border border-cyan-900/30 rounded-lg p-3",children:[x.jsx("div",{className:"text-xs text-cyan-400 font-semibold mb-2 uppercase tracking-wide",children:"➕ Buscar y Agregar País"}),x.jsxs("div",{className:"flex gap-2 items-end",children:[x.jsxs("div",{className:"flex-1 relative",children:[x.jsx("label",{className:"text-xs text-slate-400 mb-1 block",children:"Buscar país (ej: Canadá, Francia, China)"}),x.jsxs("div",{className:"relative",children:[x.jsx(Pp,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"}),x.jsx("input",{type:"text",placeholder:"Escribe para buscar...",value:Z,onChange:je=>{$(je.target.value),ee(je.target.value.length>=2)},onFocus:()=>Z.length>=2&&ee(!0),className:"w-full pl-10 pr-4 py-2 bg-slate-700 border-2 border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500"})]}),W&&ke.length>0&&x.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-cyan-500 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto",children:ke.map(je=>{const Xe=s.some(tt=>tt.country_code===je.code);return x.jsx("button",{onClick:()=>!Xe&&se(je),disabled:Xe,className:`w-full px-4 py-3 text-left transition-colors border-b border-slate-700 last:border-0 ${Xe?"bg-slate-700/50 cursor-not-allowed opacity-50":"hover:bg-cyan-900/30 cursor-pointer"}`,children:x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{children:[x.jsx("div",{className:"text-white font-medium",children:je.name}),x.jsxs("div",{className:"text-xs text-slate-400",children:[je.code," · ",je.region]})]}),Xe?x.jsxs("span",{className:"text-xs text-green-400 flex items-center gap-1",children:[x.jsx(I_,{className:"w-3 h-3"})," Ya agregado"]}):x.jsx("span",{className:"text-xs text-cyan-400",children:"Click para agregar"})]})},je.code)})})]}),x.jsxs("div",{className:"flex flex-col gap-1",children:[x.jsx("label",{className:"text-xs text-slate-400",children:"Color"}),x.jsxs("div",{className:"flex gap-2",children:[x.jsx("div",{className:"w-10 h-10 rounded border-2 border-white/20",style:{backgroundColor:ie}}),x.jsx("input",{type:"color",value:ie,onChange:je=>ae(je.target.value),className:"w-10 h-10 rounded cursor-pointer",title:"Seleccionar color"})]})]})]}),Z.length>0&&ke.length===0&&x.jsx("div",{className:"mt-2 text-xs text-slate-500 italic",children:"No se encontraron países. Intenta con otro nombre."})]})]}),x.jsx("div",{className:"flex-1 overflow-y-auto p-4 custom-scrollbar",children:c?x.jsx("div",{className:"text-center text-slate-400 py-8",children:"Cargando países..."}):le.length===0?x.jsx("div",{className:"text-center text-slate-400 py-8",children:L?"No se encontraron países":"No hay países configurados"}):x.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:le.map(je=>x.jsxs("div",{className:`p-4 rounded-lg border-2 transition-all ${je.is_visible?"bg-slate-800/50 border-cyan-500/50":"bg-slate-800/30 border-slate-700 opacity-60"}`,children:[x.jsxs("div",{className:"flex items-start justify-between mb-3",children:[x.jsxs("div",{className:"flex-1",children:[x.jsx("h3",{className:"text-white font-semibold",children:je.country_name}),x.jsx("p",{className:"text-xs text-slate-400",children:je.country_code})]}),x.jsxs("div",{className:"flex gap-1",children:[x.jsx("button",{onClick:()=>v(je.country_code),className:`p-1.5 rounded transition-colors ${je.is_visible?"bg-cyan-600 hover:bg-cyan-700 text-white":"bg-slate-700 hover:bg-slate-600 text-slate-400"}`,title:je.is_visible?"Ocultar":"Mostrar",children:je.is_visible?x.jsx(kl,{className:"w-4 h-4"}):x.jsx(F_,{className:"w-4 h-4"})}),x.jsx("button",{onClick:()=>{confirm(`¿Eliminar ${je.country_name}?`)&&C(je.country_code)},className:"p-1.5 rounded bg-red-900/30 hover:bg-red-900/50 text-red-400 transition-colors",title:"Eliminar",children:x.jsx(Sc,{className:"w-4 h-4"})})]})]}),x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsx("div",{className:"w-full h-8 rounded border-2 border-white/20",style:{backgroundColor:je.color}}),x.jsx("input",{type:"color",value:je.color,onChange:Xe=>S(je.country_code,Xe.target.value),className:"w-12 h-8 rounded cursor-pointer",title:"Cambiar color"})]})]},je.country_code))})}),x.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800/50 flex justify-between items-center",children:[x.jsxs("div",{className:"text-sm text-slate-400",children:["ℹ️ Los límites se cargan desde ",x.jsx("a",{href:"https://marineregions.org",target:"_blank",rel:"noopener noreferrer",className:"text-cyan-400 hover:underline",children:"Marine Regions"})]}),x.jsx("button",{onClick:r,className:"px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium transition-colors",children:"Cerrar"})]})]})})}function xV({onClose:r,onOpenMaritimeConfig:s}){const{showBoundaries:c,toggleBoundaries:m}=aR(),v=[{id:"toggle-maritime",title:c?"Ocultar Límites Marítimos":"Mostrar Límites Marítimos",description:c?"Ocultar EEZ de 200 NM":"Ver EEZ y aguas territoriales",icon:kN,color:c?"bg-cyan-900/30":"bg-slate-800/30",hoverColor:c?"hover:bg-cyan-900/50":"hover:bg-slate-700",textColor:c?"text-cyan-400":"text-slate-400"},{id:"configure-maritime",title:"Gestor de Países",description:"Buscar, agregar y personalizar límites",icon:YF,color:"bg-purple-900/30",hoverColor:"hover:bg-purple-900/50",textColor:"text-purple-400"},{id:"custom-zones",title:"Zonas Personalizadas",description:"Crear zonas de interés (Próximamente)",icon:ju,color:"bg-slate-800/30",hoverColor:"hover:bg-slate-700",textColor:"text-slate-400",disabled:!0}],S=C=>{switch(C){case"toggle-maritime":m();break;case"configure-maritime":s(),r();break}};return x.jsx("div",{className:"flex gap-3 overflow-x-auto pb-2 custom-scrollbar",style:{maxWidth:"100%"},children:v.map(C=>{const o=C.icon,L=C.disabled;return x.jsxs("button",{onClick:()=>!L&&S(C.id),disabled:L,className:`flex-shrink-0 flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-all ${L?"opacity-40 cursor-not-allowed bg-slate-800/30":`${C.color} ${C.hoverColor} cursor-pointer`}`,style:{width:"200px",height:"140px"},children:[x.jsx("div",{className:`w-16 h-16 ${L?"bg-slate-700":"bg-slate-700/80"} rounded-lg flex items-center justify-center`,children:x.jsx(o,{className:`w-8 h-8 ${C.textColor}`})}),x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:`font-medium text-sm ${C.textColor}`,children:C.title}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:C.description}),L&&x.jsx("div",{className:"text-xs text-yellow-500 mt-1",children:"Próximamente"})]})]},C.id)})})}function vV({onTogglePalette:r,paletteVisible:s,map:c,onToggleRadar:m,radarVisible:v=!1,onToggleRadarMode:S=()=>{},radarCompact:C=!0,onToggleMeasurement:o=()=>{},measurementVisible:L=!1,onToggleIntelligence:F=()=>{},intelligenceVisible:Z=!1}){const[$,W]=Ne.useState(null),[ee,ie]=Ne.useState(()=>localStorage.getItem("selectedMapStyle")||"satellite-streets"),[ae,ke]=Ne.useState(null),[le,se]=Ne.useState(!1),[J,Ee]=Ne.useState(!1),[je,Xe]=Ne.useState(!1),{hiddenCount:tt}=HU();WU();const it=uR();Ne.useEffect(()=>{const Nt=()=>{Xe(!0)};return window.addEventListener("openMaritimePanel",Nt),()=>window.removeEventListener("openMaritimePanel",Nt)},[]);const We=Nt=>{W($===Nt?null:Nt)},Ct=(Nt,Wt)=>{c&&(c.setStyle(Wt),ie(Nt),localStorage.setItem("selectedMapStyle",Nt))};return x.jsxs(x.Fragment,{children:[x.jsxs("div",{className:"fixed top-0 left-0 right-0 h-14 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-slate-700 flex items-center px-2 sm:px-4 gap-1 sm:gap-2 shadow-2xl z-50 overflow-x-auto custom-scrollbar-horizontal",children:[x.jsx("div",{className:"flex items-center gap-1 sm:gap-2 pr-2 sm:pr-4 border-r border-slate-700 flex-shrink-0",children:x.jsx("span",{className:"text-white font-bold text-sm sm:text-base",children:"SAE - MONITOR"})}),x.jsx("div",{className:"h-8 w-px bg-slate-700 hidden md:block"}),x.jsx(Ud,{icon:x.jsx(TN,{className:"w-5 h-5"}),label:"Plantillas",active:s,onClick:r,tooltip:"Paleta de Plantillas"}),x.jsx(Ud,{icon:x.jsx(IN,{className:"w-5 h-5"}),label:"Mapas",active:$==="maps",onClick:()=>We("maps"),tooltip:"Estilos de Mapa",hasSubmenu:!0}),x.jsx(Ud,{icon:x.jsx(kl,{className:"w-5 h-5"}),label:"Ver",active:$==="view",onClick:()=>We("view"),tooltip:"Gestión de Visibilidad",hasSubmenu:!0,badge:tt>0?tt:null}),x.jsx(Ud,{icon:x.jsx(ju,{className:"w-5 h-5"}),label:"Zonas",active:$==="zones",onClick:()=>We("zones"),tooltip:"Zonas de Interés"}),x.jsx(Ud,{icon:x.jsx(PN,{className:"w-5 h-5"}),label:"Intel",active:Z,onClick:F,tooltip:"Intelligence Feed (Grok AI)",badge:it>0?it:null}),x.jsx(Ud,{icon:x.jsx(vs,{className:"w-5 h-5"}),label:"Grupos",active:J,onClick:()=>Ee(!0),tooltip:"Gestión de Grupos"}),x.jsx("div",{className:"flex-1"}),x.jsx(Ud,{icon:x.jsx(B_,{className:"w-5 h-5"}),label:"Config",active:le,onClick:()=>se(!0),tooltip:"Configuración"})]}),$&&x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"fixed inset-0 bg-black/20",style:{top:"56px",zIndex:45},onClick:()=>W(null)}),x.jsx("div",{className:"fixed left-0 right-0 bg-slate-800/98 backdrop-blur-md border-b border-slate-700 shadow-2xl animate-in slide-in-from-top duration-200",style:{top:"56px",maxHeight:"500px",zIndex:46},children:x.jsxs("div",{className:"p-4",children:[x.jsxs("div",{className:"flex items-center justify-between mb-3",children:[x.jsx("h3",{className:"text-white font-semibold",children:wV($)}),x.jsx("button",{onClick:()=>W(null),className:"text-slate-400 hover:text-white transition-colors",children:"✕"})]}),x.jsx("div",{children:$==="maps"?x.jsx(TV,{currentStyle:ee,onStyleChange:Ct}):$==="view"?x.jsx(bV,{onClose:()=>W(null),onShowHidden:()=>ke("hidden"),onShowArchived:()=>ke("archived"),onToggleRadar:m,radarVisible:v,onToggleRadarMode:S,radarCompact:C,onToggleMeasurement:o,measurementVisible:L}):$==="zones"?x.jsx(xV,{onClose:()=>W(null),onOpenMaritimeConfig:()=>Xe(!0)}):x.jsx("div",{className:"text-slate-300 text-sm",children:SV($)})})]})})]}),ae&&x.jsx(dV,{type:ae,onClose:()=>ke(null)}),le&&x.jsx(fV,{onClose:()=>se(!1)}),J&&x.jsx(mV,{onClose:()=>Ee(!1)}),je&&x.jsx(yV,{onClose:()=>Xe(!1)})]})}function Ud({icon:r,label:s,active:c,onClick:m,tooltip:v,hasSubmenu:S,badge:C}){return x.jsxs("button",{onClick:m,title:v,className:`
        flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-lg transition-all relative flex-shrink-0
        ${c?"bg-blue-600 text-white shadow-lg shadow-blue-500/30":"text-slate-300 hover:bg-slate-700/50 hover:text-white"}
      `,children:[r,x.jsx("span",{className:"text-xs font-medium hidden sm:inline",children:s}),S&&x.jsx(Ap,{size:14,className:`transition-transform ${c?"rotate-180":""} hidden sm:inline`}),C&&x.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold",children:C>99?"99+":C})]})}function bV({onClose:r,onShowHidden:s,onShowArchived:c,onToggleRadar:m,radarVisible:v=!1,onToggleRadarMode:S=()=>{},radarCompact:C=!0,onToggleMeasurement:o=()=>{},measurementVisible:L=!1}){const{getSelectedCount:F,getSelectedIds:Z,clearSelection:$}=Ev(),{toggleVisibility:W,archiveEntity:ee,deleteEntity:ie}=Nv(),{isLocked:ae,toggleLock:ke}=US(),le=F(),se=Z(),J=async je=>{if((je==="hide"||je==="archive"||je==="delete")&&le===0){console.log("Selecciona al menos una entidad primero (Ctrl+Click en el mapa)");return}if(je==="show-hidden"){s(),r();return}if(je==="show-archived"){c(),r();return}if(je==="toggle-lock"){ke();return}if(je==="toggle-radar"){m();return}if(je==="toggle-radar-mode"){S();return}if(je==="toggle-measurement"){o();return}let Xe=null;switch(je){case"hide":Xe=tt=>W(tt,!0);break;case"archive":Xe=ee;break;case"delete":Xe=ie;break;default:return}for(const tt of se)await Xe(tt),window.removeEntityDirectly&&window.removeEntityDirectly(tt);$(),r()},Ee=[{id:"toggle-measurement",title:L?"Ocultar Medición":"Herramientas de Medición",description:L?"Cerrar herramientas":"Medir distancias, áreas y círculos",icon:v2,color:L?"bg-cyan-900/30":"bg-slate-700",hoverColor:L?"hover:bg-cyan-900/50":"hover:bg-slate-600",textColor:L?"text-cyan-400":"text-slate-300",requiresSelection:!1},{id:"toggle-radar",title:v?"Ocultar Radar":"Mostrar Radar",description:v?"Desactivar sistema de radar":"Radar de detección en tiempo real",icon:Jx,color:v?"bg-green-900/30":"bg-slate-700",hoverColor:v?"hover:bg-green-900/50":"hover:bg-slate-600",textColor:v?"text-green-400":"text-slate-300",requiresSelection:!1},{id:"toggle-radar-mode",title:C?"Radar Completo":"Radar Compacto",description:C?"Expandir panel de control":"Minimizar radar (recomendado)",icon:Kx,color:C?"bg-cyan-900/30":"bg-blue-900/30",hoverColor:C?"hover:bg-cyan-900/50":"hover:bg-blue-900/50",textColor:C?"text-cyan-400":"text-blue-400",requiresSelection:!1},{id:"toggle-lock",title:ae?"Desbloquear Movimiento":"Bloquear Movimiento",description:ae?"Permitir mover entidades":"Evitar movimientos accidentales",icon:ae?EN:LF,color:ae?"bg-orange-900/30":"bg-green-900/30",hoverColor:ae?"hover:bg-orange-900/50":"hover:bg-green-900/50",textColor:ae?"text-orange-400":"text-green-400",requiresSelection:!1},{id:"hide",title:"Ocultar Seleccionadas",description:"Oculta las entidades del mapa sin eliminarlas",icon:F_,color:"bg-slate-700",hoverColor:"hover:bg-slate-600",requiresSelection:!0},{id:"show-hidden",title:"Ver Entidades Ocultas",description:"Muestra panel con entidades ocultas",icon:kl,color:"bg-blue-900/30",hoverColor:"hover:bg-blue-900/50",requiresSelection:!1},{id:"archive",title:"Archivar Seleccionadas",description:"Archiva entidades (se pueden restaurar)",icon:E_,color:"bg-yellow-900/30",hoverColor:"hover:bg-yellow-900/50",textColor:"text-yellow-400",requiresSelection:!0},{id:"show-archived",title:"Ver Archivadas",description:"Panel de entidades archivadas",icon:eF,color:"bg-yellow-900/30",hoverColor:"hover:bg-yellow-900/50",textColor:"text-yellow-400",requiresSelection:!1},{id:"delete",title:"Eliminar Permanentemente",description:"⚠️ No se puede deshacer",icon:Sc,color:"bg-red-900/30",hoverColor:"hover:bg-red-900/50",textColor:"text-red-400",requiresSelection:!0}];return x.jsx("div",{className:"flex gap-3 overflow-x-auto pb-2 custom-scrollbar",style:{maxWidth:"100%"},children:Ee.map(je=>{const Xe=je.icon,tt=je.requiresSelection&&le===0;return x.jsxs("button",{onClick:()=>J(je.id),disabled:tt,className:`flex-shrink-0 flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-all ${tt?"opacity-40 cursor-not-allowed bg-slate-800/30":`${je.color} ${je.hoverColor} cursor-pointer`}`,style:{width:"200px",height:"140px"},children:[x.jsx("div",{className:`w-16 h-16 ${tt?"bg-slate-700":"bg-slate-700/80"} rounded-lg flex items-center justify-center`,children:x.jsx(Xe,{className:`w-8 h-8 ${je.textColor||"text-white"}`})}),x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:`font-medium text-sm ${je.textColor||"text-white"}`,children:je.title}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:je.description}),tt&&x.jsx("div",{className:"text-xs text-yellow-500 mt-1",children:"Selecciona entidades primero"})]})]},je.id)})})}function wV(r){return{maps:"🗺️ Estilos de Mapa",view:"👁️ Gestión de Visibilidad",types:"🚢 Filtrar por Tipo",zones:"📍 Zonas de Interés",search:"🔍 Búsqueda Avanzada",filters:"🎛️ Filtros y Capas",settings:"⚙️ Configuración"}[r]||"Panel"}function SV(r){return{types:"Filtrar por: Destructores, Fragatas, Aviones, etc.",zones:"Gestión de zonas de interés",search:"Búsqueda avanzada de entidades",filters:"Activar/desactivar capas del mapa",settings:"Configuración general de la aplicación"}[r]||"Contenido del panel"}function TV({currentStyle:r,onStyleChange:s}){const c=[{id:"satellite-streets",name:"Satélite + Calles",icon:lP,style:oo.SATELLITE_STREETS,description:"Vista satélite con información de calles",color:"bg-blue-500"},{id:"dark",name:"Oscuro",icon:qF,style:oo.DARK,description:"Estilo oscuro profesional",color:"bg-slate-700"},{id:"navigation-night",name:"Navegación Nocturna",icon:zS,style:oo.NAVIGATION_NIGHT,description:"Optimizado para navegación nocturna",color:"bg-indigo-600"},{id:"satellite",name:"Satélite Puro",icon:lP,style:oo.SATELLITE,description:"Vista satélite sin overlays",color:"bg-green-600"},{id:"streets",name:"Calles",icon:IN,style:oo.STREETS,description:"Mapa de calles estándar",color:"bg-gray-500"},{id:"outdoors",name:"Terreno",icon:WF,style:oo.OUTDOORS,description:"Vista topográfica con relieve",color:"bg-amber-600"}];return x.jsx("div",{className:"flex gap-3 overflow-x-auto pb-2 custom-scrollbar",style:{maxWidth:"100%"},children:c.map(m=>{const v=m.icon,S=r===m.id;return x.jsxs("button",{onClick:()=>s(m.id,m.style),className:`flex-shrink-0 flex flex-col items-center justify-center gap-2 p-4 rounded-lg transition-all ${S?"bg-blue-600 text-white shadow-lg shadow-blue-500/30":"bg-slate-700/50 hover:bg-slate-700 text-slate-200"}`,style:{width:"200px",height:"140px"},children:[x.jsx("div",{className:`w-16 h-16 ${S?"bg-white/20":m.color} rounded-lg flex items-center justify-center`,children:x.jsx(v,{className:"w-8 h-8 text-white"})}),x.jsxs("div",{className:"text-center",children:[x.jsxs("div",{className:"font-medium text-sm flex items-center gap-2",children:[m.name,S&&x.jsx(I_,{size:14,className:"text-white"})]}),x.jsx("div",{className:`text-xs mt-0.5 ${S?"text-blue-100":"text-slate-400"}`,children:m.description})]})]},m.id)})})}function EV({map:r,onDetection:s,compact:c=!1}){const{entities:m,loading:v}=Mv(),[S,C]=Ne.useState(0),[o,L]=Ne.useState([]),[F,Z]=Ne.useState(2),[$,W]=Ne.useState(!0),[ee,ie]=Ne.useState("sweep"),[ae,ke]=Ne.useState({lat:18.4,lng:-66.1}),[le,se]=Ne.useState(300),[J,Ee]=Ne.useState([]),[je,Xe]=Ne.useState(!c);Ne.useEffect(()=>{if(!r)return;const Ct=()=>{const Nt=r.getCenter(),Wt=r.getZoom(),fr=CV(Wt,Nt.lat);ke({lat:Nt.lat,lng:Nt.lng}),se(fr);const dr=r.getBounds(),cr=m.filter(Ut=>Ut.is_visible?dr.contains([Ut.longitude,Ut.latitude]):!1);Ee(cr)};return Ct(),r.on("zoom",Ct),r.on("move",Ct),()=>{r.off("zoom",Ct),r.off("move",Ct)}},[r,m]),Ne.useEffect(()=>{if(!$)return;const Ct=setInterval(()=>{C(Nt=>(Nt+F)%360)},33);return()=>clearInterval(Ct)},[$,F]),Ne.useEffect(()=>{if(!J||J.length===0||!$)return;const Ct=15,Nt=J.filter(Wt=>{const fr=R2(ae,{lat:Wt.latitude,lng:Wt.longitude});return Math.abs((fr-S+180)%360-180)<Ct});L(Nt),Nt.length>0&&s&&s(Nt)},[S,J,ae,$,s]);const tt=(m==null?void 0:m.filter(Ct=>Ct.is_visible).length)||0;if(v)return x.jsx("div",{className:"fixed bottom-8 left-8 w-80 h-80 bg-slate-900/80 rounded-full border-2 border-green-500/30 flex items-center justify-center backdrop-blur-sm",children:x.jsx("div",{className:"text-green-400 text-sm",children:"Iniciando radar..."})});const it=c?"w-48 h-48":"w-80 h-80",We=c?"bottom-4 left-4":"bottom-8 left-8";return x.jsxs("div",{className:`fixed ${We} pointer-events-auto z-30`,children:[x.jsx("div",{className:`relative ${it} select-none`,children:x.jsxs("div",{className:"relative w-full h-full rounded-full bg-slate-900/90 border-2 border-green-500 backdrop-blur-md overflow-hidden shadow-2xl shadow-green-500/20",children:[x.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-green-500/30"}),x.jsx("div",{className:"absolute inset-[16.66%] rounded-full border border-green-500/20"}),x.jsx("div",{className:"absolute inset-[33.33%] rounded-full border border-green-500/20"}),x.jsx("div",{className:"absolute inset-[50%] rounded-full border border-green-500/20"}),x.jsx("div",{className:"absolute inset-[66.66%] rounded-full border border-green-500/20"}),x.jsx("div",{className:"absolute top-1/2 left-0 w-full h-[1px] bg-green-500/20"}),x.jsx("div",{className:"absolute top-0 left-1/2 w-[1px] h-full bg-green-500/20"}),x.jsxs("div",{className:"absolute inset-0",style:{transform:"rotate(45deg)"},children:[x.jsx("div",{className:"absolute top-1/2 left-0 w-full h-[1px] bg-green-500/10"}),x.jsx("div",{className:"absolute top-0 left-1/2 w-[1px] h-full bg-green-500/10"})]}),x.jsx("div",{className:"absolute top-1 left-1/2 -translate-x-1/2 text-green-400 text-xs font-bold",children:"N"}),x.jsx("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 text-green-400 text-xs font-bold",children:"S"}),x.jsx("div",{className:"absolute top-1/2 right-1 -translate-y-1/2 text-green-400 text-xs font-bold",children:"E"}),x.jsx("div",{className:"absolute top-1/2 left-1 -translate-y-1/2 text-green-400 text-xs font-bold",children:"W"}),$&&x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"absolute top-1/2 left-1/2 w-1/2 h-[3px] origin-left transition-none",style:{transform:`rotate(${S}deg)`,background:"linear-gradient(to right, #22c55e, transparent)",boxShadow:"0 0 20px rgba(34, 197, 94, 0.8)"}}),x.jsx("div",{className:"absolute inset-0 rounded-full transition-none pointer-events-none",style:{background:`conic-gradient(
                    from ${S-60}deg,
                    transparent 0deg,
                    rgba(34, 197, 94, 0.15) 20deg,
                    rgba(34, 197, 94, 0.05) 40deg,
                    transparent 60deg
                  )`,mixBlendMode:"screen"}})]}),J.map(Ct=>{const Nt=IV(Ct,ae,le),Wt=o.find(dr=>dr.id===Ct.id),fr=dr=>{switch(dr){case"destructor":return"bg-red-500";case"fragata":return"bg-blue-500";case"avion":return"bg-yellow-500";case"tropas":return"bg-green-500";case"submarino":return"bg-purple-500";default:return"bg-cyan-500"}};return x.jsx("div",{className:`absolute transition-all duration-300 ${Wt?"w-3 h-3 animate-ping":"w-2 h-2"} rounded-full ${fr(Ct.type)}`,style:{left:`${Nt.x}%`,top:`${Nt.y}%`,transform:"translate(-50%, -50%)",boxShadow:Wt?"0 0 10px currentColor":"none",opacity:Wt?1:.6},title:Ct.name},Ct.id)}),x.jsx("div",{className:"absolute top-1/2 left-1/2 w-2 h-2 bg-green-400 rounded-full -translate-x-1/2 -translate-y-1/2 shadow-lg shadow-green-400/50"}),!$&&x.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:x.jsx("div",{className:"text-yellow-500 text-sm font-bold animate-pulse",children:"RADAR EN PAUSA"})})]})}),c&&x.jsx("button",{onClick:()=>Xe(!je),className:"absolute -top-2 -right-2 w-8 h-8 bg-green-500/20 hover:bg-green-500/40 border border-green-500 rounded-full flex items-center justify-center transition-all z-10",title:je?"Ocultar controles":"Mostrar controles",children:x.jsx(Jx,{className:"w-4 h-4 text-green-400"})}),je&&x.jsxs("div",{className:"mt-4 bg-slate-900/90 border border-green-500/40 rounded-lg backdrop-blur-md shadow-xl",children:[x.jsxs("div",{className:"p-3 border-b border-green-500/20",children:[x.jsxs("div",{className:"flex items-center justify-between mb-2",children:[x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(Jx,{className:"w-4 h-4 text-green-400"}),x.jsx("span",{className:"text-green-400 text-xs font-bold uppercase tracking-wider",children:"Control de Radar"})]}),x.jsx("button",{onClick:()=>W(!$),className:`px-3 py-1 rounded text-xs font-bold transition-colors ${$?"bg-green-500/20 text-green-400 hover:bg-green-500/30":"bg-red-500/20 text-red-400 hover:bg-red-500/30"}`,children:$?"ACTIVO":"PAUSADO"})]}),x.jsxs("div",{className:"space-y-1",children:[x.jsxs("label",{className:"text-green-400/80 text-xs flex items-center justify-between",children:[x.jsx("span",{children:"Velocidad de barrido"}),x.jsxs("span",{className:"font-mono",children:[F,"°/frame"]})]}),x.jsx("input",{type:"range",min:"1",max:"5",step:"0.5",value:F,onChange:Ct=>Z(parseFloat(Ct.target.value)),className:"w-full h-1 bg-green-500/20 rounded-lg appearance-none cursor-pointer accent-green-500"})]})]}),x.jsxs("div",{className:"p-3 space-y-2",children:[x.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-green-400/70 uppercase text-[10px]",children:"Radio Vista"}),x.jsxs("div",{className:"text-green-400 font-bold font-mono",children:[Math.floor(le)," km"]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-green-400/70 uppercase text-[10px]",children:"Barrido"}),x.jsxs("div",{className:"text-green-400 font-bold font-mono",children:[Math.floor(S),"°"]})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-green-400/70 uppercase text-[10px]",children:"En Pantalla"}),x.jsx("div",{className:"text-green-400 font-bold font-mono",children:J.length})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded p-2",children:[x.jsx("div",{className:"text-cyan-400/70 uppercase text-[10px]",children:"Total Activas"}),x.jsx("div",{className:"text-cyan-400 font-bold font-mono",children:tt})]})]}),J.length>0&&x.jsxs("div",{className:"mt-3 pt-3 border-t border-green-500/20",children:[x.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[x.jsx(Kx,{className:"w-3 h-3 text-green-400"}),x.jsx("span",{className:"text-green-400 text-xs font-bold",children:"Contactos en Pantalla"})]}),x.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto modern-scrollbar",children:J.slice(0,10).map(Ct=>{const Nt=_R(ae.lat,ae.lng,Ct.latitude,Ct.longitude),Wt=Math.floor(R2(ae,{lat:Ct.latitude,lng:Ct.longitude}));return x.jsxs("div",{className:"text-xs bg-slate-800/30 rounded px-2 py-1 flex items-center justify-between hover:bg-slate-800/50 transition-colors",children:[x.jsx("span",{className:"text-green-400/90 truncate flex-1",children:Ct.name}),x.jsxs("div",{className:"flex items-center space-x-2 text-[10px] text-green-400/60 font-mono",children:[x.jsxs("span",{children:[Math.floor(Nt)," km"]}),x.jsxs("span",{children:[Wt,"°"]})]})]},Ct.id)})})]})]})]})]})}function R2(r,s){const c=r.lat*Math.PI/180,m=s.lat*Math.PI/180,v=(s.lng-r.lng)*Math.PI/180,S=Math.sin(v)*Math.cos(m),C=Math.cos(c)*Math.sin(m)-Math.sin(c)*Math.cos(m)*Math.cos(v);return(Math.atan2(S,C)*180/Math.PI+360)%360}function IV(r,s,c){const m=_R(s.lat,s.lng,r.latitude,r.longitude),v=R2(s,{lat:r.latitude,lng:r.longitude}),S=Math.min(m/c*40,40),C=50+S*Math.sin(v*Math.PI/180),o=50-S*Math.cos(v*Math.PI/180);return{x:C,y:o}}function _R(r,s,c,m){const S=(c-r)*Math.PI/180,C=(m-s)*Math.PI/180,o=Math.sin(S/2)*Math.sin(S/2)+Math.cos(r*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(C/2)*Math.sin(C/2);return 6371*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function CV(r,s){const v=Math.cos(s*Math.PI/180),o=6371*2*Math.PI*1e3*v/(512*Math.pow(2,r))*400/2/1e3;return Math.max(10,Math.min(o,5e3))}function AV(){return x.jsxs("div",{className:"fixed top-1/2 left-1/2 pointer-events-none z-40",children:[x.jsx("div",{className:"absolute -left-[6px] -top-[6px] w-3 h-3 bg-green-500 rounded-full shadow-lg shadow-green-500/50 animate-pulse"}),x.jsx("div",{className:"absolute -left-3 -top-3 w-6 h-6 border-2 border-green-500/50 rounded-full animate-ping"}),x.jsx("div",{className:"absolute -top-[0.5px] -left-6 w-4 h-[1px] bg-green-500/70"}),x.jsx("div",{className:"absolute -top-[0.5px] left-2 w-4 h-[1px] bg-green-500/70"}),x.jsx("div",{className:"absolute -left-[0.5px] -top-6 w-[1px] h-4 bg-green-500/70"}),x.jsx("div",{className:"absolute -left-[0.5px] top-2 w-[1px] h-4 bg-green-500/70"})]})}const L2=function(r,s){const c={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},m={on(S,C,o){if(c[S]===void 0)throw new Error(`Invalid event type: ${S}`);c[S].push({selector:C,fn:o})},render(S){s.store.featureChanged(S)}},v=function(S,C){const o=c[S];let L=o.length;for(;L--;){const F=o[L];if(F.selector(C)){F.fn.call(m,C)||s.store.render(),s.ui.updateMapClasses();break}}};return r.start.call(m),{render:r.render,stop(){r.stop&&r.stop()},trash(){r.trash&&(r.trash(),s.store.render())},combineFeatures(){r.combineFeatures&&r.combineFeatures()},uncombineFeatures(){r.uncombineFeatures&&r.uncombineFeatures()},drag(S){v("drag",S)},click(S){v("click",S)},mousemove(S){v("mousemove",S)},mousedown(S){v("mousedown",S)},mouseup(S){v("mouseup",S)},mouseout(S){v("mouseout",S)},keydown(S){v("keydown",S)},keyup(S){v("keyup",S)},touchstart(S){v("touchstart",S)},touchmove(S){v("touchmove",S)},touchend(S){v("touchend",S)},tap(S){v("tap",S)}}};var WS={},Lv={};Lv.RADIUS=6378137;Lv.FLATTENING=1/298.257223563;Lv.POLAR_RADIUS=63567523142e-4;var GP=Lv;WS.geometry=yR;WS.ring=O2;function yR(r){var s=0,c;switch(r.type){case"Polygon":return qP(r.coordinates);case"MultiPolygon":for(c=0;c<r.coordinates.length;c++)s+=qP(r.coordinates[c]);return s;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(c=0;c<r.geometries.length;c++)s+=yR(r.geometries[c]);return s}}function qP(r){var s=0;if(r&&r.length>0){s+=Math.abs(O2(r[0]));for(var c=1;c<r.length;c++)s-=Math.abs(O2(r[c]))}return s}function O2(r){var s,c,m,v,S,C,o,L=0,F=r.length;if(F>2){for(o=0;o<F;o++)o===F-2?(v=F-2,S=F-1,C=0):o===F-1?(v=F-1,S=0,C=1):(v=o,S=o+1,C=o+2),s=r[v],c=r[S],m=r[C],L+=(S1(m[0])-S1(s[0]))*Math.sin(S1(c[1]));L=L*GP.RADIUS*GP.RADIUS/2}return L}function S1(r){return r*Math.PI/180}const xo={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},ha={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},Nn={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},vo={POLYGON:"polygon",LINE:"line_string",POINT:"point"},Br={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},Oi={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},co={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},q_={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},Us={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},ws={ACTIVE:"true",INACTIVE:"false"},xR=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],PV=-90,D2=-85,kV=90,j2=85,MV=-270,NV=270,vR=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:kV,LAT_MIN:PV,LAT_RENDERED_MAX:j2,LAT_RENDERED_MIN:D2,LNG_MAX:NV,LNG_MIN:MV,activeStates:ws,classes:xo,cursors:Nn,events:co,geojsonTypes:Br,interactions:xR,meta:Us,modes:Oi,sources:ha,types:vo,updateActions:q_},Symbol.toStringTag,{value:"Module"})),HP={Point:0,LineString:1,MultiLineString:1,Polygon:2};function RV(r,s){const c=HP[r.geometry.type]-HP[s.geometry.type];return c===0&&r.geometry.type===Br.POLYGON?r.area-s.area:c}function bR(r){return r.map(s=>(s.geometry.type===Br.POLYGON&&(s.area=WS.geometry({type:Br.FEATURE,property:{},geometry:s.geometry})),s)).sort(RV).map(s=>(delete s.area,s))}function wR(r,s=0){return[[r.point.x-s,r.point.y-s],[r.point.x+s,r.point.y+s]]}function ma(r){if(this._items={},this._nums={},this._length=r?r.length:0,!!r)for(let s=0,c=r.length;s<c;s++)this.add(r[s]),r[s]!==void 0&&(typeof r[s]=="string"?this._items[r[s]]=s:this._nums[r[s]]=s)}ma.prototype.add=function(r){return this.has(r)?this:(this._length++,typeof r=="string"?this._items[r]=this._length:this._nums[r]=this._length,this)};ma.prototype.delete=function(r){return this.has(r)===!1?this:(this._length--,delete this._items[r],delete this._nums[r],this)};ma.prototype.has=function(r){return typeof r!="string"&&typeof r!="number"?!1:this._items[r]!==void 0||this._nums[r]!==void 0};ma.prototype.values=function(){const r=[];return Object.keys(this._items).forEach(s=>{r.push({k:s,v:this._items[s]})}),Object.keys(this._nums).forEach(s=>{r.push({k:JSON.parse(s),v:this._nums[s]})}),r.sort((s,c)=>s.v-c.v).map(s=>s.k)};ma.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};const LV=[Us.FEATURE,Us.MIDPOINT,Us.VERTEX],Mp={click:OV,touch:DV};function OV(r,s,c){return SR(r,s,c,c.options.clickBuffer)}function DV(r,s,c){return SR(r,s,c,c.options.touchBuffer)}function SR(r,s,c,m){if(c.map===null)return[];const v=r?wR(r,m):s,S={};c.options.styles&&(S.layers=c.options.styles.map(F=>F.id).filter(F=>c.map.getLayer(F)!=null));const C=c.map.queryRenderedFeatures(v,S).filter(F=>LV.indexOf(F.properties.meta)!==-1),o=new ma,L=[];return C.forEach(F=>{const Z=F.properties.id;o.has(Z)||(o.add(Z),L.push(F))}),bR(L)}function Ix(r,s){const c=Mp.click(r,null,s),m={mouse:Nn.NONE};return c[0]&&(m.mouse=c[0].properties.active===ws.ACTIVE?Nn.MOVE:Nn.POINTER,m.feature=c[0].properties.meta),s.events.currentModeName().indexOf("draw")!==-1&&(m.mouse=Nn.ADD),s.ui.queueMapClasses(m),s.ui.updateMapClasses(),c[0]}function ZS(r,s){const c=r.x-s.x,m=r.y-s.y;return Math.sqrt(c*c+m*m)}const jV=4,zV=12,FV=500;function z2(r,s,c={}){const m=c.fineTolerance!=null?c.fineTolerance:jV,v=c.grossTolerance!=null?c.grossTolerance:zV,S=c.interval!=null?c.interval:FV;r.point=r.point||s.point,r.time=r.time||s.time;const C=ZS(r.point,s.point);return C<m||C<v&&s.time-r.time<S}const BV=25,UV=250;function F2(r,s,c={}){const m=c.tolerance!=null?c.tolerance:BV,v=c.interval!=null?c.interval:UV;return r.point=r.point||s.point,r.time=r.time||s.time,ZS(r.point,s.point)<m&&s.time-r.time<v}let VV=(r,s=21)=>(c=s)=>{let m="",v=c|0;for(;v--;)m+=r[Math.random()*r.length|0];return m};const $V=VV("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function XS(){return $V()}const fo=function(r,s){this.ctx=r,this.properties=s.properties||{},this.coordinates=s.geometry.coordinates,this.id=s.id||XS(),this.type=s.geometry.type};fo.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};fo.prototype.incomingCoords=function(r){this.setCoordinates(r)};fo.prototype.setCoordinates=function(r){this.coordinates=r,this.changed()};fo.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};fo.prototype.setProperty=function(r,s){this.properties[r]=s};fo.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:Br.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};fo.prototype.internal=function(r){const s={id:this.id,meta:Us.FEATURE,"meta:type":this.type,active:ws.INACTIVE,mode:r};if(this.ctx.options.userProperties)for(const c in this.properties)s[`user_${c}`]=this.properties[c];return{type:Br.FEATURE,properties:s,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const Vu=function(r,s){fo.call(this,r,s)};Vu.prototype=Object.create(fo.prototype);Vu.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};Vu.prototype.updateCoordinate=function(r,s,c){arguments.length===3?this.coordinates=[s,c]:this.coordinates=[r,s],this.changed()};Vu.prototype.getCoordinate=function(){return this.getCoordinates()};const Nl=function(r,s){fo.call(this,r,s)};Nl.prototype=Object.create(fo.prototype);Nl.prototype.isValid=function(){return this.coordinates.length>1};Nl.prototype.addCoordinate=function(r,s,c){this.changed();const m=parseInt(r,10);this.coordinates.splice(m,0,[s,c])};Nl.prototype.getCoordinate=function(r){const s=parseInt(r,10);return JSON.parse(JSON.stringify(this.coordinates[s]))};Nl.prototype.removeCoordinate=function(r){this.changed(),this.coordinates.splice(parseInt(r,10),1)};Nl.prototype.updateCoordinate=function(r,s,c){const m=parseInt(r,10);this.coordinates[m]=[s,c],this.changed()};const Ko=function(r,s){fo.call(this,r,s),this.coordinates=this.coordinates.map(c=>c.slice(0,-1))};Ko.prototype=Object.create(fo.prototype);Ko.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(r=>r.length>2)};Ko.prototype.incomingCoords=function(r){this.coordinates=r.map(s=>s.slice(0,-1)),this.changed()};Ko.prototype.setCoordinates=function(r){this.coordinates=r,this.changed()};Ko.prototype.addCoordinate=function(r,s,c){this.changed();const m=r.split(".").map(S=>parseInt(S,10));this.coordinates[m[0]].splice(m[1],0,[s,c])};Ko.prototype.removeCoordinate=function(r){this.changed();const s=r.split(".").map(m=>parseInt(m,10)),c=this.coordinates[s[0]];c&&(c.splice(s[1],1),c.length<3&&this.coordinates.splice(s[0],1))};Ko.prototype.getCoordinate=function(r){const s=r.split(".").map(m=>parseInt(m,10)),c=this.coordinates[s[0]];return JSON.parse(JSON.stringify(c[s[1]]))};Ko.prototype.getCoordinates=function(){return this.coordinates.map(r=>r.concat([r[0]]))};Ko.prototype.updateCoordinate=function(r,s,c){this.changed();const m=r.split("."),v=parseInt(m[0],10),S=parseInt(m[1],10);this.coordinates[v]===void 0&&(this.coordinates[v]=[]),this.coordinates[v][S]=[s,c]};const GV={MultiPoint:Vu,MultiLineString:Nl,MultiPolygon:Ko},Ov=(r,s,c,m,v)=>{const S=c.split("."),C=parseInt(S[0],10),o=S[1]?S.slice(1).join("."):null;return r[C][s](o,m,v)},lo=function(r,s){if(fo.call(this,r,s),delete this.coordinates,this.model=GV[s.geometry.type],this.model===void 0)throw new TypeError(`${s.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(s.geometry.coordinates)};lo.prototype=Object.create(fo.prototype);lo.prototype._coordinatesToFeatures=function(r){const s=this.model.bind(this);return r.map(c=>new s(this.ctx,{id:XS(),type:Br.FEATURE,properties:{},geometry:{coordinates:c,type:this.type.replace("Multi","")}}))};lo.prototype.isValid=function(){return this.features.every(r=>r.isValid())};lo.prototype.setCoordinates=function(r){this.features=this._coordinatesToFeatures(r),this.changed()};lo.prototype.getCoordinate=function(r){return Ov(this.features,"getCoordinate",r)};lo.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(r=>r.type===Br.POLYGON?r.getCoordinates():r.coordinates)))};lo.prototype.updateCoordinate=function(r,s,c){Ov(this.features,"updateCoordinate",r,s,c),this.changed()};lo.prototype.addCoordinate=function(r,s,c){Ov(this.features,"addCoordinate",r,s,c),this.changed()};lo.prototype.removeCoordinate=function(r){Ov(this.features,"removeCoordinate",r),this.changed()};lo.prototype.getFeatures=function(){return this.features};function xi(r){this.map=r.map,this.drawConfig=JSON.parse(JSON.stringify(r.options||{})),this._ctx=r}xi.prototype.setSelected=function(r){return this._ctx.store.setSelected(r)};xi.prototype.setSelectedCoordinates=function(r){this._ctx.store.setSelectedCoordinates(r),r.reduce((s,c)=>(s[c.feature_id]===void 0&&(s[c.feature_id]=!0,this._ctx.store.get(c.feature_id).changed()),s),{})};xi.prototype.getSelected=function(){return this._ctx.store.getSelected()};xi.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()};xi.prototype.isSelected=function(r){return this._ctx.store.isSelected(r)};xi.prototype.getFeature=function(r){return this._ctx.store.get(r)};xi.prototype.select=function(r){return this._ctx.store.select(r)};xi.prototype.deselect=function(r){return this._ctx.store.deselect(r)};xi.prototype.deleteFeature=function(r,s={}){return this._ctx.store.delete(r,s)};xi.prototype.addFeature=function(r,s={}){return this._ctx.store.add(r,s)};xi.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()};xi.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()};xi.prototype.setActionableState=function(r={}){const s={trash:r.trash||!1,combineFeatures:r.combineFeatures||!1,uncombineFeatures:r.uncombineFeatures||!1};return this._ctx.events.actionable(s)};xi.prototype.changeMode=function(r,s={},c={}){return this._ctx.events.changeMode(r,s,c)};xi.prototype.fire=function(r,s){return this._ctx.events.fire(r,s)};xi.prototype.updateUIClasses=function(r){return this._ctx.ui.queueMapClasses(r)};xi.prototype.activateUIButton=function(r){return this._ctx.ui.setActiveButton(r)};xi.prototype.featuresAt=function(r,s,c="click"){if(c!=="click"&&c!=="touch")throw new Error("invalid buffer type");return Mp[c](r,s,this._ctx)};xi.prototype.newFeature=function(r){const s=r.geometry.type;return s===Br.POINT?new Vu(this._ctx,r):s===Br.LINE_STRING?new Nl(this._ctx,r):s===Br.POLYGON?new Ko(this._ctx,r):new lo(this._ctx,r)};xi.prototype.isInstanceOf=function(r,s){if(r===Br.POINT)return s instanceof Vu;if(r===Br.LINE_STRING)return s instanceof Nl;if(r===Br.POLYGON)return s instanceof Ko;if(r==="MultiFeature")return s instanceof lo;throw new Error(`Unknown feature class: ${r}`)};xi.prototype.doRender=function(r){return this._ctx.store.featureChanged(r)};xi.prototype.onSetup=function(){};xi.prototype.onDrag=function(){};xi.prototype.onClick=function(){};xi.prototype.onMouseMove=function(){};xi.prototype.onMouseDown=function(){};xi.prototype.onMouseUp=function(){};xi.prototype.onMouseOut=function(){};xi.prototype.onKeyUp=function(){};xi.prototype.onKeyDown=function(){};xi.prototype.onTouchStart=function(){};xi.prototype.onTouchMove=function(){};xi.prototype.onTouchEnd=function(){};xi.prototype.onTap=function(){};xi.prototype.onStop=function(){};xi.prototype.onTrash=function(){};xi.prototype.onCombineFeature=function(){};xi.prototype.onUncombineFeature=function(){};xi.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};const TR={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},qV=Object.keys(TR);function HV(r){const s=Object.keys(r);return function(c,m={}){let v={};const S=s.reduce((o,L)=>(o[L]=r[L],o),new xi(c));function C(o){return L=>S[o](v,L)}return{start(){v=S.onSetup(m),qV.forEach(o=>{const L=TR[o];let F=()=>!1;r[L]&&(F=()=>!0),this.on(o,F,C(L))})},stop(){S.onStop(v)},trash(){S.onTrash(v)},combineFeatures(){S.onCombineFeatures(v)},uncombineFeatures(){S.onUncombineFeatures(v)},render(o,L){S.toDisplayFeatures(v,o,L)}}}}function WV(r){const s=Object.keys(r.options.modes).reduce((W,ee)=>(W[ee]=HV(r.options.modes[ee]),W),{});let c={},m={};const v={};let S=null,C=null;v.drag=function(W,ee){ee({point:W.point,time:new Date().getTime()})?(r.ui.queueMapClasses({mouse:Nn.DRAG}),C.drag(W)):W.originalEvent.stopPropagation()},v.mousedrag=function(W){v.drag(W,ee=>!z2(c,ee))},v.touchdrag=function(W){v.drag(W,ee=>!F2(m,ee))},v.mousemove=function(W){if((W.originalEvent.buttons!==void 0?W.originalEvent.buttons:W.originalEvent.which)===1)return v.mousedrag(W);const ie=Ix(W,r);W.featureTarget=ie,C.mousemove(W)},v.mousedown=function(W){c={time:new Date().getTime(),point:W.point};const ee=Ix(W,r);W.featureTarget=ee,C.mousedown(W)},v.mouseup=function(W){const ee=Ix(W,r);W.featureTarget=ee,z2(c,{point:W.point,time:new Date().getTime()})?C.click(W):C.mouseup(W)},v.mouseout=function(W){C.mouseout(W)},v.touchstart=function(W){if(!r.options.touchEnabled)return;m={time:new Date().getTime(),point:W.point};const ee=Mp.touch(W,null,r)[0];W.featureTarget=ee,C.touchstart(W)},v.touchmove=function(W){if(r.options.touchEnabled)return C.touchmove(W),v.touchdrag(W)},v.touchend=function(W){if(W.originalEvent.preventDefault(),!r.options.touchEnabled)return;const ee=Mp.touch(W,null,r)[0];W.featureTarget=ee,F2(m,{time:new Date().getTime(),point:W.point})?C.tap(W):C.touchend(W)};const o=W=>!(W===8||W===46||W>=48&&W<=57);v.keydown=function(W){(W.srcElement||W.target).classList.contains(xo.CANVAS)&&((W.keyCode===8||W.keyCode===46)&&r.options.controls.trash?(W.preventDefault(),C.trash()):o(W.keyCode)?C.keydown(W):W.keyCode===49&&r.options.controls.point?L(Oi.DRAW_POINT):W.keyCode===50&&r.options.controls.line_string?L(Oi.DRAW_LINE_STRING):W.keyCode===51&&r.options.controls.polygon&&L(Oi.DRAW_POLYGON))},v.keyup=function(W){o(W.keyCode)&&C.keyup(W)},v.zoomend=function(){r.store.changeZoom()},v.data=function(W){if(W.dataType==="style"){const{setup:ee,map:ie,options:ae,store:ke}=r;ae.styles.some(se=>ie.getLayer(se.id))||(ee.addLayers(),ke.setDirty(),ke.render())}};function L(W,ee,ie={}){C.stop();const ae=s[W];if(ae===void 0)throw new Error(`${W} is not valid`);S=W;const ke=ae(r,ee);C=L2(ke,r),ie.silent||r.map.fire(co.MODE_CHANGE,{mode:W}),r.store.setDirty(),r.store.render()}const F={trash:!1,combineFeatures:!1,uncombineFeatures:!1};function Z(W){let ee=!1;Object.keys(W).forEach(ie=>{if(F[ie]===void 0)throw new Error("Invalid action type");F[ie]!==W[ie]&&(ee=!0),F[ie]=W[ie]}),ee&&r.map.fire(co.ACTIONABLE,{actions:F})}return{start(){S=r.options.defaultMode,C=L2(s[S](r),r)},changeMode:L,actionable:Z,currentModeName(){return S},currentModeRender(W,ee){return C.render(W,ee)},fire(W,ee){r.map&&r.map.fire(W,ee)},addEventListeners(){r.map.on("mousemove",v.mousemove),r.map.on("mousedown",v.mousedown),r.map.on("mouseup",v.mouseup),r.map.on("data",v.data),r.map.on("touchmove",v.touchmove),r.map.on("touchstart",v.touchstart),r.map.on("touchend",v.touchend),r.container.addEventListener("mouseout",v.mouseout),r.options.keybindings&&(r.container.addEventListener("keydown",v.keydown),r.container.addEventListener("keyup",v.keyup))},removeEventListeners(){r.map.off("mousemove",v.mousemove),r.map.off("mousedown",v.mousedown),r.map.off("mouseup",v.mouseup),r.map.off("data",v.data),r.map.off("touchmove",v.touchmove),r.map.off("touchstart",v.touchstart),r.map.off("touchend",v.touchend),r.container.removeEventListener("mouseout",v.mouseout),r.options.keybindings&&(r.container.removeEventListener("keydown",v.keydown),r.container.removeEventListener("keyup",v.keyup))},trash(W){C.trash(W)},combineFeatures(){C.combineFeatures()},uncombineFeatures(){C.uncombineFeatures()},getMode(){return S}}}function H_(r){return[].concat(r).filter(s=>s!==void 0)}function ZV(){const r=this;if(!(r.ctx.map&&r.ctx.map.getSource(ha.HOT)!==void 0))return L();const c=r.ctx.events.currentModeName();r.ctx.ui.queueMapClasses({mode:c});let m=[],v=[];r.isDirty?v=r.getAllIds():(m=r.getChangedIds().filter(F=>r.get(F)!==void 0),v=r.sources.hot.filter(F=>F.properties.id&&m.indexOf(F.properties.id)===-1&&r.get(F.properties.id)!==void 0).map(F=>F.properties.id)),r.sources.hot=[];const S=r.sources.cold.length;r.sources.cold=r.isDirty?[]:r.sources.cold.filter(F=>{const Z=F.properties.id||F.properties.parent;return m.indexOf(Z)===-1});const C=S!==r.sources.cold.length||v.length>0;m.forEach(F=>o(F,"hot")),v.forEach(F=>o(F,"cold"));function o(F,Z){const W=r.get(F).internal(c);r.ctx.events.currentModeRender(W,ee=>{ee.properties.mode=c,r.sources[Z].push(ee)})}C&&r.ctx.map.getSource(ha.COLD).setData({type:Br.FEATURE_COLLECTION,features:r.sources.cold}),r.ctx.map.getSource(ha.HOT).setData({type:Br.FEATURE_COLLECTION,features:r.sources.hot}),L();function L(){r.isDirty=!1,r.clearChangedIds()}}function vn(r){this._features={},this._featureIds=new ma,this._selectedFeatureIds=new ma,this._selectedCoordinates=[],this._changedFeatureIds=new ma,this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=r,this.sources={hot:[],cold:[]};let s;this.render=()=>{s||(s=requestAnimationFrame(()=>{s=null,ZV.call(this),this._emitSelectionChange&&(this.ctx.events.fire(co.SELECTION_CHANGE,{features:this.getSelected().map(c=>c.toGeoJSON()),points:this.getSelectedCoordinates().map(c=>({type:Br.FEATURE,properties:{},geometry:{type:Br.POINT,coordinates:c.coordinates}}))}),this._emitSelectionChange=!1),this.ctx.events.fire(co.RENDER,{})}))},this.isDirty=!1}vn.prototype.createRenderBatch=function(){const r=this.render;let s=0;return this.render=function(){s++},()=>{this.render=r,s>0&&this.render()}};vn.prototype.setDirty=function(){return this.isDirty=!0,this};vn.prototype.featureCreated=function(r,s={}){if(this._changedFeatureIds.add(r),(s.silent!=null?s.silent:this.ctx.options.suppressAPIEvents)!==!0){const m=this.get(r);this.ctx.events.fire(co.CREATE,{features:[m.toGeoJSON()]})}return this};vn.prototype.featureChanged=function(r,s={}){return this._changedFeatureIds.add(r),(s.silent!=null?s.silent:this.ctx.options.suppressAPIEvents)!==!0&&this.ctx.events.fire(co.UPDATE,{action:s.action?s.action:q_.CHANGE_COORDINATES,features:[this.get(r).toGeoJSON()]}),this};vn.prototype.getChangedIds=function(){return this._changedFeatureIds.values()};vn.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this};vn.prototype.getAllIds=function(){return this._featureIds.values()};vn.prototype.add=function(r,s={}){return this._features[r.id]=r,this._featureIds.add(r.id),this.featureCreated(r.id,{silent:s.silent}),this};vn.prototype.delete=function(r,s={}){const c=[];return H_(r).forEach(m=>{this._featureIds.has(m)&&(this._featureIds.delete(m),this._selectedFeatureIds.delete(m),s.silent||c.indexOf(this._features[m])===-1&&c.push(this._features[m].toGeoJSON()),delete this._features[m],this.isDirty=!0)}),c.length&&this.ctx.events.fire(co.DELETE,{features:c}),ER(this,s),this};vn.prototype.get=function(r){return this._features[r]};vn.prototype.getAll=function(){return Object.keys(this._features).map(r=>this._features[r])};vn.prototype.select=function(r,s={}){return H_(r).forEach(c=>{this._selectedFeatureIds.has(c)||(this._selectedFeatureIds.add(c),this._changedFeatureIds.add(c),s.silent||(this._emitSelectionChange=!0))}),this};vn.prototype.deselect=function(r,s={}){return H_(r).forEach(c=>{this._selectedFeatureIds.has(c)&&(this._selectedFeatureIds.delete(c),this._changedFeatureIds.add(c),s.silent||(this._emitSelectionChange=!0))}),ER(this,s),this};vn.prototype.clearSelected=function(r={}){return this.deselect(this._selectedFeatureIds.values(),{silent:r.silent}),this};vn.prototype.setSelected=function(r,s={}){return r=H_(r),this.deselect(this._selectedFeatureIds.values().filter(c=>r.indexOf(c)===-1),{silent:s.silent}),this.select(r.filter(c=>!this._selectedFeatureIds.has(c)),{silent:s.silent}),this};vn.prototype.setSelectedCoordinates=function(r){return this._selectedCoordinates=r,this._emitSelectionChange=!0,this};vn.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this};vn.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()};vn.prototype.getSelected=function(){return this.getSelectedIds().map(r=>this.get(r))};vn.prototype.getSelectedCoordinates=function(){return this._selectedCoordinates.map(s=>({coordinates:this.get(s.feature_id).getCoordinate(s.coord_path)}))};vn.prototype.isSelected=function(r){return this._selectedFeatureIds.has(r)};vn.prototype.setFeatureProperty=function(r,s,c,m={}){this.get(r).setProperty(s,c),this.featureChanged(r,{silent:m.silent,action:q_.CHANGE_PROPERTIES})};function ER(r,s={}){const c=r._selectedCoordinates.filter(m=>r._selectedFeatureIds.has(m.feature_id));r._selectedCoordinates.length!==c.length&&!s.silent&&(r._emitSelectionChange=!0),r._selectedCoordinates=c}vn.prototype.storeMapConfig=function(){xR.forEach(r=>{this.ctx.map[r]&&(this._mapInitialConfig[r]=this.ctx.map[r].isEnabled())})};vn.prototype.restoreMapConfig=function(){Object.keys(this._mapInitialConfig).forEach(r=>{this._mapInitialConfig[r]?this.ctx.map[r].enable():this.ctx.map[r].disable()})};vn.prototype.getInitialConfigValue=function(r){return this._mapInitialConfig[r]!==void 0?this._mapInitialConfig[r]:!0};const XV=["mode","feature","mouse"];function YV(r){const s={};let c=null,m={mode:null,feature:null,mouse:null},v={mode:null,feature:null,mouse:null};function S(){C({mode:null,feature:null,mouse:null}),o()}function C(ee){v=Object.assign(v,ee)}function o(){if(!r.container)return;const ee=[],ie=[];XV.forEach(ae=>{v[ae]!==m[ae]&&(ee.push(`${ae}-${m[ae]}`),v[ae]!==null&&ie.push(`${ae}-${v[ae]}`))}),ee.length>0&&r.container.classList.remove(...ee),ie.length>0&&r.container.classList.add(...ie),m=Object.assign(m,v)}function L(ee,ie={}){const ae=document.createElement("button");return ae.className=`${xo.CONTROL_BUTTON} ${ie.className}`,ae.setAttribute("title",ie.title),ie.container.appendChild(ae),ae.addEventListener("click",ke=>{if(ke.preventDefault(),ke.stopPropagation(),ke.target===c){F(),ie.onDeactivate();return}Z(ee),ie.onActivate()},!0),ae}function F(){c&&(c.classList.remove(xo.ACTIVE_BUTTON),c=null)}function Z(ee){F();const ie=s[ee];ie&&ie&&ee!=="trash"&&(ie.classList.add(xo.ACTIVE_BUTTON),c=ie)}function $(){const ee=r.options.controls,ie=document.createElement("div");return ie.className=`${xo.CONTROL_GROUP} ${xo.CONTROL_BASE}`,ee&&(ee[vo.LINE]&&(s[vo.LINE]=L(vo.LINE,{container:ie,className:xo.CONTROL_BUTTON_LINE,title:`LineString tool ${r.options.keybindings?"(l)":""}`,onActivate:()=>r.events.changeMode(Oi.DRAW_LINE_STRING),onDeactivate:()=>r.events.trash()})),ee[vo.POLYGON]&&(s[vo.POLYGON]=L(vo.POLYGON,{container:ie,className:xo.CONTROL_BUTTON_POLYGON,title:`Polygon tool ${r.options.keybindings?"(p)":""}`,onActivate:()=>r.events.changeMode(Oi.DRAW_POLYGON),onDeactivate:()=>r.events.trash()})),ee[vo.POINT]&&(s[vo.POINT]=L(vo.POINT,{container:ie,className:xo.CONTROL_BUTTON_POINT,title:`Marker tool ${r.options.keybindings?"(m)":""}`,onActivate:()=>r.events.changeMode(Oi.DRAW_POINT),onDeactivate:()=>r.events.trash()})),ee.trash&&(s.trash=L("trash",{container:ie,className:xo.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:()=>{r.events.trash()}})),ee.combine_features&&(s.combine_features=L("combineFeatures",{container:ie,className:xo.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:()=>{r.events.combineFeatures()}})),ee.uncombine_features&&(s.uncombine_features=L("uncombineFeatures",{container:ie,className:xo.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:()=>{r.events.uncombineFeatures()}}))),ie}function W(){Object.keys(s).forEach(ee=>{const ie=s[ee];ie.parentNode&&ie.parentNode.removeChild(ie),delete s[ee]})}return{setActiveButton:Z,queueMapClasses:C,updateMapClasses:o,clearMapClasses:S,addButtons:$,removeButtons:W}}function KV(r){let s=null,c=null;const m={onRemove(){return r.map.off("load",m.connect),clearInterval(c),m.removeLayers(),r.store.restoreMapConfig(),r.ui.removeButtons(),r.events.removeEventListeners(),r.ui.clearMapClasses(),r.boxZoomInitial&&r.map.boxZoom.enable(),r.map=null,r.container=null,r.store=null,s&&s.parentNode&&s.parentNode.removeChild(s),s=null,this},connect(){r.map.off("load",m.connect),clearInterval(c),m.addLayers(),r.store.storeMapConfig(),r.events.addEventListeners()},onAdd(v){if(r.map=v,r.events=WV(r),r.ui=YV(r),r.container=v.getContainer(),r.store=new vn(r),s=r.ui.addButtons(),r.options.boxSelect){r.boxZoomInitial=v.boxZoom.isEnabled(),v.boxZoom.disable();const S=v.dragPan.isEnabled();v.dragPan.disable(),v.dragPan.enable(),S||v.dragPan.disable()}return v.loaded()?m.connect():(v.on("load",m.connect),c=setInterval(()=>{v.loaded()&&m.connect()},16)),r.events.start(),s},addLayers(){r.map.addSource(ha.COLD,{data:{type:Br.FEATURE_COLLECTION,features:[]},type:"geojson"}),r.map.addSource(ha.HOT,{data:{type:Br.FEATURE_COLLECTION,features:[]},type:"geojson"}),r.options.styles.forEach(v=>{r.map.addLayer(v)}),r.store.setDirty(!0),r.store.render()},removeLayers(){r.options.styles.forEach(v=>{r.map.getLayer(v.id)&&r.map.removeLayer(v.id)}),r.map.getSource(ha.COLD)&&r.map.removeSource(ha.COLD),r.map.getSource(ha.HOT)&&r.map.removeSource(ha.HOT)}};return r.setup=m,m}const T1="#3bb2d0",$g="#fbb03b",WP="#fff",IR=[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":["case",["==",["get","active"],"true"],$g,T1],"fill-opacity":.1}},{id:"gl-draw-lines",type:"line",filter:["any",["==","$type","LineString"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["==",["get","active"],"true"],$g,T1],"line-dasharray":["case",["==",["get","active"],"true"],[.2,2],[2,0]],"line-width":2}},{id:"gl-draw-point-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":WP}},{id:"gl-draw-point-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":["case",["==",["get","active"],"true"],$g,T1]}},{id:"gl-draw-vertex-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":WP}},{id:"gl-draw-vertex-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":$g}},{id:"gl-draw-midpoint",type:"circle",filter:["all",["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":$g}}];function Dv(r){return function(s){const c=s.featureTarget;return!c||!c.properties?!1:c.properties.meta===r}}function CR(r){return!r.originalEvent||!r.originalEvent.shiftKey?!1:r.originalEvent.button===0}function hh(r){return!r.featureTarget||!r.featureTarget.properties?!1:r.featureTarget.properties.active===ws.ACTIVE&&r.featureTarget.properties.meta===Us.FEATURE}function YS(r){return!r.featureTarget||!r.featureTarget.properties?!1:r.featureTarget.properties.active===ws.INACTIVE&&r.featureTarget.properties.meta===Us.FEATURE}function jv(r){return r.featureTarget===void 0}function KS(r){return!r.featureTarget||!r.featureTarget.properties?!1:r.featureTarget.properties.meta===Us.FEATURE}function W_(r){const s=r.featureTarget;return!s||!s.properties?!1:s.properties.meta===Us.VERTEX}function av(r){return r.originalEvent?r.originalEvent.shiftKey===!0:!1}function zv(r){return r.keyCode===27}function Fv(r){return r.keyCode===13}function JV(){return!0}const QV=Object.freeze(Object.defineProperty({__proto__:null,isActiveFeature:hh,isEnterKey:Fv,isEscapeKey:zv,isFeature:KS,isInactiveFeature:YS,isOfMetaType:Dv,isShiftDown:av,isShiftMousedown:CR,isTrue:JV,isVertex:W_,noTarget:jv},Symbol.toStringTag,{value:"Module"}));function Iu(r,s){this.x=r,this.y=s}Iu.prototype={clone(){return new Iu(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,s){return this.clone()._rotateAround(r,s)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const s=r.x-this.x,c=r.y-this.y;return s*s+c*c},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,s){return Math.atan2(this.x*s-this.y*r,this.x*r+this.y*s)},_matMult(r){const s=r[0]*this.x+r[1]*this.y,c=r[2]*this.x+r[3]*this.y;return this.x=s,this.y=c,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const s=Math.cos(r),c=Math.sin(r),m=s*this.x-c*this.y,v=c*this.x+s*this.y;return this.x=m,this.y=v,this},_rotateAround(r,s){const c=Math.cos(r),m=Math.sin(r),v=s.x+c*(this.x-s.x)-m*(this.y-s.y),S=s.y+m*(this.x-s.x)+c*(this.y-s.y);return this.x=v,this.y=S,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Iu};Iu.convert=function(r){if(r instanceof Iu)return r;if(Array.isArray(r))return new Iu(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new Iu(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};function JS(r,s){const c=s.getBoundingClientRect();return new Iu(r.clientX-c.left-(s.clientLeft||0),r.clientY-c.top-(s.clientTop||0))}function Np(r,s,c,m){return{type:Br.FEATURE,properties:{meta:Us.VERTEX,parent:r,coord_path:c,active:m?ws.ACTIVE:ws.INACTIVE},geometry:{type:Br.POINT,coordinates:s}}}function AR(r,s,c){const m=s.geometry.coordinates,v=c.geometry.coordinates;if(m[1]>j2||m[1]<D2||v[1]>j2||v[1]<D2)return null;const S={lng:(m[0]+v[0])/2,lat:(m[1]+v[1])/2};return{type:Br.FEATURE,properties:{meta:Us.MIDPOINT,parent:r,lng:S.lng,lat:S.lat,coord_path:c.properties.coord_path},geometry:{type:Br.POINT,coordinates:[S.lng,S.lat]}}}function Bv(r,s={},c=null){const{type:m,coordinates:v}=r.geometry,S=r.properties&&r.properties.id;let C=[];m===Br.POINT?C.push(Np(S,v,c,L(c))):m===Br.POLYGON?v.forEach((Z,$)=>{o(Z,c!==null?`${c}.${$}`:String($))}):m===Br.LINE_STRING?o(v,c):m.indexOf(Br.MULTI_PREFIX)===0&&F();function o(Z,$){let W="",ee=null;Z.forEach((ie,ae)=>{const ke=$!=null?`${$}.${ae}`:String(ae),le=Np(S,ie,ke,L(ke));if(s.midpoints&&ee){const J=AR(S,ee,le);J&&C.push(J)}ee=le;const se=JSON.stringify(ie);W!==se&&C.push(le),ae===0&&(W=se)})}function L(Z){return s.selectedPaths?s.selectedPaths.indexOf(Z)!==-1:!1}function F(){const Z=m.replace(Br.MULTI_PREFIX,"");v.forEach(($,W)=>{const ee={type:Br.FEATURE,properties:r.properties,geometry:{type:Z,coordinates:$}};C=C.concat(Bv(ee,s,W))})}return C}const Ga={enable(r){setTimeout(()=>{!r.map||!r.map.doubleClickZoom||!r._ctx||!r._ctx.store||!r._ctx.store.getInitialConfigValue||r._ctx.store.getInitialConfigValue("doubleClickZoom")&&r.map.doubleClickZoom.enable()},0)},disable(r){setTimeout(()=>{!r.map||!r.map.doubleClickZoom||r.map.doubleClickZoom.disable()},0)}},{LAT_MIN:ux,LAT_MAX:dx,LAT_RENDERED_MIN:ZP,LAT_RENDERED_MAX:XP,LNG_MIN:YP,LNG_MAX:KP}=vR;function e8(r){const s={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[r.geometry.type],c=[r.geometry.coordinates].flat(s),m=c.map(o=>o[0]),v=c.map(o=>o[1]),S=o=>Math.min.apply(null,o),C=o=>Math.max.apply(null,o);return[S(m),S(v),C(m),C(v)]}function QS(r,s){let c=ux,m=dx,v=ux,S=dx,C=KP,o=YP;r.forEach(F=>{const Z=e8(F),$=Z[1],W=Z[3],ee=Z[0],ie=Z[2];$>c&&(c=$),W<m&&(m=W),W>v&&(v=W),$<S&&(S=$),ee<C&&(C=ee),ie>o&&(o=ie)});const L=s;return c+L.lat>XP&&(L.lat=XP-c),v+L.lat>dx&&(L.lat=dx-v),m+L.lat<ZP&&(L.lat=ZP-m),S+L.lat<ux&&(L.lat=ux-S),C+L.lng<=YP&&(L.lng+=Math.ceil(Math.abs(L.lng)/360)*360),o+L.lng>=KP&&(L.lng-=Math.ceil(Math.abs(L.lng)/360)*360),L}function eT(r,s){const c=QS(r.map(m=>m.toGeoJSON()),s);r.forEach(m=>{const v=m.getCoordinates(),S=F=>{const Z={lng:F[0]+c.lng,lat:F[1]+c.lat};return[Z.lng,Z.lat]},C=F=>F.map(Z=>S(Z)),o=F=>F.map(Z=>C(Z));let L;m.type===Br.POINT?L=S(v):m.type===Br.LINE_STRING||m.type===Br.MULTI_POINT?L=v.map(S):m.type===Br.POLYGON||m.type===Br.MULTI_LINE_STRING?L=v.map(C):m.type===Br.MULTI_POLYGON&&(L=v.map(o)),m.incomingCoords(L)})}const ln={};ln.onSetup=function(r){const s={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:r.featureIds||[]};return this.setSelected(s.initiallySelectedFeatureIds.filter(c=>this.getFeature(c)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),s};ln.fireUpdate=function(){this.fire(co.UPDATE,{action:q_.MOVE,features:this.getSelected().map(r=>r.toGeoJSON())})};ln.fireActionable=function(){const r=this.getSelected(),s=r.filter(S=>this.isInstanceOf("MultiFeature",S));let c=!1;if(r.length>1){c=!0;const S=r[0].type.replace("Multi","");r.forEach(C=>{C.type.replace("Multi","")!==S&&(c=!1)})}const m=s.length>0,v=r.length>0;this.setActionableState({combineFeatures:c,uncombineFeatures:m,trash:v})};ln.getUniqueIds=function(r){return r.length?r.map(c=>c.properties.id).filter(c=>c!==void 0).reduce((c,m)=>(c.add(m),c),new ma).values():[]};ln.stopExtendedInteractions=function(r){r.boxSelectElement&&(r.boxSelectElement.parentNode&&r.boxSelectElement.parentNode.removeChild(r.boxSelectElement),r.boxSelectElement=null),(r.canDragMove||r.canBoxSelect)&&r.initialDragPanState===!0&&this.map.dragPan.enable(),r.boxSelecting=!1,r.canBoxSelect=!1,r.dragMoving=!1,r.canDragMove=!1};ln.onStop=function(){Ga.enable(this)};ln.onMouseMove=function(r,s){return KS(s)&&r.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(r),!0};ln.onMouseOut=function(r){return r.dragMoving?this.fireUpdate():!0};ln.onTap=ln.onClick=function(r,s){if(jv(s))return this.clickAnywhere(r,s);if(Dv(Us.VERTEX)(s))return this.clickOnVertex(r,s);if(KS(s))return this.clickOnFeature(r,s)};ln.clickAnywhere=function(r){const s=this.getSelectedIds();s.length&&(this.clearSelectedFeatures(),s.forEach(c=>this.doRender(c))),Ga.enable(this),this.stopExtendedInteractions(r)};ln.clickOnVertex=function(r,s){this.changeMode(Oi.DIRECT_SELECT,{featureId:s.featureTarget.properties.parent,coordPath:s.featureTarget.properties.coord_path,startPos:s.lngLat}),this.updateUIClasses({mouse:Nn.MOVE})};ln.startOnActiveFeature=function(r,s){this.stopExtendedInteractions(r),this.map.dragPan.disable(),this.doRender(s.featureTarget.properties.id),r.canDragMove=!0,r.dragMoveLocation=s.lngLat};ln.clickOnFeature=function(r,s){Ga.disable(this),this.stopExtendedInteractions(r);const c=av(s),m=this.getSelectedIds(),v=s.featureTarget.properties.id,S=this.isSelected(v);if(!c&&S&&this.getFeature(v).type!==Br.POINT)return this.changeMode(Oi.DIRECT_SELECT,{featureId:v});S&&c?(this.deselect(v),this.updateUIClasses({mouse:Nn.POINTER}),m.length===1&&Ga.enable(this)):!S&&c?(this.select(v),this.updateUIClasses({mouse:Nn.MOVE})):!S&&!c&&(m.forEach(C=>this.doRender(C)),this.setSelected(v),this.updateUIClasses({mouse:Nn.MOVE})),this.doRender(v)};ln.onMouseDown=function(r,s){if(r.initialDragPanState=this.map.dragPan.isEnabled(),hh(s))return this.startOnActiveFeature(r,s);if(this.drawConfig.boxSelect&&CR(s))return this.startBoxSelect(r,s)};ln.startBoxSelect=function(r,s){this.stopExtendedInteractions(r),this.map.dragPan.disable(),r.boxSelectStartLocation=JS(s.originalEvent,this.map.getContainer()),r.canBoxSelect=!0};ln.onTouchStart=function(r,s){if(hh(s))return this.startOnActiveFeature(r,s)};ln.onDrag=function(r,s){if(r.canDragMove)return this.dragMove(r,s);if(this.drawConfig.boxSelect&&r.canBoxSelect)return this.whileBoxSelect(r,s)};ln.whileBoxSelect=function(r,s){r.boxSelecting=!0,this.updateUIClasses({mouse:Nn.ADD}),r.boxSelectElement||(r.boxSelectElement=document.createElement("div"),r.boxSelectElement.classList.add(xo.BOX_SELECT),this.map.getContainer().appendChild(r.boxSelectElement));const c=JS(s.originalEvent,this.map.getContainer()),m=Math.min(r.boxSelectStartLocation.x,c.x),v=Math.max(r.boxSelectStartLocation.x,c.x),S=Math.min(r.boxSelectStartLocation.y,c.y),C=Math.max(r.boxSelectStartLocation.y,c.y),o=`translate(${m}px, ${S}px)`;r.boxSelectElement.style.transform=o,r.boxSelectElement.style.WebkitTransform=o,r.boxSelectElement.style.width=`${v-m}px`,r.boxSelectElement.style.height=`${C-S}px`};ln.dragMove=function(r,s){r.dragMoving=!0,s.originalEvent.stopPropagation();const c={lng:s.lngLat.lng-r.dragMoveLocation.lng,lat:s.lngLat.lat-r.dragMoveLocation.lat};eT(this.getSelected(),c),r.dragMoveLocation=s.lngLat};ln.onTouchEnd=ln.onMouseUp=function(r,s){if(r.dragMoving)this.fireUpdate();else if(r.boxSelecting){const c=[r.boxSelectStartLocation,JS(s.originalEvent,this.map.getContainer())],m=this.featuresAt(null,c,"click"),v=this.getUniqueIds(m).filter(S=>!this.isSelected(S));v.length&&(this.select(v),v.forEach(S=>this.doRender(S)),this.updateUIClasses({mouse:Nn.MOVE}))}this.stopExtendedInteractions(r)};ln.toDisplayFeatures=function(r,s,c){s.properties.active=this.isSelected(s.properties.id)?ws.ACTIVE:ws.INACTIVE,c(s),this.fireActionable(),!(s.properties.active!==ws.ACTIVE||s.geometry.type===Br.POINT)&&Bv(s).forEach(c)};ln.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};ln.onCombineFeatures=function(){const r=this.getSelected();if(r.length===0||r.length<2)return;const s=[],c=[],m=r[0].type.replace("Multi","");for(let v=0;v<r.length;v++){const S=r[v];if(S.type.replace("Multi","")!==m)return;S.type.includes("Multi")?S.getCoordinates().forEach(C=>{s.push(C)}):s.push(S.getCoordinates()),c.push(S.toGeoJSON())}if(c.length>1){const v=this.newFeature({type:Br.FEATURE,properties:c[0].properties,geometry:{type:`Multi${m}`,coordinates:s}});this.addFeature(v),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([v.id]),this.fire(co.COMBINE_FEATURES,{createdFeatures:[v.toGeoJSON()],deletedFeatures:c})}this.fireActionable()};ln.onUncombineFeatures=function(){const r=this.getSelected();if(r.length===0)return;const s=[],c=[];for(let m=0;m<r.length;m++){const v=r[m];this.isInstanceOf("MultiFeature",v)&&(v.getFeatures().forEach(S=>{this.addFeature(S),S.properties=v.properties,s.push(S.toGeoJSON()),this.select([S.id])}),this.deleteFeature(v.id,{silent:!0}),c.push(v.toGeoJSON()))}s.length>1&&this.fire(co.UNCOMBINE_FEATURES,{createdFeatures:s,deletedFeatures:c}),this.fireActionable()};const PR=Dv(Us.VERTEX),kR=Dv(Us.MIDPOINT),cn={};cn.fireUpdate=function(){this.fire(co.UPDATE,{action:q_.CHANGE_COORDINATES,features:this.getSelected().map(r=>r.toGeoJSON())})};cn.fireActionable=function(r){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:r.selectedCoordPaths.length>0})};cn.startDragging=function(r,s){r.initialDragPanState=this.map.dragPan.isEnabled(),this.map.dragPan.disable(),r.canDragMove=!0,r.dragMoveLocation=s.lngLat};cn.stopDragging=function(r){r.canDragMove&&r.initialDragPanState===!0&&this.map.dragPan.enable(),r.dragMoving=!1,r.canDragMove=!1,r.dragMoveLocation=null};cn.onVertex=function(r,s){this.startDragging(r,s);const c=s.featureTarget.properties,m=r.selectedCoordPaths.indexOf(c.coord_path);!av(s)&&m===-1?r.selectedCoordPaths=[c.coord_path]:av(s)&&m===-1&&r.selectedCoordPaths.push(c.coord_path);const v=this.pathsToCoordinates(r.featureId,r.selectedCoordPaths);this.setSelectedCoordinates(v)};cn.onMidpoint=function(r,s){this.startDragging(r,s);const c=s.featureTarget.properties;r.feature.addCoordinate(c.coord_path,c.lng,c.lat),this.fireUpdate(),r.selectedCoordPaths=[c.coord_path]};cn.pathsToCoordinates=function(r,s){return s.map(c=>({feature_id:r,coord_path:c}))};cn.onFeature=function(r,s){r.selectedCoordPaths.length===0?this.startDragging(r,s):this.stopDragging(r)};cn.dragFeature=function(r,s,c){eT(this.getSelected(),c),r.dragMoveLocation=s.lngLat};cn.dragVertex=function(r,s,c){const m=r.selectedCoordPaths.map(C=>r.feature.getCoordinate(C)),v=m.map(C=>({type:Br.FEATURE,properties:{},geometry:{type:Br.POINT,coordinates:C}})),S=QS(v,c);for(let C=0;C<m.length;C++){const o=m[C];r.feature.updateCoordinate(r.selectedCoordPaths[C],o[0]+S.lng,o[1]+S.lat)}};cn.clickNoTarget=function(){this.changeMode(Oi.SIMPLE_SELECT)};cn.clickInactive=function(){this.changeMode(Oi.SIMPLE_SELECT)};cn.clickActiveFeature=function(r){r.selectedCoordPaths=[],this.clearSelectedCoordinates(),r.feature.changed()};cn.onSetup=function(r){const s=r.featureId,c=this.getFeature(s);if(!c)throw new Error("You must provide a featureId to enter direct_select mode");if(c.type===Br.POINT)throw new TypeError("direct_select mode doesn't handle point features");const m={featureId:s,feature:c,dragMoveLocation:r.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:r.coordPath?[r.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(s,m.selectedCoordPaths)),this.setSelected(s),Ga.disable(this),this.setActionableState({trash:!0}),m};cn.onStop=function(){Ga.enable(this),this.clearSelectedCoordinates()};cn.toDisplayFeatures=function(r,s,c){r.featureId===s.properties.id?(s.properties.active=ws.ACTIVE,c(s),Bv(s,{map:this.map,midpoints:!0,selectedPaths:r.selectedCoordPaths}).forEach(c)):(s.properties.active=ws.INACTIVE,c(s)),this.fireActionable(r)};cn.onTrash=function(r){r.selectedCoordPaths.sort((s,c)=>c.localeCompare(s,"en",{numeric:!0})).forEach(s=>r.feature.removeCoordinate(s)),this.fireUpdate(),r.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(r),r.feature.isValid()===!1&&(this.deleteFeature([r.featureId]),this.changeMode(Oi.SIMPLE_SELECT,{}))};cn.onMouseMove=function(r,s){const c=hh(s),m=PR(s),v=kR(s),S=r.selectedCoordPaths.length===0;return c&&S?this.updateUIClasses({mouse:Nn.MOVE}):m&&!S?this.updateUIClasses({mouse:Nn.MOVE}):this.updateUIClasses({mouse:Nn.NONE}),(m||c||v)&&r.dragMoving&&this.fireUpdate(),this.stopDragging(r),!0};cn.onMouseOut=function(r){return r.dragMoving&&this.fireUpdate(),!0};cn.onTouchStart=cn.onMouseDown=function(r,s){if(PR(s))return this.onVertex(r,s);if(hh(s))return this.onFeature(r,s);if(kR(s))return this.onMidpoint(r,s)};cn.onDrag=function(r,s){if(r.canDragMove!==!0)return;r.dragMoving=!0,s.originalEvent.stopPropagation();const c={lng:s.lngLat.lng-r.dragMoveLocation.lng,lat:s.lngLat.lat-r.dragMoveLocation.lat};r.selectedCoordPaths.length>0?this.dragVertex(r,s,c):this.dragFeature(r,s,c),r.dragMoveLocation=s.lngLat};cn.onClick=function(r,s){if(jv(s))return this.clickNoTarget(r,s);if(hh(s))return this.clickActiveFeature(r,s);if(YS(s))return this.clickInactive(r,s);this.stopDragging(r)};cn.onTap=function(r,s){if(jv(s))return this.clickNoTarget(r,s);if(hh(s))return this.clickActiveFeature(r,s);if(YS(s))return this.clickInactive(r,s)};cn.onTouchEnd=cn.onMouseUp=function(r){r.dragMoving&&this.fireUpdate(),this.stopDragging(r)};const Ml={};Ml.onSetup=function(){const r=this.newFeature({type:Br.FEATURE,properties:{},geometry:{type:Br.POINT,coordinates:[]}});return this.addFeature(r),this.clearSelectedFeatures(),this.updateUIClasses({mouse:Nn.ADD}),this.activateUIButton(vo.POINT),this.setActionableState({trash:!0}),{point:r}};Ml.stopDrawingAndRemove=function(r){this.deleteFeature([r.point.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT)};Ml.onTap=Ml.onClick=function(r,s){this.updateUIClasses({mouse:Nn.MOVE}),r.point.updateCoordinate("",s.lngLat.lng,s.lngLat.lat),this.fire(co.CREATE,{features:[r.point.toGeoJSON()]}),this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.point.id]})};Ml.onStop=function(r){this.activateUIButton(),r.point.getCoordinate().length||this.deleteFeature([r.point.id],{silent:!0})};Ml.toDisplayFeatures=function(r,s,c){const m=s.properties.id===r.point.id;if(s.properties.active=m?ws.ACTIVE:ws.INACTIVE,!m)return c(s)};Ml.onTrash=Ml.stopDrawingAndRemove;Ml.onKeyUp=function(r,s){if(zv(s)||Fv(s))return this.stopDrawingAndRemove(r,s)};function lv(r,s){return r.lngLat?r.lngLat.lng===s[0]&&r.lngLat.lat===s[1]:!1}const qa={};qa.onSetup=function(){const r=this.newFeature({type:Br.FEATURE,properties:{},geometry:{type:Br.POLYGON,coordinates:[[]]}});return this.addFeature(r),this.clearSelectedFeatures(),Ga.disable(this),this.updateUIClasses({mouse:Nn.ADD}),this.activateUIButton(vo.POLYGON),this.setActionableState({trash:!0}),{polygon:r,currentVertexPosition:0}};qa.clickAnywhere=function(r,s){if(r.currentVertexPosition>0&&lv(s,r.polygon.coordinates[0][r.currentVertexPosition-1]))return this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.polygon.id]});this.updateUIClasses({mouse:Nn.ADD}),r.polygon.updateCoordinate(`0.${r.currentVertexPosition}`,s.lngLat.lng,s.lngLat.lat),r.currentVertexPosition++,r.polygon.updateCoordinate(`0.${r.currentVertexPosition}`,s.lngLat.lng,s.lngLat.lat)};qa.clickOnVertex=function(r){return this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.polygon.id]})};qa.onMouseMove=function(r,s){r.polygon.updateCoordinate(`0.${r.currentVertexPosition}`,s.lngLat.lng,s.lngLat.lat),W_(s)&&this.updateUIClasses({mouse:Nn.POINTER})};qa.onTap=qa.onClick=function(r,s){return W_(s)?this.clickOnVertex(r,s):this.clickAnywhere(r,s)};qa.onKeyUp=function(r,s){zv(s)?(this.deleteFeature([r.polygon.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT)):Fv(s)&&this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.polygon.id]})};qa.onStop=function(r){this.updateUIClasses({mouse:Nn.NONE}),Ga.enable(this),this.activateUIButton(),this.getFeature(r.polygon.id)!==void 0&&(r.polygon.removeCoordinate(`0.${r.currentVertexPosition}`),r.polygon.isValid()?this.fire(co.CREATE,{features:[r.polygon.toGeoJSON()]}):(this.deleteFeature([r.polygon.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT,{},{silent:!0})))};qa.toDisplayFeatures=function(r,s,c){const m=s.properties.id===r.polygon.id;if(s.properties.active=m?ws.ACTIVE:ws.INACTIVE,!m)return c(s);if(s.geometry.coordinates.length===0)return;const v=s.geometry.coordinates[0].length;if(!(v<3)){if(s.properties.meta=Us.FEATURE,c(Np(r.polygon.id,s.geometry.coordinates[0][0],"0.0",!1)),v>3){const S=s.geometry.coordinates[0].length-3;c(Np(r.polygon.id,s.geometry.coordinates[0][S],`0.${S}`,!1))}if(v<=4){const S=[[s.geometry.coordinates[0][0][0],s.geometry.coordinates[0][0][1]],[s.geometry.coordinates[0][1][0],s.geometry.coordinates[0][1][1]]];if(c({type:Br.FEATURE,properties:s.properties,geometry:{coordinates:S,type:Br.LINE_STRING}}),v===3)return}return c(s)}};qa.onTrash=function(r){this.deleteFeature([r.polygon.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT)};const Ha={};Ha.onSetup=function(r){r=r||{};const s=r.featureId;let c,m,v="forward";if(s){if(c=this.getFeature(s),!c)throw new Error("Could not find a feature with the provided featureId");let S=r.from;if(S&&S.type==="Feature"&&S.geometry&&S.geometry.type==="Point"&&(S=S.geometry),S&&S.type==="Point"&&S.coordinates&&S.coordinates.length===2&&(S=S.coordinates),!S||!Array.isArray(S))throw new Error("Please use the `from` property to indicate which point to continue the line from");const C=c.coordinates.length-1;if(c.coordinates[C][0]===S[0]&&c.coordinates[C][1]===S[1])m=C+1,c.addCoordinate(m,...c.coordinates[C]);else if(c.coordinates[0][0]===S[0]&&c.coordinates[0][1]===S[1])v="backwards",m=0,c.addCoordinate(m,...c.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else c=this.newFeature({type:Br.FEATURE,properties:{},geometry:{type:Br.LINE_STRING,coordinates:[]}}),m=0,this.addFeature(c);return this.clearSelectedFeatures(),Ga.disable(this),this.updateUIClasses({mouse:Nn.ADD}),this.activateUIButton(vo.LINE),this.setActionableState({trash:!0}),{line:c,currentVertexPosition:m,direction:v}};Ha.clickAnywhere=function(r,s){if(r.currentVertexPosition>0&&lv(s,r.line.coordinates[r.currentVertexPosition-1])||r.direction==="backwards"&&lv(s,r.line.coordinates[r.currentVertexPosition+1]))return this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.line.id]});this.updateUIClasses({mouse:Nn.ADD}),r.line.updateCoordinate(r.currentVertexPosition,s.lngLat.lng,s.lngLat.lat),r.direction==="forward"?(r.currentVertexPosition++,r.line.updateCoordinate(r.currentVertexPosition,s.lngLat.lng,s.lngLat.lat)):r.line.addCoordinate(0,s.lngLat.lng,s.lngLat.lat)};Ha.clickOnVertex=function(r){return this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.line.id]})};Ha.onMouseMove=function(r,s){r.line.updateCoordinate(r.currentVertexPosition,s.lngLat.lng,s.lngLat.lat),W_(s)&&this.updateUIClasses({mouse:Nn.POINTER})};Ha.onTap=Ha.onClick=function(r,s){if(W_(s))return this.clickOnVertex(r,s);this.clickAnywhere(r,s)};Ha.onKeyUp=function(r,s){Fv(s)?this.changeMode(Oi.SIMPLE_SELECT,{featureIds:[r.line.id]}):zv(s)&&(this.deleteFeature([r.line.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT))};Ha.onStop=function(r){Ga.enable(this),this.activateUIButton(),this.getFeature(r.line.id)!==void 0&&(r.line.removeCoordinate(`${r.currentVertexPosition}`),r.line.isValid()?this.fire(co.CREATE,{features:[r.line.toGeoJSON()]}):(this.deleteFeature([r.line.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT,{},{silent:!0})))};Ha.onTrash=function(r){this.deleteFeature([r.line.id],{silent:!0}),this.changeMode(Oi.SIMPLE_SELECT)};Ha.toDisplayFeatures=function(r,s,c){const m=s.properties.id===r.line.id;if(s.properties.active=m?ws.ACTIVE:ws.INACTIVE,!m)return c(s);s.geometry.coordinates.length<2||(s.properties.meta=Us.FEATURE,c(Np(r.line.id,s.geometry.coordinates[r.direction==="forward"?s.geometry.coordinates.length-2:1],`${r.direction==="forward"?s.geometry.coordinates.length-2:1}`,!1)),c(s))};const MR={simple_select:ln,direct_select:cn,draw_point:Ml,draw_polygon:qa,draw_line_string:Ha},t8={defaultMode:Oi.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:IR,modes:MR,controls:{},userProperties:!1,suppressAPIEvents:!0},r8={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},i8={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function JP(r,s){return r.map(c=>c.source?c:Object.assign({},c,{id:`${c.id}.${s}`,source:s==="hot"?ha.HOT:ha.COLD}))}function n8(r={}){let s=Object.assign({},r);return r.controls||(s.controls={}),r.displayControlsDefault===!1?s.controls=Object.assign({},i8,r.controls):s.controls=Object.assign({},r8,r.controls),s=Object.assign({},t8,s),s.styles=JP(s.styles,"cold").concat(JP(s.styles,"hot")),s}var s8=function r(s,c){if(s===c)return!0;if(s&&c&&typeof s=="object"&&typeof c=="object"){if(s.constructor!==c.constructor)return!1;var m,v,S;if(Array.isArray(s)){if(m=s.length,m!=c.length)return!1;for(v=m;v--!==0;)if(!r(s[v],c[v]))return!1;return!0}if(s.constructor===RegExp)return s.source===c.source&&s.flags===c.flags;if(s.valueOf!==Object.prototype.valueOf)return s.valueOf()===c.valueOf();if(s.toString!==Object.prototype.toString)return s.toString()===c.toString();if(S=Object.keys(s),m=S.length,m!==Object.keys(c).length)return!1;for(v=m;v--!==0;)if(!Object.prototype.hasOwnProperty.call(c,S[v]))return!1;for(v=m;v--!==0;){var C=S[v];if(!r(s[C],c[C]))return!1}return!0}return s!==s&&c!==c};const QP=U2(s8);var o8=l8,a8={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function l8(r){if(!r||!r.type)return null;var s=a8[r.type];if(!s)return null;if(s==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:r}]};if(s==="feature")return{type:"FeatureCollection",features:[r]};if(s==="featurecollection")return r}const c8=U2(o8);function NR(r,s){return r.length!==s.length?!1:JSON.stringify(r.map(c=>c).sort())===JSON.stringify(s.map(c=>c).sort())}const u8={Polygon:Ko,LineString:Nl,Point:Vu,MultiPolygon:lo,MultiLineString:lo,MultiPoint:lo};function d8(r,s){s.modes=Oi;const c=r.options.suppressAPIEvents!==void 0?!!r.options.suppressAPIEvents:!0;return s.getFeatureIdsAt=function(m){return Mp.click({point:m},null,r).map(S=>S.properties.id)},s.getSelectedIds=function(){return r.store.getSelectedIds()},s.getSelected=function(){return{type:Br.FEATURE_COLLECTION,features:r.store.getSelectedIds().map(m=>r.store.get(m)).map(m=>m.toGeoJSON())}},s.getSelectedPoints=function(){return{type:Br.FEATURE_COLLECTION,features:r.store.getSelectedCoordinates().map(m=>({type:Br.FEATURE,properties:{},geometry:{type:Br.POINT,coordinates:m.coordinates}}))}},s.set=function(m){if(m.type===void 0||m.type!==Br.FEATURE_COLLECTION||!Array.isArray(m.features))throw new Error("Invalid FeatureCollection");const v=r.store.createRenderBatch();let S=r.store.getAllIds().slice();const C=s.add(m),o=new ma(C);return S=S.filter(L=>!o.has(L)),S.length&&s.delete(S),v(),C},s.add=function(m){const S=JSON.parse(JSON.stringify(c8(m))).features.map(C=>{if(C.id=C.id||XS(),C.geometry===null)throw new Error("Invalid geometry: null");if(r.store.get(C.id)===void 0||r.store.get(C.id).type!==C.geometry.type){const o=u8[C.geometry.type];if(o===void 0)throw new Error(`Invalid geometry type: ${C.geometry.type}.`);const L=new o(r,C);r.store.add(L,{silent:c})}else{const o=r.store.get(C.id),L=o.properties;o.properties=C.properties,QP(L,C.properties)||r.store.featureChanged(o.id,{silent:c}),QP(o.getCoordinates(),C.geometry.coordinates)||o.incomingCoords(C.geometry.coordinates)}return C.id});return r.store.render(),S},s.get=function(m){const v=r.store.get(m);if(v)return v.toGeoJSON()},s.getAll=function(){return{type:Br.FEATURE_COLLECTION,features:r.store.getAll().map(m=>m.toGeoJSON())}},s.delete=function(m){return r.store.delete(m,{silent:c}),s.getMode()===Oi.DIRECT_SELECT&&!r.store.getSelectedIds().length?r.events.changeMode(Oi.SIMPLE_SELECT,void 0,{silent:c}):r.store.render(),s},s.deleteAll=function(){return r.store.delete(r.store.getAllIds(),{silent:c}),s.getMode()===Oi.DIRECT_SELECT?r.events.changeMode(Oi.SIMPLE_SELECT,void 0,{silent:c}):r.store.render(),s},s.changeMode=function(m,v={}){return m===Oi.SIMPLE_SELECT&&s.getMode()===Oi.SIMPLE_SELECT?(NR(v.featureIds||[],r.store.getSelectedIds())||(r.store.setSelected(v.featureIds,{silent:c}),r.store.render()),s):(m===Oi.DIRECT_SELECT&&s.getMode()===Oi.DIRECT_SELECT&&v.featureId===r.store.getSelectedIds()[0]||r.events.changeMode(m,v,{silent:c}),s)},s.getMode=function(){return r.events.getMode()},s.trash=function(){return r.events.trash({silent:c}),s},s.combineFeatures=function(){return r.events.combineFeatures({silent:c}),s},s.uncombineFeatures=function(){return r.events.uncombineFeatures({silent:c}),s},s.setFeatureProperty=function(m,v,S){return r.store.setFeatureProperty(m,v,S,{silent:c}),s},s}const h8=Object.freeze(Object.defineProperty({__proto__:null,CommonSelectors:QV,ModeHandler:L2,StringSet:ma,constrainFeatureMovement:QS,createMidPoint:AR,createSupplementaryPoints:Bv,createVertex:Np,doubleClickZoom:Ga,euclideanDistance:ZS,featuresAt:Mp,getFeatureAtAndSetCursors:Ix,isClick:z2,isEventAtCoordinates:lv,isTap:F2,mapEventToBoundingBox:wR,moveFeatures:eT,sortFeatures:bR,stringSetsAreEqual:NR,theme:IR,toDenseArray:H_},Symbol.toStringTag,{value:"Module"})),f8=function(r,s){r=n8(r);const c={options:r};s=d8(c,s),c.api=s;const m=KV(c);return s.onAdd=m.onAdd,s.onRemove=m.onRemove,s.types=vo,s.options=r,s};function Uv(r){f8(r,this)}Uv.modes=MR;Uv.constants=vR;Uv.lib=h8;var no=63710088e-1,RR={centimeters:no*100,centimetres:no*100,degrees:360/(2*Math.PI),feet:no*3.28084,inches:no*39.37,kilometers:no/1e3,kilometres:no/1e3,meters:no,metres:no,miles:no/1609.344,millimeters:no*1e3,millimetres:no*1e3,nauticalmiles:no/1852,radians:1,yards:no*1.0936};function Rp(r,s,c={}){const m={type:"Feature"};return(c.id===0||c.id)&&(m.id=c.id),c.bbox&&(m.bbox=c.bbox),m.properties=s||{},m.geometry=r,m}function p8(r,s,c={}){if(!r)throw new Error("coordinates is required");if(!Array.isArray(r))throw new Error("coordinates must be an Array");if(r.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!tk(r[0])||!tk(r[1]))throw new Error("coordinates must contain numbers");return Rp({type:"Point",coordinates:r},s,c)}function LR(r,s,c={}){for(const v of r){if(v.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(v[v.length-1].length!==v[0].length)throw new Error("First and last Position are not equivalent.");for(let S=0;S<v[v.length-1].length;S++)if(v[v.length-1][S]!==v[0][S])throw new Error("First and last Position are not equivalent.")}return Rp({type:"Polygon",coordinates:r},s,c)}function tT(r,s,c={}){if(r.length<2)throw new Error("coordinates must be an array of two or more positions");return Rp({type:"LineString",coordinates:r},s,c)}function m8(r,s={}){const c={type:"FeatureCollection"};return s.id&&(c.id=s.id),s.bbox&&(c.bbox=s.bbox),c.features=r,c}function g8(r,s,c={}){return Rp({type:"MultiLineString",coordinates:r},s,c)}function _8(r,s="kilometers"){const c=RR[s];if(!c)throw new Error(s+" units is invalid");return r*c}function y8(r,s="kilometers"){const c=RR[s];if(!c)throw new Error(s+" units is invalid");return r/c}function ek(r){return r%(2*Math.PI)*180/Math.PI}function eh(r){return r%360*Math.PI/180}function tk(r){return!isNaN(r)&&r!==null&&!Array.isArray(r)}function B2(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return[...r.geometry.coordinates];if(r.type==="Point")return[...r.coordinates]}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return[...r];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function rT(r){return r.type==="Feature"?r.geometry:r}function x8(r,s,c,m={}){const v=B2(r),S=eh(v[0]),C=eh(v[1]),o=eh(c),L=y8(s,m.units),F=Math.asin(Math.sin(C)*Math.cos(L)+Math.cos(C)*Math.sin(L)*Math.cos(o)),Z=S+Math.atan2(Math.sin(o)*Math.sin(L)*Math.cos(C),Math.cos(L)-Math.sin(C)*Math.sin(F)),$=ek(Z),W=ek(F);return p8([$,W],m.properties)}function v8(r,s,c={}){var m=B2(r),v=B2(s),S=eh(v[1]-m[1]),C=eh(v[0]-m[0]),o=eh(m[1]),L=eh(v[1]),F=Math.pow(Math.sin(S/2),2)+Math.pow(Math.sin(C/2),2)*Math.cos(o)*Math.cos(L);return _8(2*Math.atan2(Math.sqrt(F),Math.sqrt(1-F)),c.units)}function OR(r,s,c){if(r!==null)for(var m,v,S,C,o,L,F,Z=0,$=0,W,ee=r.type,ie=ee==="FeatureCollection",ae=ee==="Feature",ke=ie?r.features.length:1,le=0;le<ke;le++){F=ie?r.features[le].geometry:ae?r.geometry:r,W=F?F.type==="GeometryCollection":!1,o=W?F.geometries.length:1;for(var se=0;se<o;se++){var J=0,Ee=0;if(C=W?F.geometries[se]:F,C!==null){L=C.coordinates;var je=C.type;switch(Z=0,je){case null:break;case"Point":if(s(L,$,le,J,Ee)===!1)return!1;$++,J++;break;case"LineString":case"MultiPoint":for(m=0;m<L.length;m++){if(s(L[m],$,le,J,Ee)===!1)return!1;$++,je==="MultiPoint"&&J++}je==="LineString"&&J++;break;case"Polygon":case"MultiLineString":for(m=0;m<L.length;m++){for(v=0;v<L[m].length-Z;v++){if(s(L[m][v],$,le,J,Ee)===!1)return!1;$++}je==="MultiLineString"&&J++,je==="Polygon"&&Ee++}je==="Polygon"&&J++;break;case"MultiPolygon":for(m=0;m<L.length;m++){for(Ee=0,v=0;v<L[m].length;v++){for(S=0;S<L[m][v].length-Z;S++){if(s(L[m][v][S],$,le,J,Ee)===!1)return!1;$++}Ee++}J++}break;case"GeometryCollection":for(m=0;m<C.geometries.length;m++)if(OR(C.geometries[m],s)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function DR(r,s){var c,m,v,S,C,o,L,F,Z,$,W=0,ee=r.type==="FeatureCollection",ie=r.type==="Feature",ae=ee?r.features.length:1;for(c=0;c<ae;c++){for(o=ee?r.features[c].geometry:ie?r.geometry:r,F=ee?r.features[c].properties:ie?r.properties:{},Z=ee?r.features[c].bbox:ie?r.bbox:void 0,$=ee?r.features[c].id:ie?r.id:void 0,L=o?o.type==="GeometryCollection":!1,C=L?o.geometries.length:1,v=0;v<C;v++){if(S=L?o.geometries[v]:o,S===null){if(s(null,W,F,Z,$)===!1)return!1;continue}switch(S.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(s(S,W,F,Z,$)===!1)return!1;break}case"GeometryCollection":{for(m=0;m<S.geometries.length;m++)if(s(S.geometries[m],W,F,Z,$)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}W++}}function b8(r,s,c){var m=c;return DR(r,function(v,S,C,o,L){m=s(m,v,S,C,o,L)}),m}function w8(r,s){DR(r,function(c,m,v,S,C){var o=c===null?null:c.type;switch(o){case null:case"Point":case"LineString":case"Polygon":return s(Rp(c,v,{bbox:S,id:C}),m,0)===!1?!1:void 0}var L;switch(o){case"MultiPoint":L="Point";break;case"MultiLineString":L="LineString";break;case"MultiPolygon":L="Polygon";break}for(var F=0;F<c.coordinates.length;F++){var Z=c.coordinates[F],$={type:L,coordinates:Z};if(s(Rp($,v),m,F)===!1)return!1}})}function S8(r,s){w8(r,function(c,m,v){var S=0;if(c.geometry){var C=c.geometry.type;if(!(C==="Point"||C==="MultiPoint")){var o,L=0,F=0,Z=0;if(OR(c,function($,W,ee,ie,ae){if(o===void 0||m>L||ie>F||ae>Z){o=$,L=m,F=ie,Z=ae,S=0;return}var ke=tT([o,$],c.properties);if(s(ke,m,v,ae,S)===!1)return!1;S++,o=$})===!1)return!1}}})}function T8(r,s,c){var m=c,v=!1;return S8(r,function(S,C,o,L,F){v===!1&&c===void 0?m=S:m=s(m,S,C,o,L,F),v=!0}),m}function E8(r){return b8(r,(s,c)=>s+I8(c),0)}function I8(r){let s=0,c;switch(r.type){case"Polygon":return rk(r.coordinates);case"MultiPolygon":for(c=0;c<r.coordinates.length;c++)s+=rk(r.coordinates[c]);return s;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function rk(r){let s=0;if(r&&r.length>0){s+=Math.abs(ik(r[0]));for(let c=1;c<r.length;c++)s-=Math.abs(ik(r[c]))}return s}var C8=no*no/2,E1=Math.PI/180;function ik(r){const s=r.length-1;if(s<=2)return 0;let c=0,m=0;for(;m<s;){const v=r[m],S=r[m+1===s?0:m+1],C=r[m+2>=s?(m+2)%s:m+2],o=v[0]*E1,L=S[1]*E1,F=C[0]*E1;c+=(F-o)*Math.sin(L),m++}return c*C8}function A8(r,s={}){const c=rT(r);switch(!s.properties&&r.type==="Feature"&&(s.properties=r.properties),c.type){case"Polygon":return P8(c,s);case"MultiPolygon":return k8(c,s);default:throw new Error("invalid poly")}}function P8(r,s={}){const m=rT(r).coordinates,v=s.properties?s.properties:r.type==="Feature"?r.properties:{};return jR(m,v)}function k8(r,s={}){const m=rT(r).coordinates,v=s.properties?s.properties:r.type==="Feature"?r.properties:{},S=[];return m.forEach(C=>{S.push(jR(C,v))}),m8(S)}function jR(r,s){return r.length>1?g8(r,s):tT(r[0],s)}function M8(r,s,c={}){const m=c.steps||64,v=c.properties?c.properties:!Array.isArray(r)&&r.type==="Feature"&&r.properties?r.properties:{},S=[];for(let C=0;C<m;C++)S.push(x8(r,s,C*-360/m,c).geometry.coordinates);return S.push(S[0]),LR([S],v)}function nk(r,s={}){return T8(r,(c,m)=>{const v=m.geometry.coordinates;return c+v8(v[0],v[1],s)},0)}function N8({map:r}){const[s,c]=Ne.useState([]),[m,v]=Ne.useState(null),[S,C]=Ne.useState(100),o=Ne.useRef(null);Ne.useEffect(()=>{if(!r)return;const ee=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#22c55e","line-width":3,"line-opacity":.8}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#22c55e","fill-opacity":.15}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#22c55e","line-width":3,"line-opacity":.9}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":6,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#fff"}},{id:"gl-draw-point",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","vertex"]],paint:{"circle-radius":8,"circle-color":"#22c55e","circle-stroke-width":2,"circle-stroke-color":"#fff"}}],ie=new Uv({displayControlsDefault:!1,styles:ee,controls:{}});r.addControl(ie,"top-left"),o.current=ie;const ae=se=>{L(se.features)},ke=se=>{L(se.features)},le=()=>{c([])};return r.on("draw.create",ae),r.on("draw.update",ke),r.on("draw.delete",le),()=>{r.off("draw.create",ae),r.off("draw.update",ke),r.off("draw.delete",le),o.current&&r.removeControl(o.current)}},[r]);const L=ee=>{const ie=[];ee.forEach(ae=>{if(ae.geometry.type==="LineString"){const ke=tT(ae.geometry.coordinates),le=nk(ke,{units:"kilometers"});ie.push({id:ae.id,type:"distance",value:le,unit:"km",label:`${le.toFixed(2)} km`,coordinates:ae.geometry.coordinates})}if(ae.geometry.type==="Polygon"){const ke=LR(ae.geometry.coordinates),le=E8(ke)/1e6,se=nk(A8(ke),{units:"kilometers"});ie.push({id:ae.id,type:"area",value:le,perimeter:se,unit:"km²",label:`${le.toFixed(2)} km²`,perimeterLabel:`${se.toFixed(2)} km`,coordinates:ae.geometry.coordinates})}}),c(ie)},F=()=>{o.current&&(o.current.changeMode("draw_line_string"),v("line"))},Z=()=>{o.current&&(o.current.changeMode("draw_polygon"),v("polygon"))},$=()=>{if(!o.current||!r)return;const ee=r.getCenter(),ie={steps:64,units:"kilometers"},ae=M8([ee.lng,ee.lat],S,ie),ke=o.current.add(ae);v("circle"),L([{id:ke[0],geometry:ae.geometry}])},W=()=>{o.current&&(o.current.deleteAll(),c([]),v(null))};return x.jsx("div",{className:"fixed top-20 left-4 z-20 pointer-events-auto",children:x.jsxs("div",{className:"bg-slate-900/95 border-2 border-green-500/50 rounded-lg backdrop-blur-md shadow-2xl shadow-green-500/20 min-w-[280px]",children:[x.jsx("div",{className:"px-4 py-3 border-b border-green-500/30 flex items-center justify-between",children:x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx(v2,{className:"w-5 h-5 text-green-400"}),x.jsx("h3",{className:"text-green-400 font-bold uppercase tracking-wider text-sm",children:"Herramientas de Medición"})]})}),x.jsxs("div",{className:"p-3 space-y-2",children:[x.jsxs("button",{onClick:F,className:`w-full px-4 py-3 rounded-lg border-2 transition-all flex items-center space-x-3 ${m==="line"?"bg-green-500/20 border-green-500 text-green-400":"bg-slate-800/50 border-slate-700 text-slate-300 hover:border-green-500/50 hover:bg-slate-800"}`,children:[x.jsx(v2,{className:"w-5 h-5"}),x.jsxs("div",{className:"text-left flex-1",children:[x.jsx("div",{className:"font-bold text-sm",children:"Medir Distancia"}),x.jsx("div",{className:"text-xs opacity-70",children:"Click para agregar puntos"})]})]}),x.jsxs("button",{onClick:Z,className:`w-full px-4 py-3 rounded-lg border-2 transition-all flex items-center space-x-3 ${m==="polygon"?"bg-blue-500/20 border-blue-500 text-blue-400":"bg-slate-800/50 border-slate-700 text-slate-300 hover:border-blue-500/50 hover:bg-slate-800"}`,children:[x.jsx(QF,{className:"w-5 h-5"}),x.jsxs("div",{className:"text-left flex-1",children:[x.jsx("div",{className:"font-bold text-sm",children:"Medir Área"}),x.jsx("div",{className:"text-xs opacity-70",children:"Dibujar polígono"})]})]}),x.jsxs("div",{className:`border-2 rounded-lg transition-all ${m==="circle"?"bg-cyan-500/20 border-cyan-500":"bg-slate-800/50 border-slate-700"}`,children:[x.jsxs("button",{onClick:$,className:"w-full px-4 py-3 flex items-center space-x-3 text-left hover:bg-slate-800/30 transition-colors rounded-t-lg",children:[x.jsx(hF,{className:`w-5 h-5 ${m==="circle"?"text-cyan-400":"text-slate-300"}`}),x.jsxs("div",{className:"flex-1",children:[x.jsx("div",{className:`font-bold text-sm ${m==="circle"?"text-cyan-400":"text-slate-300"}`,children:"Círculo de Alcance"}),x.jsxs("div",{className:`text-xs ${m==="circle"?"text-cyan-400/70":"text-slate-400"}`,children:["Radio: ",S," km"]})]})]}),x.jsxs("div",{className:"px-4 pb-3 space-y-2",children:[x.jsx("input",{type:"range",min:"10",max:"6000",step:"50",value:S,onChange:ee=>C(parseInt(ee.target.value)),className:"w-full h-1 bg-cyan-500/20 rounded-lg appearance-none cursor-pointer accent-cyan-500"}),x.jsxs("div",{className:"flex justify-between text-[10px] text-cyan-400/60 font-mono",children:[x.jsx("span",{children:"10 km"}),x.jsx("span",{children:"6,000 km"})]}),x.jsx("div",{className:"text-xs text-cyan-400/70 text-center",children:S<500?"🎯 Corto alcance":S<1500?"🚀 Alcance medio":S<3500?"⚡ Largo alcance":"☢️ Intercontinental"})]})]}),x.jsxs("button",{onClick:W,className:"w-full px-4 py-3 rounded-lg border-2 border-red-500/30 bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:border-red-500 transition-all flex items-center space-x-3",children:[x.jsx(Sc,{className:"w-5 h-5"}),x.jsxs("div",{className:"text-left flex-1",children:[x.jsx("div",{className:"font-bold text-sm",children:"Limpiar Todo"}),x.jsx("div",{className:"text-xs opacity-70",children:"Borrar mediciones"})]})]})]}),s.length>0&&x.jsxs("div",{className:"border-t border-green-500/30 p-3",children:[x.jsx("div",{className:"text-green-400 text-xs font-bold uppercase tracking-wider mb-2",children:"📊 Resultados"}),x.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto modern-scrollbar",children:s.map((ee,ie)=>x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[ee.type==="distance"&&x.jsx(x.Fragment,{children:x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsx("span",{className:"text-green-400 text-xs font-bold",children:"📏 DISTANCIA"}),x.jsx("span",{className:"text-green-400 font-mono font-bold",children:ee.label})]})}),ee.type==="area"&&x.jsxs(x.Fragment,{children:[x.jsxs("div",{className:"flex items-center justify-between mb-1",children:[x.jsx("span",{className:"text-blue-400 text-xs font-bold",children:"📐 ÁREA"}),x.jsx("span",{className:"text-blue-400 font-mono font-bold",children:ee.label})]}),x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsx("span",{className:"text-blue-400/70 text-xs",children:"Perímetro:"}),x.jsx("span",{className:"text-blue-400/70 font-mono text-xs",children:ee.perimeterLabel})]})]})]},ee.id||ie))})]}),x.jsx("div",{className:"border-t border-green-500/20 p-3 bg-slate-800/30",children:x.jsxs("div",{className:"text-green-400/60 text-xs space-y-1",children:[x.jsxs("div",{children:["💡 ",x.jsx("strong",{children:"Línea/Polígono:"})," Click para agregar puntos"]}),x.jsxs("div",{children:["💡 ",x.jsx("strong",{children:"Enter:"})," Finalizar dibujo"]}),x.jsxs("div",{children:["💡 ",x.jsx("strong",{children:"Esc:"})," Cancelar"]}),x.jsxs("div",{children:["💡 ",x.jsx("strong",{children:"Delete:"})," Borrar seleccionado"]})]})})]})})}const Vd=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const s=Math.random()*16|0;return(r==="x"?s:s&3|8).toString(16)});function R8(){const[r,s]=Ne.useState([]),[c,m]=Ne.useState(!1),[v,S]=Ne.useState(null),C=Ne.useRef(Vd()),[o,L]=Ne.useState([]);Ne.useEffect(()=>{const ee=async()=>{try{const{data:ae,error:ke}=await yr.from("intelligence_events").select("*").order("detected_at",{ascending:!1}).limit(50);if(ke)throw ke;L(ae||[]),console.log(`📡 Grok cargó ${(ae==null?void 0:ae.length)||0} eventos del Intelligence Feed`)}catch(ae){console.error("Error cargando eventos para Grok:",ae)}};ee();const ie=yr.channel("grok_intelligence_events").on("postgres_changes",{event:"*",schema:"public",table:"intelligence_events"},()=>{ee()}).subscribe();return()=>{ie.unsubscribe()}},[]),Ne.useEffect(()=>{s([{id:Vd(),role:"assistant",content:`👋 Hola, soy Eva, tu analista de inteligencia. Pregúntame sobre:

• Actividad militar reciente en el Caribe
• Estado de tus entidades desplegadas
• Análisis de eventos detectados
• Búsqueda de información específica

¿En qué puedo ayudarte?`,timestamp:new Date().toISOString()}])},[]);const F=async(ee,ie={})=>{var ae,ke,le;try{m(!0),S(null);const se={id:Vd(),role:"user",content:ee,timestamp:new Date().toISOString()};s(Wt=>[...Wt,se]);const J={urgent:"🔴",high:"🟠",medium:"🟡",low:"🟢"},Ee=o.slice(0,20).map((Wt,fr)=>{const dr=new Date(Wt.detected_at).toLocaleDateString("es"),cr=J[Wt.priority]||"🟡";return`${fr+1}. ${cr} ${Wt.title}
   - Fuente: ${Wt.source_author||"Desconocida"}
   - Fecha: ${dr}
   - Estado: ${Wt.status}
   ${Wt.source_url?`   - Link: ${Wt.source_url}`:""}
   ${Wt.summary?`   - Resumen: ${Wt.summary.substring(0,150)}...`:""}`}).join(`

`),je={total:o.length,pending:o.filter(Wt=>Wt.status==="pending").length,urgent:o.filter(Wt=>Wt.priority==="urgent").length,twitter:o.filter(Wt=>Wt.source_type==="twitter").length},Xe=`Eres SAE - IA, un analista de inteligencia militar experto.

CONTEXTO DEL SISTEMA:
- Aplicación: Military Ops Tracker para región del Caribe
- Usuario está monitoreando: 41 entidades militares (destructores, aviones, tropas)
- Región: 10°N-25°N, 60°W-90°W (Caribe)
- Capacidades: Radar visual, medición de distancias, análisis geoespacial

📊 INTELLIGENCE FEED (últimos 50 eventos):
- Total eventos: ${je.total}
- Pendientes: ${je.pending}
- Urgentes: ${je.urgent}
- De X/Twitter: ${je.twitter}

${Ee?`🔍 EVENTOS RECIENTES DETECTADOS (Top 20):
${Ee}`:""}

${ie.entities?`ENTIDADES EN MAPA:
${ie.entities}`:""}

INSTRUCCIONES CRÍTICAS:
- Responde en español de forma conversacional pero profesional
- USA LA INFORMACIÓN DEL INTELLIGENCE FEED para responder preguntas sobre actividad reciente
- Si te preguntan sobre eventos recientes, busca en la lista de eventos

FORMATO DE RESPUESTAS:
- USA EMOJIS para prioridades: 🔴 Urgente, 🟠 Alta, 🟡 Media, 🟢 Baja
- NUNCA uses markdown (**, __, ##, etc.) - NO FUNCIONA
- Para énfasis usa MAYÚSCULAS o emojis
- AGREGA DOBLE SALTO DE LÍNEA entre cada punto numerado (1. evento

2. evento)
- Menciona números concretos (ej: "Hay 3 eventos urgentes sin revisar")

FORMATO DE LINKS:
- Cuando menciones un evento con link, escribe SOLO el link completo en una línea separada
- NO agregues texto extra al link (NO escribas "Ver fuente", solo el link)
- Ejemplo correcto: "Evento sobre Colombia
https://x.com/USNavy/status/123"
- Ejemplo INCORRECTO: "Ver fuente: https://..." (esto crea doble icono)

ESTILO:
- Usa emojis militares: 🚢 ✈️ 🎯 📡 ⚠️
- Si no sabes algo, di "No tengo información actualizada sobre eso"
- Sugiere acciones cuando sea relevante`,tt=r.slice(-10).map(Wt=>({role:Wt.role,content:Wt.content})),it=await fetch("https://api.x.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer xai-bxXyqO66hZivdUBxB8dNVb1dT3BorWkFq0OwdxzUrpD0Z4r9VrAErYNOSTC1trFIDCJHOGwGicLGMwA5"},body:JSON.stringify({model:"grok-2-1212",messages:[{role:"system",content:Xe},...tt,{role:"user",content:ee}],temperature:.7,max_tokens:1e3,stream:!1})});if(!it.ok){const Wt=await it.text();throw new Error(`Grok API error: ${it.status} - ${Wt}`)}const We=await it.json(),Ct=((ke=(ae=We.choices[0])==null?void 0:ae.message)==null?void 0:ke.content)||"Lo siento, no pude procesar tu solicitud.",Nt={id:Vd(),role:"assistant",content:Ct,timestamp:new Date().toISOString(),tokensUsed:((le=We.usage)==null?void 0:le.total_tokens)||0};return s(Wt=>[...Wt,Nt]),{success:!0,message:Ct}}catch(se){S(se.message),console.error("Error sending message to Grok:",se);const J={id:Vd(),role:"assistant",content:`⚠️ Error al comunicarme con Grok: ${se.message}

Intenta de nuevo o verifica la conexión.`,timestamp:new Date().toISOString(),isError:!0};return s(Ee=>[...Ee,J]),{success:!1,error:se.message}}finally{m(!1)}};return{messages:r,loading:c,error:v,sendMessage:F,clearChat:()=>{C.current=Vd(),s([{id:Vd(),role:"assistant",content:"✨ Nueva sesión iniciada. ¿En qué puedo ayudarte?",timestamp:new Date().toISOString()}])},askAboutEvent:async ee=>{const ie=`Analiza este evento de inteligencia y dame tu opinión:

Título: ${ee.title}
Resumen: ${ee.summary}
Fuente: ${ee.source_author||"Desconocida"}
Confianza: ${ee.confidence_score}%

¿Es creíble? ¿Qué acción recomiendas?`;return await F(ie,{event:ee})},askDeploymentStatus:async ee=>{const ie=`Tengo las siguientes entidades desplegadas en el Caribe:

${ee}

¿Puedes darme un resumen del estado actual y si hay algo que deba preocuparme?`;return await F(ie)},sessionId:C.current}}function L8(){const[r,s]=Ne.useState(!1),[c,m]=Ne.useState(""),[v,S]=Ne.useState(!1),C=Ne.useRef(null),o=Ne.useRef(null),{messages:L,loading:F,error:Z,sendMessage:$,clearChat:W}=R8(),ee=uR();Ne.useEffect(()=>{var le;(le=C.current)==null||le.scrollIntoView({behavior:"smooth"})},[L]),Ne.useEffect(()=>{o.current&&(o.current.style.height="auto",o.current.style.height=o.current.scrollHeight+"px")},[c]);const ie=async()=>{if(!c.trim()||F)return;const le=c.trim();m(""),await $(le)},ae=le=>{le.key==="Enter"&&!le.shiftKey&&(le.preventDefault(),ie())},ke=[{text:"¿Qué hay de nuevo?",query:"Revisa los eventos del Intelligence Feed y dime qué ha pasado en las últimas horas en el Caribe"},{text:"Eventos urgentes",query:"¿Hay eventos urgentes o pendientes que deba revisar ahora mismo?"},{text:"Resumen de hoy",query:"Dame un resumen de toda la actividad militar detectada hoy según los eventos del Intelligence Feed"}];return r?x.jsx("div",{className:`fixed z-50 transition-all duration-300 ${v?"bottom-4 right-4":"bottom-0 right-0 md:right-4 md:bottom-0 left-0 md:left-auto"}`,children:x.jsxs("div",{className:`bg-slate-900/95 border-2 border-red-500/30 backdrop-blur-xl shadow-2xl shadow-red-500/20 transition-all ${v?"w-80 h-16 rounded-2xl":"w-full md:w-[450px] h-screen md:h-[600px] md:rounded-t-2xl md:border-b-0"}`,children:[x.jsxs("div",{className:"px-3 md:px-4 py-2.5 md:py-3 border-b border-red-500/20 flex items-center justify-between bg-gradient-to-r from-slate-800 to-slate-900 md:rounded-t-2xl",children:[x.jsxs("div",{className:"flex items-center space-x-2 md:space-x-3",children:[x.jsxs("div",{className:"relative w-8 md:w-10 h-8 md:h-10 rounded-full overflow-hidden border-2 border-red-500/50 bg-gradient-to-br from-red-600 to-orange-600",children:[x.jsx("img",{src:"/eva-avatar.jpg",alt:"EVA - SAE IA",className:"w-full h-full object-cover"}),x.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-2 md:w-2.5 h-2 md:h-2.5 bg-green-500 rounded-full border-2 border-slate-900"})]}),x.jsxs("div",{children:[x.jsx("h3",{className:"text-red-300 font-bold text-xs md:text-sm",children:"SAE - IA"}),!v&&x.jsx("p",{className:"text-slate-400 text-[10px] md:text-xs",children:"Analista de Inteligencia • En línea"})]})]}),x.jsxs("div",{className:"flex items-center space-x-1",children:[ee>0&&x.jsx("div",{className:"px-2 py-1 bg-red-500/20 rounded-full border border-red-500/50",children:x.jsx("span",{className:"text-red-400 text-xs font-bold",children:ee})}),x.jsx("button",{onClick:()=>S(!v),className:"p-1.5 hover:bg-slate-700 rounded-lg transition-colors",title:v?"Maximizar":"Minimizar",children:v?x.jsx(FF,{className:"w-4 h-4 text-slate-400"}):x.jsx(UF,{className:"w-4 h-4 text-slate-400"})}),!v&&x.jsx("button",{onClick:W,className:"p-1.5 hover:bg-slate-700 rounded-lg transition-colors",title:"Nueva conversación",children:x.jsx(Sc,{className:"w-4 h-4 text-slate-400"})}),x.jsx("button",{onClick:()=>s(!1),className:"p-1.5 hover:bg-red-500/20 rounded-lg transition-colors",title:"Cerrar",children:x.jsx(En,{className:"w-4 h-4 text-red-400"})})]})]}),!v&&x.jsxs("div",{className:"flex flex-col h-[calc(100vh-64px)] md:h-[536px]",children:[x.jsxs("div",{className:"flex-1 overflow-y-auto p-3 md:p-4 space-y-3 modern-scrollbar",children:[L.map(le=>x.jsx("div",{className:`flex ${le.role==="user"?"justify-end":"justify-start"}`,children:x.jsxs("div",{className:`max-w-[90%] md:max-w-[85%] ${le.role==="user"?"bg-gradient-to-r from-red-600 to-orange-600 text-white":le.isError?"bg-red-900/30 border border-red-500/50 text-red-300":"bg-slate-800 text-slate-200 border border-slate-700/50"} rounded-lg px-3 md:px-4 py-2 md:py-2.5 shadow-lg`,children:[le.role==="assistant"&&x.jsxs("div",{className:"flex items-start space-x-2 mb-2",children:[x.jsx("div",{className:"w-6 h-6 rounded-full overflow-hidden border border-red-500/50 bg-gradient-to-br from-red-600 to-orange-600 flex-shrink-0",children:x.jsx("img",{src:"/eva-avatar.jpg",alt:"EVA - SAE IA",className:"w-full h-full object-cover"})}),x.jsx("span",{className:"text-red-400 text-xs font-bold",children:"SAE - IA"})]}),x.jsx("div",{className:"text-sm leading-relaxed space-y-1",children:le.content.split(`
`).map((se,J)=>{const Ee=/(https?:\/\/[^\s]+)/g,je=se.split(Ee);return x.jsx("div",{className:"break-words",children:je.map((Xe,tt)=>Xe.match(Ee)?x.jsx("a",{href:Xe,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center space-x-1 text-blue-400 hover:text-blue-300 underline font-semibold",children:x.jsx("span",{children:"🔗 Ver fuente"})},tt):x.jsx("span",{children:Xe},tt))},J)})}),x.jsx("div",{className:`text-xs mt-1.5 ${le.role==="user"?"text-orange-200":"text-slate-500"}`,children:new Date(le.timestamp).toLocaleTimeString("es",{hour:"2-digit",minute:"2-digit"})})]})},le.id)),F&&x.jsx("div",{className:"flex justify-start",children:x.jsx("div",{className:"bg-slate-800 border border-slate-700/50 rounded-lg px-4 py-3 shadow-lg",children:x.jsxs("div",{className:"flex items-center space-x-2",children:[x.jsx("div",{className:"w-5 h-5 rounded-full overflow-hidden border border-red-500/50 flex-shrink-0",children:x.jsx("img",{src:"/eva-avatar.jpg",alt:"EVA - SAE IA",className:"w-full h-full object-cover"})}),x.jsxs("div",{className:"flex space-x-1",children:[x.jsx("div",{className:"w-2 h-2 bg-red-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),x.jsx("div",{className:"w-2 h-2 bg-orange-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),x.jsx("div",{className:"w-2 h-2 bg-red-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),x.jsx("span",{className:"text-slate-400 text-xs",children:"SAE - IA está pensando..."})]})})}),L.length<=1&&x.jsxs("div",{className:"mt-4",children:[x.jsx("div",{className:"text-red-400/70 text-xs font-bold mb-2 md:mb-3",children:"💡 Preguntas rápidas:"}),x.jsx("div",{className:"flex flex-col gap-2",children:ke.map((le,se)=>x.jsx("button",{onClick:()=>{m(le.query),setTimeout(()=>ie(),100)},className:"px-3 md:px-4 py-2 md:py-2.5 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-xs md:text-sm text-red-300 transition-colors text-left",children:le.text},se))})]}),x.jsx("div",{ref:C})]}),x.jsxs("div",{className:"flex-shrink-0 p-2 md:p-3 border-t border-red-500/20 bg-slate-800/50",children:[x.jsxs("div",{className:"relative",children:[x.jsx("textarea",{ref:o,value:c,onChange:le=>m(le.target.value),onKeyPress:ae,placeholder:"Pregúntale a SAE - IA...",disabled:F,rows:1,className:"w-full bg-slate-900 border border-slate-700 rounded-lg pl-3 md:pl-4 py-2 md:py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-red-500/50 text-xs md:text-sm disabled:opacity-50 resize-none overflow-y-auto max-h-24 md:max-h-32 modern-scrollbar",style:{minHeight:"40px",paddingRight:"52px"}}),x.jsx("button",{onClick:ie,disabled:F||!c.trim(),className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center justify-center shadow-lg",title:"Enviar (Enter)",children:x.jsx(h4,{className:"w-4 h-4 text-white"})})]}),Z&&x.jsxs("div",{className:"mt-2 text-red-400 text-xs bg-red-900/20 border border-red-500/30 rounded px-3 py-2",children:["⚠️ ",Z]})]})]})]})}):x.jsxs("div",{className:"fixed bottom-4 right-4 z-50",children:[x.jsxs("button",{onClick:()=>s(!0),className:"relative w-16 h-16 bg-gradient-to-br from-red-600 to-orange-600 rounded-full shadow-2xl shadow-red-500/50 flex items-center justify-center hover:scale-110 transition-transform group overflow-hidden border-2 border-red-500/50",title:"SAE - IA Assistant",children:[x.jsx("img",{src:"/eva-avatar.jpg",alt:"EVA - SAE IA",className:"w-full h-full object-cover"}),x.jsx("div",{className:"absolute inset-0 rounded-full bg-red-500/30 animate-ping"})]}),ee>0&&x.jsx("div",{className:"absolute -top-2 -right-2 w-7 h-7 bg-red-500 rounded-full flex items-center justify-center border-2 border-slate-900 animate-bounce shadow-lg",children:x.jsx("span",{className:"text-white text-xs font-bold",children:ee})})]})}const O8={lessThanXSeconds:{one:"menos de un segundo",other:"menos de {{count}} segundos"},xSeconds:{one:"1 segundo",other:"{{count}} segundos"},halfAMinute:"medio minuto",lessThanXMinutes:{one:"menos de un minuto",other:"menos de {{count}} minutos"},xMinutes:{one:"1 minuto",other:"{{count}} minutos"},aboutXHours:{one:"alrededor de 1 hora",other:"alrededor de {{count}} horas"},xHours:{one:"1 hora",other:"{{count}} horas"},xDays:{one:"1 día",other:"{{count}} días"},aboutXWeeks:{one:"alrededor de 1 semana",other:"alrededor de {{count}} semanas"},xWeeks:{one:"1 semana",other:"{{count}} semanas"},aboutXMonths:{one:"alrededor de 1 mes",other:"alrededor de {{count}} meses"},xMonths:{one:"1 mes",other:"{{count}} meses"},aboutXYears:{one:"alrededor de 1 año",other:"alrededor de {{count}} años"},xYears:{one:"1 año",other:"{{count}} años"},overXYears:{one:"más de 1 año",other:"más de {{count}} años"},almostXYears:{one:"casi 1 año",other:"casi {{count}} años"}},D8=(r,s,c)=>{let m;const v=O8[r];return typeof v=="string"?m=v:s===1?m=v.one:m=v.other.replace("{{count}}",s.toString()),c!=null&&c.addSuffix?c.comparison&&c.comparison>0?"en "+m:"hace "+m:m},j8={full:"EEEE, d 'de' MMMM 'de' y",long:"d 'de' MMMM 'de' y",medium:"d MMM y",short:"dd/MM/y"},z8={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},F8={full:"{{date}} 'a las' {{time}}",long:"{{date}} 'a las' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},B8={date:vp({formats:j8,defaultWidth:"full"}),time:vp({formats:z8,defaultWidth:"full"}),dateTime:vp({formats:F8,defaultWidth:"full"})},U8={lastWeek:"'el' eeee 'pasado a la' p",yesterday:"'ayer a la' p",today:"'hoy a la' p",tomorrow:"'mañana a la' p",nextWeek:"eeee 'a la' p",other:"P"},V8={lastWeek:"'el' eeee 'pasado a las' p",yesterday:"'ayer a las' p",today:"'hoy a las' p",tomorrow:"'mañana a las' p",nextWeek:"eeee 'a las' p",other:"P"},$8=(r,s,c,m)=>s.getHours()!==1?V8[r]:U8[r],G8={narrow:["AC","DC"],abbreviated:["AC","DC"],wide:["antes de cristo","después de cristo"]},q8={narrow:["1","2","3","4"],abbreviated:["T1","T2","T3","T4"],wide:["1º trimestre","2º trimestre","3º trimestre","4º trimestre"]},H8={narrow:["e","f","m","a","m","j","j","a","s","o","n","d"],abbreviated:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],wide:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]},W8={narrow:["d","l","m","m","j","v","s"],short:["do","lu","ma","mi","ju","vi","sá"],abbreviated:["dom","lun","mar","mié","jue","vie","sáb"],wide:["domingo","lunes","martes","miércoles","jueves","viernes","sábado"]},Z8={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"mañana",afternoon:"tarde",evening:"tarde",night:"noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"mañana",afternoon:"tarde",evening:"tarde",night:"noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"mañana",afternoon:"tarde",evening:"tarde",night:"noche"}},X8={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"de la mañana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"de la mañana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"de la mañana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"}},Y8=(r,s)=>Number(r)+"º",K8={ordinalNumber:Y8,era:Il({values:G8,defaultWidth:"wide"}),quarter:Il({values:q8,defaultWidth:"wide",argumentCallback:r=>Number(r)-1}),month:Il({values:H8,defaultWidth:"wide"}),day:Il({values:W8,defaultWidth:"wide"}),dayPeriod:Il({values:Z8,defaultWidth:"wide",formattingValues:X8,defaultFormattingWidth:"wide"})},J8=/^(\d+)(º)?/i,Q8=/\d+/i,e$={narrow:/^(ac|dc|a|d)/i,abbreviated:/^(a\.?\s?c\.?|a\.?\s?e\.?\s?c\.?|d\.?\s?c\.?|e\.?\s?c\.?)/i,wide:/^(antes de cristo|antes de la era com[uú]n|despu[eé]s de cristo|era com[uú]n)/i},t$={any:[/^ac/i,/^dc/i],wide:[/^(antes de cristo|antes de la era com[uú]n)/i,/^(despu[eé]s de cristo|era com[uú]n)/i]},r$={narrow:/^[1234]/i,abbreviated:/^T[1234]/i,wide:/^[1234](º)? trimestre/i},i$={any:[/1/i,/2/i,/3/i,/4/i]},n$={narrow:/^[efmajsond]/i,abbreviated:/^(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)/i,wide:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i},s$={narrow:[/^e/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^en/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i]},o$={narrow:/^[dlmjvs]/i,short:/^(do|lu|ma|mi|ju|vi|s[áa])/i,abbreviated:/^(dom|lun|mar|mi[ée]|jue|vie|s[áa]b)/i,wide:/^(domingo|lunes|martes|mi[ée]rcoles|jueves|viernes|s[áa]bado)/i},a$={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^do/i,/^lu/i,/^ma/i,/^mi/i,/^ju/i,/^vi/i,/^sa/i]},l$={narrow:/^(a|p|mn|md|(de la|a las) (mañana|tarde|noche))/i,any:/^([ap]\.?\s?m\.?|medianoche|mediodia|(de la|a las) (mañana|tarde|noche))/i},c$={any:{am:/^a/i,pm:/^p/i,midnight:/^mn/i,noon:/^md/i,morning:/mañana/i,afternoon:/tarde/i,evening:/tarde/i,night:/noche/i}},u$={ordinalNumber:fR({matchPattern:J8,parsePattern:Q8,valueCallback:function(r){return parseInt(r,10)}}),era:Cl({matchPatterns:e$,defaultMatchWidth:"wide",parsePatterns:t$,defaultParseWidth:"any"}),quarter:Cl({matchPatterns:r$,defaultMatchWidth:"wide",parsePatterns:i$,defaultParseWidth:"any",valueCallback:r=>r+1}),month:Cl({matchPatterns:n$,defaultMatchWidth:"wide",parsePatterns:s$,defaultParseWidth:"any"}),day:Cl({matchPatterns:o$,defaultMatchWidth:"wide",parsePatterns:a$,defaultParseWidth:"any"}),dayPeriod:Cl({matchPatterns:l$,defaultMatchWidth:"any",parsePatterns:c$,defaultParseWidth:"any"})},sk={code:"es",formatDistance:D8,formatLong:B8,formatRelative:$8,localize:K8,match:u$,options:{weekStartsOn:1,firstWeekContainsDate:1}};function d$({event:r,onVerify:s,onDismiss:c,onViewOnMap:m,onAction:v,compact:S=!1}){var tt,it;const[C,o]=Ne.useState(!1),[L,F]=Ne.useState(!1),Z=!!r.translated_text;r.original_language;const $=Z&&!L?r.summary:r.full_content;Z&&!L?r.translated_text:r.full_content;const W={official:{bg:"bg-green-900/20",border:"border-green-500",text:"text-green-400",icon:Zo},verified:{bg:"bg-blue-900/20",border:"border-blue-500",text:"text-blue-400",icon:I_},unverified:{bg:"bg-yellow-900/20",border:"border-yellow-500",text:"text-yellow-400",icon:Qx},questionable:{bg:"bg-red-900/20",border:"border-red-500",text:"text-red-400",icon:En}},ee=W[r.source_credibility]||W.unverified,ie=ee.icon,ae={urgent:"border-l-4 border-l-red-500 bg-red-900/10",high:"border-l-4 border-l-orange-500 bg-orange-900/10",medium:"border-l-4 border-l-yellow-500 bg-yellow-900/10",low:"border-l-4 border-l-green-500 bg-green-900/10"},ke={pending:{text:"Pendiente",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/50"},verified:{text:"Verificado",color:"bg-green-500/20 text-green-400 border-green-500/50"},dismissed:{text:"Descartado",color:"bg-red-500/20 text-red-400 border-red-500/50"},actioned:{text:"Accionado",color:"bg-blue-500/20 text-blue-400 border-blue-500/50"}},le=ke[r.status]||ke.pending,se={military_strike:{text:"⚔️ Ataque Militar",color:"bg-red-500/20 text-red-400 border-red-500/50"},counter_narcotics:{text:"💊 Anti-Narcóticos",color:"bg-orange-500/20 text-orange-400 border-orange-500/50"},deployment:{text:"🚢 Despliegue",color:"bg-blue-500/20 text-blue-400 border-blue-500/50"},exercise:{text:"🎖️ Ejercicio",color:"bg-green-500/20 text-green-400 border-green-500/50"},announcement:{text:"📢 Anuncio",color:"bg-purple-500/20 text-purple-400 border-purple-500/50"},sighting:{text:"👁️ Avistamiento",color:"bg-cyan-500/20 text-cyan-400 border-cyan-500/50"},movement:{text:"📍 Movimiento",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/50"},news:{text:"📰 Noticia",color:"bg-slate-500/20 text-slate-400 border-slate-500/50"}},J=se[r.event_type]||se.news,Ee=uV(new Date(r.detected_at),{addSuffix:!0,locale:sk}),je=((tt=r.grok_analysis)==null?void 0:tt.image_url)||null,Xe=Ex(new Date(r.event_date),"d 'de' MMMM, yyyy 'a las' HH:mm",{locale:sk});return x.jsxs("div",{className:`
      ${ae[r.priority]||ae.medium}
      bg-slate-800/70 rounded-xl border border-slate-700/50 
      hover:border-purple-500/50 hover:shadow-xl hover:shadow-purple-500/10 
      transition-all duration-200 overflow-hidden
      ${S?"p-3":"p-5"}
    `,children:[x.jsx("div",{className:"flex items-start justify-between mb-2",children:x.jsxs("div",{className:"flex-1",children:[x.jsx("h4",{className:"text-white font-bold text-sm mb-1 leading-tight",children:r.title}),((it=r.grok_analysis)==null?void 0:it.series_count)&&x.jsxs("div",{className:"mb-1 inline-flex items-center space-x-1 px-2 py-0.5 bg-red-900/30 border border-red-500/50 rounded text-xs text-red-300 font-bold",children:[x.jsxs("span",{children:["#",r.grok_analysis.series_count]}),x.jsx("span",{children:r.grok_analysis.series_description||"evento de la serie"})]}),x.jsxs("div",{className:"text-slate-400 text-xs mb-2",children:["📅 ",Xe]}),x.jsxs("div",{className:"flex items-center flex-wrap gap-2 text-xs",children:[x.jsxs("div",{className:"flex items-center space-x-1 text-slate-400",children:[x.jsx(wN,{className:"w-3 h-3"}),x.jsx("span",{children:Ee})]}),x.jsxs("div",{className:`flex items-center space-x-1 px-2 py-0.5 ${ee.bg} border ${ee.border} rounded-full ${ee.text}`,children:[x.jsx(ie,{className:"w-3 h-3"}),x.jsx("span",{className:"font-bold capitalize",children:r.source_credibility})]}),x.jsx("div",{className:`px-2 py-0.5 border rounded-full ${J.color} text-xs font-bold`,children:J.text}),x.jsx("div",{className:`px-2 py-0.5 border rounded-full ${le.color} text-xs font-bold`,children:le.text}),x.jsxs("div",{className:"flex items-center space-x-1",children:[x.jsx("div",{className:"w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden",children:x.jsx("div",{className:`h-full ${r.confidence_score>=80?"bg-green-500":r.confidence_score>=60?"bg-yellow-500":"bg-red-500"}`,style:{width:`${r.confidence_score}%`}})}),x.jsxs("span",{className:"text-slate-400 text-xs",children:[r.confidence_score,"%"]})]})]})]})}),x.jsxs("div",{className:"mb-3",children:[x.jsx("p",{className:"text-slate-300 text-sm leading-relaxed mb-2",children:$}),Z&&x.jsxs("button",{onClick:()=>F(!L),className:"flex items-center space-x-1.5 text-xs text-purple-400 hover:text-purple-300 transition-colors group",children:[x.jsx(PF,{className:"w-3.5 h-3.5 group-hover:scale-110 transition-transform"}),x.jsx("span",{children:L?"🇪🇸 Ver traducción":"🇺🇸 Ver original"})]})]}),je&&!C&&x.jsx("div",{className:"mb-3 rounded-xl overflow-hidden border border-slate-700/50",children:x.jsx("img",{src:je,alt:r.title,onError:()=>o(!0),className:"w-full h-auto object-cover max-h-96"})}),r.mentioned_entities&&r.mentioned_entities.length>0&&x.jsxs("div",{className:"mb-3 flex items-center flex-wrap gap-1.5",children:[x.jsx("span",{className:"text-xs text-slate-400",children:"🎯 Menciona:"}),r.mentioned_entities.slice(0,3).map((We,Ct)=>x.jsx("span",{className:"px-2 py-0.5 bg-purple-500/20 border border-purple-500/40 rounded text-xs text-purple-300 font-mono",children:We},Ct)),r.mentioned_entities.length>3&&x.jsxs("span",{className:"text-xs text-slate-500",children:["+",r.mentioned_entities.length-3," más"]})]}),r.location_description&&x.jsxs("div",{className:"mb-3 flex items-center space-x-2 text-sm",children:[x.jsx(ju,{className:"w-4 h-4 text-cyan-400"}),x.jsx("span",{className:"text-cyan-400",children:r.location_description}),r.location_confidence&&x.jsxs("span",{className:"text-slate-500 text-xs",children:["(",r.location_confidence,"%)"]})]}),r.source_author&&x.jsxs("div",{className:"mb-3 flex items-center space-x-2 text-xs text-slate-400",children:[x.jsx(A4,{className:"w-3 h-3"}),x.jsx("span",{children:r.source_author}),r.source_url&&x.jsxs("a",{href:r.source_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center space-x-1 text-purple-400 hover:text-purple-300 transition-colors",children:[x.jsx(xF,{className:"w-3 h-3"}),x.jsx("span",{children:"Ver fuente"})]})]}),r.status==="pending"&&!S&&x.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-slate-700/50",children:[x.jsxs("button",{onClick:()=>s(r.id),className:"px-3 py-2 bg-green-600/20 hover:bg-green-600/30 border border-green-500/50 rounded-lg text-green-400 text-xs font-bold transition-colors flex items-center justify-center space-x-1",children:[x.jsx(I_,{className:"w-4 h-4"}),x.jsx("span",{children:"Verificar"})]}),x.jsxs("button",{onClick:()=>c(r.id),className:"px-3 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-500/50 rounded-lg text-red-400 text-xs font-bold transition-colors flex items-center justify-center space-x-1",children:[x.jsx(En,{className:"w-4 h-4"}),x.jsx("span",{children:"Descartar"})]})]}),r.status==="actioned"&&r.action_taken&&x.jsx("div",{className:"mt-3 pt-3 border-t border-slate-700/50",children:x.jsxs("div",{className:"text-xs text-blue-400 bg-blue-900/20 border border-blue-500/30 rounded px-3 py-2",children:[x.jsx("span",{className:"font-bold",children:"✅ Acción:"})," ",r.action_taken]})}),r.notes&&x.jsxs("div",{className:"mt-2 text-xs text-slate-400 italic bg-slate-900/50 rounded px-3 py-2",children:["📝 ",r.notes]})]})}function h$({onClose:r,onEventAdded:s}){const[c,m]=Ne.useState(""),[v,S]=Ne.useState(""),[C,o]=Ne.useState(""),[L,F]=Ne.useState(!1),[Z,$]=Ne.useState(null),[W,ee]=Ne.useState(null),[ie,ae]=Ne.useState(!1),[ke,le]=Ne.useState(null);Ne.useEffect(()=>{if(!c||c.length<15)return;const tt=setTimeout(()=>{se(c)},1e3);return()=>clearTimeout(tt)},[c]);const se=async tt=>{var We,Ct;if(!tt||tt.length<10){ee(null);return}if(!(tt.includes("twitter.com")||tt.includes("x.com"))){console.log("ℹ️ URL no es de X/Twitter, saltando preview automático"),ae(!1);return}try{ae(!0);const dr=await(await fetch("https://oqhujdqbszbvozsuunkw.supabase.co/functions/v1/fetch-tweet-content",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xaHVqZHFic3pidm96c3V1bmt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjY1NDYsImV4cCI6MjA3NjIwMjU0Nn0.Rd0GMUcx1J_UCzwfzW0csZPjjppzp0o64g5nggKq9GM"},body:JSON.stringify({url:tt})})).json();if(dr.success&&dr.tweet){const cr=dr.tweet;if(((We=cr.media)!=null&&We.url||(Ct=cr.media)!=null&&Ct.preview_url)&&ee(cr.media.url||cr.media.preview_url),!v&&cr.text){const Ut=cr.text.length>100?cr.text.substring(0,100)+"...":cr.text;S(Ut)}!C&&cr.text&&o(cr.text),console.log("✅ Tweet cargado:",cr)}else console.error("❌ Error:",dr.error),$(dr.error||"No se pudo obtener el contenido del tweet")}catch(Nt){console.error("Error fetching preview:",Nt),$("Error al conectar con X API")}finally{ae(!1)}},J=tt=>{var Ct;const it=(Ct=tt.target.files)==null?void 0:Ct[0];if(!it)return;if(!it.type.startsWith("image/")){$("Solo se permiten archivos de imagen");return}if(it.size>5*1024*1024){$("La imagen no debe superar 5MB");return}le(it);const We=new FileReader;We.onload=Nt=>{ee(Nt.target.result)},We.readAsDataURL(it),console.log("✅ Imagen cargada:",it.name)},Ee=async tt=>{if(tt.preventDefault(),!c&&!v){$("Debes proporcionar al menos una URL o un título");return}try{F(!0),$(null),c?await je():await Xe(),s==null||s(),r()}catch(it){$(it.message)}finally{F(!1)}},je=async()=>{var xr,Rt,rr;const it=await fetch("https://api.x.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer xai-bxXyqO66hZivdUBxB8dNVb1dT3BorWkFq0OwdxzUrpD0Z4r9VrAErYNOSTC1trFIDCJHOGwGicLGMwA5"},body:JSON.stringify({model:"grok-2-1212",messages:[{role:"system",content:"You are a military intelligence analyst. Respond ONLY with valid JSON."},{role:"user",content:`Analyze this military tweet and translate to Spanish:

Tweet: "${C||v||""}"

Extract and translate to Spanish (keep proper nouns in English like USS Iwo Jima):
{
  "title": "Spanish title",
  "summary": "Spanish summary (2-3 sentences)",
  "translated_text": "Full Spanish translation",
  "original_language": "en",
  "event_type": "news",
  "priority": "high",
  "mentioned_entities": ["USS Iwo Jima"],
  "suggested_location": {"lat": 18.0, "lng": -66.0},
  "location_description": "Spanish location",
  "confidence_score": 85,
  "keywords": ["Spanish", "keywords"],
  "sentiment": "neutral"
}

IMPORTANT:
- event_type MUST be one of: sighting, news, exercise, announcement, deployment, movement, military_strike, counter_narcotics
- priority MUST be one of: low, medium, high, urgent

Respond with ONLY the JSON, no markdown.`}],temperature:.2,max_tokens:1500})});if(!it.ok){const Nr=await it.json();throw console.error("❌ Grok API error:",Nr),new Error(`Grok API error: ${((xr=Nr.error)==null?void 0:xr.message)||it.statusText}`)}const Ct=((rr=(Rt=(await it.json()).choices[0])==null?void 0:Rt.message)==null?void 0:rr.content)||"{}";console.log("🤖 Grok response:",Ct);const Nt=Ct.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),Wt=JSON.parse(Nt),dr=["sighting","news","exercise","announcement","deployment","movement","military_strike","counter_narcotics"].includes(Wt.event_type)?Wt.event_type:"news",Ut=["low","medium","high","urgent"].includes(Wt.priority)?Wt.priority:"medium";let jr=null;Wt.suggested_location&&(jr=`POINT(${Wt.suggested_location.lng} ${Wt.suggested_location.lat})`);const{error:Ht}=await yr.from("intelligence_events").insert({detected_at:new Date().toISOString(),event_date:new Date().toISOString(),event_type:dr,priority:Ut,title:Wt.title,summary:Wt.summary,full_content:C||v||c,translated_text:Wt.translated_text||null,original_language:Wt.original_language||"en",source_type:c.includes("twitter.com")||c.includes("x.com")?"twitter":"news",source_url:c,source_author:"Manual (Usuario)",source_credibility:"unverified",mentioned_entities:Wt.mentioned_entities||[],suggested_location:jr,location_confidence:Wt.location_confidence,location_description:Wt.location_description,grok_analysis:{model:"grok-2-1212",analyzed_manually:!0,auto_translated:!!Wt.translated_text,image_url:W,uploaded_manually:!!ke},confidence_score:Wt.confidence_score||70,keywords:Wt.keywords||[],sentiment:Wt.sentiment||"neutral",status:"pending"});if(Ht)throw Ht},Xe=async()=>{const{error:tt}=await yr.from("intelligence_events").insert({detected_at:new Date().toISOString(),event_date:new Date().toISOString(),event_type:"news",priority:"medium",title:v,summary:C||v,full_content:c||null,source_type:c&&(c.includes("twitter.com")||c.includes("x.com"))?"twitter":"news",source_url:c||null,source_author:"Manual (Usuario)",source_credibility:"unverified",mentioned_entities:[],grok_analysis:{manually_created:!0,image_url:W,uploaded_manually:!!ke},confidence_score:50,keywords:[],sentiment:"neutral",status:"pending"});if(tt)throw tt};return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:r}),x.jsxs("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-slate-900 border-2 border-purple-500/50 rounded-2xl shadow-2xl z-50 p-6",children:[x.jsxs("div",{className:"flex items-center justify-between mb-6",children:[x.jsxs("div",{className:"flex items-center space-x-3",children:[x.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl flex items-center justify-center",children:x.jsx(lh,{className:"w-6 h-6 text-white"})}),x.jsxs("div",{children:[x.jsx("h2",{className:"text-white font-bold text-xl",children:"Agregar Evento Manual"}),x.jsx("p",{className:"text-slate-400 text-sm",children:"Pega URL de tweet/noticia o crea evento propio"})]})]}),x.jsx("button",{onClick:r,className:"p-2 hover:bg-slate-800 rounded-lg transition-colors",children:x.jsx(En,{className:"w-5 h-5 text-slate-400"})})]}),x.jsxs("form",{onSubmit:Ee,className:"space-y-4",children:[x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-bold text-slate-300 mb-2",children:"🔗 URL de la fuente (opcional)"}),x.jsxs("div",{className:"flex space-x-2",children:[x.jsxs("div",{className:"relative flex-1",children:[x.jsx(oP,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500"}),x.jsx("input",{type:"url",value:c,onChange:tt=>m(tt.target.value),placeholder:"https://x.com/... o https://defensenews.com/... (opcional)",className:"w-full pl-11 pr-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),x.jsx("button",{type:"button",onClick:()=>se(c),disabled:!c||ie,className:"px-4 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 rounded-lg text-white font-bold transition-colors flex items-center space-x-2",children:ie?x.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):x.jsxs(x.Fragment,{children:[x.jsx(oP,{className:"w-4 h-4"}),x.jsx("span",{children:"Preview"})]})})]}),ie&&x.jsxs("div",{className:"text-blue-400 text-xs mt-1 flex items-center space-x-1",children:[x.jsx("div",{className:"w-3 h-3 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"}),x.jsx("span",{children:"Extrayendo metadata de la URL..."})]}),!ie&&c&&x.jsx("div",{className:"text-slate-500 text-xs mt-1",children:W?"✅ Imagen cargada":'Preview automático en 1 segundo o click "Preview"'})]}),W&&x.jsxs("div",{className:"rounded-lg overflow-hidden border-2 border-purple-500/50",children:[x.jsx("img",{src:W,alt:"Preview",className:"w-full h-auto max-h-64 object-cover",onError:()=>ee(null)}),x.jsxs("div",{className:"bg-slate-800/50 px-3 py-2 flex items-center justify-between",children:[x.jsxs("span",{className:"text-green-400 text-xs font-bold",children:["✅ ",ke?`Imagen subida: ${ke.name}`:"Imagen detectada"]}),x.jsx("button",{type:"button",onClick:()=>{ee(null),le(null)},className:"text-red-400 hover:text-red-300 text-xs",children:"Quitar"})]})]}),!W&&x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-bold text-slate-300 mb-2",children:"🖼️ O sube una imagen manualmente"}),x.jsxs("div",{className:"relative",children:[x.jsx("input",{type:"file",accept:"image/*",onChange:J,className:"hidden",id:"image-upload"}),x.jsxs("label",{htmlFor:"image-upload",className:"w-full px-4 py-3 bg-slate-800 border-2 border-dashed border-slate-700 hover:border-purple-500 rounded-lg text-slate-400 hover:text-white cursor-pointer transition-colors flex items-center justify-center space-x-2",children:[x.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:x.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),x.jsx("span",{children:"Click para subir imagen (máx. 5MB)"})]})]}),x.jsx("p",{className:"text-slate-500 text-xs mt-1",children:"Formatos: JPG, PNG, GIF, WebP"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-bold text-slate-300 mb-2",children:"📝 Título del evento (opcional si tienes URL)"}),x.jsx("input",{type:"text",value:v,onChange:tt=>S(tt.target.value),placeholder:"Ej: Lanchas explosivas detectadas en el Caribe",className:"w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"})]}),x.jsxs("div",{children:[x.jsx("label",{className:"block text-sm font-bold text-slate-300 mb-2",children:"📄 Resumen (opcional)"}),x.jsx("textarea",{value:C,onChange:tt=>o(tt.target.value),placeholder:"Describe el evento en 2-3 oraciones...",rows:3,className:"w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"})]}),Z&&x.jsxs("div",{className:"flex items-center space-x-2 p-3 bg-red-900/20 border border-red-500/50 rounded-lg",children:[x.jsx(z_,{className:"w-5 h-5 text-red-400"}),x.jsx("span",{className:"text-red-400 text-sm",children:Z})]}),x.jsxs("div",{className:"flex space-x-3",children:[x.jsx("button",{type:"button",onClick:r,className:"flex-1 px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-white font-bold transition-colors",children:"Cancelar"}),x.jsx("button",{type:"submit",disabled:L||!c&&!v,className:"flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 disabled:from-slate-700 disabled:to-slate-700 rounded-lg text-white font-bold transition-all shadow-lg disabled:shadow-none flex items-center justify-center space-x-2",children:L?x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),x.jsx("span",{children:"Analizando..."})]}):x.jsxs(x.Fragment,{children:[x.jsx(lh,{className:"w-5 h-5"}),x.jsx("span",{children:"Agregar Evento"})]})})]}),x.jsx("div",{className:"mt-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg",children:x.jsxs("p",{className:"text-blue-300 text-xs leading-relaxed",children:["💡 ",x.jsx("strong",{children:"Tres formas de agregar eventos:"}),x.jsx("br",{}),"1️⃣ ",x.jsx("strong",{children:"Link de X/Twitter:"})," Análisis automático con Grok + traducción al español",x.jsx("br",{}),"2️⃣ ",x.jsx("strong",{children:"Link de otra web:"})," Escribe título y resumen manualmente + sube imagen",x.jsx("br",{}),"3️⃣ ",x.jsx("strong",{children:"Evento propio:"})," Sin URL, solo título, resumen e imagen manual"]})})]})]})]})}function f$({onClose:r,map:s}){const[c,m]=Ne.useState("all"),[v,S]=Ne.useState("all"),[C,o]=Ne.useState("all"),[L,F]=Ne.useState("all"),[Z,$]=Ne.useState("all"),[W,ee]=Ne.useState(""),[ie,ae]=Ne.useState(!1),[ke,le]=Ne.useState(!1),[se,J]=Ne.useState(!1),[Ee,je]=Ne.useState(null),Xe={};c!=="all"&&(Xe.status=c),v!=="all"&&(Xe.priority=v),C!=="all"&&(Xe.event_type=C);const{events:tt,loading:it,error:We,refetch:Ct,verifyEvent:Nt,dismissEvent:Wt,markAsActioned:fr,runXMonitor:dr}=ZU(Xe),cr=Ne.useMemo(()=>{let Rt=tt;if(L==="twitter_auto"?Rt=Rt.filter(rr=>{var Nr;return rr.source_type==="twitter"&&!((Nr=rr.source_author)!=null&&Nr.includes("Manual"))}):L==="twitter_manual"&&(Rt=Rt.filter(rr=>{var Nr;return rr.source_type==="twitter"&&((Nr=rr.source_author)==null?void 0:Nr.includes("Manual"))})),Z!=="all"){const rr=new Date,Nr=new Date;switch(Z){case"7d":Nr.setDate(rr.getDate()-7);break;case"30d":Nr.setDate(rr.getDate()-30);break;case"90d":Nr.setDate(rr.getDate()-90);break}Rt=Rt.filter(Un=>new Date(Un.event_date)>=Nr)}return W&&(Rt=Rt.filter(rr=>{var Nr;return rr.title.toLowerCase().includes(W.toLowerCase())||rr.summary.toLowerCase().includes(W.toLowerCase())||((Nr=rr.mentioned_entities)==null?void 0:Nr.some(Un=>Un.toLowerCase().includes(W.toLowerCase())))})),Rt},[tt,Z,W,L]),Ut=async Rt=>await Nt(Rt),jr=async Rt=>await Wt(Rt),Ht=Rt=>{if(Rt.suggested_location&&s){const{lat:rr,lng:Nr}=Rt.suggested_location;s.flyTo({center:[Nr,rr],zoom:7,duration:2e3}),r()}},xr=async()=>{J(!0),je(null);try{const Rt=await dr();je({type:"twitter",success:Rt.success,stats:Rt.stats,error:Rt.error,message:Rt.message}),Rt.success&&setTimeout(()=>Ct(),2e3)}catch(Rt){je({type:"twitter",success:!1,error:Rt.message})}finally{J(!1)}};return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:"fixed inset-0 z-50 bg-black/60 backdrop-blur-sm",onClick:r}),x.jsxs("div",{className:"fixed top-0 right-0 h-full w-full max-w-3xl z-50 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 shadow-2xl border-l border-red-500/30 flex flex-col animate-slide-in-right",children:[x.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-red-500/20 bg-gradient-to-r from-slate-800 to-slate-900 backdrop-blur-sm",children:[x.jsxs("div",{className:"flex items-center space-x-2 flex-1",children:[x.jsx("div",{className:"p-1.5 bg-gradient-to-br from-red-600 to-orange-600 rounded-lg shadow-lg",children:x.jsx(PN,{className:"w-4 h-4 text-white"})}),x.jsxs("div",{className:"flex-1",children:[x.jsx("h2",{className:"text-base font-bold text-red-300",children:"SAE - Feed de Inteligencia"}),x.jsx("p",{className:"text-[10px] text-slate-400",children:"🌐 Traducción automática • Cache inteligente"})]})]}),x.jsxs("div",{className:"flex items-center space-x-3 mr-3",children:[x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:"text-xs text-slate-400",children:L==="all"?"Total":L==="twitter_auto"?"🤖 X Auto":"✍️ Manual"}),x.jsx("div",{className:"text-sm font-bold text-white",children:cr.length})]}),x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:"text-xs text-yellow-400",children:"Pendientes"}),x.jsx("div",{className:"text-sm font-bold text-yellow-400",children:cr.filter(Rt=>Rt.status==="pending").length})]}),x.jsxs("div",{className:"text-center",children:[x.jsx("div",{className:"text-xs text-green-400",children:"Verificados"}),x.jsx("div",{className:"text-sm font-bold text-green-400",children:cr.filter(Rt=>Rt.status==="verified").length})]})]}),x.jsx("button",{onClick:r,className:"p-1.5 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-white",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsxs("div",{className:"px-4 py-2 border-b border-slate-700/50 bg-slate-800/30",children:[x.jsx("div",{className:"flex items-center space-x-2 mb-3",children:[{value:"all",label:"📊 Todos"},{value:"twitter_auto",label:"🤖 X Auto"},{value:"twitter_manual",label:"✍️ Manual"}].map(Rt=>x.jsx("button",{onClick:()=>F(Rt.value),className:`flex-1 px-3 py-2 rounded-lg text-xs font-bold transition-all ${L===Rt.value?"bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg":"bg-slate-700/50 text-slate-300 hover:bg-slate-700"}`,children:Rt.label},Rt.value))}),x.jsxs("div",{className:"flex items-center space-x-1 mb-2",children:[[{value:"all",label:"Todos",icon:"∞"},{value:"7d",label:"Últimos 7d"},{value:"30d",label:"Últimos 30d"},{value:"90d",label:"Últimos 90d"}].map(Rt=>x.jsxs("button",{onClick:()=>$(Rt.value),className:`px-2 py-1 rounded-lg text-[10px] font-bold transition-all ${Z===Rt.value?"bg-red-600 text-white":"bg-slate-700/50 text-slate-300 hover:bg-slate-700"}`,children:[Rt.icon||""," ",Rt.label]},Rt.value)),x.jsxs("button",{onClick:()=>le(!ke),className:`ml-auto px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center space-x-1 ${ke?"bg-red-600 text-white":"bg-slate-700/50 text-slate-300 hover:bg-slate-700"}`,children:[x.jsx(x2,{className:"w-3 h-3"}),x.jsx("span",{children:"Filtros"}),x.jsx(Ap,{className:`w-3 h-3 transition-transform ${ke?"rotate-180":""}`})]})]}),ke&&x.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-2",children:[x.jsxs("select",{value:c,onChange:Rt=>m(Rt.target.value),className:"px-2 py-1.5 bg-slate-900 border border-slate-700 rounded text-white text-xs",children:[x.jsx("option",{value:"all",children:"Todos"}),x.jsx("option",{value:"pending",children:"Pendientes"}),x.jsx("option",{value:"verified",children:"Verificados"}),x.jsx("option",{value:"dismissed",children:"Descartados"})]}),x.jsxs("select",{value:v,onChange:Rt=>S(Rt.target.value),className:"px-2 py-1.5 bg-slate-900 border border-slate-700 rounded text-white text-xs",children:[x.jsx("option",{value:"all",children:"Todas"}),x.jsx("option",{value:"urgent",children:"🔴 Urgente"}),x.jsx("option",{value:"high",children:"🟠 Alta"}),x.jsx("option",{value:"medium",children:"🟡 Media"}),x.jsx("option",{value:"low",children:"🟢 Baja"})]}),x.jsxs("select",{value:C,onChange:Rt=>o(Rt.target.value),className:"px-2 py-1.5 bg-slate-900 border border-slate-700 rounded text-white text-xs",children:[x.jsx("option",{value:"all",children:"Todos"}),x.jsx("option",{value:"military_strike",children:"⚔️ Ataques"}),x.jsx("option",{value:"counter_narcotics",children:"💊 Anti-Narco"}),x.jsx("option",{value:"deployment",children:"🚢 Despliegues"}),x.jsx("option",{value:"exercise",children:"🎖️ Ejercicios"})]})]}),x.jsxs("div",{className:"relative mb-2",children:[x.jsx(Pp,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500"}),x.jsx("input",{type:"text",value:W,onChange:Rt=>ee(Rt.target.value),placeholder:"Buscar eventos...",className:"w-full pl-8 pr-3 py-1.5 bg-slate-900 border border-slate-700 rounded text-white placeholder-slate-500 text-xs"})]}),L==="twitter_auto"&&x.jsxs("div",{className:"mb-2",children:[x.jsx("button",{onClick:xr,disabled:se,className:"w-full px-4 py-2.5 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 disabled:from-slate-700 disabled:to-slate-700 rounded-lg text-white text-sm font-bold transition-all flex items-center justify-center space-x-2 disabled:opacity-50 shadow-lg relative overflow-hidden",children:se?x.jsxs(x.Fragment,{children:[x.jsx(Wd,{className:"w-5 h-5 animate-spin"}),x.jsx("span",{children:"Ejecutando Monitor..."}),x.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-shimmer"})]}):x.jsxs(x.Fragment,{children:[x.jsx(r4,{className:"w-4 h-4"}),x.jsx("span",{children:"🐦 Ejecutar Monitor de X (Twitter)"})]})}),x.jsx("p",{className:"text-[10px] text-slate-400 text-center mt-1.5",children:"🌐 Traducción automática al español • Cuentas oficiales del DoD"})]}),L==="twitter_manual"&&x.jsxs("div",{className:"mb-2",children:[x.jsxs("button",{onClick:()=>ae(!0),className:"w-full px-4 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 rounded-lg text-white text-sm font-bold transition-all flex items-center justify-center space-x-2 shadow-lg",children:[x.jsx(lh,{className:"w-4 h-4"}),x.jsx("span",{children:"✍️ Agregar Evento Manual"})]}),x.jsx("p",{className:"text-[10px] text-slate-400 text-center mt-1.5",children:"Ingresa eventos de inteligencia manualmente"})]})]}),x.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3 space-y-3 modern-scrollbar",children:it&&tt.length===0?x.jsxs("div",{className:"flex flex-col items-center justify-center h-full space-y-2",children:[x.jsx(f1,{className:"w-8 h-8 text-purple-400 animate-spin"}),x.jsx("p",{className:"text-slate-400 text-sm",children:"Cargando..."})]}):We?x.jsxs("div",{className:"flex flex-col items-center justify-center h-full space-y-2",children:[x.jsx(z_,{className:"w-8 h-8 text-red-400"}),x.jsx("p",{className:"text-red-400 text-sm",children:We})]}):cr.length===0?x.jsxs("div",{className:"flex flex-col items-center justify-center h-full space-y-2",children:[x.jsx(x2,{className:"w-8 h-8 text-slate-600"}),x.jsx("p",{className:"text-slate-400 text-sm",children:"No hay eventos"})]}):x.jsxs(x.Fragment,{children:[x.jsxs("div",{className:"text-slate-400 text-xs mb-2",children:["Mostrando ",x.jsx("span",{className:"text-white font-bold",children:cr.length})," de ",tt.length]}),cr.map(Rt=>x.jsx(d$,{event:Rt,onVerify:Ut,onDismiss:jr,onViewOnMap:Ht,onAction:rr=>fr(Rt.id,rr),compact:!1},Rt.id))]})}),x.jsx("div",{className:"px-4 py-2 border-t border-slate-700/50 bg-slate-800/50 text-xs text-slate-400",children:x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsx("span",{children:"🔄 Actualización automática cada 6h"}),x.jsxs("button",{onClick:Ct,className:"text-purple-400 hover:text-purple-300 flex items-center space-x-1",children:[x.jsx(f1,{className:"w-3 h-3"}),x.jsx("span",{children:"Actualizar"})]})]})})]}),ie&&x.jsx(h$,{onClose:()=>ae(!1),onEventAdded:()=>{ae(!1),Ct()}}),Ee&&x.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",children:[x.jsx("div",{className:"absolute inset-0 bg-black/80 backdrop-blur-sm",onClick:()=>je(null)}),x.jsxs("div",{className:"relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl shadow-2xl border-2 max-w-md w-full mx-4 overflow-hidden animate-scale-in",style:{borderColor:Ee.success?"#10b981":"#ef4444"},children:[x.jsxs("div",{className:`px-6 py-4 flex items-center gap-4 ${Ee.success?"bg-gradient-to-r from-green-600/20 to-emerald-600/20 border-b border-green-500/30":"bg-gradient-to-r from-red-600/20 to-orange-600/20 border-b border-red-500/30"}`,children:[Ee.success?x.jsx("div",{className:"w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center",children:x.jsx(DS,{className:"w-7 h-7 text-green-400"})}):x.jsx("div",{className:"w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center",children:x.jsx(bN,{className:"w-7 h-7 text-red-400"})}),x.jsxs("div",{className:"flex-1",children:[x.jsx("h3",{className:"text-lg font-bold text-white",children:Ee.success?"✅ Monitor Ejecutado":"❌ Error en Monitor"}),x.jsx("p",{className:"text-sm text-slate-400",children:Ee.type==="twitter"?"🐦 X (Twitter)":"📰 RSS Feeds"})]}),x.jsx("button",{onClick:()=>je(null),className:"text-slate-400 hover:text-white transition-colors",children:x.jsx(En,{className:"w-5 h-5"})})]}),x.jsx("div",{className:"px-6 py-6",children:Ee.success?x.jsxs("div",{className:"space-y-4",children:[Ee.type==="twitter"&&Ee.stats&&x.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("div",{className:"text-2xl font-bold text-cyan-400",children:Ee.stats.tweets_found||0}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Tweets"})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("div",{className:"text-2xl font-bold text-green-400",children:Ee.stats.tweets_new||0}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Nuevos"})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("div",{className:"text-2xl font-bold text-purple-400",children:Ee.stats.events_created||0}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Eventos"})]}),Ee.stats.events_duplicate>0&&x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-yellow-700/50",children:[x.jsx("div",{className:"text-2xl font-bold text-yellow-400",children:Ee.stats.events_duplicate}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Duplicados"})]})]}),Ee.type==="rss"&&Ee.stats&&x.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("div",{className:"text-2xl font-bold text-orange-400",children:Ee.stats.articles_processed||0}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Artículos"})]}),x.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700",children:[x.jsx("div",{className:"text-2xl font-bold text-green-400",children:Ee.stats.events_created||0}),x.jsx("div",{className:"text-xs text-slate-400 mt-1",children:"Eventos"})]})]}),Ee.message&&x.jsx("div",{className:"bg-slate-800/30 rounded-lg p-3 border border-slate-700",children:x.jsx("p",{className:"text-sm text-slate-300",children:Ee.message})}),x.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-400",children:[x.jsx(f1,{className:"w-3 h-3 animate-spin"}),x.jsx("span",{children:"Actualizando lista de eventos..."})]})]}):x.jsx("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4",children:x.jsx("p",{className:"text-red-300 text-sm",children:Ee.error||"Error desconocido"})})}),x.jsx("div",{className:"px-6 py-4 bg-slate-800/30 border-t border-slate-700 flex justify-end",children:x.jsx("button",{onClick:()=>je(null),className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium text-sm",children:"Cerrar"})})]})]})]})}function p$(){const[r,s]=Ne.useState(!1),[c,m]=Ne.useState(null);async function v(C){try{s(!0),m(null);const o=`POINT(${C.longitude} ${C.latitude})`,L={name:C.name,class:C.code||C.class||null,type:C.type,status:C.status||"activo",position:o,heading:C.heading||0,speed:C.speed||0,altitude:C.altitude||0,template_id:C.template_id||null,commissioned_year:C.commissioned_year||null,displacement_tons:C.displacement_tons||null,length_meters:C.length_meters||null,beam_meters:C.beam_meters||null,max_speed_knots:C.max_speed_knots||null,crew_count:C.crew_count||null,range_km:C.range_km||null,air_wing:C.air_wing||null,propulsion:C.propulsion||null,thrust_hp:C.thrust_hp||null,country_origin:C.country_origin||null,manufacturer:C.manufacturer||null,armamento:C.armamento||null,image_url:C.image_url||null,image_thumbnail_url:C.image_thumbnail_url||null},{data:F,error:Z}=await yr.from("entities").insert(L).select().single();if(Z)throw Z;return{success:!0,data:F}}catch(o){return console.error("❌ Error al crear entidad:",o),m(o.message),{success:!1,error:o.message}}finally{s(!1)}}async function S(C,o){const L={...C,template_id:o.id,type:o.entity_type};return await v(L)}return{createEntity:v,createFromTemplate:S,creating:r,error:c}}function m$(){const[r,s]=Ne.useState(null),[c,m]=Ne.useState(null),[v,S]=Ne.useState(!1),[C,o]=Ne.useState(null),[L,F]=Ne.useState(!0),[Z,$]=Ne.useState(!0),[W,ee]=Ne.useState(!1),[ie,ae]=Ne.useState(!1),{createFromTemplate:ke,creating:le}=p$(),se=it=>{s(it),m(null)},J=(it,We)=>{},Ee=(it,We)=>{s(it),m(We)},je=()=>{s(null),m(null)},Xe=async it=>{if(!r)return;const We=await ke(it,r);We.success?(je(),window.addEntityDirectly&&We.data&&window.addEntityDirectly(We.data)):alert(`Error al crear entidad: ${We.error}`)},tt=it=>{};return x.jsx(L4,{children:x.jsx(R4,{children:x.jsxs(SU,{children:[x.jsx(vV,{onTogglePalette:()=>S(!v),paletteVisible:v,map:C,onToggleRadar:()=>F(!L),radarVisible:L,onToggleRadarMode:()=>$(!Z),radarCompact:Z,onToggleMeasurement:()=>ee(!W),measurementVisible:W,onToggleIntelligence:()=>ae(!ie),intelligenceVisible:ie}),x.jsxs("div",{className:"h-screen",children:[x.jsx(UU,{onRefetchNeeded:!0,onTemplateDrop:Ee,showPalette:v,onMapReady:o}),v&&x.jsx(GU,{onSelectTemplate:se,onDragTemplate:J,onClose:()=>S(!1)}),r&&x.jsx(qU,{template:r,position:c,onClose:je,onConfirm:Xe}),L&&x.jsx(AV,{}),L&&C&&x.jsx(EV,{map:C,onDetection:tt,compact:Z}),W&&C&&x.jsx(N8,{map:C}),ie&&x.jsx(f$,{onClose:()=>ae(!1),map:C}),x.jsx(L8,{}),le&&x.jsxs("div",{className:"fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 z-50",children:[x.jsx("div",{className:"animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"}),x.jsx("span",{children:"Creando entidad..."})]})]})]})})})}T_(document.getElementById("root")).render(x.jsx(m$,{}));
